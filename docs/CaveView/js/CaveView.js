!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).CV={})}(this,(function(t){"use strict";var e;if(void 0===(e=self||window).TextDecoder){var i=function(){};i.prototype.decode=function(t){const e=t.length;for(var i="",n=0;n<e;n++)i+="%"+t[n].toString(16);return decodeURIComponent(i)},e.TextDecoder=i}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Number.isInteger&&(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t}),void 0===Math.sign&&(Math.sign=function(t){return t<0?-1:t>0?1:+t}),"name"in Function.prototype==!1&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(t){if(null==t)throw new TypeError("Cannot convert undefined or null to object");const e=Object(t);for(let t=1;t<arguments.length;t++){const i=arguments[t];if(null!=i)for(const t in i)Object.prototype.hasOwnProperty.call(i,t)&&(e[t]=i[t])}return e});const n="2.1.test5",r=10,s=11,a=13,o=11,h=12,l=13,c=15;function u(){}Object.assign(u.prototype,{addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)},removeEventListener:function(t,e){if(void 0===this._listeners)return;const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}},dispatchEvent:function(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const i=e.slice(0);for(let e=0,n=i.length;e<n;e++)i[e].call(this,t)}}});const d=0,p=1,f=2,m=100,g=1e3,v=1001,y=1002,x=1003,_=1006,M=1008,b=1009,w=1012,S=1014,E=1015,T=1016,L=1020,C=1022,A=1023,P=1026,R=1027,D=3e3,N=7680,I=7682,O="300 es",F=[];for(let t=0;t<256;t++)F[t]=(t<16?"0":"")+t.toString(16);let U=1234567;const z={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(F[255&t]+F[t>>8&255]+F[t>>16&255]+F[t>>24&255]+"-"+F[255&e]+F[e>>8&255]+"-"+F[e>>16&15|64]+F[e>>24&255]+"-"+F[63&i|128]+F[i>>8&255]+"-"+F[i>>16&255]+F[i>>24&255]+F[255&n]+F[n>>8&255]+F[n>>16&255]+F[n>>24&255]).toUpperCase()},clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,i,n,r){return n+(t-e)*(r-n)/(i-e)},lerp:function(t,e,i){return(1-i)*t+i*e},smoothstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*(3-2*t)},smootherstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},seededRandom:function(t){return void 0!==t&&(U=t%2147483647),U=16807*U%2147483647,(U-1)/2147483646},degToRad:function(t){return t*z.DEG2RAD},radToDeg:function(t){return t*z.RAD2DEG},isPowerOfTwo:function(t){return 0==(t&t-1)&&0!==t},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},setQuaternionFromProperEuler:function(t,e,i,n,r){const s=Math.cos,a=Math.sin,o=s(i/2),h=a(i/2),l=s((e+n)/2),c=a((e+n)/2),u=s((e-n)/2),d=a((e-n)/2),p=s((n-e)/2),f=a((n-e)/2);switch(r){case"XYX":t.set(o*c,h*u,h*d,o*l);break;case"YZY":t.set(h*d,o*c,h*u,o*l);break;case"ZXZ":t.set(h*u,h*d,o*c,o*l);break;case"XZX":t.set(o*c,h*f,h*p,o*l);break;case"YXY":t.set(h*p,o*c,h*f,o*l);break;case"ZYZ":t.set(h*f,h*p,o*c,o*l);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}}};class k{constructor(t=0,e=0){Object.defineProperty(this,"isVector2",{value:!0}),this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this)}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this)}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,i=this.y,n=t.elements;return this.x=n[0]*e+n[3]*i+n[6],this.y=n[1]*e+n[4]*i+n[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y;return e*e+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const i=Math.cos(e),n=Math.sin(e),r=this.x-t.x,s=this.y-t.y;return this.x=r*i-s*n+t.x,this.y=r*n+s*i+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}}class B{constructor(){Object.defineProperty(this,"isMatrix3",{value:!0}),this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(t,e,i,n,r,s,a,o,h){const l=this.elements;return l[0]=t,l[1]=n,l[2]=a,l[3]=e,l[4]=r,l[5]=o,l[6]=i,l[7]=s,l[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}clone(){return(new this.constructor).fromArray(this.elements)}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],this}extractBasis(t,e,i){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,r=this.elements,s=i[0],a=i[3],o=i[6],h=i[1],l=i[4],c=i[7],u=i[2],d=i[5],p=i[8],f=n[0],m=n[3],g=n[6],v=n[1],y=n[4],x=n[7],_=n[2],M=n[5],b=n[8];return r[0]=s*f+a*v+o*_,r[3]=s*m+a*y+o*M,r[6]=s*g+a*x+o*b,r[1]=h*f+l*v+c*_,r[4]=h*m+l*y+c*M,r[7]=h*g+l*x+c*b,r[2]=u*f+d*v+p*_,r[5]=u*m+d*y+p*M,r[8]=u*g+d*x+p*b,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],a=t[5],o=t[6],h=t[7],l=t[8];return e*s*l-e*a*h-i*r*l+i*a*o+n*r*h-n*s*o}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=l*s-a*h,u=a*o-l*r,d=h*r-s*o,p=e*c+i*u+n*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const f=1/p;return t[0]=c*f,t[1]=(n*h-l*i)*f,t[2]=(a*i-n*s)*f,t[3]=u*f,t[4]=(l*e-n*o)*f,t[5]=(n*r-a*e)*f,t[6]=d*f,t[7]=(i*o-h*e)*f,t[8]=(s*e-i*r)*f,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).copy(this).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,i,n,r,s,a){const o=Math.cos(r),h=Math.sin(r);return this.set(i*o,i*h,-i*(o*s+h*a)+s+t,-n*h,n*o,-n*(-h*s+o*a)+a+e,0,0,1),this}scale(t,e){const i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=e,i[4]*=e,i[7]*=e,this}rotate(t){const e=Math.cos(t),i=Math.sin(t),n=this.elements,r=n[0],s=n[3],a=n[6],o=n[1],h=n[4],l=n[7];return n[0]=e*r+i*o,n[3]=e*s+i*h,n[6]=e*a+i*l,n[1]=-i*r+e*o,n[4]=-i*s+e*h,n[7]=-i*a+e*l,this}translate(t,e){const i=this.elements;return i[0]+=t*i[2],i[3]+=t*i[5],i[6]+=t*i[8],i[1]+=e*i[2],i[4]+=e*i[5],i[7]+=e*i[8],this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<9;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<9;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t}}let G;const H=function(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{void 0===G&&(G=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),G.width=t.width,G.height=t.height;const i=G.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):i.drawImage(t,0,0,t.width,t.height),e=G}return e.width>2048||e.height>2048?e.toDataURL("image/jpeg",.6):e.toDataURL("image/png")};let V=0;function W(t=W.DEFAULT_IMAGE,e=W.DEFAULT_MAPPING,i=1001,n=1001,r=1006,s=1008,a=1023,o=1009,h=1,l=3e3){Object.defineProperty(this,"id",{value:V++}),this.uuid=z.generateUUID(),this.name="",this.image=t,this.mipmaps=[],this.mapping=e,this.wrapS=i,this.wrapT=n,this.magFilter=r,this.minFilter=s,this.anisotropy=h,this.format=a,this.internalFormat=null,this.type=o,this.offset=new k(0,0),this.repeat=new k(1,1),this.center=new k(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new B,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=l,this.version=0,this.onUpdate=null}function j(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?H(t):t.data?{data:Array.prototype.slice.call(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}W.DEFAULT_IMAGE=void 0,W.DEFAULT_MAPPING=300,W.prototype=Object.assign(Object.create(u.prototype),{constructor:W,isTexture:!0,updateMatrix:function(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.name=t.name,this.image=t.image,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.encoding=t.encoding,this},toJSON:function(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const i={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(void 0!==this.image){const n=this.image;if(void 0===n.uuid&&(n.uuid=z.generateUUID()),!e&&void 0===t.images[n.uuid]){let e;if(Array.isArray(n)){e=[];for(let t=0,i=n.length;t<i;t++)n[t].isDataTexture?e.push(j(n[t].image)):e.push(j(n[t]))}else e=j(n);t.images[n.uuid]={uuid:n.uuid,url:e}}i.image=n.uuid}return e||(t.textures[this.uuid]=i),i},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(t){if(300!==this.mapping)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case g:t.x=t.x-Math.floor(t.x);break;case v:t.x=t.x<0?0:1;break;case y:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case g:t.y=t.y-Math.floor(t.y);break;case v:t.y=t.y<0?0:1;break;case y:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}}),Object.defineProperty(W.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}});class X{constructor(t=0,e=0,i=0,n=1){Object.defineProperty(this,"isVector4",{value:!0}),this.x=t,this.y=e,this.z=i,this.w=n}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,r=this.w,s=t.elements;return this.x=s[0]*e+s[4]*i+s[8]*n+s[12]*r,this.y=s[1]*e+s[5]*i+s[9]*n+s[13]*r,this.z=s[2]*e+s[6]*i+s[10]*n+s[14]*r,this.w=s[3]*e+s[7]*i+s[11]*n+s[15]*r,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,i,n,r;const s=.01,a=.1,o=t.elements,h=o[0],l=o[4],c=o[8],u=o[1],d=o[5],p=o[9],f=o[2],m=o[6],g=o[10];if(Math.abs(l-u)<s&&Math.abs(c-f)<s&&Math.abs(p-m)<s){if(Math.abs(l+u)<a&&Math.abs(c+f)<a&&Math.abs(p+m)<a&&Math.abs(h+d+g-3)<a)return this.set(1,0,0,0),this;e=Math.PI;const t=(h+1)/2,o=(d+1)/2,v=(g+1)/2,y=(l+u)/4,x=(c+f)/4,_=(p+m)/4;return t>o&&t>v?t<s?(i=0,n=.707106781,r=.707106781):(i=Math.sqrt(t),n=y/i,r=x/i):o>v?o<s?(i=.707106781,n=0,r=.707106781):(n=Math.sqrt(o),i=y/n,r=_/n):v<s?(i=.707106781,n=.707106781,r=0):(r=Math.sqrt(v),i=x/r,n=_/r),this.set(i,n,r,e),this}let v=Math.sqrt((m-p)*(m-p)+(c-f)*(c-f)+(u-l)*(u-l));return Math.abs(v)<.001&&(v=1),this.x=(m-p)/v,this.y=(c-f)/v,this.z=(u-l)/v,this.w=Math.acos((h+d+g-1)/2),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this.w=Math.max(t,Math.min(e,this.w)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this.w=t.w+(e.w-t.w)*i,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}}function q(t,e,i){this.width=t,this.height=e,this.scissor=new X(0,0,t,e),this.scissorTest=!1,this.viewport=new X(0,0,t,e),i=i||{},this.texture=new W(void 0,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.texture.image={},this.texture.image.width=t,this.texture.image.height=e,this.texture.generateMipmaps=void 0!==i.generateMipmaps&&i.generateMipmaps,this.texture.minFilter=void 0!==i.minFilter?i.minFilter:_,this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0!==i.stencilBuffer&&i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null}function Y(t,e,i,n,r,s,a,o,h,l,c,u){W.call(this,null,s,a,o,h,l,n,r,c,u),this.image={data:t||null,width:e||1,height:i||1},this.magFilter=void 0!==h?h:x,this.minFilter=void 0!==l?l:x,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}q.prototype=Object.assign(Object.create(u.prototype),{constructor:q,isWebGLRenderTarget:!0,setSize:function(t,e){this.width===t&&this.height===e||(this.width=t,this.height=e,this.texture.image.width=t,this.texture.image.height=e,this.dispose()),this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.width=t.width,this.height=t.height,this.viewport.copy(t.viewport),this.texture=t.texture.clone(),this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,this.depthTexture=t.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Y.prototype=Object.create(W.prototype),Y.prototype.constructor=Y,Y.prototype.isDataTexture=!0;class Z{constructor(t=0,e=0,i=0,n=1){Object.defineProperty(this,"isQuaternion",{value:!0}),this._x=t,this._y=e,this._z=i,this._w=n}static slerp(t,e,i,n){return i.copy(t).slerp(e,n)}static slerpFlat(t,e,i,n,r,s,a){let o=i[n+0],h=i[n+1],l=i[n+2],c=i[n+3];const u=r[s+0],d=r[s+1],p=r[s+2],f=r[s+3];if(c!==f||o!==u||h!==d||l!==p){let t=1-a;const e=o*u+h*d+l*p+c*f,i=e>=0?1:-1,n=1-e*e;if(n>Number.EPSILON){const r=Math.sqrt(n),s=Math.atan2(r,e*i);t=Math.sin(t*s)/r,a=Math.sin(a*s)/r}const r=a*i;if(o=o*t+u*r,h=h*t+d*r,l=l*t+p*r,c=c*t+f*r,t===1-a){const t=1/Math.sqrt(o*o+h*h+l*l+c*c);o*=t,h*=t,l*=t,c*=t}}t[e]=o,t[e+1]=h,t[e+2]=l,t[e+3]=c}static multiplyQuaternionsFlat(t,e,i,n,r,s){const a=i[n],o=i[n+1],h=i[n+2],l=i[n+3],c=r[s],u=r[s+1],d=r[s+2],p=r[s+3];return t[e]=a*p+l*c+o*d-h*u,t[e+1]=o*p+l*u+h*c-a*d,t[e+2]=h*p+l*d+a*u-o*c,t[e+3]=l*p-a*c-o*u-h*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e){if(!t||!t.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const i=t._x,n=t._y,r=t._z,s=t._order,a=Math.cos,o=Math.sin,h=a(i/2),l=a(n/2),c=a(r/2),u=o(i/2),d=o(n/2),p=o(r/2);switch(s){case"XYZ":this._x=u*l*c+h*d*p,this._y=h*d*c-u*l*p,this._z=h*l*p+u*d*c,this._w=h*l*c-u*d*p;break;case"YXZ":this._x=u*l*c+h*d*p,this._y=h*d*c-u*l*p,this._z=h*l*p-u*d*c,this._w=h*l*c+u*d*p;break;case"ZXY":this._x=u*l*c-h*d*p,this._y=h*d*c+u*l*p,this._z=h*l*p+u*d*c,this._w=h*l*c-u*d*p;break;case"ZYX":this._x=u*l*c-h*d*p,this._y=h*d*c+u*l*p,this._z=h*l*p-u*d*c,this._w=h*l*c+u*d*p;break;case"YZX":this._x=u*l*c+h*d*p,this._y=h*d*c+u*l*p,this._z=h*l*p-u*d*c,this._w=h*l*c-u*d*p;break;case"XZY":this._x=u*l*c-h*d*p,this._y=h*d*c-u*l*p,this._z=h*l*p+u*d*c,this._w=h*l*c+u*d*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!1!==e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const i=e/2,n=Math.sin(i);return this._x=t.x*n,this._y=t.y*n,this._z=t.z*n,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,i=e[0],n=e[4],r=e[8],s=e[1],a=e[5],o=e[9],h=e[2],l=e[6],c=e[10],u=i+a+c;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(l-o)*t,this._y=(r-h)*t,this._z=(s-n)*t}else if(i>a&&i>c){const t=2*Math.sqrt(1+i-a-c);this._w=(l-o)/t,this._x=.25*t,this._y=(n+s)/t,this._z=(r+h)/t}else if(a>c){const t=2*Math.sqrt(1+a-i-c);this._w=(r-h)/t,this._x=(n+s)/t,this._y=.25*t,this._z=(o+l)/t}else{const t=2*Math.sqrt(1+c-i-a);this._w=(s-n)/t,this._x=(r+h)/t,this._y=(o+l)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let i=t.dot(e)+1;return i<1e-6?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=i):(this._x=0,this._y=-t.z,this._z=t.y,this._w=i)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=i),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(z.clamp(this.dot(t),-1,1)))}rotateTowards(t,e){const i=this.angleTo(t);if(0===i)return this;const n=Math.min(1,e/i);return this.slerp(t,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const i=t._x,n=t._y,r=t._z,s=t._w,a=e._x,o=e._y,h=e._z,l=e._w;return this._x=i*l+s*a+n*h-r*o,this._y=n*l+s*o+r*a-i*h,this._z=r*l+s*h+i*o-n*a,this._w=s*l-i*a-n*o-r*h,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const i=this._x,n=this._y,r=this._z,s=this._w;let a=s*t._w+i*t._x+n*t._y+r*t._z;if(a<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,a=-a):this.copy(t),a>=1)return this._w=s,this._x=i,this._y=n,this._z=r,this;const o=1-a*a;if(o<=Number.EPSILON){const t=1-e;return this._w=t*s+e*this._w,this._x=t*i+e*this._x,this._y=t*n+e*this._y,this._z=t*r+e*this._z,this.normalize(),this._onChangeCallback(),this}const h=Math.sqrt(o),l=Math.atan2(h,a),c=Math.sin((1-e)*l)/h,u=Math.sin(e*l)/h;return this._w=s*c+this._w*u,this._x=i*c+this._x*u,this._y=n*c+this._y*u,this._z=r*c+this._z*u,this._onChangeCallback(),this}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}}class J{constructor(t=0,e=0,i=0){Object.defineProperty(this,"isVector3",{value:!0}),this.x=t,this.y=e,this.z=i}set(t,e,i){return void 0===i&&(i=this.z),this.x=t,this.y=e,this.z=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(K.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(K.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,i=this.y,n=this.z,r=t.elements;return this.x=r[0]*e+r[3]*i+r[6]*n,this.y=r[1]*e+r[4]*i+r[7]*n,this.z=r[2]*e+r[5]*i+r[8]*n,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,r=t.elements,s=1/(r[3]*e+r[7]*i+r[11]*n+r[15]);return this.x=(r[0]*e+r[4]*i+r[8]*n+r[12])*s,this.y=(r[1]*e+r[5]*i+r[9]*n+r[13])*s,this.z=(r[2]*e+r[6]*i+r[10]*n+r[14])*s,this}applyQuaternion(t){const e=this.x,i=this.y,n=this.z,r=t.x,s=t.y,a=t.z,o=t.w,h=o*e+s*n-a*i,l=o*i+a*e-r*n,c=o*n+r*i-s*e,u=-r*e-s*i-a*n;return this.x=h*o+u*-r+l*-a-c*-s,this.y=l*o+u*-s+c*-r-h*-a,this.z=c*o+u*-a+h*-s-l*-r,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,i=this.y,n=this.z,r=t.elements;return this.x=r[0]*e+r[4]*i+r[8]*n,this.y=r[1]*e+r[5]*i+r[9]*n,this.z=r[2]*e+r[6]*i+r[10]*n,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this}cross(t,e){return void 0!==e?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)}crossVectors(t,e){const i=t.x,n=t.y,r=t.z,s=e.x,a=e.y,o=e.z;return this.x=n*o-r*a,this.y=r*s-i*o,this.z=i*a-n*s,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const i=t.dot(this)/e;return this.copy(t).multiplyScalar(i)}projectOnPlane(t){return Q.copy(this).projectOnVector(t),this.sub(Q)}reflect(t){return this.sub(Q.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;return Math.acos(z.clamp(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return e*e+i*i+n*n}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,i){const n=Math.sin(e)*t;return this.x=n*Math.sin(i),this.y=Math.cos(e)*t,this.z=n*Math.cos(i),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,i){return this.x=t*Math.sin(e),this.y=i,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),n=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=n,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}const Q=new J,K=new Z;class ${constructor(t,e){Object.defineProperty(this,"isBox3",{value:!0}),this.min=void 0!==t?t:new J(1/0,1/0,1/0),this.max=void 0!==e?e:new J(-1/0,-1/0,-1/0)}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){let e=1/0,i=1/0,n=1/0,r=-1/0,s=-1/0,a=-1/0;for(let o=0,h=t.length;o<h;o+=3){const h=t[o],l=t[o+1],c=t[o+2];h<e&&(e=h),l<i&&(i=l),c<n&&(n=c),h>r&&(r=h),l>s&&(s=l),c>a&&(a=c)}return this.min.set(e,i,n),this.max.set(r,s,a),this}setFromBufferAttribute(t){let e=1/0,i=1/0,n=1/0,r=-1/0,s=-1/0,a=-1/0;for(let o=0,h=t.count;o<h;o++){const h=t.getX(o),l=t.getY(o),c=t.getZ(o);h<e&&(e=h),l<i&&(i=l),c<n&&(n=c),h>r&&(r=h),l>s&&(s=l),c>a&&(a=c)}return this.min.set(e,i,n),this.max.set(r,s,a),this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=it.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}setFromObject(t){return this.makeEmpty(),this.expandByObject(t)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return void 0===t&&(console.warn("THREE.Box3: .getCenter() target is now required"),t=new J),this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return void 0===t&&(console.warn("THREE.Box3: .getSize() target is now required"),t=new J),this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t){t.updateWorldMatrix(!1,!1);const e=t.geometry;void 0!==e&&(null===e.boundingBox&&e.computeBoundingBox(),nt.copy(e.boundingBox),nt.applyMatrix4(t.matrixWorld),this.union(nt));const i=t.children;for(let t=0,e=i.length;t<e;t++)this.expandByObject(i[t]);return this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return void 0===e&&(console.warn("THREE.Box3: .getParameter() target is now required"),e=new J),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}intersectsSphere(t){return this.clampPoint(t.center,it),it.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,i;return t.normal.x>0?(e=t.normal.x*this.min.x,i=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,i=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,i+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,i+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,i+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,i+=t.normal.z*this.min.z),e<=-t.constant&&i>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(ct),ut.subVectors(this.max,ct),rt.subVectors(t.a,ct),st.subVectors(t.b,ct),at.subVectors(t.c,ct),ot.subVectors(st,rt),ht.subVectors(at,st),lt.subVectors(rt,at);let e=[0,-ot.z,ot.y,0,-ht.z,ht.y,0,-lt.z,lt.y,ot.z,0,-ot.x,ht.z,0,-ht.x,lt.z,0,-lt.x,-ot.y,ot.x,0,-ht.y,ht.x,0,-lt.y,lt.x,0];return!!tt(e,rt,st,at,ut)&&(e=[1,0,0,0,1,0,0,0,1],!!tt(e,rt,st,at,ut)&&(dt.crossVectors(ot,ht),e=[dt.x,dt.y,dt.z],tt(e,rt,st,at,ut)))}clampPoint(t,e){return void 0===e&&(console.warn("THREE.Box3: .clampPoint() target is now required"),e=new J),e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return it.copy(t).clamp(this.min,this.max).sub(t).length()}getBoundingSphere(t){return void 0===t&&console.error("THREE.Box3: .getBoundingSphere() target is now required"),this.getCenter(t.center),t.radius=.5*this.getSize(it).length(),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(et[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),et[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),et[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),et[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),et[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),et[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),et[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),et[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(et)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}function tt(t,e,i,n,r){for(let s=0,a=t.length-3;s<=a;s+=3){pt.fromArray(t,s);const a=r.x*Math.abs(pt.x)+r.y*Math.abs(pt.y)+r.z*Math.abs(pt.z),o=e.dot(pt),h=i.dot(pt),l=n.dot(pt);if(Math.max(-Math.max(o,h,l),Math.min(o,h,l))>a)return!1}return!0}const et=[new J,new J,new J,new J,new J,new J,new J,new J],it=new J,nt=new $,rt=new J,st=new J,at=new J,ot=new J,ht=new J,lt=new J,ct=new J,ut=new J,dt=new J,pt=new J,ft=new $;class mt{constructor(t,e){this.center=void 0!==t?t:new J,this.radius=void 0!==e?e:-1}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const i=this.center;void 0!==e?i.copy(e):ft.setFromPoints(t).getCenter(i);let n=0;for(let e=0,r=t.length;e<r;e++)n=Math.max(n,i.distanceToSquared(t[e]));return this.radius=Math.sqrt(n),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const i=this.center.distanceToSquared(t);return void 0===e&&(console.warn("THREE.Sphere: .clampPoint() target is now required"),e=new J),e.copy(t),i>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return void 0===t&&(console.warn("THREE.Sphere: .getBoundingBox() target is now required"),t=new $),this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}}const gt=new J,vt=new J,yt=new B;class xt{constructor(t,e){Object.defineProperty(this,"isPlane",{value:!0}),this.normal=void 0!==t?t:new J(1,0,0),this.constant=void 0!==e?e:0}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,i,n){return this.normal.set(t,e,i),this.constant=n,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,i){const n=gt.subVectors(i,e).cross(vt.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(n,t),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return void 0===e&&(console.warn("THREE.Plane: .projectPoint() target is now required"),e=new J),e.copy(this.normal).multiplyScalar(-this.distanceToPoint(t)).add(t)}intersectLine(t,e){void 0===e&&(console.warn("THREE.Plane: .intersectLine() target is now required"),e=new J);const i=t.delta(gt),n=this.normal.dot(i);if(0===n)return 0===this.distanceToPoint(t.start)?e.copy(t.start):void 0;const r=-(t.start.dot(this.normal)+this.constant)/n;return r<0||r>1?void 0:e.copy(i).multiplyScalar(r).add(t.start)}intersectsLine(t){const e=this.distanceToPoint(t.start),i=this.distanceToPoint(t.end);return e<0&&i>0||i<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return void 0===t&&(console.warn("THREE.Plane: .coplanarPoint() target is now required"),t=new J),t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const i=e||yt.getNormalMatrix(t),n=this.coplanarPoint(gt).applyMatrix4(t),r=this.normal.applyMatrix3(i).normalize();return this.constant=-n.dot(r),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}}const _t=new mt,Mt=new J;class bt{constructor(t,e,i,n,r,s){this.planes=[void 0!==t?t:new xt,void 0!==e?e:new xt,void 0!==i?i:new xt,void 0!==n?n:new xt,void 0!==r?r:new xt,void 0!==s?s:new xt]}set(t,e,i,n,r,s){const a=this.planes;return a[0].copy(t),a[1].copy(e),a[2].copy(i),a[3].copy(n),a[4].copy(r),a[5].copy(s),this}clone(){return(new this.constructor).copy(this)}copy(t){const e=this.planes;for(let i=0;i<6;i++)e[i].copy(t.planes[i]);return this}setFromProjectionMatrix(t){const e=this.planes,i=t.elements,n=i[0],r=i[1],s=i[2],a=i[3],o=i[4],h=i[5],l=i[6],c=i[7],u=i[8],d=i[9],p=i[10],f=i[11],m=i[12],g=i[13],v=i[14],y=i[15];return e[0].setComponents(a-n,c-o,f-u,y-m).normalize(),e[1].setComponents(a+n,c+o,f+u,y+m).normalize(),e[2].setComponents(a+r,c+h,f+d,y+g).normalize(),e[3].setComponents(a-r,c-h,f-d,y-g).normalize(),e[4].setComponents(a-s,c-l,f-p,y-v).normalize(),e[5].setComponents(a+s,c+l,f+p,y+v).normalize(),this}intersectsObject(t){const e=t.geometry;return null===e.boundingSphere&&e.computeBoundingSphere(),_t.copy(e.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(_t)}intersectsSprite(t){return _t.center.set(0,0,0),_t.radius=.7071067811865476,_t.applyMatrix4(t.matrixWorld),this.intersectsSphere(_t)}intersectsSphere(t){const e=this.planes,i=t.center,n=-t.radius;for(let t=0;t<6;t++){if(e[t].distanceToPoint(i)<n)return!1}return!0}intersectsBox(t){const e=this.planes;for(let i=0;i<6;i++){const n=e[i];if(Mt.x=n.normal.x>0?t.max.x:t.min.x,Mt.y=n.normal.y>0?t.max.y:t.min.y,Mt.z=n.normal.z>0?t.max.z:t.min.z,n.distanceToPoint(Mt)<0)return!1}return!0}containsPoint(t){const e=this.planes;for(let i=0;i<6;i++)if(e[i].distanceToPoint(t)<0)return!1;return!0}}class wt{constructor(){Object.defineProperty(this,"isMatrix4",{value:!0}),this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(t,e,i,n,r,s,a,o,h,l,c,u,d,p,f,m){const g=this.elements;return g[0]=t,g[4]=e,g[8]=i,g[12]=n,g[1]=r,g[5]=s,g[9]=a,g[13]=o,g[2]=h,g[6]=l,g[10]=c,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new wt).fromArray(this.elements)}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}copyPosition(t){const e=this.elements,i=t.elements;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}extractBasis(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,i=t.elements,n=1/St.setFromMatrixColumn(t,0).length(),r=1/St.setFromMatrixColumn(t,1).length(),s=1/St.setFromMatrixColumn(t,2).length();return e[0]=i[0]*n,e[1]=i[1]*n,e[2]=i[2]*n,e[3]=0,e[4]=i[4]*r,e[5]=i[5]*r,e[6]=i[6]*r,e[7]=0,e[8]=i[8]*s,e[9]=i[9]*s,e[10]=i[10]*s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){t&&t.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const e=this.elements,i=t.x,n=t.y,r=t.z,s=Math.cos(i),a=Math.sin(i),o=Math.cos(n),h=Math.sin(n),l=Math.cos(r),c=Math.sin(r);if("XYZ"===t.order){const t=s*l,i=s*c,n=a*l,r=a*c;e[0]=o*l,e[4]=-o*c,e[8]=h,e[1]=i+n*h,e[5]=t-r*h,e[9]=-a*o,e[2]=r-t*h,e[6]=n+i*h,e[10]=s*o}else if("YXZ"===t.order){const t=o*l,i=o*c,n=h*l,r=h*c;e[0]=t+r*a,e[4]=n*a-i,e[8]=s*h,e[1]=s*c,e[5]=s*l,e[9]=-a,e[2]=i*a-n,e[6]=r+t*a,e[10]=s*o}else if("ZXY"===t.order){const t=o*l,i=o*c,n=h*l,r=h*c;e[0]=t-r*a,e[4]=-s*c,e[8]=n+i*a,e[1]=i+n*a,e[5]=s*l,e[9]=r-t*a,e[2]=-s*h,e[6]=a,e[10]=s*o}else if("ZYX"===t.order){const t=s*l,i=s*c,n=a*l,r=a*c;e[0]=o*l,e[4]=n*h-i,e[8]=t*h+r,e[1]=o*c,e[5]=r*h+t,e[9]=i*h-n,e[2]=-h,e[6]=a*o,e[10]=s*o}else if("YZX"===t.order){const t=s*o,i=s*h,n=a*o,r=a*h;e[0]=o*l,e[4]=r-t*c,e[8]=n*c+i,e[1]=c,e[5]=s*l,e[9]=-a*l,e[2]=-h*l,e[6]=i*c+n,e[10]=t-r*c}else if("XZY"===t.order){const t=s*o,i=s*h,n=a*o,r=a*h;e[0]=o*l,e[4]=-c,e[8]=h*l,e[1]=t*c+r,e[5]=s*l,e[9]=i*c-n,e[2]=n*c-i,e[6]=a*l,e[10]=r*c+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(Tt,t,Lt)}lookAt(t,e,i){const n=this.elements;return Pt.subVectors(t,e),0===Pt.lengthSq()&&(Pt.z=1),Pt.normalize(),Ct.crossVectors(i,Pt),0===Ct.lengthSq()&&(1===Math.abs(i.z)?Pt.x+=1e-4:Pt.z+=1e-4,Pt.normalize(),Ct.crossVectors(i,Pt)),Ct.normalize(),At.crossVectors(Pt,Ct),n[0]=Ct.x,n[4]=At.x,n[8]=Pt.x,n[1]=Ct.y,n[5]=At.y,n[9]=Pt.y,n[2]=Ct.z,n[6]=At.z,n[10]=Pt.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(t,e)):this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,r=this.elements,s=i[0],a=i[4],o=i[8],h=i[12],l=i[1],c=i[5],u=i[9],d=i[13],p=i[2],f=i[6],m=i[10],g=i[14],v=i[3],y=i[7],x=i[11],_=i[15],M=n[0],b=n[4],w=n[8],S=n[12],E=n[1],T=n[5],L=n[9],C=n[13],A=n[2],P=n[6],R=n[10],D=n[14],N=n[3],I=n[7],O=n[11],F=n[15];return r[0]=s*M+a*E+o*A+h*N,r[4]=s*b+a*T+o*P+h*I,r[8]=s*w+a*L+o*R+h*O,r[12]=s*S+a*C+o*D+h*F,r[1]=l*M+c*E+u*A+d*N,r[5]=l*b+c*T+u*P+d*I,r[9]=l*w+c*L+u*R+d*O,r[13]=l*S+c*C+u*D+d*F,r[2]=p*M+f*E+m*A+g*N,r[6]=p*b+f*T+m*P+g*I,r[10]=p*w+f*L+m*R+g*O,r[14]=p*S+f*C+m*D+g*F,r[3]=v*M+y*E+x*A+_*N,r[7]=v*b+y*T+x*P+_*I,r[11]=v*w+y*L+x*R+_*O,r[15]=v*S+y*C+x*D+_*F,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[4],n=t[8],r=t[12],s=t[1],a=t[5],o=t[9],h=t[13],l=t[2],c=t[6],u=t[10],d=t[14];return t[3]*(+r*o*c-n*h*c-r*a*u+i*h*u+n*a*d-i*o*d)+t[7]*(+e*o*d-e*h*u+r*s*u-n*s*d+n*h*l-r*o*l)+t[11]*(+e*h*c-e*a*d-r*s*c+i*s*d+r*a*l-i*h*l)+t[15]*(-n*a*l-e*o*c+e*a*u+n*s*c-i*s*u+i*o*l)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,i){const n=this.elements;return t.isVector3?(n[12]=t.x,n[13]=t.y,n[14]=t.z):(n[12]=t,n[13]=e,n[14]=i),this}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=t[9],u=t[10],d=t[11],p=t[12],f=t[13],m=t[14],g=t[15],v=c*m*h-f*u*h+f*o*d-a*m*d-c*o*g+a*u*g,y=p*u*h-l*m*h-p*o*d+s*m*d+l*o*g-s*u*g,x=l*f*h-p*c*h+p*a*d-s*f*d-l*a*g+s*c*g,_=p*c*o-l*f*o-p*a*u+s*f*u+l*a*m-s*c*m,M=e*v+i*y+n*x+r*_;if(0===M)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const b=1/M;return t[0]=v*b,t[1]=(f*u*r-c*m*r-f*n*d+i*m*d+c*n*g-i*u*g)*b,t[2]=(a*m*r-f*o*r+f*n*h-i*m*h-a*n*g+i*o*g)*b,t[3]=(c*o*r-a*u*r-c*n*h+i*u*h+a*n*d-i*o*d)*b,t[4]=y*b,t[5]=(l*m*r-p*u*r+p*n*d-e*m*d-l*n*g+e*u*g)*b,t[6]=(p*o*r-s*m*r-p*n*h+e*m*h+s*n*g-e*o*g)*b,t[7]=(s*u*r-l*o*r+l*n*h-e*u*h-s*n*d+e*o*d)*b,t[8]=x*b,t[9]=(p*c*r-l*f*r-p*i*d+e*f*d+l*i*g-e*c*g)*b,t[10]=(s*f*r-p*a*r+p*i*h-e*f*h-s*i*g+e*a*g)*b,t[11]=(l*a*r-s*c*r-l*i*h+e*c*h+s*i*d-e*a*d)*b,t[12]=_*b,t[13]=(l*f*n-p*c*n+p*i*u-e*f*u-l*i*m+e*c*m)*b,t[14]=(p*a*n-s*f*n-p*i*o+e*f*o+s*i*m-e*a*m)*b,t[15]=(s*c*n-l*a*n+l*i*o-e*c*o-s*i*u+e*a*u)*b,this}scale(t){const e=this.elements,i=t.x,n=t.y,r=t.z;return e[0]*=i,e[4]*=n,e[8]*=r,e[1]*=i,e[5]*=n,e[9]*=r,e[2]*=i,e[6]*=n,e[10]*=r,e[3]*=i,e[7]*=n,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],n=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,n))}makeTranslation(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const i=Math.cos(e),n=Math.sin(e),r=1-i,s=t.x,a=t.y,o=t.z,h=r*s,l=r*a;return this.set(h*s+i,h*a-n*o,h*o+n*a,0,h*a+n*o,l*a+i,l*o-n*s,0,h*o-n*a,l*o+n*s,r*o*o+i,0,0,0,0,1),this}makeScale(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}makeShear(t,e,i){return this.set(1,e,i,0,t,1,i,0,t,e,1,0,0,0,0,1),this}compose(t,e,i){const n=this.elements,r=e._x,s=e._y,a=e._z,o=e._w,h=r+r,l=s+s,c=a+a,u=r*h,d=r*l,p=r*c,f=s*l,m=s*c,g=a*c,v=o*h,y=o*l,x=o*c,_=i.x,M=i.y,b=i.z;return n[0]=(1-(f+g))*_,n[1]=(d+x)*_,n[2]=(p-y)*_,n[3]=0,n[4]=(d-x)*M,n[5]=(1-(u+g))*M,n[6]=(m+v)*M,n[7]=0,n[8]=(p+y)*b,n[9]=(m-v)*b,n[10]=(1-(u+f))*b,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,this}decompose(t,e,i){const n=this.elements;let r=St.set(n[0],n[1],n[2]).length();const s=St.set(n[4],n[5],n[6]).length(),a=St.set(n[8],n[9],n[10]).length();this.determinant()<0&&(r=-r),t.x=n[12],t.y=n[13],t.z=n[14],Et.copy(this);const o=1/r,h=1/s,l=1/a;return Et.elements[0]*=o,Et.elements[1]*=o,Et.elements[2]*=o,Et.elements[4]*=h,Et.elements[5]*=h,Et.elements[6]*=h,Et.elements[8]*=l,Et.elements[9]*=l,Et.elements[10]*=l,e.setFromRotationMatrix(Et),i.x=r,i.y=s,i.z=a,this}makePerspective(t,e,i,n,r,s){void 0===s&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const a=this.elements,o=2*r/(e-t),h=2*r/(i-n),l=(e+t)/(e-t),c=(i+n)/(i-n),u=-(s+r)/(s-r),d=-2*s*r/(s-r);return a[0]=o,a[4]=0,a[8]=l,a[12]=0,a[1]=0,a[5]=h,a[9]=c,a[13]=0,a[2]=0,a[6]=0,a[10]=u,a[14]=d,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(t,e,i,n,r,s){const a=this.elements,o=1/(e-t),h=1/(i-n),l=1/(s-r),c=(e+t)*o,u=(i+n)*h,d=(s+r)*l;return a[0]=2*o,a[4]=0,a[8]=0,a[12]=-c,a[1]=0,a[5]=2*h,a[9]=0,a[13]=-u,a[2]=0,a[6]=0,a[10]=-2*l,a[14]=-d,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<16;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<16;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}const St=new J,Et=new wt,Tt=new J(0,0,0),Lt=new J(1,1,1),Ct=new J,At=new J,Pt=new J,Rt={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Dt={h:0,s:0,l:0},Nt={h:0,s:0,l:0};function It(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}function Ot(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function Ft(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}class Ut{constructor(t,e,i){return Object.defineProperty(this,"isColor",{value:!0}),void 0===e&&void 0===i?this.set(t):this.setRGB(t,e,i)}set(t){return t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t),this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this}setRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}setHSL(t,e,i){if(t=z.euclideanModulo(t,1),e=z.clamp(e,0,1),i=z.clamp(i,0,1),0===e)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+e):i+e-i*e,r=2*i-n;this.r=It(r,n,t+1/3),this.g=It(r,n,t),this.b=It(r,n,t-1/3)}return this}setStyle(t){function e(e){void 0!==e&&parseFloat(e)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}let i;if(i=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(t)){let t;const n=i[1],r=i[2];switch(n){case"rgb":case"rgba":if(t=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255,e(t[4]),this;if(t=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100,e(t[4]),this;break;case"hsl":case"hsla":if(t=/^(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r)){const i=parseFloat(t[1])/360,n=parseInt(t[2],10)/100,r=parseInt(t[3],10)/100;return e(t[4]),this.setHSL(i,n,r)}}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(t)){const t=i[1],e=t.length;if(3===e)return this.r=parseInt(t.charAt(0)+t.charAt(0),16)/255,this.g=parseInt(t.charAt(1)+t.charAt(1),16)/255,this.b=parseInt(t.charAt(2)+t.charAt(2),16)/255,this;if(6===e)return this.r=parseInt(t.charAt(0)+t.charAt(1),16)/255,this.g=parseInt(t.charAt(2)+t.charAt(3),16)/255,this.b=parseInt(t.charAt(4)+t.charAt(5),16)/255,this}return t&&t.length>0?this.setColorName(t):this}setColorName(t){const e=Rt[t];return void 0!==e?this.setHex(e):console.warn("THREE.Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copyGammaToLinear(t,e=2){return this.r=Math.pow(t.r,e),this.g=Math.pow(t.g,e),this.b=Math.pow(t.b,e),this}copyLinearToGamma(t,e=2){const i=e>0?1/e:1;return this.r=Math.pow(t.r,i),this.g=Math.pow(t.g,i),this.b=Math.pow(t.b,i),this}convertGammaToLinear(t){return this.copyGammaToLinear(this,t),this}convertLinearToGamma(t){return this.copyLinearToGamma(this,t),this}copySRGBToLinear(t){return this.r=Ot(t.r),this.g=Ot(t.g),this.b=Ot(t.b),this}copyLinearToSRGB(t){return this.r=Ft(t.r),this.g=Ft(t.g),this.b=Ft(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(t){void 0===t&&(console.warn("THREE.Color: .getHSL() target is now required"),t={h:0,s:0,l:0});const e=this.r,i=this.g,n=this.b,r=Math.max(e,i,n),s=Math.min(e,i,n);let a,o;const h=(s+r)/2;if(s===r)a=0,o=0;else{const t=r-s;switch(o=h<=.5?t/(r+s):t/(2-r-s),r){case e:a=(i-n)/t+(i<n?6:0);break;case i:a=(n-e)/t+2;break;case n:a=(e-i)/t+4}a/=6}return t.h=a,t.s=o,t.l=h,t}getStyle(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"}offsetHSL(t,e,i){return this.getHSL(Dt),Dt.h+=t,Dt.s+=e,Dt.l+=i,this.setHSL(Dt.h,Dt.s,Dt.l),this}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpHSL(t,e){this.getHSL(Dt),t.getHSL(Nt);const i=z.lerp(Dt.h,Nt.h,e),n=z.lerp(Dt.s,Nt.s,e),r=z.lerp(Dt.l,Nt.l,e);return this.setHSL(i,n,r),this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),!0===t.normalized&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}}function zt(){let t=null,e=!1,i=null,n=null;function r(e,s){i(e,s),n=t.requestAnimationFrame(r)}return{start:function(){!0!==e&&null!==i&&(n=t.requestAnimationFrame(r),e=!0)},stop:function(){t.cancelAnimationFrame(n),e=!1},setAnimationLoop:function(t){i=t},setContext:function(e){t=e}}}function kt(t,e){const i=e.isWebGL2,n=new WeakMap;return{get:function(t){return t.isInterleavedBufferAttribute&&(t=t.data),n.get(t)},remove:function(e){e.isInterleavedBufferAttribute&&(e=e.data);const i=n.get(e);i&&(t.deleteBuffer(i.buffer),n.delete(e))},update:function(e,r){if(e.isGLBufferAttribute){const t=n.get(e);return void((!t||t.version<e.version)&&n.set(e,{buffer:e.buffer,type:e.type,bytesPerElement:e.elementSize,version:e.version}))}e.isInterleavedBufferAttribute&&(e=e.data);const s=n.get(e);void 0===s?n.set(e,function(e,n){const r=e.array,s=e.usage,a=t.createBuffer();t.bindBuffer(n,a),t.bufferData(n,r,s),e.onUploadCallback();let o=t.FLOAT;return r instanceof Float32Array?o=t.FLOAT:r instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):r instanceof Uint16Array?e.isFloat16BufferAttribute?i?o=t.HALF_FLOAT:console.warn("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2."):o=t.UNSIGNED_SHORT:r instanceof Int16Array?o=t.SHORT:r instanceof Uint32Array?o=t.UNSIGNED_INT:r instanceof Int32Array?o=t.INT:r instanceof Int8Array?o=t.BYTE:r instanceof Uint8Array&&(o=t.UNSIGNED_BYTE),{buffer:a,type:o,bytesPerElement:r.BYTES_PER_ELEMENT,version:e.version}}(e,r)):s.version<e.version&&(!function(e,n,r){const s=n.array,a=n.updateRange;t.bindBuffer(r,e),-1===a.count?t.bufferSubData(r,0,s):(i?t.bufferSubData(r,a.offset*s.BYTES_PER_ELEMENT,s,a.offset,a.count):t.bufferSubData(r,a.offset*s.BYTES_PER_ELEMENT,s.subarray(a.offset,a.offset+a.count)),a.count=-1)}(s.buffer,e,r),s.version=e.version)}}}Ut.NAMES=Rt,Ut.prototype.r=1,Ut.prototype.g=1,Ut.prototype.b=1;const Bt=new J,Gt=new k;function Ht(t,e,i){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=!0===i,this.usage=35044,this.updateRange={offset:0,count:-1},this.version=0}function Vt(t,e,i){Ht.call(this,new Int8Array(t),e,i)}function Wt(t,e,i){Ht.call(this,new Uint8Array(t),e,i)}function jt(t,e,i){Ht.call(this,new Uint8ClampedArray(t),e,i)}function Xt(t,e,i){Ht.call(this,new Int16Array(t),e,i)}function qt(t,e,i){Ht.call(this,new Uint16Array(t),e,i)}function Yt(t,e,i){Ht.call(this,new Int32Array(t),e,i)}function Zt(t,e,i){Ht.call(this,new Uint32Array(t),e,i)}function Jt(t,e,i){Ht.call(this,new Uint16Array(t),e,i)}function Qt(t,e,i){Ht.call(this,new Float32Array(t),e,i)}function Kt(t,e,i){Ht.call(this,new Float64Array(t),e,i)}Object.defineProperty(Ht.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(Ht.prototype,{isBufferAttribute:!0,onUploadCallback:function(){},setUsage:function(t){return this.usage=t,this},copy:function(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this},copyAt:function(t,e,i){t*=this.itemSize,i*=e.itemSize;for(let n=0,r=this.itemSize;n<r;n++)this.array[t+n]=e.array[i+n];return this},copyArray:function(t){return this.array.set(t),this},copyColorsArray:function(t){const e=this.array;let i=0;for(let n=0,r=t.length;n<r;n++){let r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",n),r=new Ut),e[i++]=r.r,e[i++]=r.g,e[i++]=r.b}return this},copyVector2sArray:function(t){const e=this.array;let i=0;for(let n=0,r=t.length;n<r;n++){let r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",n),r=new k),e[i++]=r.x,e[i++]=r.y}return this},copyVector3sArray:function(t){const e=this.array;let i=0;for(let n=0,r=t.length;n<r;n++){let r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",n),r=new J),e[i++]=r.x,e[i++]=r.y,e[i++]=r.z}return this},copyVector4sArray:function(t){const e=this.array;let i=0;for(let n=0,r=t.length;n<r;n++){let r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",n),r=new X),e[i++]=r.x,e[i++]=r.y,e[i++]=r.z,e[i++]=r.w}return this},applyMatrix3:function(t){if(2===this.itemSize)for(let e=0,i=this.count;e<i;e++)Gt.fromBufferAttribute(this,e),Gt.applyMatrix3(t),this.setXY(e,Gt.x,Gt.y);else if(3===this.itemSize)for(let e=0,i=this.count;e<i;e++)Bt.fromBufferAttribute(this,e),Bt.applyMatrix3(t),this.setXYZ(e,Bt.x,Bt.y,Bt.z);return this},applyMatrix4:function(t){for(let e=0,i=this.count;e<i;e++)Bt.x=this.getX(e),Bt.y=this.getY(e),Bt.z=this.getZ(e),Bt.applyMatrix4(t),this.setXYZ(e,Bt.x,Bt.y,Bt.z);return this},applyNormalMatrix:function(t){for(let e=0,i=this.count;e<i;e++)Bt.x=this.getX(e),Bt.y=this.getY(e),Bt.z=this.getZ(e),Bt.applyNormalMatrix(t),this.setXYZ(e,Bt.x,Bt.y,Bt.z);return this},transformDirection:function(t){for(let e=0,i=this.count;e<i;e++)Bt.x=this.getX(e),Bt.y=this.getY(e),Bt.z=this.getZ(e),Bt.transformDirection(t),this.setXYZ(e,Bt.x,Bt.y,Bt.z);return this},set:function(t,e=0){return this.array.set(t,e),this},getX:function(t){return this.array[t*this.itemSize]},setX:function(t,e){return this.array[t*this.itemSize]=e,this},getY:function(t){return this.array[t*this.itemSize+1]},setY:function(t,e){return this.array[t*this.itemSize+1]=e,this},getZ:function(t){return this.array[t*this.itemSize+2]},setZ:function(t,e){return this.array[t*this.itemSize+2]=e,this},getW:function(t){return this.array[t*this.itemSize+3]},setW:function(t,e){return this.array[t*this.itemSize+3]=e,this},setXY:function(t,e,i){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this},setXYZ:function(t,e,i,n){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this},setXYZW:function(t,e,i,n,r){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this.array[t+3]=r,this},onUpload:function(t){return this.onUploadCallback=t,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)},toJSON:function(){return{itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized}}}),Vt.prototype=Object.create(Ht.prototype),Vt.prototype.constructor=Vt,Wt.prototype=Object.create(Ht.prototype),Wt.prototype.constructor=Wt,jt.prototype=Object.create(Ht.prototype),jt.prototype.constructor=jt,Xt.prototype=Object.create(Ht.prototype),Xt.prototype.constructor=Xt,qt.prototype=Object.create(Ht.prototype),qt.prototype.constructor=qt,Yt.prototype=Object.create(Ht.prototype),Yt.prototype.constructor=Yt,Zt.prototype=Object.create(Ht.prototype),Zt.prototype.constructor=Zt,Jt.prototype=Object.create(Ht.prototype),Jt.prototype.constructor=Jt,Jt.prototype.isFloat16BufferAttribute=!0,Qt.prototype=Object.create(Ht.prototype),Qt.prototype.constructor=Qt,Kt.prototype=Object.create(Ht.prototype),Kt.prototype.constructor=Kt;class $t{constructor(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}computeGroups(t){const e=[];let i,n,r;const s=t.faces;for(n=0;n<s.length;n++){const t=s[n];t.materialIndex!==r&&(r=t.materialIndex,void 0!==i&&(i.count=3*n-i.start,e.push(i)),i={start:3*n,materialIndex:r})}void 0!==i&&(i.count=3*n-i.start,e.push(i)),this.groups=e}fromGeometry(t){const e=t.faces,i=t.vertices,n=t.faceVertexUvs,r=n[0]&&n[0].length>0,s=n[1]&&n[1].length>0,a=t.morphTargets,o=a.length;let h;if(o>0){h=[];for(let t=0;t<o;t++)h[t]={name:a[t].name,data:[]};this.morphTargets.position=h}const l=t.morphNormals,c=l.length;let u;if(c>0){u=[];for(let t=0;t<c;t++)u[t]={name:l[t].name,data:[]};this.morphTargets.normal=u}const d=t.skinIndices,p=t.skinWeights,f=d.length===i.length,m=p.length===i.length;i.length>0&&0===e.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let t=0;t<e.length;t++){const g=e[t];this.vertices.push(i[g.a],i[g.b],i[g.c]);const v=g.vertexNormals;if(3===v.length)this.normals.push(v[0],v[1],v[2]);else{const t=g.normal;this.normals.push(t,t,t)}const y=g.vertexColors;if(3===y.length)this.colors.push(y[0],y[1],y[2]);else{const t=g.color;this.colors.push(t,t,t)}if(!0===r){const e=n[0][t];void 0!==e?this.uvs.push(e[0],e[1],e[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",t),this.uvs.push(new k,new k,new k))}if(!0===s){const e=n[1][t];void 0!==e?this.uvs2.push(e[0],e[1],e[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",t),this.uvs2.push(new k,new k,new k))}for(let t=0;t<o;t++){const e=a[t].vertices;h[t].data.push(e[g.a],e[g.b],e[g.c])}for(let e=0;e<c;e++){const i=l[e].vertexNormals[t];u[e].data.push(i.a,i.b,i.c)}f&&this.skinIndices.push(d[g.a],d[g.b],d[g.c]),m&&this.skinWeights.push(p[g.a],p[g.b],p[g.c])}return this.computeGroups(t),this.verticesNeedUpdate=t.verticesNeedUpdate,this.normalsNeedUpdate=t.normalsNeedUpdate,this.colorsNeedUpdate=t.colorsNeedUpdate,this.uvsNeedUpdate=t.uvsNeedUpdate,this.groupsNeedUpdate=t.groupsNeedUpdate,null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),this}}class te{constructor(t=0,e=0,i=0,n=te.DefaultOrder){Object.defineProperty(this,"isEuler",{value:!0}),this._x=t,this._y=e,this._z=i,this._order=n}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._order=n||this._order,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e,i){const n=z.clamp,r=t.elements,s=r[0],a=r[4],o=r[8],h=r[1],l=r[5],c=r[9],u=r[2],d=r[6],p=r[10];switch(e=e||this._order){case"XYZ":this._y=Math.asin(n(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,p),this._z=Math.atan2(-a,s)):(this._x=Math.atan2(d,l),this._z=0);break;case"YXZ":this._x=Math.asin(-n(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(o,p),this._z=Math.atan2(h,l)):(this._y=Math.atan2(-u,s),this._z=0);break;case"ZXY":this._x=Math.asin(n(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-a,l)):(this._y=0,this._z=Math.atan2(h,s));break;case"ZYX":this._y=Math.asin(-n(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(d,p),this._z=Math.atan2(h,s)):(this._x=0,this._z=Math.atan2(-a,l));break;case"YZX":this._z=Math.asin(n(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-u,s)):(this._x=0,this._y=Math.atan2(o,p));break;case"XZY":this._z=Math.asin(-n(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(d,l),this._y=Math.atan2(o,s)):(this._x=Math.atan2(-c,p),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,!1!==i&&this._onChangeCallback(),this}setFromQuaternion(t,e,i){return ee.makeRotationFromQuaternion(t),this.setFromRotationMatrix(ee,e,i)}setFromVector3(t,e){return this.set(t.x,t.y,t.z,e||this._order)}reorder(t){return ie.setFromEuler(this),this.setFromQuaternion(ie,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}toVector3(t){return t?t.set(this._x,this._y,this._z):new J(this._x,this._y,this._z)}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}}te.DefaultOrder="XYZ",te.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];const ee=new wt,ie=new Z;class ne{constructor(){this.mask=1}set(t){this.mask=1<<t|0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return 0!=(this.mask&t.mask)}}let re=0;const se=new J,ae=new Z,oe=new wt,he=new J,le=new J,ce=new J,ue=new Z,de=new J(1,0,0),pe=new J(0,1,0),fe=new J(0,0,1),me={type:"added"},ge={type:"removed"};function ve(){Object.defineProperty(this,"id",{value:re++}),this.uuid=z.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=ve.DefaultUp.clone();const t=new J,e=new te,i=new Z,n=new J(1,1,1);e._onChange((function(){i.setFromEuler(e,!1)})),i._onChange((function(){e.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new wt},normalMatrix:{value:new B}}),this.matrix=new wt,this.matrixWorld=new wt,this.matrixAutoUpdate=ve.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new ne,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}function ye(t){if(0===t.length)return-1/0;let e=t[0];for(let i=1,n=t.length;i<n;++i)t[i]>e&&(e=t[i]);return e}ve.DefaultUp=new J(0,1,0),ve.DefaultMatrixAutoUpdate=!0,ve.prototype=Object.assign(Object.create(u.prototype),{constructor:ve,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix4:function(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(t){return this.quaternion.premultiply(t),this},setRotationFromAxisAngle:function(t,e){this.quaternion.setFromAxisAngle(t,e)},setRotationFromEuler:function(t){this.quaternion.setFromEuler(t,!0)},setRotationFromMatrix:function(t){this.quaternion.setFromRotationMatrix(t)},setRotationFromQuaternion:function(t){this.quaternion.copy(t)},rotateOnAxis:function(t,e){return ae.setFromAxisAngle(t,e),this.quaternion.multiply(ae),this},rotateOnWorldAxis:function(t,e){return ae.setFromAxisAngle(t,e),this.quaternion.premultiply(ae),this},rotateX:function(t){return this.rotateOnAxis(de,t)},rotateY:function(t){return this.rotateOnAxis(pe,t)},rotateZ:function(t){return this.rotateOnAxis(fe,t)},translateOnAxis:function(t,e){return se.copy(t).applyQuaternion(this.quaternion),this.position.add(se.multiplyScalar(e)),this},translateX:function(t){return this.translateOnAxis(de,t)},translateY:function(t){return this.translateOnAxis(pe,t)},translateZ:function(t){return this.translateOnAxis(fe,t)},localToWorld:function(t){return t.applyMatrix4(this.matrixWorld)},worldToLocal:function(t){return t.applyMatrix4(oe.copy(this.matrixWorld).invert())},lookAt:function(t,e,i){t.isVector3?he.copy(t):he.set(t,e,i);const n=this.parent;this.updateWorldMatrix(!0,!1),le.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?oe.lookAt(le,he,this.up):oe.lookAt(he,le,this.up),this.quaternion.setFromRotationMatrix(oe),n&&(oe.extractRotation(n.matrixWorld),ae.setFromRotationMatrix(oe),this.quaternion.premultiply(ae.invert()))},add:function(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(me)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)},remove:function(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(ge)),this},clear:function(){for(let t=0;t<this.children.length;t++){const e=this.children[t];e.parent=null,e.dispatchEvent(ge)}return this.children.length=0,this},attach:function(t){return this.updateWorldMatrix(!0,!1),oe.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),oe.multiply(t.parent.matrixWorld)),t.applyMatrix4(oe),t.updateWorldMatrix(!1,!1),this.add(t),this},getObjectById:function(t){return this.getObjectByProperty("id",t)},getObjectByName:function(t){return this.getObjectByProperty("name",t)},getObjectByProperty:function(t,e){if(this[t]===e)return this;for(let i=0,n=this.children.length;i<n;i++){const n=this.children[i].getObjectByProperty(t,e);if(void 0!==n)return n}},getWorldPosition:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldPosition() target is now required"),t=new J),this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldQuaternion() target is now required"),t=new Z),this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(le,t,ce),t},getWorldScale:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldScale() target is now required"),t=new J),this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(le,ue,t),t},getWorldDirection:function(t){void 0===t&&(console.warn("THREE.Object3D: .getWorldDirection() target is now required"),t=new J),this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()},raycast:function(){},traverse:function(t){t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverse(t)},traverseVisible:function(t){if(!1===this.visible)return;t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverseVisible(t)},traverseAncestors:function(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].updateMatrixWorld(t)},updateWorldMatrix:function(t,e){const i=this.parent;if(!0===t&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e){const t=this.children;for(let e=0,i=t.length;e<i;e++)t[e].updateWorldMatrix(!1,!0)}},toJSON:function(t){const e=void 0===t||"string"==typeof t,i={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const n={};function r(e,i){return void 0===e[i.uuid]&&(e[i.uuid]=i.toJSON(t)),i.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON()),this.isMesh||this.isLine||this.isPoints){n.geometry=r(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const i=e.shapes;if(Array.isArray(i))for(let e=0,n=i.length;e<n;e++){const n=i[e];r(t.shapes,n)}else r(t.shapes,i)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(t.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let i=0,n=this.material.length;i<n;i++)e.push(r(t.materials,this.material[i]));n.material=e}else n.material=r(t.materials,this.material);if(this.children.length>0){n.children=[];for(let e=0;e<this.children.length;e++)n.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){n.animations=[];for(let e=0;e<this.animations.length;e++){const i=this.animations[e];n.animations.push(r(t.animations,i))}}if(e){const e=s(t.geometries),n=s(t.materials),r=s(t.textures),a=s(t.images),o=s(t.shapes),h=s(t.skeletons),l=s(t.animations);e.length>0&&(i.geometries=e),n.length>0&&(i.materials=n),r.length>0&&(i.textures=r),a.length>0&&(i.images=a),o.length>0&&(i.shapes=o),h.length>0&&(i.skeletons=h),l.length>0&&(i.animations=l)}return i.object=n,i;function s(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}},clone:function(t){return(new this.constructor).copy(this,t)},copy:function(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const i=t.children[e];this.add(i.clone())}return this}});let xe=1;const _e=new wt,Me=new ve,be=new J,we=new $,Se=new $,Ee=new J;function Te(){Object.defineProperty(this,"id",{value:xe+=2}),this.uuid=z.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}Te.prototype=Object.assign(Object.create(u.prototype),{constructor:Te,isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(t){return Array.isArray(t)?this.index=new(ye(t)>65535?Zt:qt)(t,1):this.index=t,this},getAttribute:function(t){return this.attributes[t]},setAttribute:function(t,e){return this.attributes[t]=e,this},deleteAttribute:function(t){return delete this.attributes[t],this},hasAttribute:function(t){return void 0!==this.attributes[t]},addGroup:function(t,e,i=0){this.groups.push({start:t,count:e,materialIndex:i})},clearGroups:function(){this.groups=[]},setDrawRange:function(t,e){this.drawRange.start=t,this.drawRange.count=e},applyMatrix4:function(t){const e=this.attributes.position;void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const e=(new B).getNormalMatrix(t);i.applyNormalMatrix(e),i.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(t),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(t){return _e.makeRotationX(t),this.applyMatrix4(_e),this},rotateY:function(t){return _e.makeRotationY(t),this.applyMatrix4(_e),this},rotateZ:function(t){return _e.makeRotationZ(t),this.applyMatrix4(_e),this},translate:function(t,e,i){return _e.makeTranslation(t,e,i),this.applyMatrix4(_e),this},scale:function(t,e,i){return _e.makeScale(t,e,i),this.applyMatrix4(_e),this},lookAt:function(t){return Me.lookAt(t),Me.updateMatrix(),this.applyMatrix4(Me.matrix),this},center:function(){return this.computeBoundingBox(),this.boundingBox.getCenter(be).negate(),this.translate(be.x,be.y,be.z),this},setFromObject:function(t){const e=t.geometry;if(t.isPoints||t.isLine){const t=new Qt(3*e.vertices.length,3),i=new Qt(3*e.colors.length,3);if(this.setAttribute("position",t.copyVector3sArray(e.vertices)),this.setAttribute("color",i.copyColorsArray(e.colors)),e.lineDistances&&e.lineDistances.length===e.vertices.length){const t=new Qt(e.lineDistances.length,1);this.setAttribute("lineDistance",t.copyArray(e.lineDistances))}null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone())}else t.isMesh&&e&&e.isGeometry&&this.fromGeometry(e);return this},setFromPoints:function(t){const e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i];e.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new Qt(e,3)),this},updateFromObject:function(t){let e=t.geometry;if(t.isMesh){let t=e.__directGeometry;if(!0===e.elementsNeedUpdate&&(t=void 0,e.elementsNeedUpdate=!1),void 0===t)return this.fromGeometry(e);t.verticesNeedUpdate=e.verticesNeedUpdate,t.normalsNeedUpdate=e.normalsNeedUpdate,t.colorsNeedUpdate=e.colorsNeedUpdate,t.uvsNeedUpdate=e.uvsNeedUpdate,t.groupsNeedUpdate=e.groupsNeedUpdate,e.verticesNeedUpdate=!1,e.normalsNeedUpdate=!1,e.colorsNeedUpdate=!1,e.uvsNeedUpdate=!1,e.groupsNeedUpdate=!1,e=t}if(!0===e.verticesNeedUpdate){const t=this.attributes.position;void 0!==t&&(t.copyVector3sArray(e.vertices),t.needsUpdate=!0),e.verticesNeedUpdate=!1}if(!0===e.normalsNeedUpdate){const t=this.attributes.normal;void 0!==t&&(t.copyVector3sArray(e.normals),t.needsUpdate=!0),e.normalsNeedUpdate=!1}if(!0===e.colorsNeedUpdate){const t=this.attributes.color;void 0!==t&&(t.copyColorsArray(e.colors),t.needsUpdate=!0),e.colorsNeedUpdate=!1}if(e.uvsNeedUpdate){const t=this.attributes.uv;void 0!==t&&(t.copyVector2sArray(e.uvs),t.needsUpdate=!0),e.uvsNeedUpdate=!1}if(e.lineDistancesNeedUpdate){const t=this.attributes.lineDistance;void 0!==t&&(t.copyArray(e.lineDistances),t.needsUpdate=!0),e.lineDistancesNeedUpdate=!1}return e.groupsNeedUpdate&&(e.computeGroups(t.geometry),this.groups=e.groups,e.groupsNeedUpdate=!1),this},fromGeometry:function(t){return t.__directGeometry=(new $t).fromGeometry(t),this.fromDirectGeometry(t.__directGeometry)},fromDirectGeometry:function(t){const e=new Float32Array(3*t.vertices.length);if(this.setAttribute("position",new Ht(e,3).copyVector3sArray(t.vertices)),t.normals.length>0){const e=new Float32Array(3*t.normals.length);this.setAttribute("normal",new Ht(e,3).copyVector3sArray(t.normals))}if(t.colors.length>0){const e=new Float32Array(3*t.colors.length);this.setAttribute("color",new Ht(e,3).copyColorsArray(t.colors))}if(t.uvs.length>0){const e=new Float32Array(2*t.uvs.length);this.setAttribute("uv",new Ht(e,2).copyVector2sArray(t.uvs))}if(t.uvs2.length>0){const e=new Float32Array(2*t.uvs2.length);this.setAttribute("uv2",new Ht(e,2).copyVector2sArray(t.uvs2))}this.groups=t.groups;for(const e in t.morphTargets){const i=[],n=t.morphTargets[e];for(let t=0,e=n.length;t<e;t++){const e=n[t],r=new Qt(3*e.data.length,3);r.name=e.name,i.push(r.copyVector3sArray(e.data))}this.morphAttributes[e]=i}if(t.skinIndices.length>0){const e=new Qt(4*t.skinIndices.length,4);this.setAttribute("skinIndex",e.copyVector4sArray(t.skinIndices))}if(t.skinWeights.length>0){const e=new Qt(4*t.skinWeights.length,4);this.setAttribute("skinWeight",e.copyVector4sArray(t.skinWeights))}return null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new $);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingBox.set(new J(-1/0,-1/0,-1/0),new J(1/0,1/0,1/0));if(void 0!==t){if(this.boundingBox.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];we.setFromBufferAttribute(i),this.morphTargetsRelative?(Ee.addVectors(this.boundingBox.min,we.min),this.boundingBox.expandByPoint(Ee),Ee.addVectors(this.boundingBox.max,we.max),this.boundingBox.expandByPoint(Ee)):(this.boundingBox.expandByPoint(we.min),this.boundingBox.expandByPoint(we.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new mt);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingSphere.set(new J,1/0);if(t){const i=this.boundingSphere.center;if(we.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];Se.setFromBufferAttribute(i),this.morphTargetsRelative?(Ee.addVectors(we.min,Se.min),we.expandByPoint(Ee),Ee.addVectors(we.max,Se.max),we.expandByPoint(Ee)):(we.expandByPoint(Se.min),we.expandByPoint(Se.max))}we.getCenter(i);let n=0;for(let e=0,r=t.count;e<r;e++)Ee.fromBufferAttribute(t,e),n=Math.max(n,i.distanceToSquared(Ee));if(e)for(let r=0,s=e.length;r<s;r++){const s=e[r],a=this.morphTargetsRelative;for(let e=0,r=s.count;e<r;e++)Ee.fromBufferAttribute(s,e),a&&(be.fromBufferAttribute(t,e),Ee.add(be)),n=Math.max(n,i.distanceToSquared(Ee))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}},computeFaceNormals:function(){},computeVertexNormals:function(){const t=this.index,e=this.getAttribute("position");if(void 0!==e){let i=this.getAttribute("normal");if(void 0===i)i=new Ht(new Float32Array(3*e.count),3),this.setAttribute("normal",i);else for(let t=0,e=i.count;t<e;t++)i.setXYZ(t,0,0,0);const n=new J,r=new J,s=new J,a=new J,o=new J,h=new J,l=new J,c=new J;if(t)for(let u=0,d=t.count;u<d;u+=3){const d=t.getX(u+0),p=t.getX(u+1),f=t.getX(u+2);n.fromBufferAttribute(e,d),r.fromBufferAttribute(e,p),s.fromBufferAttribute(e,f),l.subVectors(s,r),c.subVectors(n,r),l.cross(c),a.fromBufferAttribute(i,d),o.fromBufferAttribute(i,p),h.fromBufferAttribute(i,f),a.add(l),o.add(l),h.add(l),i.setXYZ(d,a.x,a.y,a.z),i.setXYZ(p,o.x,o.y,o.z),i.setXYZ(f,h.x,h.y,h.z)}else for(let t=0,a=e.count;t<a;t+=3)n.fromBufferAttribute(e,t+0),r.fromBufferAttribute(e,t+1),s.fromBufferAttribute(e,t+2),l.subVectors(s,r),c.subVectors(n,r),l.cross(c),i.setXYZ(t+0,l.x,l.y,l.z),i.setXYZ(t+1,l.x,l.y,l.z),i.setXYZ(t+2,l.x,l.y,l.z);this.normalizeNormals(),i.needsUpdate=!0}},merge:function(t,e){if(!t||!t.isBufferGeometry)return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",t);void 0===e&&(e=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));const i=this.attributes;for(const n in i){if(void 0===t.attributes[n])continue;const r=i[n].array,s=t.attributes[n],a=s.array,o=s.itemSize*e,h=Math.min(a.length,r.length-o);for(let t=0,e=o;t<h;t++,e++)r[e]=a[t]}return this},normalizeNormals:function(){const t=this.attributes.normal;for(let e=0,i=t.count;e<i;e++)Ee.fromBufferAttribute(t,e),Ee.normalize(),t.setXYZ(e,Ee.x,Ee.y,Ee.z)},toNonIndexed:function(){function t(t,e){const i=t.array,n=t.itemSize,r=t.normalized,s=new i.constructor(e.length*n);let a=0,o=0;for(let t=0,r=e.length;t<r;t++){a=e[t]*n;for(let t=0;t<n;t++)s[o++]=i[a++]}return new Ht(s,n,r)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;const e=new Te,i=this.index.array,n=this.attributes;for(const r in n){const s=t(n[r],i);e.setAttribute(r,s)}const r=this.morphAttributes;for(const n in r){const s=[],a=r[n];for(let e=0,n=a.length;e<n;e++){const n=t(a[e],i);s.push(n)}e.morphAttributes[n]=s}e.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let t=0,i=s.length;t<i;t++){const i=s[t];e.addGroup(i.start,i.count,i.materialIndex)}return e},toJSON:function(){const t={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){const e=this.parameters;for(const i in e)void 0!==e[i]&&(t[i]=e[i]);return t}t.data={attributes:{}};const e=this.index;null!==e&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const i=this.attributes;for(const e in i){const n=i[e],r=n.toJSON(t.data);""!==n.name&&(r.name=n.name),t.data.attributes[e]=r}const n={};let r=!1;for(const e in this.morphAttributes){const i=this.morphAttributes[e],s=[];for(let e=0,n=i.length;e<n;e++){const n=i[e],r=n.toJSON(t.data);""!==n.name&&(r.name=n.name),s.push(r)}s.length>0&&(n[e]=s,r=!0)}r&&(t.data.morphAttributes=n,t.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(t.data.groups=JSON.parse(JSON.stringify(s)));const a=this.boundingSphere;return null!==a&&(t.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),t},clone:function(){return(new Te).copy(this)},copy:function(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const i=t.index;null!==i&&this.setIndex(i.clone(e));const n=t.attributes;for(const t in n){const i=n[t];this.setAttribute(t,i.clone(e))}const r=t.morphAttributes;for(const t in r){const i=[],n=r[t];for(let t=0,r=n.length;t<r;t++)i.push(n[t].clone(e));this.morphAttributes[t]=i}this.morphTargetsRelative=t.morphTargetsRelative;const s=t.groups;for(let t=0,e=s.length;t<e;t++){const e=s[t];this.addGroup(e.start,e.count,e.materialIndex)}const a=t.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=t.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this},dispose:function(){this.dispatchEvent({type:"dispose"})}});class Le extends Te{constructor(t=1,e=1,i=1,n=1,r=1,s=1){super(),this.type="BoxBufferGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:n,heightSegments:r,depthSegments:s};const a=this;n=Math.floor(n),r=Math.floor(r),s=Math.floor(s);const o=[],h=[],l=[],c=[];let u=0,d=0;function p(t,e,i,n,r,s,p,f,m,g,v){const y=s/m,x=p/g,_=s/2,M=p/2,b=f/2,w=m+1,S=g+1;let E=0,T=0;const L=new J;for(let s=0;s<S;s++){const a=s*x-M;for(let o=0;o<w;o++){const u=o*y-_;L[t]=u*n,L[e]=a*r,L[i]=b,h.push(L.x,L.y,L.z),L[t]=0,L[e]=0,L[i]=f>0?1:-1,l.push(L.x,L.y,L.z),c.push(o/m),c.push(1-s/g),E+=1}}for(let t=0;t<g;t++)for(let e=0;e<m;e++){const i=u+e+w*t,n=u+e+w*(t+1),r=u+(e+1)+w*(t+1),s=u+(e+1)+w*t;o.push(i,n,s),o.push(n,r,s),T+=6}a.addGroup(d,T,v),d+=T,u+=E}p("z","y","x",-1,-1,i,e,t,s,r,0),p("z","y","x",1,-1,i,e,-t,s,r,1),p("x","z","y",1,1,t,i,e,n,s,2),p("x","z","y",1,-1,t,i,-e,n,s,3),p("x","y","z",1,-1,t,e,i,n,r,4),p("x","y","z",-1,-1,t,e,-i,n,r,5),this.setIndex(o),this.setAttribute("position",new Qt(h,3)),this.setAttribute("normal",new Qt(l,3)),this.setAttribute("uv",new Qt(c,2))}}class Ce extends Te{constructor(t=1,e=1,i=1,n=1){super(),this.type="PlaneBufferGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:n};const r=t/2,s=e/2,a=Math.floor(i),o=Math.floor(n),h=a+1,l=o+1,c=t/a,u=e/o,d=[],p=[],f=[],m=[];for(let t=0;t<l;t++){const e=t*u-s;for(let i=0;i<h;i++){const n=i*c-r;p.push(n,-e,0),f.push(0,0,1),m.push(i/a),m.push(1-t/o)}}for(let t=0;t<o;t++)for(let e=0;e<a;e++){const i=e+h*t,n=e+h*(t+1),r=e+1+h*(t+1),s=e+1+h*t;d.push(i,n,s),d.push(n,r,s)}this.setIndex(d),this.setAttribute("position",new Qt(p,3)),this.setAttribute("normal",new Qt(f,3)),this.setAttribute("uv",new Qt(m,2))}}let Ae=0;function Pe(){Object.defineProperty(this,"id",{value:Ae++}),this.uuid=z.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.blending=1,this.side=0,this.flatShading=!1,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=m,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=N,this.stencilZFail=N,this.stencilZPass=N,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0}function Re(t){const e={};for(const i in t){e[i]={};for(const n in t[i]){const r=t[i][n];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture)?e[i][n]=r.clone():Array.isArray(r)?e[i][n]=r.slice():e[i][n]=r}}return e}function De(t){const e={};for(let i=0;i<t.length;i++){const n=Re(t[i]);for(const t in n)e[t]=n[t]}return e}Pe.prototype=Object.assign(Object.create(u.prototype),{constructor:Pe,isMaterial:!0,onBeforeCompile:function(){},customProgramCacheKey:function(){return this.onBeforeCompile.toString()},setValues:function(t){if(void 0!==t)for(const e in t){const i=t[e];if(void 0===i){console.warn("THREE.Material: '"+e+"' parameter is undefined.");continue}if("shading"===e){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===i;continue}const n=this[e];void 0!==n?n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[e]=i:console.warn("THREE."+this.type+": '"+e+"' is not a property of this material.")}},toJSON:function(t){const e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{}});const i={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function n(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),this.sheen&&this.sheen.isColor&&(i.sheen=this.sheen.getHex()),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(t).uuid),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(t).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(t).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(t).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(t).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(t).uuid,i.reflectivity=this.reflectivity,i.refractionRatio=this.refractionRatio,void 0!==this.combine&&(i.combine=this.combine),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity)),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.size&&(i.size=this.size),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(i.blending=this.blending),!0===this.flatShading&&(i.flatShading=this.flatShading),0!==this.side&&(i.side=this.side),this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=this.transparent),i.depthFunc=this.depthFunc,i.depthTest=this.depthTest,i.depthWrite=this.depthWrite,i.stencilWrite=this.stencilWrite,i.stencilWriteMask=this.stencilWriteMask,i.stencilFunc=this.stencilFunc,i.stencilRef=this.stencilRef,i.stencilFuncMask=this.stencilFuncMask,i.stencilFail=this.stencilFail,i.stencilZFail=this.stencilZFail,i.stencilZPass=this.stencilZPass,this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(i.wireframe=this.wireframe),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(i.morphTargets=!0),!0===this.morphNormals&&(i.morphNormals=!0),!0===this.skinning&&(i.skinning=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),e){const e=n(t.textures),r=n(t.images);e.length>0&&(i.textures=e),r.length>0&&(i.images=r)}return i},clone:function(){return(new this.constructor).copy(this)},copy:function(t){this.name=t.name,this.fog=t.fog,this.blending=t.blending,this.side=t.side,this.flatShading=t.flatShading,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let i=null;if(null!==e){const t=e.length;i=new Array(t);for(let n=0;n!==t;++n)i[n]=e[n].clone()}return this.clippingPlanes=i,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.premultipliedAlpha=t.premultipliedAlpha,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.defineProperty(Pe.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}});const Ne={clone:Re,merge:De};function Ie(t){Pe.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==t&&(void 0!==t.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(t))}Ie.prototype=Object.create(Pe.prototype),Ie.prototype.constructor=Ie,Ie.prototype.isShaderMaterial=!0,Ie.prototype.copy=function(t){return Pe.prototype.copy.call(this,t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=Re(t.uniforms),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.lights=t.lights,this.clipping=t.clipping,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this.extensions=Object.assign({},t.extensions),this.glslVersion=t.glslVersion,this},Ie.prototype.toJSON=function(t){const e=Pe.prototype.toJSON.call(this,t);e.glslVersion=this.glslVersion,e.uniforms={};for(const i in this.uniforms){const n=this.uniforms[i].value;n&&n.isTexture?e.uniforms[i]={type:"t",value:n.toJSON(t).uuid}:n&&n.isColor?e.uniforms[i]={type:"c",value:n.getHex()}:n&&n.isVector2?e.uniforms[i]={type:"v2",value:n.toArray()}:n&&n.isVector3?e.uniforms[i]={type:"v3",value:n.toArray()}:n&&n.isVector4?e.uniforms[i]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?e.uniforms[i]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?e.uniforms[i]={type:"m4",value:n.toArray()}:e.uniforms[i]={value:n}}Object.keys(this.defines).length>0&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader;const i={};for(const t in this.extensions)!0===this.extensions[t]&&(i[t]=!0);return Object.keys(i).length>0&&(e.extensions=i),e};const Oe=new J,Fe=new J,Ue=new J,ze=new J,ke=new J,Be=new J,Ge=new J;class He{constructor(t,e){this.origin=void 0!==t?t:new J,this.direction=void 0!==e?e:new J(0,0,-1)}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return void 0===e&&(console.warn("THREE.Ray: .at() target is now required"),e=new J),e.copy(this.direction).multiplyScalar(t).add(this.origin)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,Oe)),this}closestPointToPoint(t,e){void 0===e&&(console.warn("THREE.Ray: .closestPointToPoint() target is now required"),e=new J),e.subVectors(t,this.origin);const i=e.dot(this.direction);return i<0?e.copy(this.origin):e.copy(this.direction).multiplyScalar(i).add(this.origin)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=Oe.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(Oe.copy(this.direction).multiplyScalar(e).add(this.origin),Oe.distanceToSquared(t))}distanceSqToSegment(t,e,i,n){Fe.copy(t).add(e).multiplyScalar(.5),Ue.copy(e).sub(t).normalize(),ze.copy(this.origin).sub(Fe);const r=.5*t.distanceTo(e),s=-this.direction.dot(Ue),a=ze.dot(this.direction),o=-ze.dot(Ue),h=ze.lengthSq(),l=Math.abs(1-s*s);let c,u,d,p;if(l>0)if(c=s*o-a,u=s*a-o,p=r*l,c>=0)if(u>=-p)if(u<=p){const t=1/l;c*=t,u*=t,d=c*(c+s*u+2*a)+u*(s*c+u+2*o)+h}else u=r,c=Math.max(0,-(s*u+a)),d=-c*c+u*(u+2*o)+h;else u=-r,c=Math.max(0,-(s*u+a)),d=-c*c+u*(u+2*o)+h;else u<=-p?(c=Math.max(0,-(-s*r+a)),u=c>0?-r:Math.min(Math.max(-r,-o),r),d=-c*c+u*(u+2*o)+h):u<=p?(c=0,u=Math.min(Math.max(-r,-o),r),d=u*(u+2*o)+h):(c=Math.max(0,-(s*r+a)),u=c>0?r:Math.min(Math.max(-r,-o),r),d=-c*c+u*(u+2*o)+h);else u=s>0?-r:r,c=Math.max(0,-(s*u+a)),d=-c*c+u*(u+2*o)+h;return i&&i.copy(this.direction).multiplyScalar(c).add(this.origin),n&&n.copy(Ue).multiplyScalar(u).add(Fe),d}intersectSphere(t,e){Oe.subVectors(t.center,this.origin);const i=Oe.dot(this.direction),n=Oe.dot(Oe)-i*i,r=t.radius*t.radius;if(n>r)return null;const s=Math.sqrt(r-n),a=i-s,o=i+s;return a<0&&o<0?null:a<0?this.at(o,e):this.at(a,e)}intersectsSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(t.normal)+t.constant)/e;return i>=0?i:null}intersectPlane(t,e){const i=this.distanceToPlane(t);return null===i?null:this.at(i,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);if(0===e)return!0;return t.normal.dot(this.direction)*e<0}intersectBox(t,e){let i,n,r,s,a,o;const h=1/this.direction.x,l=1/this.direction.y,c=1/this.direction.z,u=this.origin;return h>=0?(i=(t.min.x-u.x)*h,n=(t.max.x-u.x)*h):(i=(t.max.x-u.x)*h,n=(t.min.x-u.x)*h),l>=0?(r=(t.min.y-u.y)*l,s=(t.max.y-u.y)*l):(r=(t.max.y-u.y)*l,s=(t.min.y-u.y)*l),i>s||r>n?null:((r>i||i!=i)&&(i=r),(s<n||n!=n)&&(n=s),c>=0?(a=(t.min.z-u.z)*c,o=(t.max.z-u.z)*c):(a=(t.max.z-u.z)*c,o=(t.min.z-u.z)*c),i>o||a>n?null:((a>i||i!=i)&&(i=a),(o<n||n!=n)&&(n=o),n<0?null:this.at(i>=0?i:n,e)))}intersectsBox(t){return null!==this.intersectBox(t,Oe)}intersectTriangle(t,e,i,n,r){ke.subVectors(e,t),Be.subVectors(i,t),Ge.crossVectors(ke,Be);let s,a=this.direction.dot(Ge);if(a>0){if(n)return null;s=1}else{if(!(a<0))return null;s=-1,a=-a}ze.subVectors(this.origin,t);const o=s*this.direction.dot(Be.crossVectors(ze,Be));if(o<0)return null;const h=s*this.direction.dot(ke.cross(ze));if(h<0)return null;if(o+h>a)return null;const l=-s*ze.dot(Ge);return l<0?null:this.at(l/a,r)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}}const Ve=new J,We=new J,je=new J,Xe=new J,qe=new J,Ye=new J,Ze=new J,Je=new J,Qe=new J,Ke=new J;class $e{constructor(t,e,i){this.a=void 0!==t?t:new J,this.b=void 0!==e?e:new J,this.c=void 0!==i?i:new J}static getNormal(t,e,i,n){void 0===n&&(console.warn("THREE.Triangle: .getNormal() target is now required"),n=new J),n.subVectors(i,e),Ve.subVectors(t,e),n.cross(Ve);const r=n.lengthSq();return r>0?n.multiplyScalar(1/Math.sqrt(r)):n.set(0,0,0)}static getBarycoord(t,e,i,n,r){Ve.subVectors(n,e),We.subVectors(i,e),je.subVectors(t,e);const s=Ve.dot(Ve),a=Ve.dot(We),o=Ve.dot(je),h=We.dot(We),l=We.dot(je),c=s*h-a*a;if(void 0===r&&(console.warn("THREE.Triangle: .getBarycoord() target is now required"),r=new J),0===c)return r.set(-2,-1,-1);const u=1/c,d=(h*o-a*l)*u,p=(s*l-a*o)*u;return r.set(1-d-p,p,d)}static containsPoint(t,e,i,n){return this.getBarycoord(t,e,i,n,Xe),Xe.x>=0&&Xe.y>=0&&Xe.x+Xe.y<=1}static getUV(t,e,i,n,r,s,a,o){return this.getBarycoord(t,e,i,n,Xe),o.set(0,0),o.addScaledVector(r,Xe.x),o.addScaledVector(s,Xe.y),o.addScaledVector(a,Xe.z),o}static isFrontFacing(t,e,i,n){return Ve.subVectors(i,e),We.subVectors(t,e),Ve.cross(We).dot(n)<0}set(t,e,i){return this.a.copy(t),this.b.copy(e),this.c.copy(i),this}setFromPointsAndIndices(t,e,i,n){return this.a.copy(t[e]),this.b.copy(t[i]),this.c.copy(t[n]),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return Ve.subVectors(this.c,this.b),We.subVectors(this.a,this.b),.5*Ve.cross(We).length()}getMidpoint(t){return void 0===t&&(console.warn("THREE.Triangle: .getMidpoint() target is now required"),t=new J),t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return $e.getNormal(this.a,this.b,this.c,t)}getPlane(t){return void 0===t&&(console.warn("THREE.Triangle: .getPlane() target is now required"),t=new xt),t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return $e.getBarycoord(t,this.a,this.b,this.c,e)}getUV(t,e,i,n,r){return $e.getUV(t,this.a,this.b,this.c,e,i,n,r)}containsPoint(t){return $e.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return $e.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){void 0===e&&(console.warn("THREE.Triangle: .closestPointToPoint() target is now required"),e=new J);const i=this.a,n=this.b,r=this.c;let s,a;qe.subVectors(n,i),Ye.subVectors(r,i),Je.subVectors(t,i);const o=qe.dot(Je),h=Ye.dot(Je);if(o<=0&&h<=0)return e.copy(i);Qe.subVectors(t,n);const l=qe.dot(Qe),c=Ye.dot(Qe);if(l>=0&&c<=l)return e.copy(n);const u=o*c-l*h;if(u<=0&&o>=0&&l<=0)return s=o/(o-l),e.copy(i).addScaledVector(qe,s);Ke.subVectors(t,r);const d=qe.dot(Ke),p=Ye.dot(Ke);if(p>=0&&d<=p)return e.copy(r);const f=d*h-o*p;if(f<=0&&h>=0&&p<=0)return a=h/(h-p),e.copy(i).addScaledVector(Ye,a);const m=l*p-d*c;if(m<=0&&c-l>=0&&d-p>=0)return Ze.subVectors(r,n),a=(c-l)/(c-l+(d-p)),e.copy(n).addScaledVector(Ze,a);const g=1/(m+f+u);return s=f*g,a=u*g,e.copy(i).addScaledVector(qe,s).addScaledVector(Ye,a)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}class ti{constructor(t,e,i,n,r,s=0){this.a=t,this.b=e,this.c=i,this.normal=n&&n.isVector3?n:new J,this.vertexNormals=Array.isArray(n)?n:[],this.color=r&&r.isColor?r:new Ut,this.vertexColors=Array.isArray(r)?r:[],this.materialIndex=s}clone(){return(new this.constructor).copy(this)}copy(t){this.a=t.a,this.b=t.b,this.c=t.c,this.normal.copy(t.normal),this.color.copy(t.color),this.materialIndex=t.materialIndex;for(let e=0,i=t.vertexNormals.length;e<i;e++)this.vertexNormals[e]=t.vertexNormals[e].clone();for(let e=0,i=t.vertexColors.length;e<i;e++)this.vertexColors[e]=t.vertexColors[e].clone();return this}}function ei(t){Pe.call(this),this.type="MeshBasicMaterial",this.color=new Ut(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.setValues(t)}ei.prototype=Object.create(Pe.prototype),ei.prototype.constructor=ei,ei.prototype.isMeshBasicMaterial=!0,ei.prototype.copy=function(t){return Pe.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this};const ii=new wt,ni=new He,ri=new mt,si=new J,ai=new J,oi=new J,hi=new J,li=new J,ci=new J,ui=new J,di=new J,pi=new J,fi=new k,mi=new k,gi=new k,vi=new J,yi=new J;function xi(t=new Te,e=new ei){ve.call(this),this.type="Mesh",this.geometry=t,this.material=e,this.updateMorphTargets()}function _i(t,e,i,n,r,s,a,o){let h;if(h=1===e.side?n.intersectTriangle(a,s,r,!0,o):n.intersectTriangle(r,s,a,2!==e.side,o),null===h)return null;yi.copy(o),yi.applyMatrix4(t.matrixWorld);const l=i.ray.origin.distanceTo(yi);return l<i.near||l>i.far?null:{distance:l,point:yi.clone(),object:t}}function Mi(t,e,i,n,r,s,a,o,h,l,c,u){si.fromBufferAttribute(r,l),ai.fromBufferAttribute(r,c),oi.fromBufferAttribute(r,u);const d=t.morphTargetInfluences;if(e.morphTargets&&s&&d){ui.set(0,0,0),di.set(0,0,0),pi.set(0,0,0);for(let t=0,e=s.length;t<e;t++){const e=d[t],i=s[t];0!==e&&(hi.fromBufferAttribute(i,l),li.fromBufferAttribute(i,c),ci.fromBufferAttribute(i,u),a?(ui.addScaledVector(hi,e),di.addScaledVector(li,e),pi.addScaledVector(ci,e)):(ui.addScaledVector(hi.sub(si),e),di.addScaledVector(li.sub(ai),e),pi.addScaledVector(ci.sub(oi),e)))}si.add(ui),ai.add(di),oi.add(pi)}t.isSkinnedMesh&&(t.boneTransform(l,si),t.boneTransform(c,ai),t.boneTransform(u,oi));const p=_i(t,e,i,n,si,ai,oi,vi);if(p){o&&(fi.fromBufferAttribute(o,l),mi.fromBufferAttribute(o,c),gi.fromBufferAttribute(o,u),p.uv=$e.getUV(vi,si,ai,oi,fi,mi,gi,new k)),h&&(fi.fromBufferAttribute(h,l),mi.fromBufferAttribute(h,c),gi.fromBufferAttribute(h,u),p.uv2=$e.getUV(vi,si,ai,oi,fi,mi,gi,new k));const t=new ti(l,c,u);$e.getNormal(si,ai,oi,t.normal),p.face=t}return p}xi.prototype=Object.assign(Object.create(ve.prototype),{constructor:xi,isMesh:!0,copy:function(t){return ve.prototype.copy.call(this,t),void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=t.material,this.geometry=t.geometry,this},updateMorphTargets:function(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,i=Object.keys(e);if(i.length>0){const t=e[i[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=t.length;e<i;e++){const i=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}},raycast:function(t,e){const i=this.geometry,n=this.material,r=this.matrixWorld;if(void 0===n)return;if(null===i.boundingSphere&&i.computeBoundingSphere(),ri.copy(i.boundingSphere),ri.applyMatrix4(r),!1===t.ray.intersectsSphere(ri))return;if(ii.copy(r).invert(),ni.copy(t.ray).applyMatrix4(ii),null!==i.boundingBox&&!1===ni.intersectsBox(i.boundingBox))return;let s;if(i.isBufferGeometry){const r=i.index,a=i.attributes.position,o=i.morphAttributes.position,h=i.morphTargetsRelative,l=i.attributes.uv,c=i.attributes.uv2,u=i.groups,d=i.drawRange;if(null!==r)if(Array.isArray(n))for(let i=0,p=u.length;i<p;i++){const p=u[i],f=n[p.materialIndex];for(let i=Math.max(p.start,d.start),n=Math.min(p.start+p.count,d.start+d.count);i<n;i+=3){const n=r.getX(i),u=r.getX(i+1),d=r.getX(i+2);s=Mi(this,f,t,ni,a,o,h,l,c,n,u,d),s&&(s.faceIndex=Math.floor(i/3),s.face.materialIndex=p.materialIndex,e.push(s))}}else{for(let i=Math.max(0,d.start),u=Math.min(r.count,d.start+d.count);i<u;i+=3){const u=r.getX(i),d=r.getX(i+1),p=r.getX(i+2);s=Mi(this,n,t,ni,a,o,h,l,c,u,d,p),s&&(s.faceIndex=Math.floor(i/3),e.push(s))}}else if(void 0!==a)if(Array.isArray(n))for(let i=0,r=u.length;i<r;i++){const r=u[i],p=n[r.materialIndex];for(let i=Math.max(r.start,d.start),n=Math.min(r.start+r.count,d.start+d.count);i<n;i+=3){s=Mi(this,p,t,ni,a,o,h,l,c,i,i+1,i+2),s&&(s.faceIndex=Math.floor(i/3),s.face.materialIndex=r.materialIndex,e.push(s))}}else{for(let i=Math.max(0,d.start),r=Math.min(a.count,d.start+d.count);i<r;i+=3){s=Mi(this,n,t,ni,a,o,h,l,c,i,i+1,i+2),s&&(s.faceIndex=Math.floor(i/3),e.push(s))}}}else if(i.isGeometry){const r=Array.isArray(n),a=i.vertices,o=i.faces;let h;const l=i.faceVertexUvs[0];l.length>0&&(h=l);for(let i=0,l=o.length;i<l;i++){const l=o[i],c=r?n[l.materialIndex]:n;if(void 0===c)continue;const u=a[l.a],d=a[l.b],p=a[l.c];if(s=_i(this,c,t,ni,u,d,p,vi),s){if(h&&h[i]){const t=h[i];fi.copy(t[0]),mi.copy(t[1]),gi.copy(t[2]),s.uv=$e.getUV(vi,u,d,p,fi,mi,gi,new k)}s.face=l,s.faceIndex=i,e.push(s)}}}}});const bi={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"vec3 transformed = vec3( position );",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"vec2 integrateSpecularBRDF( const in float dotNV, const in float roughness ) {\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\treturn vec2( -1.04, 1.04 ) * a004 + r.zw;\n}\nfloat punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n#else\n\tif( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t}\n\treturn 1.0;\n#endif\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nvec3 F_Schlick_RoughnessDependent( const in vec3 F0, const in float dotNV, const in float roughness ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotNV - 6.98316 ) * dotNV );\n\tvec3 Fr = max( vec3( 1.0 - roughness ), F0 ) - F0;\n\treturn Fr * fresnel + F0;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + viewDir );\n\tfloat dotNL = saturate( dot( normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\nvec3 BRDF_Specular_GGX_Environment( const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\treturn specularColor * brdf.x + brdf.y;\n}\nvoid BRDF_Specular_Multiscattering_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tvec3 F = F_Schlick_RoughnessDependent( specularColor, dotNV, roughness );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\tvec3 FssEss = F * brdf.x + brdf.y;\n\tfloat Ess = brdf.x + brdf.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie(float roughness, float NoH) {\n\tfloat invAlpha = 1.0 / roughness;\n\tfloat cos2h = NoH * NoH;\n\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\treturn (2.0 + invAlpha) * pow(sin2h, invAlpha * 0.5) / (2.0 * PI);\n}\nfloat V_Neubelt(float NoV, float NoL) {\n\treturn saturate(1.0 / (4.0 * (NoL + NoV - NoL * NoV)));\n}\nvec3 BRDF_Specular_Sheen( const in float roughness, const in vec3 L, const in GeometricContext geometry, vec3 specularColor ) {\n\tvec3 N = geometry.normal;\n\tvec3 V = geometry.viewDir;\n\tvec3 H = normalize( V + L );\n\tfloat dotNH = saturate( dot( N, H ) );\n\treturn specularColor * D_Charlie( roughness, dotNH ) * V_Neubelt( dot(N, V), dot(N, L) );\n}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tfDet *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#pragma unroll_loop_end\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\tif ( clipped ) discard;\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor.xyz *= color.xyz;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat max3( vec3 v ) { return max( max( v.x, v.y ), v.z ); }\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n#ifdef CLEARCOAT\n\tvec3 clearcoatNormal;\n#endif\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\treturn dot( weights, color.rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_maxMipLevel 8.0\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_maxTileSize 256.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\tfloat texelSize = 1.0 / ( 3.0 * cubeUV_maxTileSize );\n\t\tvec2 uv = getUV( direction, face ) * ( faceSize - 1.0 );\n\t\tvec2 f = fract( uv );\n\t\tuv += 0.5 - f;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tif ( mipInt < cubeUV_maxMipLevel ) {\n\t\t\tuv.y += 2.0 * cubeUV_maxTileSize;\n\t\t}\n\t\tuv.y += filterInt * 2.0 * cubeUV_minTileSize;\n\t\tuv.x += 3.0 * max( 0.0, cubeUV_maxTileSize - 2.0 * faceSize );\n\t\tuv *= texelSize;\n\t\tvec3 tl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.x += texelSize;\n\t\tvec3 tr = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.y += texelSize;\n\t\tvec3 br = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.x -= texelSize;\n\t\tvec3 bl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tvec3 tm = mix( tl, tr, f.x );\n\t\tvec3 bm = mix( bl, br, f.x );\n\t\treturn mix( tm, bm, f.y );\n\t}\n\t#define r0 1.0\n\t#define v0 0.339\n\t#define m0 - 2.0\n\t#define r1 0.8\n\t#define v1 0.276\n\t#define m1 - 1.0\n\t#define r4 0.4\n\t#define v4 0.046\n\t#define m4 2.0\n\t#define r5 0.305\n\t#define v5 0.016\n\t#define m5 3.0\n\t#define r6 0.21\n\t#define v6 0.0038\n\t#define m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= r1 ) {\n\t\t\tmip = ( r0 - roughness ) * ( m1 - m0 ) / ( r0 - r1 ) + m0;\n\t\t} else if ( roughness >= r4 ) {\n\t\t\tmip = ( r1 - roughness ) * ( m4 - m1 ) / ( r1 - r4 ) + m1;\n\t\t} else if ( roughness >= r5 ) {\n\t\t\tmip = ( r4 - roughness ) * ( m5 - m4 ) / ( r4 - r5 ) + m4;\n\t\t} else if ( roughness >= r6 ) {\n\t\t\tmip = ( r5 - roughness ) * ( m6 - m5 ) / ( r5 - r6 ) + m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), m0, cubeUV_maxMipLevel );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_INSTANCING\n\tmat3 m = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n\ttransformedNormal = m * transformedNormal;\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",encodings_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( gammaFactor ) ), value.a );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( 1.0 / gammaFactor ) ), value.a );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * value.a * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat M = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat D = max( maxRange / maxRGB, 1.0 );\n\tD = clamp( floor( D ) / 255.0, 0.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value ) {\n\tvec3 Xp_Y_XYZp = cLogLuvM * value.rgb;\n\tXp_Y_XYZp = max( Xp_Y_XYZp, vec3( 1e-6, 1e-6, 1e-6 ) );\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract( Le );\n\tvResult.z = ( Le - ( floor( vResult.w * 255.0 ) ) / 255.0 ) / 255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2( ( Le - 127.0 ) / 2.0 );\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;\n\treturn vec4( max( vRGB, 0.0 ), 1.0 );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 envColor = textureCubeUV( envMap, reflectVec, 0.0 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifndef ENVMAP_TYPE_CUBE_UV\n\t\tenvColor = envMapTexelToLinear( envColor );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform int maxMipLevel;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ||defined( PHONG )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#if defined( USE_ENVMAP )\n\t#ifdef ENVMAP_MODE_REFRACTION\n\t\tuniform float refractionRatio;\n\t#endif\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float roughness, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat sigma = PI * roughness * roughness / ( 1.0 + roughness );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar + log2( sigma );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -viewDir, normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( roughness, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tfogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float fogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * fogDepth * fogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn texture2D( gradientMap, coord ).rgb;\n\t#else\n\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\treflectedLight.indirectDiffuse += PI * lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\nvIndirectFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n\tvIndirectBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\nvIndirectFront += getAmbientLightIrradiance( ambientLightColor );\nvIndirectFront += getLightProbeIrradiance( lightProbe, geometry );\n#ifdef DOUBLE_SIDED\n\tvIndirectBack += getAmbientLightIrradiance( ambientLightColor );\n\tvIndirectBack += getLightProbeIrradiance( lightProbe, backGeometry );\n#endif\n#if NUM_POINT_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_DIR_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\nuniform vec3 lightProbe[ 9 ];\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in GeometricContext geometry ) {\n\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon\n#define Material_LightProbeLOD( material )\t(0)",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.specularRoughness = max( roughnessFactor, 0.0525 );material.specularRoughness += geometryRoughness;\nmaterial.specularRoughness = min( material.specularRoughness, 1.0 );\n#ifdef REFLECTIVITY\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#endif\n#ifdef CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheen;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat specularRoughness;\n\tvec3 specularColor;\n#ifdef CLEARCOAT\n\tfloat clearcoat;\n\tfloat clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tvec3 sheenColor;\n#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearcoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifdef CLEARCOAT\n\t\tfloat ccDotNL = saturate( dot( geometry.clearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = ccDotNL * directLight.color;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tccIrradiance *= PI;\n\t\t#endif\n\t\tfloat clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );\n\t\treflectedLight.directSpecular += ccIrradiance * material.clearcoat * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );\n\t#else\n\t\tfloat clearcoatDHR = 0.0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\treflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_Sheen(\n\t\t\tmaterial.specularRoughness,\n\t\t\tdirectLight.direction,\n\t\t\tgeometry,\n\t\t\tmaterial.sheenColor\n\t\t);\n\t#else\n\t\treflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.normal, material.specularColor, material.specularRoughness);\n\t#endif\n\treflectedLight.directDiffuse += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef CLEARCOAT\n\t\tfloat ccDotNV = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular += clearcoatRadiance * material.clearcoat * BRDF_Specular_GGX_Environment( geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );\n\t\tfloat ccDotNL = ccDotNV;\n\t\tfloat clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );\n\t#else\n\t\tfloat clearcoatDHR = 0.0;\n\t#endif\n\tfloat clearcoatInv = 1.0 - clearcoatDHR;\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\tBRDF_Specular_Multiscattering_Environment( geometry, material.specularColor, material.specularRoughness, singleScattering, multiScattering );\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );\n\treflectedLight.indirectSpecular += clearcoatInv * radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n#ifdef CLEARCOAT\n\tgeometry.clearcoatNormal = clearcoatNormal;\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\tirradiance += getLightProbeIrradiance( lightProbe, geometry );\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\tvec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getLightProbeIndirectIrradiance( geometry, maxMipLevel );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tradiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, maxMipLevel );\n\t#ifdef CLEARCOAT\n\t\tclearcoatRadiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, maxMipLevel );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometry, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n#endif\n#ifdef USE_MAP\n\tvec4 mapTexel = texture2D( map, uv );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tuniform mat3 uvTransform;\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifndef USE_MORPHNORMALS\n\t\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\t\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t#endif\n#endif",normal_fragment_begin:"#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t#endif\n\t#ifdef USE_TANGENT\n\t\tvec3 tangent = normalize( vTangent );\n\t\tvec3 bitangent = normalize( vBitangent );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\ttangent = tangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t\tbitangent = bitangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t#endif\n\t\t#if defined( TANGENTSPACE_NORMALMAP ) || defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tmat3 vTBN = mat3( tangent, bitangent, normal );\n\t\t#endif\n\t#endif\n#endif\nvec3 geometryNormal = normal;",normal_fragment_maps:"#ifdef OBJECTSPACE_NORMALMAP\n\tnormal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( TANGENTSPACE_NORMALMAP )\n\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\t#ifdef USE_TANGENT\n\t\tnormal = normalize( vTBN * mapN );\n\t#else\n\t\tnormal = perturbNormal2Arb( -vViewPosition, normal, mapN );\n\t#endif\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( TANGENTSPACE_NORMALMAP ) || defined ( USE_CLEARCOAT_NORMALMAP ) )\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 mapN ) {\n\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tfloat scale = sign( st1.t * st0.s - st0.t * st1.s );\n\t\tvec3 S = normalize( ( q0 * st1.t - q1 * st0.t ) * scale );\n\t\tvec3 T = normalize( ( - q0 * st1.s + q1 * st0.s ) * scale );\n\t\tvec3 N = normalize( surf_norm );\n\t\tmat3 tsn = mat3( S, T, N );\n\t\tmapN.xy *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\treturn normalize( tsn * mapN );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef CLEARCOAT\n\tvec3 clearcoatNormal = geometryNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\t#ifdef USE_TANGENT\n\t\tclearcoatNormal = normalize( vTBN * clearcoatMapN );\n\t#else\n\t\tclearcoatNormal = perturbNormal2Arb( - vViewPosition, clearcoatNormal, clearcoatMapN );\n\t#endif\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ));\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w);\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0 || NUM_SPOT_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0\n\t\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\tvec4 shadowWorldPosition;\n\t#endif\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform highp sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmissionmap_fragment:"#ifdef USE_TRANSMISSIONMAP\n\ttotalTransmission *= texture2D( transmissionMap, vUv ).r;\n#endif",transmissionmap_pars_fragment:"#ifdef USE_TRANSMISSIONMAP\n\tuniform sampler2D transmissionMap;\n#endif",uv_pars_fragment:"#if ( defined( USE_UV ) && ! defined( UVS_VERTEX_ONLY ) )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#ifdef USE_UV\n\t#ifdef UVS_VERTEX_ONLY\n\t\tvec2 vUv;\n\t#else\n\t\tvarying vec2 vUv;\n\t#endif\n\tuniform mat3 uvTransform;\n#endif",uv_vertex:"#ifdef USE_UV\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n\tuniform mat3 uv2Transform;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = ( uv2Transform * vec3( uv2, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_frag:"uniform sampler2D t2D;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",cube_frag:"#include <envmap_common_pars_fragment>\nuniform float opacity;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\tvec3 vReflect = vWorldDirection;\n\t#include <envmap_fragment>\n\tgl_FragColor = envColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tvec4 texColor = texture2D( tEquirect, sampleUV );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;\n\t#else\n\t\treflectedLight.indirectDiffuse += vIndirectFront;\n\t#endif\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t\tmatcapColor = matcapTexelToLinear( matcapColor );\n\t#else\n\t\tvec4 matcapColor = vec4( 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#ifndef FLAT_SHADED\n\t\tvNormal = normalize( transformedNormal );\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define REFLECTIVITY\n\t#define CLEARCOAT\n\t#define TRANSMISSION\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef TRANSMISSION\n\tuniform float transmission;\n#endif\n#ifdef REFLECTIVITY\n\tuniform float reflectivity;\n#endif\n#ifdef CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheen;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <transmissionmap_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#ifdef TRANSMISSION\n\t\tfloat totalTransmission = transmission;\n\t#endif\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <transmissionmap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#ifdef TRANSMISSION\n\t\tdiffuseColor.a *= mix( saturate( 1. - totalTransmission + linearToRelativeLuminance( reflectedLight.directSpecular + reflectedLight.indirectSpecular ) ), 1.0, metalness );\n\t#endif\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}",normal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",shadow_vert:"#include <common>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}"},wi={common:{diffuse:{value:new Ut(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new B},uv2Transform:{value:new B},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new k(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Ut(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Ut(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},uvTransform:{value:new B}},sprite:{diffuse:{value:new Ut(15658734)},opacity:{value:1},center:{value:new k(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},uvTransform:{value:new B}}},Si={basic:{uniforms:De([wi.common,wi.specularmap,wi.envmap,wi.aomap,wi.lightmap,wi.fog]),vertexShader:bi.meshbasic_vert,fragmentShader:bi.meshbasic_frag},lambert:{uniforms:De([wi.common,wi.specularmap,wi.envmap,wi.aomap,wi.lightmap,wi.emissivemap,wi.fog,wi.lights,{emissive:{value:new Ut(0)}}]),vertexShader:bi.meshlambert_vert,fragmentShader:bi.meshlambert_frag},phong:{uniforms:De([wi.common,wi.specularmap,wi.envmap,wi.aomap,wi.lightmap,wi.emissivemap,wi.bumpmap,wi.normalmap,wi.displacementmap,wi.fog,wi.lights,{emissive:{value:new Ut(0)},specular:{value:new Ut(1118481)},shininess:{value:30}}]),vertexShader:bi.meshphong_vert,fragmentShader:bi.meshphong_frag},standard:{uniforms:De([wi.common,wi.envmap,wi.aomap,wi.lightmap,wi.emissivemap,wi.bumpmap,wi.normalmap,wi.displacementmap,wi.roughnessmap,wi.metalnessmap,wi.fog,wi.lights,{emissive:{value:new Ut(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:bi.meshphysical_vert,fragmentShader:bi.meshphysical_frag},toon:{uniforms:De([wi.common,wi.aomap,wi.lightmap,wi.emissivemap,wi.bumpmap,wi.normalmap,wi.displacementmap,wi.gradientmap,wi.fog,wi.lights,{emissive:{value:new Ut(0)}}]),vertexShader:bi.meshtoon_vert,fragmentShader:bi.meshtoon_frag},matcap:{uniforms:De([wi.common,wi.bumpmap,wi.normalmap,wi.displacementmap,wi.fog,{matcap:{value:null}}]),vertexShader:bi.meshmatcap_vert,fragmentShader:bi.meshmatcap_frag},points:{uniforms:De([wi.points,wi.fog]),vertexShader:bi.points_vert,fragmentShader:bi.points_frag},dashed:{uniforms:De([wi.common,wi.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:bi.linedashed_vert,fragmentShader:bi.linedashed_frag},depth:{uniforms:De([wi.common,wi.displacementmap]),vertexShader:bi.depth_vert,fragmentShader:bi.depth_frag},normal:{uniforms:De([wi.common,wi.bumpmap,wi.normalmap,wi.displacementmap,{opacity:{value:1}}]),vertexShader:bi.normal_vert,fragmentShader:bi.normal_frag},sprite:{uniforms:De([wi.sprite,wi.fog]),vertexShader:bi.sprite_vert,fragmentShader:bi.sprite_frag},background:{uniforms:{uvTransform:{value:new B},t2D:{value:null}},vertexShader:bi.background_vert,fragmentShader:bi.background_frag},cube:{uniforms:De([wi.envmap,{opacity:{value:1}}]),vertexShader:bi.cube_vert,fragmentShader:bi.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:bi.equirect_vert,fragmentShader:bi.equirect_frag},distanceRGBA:{uniforms:De([wi.common,wi.displacementmap,{referencePosition:{value:new J},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:bi.distanceRGBA_vert,fragmentShader:bi.distanceRGBA_frag},shadow:{uniforms:De([wi.lights,wi.fog,{color:{value:new Ut(0)},opacity:{value:1}}]),vertexShader:bi.shadow_vert,fragmentShader:bi.shadow_frag}};function Ei(t,e,i,n,r){const s=new Ut(0);let a,o,h=0,l=null,c=0,u=null;function d(t,e){i.buffers.color.setClear(t.r,t.g,t.b,e,r)}return{getClearColor:function(){return s},setClearColor:function(t,e=1){s.set(t),h=e,d(s,h)},getClearAlpha:function(){return h},setClearAlpha:function(t){h=t,d(s,h)},render:function(i,r,p,f){let m=!0===r.isScene?r.background:null;m&&m.isTexture&&(m=e.get(m));const g=t.xr,v=g.getSession&&g.getSession();v&&"additive"===v.environmentBlendMode&&(m=null),null===m?d(s,h):m&&m.isColor&&(d(m,1),f=!0),(t.autoClear||f)&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),m&&(m.isCubeTexture||m.isWebGLCubeRenderTarget||306===m.mapping)?(void 0===o&&(o=new xi(new Le(1,1,1),new Ie({name:"BackgroundCubeMaterial",uniforms:Re(Si.cube.uniforms),vertexShader:Si.cube.vertexShader,fragmentShader:Si.cube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1})),o.geometry.deleteAttribute("normal"),o.geometry.deleteAttribute("uv"),o.onBeforeRender=function(t,e,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(o.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),n.update(o)),m.isWebGLCubeRenderTarget&&(m=m.texture),o.material.uniforms.envMap.value=m,o.material.uniforms.flipEnvMap.value=m.isCubeTexture&&m._needsFlipEnvMap?-1:1,l===m&&c===m.version&&u===t.toneMapping||(o.material.needsUpdate=!0,l=m,c=m.version,u=t.toneMapping),i.unshift(o,o.geometry,o.material,0,0,null)):m&&m.isTexture&&(void 0===a&&(a=new xi(new Ce(2,2),new Ie({name:"BackgroundMaterial",uniforms:Re(Si.background.uniforms),vertexShader:Si.background.vertexShader,fragmentShader:Si.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1})),a.geometry.deleteAttribute("normal"),Object.defineProperty(a.material,"map",{get:function(){return this.uniforms.t2D.value}}),n.update(a)),a.material.uniforms.t2D.value=m,!0===m.matrixAutoUpdate&&m.updateMatrix(),a.material.uniforms.uvTransform.value.copy(m.matrix),l===m&&c===m.version&&u===t.toneMapping||(a.material.needsUpdate=!0,l=m,c=m.version,u=t.toneMapping),i.unshift(a,a.geometry,a.material,0,0,null))}}}function Ti(t,e,i,n){const r=t.getParameter(t.MAX_VERTEX_ATTRIBS),s=n.isWebGL2?null:e.get("OES_vertex_array_object"),a=n.isWebGL2||null!==s,o={},h=d(null);let l=h;function c(e){return n.isWebGL2?t.bindVertexArray(e):s.bindVertexArrayOES(e)}function u(e){return n.isWebGL2?t.deleteVertexArray(e):s.deleteVertexArrayOES(e)}function d(t){const e=[],i=[],n=[];for(let t=0;t<r;t++)e[t]=0,i[t]=0,n[t]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:e,enabledAttributes:i,attributeDivisors:n,object:t,attributes:{},index:null}}function p(){const t=l.newAttributes;for(let e=0,i=t.length;e<i;e++)t[e]=0}function f(t){m(t,0)}function m(i,r){const s=l.newAttributes,a=l.enabledAttributes,o=l.attributeDivisors;if(s[i]=1,0===a[i]&&(t.enableVertexAttribArray(i),a[i]=1),o[i]!==r){(n.isWebGL2?t:e.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](i,r),o[i]=r}}function g(){const e=l.newAttributes,i=l.enabledAttributes;for(let n=0,r=i.length;n<r;n++)i[n]!==e[n]&&(t.disableVertexAttribArray(n),i[n]=0)}function v(e,i,r,s,a,o){!0!==n.isWebGL2||r!==t.INT&&r!==t.UNSIGNED_INT?t.vertexAttribPointer(e,i,r,s,a,o):t.vertexAttribIPointer(e,i,r,a,o)}function y(){x(),l!==h&&(l=h,c(l.object))}function x(){h.geometry=null,h.program=null,h.wireframe=!1}return{setup:function(r,h,u,y,x){let _=!1;if(a){const e=function(e,i,r){const a=!0===r.wireframe;let h=o[e.id];void 0===h&&(h={},o[e.id]=h);let l=h[i.id];void 0===l&&(l={},h[i.id]=l);let c=l[a];void 0===c&&(c=d(n.isWebGL2?t.createVertexArray():s.createVertexArrayOES()),l[a]=c);return c}(y,u,h);l!==e&&(l=e,c(l.object)),_=function(t,e){const i=l.attributes,n=t.attributes;let r=0;for(const t in n){const e=i[t],s=n[t];if(void 0===e)return!0;if(e.attribute!==s)return!0;if(e.data!==s.data)return!0;r++}return l.attributesNum!==r||l.index!==e}(y,x),_&&function(t,e){const i={},n=t.attributes;let r=0;for(const t in n){const e=n[t],s={};s.attribute=e,e.data&&(s.data=e.data),i[t]=s,r++}l.attributes=i,l.attributesNum=r,l.index=e}(y,x)}else{const t=!0===h.wireframe;l.geometry===y.id&&l.program===u.id&&l.wireframe===t||(l.geometry=y.id,l.program=u.id,l.wireframe=t,_=!0)}!0===r.isInstancedMesh&&(_=!0),null!==x&&i.update(x,t.ELEMENT_ARRAY_BUFFER),_&&(!function(r,s,a,o){if(!1===n.isWebGL2&&(r.isInstancedMesh||o.isInstancedBufferGeometry)&&null===e.get("ANGLE_instanced_arrays"))return;p();const h=o.attributes,l=a.getAttributes(),c=s.defaultAttributeValues;for(const e in l){const n=l[e];if(n>=0){const s=h[e];if(void 0!==s){const e=s.normalized,r=s.itemSize,a=i.get(s);if(void 0===a)continue;const h=a.buffer,l=a.type,c=a.bytesPerElement;if(s.isInterleavedBufferAttribute){const i=s.data,a=i.stride,u=s.offset;i&&i.isInstancedInterleavedBuffer?(m(n,i.meshPerAttribute),void 0===o._maxInstanceCount&&(o._maxInstanceCount=i.meshPerAttribute*i.count)):f(n),t.bindBuffer(t.ARRAY_BUFFER,h),v(n,r,l,e,a*c,u*c)}else s.isInstancedBufferAttribute?(m(n,s.meshPerAttribute),void 0===o._maxInstanceCount&&(o._maxInstanceCount=s.meshPerAttribute*s.count)):f(n),t.bindBuffer(t.ARRAY_BUFFER,h),v(n,r,l,e,0,0)}else if("instanceMatrix"===e){const e=i.get(r.instanceMatrix);if(void 0===e)continue;const s=e.buffer,a=e.type;m(n+0,1),m(n+1,1),m(n+2,1),m(n+3,1),t.bindBuffer(t.ARRAY_BUFFER,s),t.vertexAttribPointer(n+0,4,a,!1,64,0),t.vertexAttribPointer(n+1,4,a,!1,64,16),t.vertexAttribPointer(n+2,4,a,!1,64,32),t.vertexAttribPointer(n+3,4,a,!1,64,48)}else if("instanceColor"===e){const e=i.get(r.instanceColor);if(void 0===e)continue;const s=e.buffer,a=e.type;m(n,1),t.bindBuffer(t.ARRAY_BUFFER,s),t.vertexAttribPointer(n,3,a,!1,12,0)}else if(void 0!==c){const i=c[e];if(void 0!==i)switch(i.length){case 2:t.vertexAttrib2fv(n,i);break;case 3:t.vertexAttrib3fv(n,i);break;case 4:t.vertexAttrib4fv(n,i);break;default:t.vertexAttrib1fv(n,i)}}}}g()}(r,h,u,y),null!==x&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i.get(x).buffer))},reset:y,resetDefaultState:x,dispose:function(){y();for(const t in o){const e=o[t];for(const t in e){const i=e[t];for(const t in i)u(i[t].object),delete i[t];delete e[t]}delete o[t]}},releaseStatesOfGeometry:function(t){if(void 0===o[t.id])return;const e=o[t.id];for(const t in e){const i=e[t];for(const t in i)u(i[t].object),delete i[t];delete e[t]}delete o[t.id]},releaseStatesOfProgram:function(t){for(const e in o){const i=o[e];if(void 0===i[t.id])continue;const n=i[t.id];for(const t in n)u(n[t].object),delete n[t];delete i[t.id]}},initAttributes:p,enableAttribute:f,disableUnusedAttributes:g}}function Li(t,e,i,n){const r=n.isWebGL2;let s;this.setMode=function(t){s=t},this.render=function(e,n){t.drawArrays(s,e,n),i.update(n,s,1)},this.renderInstances=function(n,a,o){if(0===o)return;let h,l;if(r)h=t,l="drawArraysInstanced";else if(h=e.get("ANGLE_instanced_arrays"),l="drawArraysInstancedANGLE",null===h)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");h[l](s,n,a,o),i.update(a,s,o)}}function Ci(t,e,i){let n;function r(e){if("highp"===e){if(t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0)return"highp";e="mediump"}return"mediump"===e&&t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}const s="undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||"undefined"!=typeof WebGL2ComputeRenderingContext&&t instanceof WebGL2ComputeRenderingContext;let a=void 0!==i.precision?i.precision:"highp";const o=r(a);o!==a&&(console.warn("THREE.WebGLRenderer:",a,"not supported, using",o,"instead."),a=o);const h=!0===i.logarithmicDepthBuffer,l=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),c=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),u=t.getParameter(t.MAX_TEXTURE_SIZE),d=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),p=t.getParameter(t.MAX_VERTEX_ATTRIBS),f=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),m=t.getParameter(t.MAX_VARYING_VECTORS),g=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),v=c>0,y=s||!!e.get("OES_texture_float");return{isWebGL2:s,getMaxAnisotropy:function(){if(void 0!==n)return n;const i=e.get("EXT_texture_filter_anisotropic");return n=null!==i?t.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,n},getMaxPrecision:r,precision:a,logarithmicDepthBuffer:h,maxTextures:l,maxVertexTextures:c,maxTextureSize:u,maxCubemapSize:d,maxAttributes:p,maxVertexUniforms:f,maxVaryings:m,maxFragmentUniforms:g,vertexTextures:v,floatFragmentTextures:y,floatVertexTextures:v&&y,maxSamples:s?t.getParameter(t.MAX_SAMPLES):0}}function Ai(t){const e=this;let i=null,n=0,r=!1,s=!1;const a=new xt,o=new B,h={value:null,needsUpdate:!1};function l(){h.value!==i&&(h.value=i,h.needsUpdate=n>0),e.numPlanes=n,e.numIntersection=0}function c(t,i,n,r){const s=null!==t?t.length:0;let l=null;if(0!==s){if(l=h.value,!0!==r||null===l){const e=n+4*s,r=i.matrixWorldInverse;o.getNormalMatrix(r),(null===l||l.length<e)&&(l=new Float32Array(e));for(let e=0,i=n;e!==s;++e,i+=4)a.copy(t[e]).applyMatrix4(r,o),a.normal.toArray(l,i),l[i+3]=a.constant}h.value=l,h.needsUpdate=!0}return e.numPlanes=s,e.numIntersection=0,l}this.uniform=h,this.numPlanes=0,this.numIntersection=0,this.init=function(t,e,s){const a=0!==t.length||e||0!==n||r;return r=e,i=c(t,s,0),n=t.length,a},this.beginShadows=function(){s=!0,c(null)},this.endShadows=function(){s=!1,l()},this.setState=function(e,a,o){const u=e.clippingPlanes,d=e.clipIntersection,p=e.clipShadows,f=t.get(e);if(!r||null===u||0===u.length||s&&!p)s?c(null):l();else{const t=s?0:n,e=4*t;let r=f.clippingState||null;h.value=r,r=c(u,a,e,o);for(let t=0;t!==e;++t)r[t]=i[t];f.clippingState=r,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=t}}}function Pi(){ve.call(this),this.type="Camera",this.matrixWorldInverse=new wt,this.projectionMatrix=new wt,this.projectionMatrixInverse=new wt}function Ri(t=50,e=1,i=.1,n=2e3){Pi.call(this),this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=i,this.far=n,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}Si.physical={uniforms:De([Si.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new k(1,1)},clearcoatNormalMap:{value:null},sheen:{value:new Ut(0)},transmission:{value:0},transmissionMap:{value:null}}]),vertexShader:bi.meshphysical_vert,fragmentShader:bi.meshphysical_frag},Pi.prototype=Object.assign(Object.create(ve.prototype),{constructor:Pi,isCamera:!0,copy:function(t,e){return ve.prototype.copy.call(this,t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this},getWorldDirection:function(t){void 0===t&&(console.warn("THREE.Camera: .getWorldDirection() target is now required"),t=new J),this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(-e[8],-e[9],-e[10]).normalize()},updateMatrixWorld:function(t){ve.prototype.updateMatrixWorld.call(this,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()},updateWorldMatrix:function(t,e){ve.prototype.updateWorldMatrix.call(this,t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()},clone:function(){return(new this.constructor).copy(this)}}),Ri.prototype=Object.assign(Object.create(Pi.prototype),{constructor:Ri,isPerspectiveCamera:!0,copy:function(t,e){return Pi.prototype.copy.call(this,t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this},setFocalLength:function(t){const e=.5*this.getFilmHeight()/t;this.fov=2*z.RAD2DEG*Math.atan(e),this.updateProjectionMatrix()},getFocalLength:function(){const t=Math.tan(.5*z.DEG2RAD*this.fov);return.5*this.getFilmHeight()/t},getEffectiveFOV:function(){return 2*z.RAD2DEG*Math.atan(Math.tan(.5*z.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(t,e,i,n,r,s){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){const t=this.near;let e=t*Math.tan(.5*z.DEG2RAD*this.fov)/this.zoom,i=2*e,n=this.aspect*i,r=-.5*n;const s=this.view;if(null!==this.view&&this.view.enabled){const t=s.fullWidth,a=s.fullHeight;r+=s.offsetX*n/t,e-=s.offsetY*i/a,n*=s.width/t,i*=s.height/a}const a=this.filmOffset;0!==a&&(r+=t*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+n,e,e-i,t,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()},toJSON:function(t){const e=ve.prototype.toJSON.call(this,t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}});const Di=90;function Ni(t,e,i){if(ve.call(this),this.type="CubeCamera",!0!==i.isWebGLCubeRenderTarget)return void console.error("THREE.CubeCamera: The constructor now expects an instance of WebGLCubeRenderTarget as third parameter.");this.renderTarget=i;const n=new Ri(Di,1,t,e);n.layers=this.layers,n.up.set(0,-1,0),n.lookAt(new J(1,0,0)),this.add(n);const r=new Ri(Di,1,t,e);r.layers=this.layers,r.up.set(0,-1,0),r.lookAt(new J(-1,0,0)),this.add(r);const s=new Ri(Di,1,t,e);s.layers=this.layers,s.up.set(0,0,1),s.lookAt(new J(0,1,0)),this.add(s);const a=new Ri(Di,1,t,e);a.layers=this.layers,a.up.set(0,0,-1),a.lookAt(new J(0,-1,0)),this.add(a);const o=new Ri(Di,1,t,e);o.layers=this.layers,o.up.set(0,-1,0),o.lookAt(new J(0,0,1)),this.add(o);const h=new Ri(Di,1,t,e);h.layers=this.layers,h.up.set(0,-1,0),h.lookAt(new J(0,0,-1)),this.add(h),this.update=function(t,e){null===this.parent&&this.updateMatrixWorld();const l=t.xr.enabled,c=t.getRenderTarget();t.xr.enabled=!1;const u=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,t.setRenderTarget(i,0),t.render(e,n),t.setRenderTarget(i,1),t.render(e,r),t.setRenderTarget(i,2),t.render(e,s),t.setRenderTarget(i,3),t.render(e,a),t.setRenderTarget(i,4),t.render(e,o),i.texture.generateMipmaps=u,t.setRenderTarget(i,5),t.render(e,h),t.setRenderTarget(c),t.xr.enabled=l}}function Ii(t,e,i,n,r,s,a,o,h,l){t=void 0!==t?t:[],e=void 0!==e?e:301,a=void 0!==a?a:C,W.call(this,t,e,i,n,r,s,a,o,h,l),this.flipY=!1,this._needsFlipEnvMap=!0}function Oi(t,e,i){Number.isInteger(e)&&(console.warn("THREE.WebGLCubeRenderTarget: constructor signature is now WebGLCubeRenderTarget( size, options )"),e=i),q.call(this,t,t,e),e=e||{},this.texture=new Ii(void 0,e.mapping,e.wrapS,e.wrapT,e.magFilter,e.minFilter,e.format,e.type,e.anisotropy,e.encoding),this.texture._needsFlipEnvMap=!1}function Fi(t){let e=new WeakMap;function i(t,e){return 303===e?t.mapping=301:304===e&&(t.mapping=302),t}function n(t){const i=t.target;i.removeEventListener("dispose",n);const r=e.get(i);void 0!==r&&(e.delete(i),r.dispose())}return{get:function(r){if(r&&r.isTexture){const s=r.mapping;if(303===s||304===s){if(e.has(r)){return i(e.get(r).texture,r.mapping)}{const s=r.image;if(s&&s.height>0){const a=t.getRenderList(),o=t.getRenderTarget(),h=new Oi(s.height/2);return h.fromEquirectangularTexture(t,r),e.set(r,h),t.setRenderTarget(o),t.setRenderList(a),r.addEventListener("dispose",n),i(h.texture,r.mapping)}return null}}}return r},dispose:function(){e=new WeakMap}}}function Ui(t){const e={};return{has:function(i){if(void 0!==e[i])return null!==e[i];let n;switch(i){case"WEBGL_depth_texture":n=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=t.getExtension(i)}return e[i]=n,null!==n},get:function(t){return this.has(t)||console.warn("THREE.WebGLRenderer: "+t+" extension not supported."),e[t]}}}function zi(t,e,i,n){const r=new WeakMap,s=new WeakMap;function a(t){const o=t.target,h=r.get(o);null!==h.index&&e.remove(h.index);for(const t in h.attributes)e.remove(h.attributes[t]);o.removeEventListener("dispose",a),r.delete(o);const l=s.get(h);l&&(e.remove(l),s.delete(h)),n.releaseStatesOfGeometry(h),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,i.memory.geometries--}function o(t){const i=[],n=t.index,r=t.attributes.position;let a=0;if(null!==n){const t=n.array;a=n.version;for(let e=0,n=t.length;e<n;e+=3){const n=t[e+0],r=t[e+1],s=t[e+2];i.push(n,r,r,s,s,n)}}else{const t=r.array;a=r.version;for(let e=0,n=t.length/3-1;e<n;e+=3){const t=e+0,n=e+1,r=e+2;i.push(t,n,n,r,r,t)}}const o=new(ye(i)>65535?Zt:qt)(i,1);o.version=a;const h=s.get(t);h&&e.remove(h),s.set(t,o)}return{get:function(t,e){let n=r.get(e);return n||(e.addEventListener("dispose",a),e.isBufferGeometry?n=e:e.isGeometry&&(void 0===e._bufferGeometry&&(e._bufferGeometry=(new Te).setFromObject(t)),n=e._bufferGeometry),r.set(e,n),i.memory.geometries++,n)},update:function(i){const n=i.attributes;for(const i in n)e.update(n[i],t.ARRAY_BUFFER);const r=i.morphAttributes;for(const i in r){const n=r[i];for(let i=0,r=n.length;i<r;i++)e.update(n[i],t.ARRAY_BUFFER)}},getWireframeAttribute:function(t){const e=s.get(t);if(e){const i=t.index;null!==i&&e.version<i.version&&o(t)}else o(t);return s.get(t)}}}function ki(t,e,i,n){const r=n.isWebGL2;let s,a,o;this.setMode=function(t){s=t},this.setIndex=function(t){a=t.type,o=t.bytesPerElement},this.render=function(e,n){t.drawElements(s,n,a,e*o),i.update(n,s,1)},this.renderInstances=function(n,h,l){if(0===l)return;let c,u;if(r)c=t,u="drawElementsInstanced";else if(c=e.get("ANGLE_instanced_arrays"),u="drawElementsInstancedANGLE",null===c)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");c[u](s,h,a,n*o,l),i.update(h,s,l)}}function Bi(t){const e={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:e,programs:null,autoReset:!0,reset:function(){e.frame++,e.calls=0,e.triangles=0,e.points=0,e.lines=0},update:function(i,n,r){switch(e.calls++,n){case t.TRIANGLES:e.triangles+=r*(i/3);break;case t.LINES:e.lines+=r*(i/2);break;case t.LINE_STRIP:e.lines+=r*(i-1);break;case t.LINE_LOOP:e.lines+=r*i;break;case t.POINTS:e.points+=r*i;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",n)}}}}function Gi(t,e){return t[0]-e[0]}function Hi(t,e){return Math.abs(e[1])-Math.abs(t[1])}function Vi(t){const e={},i=new Float32Array(8),n=[];for(let t=0;t<8;t++)n[t]=[t,0];return{update:function(r,s,a,o){const h=r.morphTargetInfluences,l=void 0===h?0:h.length;let c=e[s.id];if(void 0===c){c=[];for(let t=0;t<l;t++)c[t]=[t,0];e[s.id]=c}for(let t=0;t<l;t++){const e=c[t];e[0]=t,e[1]=h[t]}c.sort(Hi);for(let t=0;t<8;t++)t<l&&c[t][1]?(n[t][0]=c[t][0],n[t][1]=c[t][1]):(n[t][0]=Number.MAX_SAFE_INTEGER,n[t][1]=0);n.sort(Gi);const u=a.morphTargets&&s.morphAttributes.position,d=a.morphNormals&&s.morphAttributes.normal;let p=0;for(let t=0;t<8;t++){const e=n[t],r=e[0],a=e[1];r!==Number.MAX_SAFE_INTEGER&&a?(u&&s.getAttribute("morphTarget"+t)!==u[r]&&s.setAttribute("morphTarget"+t,u[r]),d&&s.getAttribute("morphNormal"+t)!==d[r]&&s.setAttribute("morphNormal"+t,d[r]),i[t]=a,p+=a):(u&&!0===s.hasAttribute("morphTarget"+t)&&s.deleteAttribute("morphTarget"+t),d&&!0===s.hasAttribute("morphNormal"+t)&&s.deleteAttribute("morphNormal"+t),i[t]=0)}const f=s.morphTargetsRelative?1:1-p;o.getUniforms().setValue(t,"morphTargetBaseInfluence",f),o.getUniforms().setValue(t,"morphTargetInfluences",i)}}}function Wi(t,e,i,n){let r=new WeakMap;function s(t){const e=t.target;e.removeEventListener("dispose",s),i.remove(e.instanceMatrix),null!==e.instanceColor&&i.remove(e.instanceColor)}return{update:function(a){const o=n.render.frame,h=a.geometry,l=e.get(a,h);return r.get(l)!==o&&(h.isGeometry&&l.updateFromObject(a),e.update(l),r.set(l,o)),a.isInstancedMesh&&(!1===a.hasEventListener("dispose",s)&&a.addEventListener("dispose",s),i.update(a.instanceMatrix,t.ARRAY_BUFFER),null!==a.instanceColor&&i.update(a.instanceColor,t.ARRAY_BUFFER)),l},dispose:function(){r=new WeakMap}}}function ji(t=null,e=1,i=1,n=1){W.call(this,null),this.image={data:t,width:e,height:i,depth:n},this.magFilter=x,this.minFilter=x,this.wrapR=v,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}function Xi(t=null,e=1,i=1,n=1){W.call(this,null),this.image={data:t,width:e,height:i,depth:n},this.magFilter=x,this.minFilter=x,this.wrapR=v,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}Ni.prototype=Object.create(ve.prototype),Ni.prototype.constructor=Ni,Ii.prototype=Object.create(W.prototype),Ii.prototype.constructor=Ii,Ii.prototype.isCubeTexture=!0,Object.defineProperty(Ii.prototype,"images",{get:function(){return this.image},set:function(t){this.image=t}}),Oi.prototype=Object.create(q.prototype),Oi.prototype.constructor=Oi,Oi.prototype.isWebGLCubeRenderTarget=!0,Oi.prototype.fromEquirectangularTexture=function(t,e){this.texture.type=e.type,this.texture.format=A,this.texture.encoding=e.encoding,this.texture.generateMipmaps=e.generateMipmaps,this.texture.minFilter=e.minFilter,this.texture.magFilter=e.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t#include <begin_vertex>\n\t\t\t\t#include <project_vertex>\n\n\t\t\t}\n\t\t",fragmentShader:"\n\n\t\t\tuniform sampler2D tEquirect;\n\n\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t}\n\t\t"},n=new Le(5,5,5),r=new Ie({name:"CubemapFromEquirect",uniforms:Re(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:1,blending:0});r.uniforms.tEquirect.value=e;const s=new xi(n,r),a=e.minFilter;e.minFilter===M&&(e.minFilter=_);return new Ni(1,10,this).update(t,s),e.minFilter=a,s.geometry.dispose(),s.material.dispose(),this},Oi.prototype.clear=function(t,e,i,n){const r=t.getRenderTarget();for(let r=0;r<6;r++)t.setRenderTarget(this,r),t.clear(e,i,n);t.setRenderTarget(r)},ji.prototype=Object.create(W.prototype),ji.prototype.constructor=ji,ji.prototype.isDataTexture2DArray=!0,Xi.prototype=Object.create(W.prototype),Xi.prototype.constructor=Xi,Xi.prototype.isDataTexture3D=!0;const qi=new W,Yi=new ji,Zi=new Xi,Ji=new Ii,Qi=[],Ki=[],$i=new Float32Array(16),tn=new Float32Array(9),en=new Float32Array(4);function nn(t,e,i){const n=t[0];if(n<=0||n>0)return t;const r=e*i;let s=Qi[r];if(void 0===s&&(s=new Float32Array(r),Qi[r]=s),0!==e){n.toArray(s,0);for(let n=1,r=0;n!==e;++n)r+=i,t[n].toArray(s,r)}return s}function rn(t,e){if(t.length!==e.length)return!1;for(let i=0,n=t.length;i<n;i++)if(t[i]!==e[i])return!1;return!0}function sn(t,e){for(let i=0,n=e.length;i<n;i++)t[i]=e[i]}function an(t,e){let i=Ki[e];void 0===i&&(i=new Int32Array(e),Ki[e]=i);for(let n=0;n!==e;++n)i[n]=t.allocateTextureUnit();return i}function on(t,e){const i=this.cache;i[0]!==e&&(t.uniform1f(this.addr,e),i[0]=e)}function hn(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2f(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(rn(i,e))return;t.uniform2fv(this.addr,e),sn(i,e)}}function ln(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3f(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else if(void 0!==e.r)i[0]===e.r&&i[1]===e.g&&i[2]===e.b||(t.uniform3f(this.addr,e.r,e.g,e.b),i[0]=e.r,i[1]=e.g,i[2]=e.b);else{if(rn(i,e))return;t.uniform3fv(this.addr,e),sn(i,e)}}function cn(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(rn(i,e))return;t.uniform4fv(this.addr,e),sn(i,e)}}function un(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(rn(i,e))return;t.uniformMatrix2fv(this.addr,!1,e),sn(i,e)}else{if(rn(i,n))return;en.set(n),t.uniformMatrix2fv(this.addr,!1,en),sn(i,n)}}function dn(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(rn(i,e))return;t.uniformMatrix3fv(this.addr,!1,e),sn(i,e)}else{if(rn(i,n))return;tn.set(n),t.uniformMatrix3fv(this.addr,!1,tn),sn(i,n)}}function pn(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(rn(i,e))return;t.uniformMatrix4fv(this.addr,!1,e),sn(i,e)}else{if(rn(i,n))return;$i.set(n),t.uniformMatrix4fv(this.addr,!1,$i),sn(i,n)}}function fn(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.safeSetTexture2D(e||qi,r)}function mn(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture2DArray(e||Yi,r)}function gn(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture3D(e||Zi,r)}function vn(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.safeSetTextureCube(e||Ji,r)}function yn(t,e){const i=this.cache;i[0]!==e&&(t.uniform1i(this.addr,e),i[0]=e)}function xn(t,e){const i=this.cache;rn(i,e)||(t.uniform2iv(this.addr,e),sn(i,e))}function _n(t,e){const i=this.cache;rn(i,e)||(t.uniform3iv(this.addr,e),sn(i,e))}function Mn(t,e){const i=this.cache;rn(i,e)||(t.uniform4iv(this.addr,e),sn(i,e))}function bn(t,e){const i=this.cache;i[0]!==e&&(t.uniform1ui(this.addr,e),i[0]=e)}function wn(t,e){t.uniform1fv(this.addr,e)}function Sn(t,e){t.uniform1iv(this.addr,e)}function En(t,e){t.uniform2iv(this.addr,e)}function Tn(t,e){t.uniform3iv(this.addr,e)}function Ln(t,e){t.uniform4iv(this.addr,e)}function Cn(t,e){const i=nn(e,this.size,2);t.uniform2fv(this.addr,i)}function An(t,e){const i=nn(e,this.size,3);t.uniform3fv(this.addr,i)}function Pn(t,e){const i=nn(e,this.size,4);t.uniform4fv(this.addr,i)}function Rn(t,e){const i=nn(e,this.size,4);t.uniformMatrix2fv(this.addr,!1,i)}function Dn(t,e){const i=nn(e,this.size,9);t.uniformMatrix3fv(this.addr,!1,i)}function Nn(t,e){const i=nn(e,this.size,16);t.uniformMatrix4fv(this.addr,!1,i)}function In(t,e,i){const n=e.length,r=an(i,n);t.uniform1iv(this.addr,r);for(let t=0;t!==n;++t)i.safeSetTexture2D(e[t]||qi,r[t])}function On(t,e,i){const n=e.length,r=an(i,n);t.uniform1iv(this.addr,r);for(let t=0;t!==n;++t)i.safeSetTextureCube(e[t]||Ji,r[t])}function Fn(t,e,i){this.id=t,this.addr=i,this.cache=[],this.setValue=function(t){switch(t){case 5126:return on;case 35664:return hn;case 35665:return ln;case 35666:return cn;case 35674:return un;case 35675:return dn;case 35676:return pn;case 5124:case 35670:return yn;case 35667:case 35671:return xn;case 35668:case 35672:return _n;case 35669:case 35673:return Mn;case 5125:return bn;case 35678:case 36198:case 36298:case 36306:case 35682:return fn;case 35679:case 36299:case 36307:return gn;case 35680:case 36300:case 36308:case 36293:return vn;case 36289:case 36303:case 36311:case 36292:return mn}}(e.type)}function Un(t,e,i){this.id=t,this.addr=i,this.cache=[],this.size=e.size,this.setValue=function(t){switch(t){case 5126:return wn;case 35664:return Cn;case 35665:return An;case 35666:return Pn;case 35674:return Rn;case 35675:return Dn;case 35676:return Nn;case 5124:case 35670:return Sn;case 35667:case 35671:return En;case 35668:case 35672:return Tn;case 35669:case 35673:return Ln;case 35678:case 36198:case 36298:case 36306:case 35682:return In;case 35680:case 36300:case 36308:case 36293:return On}}(e.type)}function zn(t){this.id=t,this.seq=[],this.map={}}Un.prototype.updateCache=function(t){const e=this.cache;t instanceof Float32Array&&e.length!==t.length&&(this.cache=new Float32Array(t.length)),sn(e,t)},zn.prototype.setValue=function(t,e,i){const n=this.seq;for(let r=0,s=n.length;r!==s;++r){const s=n[r];s.setValue(t,e[s.id],i)}};const kn=/(\w+)(\])?(\[|\.)?/g;function Bn(t,e){t.seq.push(e),t.map[e.id]=e}function Gn(t,e,i){const n=t.name,r=n.length;for(kn.lastIndex=0;;){const s=kn.exec(n),a=kn.lastIndex;let o=s[1];const h="]"===s[2],l=s[3];if(h&&(o|=0),void 0===l||"["===l&&a+2===r){Bn(i,void 0===l?new Fn(o,t,e):new Un(o,t,e));break}{let t=i.map[o];void 0===t&&(t=new zn(o),Bn(i,t)),i=t}}}function Hn(t,e){this.seq=[],this.map={};const i=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let n=0;n<i;++n){const i=t.getActiveUniform(e,n);Gn(i,t.getUniformLocation(e,i.name),this)}}function Vn(t,e,i){const n=t.createShader(e);return t.shaderSource(n,i),t.compileShader(n),n}Hn.prototype.setValue=function(t,e,i,n){const r=this.map[e];void 0!==r&&r.setValue(t,i,n)},Hn.prototype.setOptional=function(t,e,i){const n=e[i];void 0!==n&&this.setValue(t,i,n)},Hn.upload=function(t,e,i,n){for(let r=0,s=e.length;r!==s;++r){const s=e[r],a=i[s.id];!1!==a.needsUpdate&&s.setValue(t,a.value,n)}},Hn.seqWithValue=function(t,e){const i=[];for(let n=0,r=t.length;n!==r;++n){const r=t[n];r.id in e&&i.push(r)}return i};let Wn=0;function jn(t){switch(t){case D:return["Linear","( value )"];case 3001:return["sRGB","( value )"];case 3002:return["RGBE","( value )"];case 3004:return["RGBM","( value, 7.0 )"];case 3005:return["RGBM","( value, 16.0 )"];case 3006:return["RGBD","( value, 256.0 )"];case 3007:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case 3003:return["LogLuv","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",t),["Linear","( value )"]}}function Xn(t,e,i){const n=t.getShaderParameter(e,t.COMPILE_STATUS),r=t.getShaderInfoLog(e).trim();if(n&&""===r)return"";return"THREE.WebGLShader: gl.getShaderInfoLog() "+i+"\n"+r+function(t){const e=t.split("\n");for(let t=0;t<e.length;t++)e[t]=t+1+": "+e[t];return e.join("\n")}(t.getShaderSource(e))}function qn(t,e){const i=jn(e);return"vec4 "+t+"( vec4 value ) { return "+i[0]+"ToLinear"+i[1]+"; }"}function Yn(t,e){const i=jn(e);return"vec4 "+t+"( vec4 value ) { return LinearTo"+i[0]+i[1]+"; }"}function Zn(t,e){let i;switch(e){case 1:i="Linear";break;case 2:i="Reinhard";break;case 3:i="OptimizedCineon";break;case 4:i="ACESFilmic";break;case 5:i="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",e),i="Linear"}return"vec3 "+t+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function Jn(t){return""!==t}function Qn(t,e){return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function Kn(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const $n=/^[ \t]*#include +<([\w\d./]+)>/gm;function tr(t){return t.replace($n,er)}function er(t,e){const i=bi[e];if(void 0===i)throw new Error("Can not resolve #include <"+e+">");return tr(i)}const ir=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,nr=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function rr(t){return t.replace(nr,ar).replace(ir,sr)}function sr(t,e,i,n){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),ar(t,e,i,n)}function ar(t,e,i,n){let r="";for(let t=parseInt(e);t<parseInt(i);t++)r+=n.replace(/\[\s*i\s*\]/g,"[ "+t+" ]").replace(/UNROLLED_LOOP_INDEX/g,t);return r}function or(t){let e="precision "+t.precision+" float;\nprecision "+t.precision+" int;";return"highp"===t.precision?e+="\n#define HIGH_PRECISION":"mediump"===t.precision?e+="\n#define MEDIUM_PRECISION":"lowp"===t.precision&&(e+="\n#define LOW_PRECISION"),e}function hr(t,e,i,n){const r=t.getContext(),s=i.defines;let a=i.vertexShader,o=i.fragmentShader;const h=function(t){let e="SHADOWMAP_TYPE_BASIC";return 1===t.shadowMapType?e="SHADOWMAP_TYPE_PCF":2===t.shadowMapType?e="SHADOWMAP_TYPE_PCF_SOFT":3===t.shadowMapType&&(e="SHADOWMAP_TYPE_VSM"),e}(i),l=function(t){let e="ENVMAP_TYPE_CUBE";if(t.envMap)switch(t.envMapMode){case 301:case 302:e="ENVMAP_TYPE_CUBE";break;case 306:case 307:e="ENVMAP_TYPE_CUBE_UV"}return e}(i),c=function(t){let e="ENVMAP_MODE_REFLECTION";if(t.envMap)switch(t.envMapMode){case 302:case 307:e="ENVMAP_MODE_REFRACTION"}return e}(i),u=function(t){let e="ENVMAP_BLENDING_NONE";if(t.envMap)switch(t.combine){case 0:e="ENVMAP_BLENDING_MULTIPLY";break;case 1:e="ENVMAP_BLENDING_MIX";break;case 2:e="ENVMAP_BLENDING_ADD"}return e}(i),d=t.gammaFactor>0?t.gammaFactor:1,p=i.isWebGL2?"":function(t){return[t.extensionDerivatives||t.envMapCubeUV||t.bumpMap||t.tangentSpaceNormalMap||t.clearcoatNormalMap||t.flatShading||"physical"===t.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(t.extensionFragDepth||t.logarithmicDepthBuffer)&&t.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",t.extensionDrawBuffers&&t.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(t.extensionShaderTextureLOD||t.envMap)&&t.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Jn).join("\n")}(i),f=function(t){const e=[];for(const i in t){const n=t[i];!1!==n&&e.push("#define "+i+" "+n)}return e.join("\n")}(s),m=r.createProgram();let g,v,y=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(g=[f].filter(Jn).join("\n"),g.length>0&&(g+="\n"),v=[p,f].filter(Jn).join("\n"),v.length>0&&(v+="\n")):(g=[or(i),"#define SHADER_NAME "+i.shaderName,f,i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+d,"#define MAX_BONES "+i.maxBones,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+c:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.displacementMap&&i.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.useVertexTexture?"#define BONE_TEXTURE":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+h:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Jn).join("\n"),v=[p,or(i),"#define SHADER_NAME "+i.shaderName,f,i.alphaTest?"#define ALPHATEST "+i.alphaTest+(i.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+d,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+l:"",i.envMap?"#define "+c:"",i.envMap?"#define "+u:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.sheen?"#define USE_SHEEN":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor?"#define USE_COLOR":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+h:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(i.extensionShaderTextureLOD||i.envMap)&&i.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==i.toneMapping?"#define TONE_MAPPING":"",0!==i.toneMapping?bi.tonemapping_pars_fragment:"",0!==i.toneMapping?Zn("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",bi.encodings_pars_fragment,i.map?qn("mapTexelToLinear",i.mapEncoding):"",i.matcap?qn("matcapTexelToLinear",i.matcapEncoding):"",i.envMap?qn("envMapTexelToLinear",i.envMapEncoding):"",i.emissiveMap?qn("emissiveMapTexelToLinear",i.emissiveMapEncoding):"",i.lightMap?qn("lightMapTexelToLinear",i.lightMapEncoding):"",Yn("linearToOutputTexel",i.outputEncoding),i.depthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(Jn).join("\n")),a=tr(a),a=Qn(a,i),a=Kn(a,i),o=tr(o),o=Qn(o,i),o=Kn(o,i),a=rr(a),o=rr(o),i.isWebGL2&&!0!==i.isRawShaderMaterial&&(y="#version 300 es\n",g=["#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+g,v=["#define varying in",i.glslVersion===O?"":"out highp vec4 pc_fragColor;",i.glslVersion===O?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+v);const x=y+g+a,_=y+v+o,M=Vn(r,r.VERTEX_SHADER,x),b=Vn(r,r.FRAGMENT_SHADER,_);if(r.attachShader(m,M),r.attachShader(m,b),void 0!==i.index0AttributeName?r.bindAttribLocation(m,0,i.index0AttributeName):!0===i.morphTargets&&r.bindAttribLocation(m,0,"position"),r.linkProgram(m),t.debug.checkShaderErrors){const t=r.getProgramInfoLog(m).trim(),e=r.getShaderInfoLog(M).trim(),i=r.getShaderInfoLog(b).trim();let n=!0,s=!0;if(!1===r.getProgramParameter(m,r.LINK_STATUS)){n=!1;const e=Xn(r,M,"vertex"),i=Xn(r,b,"fragment");console.error("THREE.WebGLProgram: shader error: ",r.getError(),"gl.VALIDATE_STATUS",r.getProgramParameter(m,r.VALIDATE_STATUS),"gl.getProgramInfoLog",t,e,i)}else""!==t?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",t):""!==e&&""!==i||(s=!1);s&&(this.diagnostics={runnable:n,programLog:t,vertexShader:{log:e,prefix:g},fragmentShader:{log:i,prefix:v}})}let w,S;return r.deleteShader(M),r.deleteShader(b),this.getUniforms=function(){return void 0===w&&(w=new Hn(r,m)),w},this.getAttributes=function(){return void 0===S&&(S=function(t,e){const i={},n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let r=0;r<n;r++){const n=t.getActiveAttrib(e,r).name;i[n]=t.getAttribLocation(e,n)}return i}(r,m)),S},this.destroy=function(){n.releaseStatesOfProgram(this),r.deleteProgram(m),this.program=void 0},this.name=i.shaderName,this.id=Wn++,this.cacheKey=e,this.usedTimes=1,this.program=m,this.vertexShader=M,this.fragmentShader=b,this}function lr(t,e,i,n,r,s){const a=[],o=n.isWebGL2,h=n.logarithmicDepthBuffer,l=n.floatVertexTextures,c=n.maxVertexUniforms,u=n.vertexTextures;let d=n.precision;const p={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},f=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","instancingColor","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","sheen","transmissionMap"];function m(t){let e;return t&&t.isTexture?e=t.encoding:t&&t.isWebGLRenderTarget?(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),e=t.texture.encoding):e=D,e}return{getParameters:function(r,a,f,g,v){const y=g.fog,x=r.isMeshStandardMaterial?g.environment:null,_=e.get(r.envMap||x),M=p[r.type],b=v.isSkinnedMesh?function(t){const e=t.skeleton.bones;if(l)return 1024;{const t=c,i=Math.floor((t-20)/4),n=Math.min(i,e.length);return n<e.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+e.length+" bones. This GPU supports "+n+"."),0):n}}(v):0;let w,S;if(null!==r.precision&&(d=n.getMaxPrecision(r.precision),d!==r.precision&&console.warn("THREE.WebGLProgram.getParameters:",r.precision,"not supported, using",d,"instead.")),M){const t=Si[M];w=t.vertexShader,S=t.fragmentShader}else w=r.vertexShader,S=r.fragmentShader;const E=t.getRenderTarget();return{isWebGL2:o,shaderID:M,shaderName:r.type,vertexShader:w,fragmentShader:S,defines:r.defines,isRawShaderMaterial:!0===r.isRawShaderMaterial,glslVersion:r.glslVersion,precision:d,instancing:!0===v.isInstancedMesh,instancingColor:!0===v.isInstancedMesh&&null!==v.instanceColor,supportsVertexTextures:u,outputEncoding:null!==E?m(E.texture):t.outputEncoding,map:!!r.map,mapEncoding:m(r.map),matcap:!!r.matcap,matcapEncoding:m(r.matcap),envMap:!!_,envMapMode:_&&_.mapping,envMapEncoding:m(_),envMapCubeUV:!!_&&(306===_.mapping||307===_.mapping),lightMap:!!r.lightMap,lightMapEncoding:m(r.lightMap),aoMap:!!r.aoMap,emissiveMap:!!r.emissiveMap,emissiveMapEncoding:m(r.emissiveMap),bumpMap:!!r.bumpMap,normalMap:!!r.normalMap,objectSpaceNormalMap:1===r.normalMapType,tangentSpaceNormalMap:0===r.normalMapType,clearcoatMap:!!r.clearcoatMap,clearcoatRoughnessMap:!!r.clearcoatRoughnessMap,clearcoatNormalMap:!!r.clearcoatNormalMap,displacementMap:!!r.displacementMap,roughnessMap:!!r.roughnessMap,metalnessMap:!!r.metalnessMap,specularMap:!!r.specularMap,alphaMap:!!r.alphaMap,gradientMap:!!r.gradientMap,sheen:!!r.sheen,transmissionMap:!!r.transmissionMap,combine:r.combine,vertexTangents:r.normalMap&&r.vertexTangents,vertexColors:r.vertexColors,vertexUvs:!!(r.map||r.bumpMap||r.normalMap||r.specularMap||r.alphaMap||r.emissiveMap||r.roughnessMap||r.metalnessMap||r.clearcoatMap||r.clearcoatRoughnessMap||r.clearcoatNormalMap||r.displacementMap||r.transmissionMap),uvsVertexOnly:!(r.map||r.bumpMap||r.normalMap||r.specularMap||r.alphaMap||r.emissiveMap||r.roughnessMap||r.metalnessMap||r.clearcoatNormalMap||r.transmissionMap||!r.displacementMap),fog:!!y,useFog:r.fog,fogExp2:y&&y.isFogExp2,flatShading:r.flatShading,sizeAttenuation:r.sizeAttenuation,logarithmicDepthBuffer:h,skinning:r.skinning&&b>0,maxBones:b,useVertexTexture:l,morphTargets:r.morphTargets,morphNormals:r.morphNormals,maxMorphTargets:t.maxMorphTargets,maxMorphNormals:t.maxMorphNormals,numDirLights:a.directional.length,numPointLights:a.point.length,numSpotLights:a.spot.length,numRectAreaLights:a.rectArea.length,numHemiLights:a.hemi.length,numDirLightShadows:a.directionalShadowMap.length,numPointLightShadows:a.pointShadowMap.length,numSpotLightShadows:a.spotShadowMap.length,numClippingPlanes:s.numPlanes,numClipIntersection:s.numIntersection,dithering:r.dithering,shadowMapEnabled:t.shadowMap.enabled&&f.length>0,shadowMapType:t.shadowMap.type,toneMapping:r.toneMapped?t.toneMapping:0,physicallyCorrectLights:t.physicallyCorrectLights,premultipliedAlpha:r.premultipliedAlpha,alphaTest:r.alphaTest,doubleSided:2===r.side,flipSided:1===r.side,depthPacking:void 0!==r.depthPacking&&r.depthPacking,index0AttributeName:r.index0AttributeName,extensionDerivatives:r.extensions&&r.extensions.derivatives,extensionFragDepth:r.extensions&&r.extensions.fragDepth,extensionDrawBuffers:r.extensions&&r.extensions.drawBuffers,extensionShaderTextureLOD:r.extensions&&r.extensions.shaderTextureLOD,rendererExtensionFragDepth:o||i.has("EXT_frag_depth"),rendererExtensionDrawBuffers:o||i.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:o||i.has("EXT_shader_texture_lod"),customProgramCacheKey:r.customProgramCacheKey()}},getProgramCacheKey:function(e){const i=[];if(e.shaderID?i.push(e.shaderID):(i.push(e.fragmentShader),i.push(e.vertexShader)),void 0!==e.defines)for(const t in e.defines)i.push(t),i.push(e.defines[t]);if(!1===e.isRawShaderMaterial){for(let t=0;t<f.length;t++)i.push(e[f[t]]);i.push(t.outputEncoding),i.push(t.gammaFactor)}return i.push(e.customProgramCacheKey),i.join()},getUniforms:function(t){const e=p[t.type];let i;if(e){const t=Si[e];i=Ne.clone(t.uniforms)}else i=t.uniforms;return i},acquireProgram:function(e,i){let n;for(let t=0,e=a.length;t<e;t++){const e=a[t];if(e.cacheKey===i){n=e,++n.usedTimes;break}}return void 0===n&&(n=new hr(t,i,e,r),a.push(n)),n},releaseProgram:function(t){if(0==--t.usedTimes){const e=a.indexOf(t);a[e]=a[a.length-1],a.pop(),t.destroy()}},programs:a}}function cr(){let t=new WeakMap;return{get:function(e){let i=t.get(e);return void 0===i&&(i={},t.set(e,i)),i},remove:function(e){t.delete(e)},update:function(e,i,n){t.get(e)[i]=n},dispose:function(){t=new WeakMap}}}function ur(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program!==e.program?t.program.id-e.program.id:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function dr(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function pr(t){const e=[];let i=0;const n=[],r=[],s={id:-1};function a(n,r,a,o,h,l){let c=e[i];const u=t.get(a);return void 0===c?(c={id:n.id,object:n,geometry:r,material:a,program:u.program||s,groupOrder:o,renderOrder:n.renderOrder,z:h,group:l},e[i]=c):(c.id=n.id,c.object=n,c.geometry=r,c.material=a,c.program=u.program||s,c.groupOrder=o,c.renderOrder=n.renderOrder,c.z=h,c.group=l),i++,c}return{opaque:n,transparent:r,init:function(){i=0,n.length=0,r.length=0},push:function(t,e,i,s,o,h){const l=a(t,e,i,s,o,h);(!0===i.transparent?r:n).push(l)},unshift:function(t,e,i,s,o,h){const l=a(t,e,i,s,o,h);(!0===i.transparent?r:n).unshift(l)},finish:function(){for(let t=i,n=e.length;t<n;t++){const i=e[t];if(null===i.id)break;i.id=null,i.object=null,i.geometry=null,i.material=null,i.program=null,i.group=null}},sort:function(t,e){n.length>1&&n.sort(t||ur),r.length>1&&r.sort(e||dr)}}}function fr(t){let e=new WeakMap;return{get:function(i,n){const r=e.get(i);let s;return void 0===r?(s=new pr(t),e.set(i,new WeakMap),e.get(i).set(n,s)):(s=r.get(n),void 0===s&&(s=new pr(t),r.set(n,s))),s},dispose:function(){e=new WeakMap}}}function mr(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":i={direction:new J,color:new Ut};break;case"SpotLight":i={position:new J,direction:new J,color:new Ut,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new J,color:new Ut,distance:0,decay:0};break;case"HemisphereLight":i={direction:new J,skyColor:new Ut,groundColor:new Ut};break;case"RectAreaLight":i={color:new Ut,position:new J,halfWidth:new J,halfHeight:new J}}return t[e.id]=i,i}}}let gr=0;function vr(t,e){return(e.castShadow?1:0)-(t.castShadow?1:0)}function yr(t,e){const i=new mr,n=function(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":case"SpotLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new k};break;case"PointLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new k,shadowCameraNear:1,shadowCameraFar:1e3}}return t[e.id]=i,i}}}(),r={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let t=0;t<9;t++)r.probe.push(new J);const s=new J,a=new wt,o=new wt;return{setup:function(s){let a=0,o=0,h=0;for(let t=0;t<9;t++)r.probe[t].set(0,0,0);let l=0,c=0,u=0,d=0,p=0,f=0,m=0,g=0;s.sort(vr);for(let t=0,e=s.length;t<e;t++){const e=s[t],v=e.color,y=e.intensity,x=e.distance,_=e.shadow&&e.shadow.map?e.shadow.map.texture:null;if(e.isAmbientLight)a+=v.r*y,o+=v.g*y,h+=v.b*y;else if(e.isLightProbe)for(let t=0;t<9;t++)r.probe[t].addScaledVector(e.sh.coefficients[t],y);else if(e.isDirectionalLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity),e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,r.directionalShadow[l]=i,r.directionalShadowMap[l]=_,r.directionalShadowMatrix[l]=e.shadow.matrix,f++}r.directional[l]=t,l++}else if(e.isSpotLight){const t=i.get(e);if(t.position.setFromMatrixPosition(e.matrixWorld),t.color.copy(v).multiplyScalar(y),t.distance=x,t.coneCos=Math.cos(e.angle),t.penumbraCos=Math.cos(e.angle*(1-e.penumbra)),t.decay=e.decay,e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,r.spotShadow[u]=i,r.spotShadowMap[u]=_,r.spotShadowMatrix[u]=e.shadow.matrix,g++}r.spot[u]=t,u++}else if(e.isRectAreaLight){const t=i.get(e);t.color.copy(v).multiplyScalar(y),t.halfWidth.set(.5*e.width,0,0),t.halfHeight.set(0,.5*e.height,0),r.rectArea[d]=t,d++}else if(e.isPointLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity),t.distance=e.distance,t.decay=e.decay,e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,i.shadowCameraNear=t.camera.near,i.shadowCameraFar=t.camera.far,r.pointShadow[c]=i,r.pointShadowMap[c]=_,r.pointShadowMatrix[c]=e.shadow.matrix,m++}r.point[c]=t,c++}else if(e.isHemisphereLight){const t=i.get(e);t.skyColor.copy(e.color).multiplyScalar(y),t.groundColor.copy(e.groundColor).multiplyScalar(y),r.hemi[p]=t,p++}}d>0&&(e.isWebGL2||!0===t.has("OES_texture_float_linear")?(r.rectAreaLTC1=wi.LTC_FLOAT_1,r.rectAreaLTC2=wi.LTC_FLOAT_2):!0===t.has("OES_texture_half_float_linear")?(r.rectAreaLTC1=wi.LTC_HALF_1,r.rectAreaLTC2=wi.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),r.ambient[0]=a,r.ambient[1]=o,r.ambient[2]=h;const v=r.hash;v.directionalLength===l&&v.pointLength===c&&v.spotLength===u&&v.rectAreaLength===d&&v.hemiLength===p&&v.numDirectionalShadows===f&&v.numPointShadows===m&&v.numSpotShadows===g||(r.directional.length=l,r.spot.length=u,r.rectArea.length=d,r.point.length=c,r.hemi.length=p,r.directionalShadow.length=f,r.directionalShadowMap.length=f,r.pointShadow.length=m,r.pointShadowMap.length=m,r.spotShadow.length=g,r.spotShadowMap.length=g,r.directionalShadowMatrix.length=f,r.pointShadowMatrix.length=m,r.spotShadowMatrix.length=g,v.directionalLength=l,v.pointLength=c,v.spotLength=u,v.rectAreaLength=d,v.hemiLength=p,v.numDirectionalShadows=f,v.numPointShadows=m,v.numSpotShadows=g,r.version=gr++)},setupView:function(t,e){let i=0,n=0,h=0,l=0,c=0;const u=e.matrixWorldInverse;for(let e=0,d=t.length;e<d;e++){const d=t[e];if(d.isDirectionalLight){const t=r.directional[i];t.direction.setFromMatrixPosition(d.matrixWorld),s.setFromMatrixPosition(d.target.matrixWorld),t.direction.sub(s),t.direction.transformDirection(u),i++}else if(d.isSpotLight){const t=r.spot[h];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),t.direction.setFromMatrixPosition(d.matrixWorld),s.setFromMatrixPosition(d.target.matrixWorld),t.direction.sub(s),t.direction.transformDirection(u),h++}else if(d.isRectAreaLight){const t=r.rectArea[l];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),o.identity(),a.copy(d.matrixWorld),a.premultiply(u),o.extractRotation(a),t.halfWidth.set(.5*d.width,0,0),t.halfHeight.set(0,.5*d.height,0),t.halfWidth.applyMatrix4(o),t.halfHeight.applyMatrix4(o),l++}else if(d.isPointLight){const t=r.point[n];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),n++}else if(d.isHemisphereLight){const t=r.hemi[c];t.direction.setFromMatrixPosition(d.matrixWorld),t.direction.transformDirection(u),t.direction.normalize(),c++}}},state:r}}function xr(t,e){const i=new yr(t,e),n=[],r=[];return{init:function(){n.length=0,r.length=0},state:{lightsArray:n,shadowsArray:r,lights:i},setupLights:function(){i.setup(n)},setupLightsView:function(t){i.setupView(n,t)},pushLight:function(t){n.push(t)},pushShadow:function(t){r.push(t)}}}function _r(t,e){let i=new WeakMap;return{get:function(n,r=0){let s;return!1===i.has(n)?(s=new xr(t,e),i.set(n,[]),i.get(n).push(s)):r>=i.get(n).length?(s=new xr(t,e),i.get(n).push(s)):s=i.get(n)[r],s},dispose:function(){i=new WeakMap}}}function Mr(t){Pe.call(this),this.type="MeshDepthMaterial",this.depthPacking=3200,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.setValues(t)}function br(t){Pe.call(this),this.type="MeshDistanceMaterial",this.referencePosition=new J,this.nearDistance=1,this.farDistance=1e3,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.setValues(t)}Mr.prototype=Object.create(Pe.prototype),Mr.prototype.constructor=Mr,Mr.prototype.isMeshDepthMaterial=!0,Mr.prototype.copy=function(t){return Pe.prototype.copy.call(this,t),this.depthPacking=t.depthPacking,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this},br.prototype=Object.create(Pe.prototype),br.prototype.constructor=br,br.prototype.isMeshDistanceMaterial=!0,br.prototype.copy=function(t){return Pe.prototype.copy.call(this,t),this.referencePosition.copy(t.referencePosition),this.nearDistance=t.nearDistance,this.farDistance=t.farDistance,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this};function wr(t,e,i){let n=new bt;const r=new k,s=new k,a=new X,o=[],h=[],l={},c={0:1,1:0,2:2},u=new Ie({defines:{SAMPLE_RATE:2/8,HALF_SAMPLE_RATE:1/8},uniforms:{shadow_pass:{value:null},resolution:{value:new k},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy ) / resolution ) );\n\tfor ( float i = -1.0; i < 1.0 ; i += SAMPLE_RATE) {\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( i, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, i ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean * HALF_SAMPLE_RATE;\n\tsquared_mean = squared_mean * HALF_SAMPLE_RATE;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),d=u.clone();d.defines.HORIZONTAL_PASS=1;const p=new Te;p.setAttribute("position",new Ht(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const f=new xi(p,u),m=this;function g(i,n){const r=e.update(f);u.uniforms.shadow_pass.value=i.map.texture,u.uniforms.resolution.value=i.mapSize,u.uniforms.radius.value=i.radius,t.setRenderTarget(i.mapPass),t.clear(),t.renderBufferDirect(n,null,r,u,f,null),d.uniforms.shadow_pass.value=i.mapPass.texture,d.uniforms.resolution.value=i.mapSize,d.uniforms.radius.value=i.radius,t.setRenderTarget(i.map),t.clear(),t.renderBufferDirect(n,null,r,d,f,null)}function v(t,e,i){const n=t<<0|e<<1|i<<2;let r=o[n];return void 0===r&&(r=new Mr({depthPacking:3201,morphTargets:t,skinning:e}),o[n]=r),r}function y(t,e,i){const n=t<<0|e<<1|i<<2;let r=h[n];return void 0===r&&(r=new br({morphTargets:t,skinning:e}),h[n]=r),r}function M(e,i,n,r,s,a,o){let h=null,u=v,d=e.customDepthMaterial;if(!0===r.isPointLight&&(u=y,d=e.customDistanceMaterial),void 0===d){let t=!1;!0===n.morphTargets&&(t=i.morphAttributes&&i.morphAttributes.position&&i.morphAttributes.position.length>0);let r=!1;!0===e.isSkinnedMesh&&(!0===n.skinning?r=!0:console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",e));h=u(t,r,!0===e.isInstancedMesh)}else h=d;if(t.localClippingEnabled&&!0===n.clipShadows&&0!==n.clippingPlanes.length){const t=h.uuid,e=n.uuid;let i=l[t];void 0===i&&(i={},l[t]=i);let r=i[e];void 0===r&&(r=h.clone(),i[e]=r),h=r}return h.visible=n.visible,h.wireframe=n.wireframe,h.side=3===o?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:c[n.side],h.clipShadows=n.clipShadows,h.clippingPlanes=n.clippingPlanes,h.clipIntersection=n.clipIntersection,h.wireframeLinewidth=n.wireframeLinewidth,h.linewidth=n.linewidth,!0===r.isPointLight&&!0===h.isMeshDistanceMaterial&&(h.referencePosition.setFromMatrixPosition(r.matrixWorld),h.nearDistance=s,h.farDistance=a),h}function b(i,r,s,a,o){if(!1===i.visible)return;if(i.layers.test(r.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&3===o)&&(!i.frustumCulled||n.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,i.matrixWorld);const n=e.update(i),r=i.material;if(Array.isArray(r)){const e=n.groups;for(let h=0,l=e.length;h<l;h++){const l=e[h],c=r[l.materialIndex];if(c&&c.visible){const e=M(i,n,c,a,s.near,s.far,o);t.renderBufferDirect(s,null,n,e,i,l)}}}else if(r.visible){const e=M(i,n,r,a,s.near,s.far,o);t.renderBufferDirect(s,null,n,e,i,null)}}const h=i.children;for(let t=0,e=h.length;t<e;t++)b(h[t],r,s,a,o)}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1,this.render=function(e,o,h){if(!1===m.enabled)return;if(!1===m.autoUpdate&&!1===m.needsUpdate)return;if(0===e.length)return;const l=t.getRenderTarget(),c=t.getActiveCubeFace(),u=t.getActiveMipmapLevel(),d=t.state;d.setBlending(0),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);for(let l=0,c=e.length;l<c;l++){const c=e[l],u=c.shadow;if(void 0===u){console.warn("THREE.WebGLShadowMap:",c,"has no shadow.");continue}if(!1===u.autoUpdate&&!1===u.needsUpdate)continue;r.copy(u.mapSize);const p=u.getFrameExtents();if(r.multiply(p),s.copy(u.mapSize),(r.x>i||r.y>i)&&(r.x>i&&(s.x=Math.floor(i/p.x),r.x=s.x*p.x,u.mapSize.x=s.x),r.y>i&&(s.y=Math.floor(i/p.y),r.y=s.y*p.y,u.mapSize.y=s.y)),null===u.map&&!u.isPointLightShadow&&3===this.type){const t={minFilter:_,magFilter:_,format:A};u.map=new q(r.x,r.y,t),u.map.texture.name=c.name+".shadowMap",u.mapPass=new q(r.x,r.y,t),u.camera.updateProjectionMatrix()}if(null===u.map){const t={minFilter:x,magFilter:x,format:A};u.map=new q(r.x,r.y,t),u.map.texture.name=c.name+".shadowMap",u.camera.updateProjectionMatrix()}t.setRenderTarget(u.map),t.clear();const f=u.getViewportCount();for(let t=0;t<f;t++){const e=u.getViewport(t);a.set(s.x*e.x,s.y*e.y,s.x*e.z,s.y*e.w),d.viewport(a),u.updateMatrices(c,t),n=u.getFrustum(),b(o,h,u.camera,c,this.type)}u.isPointLightShadow||3!==this.type||g(u,h),u.needsUpdate=!1}m.needsUpdate=!1,t.setRenderTarget(l,c,u)}}function Sr(t,e,i){const n=i.isWebGL2;const r=new function(){let e=!1;const i=new X;let n=null;const r=new X(0,0,0,0);return{setMask:function(i){n===i||e||(t.colorMask(i,i,i,i),n=i)},setLocked:function(t){e=t},setClear:function(e,n,s,a,o){!0===o&&(e*=a,n*=a,s*=a),i.set(e,n,s,a),!1===r.equals(i)&&(t.clearColor(e,n,s,a),r.copy(i))},reset:function(){e=!1,n=null,r.set(-1,0,0,0)}}},s=new function(){let e=!1,i=null,n=null,r=null;return{setTest:function(e){e?I(t.DEPTH_TEST):O(t.DEPTH_TEST)},setMask:function(n){i===n||e||(t.depthMask(n),i=n)},setFunc:function(e){if(n!==e){if(e)switch(e){case 0:t.depthFunc(t.NEVER);break;case 1:t.depthFunc(t.ALWAYS);break;case 2:t.depthFunc(t.LESS);break;case 3:t.depthFunc(t.LEQUAL);break;case 4:t.depthFunc(t.EQUAL);break;case 5:t.depthFunc(t.GEQUAL);break;case 6:t.depthFunc(t.GREATER);break;case 7:t.depthFunc(t.NOTEQUAL);break;default:t.depthFunc(t.LEQUAL)}else t.depthFunc(t.LEQUAL);n=e}},setLocked:function(t){e=t},setClear:function(e){r!==e&&(t.clearDepth(e),r=e)},reset:function(){e=!1,i=null,n=null,r=null}}},a=new function(){let e=!1,i=null,n=null,r=null,s=null,a=null,o=null,h=null,l=null;return{setTest:function(i){e||(i?I(t.STENCIL_TEST):O(t.STENCIL_TEST))},setMask:function(n){i===n||e||(t.stencilMask(n),i=n)},setFunc:function(e,i,a){n===e&&r===i&&s===a||(t.stencilFunc(e,i,a),n=e,r=i,s=a)},setOp:function(e,i,n){a===e&&o===i&&h===n||(t.stencilOp(e,i,n),a=e,o=i,h=n)},setLocked:function(t){e=t},setClear:function(e){l!==e&&(t.clearStencil(e),l=e)},reset:function(){e=!1,i=null,n=null,r=null,s=null,a=null,o=null,h=null,l=null}}};let o={},h=null,l=null,c=null,u=null,d=null,p=null,f=null,g=null,v=null,y=!1,x=null,_=null,M=null,b=null,w=null;const S=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let E=!1,T=0;const L=t.getParameter(t.VERSION);-1!==L.indexOf("WebGL")?(T=parseFloat(/^WebGL (\d)/.exec(L)[1]),E=T>=1):-1!==L.indexOf("OpenGL ES")&&(T=parseFloat(/^OpenGL ES (\d)/.exec(L)[1]),E=T>=2);let C=null,A={};const P=new X,R=new X;function D(e,i,n){const r=new Uint8Array(4),s=t.createTexture();t.bindTexture(e,s),t.texParameteri(e,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(e,t.TEXTURE_MAG_FILTER,t.NEAREST);for(let e=0;e<n;e++)t.texImage2D(i+e,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,r);return s}const N={};function I(e){!0!==o[e]&&(t.enable(e),o[e]=!0)}function O(e){!1!==o[e]&&(t.disable(e),o[e]=!1)}N[t.TEXTURE_2D]=D(t.TEXTURE_2D,t.TEXTURE_2D,1),N[t.TEXTURE_CUBE_MAP]=D(t.TEXTURE_CUBE_MAP,t.TEXTURE_CUBE_MAP_POSITIVE_X,6),r.setClear(0,0,0,1),s.setClear(1),a.setClear(0),I(t.DEPTH_TEST),s.setFunc(3),k(!1),B(1),I(t.CULL_FACE),z(0);const F={[m]:t.FUNC_ADD,101:t.FUNC_SUBTRACT,102:t.FUNC_REVERSE_SUBTRACT};if(n)F[103]=t.MIN,F[104]=t.MAX;else{const t=e.get("EXT_blend_minmax");null!==t&&(F[103]=t.MIN_EXT,F[104]=t.MAX_EXT)}const U={200:t.ZERO,201:t.ONE,202:t.SRC_COLOR,204:t.SRC_ALPHA,210:t.SRC_ALPHA_SATURATE,208:t.DST_COLOR,206:t.DST_ALPHA,203:t.ONE_MINUS_SRC_COLOR,205:t.ONE_MINUS_SRC_ALPHA,209:t.ONE_MINUS_DST_COLOR,207:t.ONE_MINUS_DST_ALPHA};function z(e,i,n,r,s,a,o,h){if(0!==e){if(l||(I(t.BLEND),l=!0),5===e)s=s||i,a=a||n,o=o||r,i===u&&s===f||(t.blendEquationSeparate(F[i],F[s]),u=i,f=s),n===d&&r===p&&a===g&&o===v||(t.blendFuncSeparate(U[n],U[r],U[a],U[o]),d=n,p=r,g=a,v=o),c=e,y=null;else if(e!==c||h!==y){if(u===m&&f===m||(t.blendEquation(t.FUNC_ADD),u=m,f=m),h)switch(e){case 1:t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case 2:t.blendFunc(t.ONE,t.ONE);break;case 3:t.blendFuncSeparate(t.ZERO,t.ZERO,t.ONE_MINUS_SRC_COLOR,t.ONE_MINUS_SRC_ALPHA);break;case 4:t.blendFuncSeparate(t.ZERO,t.SRC_COLOR,t.ZERO,t.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}else switch(e){case 1:t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case 2:t.blendFunc(t.SRC_ALPHA,t.ONE);break;case 3:t.blendFunc(t.ZERO,t.ONE_MINUS_SRC_COLOR);break;case 4:t.blendFunc(t.ZERO,t.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}d=null,p=null,g=null,v=null,c=e,y=h}}else l&&(O(t.BLEND),l=!1)}function k(e){x!==e&&(e?t.frontFace(t.CW):t.frontFace(t.CCW),x=e)}function B(e){0!==e?(I(t.CULL_FACE),e!==_&&(1===e?t.cullFace(t.BACK):2===e?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):O(t.CULL_FACE),_=e}function G(e,i,n){e?(I(t.POLYGON_OFFSET_FILL),b===i&&w===n||(t.polygonOffset(i,n),b=i,w=n)):O(t.POLYGON_OFFSET_FILL)}function H(e){void 0===e&&(e=t.TEXTURE0+S-1),C!==e&&(t.activeTexture(e),C=e)}return{buffers:{color:r,depth:s,stencil:a},enable:I,disable:O,useProgram:function(e){return h!==e&&(t.useProgram(e),h=e,!0)},setBlending:z,setMaterial:function(e,i){2===e.side?O(t.CULL_FACE):I(t.CULL_FACE);let n=1===e.side;i&&(n=!n),k(n),1===e.blending&&!1===e.transparent?z(0):z(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),s.setFunc(e.depthFunc),s.setTest(e.depthTest),s.setMask(e.depthWrite),r.setMask(e.colorWrite);const o=e.stencilWrite;a.setTest(o),o&&(a.setMask(e.stencilWriteMask),a.setFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),a.setOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),G(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits)},setFlipSided:k,setCullFace:B,setLineWidth:function(e){e!==M&&(E&&t.lineWidth(e),M=e)},setPolygonOffset:G,setScissorTest:function(e){e?I(t.SCISSOR_TEST):O(t.SCISSOR_TEST)},activeTexture:H,bindTexture:function(e,i){null===C&&H();let n=A[C];void 0===n&&(n={type:void 0,texture:void 0},A[C]=n),n.type===e&&n.texture===i||(t.bindTexture(e,i||N[e]),n.type=e,n.texture=i)},unbindTexture:function(){const e=A[C];void 0!==e&&void 0!==e.type&&(t.bindTexture(e.type,null),e.type=void 0,e.texture=void 0)},compressedTexImage2D:function(){try{t.compressedTexImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage2D:function(){try{t.texImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage3D:function(){try{t.texImage3D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},scissor:function(e){!1===P.equals(e)&&(t.scissor(e.x,e.y,e.z,e.w),P.copy(e))},viewport:function(e){!1===R.equals(e)&&(t.viewport(e.x,e.y,e.z,e.w),R.copy(e))},reset:function(){o={},C=null,A={},h=null,l=null,c=null,u=null,d=null,p=null,f=null,g=null,v=null,y=!1,x=null,_=null,M=null,b=null,w=null,r.reset(),s.reset(),a.reset()}}}function Er(t,e,i,n,r,s,a){const o=r.isWebGL2,h=r.maxTextures,l=r.maxCubemapSize,c=r.maxTextureSize,u=r.maxSamples,d=new WeakMap;let p,f=!1;try{f="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(t){}function m(t,e){return f?new OffscreenCanvas(t,e):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function b(t,e,i,n){let r=1;if((t.width>n||t.height>n)&&(r=n/Math.max(t.width,t.height)),r<1||!0===e){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const n=e?z.floorPowerOfTwo:Math.floor,s=n(r*t.width),a=n(r*t.height);void 0===p&&(p=m(s,a));const o=i?m(s,a):p;o.width=s,o.height=a;return o.getContext("2d").drawImage(t,0,0,s,a),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+t.width+"x"+t.height+") to ("+s+"x"+a+")."),o}return"data"in t&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+t.width+"x"+t.height+")."),t}return t}function D(t){return z.isPowerOfTwo(t.width)&&z.isPowerOfTwo(t.height)}function N(t,e){return t.generateMipmaps&&e&&t.minFilter!==x&&t.minFilter!==_}function I(e,i,r,s){t.generateMipmap(e);n.get(i).__maxMipLevel=Math.log(Math.max(r,s))*Math.LOG2E}function O(i,n,r){if(!1===o)return n;if(null!==i){if(void 0!==t[i])return t[i];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+i+"'")}let s=n;return n===t.RED&&(r===t.FLOAT&&(s=t.R32F),r===t.HALF_FLOAT&&(s=t.R16F),r===t.UNSIGNED_BYTE&&(s=t.R8)),n===t.RGB&&(r===t.FLOAT&&(s=t.RGB32F),r===t.HALF_FLOAT&&(s=t.RGB16F),r===t.UNSIGNED_BYTE&&(s=t.RGB8)),n===t.RGBA&&(r===t.FLOAT&&(s=t.RGBA32F),r===t.HALF_FLOAT&&(s=t.RGBA16F),r===t.UNSIGNED_BYTE&&(s=t.RGBA8)),s!==t.R16F&&s!==t.R32F&&s!==t.RGBA16F&&s!==t.RGBA32F||e.get("EXT_color_buffer_float"),s}function F(e){return e===x||1004===e||1005===e?t.NEAREST:t.LINEAR}function U(e){const i=e.target;i.removeEventListener("dispose",U),function(e){const i=n.get(e);if(void 0===i.__webglInit)return;t.deleteTexture(i.__webglTexture),n.remove(e)}(i),i.isVideoTexture&&d.delete(i),a.memory.textures--}function k(e){const i=e.target;i.removeEventListener("dispose",k),function(e){const i=n.get(e),r=n.get(e.texture);if(!e)return;void 0!==r.__webglTexture&&t.deleteTexture(r.__webglTexture);e.depthTexture&&e.depthTexture.dispose();if(e.isWebGLCubeRenderTarget)for(let e=0;e<6;e++)t.deleteFramebuffer(i.__webglFramebuffer[e]),i.__webglDepthbuffer&&t.deleteRenderbuffer(i.__webglDepthbuffer[e]);else t.deleteFramebuffer(i.__webglFramebuffer),i.__webglDepthbuffer&&t.deleteRenderbuffer(i.__webglDepthbuffer),i.__webglMultisampledFramebuffer&&t.deleteFramebuffer(i.__webglMultisampledFramebuffer),i.__webglColorRenderbuffer&&t.deleteRenderbuffer(i.__webglColorRenderbuffer),i.__webglDepthRenderbuffer&&t.deleteRenderbuffer(i.__webglDepthRenderbuffer);n.remove(e.texture),n.remove(e)}(i),a.memory.textures--}let B=0;function G(e,r){const s=n.get(e);if(e.isVideoTexture&&function(t){const e=a.render.frame;d.get(t)!==e&&(d.set(t,e),t.update())}(e),e.version>0&&s.__version!==e.version){const t=e.image;if(void 0===t)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined");else{if(!1!==t.complete)return void q(s,e,r);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}i.activeTexture(t.TEXTURE0+r),i.bindTexture(t.TEXTURE_2D,s.__webglTexture)}function H(e,r){const a=n.get(e);e.version>0&&a.__version!==e.version?function(e,n,r){if(6!==n.image.length)return;X(e,n),i.activeTexture(t.TEXTURE0+r),i.bindTexture(t.TEXTURE_CUBE_MAP,e.__webglTexture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,n.flipY);const a=n&&(n.isCompressedTexture||n.image[0].isCompressedTexture),h=n.image[0]&&n.image[0].isDataTexture,c=[];for(let t=0;t<6;t++)c[t]=a||h?h?n.image[t].image:n.image[t]:b(n.image[t],!1,!0,l);const u=c[0],d=D(u)||o,p=s.convert(n.format),f=s.convert(n.type),m=O(n.internalFormat,p,f);let g;if(j(t.TEXTURE_CUBE_MAP,n,d),a){for(let e=0;e<6;e++){g=c[e].mipmaps;for(let r=0;r<g.length;r++){const s=g[r];n.format!==A&&n.format!==C?null!==p?i.compressedTexImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,m,s.width,s.height,0,s.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,m,s.width,s.height,0,p,f,s.data)}}e.__maxMipLevel=g.length-1}else{g=n.mipmaps;for(let e=0;e<6;e++)if(h){i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,m,c[e].width,c[e].height,0,p,f,c[e].data);for(let n=0;n<g.length;n++){const r=g[n].image[e].image;i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n+1,m,r.width,r.height,0,p,f,r.data)}}else{i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,m,p,f,c[e]);for(let n=0;n<g.length;n++){const r=g[n];i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n+1,m,p,f,r.image[e])}}e.__maxMipLevel=g.length}N(n,d)&&I(t.TEXTURE_CUBE_MAP,n,u.width,u.height);e.__version=n.version,n.onUpdate&&n.onUpdate(n)}(a,e,r):(i.activeTexture(t.TEXTURE0+r),i.bindTexture(t.TEXTURE_CUBE_MAP,a.__webglTexture))}const V={[g]:t.REPEAT,[v]:t.CLAMP_TO_EDGE,[y]:t.MIRRORED_REPEAT},W={[x]:t.NEAREST,1004:t.NEAREST_MIPMAP_NEAREST,1005:t.NEAREST_MIPMAP_LINEAR,[_]:t.LINEAR,1007:t.LINEAR_MIPMAP_NEAREST,[M]:t.LINEAR_MIPMAP_LINEAR};function j(i,s,a){a?(t.texParameteri(i,t.TEXTURE_WRAP_S,V[s.wrapS]),t.texParameteri(i,t.TEXTURE_WRAP_T,V[s.wrapT]),i!==t.TEXTURE_3D&&i!==t.TEXTURE_2D_ARRAY||t.texParameteri(i,t.TEXTURE_WRAP_R,V[s.wrapR]),t.texParameteri(i,t.TEXTURE_MAG_FILTER,W[s.magFilter]),t.texParameteri(i,t.TEXTURE_MIN_FILTER,W[s.minFilter])):(t.texParameteri(i,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(i,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),i!==t.TEXTURE_3D&&i!==t.TEXTURE_2D_ARRAY||t.texParameteri(i,t.TEXTURE_WRAP_R,t.CLAMP_TO_EDGE),s.wrapS===v&&s.wrapT===v||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),t.texParameteri(i,t.TEXTURE_MAG_FILTER,F(s.magFilter)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,F(s.minFilter)),s.minFilter!==x&&s.minFilter!==_&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter."));const h=e.get("EXT_texture_filter_anisotropic");if(h){if(s.type===E&&null===e.get("OES_texture_float_linear"))return;if(s.type===T&&null===(o||e.get("OES_texture_half_float_linear")))return;(s.anisotropy>1||n.get(s).__currentAnisotropy)&&(t.texParameterf(i,h.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s.anisotropy,r.getMaxAnisotropy())),n.get(s).__currentAnisotropy=s.anisotropy)}}function X(e,i){void 0===e.__webglInit&&(e.__webglInit=!0,i.addEventListener("dispose",U),e.__webglTexture=t.createTexture(),a.memory.textures++)}function q(e,n,r){let a=t.TEXTURE_2D;n.isDataTexture2DArray&&(a=t.TEXTURE_2D_ARRAY),n.isDataTexture3D&&(a=t.TEXTURE_3D),X(e,n),i.activeTexture(t.TEXTURE0+r),i.bindTexture(a,e.__webglTexture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,n.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,n.unpackAlignment);const h=function(t){return!o&&(t.wrapS!==v||t.wrapT!==v||t.minFilter!==x&&t.minFilter!==_)}(n)&&!1===D(n.image),l=b(n.image,h,!1,c),u=D(l)||o,d=s.convert(n.format);let p,f=s.convert(n.type),m=O(n.internalFormat,d,f);j(a,n,u);const g=n.mipmaps;if(n.isDepthTexture)m=t.DEPTH_COMPONENT,o?m=n.type===E?t.DEPTH_COMPONENT32F:n.type===S?t.DEPTH_COMPONENT24:n.type===L?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT16:n.type===E&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),n.format===P&&m===t.DEPTH_COMPONENT&&n.type!==w&&n.type!==S&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),n.type=w,f=s.convert(n.type)),n.format===R&&m===t.DEPTH_COMPONENT&&(m=t.DEPTH_STENCIL,n.type!==L&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),n.type=L,f=s.convert(n.type))),i.texImage2D(t.TEXTURE_2D,0,m,l.width,l.height,0,d,f,null);else if(n.isDataTexture)if(g.length>0&&u){for(let e=0,n=g.length;e<n;e++)p=g[e],i.texImage2D(t.TEXTURE_2D,e,m,p.width,p.height,0,d,f,p.data);n.generateMipmaps=!1,e.__maxMipLevel=g.length-1}else i.texImage2D(t.TEXTURE_2D,0,m,l.width,l.height,0,d,f,l.data),e.__maxMipLevel=0;else if(n.isCompressedTexture){for(let e=0,r=g.length;e<r;e++)p=g[e],n.format!==A&&n.format!==C?null!==d?i.compressedTexImage2D(t.TEXTURE_2D,e,m,p.width,p.height,0,p.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):i.texImage2D(t.TEXTURE_2D,e,m,p.width,p.height,0,d,f,p.data);e.__maxMipLevel=g.length-1}else if(n.isDataTexture2DArray)i.texImage3D(t.TEXTURE_2D_ARRAY,0,m,l.width,l.height,l.depth,0,d,f,l.data),e.__maxMipLevel=0;else if(n.isDataTexture3D)i.texImage3D(t.TEXTURE_3D,0,m,l.width,l.height,l.depth,0,d,f,l.data),e.__maxMipLevel=0;else if(g.length>0&&u){for(let e=0,n=g.length;e<n;e++)p=g[e],i.texImage2D(t.TEXTURE_2D,e,m,d,f,p);n.generateMipmaps=!1,e.__maxMipLevel=g.length-1}else i.texImage2D(t.TEXTURE_2D,0,m,d,f,l),e.__maxMipLevel=0;N(n,u)&&I(a,n,l.width,l.height),e.__version=n.version,n.onUpdate&&n.onUpdate(n)}function Y(e,r,a,o){const h=s.convert(r.texture.format),l=s.convert(r.texture.type),c=O(r.texture.internalFormat,h,l);i.texImage2D(o,0,c,r.width,r.height,0,h,l,null),t.bindFramebuffer(t.FRAMEBUFFER,e),t.framebufferTexture2D(t.FRAMEBUFFER,a,o,n.get(r.texture).__webglTexture,0),t.bindFramebuffer(t.FRAMEBUFFER,null)}function Z(e,i,n){if(t.bindRenderbuffer(t.RENDERBUFFER,e),i.depthBuffer&&!i.stencilBuffer){let r=t.DEPTH_COMPONENT16;if(n){const e=i.depthTexture;e&&e.isDepthTexture&&(e.type===E?r=t.DEPTH_COMPONENT32F:e.type===S&&(r=t.DEPTH_COMPONENT24));const n=Q(i);t.renderbufferStorageMultisample(t.RENDERBUFFER,n,r,i.width,i.height)}else t.renderbufferStorage(t.RENDERBUFFER,r,i.width,i.height);t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e)}else if(i.depthBuffer&&i.stencilBuffer){if(n){const e=Q(i);t.renderbufferStorageMultisample(t.RENDERBUFFER,e,t.DEPTH24_STENCIL8,i.width,i.height)}else t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,i.width,i.height);t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,e)}else{const e=s.convert(i.texture.format),r=s.convert(i.texture.type),a=O(i.texture.internalFormat,e,r);if(n){const e=Q(i);t.renderbufferStorageMultisample(t.RENDERBUFFER,e,a,i.width,i.height)}else t.renderbufferStorage(t.RENDERBUFFER,a,i.width,i.height)}t.bindRenderbuffer(t.RENDERBUFFER,null)}function J(e){const i=n.get(e),r=!0===e.isWebGLCubeRenderTarget;if(e.depthTexture){if(r)throw new Error("target.depthTexture not supported in Cube render targets");!function(e,i){if(i&&i.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(t.bindFramebuffer(t.FRAMEBUFFER,e),!i.depthTexture||!i.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(i.depthTexture).__webglTexture&&i.depthTexture.image.width===i.width&&i.depthTexture.image.height===i.height||(i.depthTexture.image.width=i.width,i.depthTexture.image.height=i.height,i.depthTexture.needsUpdate=!0),G(i.depthTexture,0);const r=n.get(i.depthTexture).__webglTexture;if(i.depthTexture.format===P)t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,r,0);else{if(i.depthTexture.format!==R)throw new Error("Unknown depthTexture format");t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,r,0)}}(i.__webglFramebuffer,e)}else if(r){i.__webglDepthbuffer=[];for(let n=0;n<6;n++)t.bindFramebuffer(t.FRAMEBUFFER,i.__webglFramebuffer[n]),i.__webglDepthbuffer[n]=t.createRenderbuffer(),Z(i.__webglDepthbuffer[n],e,!1)}else t.bindFramebuffer(t.FRAMEBUFFER,i.__webglFramebuffer),i.__webglDepthbuffer=t.createRenderbuffer(),Z(i.__webglDepthbuffer,e,!1);t.bindFramebuffer(t.FRAMEBUFFER,null)}function Q(t){return o&&t.isWebGLMultisampleRenderTarget?Math.min(u,t.samples):0}let K=!1,$=!1;this.allocateTextureUnit=function(){const t=B;return t>=h&&console.warn("THREE.WebGLTextures: Trying to use "+t+" texture units while this GPU supports only "+h),B+=1,t},this.resetTextureUnits=function(){B=0},this.setTexture2D=G,this.setTexture2DArray=function(e,r){const s=n.get(e);e.version>0&&s.__version!==e.version?q(s,e,r):(i.activeTexture(t.TEXTURE0+r),i.bindTexture(t.TEXTURE_2D_ARRAY,s.__webglTexture))},this.setTexture3D=function(e,r){const s=n.get(e);e.version>0&&s.__version!==e.version?q(s,e,r):(i.activeTexture(t.TEXTURE0+r),i.bindTexture(t.TEXTURE_3D,s.__webglTexture))},this.setTextureCube=H,this.setupRenderTarget=function(e){const r=n.get(e),h=n.get(e.texture);e.addEventListener("dispose",k),h.__webglTexture=t.createTexture(),a.memory.textures++;const l=!0===e.isWebGLCubeRenderTarget,c=!0===e.isWebGLMultisampleRenderTarget,u=D(e)||o;if(!o||e.texture.format!==C||e.texture.type!==E&&e.texture.type!==T||(e.texture.format=A,console.warn("THREE.WebGLRenderer: Rendering to textures with RGB format is not supported. Using RGBA format instead.")),l){r.__webglFramebuffer=[];for(let e=0;e<6;e++)r.__webglFramebuffer[e]=t.createFramebuffer()}else if(r.__webglFramebuffer=t.createFramebuffer(),c)if(o){r.__webglMultisampledFramebuffer=t.createFramebuffer(),r.__webglColorRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,r.__webglColorRenderbuffer);const i=s.convert(e.texture.format),n=s.convert(e.texture.type),a=O(e.texture.internalFormat,i,n),o=Q(e);t.renderbufferStorageMultisample(t.RENDERBUFFER,o,a,e.width,e.height),t.bindFramebuffer(t.FRAMEBUFFER,r.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,r.__webglColorRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null),e.depthBuffer&&(r.__webglDepthRenderbuffer=t.createRenderbuffer(),Z(r.__webglDepthRenderbuffer,e,!0)),t.bindFramebuffer(t.FRAMEBUFFER,null)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(l){i.bindTexture(t.TEXTURE_CUBE_MAP,h.__webglTexture),j(t.TEXTURE_CUBE_MAP,e.texture,u);for(let i=0;i<6;i++)Y(r.__webglFramebuffer[i],e,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+i);N(e.texture,u)&&I(t.TEXTURE_CUBE_MAP,e.texture,e.width,e.height),i.bindTexture(t.TEXTURE_CUBE_MAP,null)}else i.bindTexture(t.TEXTURE_2D,h.__webglTexture),j(t.TEXTURE_2D,e.texture,u),Y(r.__webglFramebuffer,e,t.COLOR_ATTACHMENT0,t.TEXTURE_2D),N(e.texture,u)&&I(t.TEXTURE_2D,e.texture,e.width,e.height),i.bindTexture(t.TEXTURE_2D,null);e.depthBuffer&&J(e)},this.updateRenderTargetMipmap=function(e){const r=e.texture;if(N(r,D(e)||o)){const s=e.isWebGLCubeRenderTarget?t.TEXTURE_CUBE_MAP:t.TEXTURE_2D,a=n.get(r).__webglTexture;i.bindTexture(s,a),I(s,r,e.width,e.height),i.bindTexture(s,null)}},this.updateMultisampleRenderTarget=function(e){if(e.isWebGLMultisampleRenderTarget)if(o){const i=n.get(e);t.bindFramebuffer(t.READ_FRAMEBUFFER,i.__webglMultisampledFramebuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,i.__webglFramebuffer);const r=e.width,s=e.height;let a=t.COLOR_BUFFER_BIT;e.depthBuffer&&(a|=t.DEPTH_BUFFER_BIT),e.stencilBuffer&&(a|=t.STENCIL_BUFFER_BIT),t.blitFramebuffer(0,0,r,s,0,0,r,s,a,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,i.__webglMultisampledFramebuffer)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")},this.safeSetTexture2D=function(t,e){t&&t.isWebGLRenderTarget&&(!1===K&&(console.warn("THREE.WebGLTextures.safeSetTexture2D: don't use render targets as textures. Use their .texture property instead."),K=!0),t=t.texture),G(t,e)},this.safeSetTextureCube=function(t,e){t&&t.isWebGLCubeRenderTarget&&(!1===$&&(console.warn("THREE.WebGLTextures.safeSetTextureCube: don't use cube render targets as textures. Use their .texture property instead."),$=!0),t=t.texture),H(t,e)}}function Tr(t,e,i){const n=i.isWebGL2;return{convert:function(i){let r;if(i===b)return t.UNSIGNED_BYTE;if(1017===i)return t.UNSIGNED_SHORT_4_4_4_4;if(1018===i)return t.UNSIGNED_SHORT_5_5_5_1;if(1019===i)return t.UNSIGNED_SHORT_5_6_5;if(1010===i)return t.BYTE;if(1011===i)return t.SHORT;if(i===w)return t.UNSIGNED_SHORT;if(1013===i)return t.INT;if(i===S)return t.UNSIGNED_INT;if(i===E)return t.FLOAT;if(i===T)return n?t.HALF_FLOAT:(r=e.get("OES_texture_half_float"),null!==r?r.HALF_FLOAT_OES:null);if(1021===i)return t.ALPHA;if(i===C)return t.RGB;if(i===A)return t.RGBA;if(1024===i)return t.LUMINANCE;if(1025===i)return t.LUMINANCE_ALPHA;if(i===P)return t.DEPTH_COMPONENT;if(i===R)return t.DEPTH_STENCIL;if(1028===i)return t.RED;if(1029===i)return t.RED_INTEGER;if(1030===i)return t.RG;if(1031===i)return t.RG_INTEGER;if(1032===i)return t.RGB_INTEGER;if(1033===i)return t.RGBA_INTEGER;if(33776===i||33777===i||33778===i||33779===i){if(r=e.get("WEBGL_compressed_texture_s3tc"),null===r)return null;if(33776===i)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(33777===i)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(33778===i)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(33779===i)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(35840===i||35841===i||35842===i||35843===i){if(r=e.get("WEBGL_compressed_texture_pvrtc"),null===r)return null;if(35840===i)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(35841===i)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(35842===i)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(35843===i)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(36196===i)return r=e.get("WEBGL_compressed_texture_etc1"),null!==r?r.COMPRESSED_RGB_ETC1_WEBGL:null;if((37492===i||37496===i)&&(r=e.get("WEBGL_compressed_texture_etc"),null!==r)){if(37492===i)return r.COMPRESSED_RGB8_ETC2;if(37496===i)return r.COMPRESSED_RGBA8_ETC2_EAC}return 37808===i||37809===i||37810===i||37811===i||37812===i||37813===i||37814===i||37815===i||37816===i||37817===i||37818===i||37819===i||37820===i||37821===i||37840===i||37841===i||37842===i||37843===i||37844===i||37845===i||37846===i||37847===i||37848===i||37849===i||37850===i||37851===i||37852===i||37853===i?(r=e.get("WEBGL_compressed_texture_astc"),null!==r?i:null):36492===i?(r=e.get("EXT_texture_compression_bptc"),null!==r?i:null):i===L?n?t.UNSIGNED_INT_24_8:(r=e.get("WEBGL_depth_texture"),null!==r?r.UNSIGNED_INT_24_8_WEBGL:null):void 0}}}function Lr(t=[]){Ri.call(this),this.cameras=t}function Cr(){ve.call(this),this.type="Group"}function Ar(){this._targetRay=null,this._grip=null,this._hand=null}function Pr(t,e){const i=this;let n=null,r=1,s=null,a="local-floor",o=null;const h=[],l=new Map,c=new Ri;c.layers.enable(1),c.viewport=new X;const u=new Ri;u.layers.enable(2),u.viewport=new X;const d=[c,u],p=new Lr;p.layers.enable(1),p.layers.enable(2);let f=null,m=null;function g(t){const e=l.get(t.inputSource);e&&e.dispatchEvent({type:t.type,data:t.inputSource})}function v(){l.forEach((function(t,e){t.disconnect(e)})),l.clear(),t.setFramebuffer(null),t.setRenderTarget(t.getRenderTarget()),S.stop(),i.isPresenting=!1,i.dispatchEvent({type:"sessionend"})}function y(t){s=t,S.setContext(n),S.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}function x(t){const e=n.inputSources;for(let t=0;t<h.length;t++)l.set(e[t],h[t]);for(let e=0;e<t.removed.length;e++){const i=t.removed[e],n=l.get(i);n&&(n.dispatchEvent({type:"disconnected",data:i}),l.delete(i))}for(let e=0;e<t.added.length;e++){const i=t.added[e],n=l.get(i);n&&n.dispatchEvent({type:"connected",data:i})}}this.enabled=!1,this.isPresenting=!1,this.getController=function(t){let e=h[t];return void 0===e&&(e=new Ar,h[t]=e),e.getTargetRaySpace()},this.getControllerGrip=function(t){let e=h[t];return void 0===e&&(e=new Ar,h[t]=e),e.getGripSpace()},this.getHand=function(t){let e=h[t];return void 0===e&&(e=new Ar,h[t]=e),e.getHandSpace()},this.setFramebufferScaleFactor=function(t){r=t,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(t){a=t,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return s},this.getSession=function(){return n},this.setSession=function(t){if(n=t,null!==n){n.addEventListener("select",g),n.addEventListener("selectstart",g),n.addEventListener("selectend",g),n.addEventListener("squeeze",g),n.addEventListener("squeezestart",g),n.addEventListener("squeezeend",g),n.addEventListener("end",v);const t=e.getContextAttributes();!0!==t.xrCompatible&&e.makeXRCompatible();const i={antialias:t.antialias,alpha:t.alpha,depth:t.depth,stencil:t.stencil,framebufferScaleFactor:r},s=new XRWebGLLayer(n,e,i);n.updateRenderState({baseLayer:s}),n.requestReferenceSpace(a).then(y),n.addEventListener("inputsourceschange",x)}};const _=new J,M=new J;function b(t,e){null===e?t.matrixWorld.copy(t.matrix):t.matrixWorld.multiplyMatrices(e.matrixWorld,t.matrix),t.matrixWorldInverse.copy(t.matrixWorld).invert()}this.getCamera=function(t){p.near=u.near=c.near=t.near,p.far=u.far=c.far=t.far,f===p.near&&m===p.far||(n.updateRenderState({depthNear:p.near,depthFar:p.far}),f=p.near,m=p.far);const e=t.parent,i=p.cameras;b(p,e);for(let t=0;t<i.length;t++)b(i[t],e);t.matrixWorld.copy(p.matrixWorld);const r=t.children;for(let t=0,e=r.length;t<e;t++)r[t].updateMatrixWorld(!0);return 2===i.length?function(t,e,i){_.setFromMatrixPosition(e.matrixWorld),M.setFromMatrixPosition(i.matrixWorld);const n=_.distanceTo(M),r=e.projectionMatrix.elements,s=i.projectionMatrix.elements,a=r[14]/(r[10]-1),o=r[14]/(r[10]+1),h=(r[9]+1)/r[5],l=(r[9]-1)/r[5],c=(r[8]-1)/r[0],u=(s[8]+1)/s[0],d=a*c,p=a*u,f=n/(-c+u),m=f*-c;e.matrixWorld.decompose(t.position,t.quaternion,t.scale),t.translateX(m),t.translateZ(f),t.matrixWorld.compose(t.position,t.quaternion,t.scale),t.matrixWorldInverse.copy(t.matrixWorld).invert();const g=a+f,v=o+f,y=d-m,x=p+(n-m),b=h*o/v*g,w=l*o/v*g;t.projectionMatrix.makePerspective(y,x,b,w,g,v)}(p,c,u):p.projectionMatrix.copy(c.projectionMatrix),p};let w=null;const S=new zt;S.setAnimationLoop((function(e,i){if(o=i.getViewerPose(s),null!==o){const e=o.views,i=n.renderState.baseLayer;t.setFramebuffer(i.framebuffer);let r=!1;e.length!==p.cameras.length&&(p.cameras.length=0,r=!0);for(let t=0;t<e.length;t++){const n=e[t],s=i.getViewport(n),a=d[t];a.matrix.fromArray(n.transform.matrix),a.projectionMatrix.fromArray(n.projectionMatrix),a.viewport.set(s.x,s.y,s.width,s.height),0===t&&p.matrix.copy(a.matrix),!0===r&&p.cameras.push(a)}}const r=n.inputSources;for(let t=0;t<h.length;t++){const e=h[t],n=r[t];e.update(n,i,s)}w&&w(e,i)})),this.setAnimationLoop=function(t){w=t},this.dispose=function(){}}function Rr(t){function e(e,i){e.opacity.value=i.opacity,i.color&&e.diffuse.value.copy(i.color),i.emissive&&e.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),i.map&&(e.map.value=i.map),i.alphaMap&&(e.alphaMap.value=i.alphaMap),i.specularMap&&(e.specularMap.value=i.specularMap);const n=t.get(i).envMap;if(n){e.envMap.value=n,e.flipEnvMap.value=n.isCubeTexture&&n._needsFlipEnvMap?-1:1,e.reflectivity.value=i.reflectivity,e.refractionRatio.value=i.refractionRatio;const r=t.get(n).__maxMipLevel;void 0!==r&&(e.maxMipLevel.value=r)}let r,s;i.lightMap&&(e.lightMap.value=i.lightMap,e.lightMapIntensity.value=i.lightMapIntensity),i.aoMap&&(e.aoMap.value=i.aoMap,e.aoMapIntensity.value=i.aoMapIntensity),i.map?r=i.map:i.specularMap?r=i.specularMap:i.displacementMap?r=i.displacementMap:i.normalMap?r=i.normalMap:i.bumpMap?r=i.bumpMap:i.roughnessMap?r=i.roughnessMap:i.metalnessMap?r=i.metalnessMap:i.alphaMap?r=i.alphaMap:i.emissiveMap?r=i.emissiveMap:i.clearcoatMap?r=i.clearcoatMap:i.clearcoatNormalMap?r=i.clearcoatNormalMap:i.clearcoatRoughnessMap&&(r=i.clearcoatRoughnessMap),void 0!==r&&(r.isWebGLRenderTarget&&(r=r.texture),!0===r.matrixAutoUpdate&&r.updateMatrix(),e.uvTransform.value.copy(r.matrix)),i.aoMap?s=i.aoMap:i.lightMap&&(s=i.lightMap),void 0!==s&&(s.isWebGLRenderTarget&&(s=s.texture),!0===s.matrixAutoUpdate&&s.updateMatrix(),e.uv2Transform.value.copy(s.matrix))}function i(e,i){e.roughness.value=i.roughness,e.metalness.value=i.metalness,i.roughnessMap&&(e.roughnessMap.value=i.roughnessMap),i.metalnessMap&&(e.metalnessMap.value=i.metalnessMap),i.emissiveMap&&(e.emissiveMap.value=i.emissiveMap),i.bumpMap&&(e.bumpMap.value=i.bumpMap,e.bumpScale.value=i.bumpScale,1===i.side&&(e.bumpScale.value*=-1)),i.normalMap&&(e.normalMap.value=i.normalMap,e.normalScale.value.copy(i.normalScale),1===i.side&&e.normalScale.value.negate()),i.displacementMap&&(e.displacementMap.value=i.displacementMap,e.displacementScale.value=i.displacementScale,e.displacementBias.value=i.displacementBias);t.get(i).envMap&&(e.envMapIntensity.value=i.envMapIntensity)}return{refreshFogUniforms:function(t,e){t.fogColor.value.copy(e.color),e.isFog?(t.fogNear.value=e.near,t.fogFar.value=e.far):e.isFogExp2&&(t.fogDensity.value=e.density)},refreshMaterialUniforms:function(t,n,r,s){n.isMeshBasicMaterial?e(t,n):n.isMeshLambertMaterial?(e(t,n),function(t,e){e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap)}(t,n)):n.isMeshToonMaterial?(e(t,n),function(t,e){e.gradientMap&&(t.gradientMap.value=e.gradientMap);e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap);e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,1===e.side&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),1===e.side&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isMeshPhongMaterial?(e(t,n),function(t,e){t.specular.value.copy(e.specular),t.shininess.value=Math.max(e.shininess,1e-4),e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap);e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,1===e.side&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),1===e.side&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isMeshStandardMaterial?(e(t,n),n.isMeshPhysicalMaterial?function(t,e){i(t,e),t.reflectivity.value=e.reflectivity,t.clearcoat.value=e.clearcoat,t.clearcoatRoughness.value=e.clearcoatRoughness,e.sheen&&t.sheen.value.copy(e.sheen);e.clearcoatMap&&(t.clearcoatMap.value=e.clearcoatMap);e.clearcoatRoughnessMap&&(t.clearcoatRoughnessMap.value=e.clearcoatRoughnessMap);e.clearcoatNormalMap&&(t.clearcoatNormalScale.value.copy(e.clearcoatNormalScale),t.clearcoatNormalMap.value=e.clearcoatNormalMap,1===e.side&&t.clearcoatNormalScale.value.negate());t.transmission.value=e.transmission,e.transmissionMap&&(t.transmissionMap.value=e.transmissionMap)}(t,n):i(t,n)):n.isMeshMatcapMaterial?(e(t,n),function(t,e){e.matcap&&(t.matcap.value=e.matcap);e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,1===e.side&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),1===e.side&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isMeshDepthMaterial?(e(t,n),function(t,e){e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isMeshDistanceMaterial?(e(t,n),function(t,e){e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias);t.referencePosition.value.copy(e.referencePosition),t.nearDistance.value=e.nearDistance,t.farDistance.value=e.farDistance}(t,n)):n.isMeshNormalMaterial?(e(t,n),function(t,e){e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,1===e.side&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),1===e.side&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isLineBasicMaterial?(function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity}(t,n),n.isLineDashedMaterial&&function(t,e){t.dashSize.value=e.dashSize,t.totalSize.value=e.dashSize+e.gapSize,t.scale.value=e.scale}(t,n)):n.isPointsMaterial?function(t,e,i,n){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.size.value=e.size*i,t.scale.value=.5*n,e.map&&(t.map.value=e.map);e.alphaMap&&(t.alphaMap.value=e.alphaMap);let r;e.map?r=e.map:e.alphaMap&&(r=e.alphaMap);void 0!==r&&(!0===r.matrixAutoUpdate&&r.updateMatrix(),t.uvTransform.value.copy(r.matrix))}(t,n,r,s):n.isSpriteMaterial?function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.rotation.value=e.rotation,e.map&&(t.map.value=e.map);e.alphaMap&&(t.alphaMap.value=e.alphaMap);let i;e.map?i=e.map:e.alphaMap&&(i=e.alphaMap);void 0!==i&&(!0===i.matrixAutoUpdate&&i.updateMatrix(),t.uvTransform.value.copy(i.matrix))}(t,n):n.isShadowMaterial?(t.color.value.copy(n.color),t.opacity.value=n.opacity):n.isShaderMaterial&&(n.uniformsNeedUpdate=!1)}}}function Dr(t){const e=void 0!==(t=t||{}).canvas?t.canvas:function(){const t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return t.style.display="block",t}(),i=void 0!==t.context?t.context:null,n=void 0!==t.alpha&&t.alpha,r=void 0===t.depth||t.depth,s=void 0===t.stencil||t.stencil,a=void 0!==t.antialias&&t.antialias,o=void 0===t.premultipliedAlpha||t.premultipliedAlpha,h=void 0!==t.preserveDrawingBuffer&&t.preserveDrawingBuffer,l=void 0!==t.powerPreference?t.powerPreference:"default",c=void 0!==t.failIfMajorPerformanceCaveat&&t.failIfMajorPerformanceCaveat;let u=null,d=null;const p=[];this.domElement=e,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=D,this.physicallyCorrectLights=!1,this.toneMapping=0,this.toneMappingExposure=1,this.maxMorphTargets=8,this.maxMorphNormals=4;const f=this;let m=!1,g=null,v=0,y=0,x=null,_=null,M=-1,w=null;const S=new X,L=new X;let C=null,P=e.width,R=e.height,N=1,I=null,O=null;const F=new X(0,0,P,R),U=new X(0,0,P,R);let B=!1;const G=new bt;let H=!1,V=!1;const W=new wt,j=new J,q={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function Z(){return null===x?N:1}let Q,K,$,tt,et,it,nt,rt,st,at,ot,ht,lt,ct,ut,dt,pt,ft,mt,gt,vt,yt=i;function xt(t,i){for(let n=0;n<t.length;n++){const r=t[n],s=e.getContext(r,i);if(null!==s)return s}return null}try{const t={alpha:n,depth:r,stencil:s,antialias:a,premultipliedAlpha:o,preserveDrawingBuffer:h,powerPreference:l,failIfMajorPerformanceCaveat:c};if(e.addEventListener("webglcontextlost",Et,!1),e.addEventListener("webglcontextrestored",Tt,!1),null===yt){const e=["webgl2","webgl","experimental-webgl"];if(!0===f.isWebGL1Renderer&&e.shift(),yt=xt(e,t),null===yt)throw xt(e)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}void 0===yt.getShaderPrecisionFormat&&(yt.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(t){throw console.error("THREE.WebGLRenderer: "+t.message),t}function _t(){Q=new Ui(yt),K=new Ci(yt,Q,t),!1===K.isWebGL2&&(Q.get("WEBGL_depth_texture"),Q.get("OES_texture_float"),Q.get("OES_texture_half_float"),Q.get("OES_texture_half_float_linear"),Q.get("OES_standard_derivatives"),Q.get("OES_element_index_uint"),Q.get("OES_vertex_array_object"),Q.get("ANGLE_instanced_arrays")),Q.get("OES_texture_float_linear"),gt=new Tr(yt,Q,K),$=new Sr(yt,Q,K),$.scissor(L.copy(U).multiplyScalar(N).floor()),$.viewport(S.copy(F).multiplyScalar(N).floor()),tt=new Bi(yt),et=new cr,it=new Er(yt,Q,$,et,K,gt,tt),nt=new Fi(f),rt=new kt(yt,K),vt=new Ti(yt,Q,rt,K),st=new zi(yt,rt,tt,vt),at=new Wi(yt,st,rt,tt),pt=new Vi(yt),ut=new Ai(et),ot=new lr(f,nt,Q,K,vt,ut),ht=new Rr(et),lt=new fr(et),ct=new _r(Q,K),dt=new Ei(f,nt,$,at,o),ft=new Li(yt,Q,tt,K),mt=new ki(yt,Q,tt,K),tt.programs=ot.programs,f.capabilities=K,f.extensions=Q,f.properties=et,f.renderLists=lt,f.state=$,f.info=tt}_t();const Mt=new Pr(f,yt);this.xr=Mt;const St=new wr(f,at,K.maxTextureSize);function Et(t){t.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),m=!0}function Tt(){console.log("THREE.WebGLRenderer: Context Restored."),m=!1,_t()}function Lt(t){const e=t.target;e.removeEventListener("dispose",Lt),function(t){Ct(t),et.remove(t)}(e)}function Ct(t){const e=et.get(t).program;void 0!==e&&ot.releaseProgram(e)}this.shadowMap=St,this.getContext=function(){return yt},this.getContextAttributes=function(){return yt.getContextAttributes()},this.forceContextLoss=function(){const t=Q.get("WEBGL_lose_context");t&&t.loseContext()},this.forceContextRestore=function(){const t=Q.get("WEBGL_lose_context");t&&t.restoreContext()},this.getPixelRatio=function(){return N},this.setPixelRatio=function(t){void 0!==t&&(N=t,this.setSize(P,R,!1))},this.getSize=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getsize() now requires a Vector2 as an argument"),t=new k),t.set(P,R)},this.setSize=function(t,i,n){Mt.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(P=t,R=i,e.width=Math.floor(t*N),e.height=Math.floor(i*N),!1!==n&&(e.style.width=t+"px",e.style.height=i+"px"),this.setViewport(0,0,t,i))},this.getDrawingBufferSize=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getdrawingBufferSize() now requires a Vector2 as an argument"),t=new k),t.set(P*N,R*N).floor()},this.setDrawingBufferSize=function(t,i,n){P=t,R=i,N=n,e.width=Math.floor(t*n),e.height=Math.floor(i*n),this.setViewport(0,0,t,i)},this.getCurrentViewport=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getCurrentViewport() now requires a Vector4 as an argument"),t=new X),t.copy(S)},this.getViewport=function(t){return t.copy(F)},this.setViewport=function(t,e,i,n){t.isVector4?F.set(t.x,t.y,t.z,t.w):F.set(t,e,i,n),$.viewport(S.copy(F).multiplyScalar(N).floor())},this.getScissor=function(t){return t.copy(U)},this.setScissor=function(t,e,i,n){t.isVector4?U.set(t.x,t.y,t.z,t.w):U.set(t,e,i,n),$.scissor(L.copy(U).multiplyScalar(N).floor())},this.getScissorTest=function(){return B},this.setScissorTest=function(t){$.setScissorTest(B=t)},this.setOpaqueSort=function(t){I=t},this.setTransparentSort=function(t){O=t},this.getClearColor=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getClearColor() now requires a Color as an argument"),t=new Ut),t.copy(dt.getClearColor())},this.setClearColor=function(){dt.setClearColor.apply(dt,arguments)},this.getClearAlpha=function(){return dt.getClearAlpha()},this.setClearAlpha=function(){dt.setClearAlpha.apply(dt,arguments)},this.clear=function(t,e,i){let n=0;(void 0===t||t)&&(n|=yt.COLOR_BUFFER_BIT),(void 0===e||e)&&(n|=yt.DEPTH_BUFFER_BIT),(void 0===i||i)&&(n|=yt.STENCIL_BUFFER_BIT),yt.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){e.removeEventListener("webglcontextlost",Et,!1),e.removeEventListener("webglcontextrestored",Tt,!1),lt.dispose(),ct.dispose(),et.dispose(),nt.dispose(),at.dispose(),vt.dispose(),Mt.dispose(),Pt.stop()},this.renderBufferImmediate=function(t,e){vt.initAttributes();const i=et.get(t);t.hasPositions&&!i.position&&(i.position=yt.createBuffer()),t.hasNormals&&!i.normal&&(i.normal=yt.createBuffer()),t.hasUvs&&!i.uv&&(i.uv=yt.createBuffer()),t.hasColors&&!i.color&&(i.color=yt.createBuffer());const n=e.getAttributes();t.hasPositions&&(yt.bindBuffer(yt.ARRAY_BUFFER,i.position),yt.bufferData(yt.ARRAY_BUFFER,t.positionArray,yt.DYNAMIC_DRAW),vt.enableAttribute(n.position),yt.vertexAttribPointer(n.position,3,yt.FLOAT,!1,0,0)),t.hasNormals&&(yt.bindBuffer(yt.ARRAY_BUFFER,i.normal),yt.bufferData(yt.ARRAY_BUFFER,t.normalArray,yt.DYNAMIC_DRAW),vt.enableAttribute(n.normal),yt.vertexAttribPointer(n.normal,3,yt.FLOAT,!1,0,0)),t.hasUvs&&(yt.bindBuffer(yt.ARRAY_BUFFER,i.uv),yt.bufferData(yt.ARRAY_BUFFER,t.uvArray,yt.DYNAMIC_DRAW),vt.enableAttribute(n.uv),yt.vertexAttribPointer(n.uv,2,yt.FLOAT,!1,0,0)),t.hasColors&&(yt.bindBuffer(yt.ARRAY_BUFFER,i.color),yt.bufferData(yt.ARRAY_BUFFER,t.colorArray,yt.DYNAMIC_DRAW),vt.enableAttribute(n.color),yt.vertexAttribPointer(n.color,3,yt.FLOAT,!1,0,0)),vt.disableUnusedAttributes(),yt.drawArrays(yt.TRIANGLES,0,t.count),t.count=0},this.renderBufferDirect=function(t,e,i,n,r,s){null===e&&(e=q);const a=r.isMesh&&r.matrixWorld.determinant()<0,o=Ot(t,e,n,r);$.setMaterial(n,a);let h=i.index;const l=i.attributes.position;if(null===h){if(void 0===l||0===l.count)return}else if(0===h.count)return;let c,u=1;!0===n.wireframe&&(h=st.getWireframeAttribute(i),u=2),(n.morphTargets||n.morphNormals)&&pt.update(r,i,n,o),vt.setup(r,n,o,i,h);let d=ft;null!==h&&(c=rt.get(h),d=mt,d.setIndex(c));const p=null!==h?h.count:l.count,f=i.drawRange.start*u,m=i.drawRange.count*u,g=null!==s?s.start*u:0,v=null!==s?s.count*u:1/0,y=Math.max(f,g),x=Math.min(p,f+m,g+v)-1,_=Math.max(0,x-y+1);if(0!==_){if(r.isMesh)!0===n.wireframe?($.setLineWidth(n.wireframeLinewidth*Z()),d.setMode(yt.LINES)):d.setMode(yt.TRIANGLES);else if(r.isLine){let t=n.linewidth;void 0===t&&(t=1),$.setLineWidth(t*Z()),r.isLineSegments?d.setMode(yt.LINES):r.isLineLoop?d.setMode(yt.LINE_LOOP):d.setMode(yt.LINE_STRIP)}else r.isPoints?d.setMode(yt.POINTS):r.isSprite&&d.setMode(yt.TRIANGLES);if(r.isInstancedMesh)d.renderInstances(y,_,r.count);else if(i.isInstancedBufferGeometry){const t=Math.min(i.instanceCount,i._maxInstanceCount);d.renderInstances(y,_,t)}else d.render(y,_)}},this.compile=function(t,e){d=ct.get(t),d.init(),t.traverseVisible((function(t){t.isLight&&t.layers.test(e.layers)&&(d.pushLight(t),t.castShadow&&d.pushShadow(t))})),d.setupLights();const i=new WeakMap;t.traverse((function(e){const n=e.material;if(n)if(Array.isArray(n))for(let r=0;r<n.length;r++){const s=n[r];!1===i.has(s)&&(It(s,t,e),i.set(s))}else!1===i.has(n)&&(It(n,t,e),i.set(n))}))};let At=null;const Pt=new zt;function Rt(t,e,i,n){if(!1===t.visible)return;if(t.layers.test(e.layers))if(t.isGroup)i=t.renderOrder;else if(t.isLOD)!0===t.autoUpdate&&t.update(e);else if(t.isLight)d.pushLight(t),t.castShadow&&d.pushShadow(t);else if(t.isSprite){if(!t.frustumCulled||G.intersectsSprite(t)){n&&j.setFromMatrixPosition(t.matrixWorld).applyMatrix4(W);const e=at.update(t),r=t.material;r.visible&&u.push(t,e,r,i,j.z,null)}}else if(t.isImmediateRenderObject)n&&j.setFromMatrixPosition(t.matrixWorld).applyMatrix4(W),u.push(t,null,t.material,i,j.z,null);else if((t.isMesh||t.isLine||t.isPoints)&&(t.isSkinnedMesh&&t.skeleton.frame!==tt.render.frame&&(t.skeleton.update(),t.skeleton.frame=tt.render.frame),!t.frustumCulled||G.intersectsObject(t))){n&&j.setFromMatrixPosition(t.matrixWorld).applyMatrix4(W);const e=at.update(t),r=t.material;if(Array.isArray(r)){const n=e.groups;for(let s=0,a=n.length;s<a;s++){const a=n[s],o=r[a.materialIndex];o&&o.visible&&u.push(t,e,o,i,j.z,a)}}else r.visible&&u.push(t,e,r,i,j.z,null)}const r=t.children;for(let t=0,s=r.length;t<s;t++)Rt(r[t],e,i,n)}function Dt(t,e,i){const n=!0===e.isScene?e.overrideMaterial:null;for(let r=0,s=t.length;r<s;r++){const s=t[r],a=s.object,o=s.geometry,h=null===n?s.material:n,l=s.group;if(i.isArrayCamera){const t=i.cameras;for(let i=0,n=t.length;i<n;i++){const n=t[i];a.layers.test(n.layers)&&($.viewport(S.copy(n.viewport)),d.setupLightsView(n),Nt(a,e,n,o,h,l))}}else Nt(a,e,i,o,h,l)}}function Nt(t,e,i,n,r,s){if(t.onBeforeRender(f,e,i,n,r,s),t.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix),t.isImmediateRenderObject){const n=Ot(i,e,r,t);$.setMaterial(r),vt.reset(),function(t,e){t.render((function(t){f.renderBufferImmediate(t,e)}))}(t,n)}else f.renderBufferDirect(i,e,n,r,t,s);t.onAfterRender(f,e,i,n,r,s)}function It(t,e,i){!0!==e.isScene&&(e=q);const n=et.get(t),r=d.state.lights,s=d.state.shadowsArray,a=r.state.version,o=ot.getParameters(t,r.state,s,e,i),h=ot.getProgramCacheKey(o);let l=n.program,c=!0;if(void 0===l)t.addEventListener("dispose",Lt);else if(l.cacheKey!==h)Ct(t);else if(n.lightsStateVersion!==a)c=!1;else{if(void 0!==o.shaderID){const i=t.isMeshStandardMaterial?e.environment:null;return void(n.envMap=nt.get(t.envMap||i))}c=!1}c&&(o.uniforms=ot.getUniforms(t),t.onBeforeCompile(o,f),l=ot.acquireProgram(o,h),n.program=l,n.uniforms=o.uniforms,n.outputEncoding=o.outputEncoding);const u=n.uniforms;(t.isShaderMaterial||t.isRawShaderMaterial)&&!0!==t.clipping||(n.numClippingPlanes=ut.numPlanes,n.numIntersection=ut.numIntersection,u.clippingPlanes=ut.uniform),n.environment=t.isMeshStandardMaterial?e.environment:null,n.fog=e.fog,n.envMap=nt.get(t.envMap||n.environment),n.needsLights=function(t){return t.isMeshLambertMaterial||t.isMeshToonMaterial||t.isMeshPhongMaterial||t.isMeshStandardMaterial||t.isShadowMaterial||t.isShaderMaterial&&!0===t.lights}(t),n.lightsStateVersion=a,n.needsLights&&(u.ambientLightColor.value=r.state.ambient,u.lightProbe.value=r.state.probe,u.directionalLights.value=r.state.directional,u.directionalLightShadows.value=r.state.directionalShadow,u.spotLights.value=r.state.spot,u.spotLightShadows.value=r.state.spotShadow,u.rectAreaLights.value=r.state.rectArea,u.ltc_1.value=r.state.rectAreaLTC1,u.ltc_2.value=r.state.rectAreaLTC2,u.pointLights.value=r.state.point,u.pointLightShadows.value=r.state.pointShadow,u.hemisphereLights.value=r.state.hemi,u.directionalShadowMap.value=r.state.directionalShadowMap,u.directionalShadowMatrix.value=r.state.directionalShadowMatrix,u.spotShadowMap.value=r.state.spotShadowMap,u.spotShadowMatrix.value=r.state.spotShadowMatrix,u.pointShadowMap.value=r.state.pointShadowMap,u.pointShadowMatrix.value=r.state.pointShadowMatrix);const p=n.program.getUniforms(),m=Hn.seqWithValue(p.seq,u);n.uniformsList=m}function Ot(t,e,i,n){!0!==e.isScene&&(e=q),it.resetTextureUnits();const r=e.fog,s=i.isMeshStandardMaterial?e.environment:null,a=null===x?f.outputEncoding:x.texture.encoding,o=nt.get(i.envMap||s),h=et.get(i),l=d.state.lights;if(!0===H&&(!0===V||t!==w)){const e=t===w&&i.id===M;ut.setState(i,t,e)}i.version===h.__version?i.fog&&h.fog!==r||h.environment!==s||h.needsLights&&h.lightsStateVersion!==l.state.version?It(i,e,n):void 0===h.numClippingPlanes||h.numClippingPlanes===ut.numPlanes&&h.numIntersection===ut.numIntersection?(h.outputEncoding!==a||h.envMap!==o)&&It(i,e,n):It(i,e,n):(It(i,e,n),h.__version=i.version);let c=!1,u=!1,p=!1;const m=h.program,g=m.getUniforms(),v=h.uniforms;if($.useProgram(m.program)&&(c=!0,u=!0,p=!0),i.id!==M&&(M=i.id,u=!0),c||w!==t){if(g.setValue(yt,"projectionMatrix",t.projectionMatrix),K.logarithmicDepthBuffer&&g.setValue(yt,"logDepthBufFC",2/(Math.log(t.far+1)/Math.LN2)),w!==t&&(w=t,u=!0,p=!0),i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshStandardMaterial||i.envMap){const e=g.map.cameraPosition;void 0!==e&&e.setValue(yt,j.setFromMatrixPosition(t.matrixWorld))}(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial)&&g.setValue(yt,"isOrthographic",!0===t.isOrthographicCamera),(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.isShadowMaterial||i.skinning)&&g.setValue(yt,"viewMatrix",t.matrixWorldInverse)}if(i.skinning){g.setOptional(yt,n,"bindMatrix"),g.setOptional(yt,n,"bindMatrixInverse");const t=n.skeleton;if(t){const e=t.bones;if(K.floatVertexTextures){if(null===t.boneTexture){let i=Math.sqrt(4*e.length);i=z.ceilPowerOfTwo(i),i=Math.max(i,4);const n=new Float32Array(i*i*4);n.set(t.boneMatrices);const r=new Y(n,i,i,A,E);t.boneMatrices=n,t.boneTexture=r,t.boneTextureSize=i}g.setValue(yt,"boneTexture",t.boneTexture,it),g.setValue(yt,"boneTextureSize",t.boneTextureSize)}else g.setOptional(yt,t,"boneMatrices")}}return(u||h.receiveShadow!==n.receiveShadow)&&(h.receiveShadow=n.receiveShadow,g.setValue(yt,"receiveShadow",n.receiveShadow)),u&&(g.setValue(yt,"toneMappingExposure",f.toneMappingExposure),h.needsLights&&function(t,e){t.ambientLightColor.needsUpdate=e,t.lightProbe.needsUpdate=e,t.directionalLights.needsUpdate=e,t.directionalLightShadows.needsUpdate=e,t.pointLights.needsUpdate=e,t.pointLightShadows.needsUpdate=e,t.spotLights.needsUpdate=e,t.spotLightShadows.needsUpdate=e,t.rectAreaLights.needsUpdate=e,t.hemisphereLights.needsUpdate=e}(v,p),r&&i.fog&&ht.refreshFogUniforms(v,r),ht.refreshMaterialUniforms(v,i,N,R),Hn.upload(yt,h.uniformsList,v,it)),i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(Hn.upload(yt,h.uniformsList,v,it),i.uniformsNeedUpdate=!1),i.isSpriteMaterial&&g.setValue(yt,"center",n.center),g.setValue(yt,"modelViewMatrix",n.modelViewMatrix),g.setValue(yt,"normalMatrix",n.normalMatrix),g.setValue(yt,"modelMatrix",n.matrixWorld),m}Pt.setAnimationLoop((function(t){Mt.isPresenting||At&&At(t)})),"undefined"!=typeof window&&Pt.setContext(window),this.setAnimationLoop=function(t){At=t,Mt.setAnimationLoop(t),null===t?Pt.stop():Pt.start()},this.render=function(t,e){let i,n;if(void 0!==arguments[2]&&(console.warn("THREE.WebGLRenderer.render(): the renderTarget argument has been removed. Use .setRenderTarget() instead."),i=arguments[2]),void 0!==arguments[3]&&(console.warn("THREE.WebGLRenderer.render(): the forceClear argument has been removed. Use .clear() instead."),n=arguments[3]),void 0!==e&&!0!==e.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===m)return;vt.resetDefaultState(),M=-1,w=null,!0===t.autoUpdate&&t.updateMatrixWorld(),null===e.parent&&e.updateMatrixWorld(),!0===Mt.enabled&&!0===Mt.isPresenting&&(e=Mt.getCamera(e)),!0===t.isScene&&t.onBeforeRender(f,t,e,i||x),d=ct.get(t,p.length),d.init(),p.push(d),W.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),G.setFromProjectionMatrix(W),V=this.localClippingEnabled,H=ut.init(this.clippingPlanes,V,e),u=lt.get(t,e),u.init(),Rt(t,e,0,f.sortObjects),u.finish(),!0===f.sortObjects&&u.sort(I,O),!0===H&&ut.beginShadows();const r=d.state.shadowsArray;St.render(r,t,e),d.setupLights(),d.setupLightsView(e),!0===H&&ut.endShadows(),!0===this.info.autoReset&&this.info.reset(),void 0!==i&&this.setRenderTarget(i),dt.render(u,t,e,n);const s=u.opaque,a=u.transparent;s.length>0&&Dt(s,t,e),a.length>0&&Dt(a,t,e),!0===t.isScene&&t.onAfterRender(f,t,e),null!==x&&(it.updateRenderTargetMipmap(x),it.updateMultisampleRenderTarget(x)),$.buffers.depth.setTest(!0),$.buffers.depth.setMask(!0),$.buffers.color.setMask(!0),$.setPolygonOffset(!1),p.pop(),d=p.length>0?p[p.length-1]:null,u=null},this.setFramebuffer=function(t){g!==t&&null===x&&yt.bindFramebuffer(yt.FRAMEBUFFER,t),g=t},this.getActiveCubeFace=function(){return v},this.getActiveMipmapLevel=function(){return y},this.getRenderList=function(){return u},this.setRenderList=function(t){u=t},this.getRenderTarget=function(){return x},this.setRenderTarget=function(t,e=0,i=0){x=t,v=e,y=i,t&&void 0===et.get(t).__webglFramebuffer&&it.setupRenderTarget(t);let n=g,r=!1;if(t){const i=et.get(t).__webglFramebuffer;t.isWebGLCubeRenderTarget?(n=i[e],r=!0):n=t.isWebGLMultisampleRenderTarget?et.get(t).__webglMultisampledFramebuffer:i,S.copy(t.viewport),L.copy(t.scissor),C=t.scissorTest}else S.copy(F).multiplyScalar(N).floor(),L.copy(U).multiplyScalar(N).floor(),C=B;if(_!==n&&(yt.bindFramebuffer(yt.FRAMEBUFFER,n),_=n),$.viewport(S),$.scissor(L),$.setScissorTest(C),r){const n=et.get(t.texture);yt.framebufferTexture2D(yt.FRAMEBUFFER,yt.COLOR_ATTACHMENT0,yt.TEXTURE_CUBE_MAP_POSITIVE_X+e,n.__webglTexture,i)}},this.readRenderTargetPixels=function(t,e,i,n,r,s,a){if(!t||!t.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let o=et.get(t).__webglFramebuffer;if(t.isWebGLCubeRenderTarget&&void 0!==a&&(o=o[a]),o){let a=!1;o!==_&&(yt.bindFramebuffer(yt.FRAMEBUFFER,o),a=!0);try{const o=t.texture,h=o.format,l=o.type;if(h!==A&&gt.convert(h)!==yt.getParameter(yt.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(l===b||gt.convert(l)===yt.getParameter(yt.IMPLEMENTATION_COLOR_READ_TYPE)||l===E&&(K.isWebGL2||Q.get("OES_texture_float")||Q.get("WEBGL_color_buffer_float"))||l===T&&(K.isWebGL2?Q.get("EXT_color_buffer_float"):Q.get("EXT_color_buffer_half_float"))))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");yt.checkFramebufferStatus(yt.FRAMEBUFFER)===yt.FRAMEBUFFER_COMPLETE?e>=0&&e<=t.width-n&&i>=0&&i<=t.height-r&&yt.readPixels(e,i,n,r,gt.convert(h),gt.convert(l),s):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{a&&yt.bindFramebuffer(yt.FRAMEBUFFER,_)}}},this.copyFramebufferToTexture=function(t,e,i=0){const n=Math.pow(2,-i),r=Math.floor(e.image.width*n),s=Math.floor(e.image.height*n),a=gt.convert(e.format);it.setTexture2D(e,0),yt.copyTexImage2D(yt.TEXTURE_2D,i,a,t.x,t.y,r,s,0),$.unbindTexture()},this.copyTextureToTexture=function(t,e,i,n=0){const r=e.image.width,s=e.image.height,a=gt.convert(i.format),o=gt.convert(i.type);it.setTexture2D(i,0),yt.pixelStorei(yt.UNPACK_FLIP_Y_WEBGL,i.flipY),yt.pixelStorei(yt.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i.premultiplyAlpha),yt.pixelStorei(yt.UNPACK_ALIGNMENT,i.unpackAlignment),e.isDataTexture?yt.texSubImage2D(yt.TEXTURE_2D,n,t.x,t.y,r,s,a,o,e.image.data):e.isCompressedTexture?yt.compressedTexSubImage2D(yt.TEXTURE_2D,n,t.x,t.y,e.mipmaps[0].width,e.mipmaps[0].height,a,e.mipmaps[0].data):yt.texSubImage2D(yt.TEXTURE_2D,n,t.x,t.y,a,o,e.image),0===n&&i.generateMipmaps&&yt.generateMipmap(yt.TEXTURE_2D),$.unbindTexture()},this.initTexture=function(t){it.setTexture2D(t,0),$.unbindTexture()},this.resetState=function(){$.reset(),vt.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}Lr.prototype=Object.assign(Object.create(Ri.prototype),{constructor:Lr,isArrayCamera:!0}),Cr.prototype=Object.assign(Object.create(ve.prototype),{constructor:Cr,isGroup:!0}),Object.assign(Ar.prototype,{constructor:Ar,getHandSpace:function(){if(null===this._hand&&(this._hand=new Cr,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints=[],this._hand.inputState={pinching:!1},window.XRHand))for(let t=0;t<=window.XRHand.LITTLE_PHALANX_TIP;t++){const t=new Cr;t.matrixAutoUpdate=!1,t.visible=!1,this._hand.joints.push(t),this._hand.add(t)}return this._hand},getTargetRaySpace:function(){return null===this._targetRay&&(this._targetRay=new Cr,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1),this._targetRay},getGripSpace:function(){return null===this._grip&&(this._grip=new Cr,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1),this._grip},dispatchEvent:function(t){return null!==this._targetRay&&this._targetRay.dispatchEvent(t),null!==this._grip&&this._grip.dispatchEvent(t),null!==this._hand&&this._hand.dispatchEvent(t),this},disconnect:function(t){return this.dispatchEvent({type:"disconnected",data:t}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this},update:function(t,e,i){let n=null,r=null,s=null;const a=this._targetRay,o=this._grip,h=this._hand;if(t&&"visible-blurred"!==e.session.visibilityState)if(h&&t.hand){s=!0;for(let n=0;n<=window.XRHand.LITTLE_PHALANX_TIP;n++)if(t.hand[n]){const r=e.getJointPose(t.hand[n],i),s=h.joints[n];null!==r&&(s.matrix.fromArray(r.transform.matrix),s.matrix.decompose(s.position,s.rotation,s.scale),s.jointRadius=r.radius),s.visible=null!==r;const a=h.joints[window.XRHand.INDEX_PHALANX_TIP],o=h.joints[window.XRHand.THUMB_PHALANX_TIP],l=a.position.distanceTo(o.position),c=.02,u=.005;h.inputState.pinching&&l>c+u?(h.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:t.handedness,target:this})):!h.inputState.pinching&&l<=c-u&&(h.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:t.handedness,target:this}))}}else null!==a&&(n=e.getPose(t.targetRaySpace,i),null!==n&&(a.matrix.fromArray(n.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale))),null!==o&&t.gripSpace&&(r=e.getPose(t.gripSpace,i),null!==r&&(o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale)));return null!==a&&(a.visible=null!==n),null!==o&&(o.visible=null!==r),null!==h&&(h.visible=null!==s),this}}),Object.assign(Pr.prototype,u.prototype);class Nr{constructor(t,e){Object.defineProperty(this,"isFogExp2",{value:!0}),this.name="",this.color=new Ut(t),this.density=void 0!==e?e:25e-5}clone(){return new Nr(this.color,this.density)}toJSON(){return{type:"FogExp2",color:this.color.getHex(),density:this.density}}}class Ir extends ve{constructor(){super(),Object.defineProperty(this,"isScene",{value:!0}),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(t,e){return super.copy(t,e),null!==t.background&&(this.background=t.background.clone()),null!==t.environment&&(this.environment=t.environment.clone()),null!==t.fog&&(this.fog=t.fog.clone()),null!==t.overrideMaterial&&(this.overrideMaterial=t.overrideMaterial.clone()),this.autoUpdate=t.autoUpdate,this.matrixAutoUpdate=t.matrixAutoUpdate,this}toJSON(t){const e=super.toJSON(t);return null!==this.background&&(e.object.background=this.background.toJSON(t)),null!==this.environment&&(e.object.environment=this.environment.toJSON(t)),null!==this.fog&&(e.object.fog=this.fog.toJSON()),e}}function Or(t){Pe.call(this),this.type="LineBasicMaterial",this.color=new Ut(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.morphTargets=!1,this.setValues(t)}Or.prototype=Object.create(Pe.prototype),Or.prototype.constructor=Or,Or.prototype.isLineBasicMaterial=!0,Or.prototype.copy=function(t){return Pe.prototype.copy.call(this,t),this.color.copy(t.color),this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this.morphTargets=t.morphTargets,this};const Fr=new J,Ur=new J,zr=new wt,kr=new He,Br=new mt;function Gr(t=new Te,e=new Or){ve.call(this),this.type="Line",this.geometry=t,this.material=e,this.updateMorphTargets()}Gr.prototype=Object.assign(Object.create(ve.prototype),{constructor:Gr,isLine:!0,copy:function(t){return ve.prototype.copy.call(this,t),this.material=t.material,this.geometry=t.geometry,this},computeLineDistances:function(){const t=this.geometry;if(t.isBufferGeometry)if(null===t.index){const e=t.attributes.position,i=[0];for(let t=1,n=e.count;t<n;t++)Fr.fromBufferAttribute(e,t-1),Ur.fromBufferAttribute(e,t),i[t]=i[t-1],i[t]+=Fr.distanceTo(Ur);t.setAttribute("lineDistance",new Qt(i,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else if(t.isGeometry){const e=t.vertices,i=t.lineDistances;i[0]=0;for(let t=1,n=e.length;t<n;t++)i[t]=i[t-1],i[t]+=e[t-1].distanceTo(e[t])}return this},raycast:function(t,e){const i=this.geometry,n=this.matrixWorld,r=t.params.Line.threshold;if(null===i.boundingSphere&&i.computeBoundingSphere(),Br.copy(i.boundingSphere),Br.applyMatrix4(n),Br.radius+=r,!1===t.ray.intersectsSphere(Br))return;zr.copy(n).invert(),kr.copy(t.ray).applyMatrix4(zr);const s=r/((this.scale.x+this.scale.y+this.scale.z)/3),a=s*s,o=new J,h=new J,l=new J,c=new J,u=this.isLineSegments?2:1;if(i.isBufferGeometry){const n=i.index,r=i.attributes.position;if(null!==n){const i=n.array;for(let n=0,s=i.length-1;n<s;n+=u){const s=i[n],u=i[n+1];o.fromBufferAttribute(r,s),h.fromBufferAttribute(r,u);if(kr.distanceSqToSegment(o,h,c,l)>a)continue;c.applyMatrix4(this.matrixWorld);const d=t.ray.origin.distanceTo(c);d<t.near||d>t.far||e.push({distance:d,point:l.clone().applyMatrix4(this.matrixWorld),index:n,face:null,faceIndex:null,object:this})}}else for(let i=0,n=r.count-1;i<n;i+=u){o.fromBufferAttribute(r,i),h.fromBufferAttribute(r,i+1);if(kr.distanceSqToSegment(o,h,c,l)>a)continue;c.applyMatrix4(this.matrixWorld);const n=t.ray.origin.distanceTo(c);n<t.near||n>t.far||e.push({distance:n,point:l.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}else if(i.isGeometry){const n=i.vertices,r=n.length;for(let i=0;i<r-1;i+=u){if(kr.distanceSqToSegment(n[i],n[i+1],c,l)>a)continue;c.applyMatrix4(this.matrixWorld);const r=t.ray.origin.distanceTo(c);r<t.near||r>t.far||e.push({distance:r,point:l.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}},updateMorphTargets:function(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,i=Object.keys(e);if(i.length>0){const t=e[i[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=t.length;e<i;e++){const i=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Line.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}});const Hr=new J,Vr=new J;function Wr(t,e){Gr.call(this,t,e),this.type="LineSegments"}function jr(t){Pe.call(this),this.type="PointsMaterial",this.color=new Ut(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.morphTargets=!1,this.setValues(t)}Wr.prototype=Object.assign(Object.create(Gr.prototype),{constructor:Wr,isLineSegments:!0,computeLineDistances:function(){const t=this.geometry;if(t.isBufferGeometry)if(null===t.index){const e=t.attributes.position,i=[];for(let t=0,n=e.count;t<n;t+=2)Hr.fromBufferAttribute(e,t),Vr.fromBufferAttribute(e,t+1),i[t]=0===t?0:i[t-1],i[t+1]=i[t]+Hr.distanceTo(Vr);t.setAttribute("lineDistance",new Qt(i,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else if(t.isGeometry){const e=t.vertices,i=t.lineDistances;for(let t=0,n=e.length;t<n;t+=2)Hr.copy(e[t]),Vr.copy(e[t+1]),i[t]=0===t?0:i[t-1],i[t+1]=i[t]+Hr.distanceTo(Vr)}return this}}),jr.prototype=Object.create(Pe.prototype),jr.prototype.constructor=jr,jr.prototype.isPointsMaterial=!0,jr.prototype.copy=function(t){return Pe.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.morphTargets=t.morphTargets,this};const Xr=new wt,qr=new He,Yr=new mt,Zr=new J;function Jr(t=new Te,e=new jr){ve.call(this),this.type="Points",this.geometry=t,this.material=e,this.updateMorphTargets()}function Qr(t,e,i,n,r,s,a){const o=qr.distanceSqToPoint(t);if(o<i){const i=new J;qr.closestPointToPoint(t,i),i.applyMatrix4(n);const h=r.ray.origin.distanceTo(i);if(h<r.near||h>r.far)return;s.push({distance:h,distanceToRay:Math.sqrt(o),point:i,index:e,face:null,object:a})}}function Kr(t,e,i,n,r,s,a,o,h){W.call(this,t,e,i,n,r,s,a,o,h),this.needsUpdate=!0}Jr.prototype=Object.assign(Object.create(ve.prototype),{constructor:Jr,isPoints:!0,copy:function(t){return ve.prototype.copy.call(this,t),this.material=t.material,this.geometry=t.geometry,this},raycast:function(t,e){const i=this.geometry,n=this.matrixWorld,r=t.params.Points.threshold;if(null===i.boundingSphere&&i.computeBoundingSphere(),Yr.copy(i.boundingSphere),Yr.applyMatrix4(n),Yr.radius+=r,!1===t.ray.intersectsSphere(Yr))return;Xr.copy(n).invert(),qr.copy(t.ray).applyMatrix4(Xr);const s=r/((this.scale.x+this.scale.y+this.scale.z)/3),a=s*s;if(i.isBufferGeometry){const r=i.index,s=i.attributes.position;if(null!==r){const i=r.array;for(let r=0,o=i.length;r<o;r++){const o=i[r];Zr.fromBufferAttribute(s,o),Qr(Zr,o,a,n,t,e,this)}}else for(let i=0,r=s.count;i<r;i++)Zr.fromBufferAttribute(s,i),Qr(Zr,i,a,n,t,e,this)}else{const r=i.vertices;for(let i=0,s=r.length;i<s;i++)Qr(r[i],i,a,n,t,e,this)}},updateMorphTargets:function(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,i=Object.keys(e);if(i.length>0){const t=e[i[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=t.length;e<i;e++){const i=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Points.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}),Kr.prototype=Object.create(W.prototype),Kr.prototype.constructor=Kr,Kr.prototype.isCanvasTexture=!0;class $r extends Te{constructor(t=1,e=8,i=6,n=0,r=2*Math.PI,s=0,a=Math.PI){super(),this.type="SphereBufferGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:n,phiLength:r,thetaStart:s,thetaLength:a},e=Math.max(3,Math.floor(e)),i=Math.max(2,Math.floor(i));const o=Math.min(s+a,Math.PI);let h=0;const l=[],c=new J,u=new J,d=[],p=[],f=[],m=[];for(let d=0;d<=i;d++){const g=[],v=d/i;let y=0;0==d&&0==s?y=.5/e:d==i&&o==Math.PI&&(y=-.5/e);for(let i=0;i<=e;i++){const o=i/e;c.x=-t*Math.cos(n+o*r)*Math.sin(s+v*a),c.y=t*Math.cos(s+v*a),c.z=t*Math.sin(n+o*r)*Math.sin(s+v*a),p.push(c.x,c.y,c.z),u.copy(c).normalize(),f.push(u.x,u.y,u.z),m.push(o+y,1-v),g.push(h++)}l.push(g)}for(let t=0;t<i;t++)for(let n=0;n<e;n++){const e=l[t][n+1],r=l[t][n],a=l[t+1][n],h=l[t+1][n+1];(0!==t||s>0)&&d.push(e,r,h),(t!==i-1||o<Math.PI)&&d.push(r,a,h)}this.setIndex(d),this.setAttribute("position",new Qt(p,3)),this.setAttribute("normal",new Qt(f,3)),this.setAttribute("uv",new Qt(m,2))}}class ts extends Te{constructor(t=.5,e=1,i=8,n=1,r=0,s=2*Math.PI){super(),this.type="RingBufferGeometry",this.parameters={innerRadius:t,outerRadius:e,thetaSegments:i,phiSegments:n,thetaStart:r,thetaLength:s},i=Math.max(3,i);const a=[],o=[],h=[],l=[];let c=t;const u=(e-t)/(n=Math.max(1,n)),d=new J,p=new k;for(let t=0;t<=n;t++){for(let t=0;t<=i;t++){const n=r+t/i*s;d.x=c*Math.cos(n),d.y=c*Math.sin(n),o.push(d.x,d.y,d.z),h.push(0,0,1),p.x=(d.x/e+1)/2,p.y=(d.y/e+1)/2,l.push(p.x,p.y)}c+=u}for(let t=0;t<n;t++){const e=t*(i+1);for(let t=0;t<i;t++){const n=t+e,r=n,s=n+i+1,o=n+i+2,h=n+1;a.push(r,s,h),a.push(s,o,h)}}this.setIndex(a),this.setAttribute("position",new Qt(o,3)),this.setAttribute("normal",new Qt(h,3)),this.setAttribute("uv",new Qt(l,2))}}class es extends Te{constructor(t=1,e=1,i=1,n=8,r=1,s=!1,a=0,o=2*Math.PI){super(),this.type="CylinderBufferGeometry",this.parameters={radiusTop:t,radiusBottom:e,height:i,radialSegments:n,heightSegments:r,openEnded:s,thetaStart:a,thetaLength:o};const h=this;n=Math.floor(n),r=Math.floor(r);const l=[],c=[],u=[],d=[];let p=0;const f=[],m=i/2;let g=0;function v(i){const r=p,s=new k,f=new J;let v=0;const y=!0===i?t:e,x=!0===i?1:-1;for(let t=1;t<=n;t++)c.push(0,m*x,0),u.push(0,x,0),d.push(.5,.5),p++;const _=p;for(let t=0;t<=n;t++){const e=t/n*o+a,i=Math.cos(e),r=Math.sin(e);f.x=y*r,f.y=m*x,f.z=y*i,c.push(f.x,f.y,f.z),u.push(0,x,0),s.x=.5*i+.5,s.y=.5*r*x+.5,d.push(s.x,s.y),p++}for(let t=0;t<n;t++){const e=r+t,n=_+t;!0===i?l.push(n,n+1,e):l.push(n+1,n,e),v+=3}h.addGroup(g,v,!0===i?1:2),g+=v}!function(){const s=new J,v=new J;let y=0;const x=(e-t)/i;for(let h=0;h<=r;h++){const l=[],g=h/r,y=g*(e-t)+t;for(let t=0;t<=n;t++){const e=t/n,r=e*o+a,h=Math.sin(r),f=Math.cos(r);v.x=y*h,v.y=-g*i+m,v.z=y*f,c.push(v.x,v.y,v.z),s.set(h,x,f).normalize(),u.push(s.x,s.y,s.z),d.push(e,1-g),l.push(p++)}f.push(l)}for(let t=0;t<n;t++)for(let e=0;e<r;e++){const i=f[e][t],n=f[e+1][t],r=f[e+1][t+1],s=f[e][t+1];l.push(i,n,s),l.push(n,r,s),y+=6}h.addGroup(g,y,0),g+=y}(),!1===s&&(t>0&&v(!0),e>0&&v(!1)),this.setIndex(l),this.setAttribute("position",new Qt(c,3)),this.setAttribute("normal",new Qt(u,3)),this.setAttribute("uv",new Qt(d,2))}}function is(t){Pe.call(this),this.type="MeshLambertMaterial",this.color=new Ut(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ut(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function ns(t){Pe.call(this),this.type="MeshPhongMaterial",this.color=new Ut(16777215),this.specular=new Ut(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ut(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new k(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}is.prototype=Object.create(Pe.prototype),is.prototype.constructor=is,is.prototype.isMeshLambertMaterial=!0,is.prototype.copy=function(t){return Pe.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},ns.prototype=Object.create(Pe.prototype),ns.prototype.constructor=ns,ns.prototype.isMeshPhongMaterial=!0,ns.prototype.copy=function(t){return Pe.prototype.copy.call(this,t),this.color.copy(t.color),this.specular.copy(t.specular),this.shininess=t.shininess,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this};const rs={enabled:!1,files:{},add:function(t,e){!1!==this.enabled&&(this.files[t]=e)},get:function(t){if(!1!==this.enabled)return this.files[t]},remove:function(t){delete this.files[t]},clear:function(){this.files={}}};const ss=new function(t,e,i){const n=this;let r,s=!1,a=0,o=0;const h=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=i,this.itemStart=function(t){o++,!1===s&&void 0!==n.onStart&&n.onStart(t,a,o),s=!0},this.itemEnd=function(t){a++,void 0!==n.onProgress&&n.onProgress(t,a,o),a===o&&(s=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(t){void 0!==n.onError&&n.onError(t)},this.resolveURL=function(t){return r?r(t):t},this.setURLModifier=function(t){return r=t,this},this.addHandler=function(t,e){return h.push(t,e),this},this.removeHandler=function(t){const e=h.indexOf(t);return-1!==e&&h.splice(e,2),this},this.getHandler=function(t){for(let e=0,i=h.length;e<i;e+=2){const i=h[e],n=h[e+1];if(i.global&&(i.lastIndex=0),i.test(t))return n}return null}};function as(t){this.manager=void 0!==t?t:ss,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}function os(t){as.call(this,t)}function hs(t){as.call(this,t)}Object.assign(as.prototype,{load:function(){},loadAsync:function(t,e){const i=this;return new Promise((function(n,r){i.load(t,n,e,r)}))},parse:function(){},setCrossOrigin:function(t){return this.crossOrigin=t,this},setWithCredentials:function(t){return this.withCredentials=t,this},setPath:function(t){return this.path=t,this},setResourcePath:function(t){return this.resourcePath=t,this},setRequestHeader:function(t){return this.requestHeader=t,this}}),os.prototype=Object.assign(Object.create(as.prototype),{constructor:os,load:function(t,e,i,n){void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,s=rs.get(t);if(void 0!==s)return r.manager.itemStart(t),setTimeout((function(){e&&e(s),r.manager.itemEnd(t)}),0),s;const a=document.createElementNS("http://www.w3.org/1999/xhtml","img");function o(){a.removeEventListener("load",o,!1),a.removeEventListener("error",h,!1),rs.add(t,this),e&&e(this),r.manager.itemEnd(t)}function h(e){a.removeEventListener("load",o,!1),a.removeEventListener("error",h,!1),n&&n(e),r.manager.itemError(t),r.manager.itemEnd(t)}return a.addEventListener("load",o,!1),a.addEventListener("error",h,!1),"data:"!==t.substr(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),r.manager.itemStart(t),a.src=t,a}}),hs.prototype=Object.assign(Object.create(as.prototype),{constructor:hs,load:function(t,e,i,n){const r=new W,s=new os(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(t,(function(i){r.image=i;const n=t.search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/);r.format=n?C:A,r.needsUpdate=!0,void 0!==e&&e(r)}),i,n),r}});const ls={};function cs(t){as.call(this,t)}function us(t,e=1){ve.call(this),this.type="Light",this.color=new Ut(t),this.intensity=e}function ds(t,e,i){us.call(this,t,i),this.type="HemisphereLight",this.position.copy(ve.DefaultUp),this.updateMatrix(),this.groundColor=new Ut(e)}function ps(t){this.camera=t,this.bias=0,this.normalBias=0,this.radius=1,this.mapSize=new k(512,512),this.map=null,this.mapPass=null,this.matrix=new wt,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new bt,this._frameExtents=new k(1,1),this._viewportCount=1,this._viewports=[new X(0,0,1,1)]}function fs(t=-1,e=1,i=1,n=-1,r=.1,s=2e3){Pi.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=i,this.bottom=n,this.near=r,this.far=s,this.updateProjectionMatrix()}function ms(){ps.call(this,new fs(-5,5,5,-5,.5,500))}function gs(t,e){us.call(this,t,e),this.type="DirectionalLight",this.position.copy(ve.DefaultUp),this.updateMatrix(),this.target=new ve,this.shadow=new ms}function vs(t,e){us.call(this,t,e),this.type="AmbientLight"}cs.prototype=Object.assign(Object.create(as.prototype),{constructor:cs,load:function(t,e,i,n){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,s=rs.get(t);if(void 0!==s)return r.manager.itemStart(t),setTimeout((function(){e&&e(s),r.manager.itemEnd(t)}),0),s;if(void 0!==ls[t])return void ls[t].push({onLoad:e,onProgress:i,onError:n});const a=t.match(/^data:(.*?)(;base64)?,(.*)$/);let o;if(a){const i=a[1],s=!!a[2];let o=a[3];o=decodeURIComponent(o),s&&(o=atob(o));try{let n;const s=(this.responseType||"").toLowerCase();switch(s){case"arraybuffer":case"blob":const t=new Uint8Array(o.length);for(let e=0;e<o.length;e++)t[e]=o.charCodeAt(e);n="blob"===s?new Blob([t.buffer],{type:i}):t.buffer;break;case"document":const e=new DOMParser;n=e.parseFromString(o,i);break;case"json":n=JSON.parse(o);break;default:n=o}setTimeout((function(){e&&e(n),r.manager.itemEnd(t)}),0)}catch(e){setTimeout((function(){n&&n(e),r.manager.itemError(t),r.manager.itemEnd(t)}),0)}}else{ls[t]=[],ls[t].push({onLoad:e,onProgress:i,onError:n}),o=new XMLHttpRequest,o.open("GET",t,!0),o.addEventListener("load",(function(e){const i=this.response,n=ls[t];if(delete ls[t],200===this.status||0===this.status){0===this.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),rs.add(t,i);for(let t=0,e=n.length;t<e;t++){const e=n[t];e.onLoad&&e.onLoad(i)}r.manager.itemEnd(t)}else{for(let t=0,i=n.length;t<i;t++){const i=n[t];i.onError&&i.onError(e)}r.manager.itemError(t),r.manager.itemEnd(t)}}),!1),o.addEventListener("progress",(function(e){const i=ls[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onProgress&&n.onProgress(e)}}),!1),o.addEventListener("error",(function(e){const i=ls[t];delete ls[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onError&&n.onError(e)}r.manager.itemError(t),r.manager.itemEnd(t)}),!1),o.addEventListener("abort",(function(e){const i=ls[t];delete ls[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onError&&n.onError(e)}r.manager.itemError(t),r.manager.itemEnd(t)}),!1),void 0!==this.responseType&&(o.responseType=this.responseType),void 0!==this.withCredentials&&(o.withCredentials=this.withCredentials),o.overrideMimeType&&o.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(const t in this.requestHeader)o.setRequestHeader(t,this.requestHeader[t]);o.send(null)}return r.manager.itemStart(t),o},setResponseType:function(t){return this.responseType=t,this},setMimeType:function(t){return this.mimeType=t,this}}),us.prototype=Object.assign(Object.create(ve.prototype),{constructor:us,isLight:!0,copy:function(t){return ve.prototype.copy.call(this,t),this.color.copy(t.color),this.intensity=t.intensity,this},toJSON:function(t){const e=ve.prototype.toJSON.call(this,t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,void 0!==this.groundColor&&(e.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(e.object.distance=this.distance),void 0!==this.angle&&(e.object.angle=this.angle),void 0!==this.decay&&(e.object.decay=this.decay),void 0!==this.penumbra&&(e.object.penumbra=this.penumbra),void 0!==this.shadow&&(e.object.shadow=this.shadow.toJSON()),e}}),ds.prototype=Object.assign(Object.create(us.prototype),{constructor:ds,isHemisphereLight:!0,copy:function(t){return us.prototype.copy.call(this,t),this.groundColor.copy(t.groundColor),this}}),Object.assign(ps.prototype,{_projScreenMatrix:new wt,_lightPositionWorld:new J,_lookTarget:new J,getViewportCount:function(){return this._viewportCount},getFrustum:function(){return this._frustum},updateMatrices:function(t){const e=this.camera,i=this.matrix,n=this._projScreenMatrix,r=this._lookTarget,s=this._lightPositionWorld;s.setFromMatrixPosition(t.matrixWorld),e.position.copy(s),r.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(r),e.updateMatrixWorld(),n.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromProjectionMatrix(n),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(e.projectionMatrix),i.multiply(e.matrixWorldInverse)},getViewport:function(t){return this._viewports[t]},getFrameExtents:function(){return this._frameExtents},copy:function(t){return this.camera=t.camera.clone(),this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){const t={};return 0!==this.bias&&(t.bias=this.bias),0!==this.normalBias&&(t.normalBias=this.normalBias),1!==this.radius&&(t.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}),fs.prototype=Object.assign(Object.create(Pi.prototype),{constructor:fs,isOrthographicCamera:!0,copy:function(t,e){return Pi.prototype.copy.call(this,t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this},setViewOffset:function(t,e,i,n,r,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2;let r=i-t,s=i+t,a=n+e,o=n-e;if(null!==this.view&&this.view.enabled){const t=(this.right-this.left)/this.view.fullWidth/this.zoom,e=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=t*this.view.offsetX,s=r+t*this.view.width,a-=e*this.view.offsetY,o=a-e*this.view.height}this.projectionMatrix.makeOrthographic(r,s,a,o,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()},toJSON:function(t){const e=ve.prototype.toJSON.call(this,t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}),ms.prototype=Object.assign(Object.create(ps.prototype),{constructor:ms,isDirectionalLightShadow:!0,updateMatrices:function(t){ps.prototype.updateMatrices.call(this,t)}}),gs.prototype=Object.assign(Object.create(us.prototype),{constructor:gs,isDirectionalLight:!0,copy:function(t){return us.prototype.copy.call(this,t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}),vs.prototype=Object.assign(Object.create(us.prototype),{constructor:vs,isAmbientLight:!0});const ys=new wt,xs=new wt;function _s(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new Ri,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new Ri,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}function Ms(){Te.call(this),this.type="InstancedBufferGeometry",this.instanceCount=1/0}function bs(t,e,i,n){"number"==typeof i&&(n=i,i=!1,console.error("THREE.InstancedBufferAttribute: The constructor now expects normalized as the third argument.")),Ht.call(this,t,e,i),this.meshPerAttribute=n||1}function ws(t,e){this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.usage=35044,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=z.generateUUID()}function Ss(t,e,i){ws.call(this,t,e),this.meshPerAttribute=i||1}Object.assign(_s.prototype,{update:function(t){const e=this._cache;if(e.focus!==t.focus||e.fov!==t.fov||e.aspect!==t.aspect*this.aspect||e.near!==t.near||e.far!==t.far||e.zoom!==t.zoom||e.eyeSep!==this.eyeSep){e.focus=t.focus,e.fov=t.fov,e.aspect=t.aspect*this.aspect,e.near=t.near,e.far=t.far,e.zoom=t.zoom,e.eyeSep=this.eyeSep;const i=t.projectionMatrix.clone(),n=e.eyeSep/2,r=n*e.near/e.focus,s=e.near*Math.tan(z.DEG2RAD*e.fov*.5)/e.zoom;let a,o;xs.elements[12]=-n,ys.elements[12]=n,a=-s*e.aspect+r,o=s*e.aspect+r,i.elements[0]=2*e.near/(o-a),i.elements[8]=(o+a)/(o-a),this.cameraL.projectionMatrix.copy(i),a=-s*e.aspect-r,o=s*e.aspect-r,i.elements[0]=2*e.near/(o-a),i.elements[8]=(o+a)/(o-a),this.cameraR.projectionMatrix.copy(i)}this.cameraL.matrixWorld.copy(t.matrixWorld).multiply(xs),this.cameraR.matrixWorld.copy(t.matrixWorld).multiply(ys)}}),Ms.prototype=Object.assign(Object.create(Te.prototype),{constructor:Ms,isInstancedBufferGeometry:!0,copy:function(t){return Te.prototype.copy.call(this,t),this.instanceCount=t.instanceCount,this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){const t=Te.prototype.toJSON.call(this);return t.instanceCount=this.instanceCount,t.isInstancedBufferGeometry=!0,t}}),bs.prototype=Object.assign(Object.create(Ht.prototype),{constructor:bs,isInstancedBufferAttribute:!0,copy:function(t){return Ht.prototype.copy.call(this,t),this.meshPerAttribute=t.meshPerAttribute,this},toJSON:function(){const t=Ht.prototype.toJSON.call(this);return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}),Object.defineProperty(ws.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(ws.prototype,{isInterleavedBuffer:!0,onUploadCallback:function(){},setUsage:function(t){return this.usage=t,this},copy:function(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.usage=t.usage,this},copyAt:function(t,e,i){t*=this.stride,i*=e.stride;for(let n=0,r=this.stride;n<r;n++)this.array[t+n]=e.array[i+n];return this},set:function(t,e=0){return this.array.set(t,e),this},clone:function(t){void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=z.generateUUID()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const e=new ws(new this.array.constructor(t.arrayBuffers[this.array.buffer._uuid]),this.stride);return e.setUsage(this.usage),e},onUpload:function(t){return this.onUploadCallback=t,this},toJSON:function(t){return void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=z.generateUUID()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=Array.prototype.slice.call(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}),Ss.prototype=Object.assign(Object.create(ws.prototype),{constructor:Ss,isInstancedInterleavedBuffer:!0,copy:function(t){return ws.prototype.copy.call(this,t),this.meshPerAttribute=t.meshPerAttribute,this},clone:function(t){const e=ws.prototype.clone.call(this,t);return e.meshPerAttribute=this.meshPerAttribute,e},toJSON:function(t){const e=ws.prototype.toJSON.call(this,t);return e.isInstancedInterleavedBuffer=!0,e.meshPerAttribute=this.meshPerAttribute,e}});const Es=new J;function Ts(t,e,i,n){this.name="",this.data=t,this.itemSize=e,this.offset=i,this.normalized=!0===n}function Ls(t,e,i,n){this.ray=new He(t,e),this.near=i||0,this.far=n||1/0,this.camera=null,this.layers=new ne,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function Cs(t,e){return t.distance-e.distance}function As(t,e,i,n){if(t.layers.test(e.layers)&&t.raycast(e,i),!0===n){const n=t.children;for(let t=0,r=n.length;t<r;t++)As(n[t],e,i,!0)}}Object.defineProperties(Ts.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}},needsUpdate:{set:function(t){this.data.needsUpdate=t}}}),Object.assign(Ts.prototype,{isInterleavedBufferAttribute:!0,applyMatrix4:function(t){for(let e=0,i=this.data.count;e<i;e++)Es.x=this.getX(e),Es.y=this.getY(e),Es.z=this.getZ(e),Es.applyMatrix4(t),this.setXYZ(e,Es.x,Es.y,Es.z);return this},setX:function(t,e){return this.data.array[t*this.data.stride+this.offset]=e,this},setY:function(t,e){return this.data.array[t*this.data.stride+this.offset+1]=e,this},setZ:function(t,e){return this.data.array[t*this.data.stride+this.offset+2]=e,this},setW:function(t,e){return this.data.array[t*this.data.stride+this.offset+3]=e,this},getX:function(t){return this.data.array[t*this.data.stride+this.offset]},getY:function(t){return this.data.array[t*this.data.stride+this.offset+1]},getZ:function(t){return this.data.array[t*this.data.stride+this.offset+2]},getW:function(t){return this.data.array[t*this.data.stride+this.offset+3]},setXY:function(t,e,i){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this},setXYZ:function(t,e,i,n){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this},setXYZW:function(t,e,i,n,r){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this.data.array[t+3]=r,this},clone:function(t){if(void 0===t){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interlaved buffer attribute will deinterleave buffer data.");const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return new Ht(new this.array.constructor(t),this.itemSize,this.normalized)}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new Ts(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)},toJSON:function(t){if(void 0===t){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interlaved buffer attribute will deinterleave buffer data.");const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:t,normalized:this.normalized}}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.toJSON(t)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}),Object.assign(Ls.prototype,{set:function(t,e){this.ray.set(t,e)},setFromCamera:function(t,e){e&&e.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(e).sub(this.ray.origin).normalize(),this.camera=e):e&&e.isOrthographicCamera?(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld),this.camera=e):console.error("THREE.Raycaster: Unsupported camera type: "+e.type)},intersectObject:function(t,e,i){const n=i||[];return As(t,this,n,e),n.sort(Cs),n},intersectObjects:function(t,e,i){const n=i||[];if(!1===Array.isArray(t))return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),n;for(let i=0,r=t.length;i<r;i++)As(t[i],this,n,e);return n.sort(Cs),n}});class Ps{constructor(t=1,e=0,i=0){return this.radius=t,this.phi=e,this.theta=i,this}set(t,e,i){return this.radius=t,this.phi=e,this.theta=i,this}clone(){return(new this.constructor).copy(this)}copy(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this}makeSafe(){const t=1e-6;return this.phi=Math.max(t,Math.min(Math.PI-t,this.phi)),this}setFromVector3(t){return this.setFromCartesianCoords(t.x,t.y,t.z)}setFromCartesianCoords(t,e,i){return this.radius=Math.sqrt(t*t+e*e+i*i),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(t,i),this.phi=Math.acos(z.clamp(e/this.radius,-1,1))),this}}const Rs=new k;class Ds{constructor(t,e){Object.defineProperty(this,"isBox2",{value:!0}),this.min=void 0!==t?t:new k(1/0,1/0),this.max=void 0!==e?e:new k(-1/0,-1/0)}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=Rs.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(t){return void 0===t&&(console.warn("THREE.Box2: .getCenter() target is now required"),t=new k),this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return void 0===t&&(console.warn("THREE.Box2: .getSize() target is now required"),t=new k),this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y}getParameter(t,e){return void 0===e&&(console.warn("THREE.Box2: .getParameter() target is now required"),e=new k),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)}clampPoint(t,e){return void 0===e&&(console.warn("THREE.Box2: .clampPoint() target is now required"),e=new k),e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return Rs.copy(t).clamp(this.min,this.max).sub(t).length()}intersect(t){return this.min.max(t.min),this.max.min(t.max),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const Ns=new J,Is=new J;class Os{constructor(t,e){this.start=void 0!==t?t:new J,this.end=void 0!==e?e:new J}set(t,e){return this.start.copy(t),this.end.copy(e),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.start.copy(t.start),this.end.copy(t.end),this}getCenter(t){return void 0===t&&(console.warn("THREE.Line3: .getCenter() target is now required"),t=new J),t.addVectors(this.start,this.end).multiplyScalar(.5)}delta(t){return void 0===t&&(console.warn("THREE.Line3: .delta() target is now required"),t=new J),t.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,e){return void 0===e&&(console.warn("THREE.Line3: .at() target is now required"),e=new J),this.delta(e).multiplyScalar(t).add(this.start)}closestPointToPointParameter(t,e){Ns.subVectors(t,this.start),Is.subVectors(this.end,this.start);const i=Is.dot(Is);let n=Is.dot(Ns)/i;return e&&(n=z.clamp(n,0,1)),n}closestPointToPoint(t,e,i){const n=this.closestPointToPointParameter(t,e);return void 0===i&&(console.warn("THREE.Line3: .closestPointToPoint() target is now required"),i=new J),this.delta(i).multiplyScalar(n).add(this.start)}applyMatrix4(t){return this.start.applyMatrix4(t),this.end.applyMatrix4(t),this}equals(t){return t.start.equals(this.start)&&t.end.equals(this.end)}}z.generateUUID=function(){return null},ve.DefaultUp.set(0,0,1),ve.prototype.addStatic=function(t){t.matrixAutoUpdate=!1,t.updateMatrix(),this.add(t)};const Fs={index:new qt([0,2,1,0,3,2],1),position:new Qt([0,0,0,0,1,0,1,1,0,1,0,0],3)};function Us(){this.array=null}function zs(t){this.material=t,this.cache={}}const ks=new J,Bs=new J,Gs=new J,Hs=new J,Vs=new J,Ws=new $e,js=new $e;function Xs(t,e){Ms.call(this),this.type="GlyphStringGeometry",this.width=0,this.setIndex(Fs.index),this.setAttribute("position",Fs.position);const i=t.length;this.glyphAtlas=e,this.setAttribute("instanceUvs",new bs(new Float32Array(2*i),2,!1,1)),this.setAttribute("instanceOffsets",new bs(new Float32Array(i),1,!1,1)),this.setAttribute("instanceWidths",new bs(new Float32Array(i),1,!1,1)),this.setString(t),this.computeBoundingSphere()}function qs(t,e,i){var n;if(this.isMutableGlyphString)n=new Xs(t,e.getAtlas());else{const r=i.glyphStringCache;let s=r.get(e);void 0===s&&(s=new zs(e),r.set(e,s)),n=s.getGeometry(t)}xi.call(this,n,e),this.name=t,this.isMutableGlyphString||(n.getAttribute("instanceUvs").onUpload(Us),n.getAttribute("instanceOffsets").onUpload(Us),n.getAttribute("instanceWidths").onUpload(Us))}function Ys(t,e){qs.call(this,t,e)}zs.prototype.getGeometry=function(t){var e=this.cache[t];return void 0===e&&(e=new Xs(t,this.material.getAtlas()),this.cache[t]=e,e.isCached=!0),e},Xs.prototype=Object.create(Ms.prototype),Xs.prototype.setString=function(t){const e=this.getAttribute("instanceUvs"),i=this.getAttribute("instanceOffsets"),n=this.getAttribute("instanceWidths"),r=t.length,s=this.glyphAtlas;var a,o=0;for(a=0;a<r;a++){if(0===t.charCodeAt(a))continue;const r=s.getGlyph(t[a]);e.setXY(a,r.column,r.row),n.setX(a,r.width),i.setX(a,o),o+=r.width}e.needsUpdate=!0,i.needsUpdate=!0,n.needsUpdate=!0,this.width=o,this.name=t,this.instanceCount=r},Xs.prototype.dispose=function(){this.isCached||(this.deleteAttribute("position"),this.setIndex(null),Ms.prototype.dispose.call(this))},qs.prototype=Object.create(xi.prototype),qs.prototype.isGlyphString=!0,qs.prototype.getWidth=function(){return this.geometry.width*this.material.scaleFactor},qs.prototype.getHeight=function(){return this.material.scaleFactor},qs.prototype.intersects=function(t,e,i){if(!this.visible)return!1;const n=this.getWidth()/i.x,r=this.getHeight()/i.y,s=this.material.rotation;return ks.set(t.x,t.y,0),Bs.setFromMatrixPosition(this.modelViewMatrix),Bs.applyMatrix4(e.projectionMatrix),this.depth=Bs.z,Bs.z=0,isNaN(Bs.x)?void 0:(Gs.set(n,0,0).applyAxisAngle(ve.DefaultUp,s),Hs.set(n,r,0).applyAxisAngle(ve.DefaultUp,s),Vs.set(0,r,0).applyAxisAngle(ve.DefaultUp,s),Gs.y*=i.x/i.y,Hs.y*=i.x/i.y,Vs.y*=i.x/i.y,Gs.add(Bs),Hs.add(Bs),Vs.add(Bs),Ws.set(Bs,Gs,Hs),js.set(Bs,Hs,Vs),Ws.containsPoint(ks)||js.containsPoint(ks))},Ys.prototype=Object.create(qs.prototype),Ys.prototype.isMutableGlyphString=!0,Ys.prototype.replaceString=function(t){t.length===this.name.length?this.geometry.setString(t):console.warn("new string has invalid length",t,this.name.length,t.length)};const Zs=new J(1,0,0);function Js(t){const e=t.stdWidth,i=t.stdMargin,n=t.ctx.cfg,r=t.ctx.materials,s=n.themeColor("hud.ahi.sky"),a=n.themeColor("hud.ahi.earth");Cr.call(this),this.name="CV.AHI",this.lastPitch=0;const o=new Cr,h=t.getCommonRing(),l=.75*e,c=new $r(l,31,31),u=new Te,d=new Te,p=c.getAttribute("position").count;t.dropBuffers(c);const f=new Qt(new Float32Array(3*p),3);var m;for(m=0;m<p;m++)(m<p/2?s:a).toArray(f.array,3*m);c.setAttribute("color",f);var g=[];g.push(4-e,0,l),g.push(e-4,0,l);const v=new Qt(g.length,3);u.setAttribute("position",v.copyArray(g));const y=e/10,x=new J(y,0,l+1),_=new J(-y,0,l+1);for(g=[],m=0;m<12;m++){const t=x.clone(),e=_.clone();m%3==0&&(t.x*=2,e.x*=2),t.applyAxisAngle(Zs,m*Math.PI/6),e.applyAxisAngle(Zs,m*Math.PI/6),g.push(t),g.push(e)}const M=new Qt(3*g.length,3);d.setAttribute("position",M.copyVector3sArray(g));const b=new xi(h,r.getBezelMaterial()),w=new xi(c,new ns({vertexColors:!0,specular:6710886,shininess:20})),S=new Wr(u,new Or({color:n.themeValue("hud.ahi.bar")})),E=new Wr(d,new Or({color:n.themeValue("hud.ahi.marks")}));w.rotateOnAxis(new J(0,1,0),Math.PI/2),E.rotateOnAxis(new J(1,0,0),Math.PI/2),b.rotateOnAxis(new J(0,0,1),Math.PI/8),o.addStatic(w),o.addStatic(E),this.addStatic(b),this.addStatic(S),this.add(o);const T=e+i;this.translateX(-3*T),this.translateY(T),this.globe=o;const L=new Ys("-90",r.getGlyphMaterial(t.atlasSpec,0));return L.translateX(-L.getWidth()/2),L.translateY(e+5),this.addStatic(L),this.label=L,this}function Qs(t,e){const i=e.container,n=e.getControls(),r=t.createHitRegion(2*t.stdWidth,2*t.stdWidth,(function(n){if(!e.HUD)return;const s=n.currentTarget;s.addEventListener("mouseleave",l),s.addEventListener("mousemove",p),s.addEventListener("mousedown",c),s.addEventListener("mouseup",u),s.addEventListener("dblclick",d);const o=i.getBoundingClientRect();a=o.top+r.offsetTop+t.stdWidth,r.style.cursor="pointer"})),s=t.stdWidth-10;var a,o,h=!1;function l(t){const e=t.currentTarget;h&&n.end(),e.removeEventListener("mouseleave",l),e.removeEventListener("mousemove",p),e.removeEventListener("mousedown",c),e.removeEventListener("mouseup",u),e.removeEventListener("dblclick",d),r.style.cursor="default",h=!1}function c(t){t.stopPropagation(),h=!0,o=Math.atan((t.clientY-a)/s)}function u(t){t.stopPropagation(),n.end(),h=!1}function d(t){t.stopPropagation(),e.polarAngle<1e-4?e.polarAngle=Math.PI/2:e.polarAngle=0}function p(t){if(t.stopPropagation(),t.preventDefault(),!h)return;const e=Math.atan((t.clientY-a)/s);n.rotateUp(o-e),o=e}r.style.right=3*t.stdMargin+2*t.stdWidth+"px",r.style.bottom=t.stdMargin+"px",i.appendChild(r),this.dispose=function(){i.removeChild(r)}}function Ks(t,e){const i=t.stdWidth,n=t.stdMargin,r=t.ctx.materials,s=new J(1,0,0),a=new ts(1,40,36,1,Math.PI,Math.PI),o=r.colourCache.getColors("inclination"),h=[],l=a.getAttribute("position"),c=l.count,u=new Qt(3*c,3),d=new J;var p;for(p=0;p<c;p++){d.fromBufferAttribute(l,p).normalize();const t=Math.floor(254*Math.asin(Math.abs(d.dot(s)))/Math.PI);h.push(o[t])}a.setAttribute("color",u.copyColorsArray(h)),t.dropBuffers(a),xi.call(this,a,new ei({color:16777215,vertexColors:!0})),this.translateY(3*(i+n)+n+30),this.translateX(-45),this.name="CV.AngleScale";const f=new qs(e,r.getGlyphMaterial(t.atlasSpec,0),t.ctx);return f.translateX(-f.getWidth()/2),f.translateY(5),this.addStatic(f),this.visible=!1,this}function $s(t){const e=t.stdWidth,i=t.stdMargin,n=t.ctx.cfg,r=t.ctx.materials;Cr.call(this),this.name="CV.Compass";const s=new xi(t.getCommonRing(),r.getBezelMaterial()),a=new ts(.9*e,e,4,1,-Math.PI/32+Math.PI/2,Math.PI/16);a.translate(0,0,5),t.dropBuffers(a);const o=new xi(a,new ei({color:n.themeValue("hud.compass.top1")})),h=function(){const t=new Te,i=new is({vertexColors:!0,flatShading:!0}),r=new xi(t,i),s=[],a=[];l(n.themeColor("hud.compass.bottom1"),n.themeColor("hud.compass.bottom2"),Math.PI/4),l(n.themeColor("hud.compass.top1"),n.themeColor("hud.compass.top2"),0);const o=new Qt(s.length,3),h=new Qt(3*s.length,3);return t.setAttribute("position",o.copyArray(s)),t.setAttribute("color",h.copyColorsArray(a)),t.computeVertexNormals(),r;function l(t,i,n){const r=.9*e,o=.2*r;var h;const l=Math.PI/4,c=Math.PI/2;for(h=0;h<4;h++){const e=h*Math.PI/2+n;s.push(Math.sin(e)*r,Math.cos(e)*r,0),s.push(0,0,2),s.push(Math.sin(e+l)*o,Math.cos(e+l)*o,0),a.push(t,t,t),s.push(Math.sin(e+l)*o,Math.cos(e+l)*o,0),s.push(0,0,2),s.push(Math.sin(e+c)*r,Math.cos(e+c)*r,0),a.push(i,i,i)}}}(),l=new Cr;l.addStatic(s),l.addStatic(o),l.addStatic(h),this.add(l),this.rotaryGroup=l;const c=e+i;this.translateX(-c),this.translateY(c),this.lastRotation=0;const u=new Ys("000",r.getGlyphMaterial(t.atlasSpec,0));return u.translateX(-u.getWidth()/2),u.translateY(e+5),this.addStatic(u),this.label=u,this}function ta(t,e){const i=e.container,n=e.getControls(),r=new k,s=new k;var a=!1,o=0;const h=t.createHitRegion(2*t.stdWidth,2*t.stdWidth,(function(n){if(!e.HUD)return;const r=n.currentTarget;r.addEventListener("mouseleave",l),r.addEventListener("mousemove",p),r.addEventListener("mousedown",c),r.addEventListener("mouseup",u),r.addEventListener("dblclick",d);const a=i.getBoundingClientRect();s.set(a.left+h.offsetLeft+t.stdWidth,a.top+h.offsetTop+t.stdWidth),h.style.cursor="pointer"}));function l(t){const e=t.currentTarget;a&&n.end(),e.removeEventListener("mouseleave",l),e.removeEventListener("mousemove",p),e.removeEventListener("mousedown",c),e.removeEventListener("mouseup",u),e.removeEventListener("dblclick",d),h.style.cursor="default",a=!1}function c(t){t.stopPropagation(),a=!0,r.set(t.clientX,t.clientY).sub(s),o=r.angle()}function u(t){t.stopPropagation(),n.end(),a=!1}function d(t){t.stopPropagation(),r.x>r.y?r.x<-r.y?e.azimuthAngle=0:e.azimuthAngle=Math.PI/2:r.x>-r.y?e.azimuthAngle=Math.PI:e.azimuthAngle=3*Math.PI/2}function p(t){if(t.stopPropagation(),t.preventDefault(),!a)return;r.set(t.clientX,t.clientY).sub(s);const e=r.angle();n.rotateLeft(o-e),o=e}h.style.right=t.stdMargin+"px",h.style.bottom=t.stdMargin+"px",i.appendChild(h),this.dispose=function(){i.removeChild(h)}}function ea(t,e,i,n){const r=t.ctx.materials,s=e.clientWidth,a=e.clientHeight,o=t.stdWidth,h=t.stdMargin,l=3*(o+h),c=(a-l)/2,u=o/2;this.ctx=t.ctx,this.barHeight=c,this.barWidth=u,this.barOffset=l,this.offsetX=-u/2-5,this.offsetY=c/2,Cr.call(this),this.translateX(s/2-u/2-h),this.translateY(-a/2+c/2+l),this.scaleBar=new xi(i,n),this.scaleBar.name="scale bar",this.textMaterial=r.getGlyphMaterial(t.atlasSpec,0),this.add(this.scaleBar),this.min=null,this.max=null,this.caption=null}function ia(t,e){const i=t.ctx.cfg,n=t.ctx.materials,r=new Ce;ea.call(this,t,e,r,new ei({color:6776679})),this.name="CV.CursorScale";const s=this.barWidth,a=this.barHeight;r.scale(s,a,1);const o=new Te,h=new Qt([s/2,-a/2,10,-s/2,-a/2,10],3);o.setAttribute("position",h);const l=new Gr(o,new Or({color:i.themeColor("hud.cursor")})),c={color:i.themeColorCSS("hud.cursor"),background:"#444444",font:"bold helvetica,sans-serif"},u=new Ys("      ",n.getGlyphMaterial(c,0));return u.translateY(-a/2-u.getHeight()/2),this.addStatic(l),l.addStatic(u),this.cursor=l,this.cursorLabel=u,this}function na(t,e,i){const n=e.container,r=t.createHitRegion(i.barWidth,i.barHeight,(function(t){if(!e.HUD)return;if(4!==e.shadingMode&&e.shadingMode!==s)return;const i=t.currentTarget;i.addEventListener("mouseleave",l),i.addEventListener("mousemove",d),i.addEventListener("mousedown",c),i.addEventListener("mouseup",u);const o=n.getBoundingClientRect();a=o.top+r.offsetTop,r.style.cursor="pointer"}));var a,o=!1;function h(t){const n=(i.barHeight-t+a)/i.barHeight,r=e.maxHeight-e.minHeight;e.shadingMode===s?e.cursorHeight=r-r*n:e.cursorHeight=r*n-r/2}function l(t){const e=t.currentTarget;e.removeEventListener("mouseleave",l),e.removeEventListener("mousemove",d),e.removeEventListener("mousedown",c),e.removeEventListener("mouseup",u),r.style.cursor="default",o=!1}function c(t){t.stopPropagation(),h(t.clientY),o=!0}function u(t){t.stopPropagation(),o=!1}function d(t){t.stopPropagation(),t.preventDefault(),o&&h(t.clientY)}r.style.right=t.stdMargin+"px",r.style.bottom=i.barOffset+"px",n.appendChild(r),this.hr=r}function ra(t,e){const i=t.ctx.materials,n=new Ce,r=i.getScaleMaterial();return ea.call(this,t,e,n,r),this.name="CV.LinearScale",n.rotateZ(-Math.PI/2),n.scale(this.barWidth,this.barHeight,1),this}function sa(t,e,i,n){const r=t.ctx.cfg,s=t.ctx.materials,a=t.stdWidth,o=a+t.stdMargin,h=new ts(a*(.9-.1*i),a*(1-.1*i)-(0===i?0:1),50),l=new Qt(306,3);if(h.setAttribute("color",l),t.dropBuffers(h),this.backgroundColor=r.themeColor("hud.progressBackground"),this.setColor=r.themeColor("hud.progress"),this.viewer=n,xi.call(this,h,s.getPlainMaterial()),this.name="CV.ProgressDial",this.translateX(5*-o),this.translateY(o),this.rotateOnAxis(ve.DefaultUp,Math.PI/2),this.visible=!1,this.isVisible=!0,this.colorRange(0),e){const e=new Ys("----",s.getGlyphMaterial(t.atlasSpec,0));e.translateY(e.getWidth()/2),e.translateX(-10),this.add(e),this.pcent=e}else this.pcent=null;return this}function aa(t,e,i,n){Te.call(this);const r=t.cfg,s=r.themeColor("hud.scale.bar1"),a=r.themeColor("hud.scale.bar2"),o=[],h=[];c(10*n,0),c(n,i+1);const l=new Qt(3*h.length,3);function c(t,n){const r=e/t;var l;for(l=0;l<t;l++){const t=l*r,e=t+r,c=n,u=c+i;o.push(t,c,0,e,u,0,t,u,0,e,u,0,t,c,0,e,c,0);const d=l%2?s:a;h.push(d,d,d,d,d,d)}}this.setAttribute("position",new Qt(o,3)),this.setAttribute("color",l.copyColorsArray(h))}function oa(t,e,i,n){const r=t.ctx.materials;Cr.call(this),this.name="CV.ScaleBar",this.hScale=i,this.scaleBars=[],this.currentLength=0,this.wScale=e.clientHeight/e.clientWidth,this.hudObject=t,this.position.set(-e.clientWidth/2+45,-e.clientHeight/2+10,0),this.scaleMax=e.clientWidth-(50+n);const s=new Ys("--------",r.getGlyphMaterial(t.atlasSpec,0));return s.translateX(0),s.translateY(10),this.add(s),this.label=s,this}function ha(){this.array=null}function la(t){const e=t.cfg;this.stdWidth=e.themeValue("hud.widgetSize"),this.atlasSpec={color:e.themeColorCSS("hud.text"),font:e.themeValue("hud.font")},this.commonRing=null,this.ctx=t}function ca(t,e){const i=this,n=t.ctx.cfg,r=t.container,o=r.clientHeight/2,h=r.clientWidth/2;var l,c,u,d,p=0,f=null,m=null,g=null,v=null,y=!0,x=!1;const _=new fs(-h,h,o,-o,1,1e3);_.position.z=600;const M=new Ir;M.name="HUD";const b=new Cr;b.position.set(h,-o,0),M.addStatic(b);var w=new la(t.ctx);const S=new vs(8947848),E=new gs(16777215);E.position.set(-1,1,1),M.addStatic(S),M.addStatic(E);const T=[new sa(w,!0,0,t),new sa(w,!1,1,t)],L=T[0];D(),b.addStatic(T[0]),b.addStatic(T[1]),t.addEventListener("newCave",R),t.addEventListener("change",I),t.addEventListener("resized",(function(){const e=t.container,i=e.clientWidth/2,n=e.clientHeight/2;_.left=-i,_.right=i,_.top=n,_.bottom=-n,_.updateProjectionMatrix(),b.position.set(i,-n,0),b.updateMatrix(),N()})),n.addEventListener("change",(function(){x&&R()})),n.addEventListener("colors",(function(){w=new la(t.ctx),D(),R()})),d=t.getControls();const C=new ta(w,t),A=new Qs(w,t);function P(t){const e=n.i18n("hud."+t);return void 0===e?t:e}function R(){x=!0,N(),I({type:"change",name:"shadingMode"})}function D(){l&&b.remove(l),c&&b.remove(c),u&&b.remove(u),l=new Js(w),c=new $s(w),u=new Ks(w,P("inclination")),b.addStatic(l),b.addStatic(c),b.addStatic(u)}function N(){const e=t.container,n=t.minHeight!==1/0&&t.maxHeight!==-1/0;f&&(f.dispose(),M.remove(f)),n&&(f=new ra(w,e),M.addStatic(f)),m&&(m.dispose(),M.remove(m)),n&&(m=new ia(w,e),v&&v.dispose(),v=new na(w,t,m),M.addStatic(m)),g&&(M.remove(g),g=null),F(d.object),i.setVisibility(y)}function I(e){if("shadingMode"===e.name&&y&&x){var i=!1,n=!1,r=!1;switch(t.shadingMode){case 1:n=!0,f.setRange(t.minHeight,t.maxHeight,P("height"));break;case 9:n=!0,f.setRange(t.maxHeight-t.minHeight,0,P("depth"));break;case a:n=!0,f.setRange(0,t.maxDistance,P("distance"));break;case 4:r=!0,m.setRange(t.minHeight,t.maxHeight,P("height")),O();break;case s:r=!0,m.setRange(t.maxHeight-t.minHeight,0,P("depth")),O();break;case 2:n=!0,f.setRange(t.minLegLength,t.maxLegLength,P("leg_length"));break;case 3:i=!0}u.visible=i,f.visible=n,m.visible=r,r?t.addEventListener("cursorChange",O):t.removeEventListener("cursorChange",O),t.renderView()}}function O(){const e=t.cursorHeight,i=t.maxHeight-t.minHeight;var n=0,r=0;4===t.shadingMode?(n=(t.cursorHeight+i/2)/i,r=e+i/2+t.minHeight):(n=1-e/i,r=e),n=Math.max(Math.min(n,1),0),m.setCursor(n,Math.round(r))}function F(e){e instanceof fs?(null===g&&(g=new oa(w,t.container,p,4*(w.stdWidth+w.stdMargin)),M.addStatic(g)),g.visible=y,g.setScale(e.zoom)):null!==g&&g.visible&&(g.visible=!1)}this.setVisibility=function(e){c.visible=e,l.visible=e,L.setVisibility(e),g&&(g.visible=e),y=e,f&&(e?I({type:"change",name:"shadingMode"}):(f.visible=!1,m.visible=!1,u.visible=!1)),t.renderView()},this.getVisibility=function(){return y},this.getProgressDial=function(t){return T[t]},this.setScale=function(t){p=t},this.renderHUD=function(){const t=d.cameraManager.activeCamera;c.set(t),l.set(t),F(t),e.clearDepth(),e.render(M,_)},this.dispose=function(){A.dispose(),C.dispose(),v&&v.dispose()}}Js.prototype=Object.create(Cr.prototype),Js.prototype.set=function(){const t=new J;return function(e){e.getWorldDirection(t);const i=Math.PI/2-t.angleTo(ve.DefaultUp);i!==this.lastPitch&&(this.globe.rotateOnAxis(Zs,i-this.lastPitch),this.lastPitch=i,this.label.replaceString(String(Math.round(z.radToDeg(i))+"").padStart(4," ")))}}(),Ks.prototype=Object.create(xi.prototype),$s.prototype=Object.create(Cr.prototype),$s.prototype.set=function(){const t=new J,e=new J(0,0,-1),i=new te;return function(n){var r;if(n.getWorldDirection(t),Math.abs(t.z)<.999?r=Math.atan2(-t.x,t.y):(i.setFromQuaternion(n.quaternion),r=i.z),r===this.lastRotation)return;r<0&&(r=2*Math.PI+r);var s=Math.round(z.radToDeg(r));360===s&&(s=0);const a=s.toString().padStart(3,"0")+"";this.label.replaceString(a),this.rotaryGroup.rotateOnAxis(e,r-this.lastRotation),this.lastRotation=r}}(),ea.prototype=Object.create(Cr.prototype),ea.prototype.setRange=function(t,e,i){const n=this.offsetX,r=this.offsetY,s=this.textMaterial;if(t!==this.min||e!==this.max){var a;for(a=this.children.length;a--;){const t=this.children[a];t.isRange&&this.remove(t)}const i=new qs(Math.round(e)+"m",s,this.ctx),o=new qs(Math.round(t)+"m",s,this.ctx);i.translateX(n-i.getWidth()),o.translateX(n-o.getWidth()),i.translateY(r-i.getHeight()),o.translateY(-r),i.isRange=!0,o.isRange=!0,this.addStatic(i),this.addStatic(o),this.min=t,this.max=e}return this.setCaption(i),this},ea.prototype.setCaption=function(t){var e=this.caption;if(null!==e){if(e.name===t)return this;this.remove(e)}return(e=new qs(t,this.textMaterial,this.ctx)).translateX(this.barWidth/2-e.getWidth()),e.translateY(this.offsetY+this.barWidth/2),this.addStatic(e),this.caption=e,this},ea.prototype.dispose=function(){this.traverse((function(t){const e=t.geometry;void 0!==e&&e.dispose()}))},ia.prototype=Object.create(ea.prototype),ia.prototype.setCursor=function(t,e){const i=this.cursor,n=this.cursorLabel;return i.position.setY(this.barHeight*t),i.updateMatrix(),n.replaceString(String(e+"m").padStart(6," ")),n.position.setX(this.offsetX-n.getWidth()),n.updateMatrix(),this},na.prototype.dispose=function(){const t=this.hr;t.parentNode.removeChild(t)},ra.prototype=Object.create(ea.prototype),sa.prototype=Object.create(xi.prototype),sa.prototype.colorRange=function(t){const e=this.geometry.getAttribute("color"),i=50-Math.round(t/2),n=e.count,r=this.setColor,s=this.backgroundColor;var a;for(a=n/2;a>=0;a--){const t=a>i?r:s;t.toArray(e.array,3*a),t.toArray(e.array,3*(a+51))}e.needsUpdate=!0},sa.prototype.set=function(t){if(t===this.progress)return;this.progress=t;const e=2*Math.floor(Math.min(100,Math.round(t))/2),i=this.pcent;if(this.colorRange(e),null!==i){var n=Math.round(t)+"%";i.replaceString(n.padStart(4," ")),i.translateY(i.getWidth()/2-i.position.y)}this.viewer.renderView()},sa.prototype.start=function(){this.colorRange(0),this.progress=0,this.visible=!0,null!==this.pcent&&this.pcent.replaceString("  0%"),this.viewer.renderView()},sa.prototype.end=function(){const t=this;setTimeout((function(){t.visible=!1,t.viewer.renderView()}),500)},sa.prototype.setVisibility=function(t){this.isVisible=t,this.visible=this.visible&&t},sa.prototype.watch=function(t){t.addEventListener("progress",this.handleProgess.bind(this))},sa.prototype.handleProgess=function(t){switch(t.name){case"start":this.start();break;case"set":this.set(t.progress);break;case"end":this.end()}},aa.prototype=Object.create(Te.prototype),oa.prototype=Object.create(Cr.prototype),oa.prototype.setScale=function(t){const e=this.scaleBars,i=this,n=this.hudObject.ctx,r=this.scaleMax/(t*this.hScale);var s=Math.ceil(Math.log(r)/Math.LN10)-1;const a=r/Math.pow(10,s);var o,h=0;if(a<2?(h=10,s-=1):h=a<5?2:5,o=s>=3?h*Math.pow(10,s-3)+"km":h*Math.pow(10,s)+"m",t*=Math.pow(10,s),this.currentLength!==h){if(!e[h]){const t=function(t){const e=new aa(n,t*i.hScale,4,t);return e.computeBoundingBox(),{mesh:new xi(e,n.materials.getPlainMaterial()),topRight:e.boundingBox.max.x}}(h);e[h]=t,this.add(t.mesh)}this.currentLength>0&&(e[this.currentLength].mesh.visible=!1),e[h].mesh.visible=this.visible,this.currentLength=h}e[h].mesh.scale.x=t;const l=this.label;l.replaceString(o.padStart(8," "));const c=l.getWidth();return l.translateX(t*e[h].topRight-l.position.x-c),this},Object.assign(la.prototype,{stdMargin:5,createHitRegion:function(t,e,i){const n=document.createElement("div");return n.style.width=t+"px",n.style.height=e+"px",n.style.position="absolute",n.setAttribute("draggable","false"),n.addEventListener("dragstart",(function(t){t.preventDefault()})),n.addEventListener("mouseenter",i),n},dropBuffers:function(t){t.getAttribute("position").onUpload(ha),t.getAttribute("normal").onUpload(ha),t.getAttribute("uv").onUpload(ha),null!==t.index&&t.index.onUpload(ha)},getCommonRing:function(){var t=this.commonRing;return null===t&&((t=new es(.9*this.stdWidth,this.stdWidth,3,32,1,!0)).rotateX(Math.PI/2),this.dropBuffers(t),this.commonRing=t),t}});const ua={anaglyphVertexShader:"varying vec2 vUv;\nvoid main() {\n\tvUv = vec2( uv.x, uv.y );\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",anaglyphFragmentShader:"uniform sampler2D mapLeft;\nuniform sampler2D mapRight;\nvarying vec2 vUv;\nuniform mat3 colorMatrixLeft;\nuniform mat3 colorMatrixRight;\nfloat lin( float c ) {\n\treturn c <= 0.04045 ? c * 0.0773993808 : pow( c * 0.9478672986 + 0.0521327014, 2.4 );\n}\nvec4 lin( vec4 c ) {\n\treturn vec4( lin( c.r ), lin( c.g ), lin( c.b ), c.a );\n}\nfloat dev( float c ) {\n\treturn c <= 0.0031308 ? c * 12.92 : pow( c, 0.41666 ) * 1.055 - 0.055;\n}\nvoid main() {\n\tvec2 uv = vUv;\n\tvec4 colorL = lin( texture2D( mapLeft, uv ) );\n\tvec4 colorR = lin( texture2D( mapRight, uv ) );\n\tvec3 color = clamp(\n\t\t\tcolorMatrixLeft * colorL.rgb +\n\t\t\tcolorMatrixRight * colorR.rgb, 0., 1.\n\t);\n\tgl_FragColor = vec4(\n\t\t\tdev( color.r ), dev( color.g ), dev( color.b ),\n\t\t\tmax( colorL.a, colorR.a )\n\t);\n}",cursorVertexShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform vec3 uLight;\nvarying vec3 vColor;\nvarying float height;\nvarying float fogDepth;\nvoid main() {\n#ifdef SURFACE\n\tvec3 sNormal = normalMatrix * normal;\n\tfloat dotNL = dot( normalize( sNormal ), uLight );\n\tvColor = saturate( dotNL ) * color + vec3( 0.3, 0.3, 0.3 );\n#else\n\tvColor = color;\n#endif\n\theight = position.z;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tfogDepth = -mvPosition.z;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",cursorFragmentShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n#define LOG2 1.442695\nuniform float cursor;\nuniform float cursorWidth;\nuniform vec3 baseColor;\nuniform vec3 cursorColor;\nuniform vec3 fogColor;\nuniform int fogEnabled;\nuniform float fogDensity;\nvarying float height;\nvarying vec3 vColor;\nvarying float fogDepth;\nvoid main() {\n\tfloat delta = abs( height - cursor );\n\tfloat ss = smoothstep( 0.0, cursorWidth, cursorWidth - delta );\n\tif ( delta < cursorWidth * 0.05 ) {\n\t\tgl_FragColor = vec4( vColor, 1.0 );\n\t} else {\n\t\tgl_FragColor = vec4( mix( baseColor, cursorColor, ss ), 1.0 ) * vec4( vColor, 1.0 );\n\t}\n\tif ( fogEnabled != 0 ) {\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n\t}\n}",depthMapVertexShader:"uniform float minZ;\nuniform float scaleZ;\nvarying float vHeight;\nvoid main() {\n\tvHeight = ( position.z - minZ ) * scaleZ;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",depthMapFragmentShader:"const float PackUpscale = 256. / 255.;const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packFloatToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\n\treturn r * PackUpscale;\n}\nvarying float vHeight;\nvoid main() {\n\tgl_FragColor = packFloatToRGBA( vHeight );\n}",depthVertexShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\nconst float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nfloat unpackRGBAToFloat( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nuniform vec3 modelMin;\nuniform float scaleX;\nuniform float scaleY;\nuniform float rangeZ;\nuniform float depthScale;\nuniform sampler2D depthMap;\nuniform float datumShift;\nuniform vec3 uLight;\nvarying vec3 vColor;\nvarying float vDepth;\nvarying float fogDepth;\nvoid main() {\n#ifdef SURFACE\n\tvec3 sNormal = normalMatrix * normal;\n\tfloat dotNL = dot( normalize( sNormal ), uLight );\n\tvColor = saturate( dotNL ) * color + vec3( 0.3, 0.3, 0.3 );\n#else\n\tvColor = color;\n#endif\n\tvec2 terrainCoords = vec2( ( position.x - modelMin.x ) * scaleX, ( position.y - modelMin.y ) * scaleY );\n\tfloat terrainHeight = unpackRGBAToFloat( texture2D( depthMap, terrainCoords ) );\n\tterrainHeight = terrainHeight * rangeZ + modelMin.z + datumShift;\n\tvDepth = ( terrainHeight - position.z ) * depthScale;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tfogDepth = -mvPosition.z;\n\tgl_Position = projectionMatrix * mvPosition;\n}",depthFragmentShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n#define LOG2 1.442695\nuniform sampler2D cmap;\nuniform vec3 fogColor;\nuniform int fogEnabled;\nuniform float fogDensity;\nvarying float vDepth;\nvarying vec3 vColor;\nvarying float fogDepth;\nvoid main() {\n\tgl_FragColor = texture2D( cmap, vec2( vDepth, 1.0 ) ) * vec4( vColor, 1.0 );\n\tif ( fogEnabled != 0 ) {\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n\t}\n}",depthCursorVertexShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\nconst float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nfloat unpackRGBAToFloat( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nuniform vec3 modelMin;\nuniform float scaleX;\nuniform float scaleY;\nuniform float rangeZ;\nuniform sampler2D depthMap;\nuniform float datumShift;\nuniform vec3 uLight;\nvarying vec3 vColor;\nvarying float vDepth;\nvarying float fogDepth;\nvoid main() {\n#ifdef SURFACE\n\tvec3 sNormal = normalMatrix * normal;\n\tfloat dotNL = dot( normalize( sNormal ), uLight );\n\tvColor = saturate( dotNL ) * color + vec3( 0.3, 0.3, 0.3 );\n#else\n\tvColor = color;\n#endif\n\tvec2 terrainCoords = vec2( ( position.x - modelMin.x ) * scaleX, ( position.y - modelMin.y ) * scaleY );\n\tfloat terrainHeight = unpackRGBAToFloat( texture2D( depthMap, terrainCoords ) );\n\tvDepth = terrainHeight * rangeZ + datumShift + modelMin.z - position.z;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tfogDepth = -mvPosition.z;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",depthCursorFragmentShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n#define LOG2 1.442695\nuniform float cursor;\nuniform float cursorWidth;\nuniform vec3 baseColor;\nuniform vec3 cursorColor;\nuniform vec3 fogColor;\nuniform int fogEnabled;\nuniform float fogDensity;\nvarying float vDepth;\nvarying vec3 vColor;\nvarying float fogDepth;\nvoid main() {\n\tfloat delta = abs( vDepth - cursor );\n\tfloat ss = smoothstep( 0.0, cursorWidth, cursorWidth - delta );\n\tif ( delta < cursorWidth * 0.05 ) {\n\t\tgl_FragColor = vec4( vColor, 1.0 );\n\t} else {\n\t\tgl_FragColor = vec4( mix( baseColor, cursorColor, ss ), 1.0 ) * vec4( vColor, 1.0 );\n\t}\n\tif ( fogEnabled != 0 ) {\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n\t}\n}",glyphVertexShader:"\nuniform float cellScale;\nuniform vec2 scale;\nuniform mat2 rotate;\nattribute vec2 instanceUvs;\nattribute float instanceOffsets;\nattribute float instanceWidths;\nvarying vec2 vUv;\nvarying float fogDepth;\nvoid main() {\n\tvUv = instanceUvs + vec2( position.x * cellScale * instanceWidths, position.y * cellScale );\n\tvec2 newPosition = vec2( position.x * instanceWidths, position.y );\n\tnewPosition.x += instanceOffsets;\n\tnewPosition = rotate * newPosition;\n\tvec4 offset = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tnewPosition *= scale;\n\tnewPosition.xy *= offset.w;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tfogDepth = -mvPosition.z;\n\tgl_Position = vec4( newPosition, 0.0, 0.0 ) + offset;\n}",glyphFragmentShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n#define LOG2 1.442695\nuniform sampler2D atlas;\nuniform vec3 fogColor;\nuniform int fogEnabled;\nuniform float fogDensity;\nvarying float fogDepth;\nvarying vec2 vUv;\nvoid main() {\n\tgl_FragColor = texture2D( atlas, vUv );\n\tif ( fogEnabled != 0 ) {\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t\tgl_FragColor = mix( gl_FragColor, vec4( fogColor, 0.0 ), fogFactor );\n\t}\n}",heightVertexShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform sampler2D cmap;\nuniform float minZ;\nuniform float scaleZ;\nuniform vec3 uLight;\nvarying vec3 vColor;\nvarying float zMap;\nvarying float fogDepth;\nvarying vec3 vMvPosition;\nvoid main() {\n#ifdef SURFACE\n\tvec3 sNormal = normalMatrix * normal;\n\tfloat dotNL = dot( normalize( sNormal ), uLight );\n\tvColor = saturate( dotNL ) * color + vec3( 0.3, 0.3, 0.3 );\n#else\n\tvColor = color;\n#endif\n\tzMap = ( position.z - minZ ) * scaleZ;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tvMvPosition = mvPosition.xyz;\n\tfogDepth = -mvPosition.z;\n\tgl_Position = projectionMatrix * mvPosition;\n}",heightFragmentShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n#define LOG2 1.442695\nuniform sampler2D cmap;\nuniform vec3 fogColor;\nuniform int fogEnabled;\nuniform float fogDensity;\nuniform float distanceTransparency;\nvarying float fogDepth;\nvarying float zMap;\nvarying vec3 vColor;\nvarying vec3 vMvPosition;\nvoid main() {\n\tgl_FragColor = texture2D( cmap, vec2( 1.0 - zMap, 1.0 ) ) * vec4( vColor, 1.0 );\n\tif ( distanceTransparency > 0.0 ) {\n\t\tgl_FragColor.a = 1.0 - length( vMvPosition.xyz ) / distanceTransparency;\n\t}\n\tif ( fogEnabled != 0 ) {\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n\t}\n}",popupVertexShader:"\nuniform mat2 rotate;\nuniform vec2 scale;\nvarying vec2 vUv;\nvarying vec3 vColor;\nvoid main() {\n\tvec2 newPosition = vec2( position.x, position.y );\n\tvColor = color;\n\tvUv = newPosition;\n\tnewPosition = rotate * newPosition;\n\tvec4 offset = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tnewPosition *= scale;\n\tnewPosition *= offset.w;\n\tgl_Position = vec4( newPosition, 0.0, 0.0 ) + offset;\n}",popupFragmentShader:"uniform sampler2D popupImage;\nvarying vec2 vUv;\nvarying vec3 vColor;\nvoid main() {\n\tgl_FragColor = texture2D( popupImage, vUv ) * vec4( vColor, 1.0 );\n}",waterVertexShader:"attribute vec3 sinks;\nattribute float selection;\nvarying vec3 vPosition;\nvarying float vSelection;\nvarying vec3 vSink;\nvoid main() {\n\tvPosition = position;\n\tvSelection = selection;\n\tvSink = sinks;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",waterFragmentShader:"uniform float offset;\nvarying vec3 vPosition;\nvarying float vSelection;\nvarying vec3 vSink;\nvoid main() {\n\tgl_FragColor = vec4( 0.1, 0.1, sin( offset + distance( vPosition, vSink ) ) * 0.4 + 0.6, 0.0 );\n\tgl_FragColor = mix( gl_FragColor, vec4( 1.0, 0.0, 0.0, 1.0 ), vSelection );\n}",lineVertexShader:"#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nuniform float linewidth;\nuniform vec2 resolution;\nattribute vec3 instanceStart;\nattribute vec3 instanceEnd;\nattribute vec3 instanceColorStart;\nattribute vec3 instanceColorEnd;\nvarying vec2 vUv;\n#ifdef CV_HEIGHT\n\tuniform sampler2D cmap;\n\tuniform float minZ;\n\tuniform float scaleZ;\n\tvarying float zMap;\n#endif\n#if defined( CV_DEPTH ) || defined( CV_DEPTH_CURSOR )\n\tconst float UnpackDownscale = 255. / 256.;\n\tconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\n\tconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n\tfloat unpackRGBAToFloat( const in vec4 v ) {\n\t\treturn dot( v, UnpackFactors );\n\t}\n\tuniform vec3 modelMin;\n\tuniform float scaleX;\n\tuniform float scaleY;\n\tuniform float rangeZ;\n\tuniform float depthScale;\n\tuniform sampler2D depthMap;\n\tuniform float datumShift;\n\tvarying float height;\n#endif\n#ifdef CV_CURSOR\n\tvarying float height;\n#endif\n#ifdef USE_DASH\n\tuniform float dashScale;\n\tattribute float instanceDistanceStart;\n\tattribute float instanceDistanceEnd;\n\tvarying float vLineDistance;\n#endif\nvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\tfloat a = projectionMatrix[ 2 ][ 2 ];\tfloat b = projectionMatrix[ 3 ][ 2 ];\tfloat nearEstimate = - 0.5 * b / a;\n\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\tend.xyz = mix( start.xyz, end.xyz, alpha );\n}\nvoid main() {\n\t#ifdef USE_COLOR\n\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\t#endif\n\t#ifdef USE_DASH\n\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\t#endif\n\tfloat aspect = resolution.x / resolution.y;\n\tvUv = uv;\n\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 );\n\tif ( perspective ) {\n\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\t\t\ttrimSegment( start, end );\n\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\t\t\ttrimSegment( end, start );\n\t\t}\n\t}\n\tvec4 clipStart = projectionMatrix * start;\n\tvec4 clipEnd = projectionMatrix * end;\n\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\tvec2 dir = ndcEnd - ndcStart;\n\tdir.x *= aspect;\n\tdir = normalize( dir );\n\tvec2 offset = vec2( dir.y, - dir.x );\n\tdir.x /= aspect;\n\toffset.x /= aspect;\n\tif ( position.x < 0.0 ) offset *= - 1.0;\n\tif ( position.y < 0.0 ) {\n\t\toffset += - dir;\n\t} else if ( position.y > 1.0 ) {\n\t\toffset += dir;\n\t}\n\toffset *= linewidth;\n\toffset /= resolution.y;\n\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\toffset *= clip.w;\n\tclip.xy += offset;\n\t#ifdef CV_CURSOR\n\t\theight = instanceStart.z + ( instanceEnd.z - instanceStart.z) * position.y;\n\t#endif\n\t#ifdef CV_HEIGHT\n\t\tzMap = ( instanceStart.z + ( instanceEnd.z - instanceStart.z) * position.y - minZ ) * scaleZ;\n\t#endif\n\t#if defined( CV_DEPTH ) || defined( CV_DEPTH_CURSOR )\n\t\tvec3 realPosition = instanceStart + ( instanceEnd - instanceStart ) * position.y;\n\t\tvec2 terrainCoords = vec2( ( realPosition.x - modelMin.x ) * scaleX, ( realPosition.y - modelMin.y ) * scaleY );\n\t\tfloat terrainHeight = unpackRGBAToFloat( texture2D( depthMap, terrainCoords ) );\n\t\tterrainHeight = terrainHeight * rangeZ + modelMin.z + datumShift;\n\t\theight = terrainHeight - realPosition.z;\n\t#endif\n\t#ifdef CV_DEPTH\n\t\theight *= depthScale;\n\t#endif\n\tgl_Position = clip;\n\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",lineFragmentShader:"uniform vec3 diffuse;\nuniform float opacity;\n#ifdef CV_HEIGHT\n\tuniform sampler2D cmap;\n\tvarying float zMap;\n#endif\n#ifdef CV_DEPTH\n\tuniform sampler2D cmap;\n\tvarying float height;\n#endif\n#if defined( CV_CURSOR ) || defined( CV_DEPTH_CURSOR )\n\tuniform float cursor;\n\tuniform float cursorWidth;\n\tuniform vec3 baseColor;\n\tuniform vec3 cursorColor;\n\tvarying float height;\n#endif\n#ifdef USE_DASH\n\tuniform float dashSize;\n\tuniform float dashOffset;\n\tuniform float gapSize;\n#endif\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vUv;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\t#ifdef USE_DASH\n\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard;\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard;\n\t#endif\n\tif ( abs( vUv.y ) > 1.0 ) {\n\t\tfloat a = vUv.x;\n\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\tfloat len2 = a * a + b * b;\n\t\tif ( len2 > 1.0 ) discard;\n\t}\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\t#ifdef CV_HEIGHT\n\t\tgl_FragColor = texture2D( cmap, vec2( 1.0 - zMap, 1.0 ) ) * vec4( vColor, 1.0 );\n\t#endif\n\t#ifdef CV_DEPTH\n\t\tgl_FragColor = texture2D( cmap, vec2( height, 1.0 ) ) * vec4( vColor, 1.0 );\n\t#endif\n\t#if defined( CV_CURSOR ) || defined( CV_DEPTH_CURSOR )\n\t\tfloat delta = abs( height - cursor );\n\t\tfloat ss = smoothstep( 0.0, cursorWidth, cursorWidth - delta );\n\t\tif ( delta < cursorWidth * 0.05 ) {\n\t\t\tgl_FragColor = vec4( vColor, 1.0 );\n\t\t} else {\n\t\t\tgl_FragColor = vec4( mix( baseColor, cursorColor, ss ), 1.0 ) * vec4( vColor, 1.0 );\n\t\t}\n\t#endif\n\t#ifdef CV_BASIC\n\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\t#endif\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",commonTerrainCodeColor:"if ( scale > 0.0 ) {\n\tfloat targetDistance = distance( target, vPosition );\n\tfloat f = abs( targetDistance - accuracy ) * scale;\n\tfloat c = smoothstep( 1.0, 6.0, f );\n\tdiffuseColor = mix( vec4( ringColor, 1.0 ), diffuseColor, c );\n}",commonTerrainCodePars:"uniform float scale;\nuniform float accuracy;\nuniform vec2 target;\nuniform vec3 ringColor;\nvarying vec2 vPosition;"};function da(t,e){const i=t.survey,n=t.cfg,r=i.modelLimits;return Ie.call(this,{vertexShader:ua.cursorVertexShader,fragmentShader:ua.cursorFragmentShader,type:"CV.CursorMaterial",uniforms:Object.assign({uLight:{value:i.lightDirection},cursor:{value:0},cursorWidth:{value:5},baseColor:{value:n.themeColor("shading.cursorBase")},cursorColor:{value:n.themeColor("shading.cursor")}},t.materials.commonUniforms),defines:{USE_COLOR:!0,SURFACE:1!==e}}),this.halfRange=(r.max.z-r.min.z)/2,this}function pa(t){const e=32,i=document.createElement("canvas");i||console.error("creating canvas for cluster marker failed"),i.width=64,i.height=64;const n=i.getContext("2d");n||console.error("cannot obtain 2D canvas"),n.fillStyle="rgba( 0, 0, 0, 0 )",n.fillRect(0,0,64,64),n.textAlign="center",n.font="bold 40px helvetica,sans-serif",n.fillStyle="#ffffff";const r=n.createRadialGradient(e,e,30,e,e,0);r.addColorStop(0,"rgba( 255, 128, 0, 64 )"),r.addColorStop(.3,"rgba( 255, 200, 0, 255 )"),r.addColorStop(1,"rgba( 255, 255, 0, 255 )"),n.fillStyle=r,n.beginPath(),n.arc(e,e,30,0,2*Math.PI),n.fill(),n.fillStyle="rgba( 0, 0, 0, 255 )",n.fillText(t,e,47);const s=new Kr(i);return jr.call(this,{map:s,size:32,depthTest:!1,transparent:!0,alphaTest:.8,sizeAttenuation:!1}),s.onUpdate=function(t){t.image=null},this.name="ClusterMaterial",this}function fa(){}da.prototype=Object.create(Ie.prototype),da.prototype.setCursor=function(t){const e=Math.max(Math.min(t,this.halfRange),-this.halfRange);return this.uniforms.cursor.value=e,e},da.prototype.getCursor=function(){return this.uniforms.cursor.value},pa.prototype=Object.create(jr.prototype),fa.prototype.setThroughMode=function(t){switch(this.stencilWrite=!1,this.blending=1,t){case 2:this.blending=5,this.blendSrc=207,this.blendDst=206;break;case 1:this.stencilWrite=!0,this.stencilFunc=514}};const ma=["uniform vec3 contourColor;","uniform vec3 contourColor10;","uniform float contourInterval;","uniform vec3 baseColor;","varying float vPositionZ;"].join("\n"),ga=["float f = fract( vPositionZ / contourInterval );","if ( f > 0.5 ) f = 1.0 - f;","float f10 = fract( vPositionZ / ( contourInterval * 10.0 ) );","float df = fwidth( vPositionZ / contourInterval );","float contourColorSelection = step( 0.90, f10 );","float c = smoothstep( df * 0.5, df * 1.0, f );","vec4 finalColor = vec4( mix( contourColor, contourColor10, contourColorSelection ), 1.0 );","vec4 baseColorAlpha = vec4( baseColor, opacity );","diffuseColor = mix( finalColor, baseColorAlpha, c );"].join("\n");function va(t){const e=t.survey,i=t.cfg,n=t.materials;return is.call(this),this.transparent=!0,this.extensions={derivatives:!0},this.onBeforeCompile=function(t){Object.assign(t.uniforms,{zOffset:{value:e.offsets.z},contourInterval:{value:i.themeValue("shading.contours.interval")},contourColor:{value:i.themeColor("shading.contours.line")},contourColor10:{value:i.themeColor("shading.contours.line10")},baseColor:{value:i.themeColor("shading.contours.base")}},n.commonDepthUniforms,n.commonTerrainUniforms);var r=t.vertexShader.replace("#include <common>","$&\nuniform float zOffset;\nuniform float datumShift;\nvarying float vPositionZ;\n").replace("include <begin_vertex>","$&\nvPositionZ = position.z + zOffset + datumShift;\n"),s=t.fragmentShader.replace("#include <common>","$&\n"+ma+"\n").replace("#include <color_fragment>",ga);t.vertexShader=r,t.fragmentShader=s},Object.defineProperty(this,"opacity",{get:function(){return t.materials.terrainOpacity}}),this}function ya(t,e){const i=t.survey,n=i.modelLimits,r=i.terrain,s=r.boundingBox,a=s.getSize(new J),o=t.cfg.value("saturatedGradient",!1)?"gradientHi":"gradientLow",h=t.materials.textureCache;return Ie.call(this,{vertexShader:ua.depthVertexShader,fragmentShader:ua.depthFragmentShader,type:"CV.DepthMaterial",uniforms:Object.assign({uLight:{value:i.lightDirection},modelMin:{value:s.min},scaleX:{value:1/a.x},scaleY:{value:1/a.y},rangeZ:{value:a.z},depthScale:{value:1/(n.max.z-n.min.z)},cmap:{value:h.getTexture(o)},depthMap:{value:r.depthTexture}},t.materials.commonUniforms,t.materials.commonDepthUniforms),defines:{USE_COLOR:!0,SURFACE:1!==e}}),this}function xa(t,e){const i=t.survey,n=t.cfg,r=i.modelLimits,s=i.terrain,a=s.boundingBox,o=a.getSize(new J);return this.max=r.max.z-r.min.z,Ie.call(this,{vertexShader:ua.depthCursorVertexShader,fragmentShader:ua.depthCursorFragmentShader,type:"CV.DepthCursorMaterial",uniforms:Object.assign({uLight:{value:i.lightDirection},modelMin:{value:a.min},scaleX:{value:1/o.x},scaleY:{value:1/o.y},rangeZ:{value:o.z},depthMap:{value:s.depthTexture},cursor:{value:this.max/2},cursorWidth:{value:5},baseColor:{value:n.themeColor("shading.cursorBase")},cursorColor:{value:n.themeColor("shading.cursor")}},t.materials.commonUniforms,t.materials.commonDepthUniforms),defines:{USE_COLOR:!0,SURFACE:1!==e}}),this}function _a(t){const e=t.boundingBox,i=e.min.z,n=e.max.z;return Ie.call(this,{vertexShader:ua.depthMapVertexShader,fragmentShader:ua.depthMapFragmentShader,type:"CV.DepthMapMaterial",depthWrite:!1,uniforms:{minZ:{value:i},scaleZ:{value:1/(n-i)}}}),this}function Ma(t){jr.call(this);const e=t.materials.colourCache,i=t.materials.textureCache;return this.map=i.getTexture("disc"),this.color=e.white,this.opacity=1,this.alphaTest=.8,this.sizeAttenuation=!1,this.transparent=!0,this.vertexColors=!0,this.onBeforeCompile=function(t){var e=t.vertexShader.replace("#include <common>","\nattribute float pSize;\n\n$&").replace("\tgl_PointSize = size;","\tgl_PointSize = pSize;");t.vertexShader=e},this}function ba(t,e,i,n){this.rotation=i;const r=this,s=e.cellScale,a=n.container,o=e.cellSize,h=Math.cos(i),l=Math.sin(i),c=new k(o/a.clientWidth,o/a.clientHeight),u=new Float32Array([h,l,-l,h]);return Ie.call(this,{vertexShader:ua.glyphVertexShader,fragmentShader:ua.glyphFragmentShader,type:"CV.GlyphMaterial",uniforms:Object.assign({cellScale:{value:s},atlas:{value:e.getTexture()},rotate:{value:u},scale:{value:c}},t.materials.commonUniforms)}),this.alphaTest=.9,this.depthTest=!1,this.transparent=!0,this.type="CV.GlyphMaterial",this.atlas=e,this.scaleFactor=1/e.cellScale,n.addEventListener("resized",(function(){r.uniforms.scale.value.set(o/a.clientWidth,o/a.clientHeight)})),this}function wa(t,e){const i=t.survey,n=i.modelLimits,r=n.min.z,s=n.max.z,a=t.cfg.value("saturatedGradient",!1)?"gradientHi":"gradientLow",o=t.materials.textureCache;return this.midRange=(s+r)/2,Ie.call(this,{vertexShader:ua.heightVertexShader,fragmentShader:ua.heightFragmentShader,type:"CV.HeightMaterial",uniforms:Object.assign({uLight:{value:i.lightDirection},minZ:{value:r},scaleZ:{value:1/(s-r)},cmap:{value:o.getTexture(a)}},t.materials.commonUniforms),defines:{USE_COLOR:!0,SURFACE:1!==e}}),this}va.prototype=Object.create(is.prototype),Object.assign(va.prototype,fa.prototype),ya.prototype=Object.create(Ie.prototype),xa.prototype=Object.create(Ie.prototype),xa.prototype.setCursor=function(t){const e=Math.max(Math.min(t,this.max),0);return this.uniforms.cursor.value=e,e},xa.prototype.getCursor=function(){return this.uniforms.cursor.value},_a.prototype=Object.create(Ie.prototype),Ma.prototype=Object.create(jr.prototype),ba.prototype=Object.create(Ie.prototype),ba.prototype.getAtlas=function(){return this.atlas},wa.prototype=Object.create(Ie.prototype);const Sa=["uniform sampler2D cmap;","varying float zMap;",ua.commonTerrainCodePars].join("\n"),Ea=["diffuseColor = texture2D( cmap, vec2( 1.0 - zMap, 1.0 ) );","diffuseColor.a = opacity;",ua.commonTerrainCodeColor].join("\n");function Ta(t){const e=t.survey,i=t.cfg,n=e.terrain,r=t.materials.textureCache;is.call(this);var s=i.themeValue("shading.hypsometric.min"),a=i.themeValue("shading.hypsometric.max");return void 0===n.boundBox&&n.computeBoundingBox(),void 0===s&&(s=n.boundingBox.min.z),void 0===a&&(a=n.boundingBox.max.z),this.transparent=!0,this.onBeforeCompile=function(e){Object.assign(e.uniforms,t.materials.commonTerrainUniforms,{minZ:{value:s},scaleZ:{value:1/(a-s)},cmap:{value:r.getTexture("hypsometric")}});var i=e.vertexShader.replace("#include <common>","\nuniform float minZ;\nuniform float scaleZ;\nvarying float zMap;\nvarying vec2 vPosition;\n$&").replace("include <begin_vertex>","$&\nvPosition = vec2( position.x, position.y );\nzMap = saturate( ( position.z - minZ ) * scaleZ );"),n=e.fragmentShader.replace("#include <common>","$&\n"+Sa+"\n").replace("#include <color_fragment>",Ea);e.vertexShader=i,e.fragmentShader=n},Object.defineProperty(this,"opacity",{get:function(){return t.materials.terrainOpacity}}),this}function La(t){return is.call(this,{color:16746632}),this.transparent=!0,Object.defineProperty(this,"opacity",{get:function(){return t.materials.terrainOpacity}}),this}Ta.prototype=Object.create(is.prototype),Object.assign(Ta.prototype,fa.prototype),La.prototype=Object.create(is.prototype),Object.assign(La.prototype,fa.prototype),z.generateUUID=function(){return null},ve.DefaultUp.set(0,0,1),ve.prototype.addStatic=function(t){t.matrixAutoUpdate=!1,t.updateMatrix(),this.add(t)};const Ca=Ne.merge([wi.common,wi.fog,{linewidth:{value:1},resolution:{value:new k(1,1)},dashScale:{value:1},dashSize:{value:1},dashOffset:{value:0},gapSize:{value:1},opacity:{value:1}}]);var Aa=function(t,e="height"){const i=t.survey,n=t.cfg,r=n.value("saturatedGradient",!1)?"gradientHi":"gradientLow",s=t.materials.textureCache,a=i.modelLimits,o=a.max.z,h=a.min.z,l={};let c=null,u=null,d=null;i.terrain&&(c=i.terrain,c.boundingBox&&(u=c.boundingBox,d=u.getSize(new J)));let p={};switch(e){case"height":l.CV_HEIGHT=!0,p={minZ:{value:h},scaleZ:{value:1/(o-h)},cmap:{value:s.getTexture(r)}};break;case"cursor":l.CV_CURSOR=!0,p={cursor:{value:0},cursorWidth:{value:5},baseColor:{value:n.themeColor("shading.cursorBase")},cursorColor:{value:n.themeColor("shading.cursor")}};break;case"depth":l.CV_DEPTH=!0,p=Object.assign({modelMin:{value:u.min},scaleX:{value:1/d.x},scaleY:{value:1/d.y},rangeZ:{value:d.z},depthScale:{value:1/(a.max.z-a.min.z)},cmap:{value:s.getTexture(r)},depthMap:{value:c.depthTexture}},t.materials.commonDepthUniforms);break;case"depth-cursor":this.max=a.max.z-a.min.z,l.CV_DEPTH_CURSOR=!0,p=Object.assign({modelMin:{value:u.min},scaleX:{value:1/d.x},scaleY:{value:1/d.y},rangeZ:{value:d.z},depthMap:{value:c.depthTexture},cursor:{value:this.max/2},cursorWidth:{value:5},baseColor:{value:n.themeColor("shading.cursorBase")},cursorColor:{value:n.themeColor("shading.cursor")}},t.materials.commonDepthUniforms);break;default:l.CV_BASIC=!0}Ie.call(this,{type:"LineMaterial",uniforms:Object.assign(Ne.clone(Ca),p,t.materials.commonUniforms),vertexShader:ua.lineVertexShader,fragmentShader:ua.lineFragmentShader,clipping:!0,defines:l}),this.dashed=!1,this.halfRange=(a.max.z-a.min.z)/2,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(t){this.uniforms.dashOffset.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues({color:16777215,vertexColors:!0,linewidth:1}),this.resolution=new k(t.container.clientWidth,t.container.clientHeight),t.viewer.addEventListener("resized",(t=>{const e=t.lineScale?t.lineScale:1;this.resolution=new k(t.width,t.height),this.linewidth=Math.max(1,Math.floor(t.width/1e3)*e)}))};(Aa.prototype=Object.create(Ie.prototype)).constructor=Aa,Aa.prototype.isLineMaterial=!0,Aa.prototype.setCursor=function(t){var e;return e=void 0!==this.max?Math.max(Math.min(t,this.max),0):Math.max(Math.min(t,this.halfRange),-this.halfRange),this.uniforms.cursor.value=e,e},Aa.prototype.getCursor=function(){return this.uniforms.cursor.value};const Pa={inclination:[[255,255,0],[253,254,2],[251,253,4],[249,252,5],[247,251,7],[245,250,9],[243,249,11],[241,249,13],[239,248,14],[237,247,16],[235,246,18],[233,245,20],[231,244,22],[229,243,23],[227,242,25],[225,241,27],[223,240,29],[221,239,31],[219,238,32],[217,237,34],[215,237,36],[213,236,38],[211,235,40],[209,234,41],[207,233,43],[205,232,45],[203,231,47],[201,230,49],[199,229,50],[197,228,52],[195,227,54],[193,226,56],[191,226,58],[189,225,60],[187,224,61],[185,223,63],[183,222,65],[181,221,67],[179,220,69],[177,219,70],[175,218,72],[173,217,74],[171,216,76],[169,215,78],[167,214,79],[165,214,81],[163,213,83],[161,212,85],[159,211,87],[157,210,88],[155,209,90],[153,208,92],[151,207,94],[149,206,96],[147,205,97],[145,204,99],[143,203,101],[141,202,103],[139,202,105],[137,201,106],[135,200,108],[133,199,110],[131,198,112],[129,197,114],[126,196,115],[124,195,117],[122,194,119],[120,193,121],[118,192,123],[116,191,124],[114,191,126],[112,190,128],[110,189,130],[108,188,132],[106,187,133],[104,186,135],[102,185,137],[100,184,139],[98,183,141],[96,182,142],[94,181,144],[92,180,146],[90,179,148],[88,179,150],[86,178,151],[84,177,153],[82,176,155],[80,175,157],[78,174,159],[76,173,160],[74,172,162],[72,171,164],[70,170,166],[68,169,168],[66,168,169],[64,167,171],[62,167,173],[60,166,175],[58,165,177],[56,164,179],[54,163,180],[52,162,182],[50,161,184],[48,160,186],[46,159,188],[44,158,189],[42,157,191],[40,156,193],[38,156,195],[36,155,197],[34,154,198],[32,153,200],[30,152,202],[28,151,204],[26,150,206],[24,149,207],[22,148,209],[20,147,211],[18,146,213],[16,145,215],[14,144,216],[12,144,218],[10,143,220],[8,142,222],[6,141,224],[4,140,225],[2,139,227],[0,138,229]],gradientLow:[[235,99,111],[235,99,112],[234,99,113],[234,100,114],[233,100,114],[233,100,115],[232,100,116],[232,101,117],[231,101,118],[231,101,119],[230,101,119],[230,101,120],[230,102,121],[229,102,122],[229,102,123],[228,102,124],[228,103,124],[227,103,125],[227,103,126],[226,103,127],[226,103,128],[226,104,129],[225,104,129],[225,104,130],[224,104,131],[224,104,132],[223,105,133],[223,105,134],[222,105,134],[222,105,135],[221,106,136],[221,106,137],[221,106,138],[220,106,139],[220,106,139],[219,107,140],[219,107,141],[218,107,142],[218,107,143],[217,108,144],[217,108,144],[216,108,145],[216,108,146],[216,108,147],[215,109,148],[215,109,149],[214,109,149],[214,109,150],[213,110,151],[213,110,152],[212,110,153],[212,110,154],[211,110,154],[211,111,155],[211,111,156],[210,111,157],[210,111,158],[209,111,159],[209,112,159],[208,112,160],[208,112,161],[207,112,162],[207,113,163],[207,113,164],[206,113,164],[206,113,165],[205,113,166],[205,114,167],[204,114,168],[204,114,169],[203,114,169],[203,115,170],[202,115,171],[202,115,172],[201,115,172],[200,116,173],[199,116,173],[198,116,173],[197,117,174],[196,117,174],[194,118,174],[193,118,175],[192,118,175],[191,119,176],[190,119,176],[189,119,176],[188,120,177],[187,120,177],[186,121,177],[185,121,178],[184,121,178],[183,122,178],[181,122,179],[180,122,179],[179,123,179],[178,123,180],[177,124,180],[176,124,181],[175,124,181],[174,125,181],[173,125,182],[172,125,182],[171,126,182],[170,126,183],[168,126,183],[167,127,183],[166,127,184],[165,128,184],[164,128,184],[163,128,185],[162,129,185],[161,129,186],[160,129,186],[159,130,186],[158,130,187],[157,131,187],[155,131,187],[154,131,188],[153,132,188],[152,132,188],[151,132,189],[150,133,189],[149,133,189],[148,133,190],[147,134,190],[146,134,191],[145,135,191],[144,135,191],[142,135,192],[141,136,192],[140,136,192],[139,136,193],[138,137,193],[137,137,193],[136,138,194],[135,138,194],[134,138,194],[133,139,195],[132,139,195],[131,139,196],[129,140,196],[128,140,196],[127,141,197],[126,141,197],[125,141,197],[124,142,198],[123,142,198],[122,142,198],[120,142,197],[119,143,197],[117,143,197],[116,143,197],[114,143,196],[113,144,196],[111,144,196],[110,144,195],[108,144,195],[107,144,195],[105,145,195],[104,145,194],[102,145,194],[101,145,194],[100,146,193],[98,146,193],[97,146,193],[95,146,193],[94,146,192],[92,147,192],[91,147,192],[89,147,191],[88,147,191],[86,147,191],[85,148,191],[83,148,190],[82,148,190],[80,148,190],[79,149,189],[78,149,189],[76,149,189],[75,149,189],[73,149,188],[72,150,188],[70,150,188],[69,150,187],[67,150,187],[66,151,187],[64,151,186],[63,151,186],[61,151,186],[60,151,186],[59,152,185],[57,152,185],[56,152,185],[54,152,184],[53,153,184],[51,153,184],[50,153,184],[48,153,183],[47,153,183],[45,154,183],[44,154,182],[42,154,182],[41,154,182],[39,154,182],[38,155,181],[37,155,181],[35,155,181],[34,155,180],[32,156,180],[31,156,180],[29,156,180],[28,156,179],[26,156,179],[25,157,179],[23,157,178],[22,157,178],[20,157,178],[19,158,178],[17,158,177],[16,158,177],[16,158,176],[17,158,176],[17,158,175],[18,158,174],[18,158,174],[19,158,173],[19,158,172],[20,158,171],[20,158,171],[21,158,170],[21,158,169],[22,158,169],[22,159,168],[23,159,167],[23,159,167],[23,159,166],[24,159,165],[24,159,164],[25,159,164],[25,159,163],[26,159,162],[26,159,162],[27,159,161],[27,159,160],[28,159,160],[28,159,159],[29,159,158],[29,159,157],[30,159,157],[30,159,156],[30,159,155],[31,159,155],[31,159,154],[32,159,153],[32,159,153],[33,159,152],[33,160,151],[34,160,150],[34,160,150],[35,160,149],[35,160,148],[36,160,148],[36,160,147],[36,160,146],[37,160,146],[37,160,145],[38,160,144],[38,160,143],[39,160,143],[39,160,142],[40,160,141],[40,160,141],[41,160,140],[41,160,139],[42,160,139],[42,160,138],[43,160,137],[43,160,136],[43,160,136],[44,160,135],[44,161,134],[45,161,134],[45,161,133],[46,161,132],[46,161,132],[47,161,131],[47,161,130],[48,161,129],[48,161,129],[49,161,128],[49,161,127],[50,161,127],[50,161,126],[51,161,125],[52,161,125],[53,161,124],[54,161,123],[55,161,123],[56,161,122],[56,160,121],[57,160,121],[58,160,120],[59,160,120],[60,160,119],[61,160,118],[62,160,118],[63,160,117],[64,160,116],[65,160,116],[66,160,115],[67,160,114],[67,159,114],[68,159,113],[69,159,112],[70,159,112],[71,159,111],[72,159,111],[73,159,110],[74,159,109],[75,159,109],[76,159,108],[77,159,107],[78,159,107],[78,158,106],[79,158,105],[80,158,105],[81,158,104],[82,158,103],[83,158,103],[84,158,102],[85,158,102],[86,158,101],[87,158,100],[88,158,100],[89,158,99],[89,157,98],[90,157,98],[91,157,97],[92,157,96],[93,157,96],[94,157,95],[95,157,94],[96,157,94],[97,157,93],[98,157,93],[99,157,92],[100,157,91],[100,156,91],[101,156,90],[102,156,89],[103,156,89],[104,156,88],[105,156,87],[106,156,87],[107,156,86],[108,156,85],[109,156,85],[110,156,84],[111,156,84],[111,155,83],[112,155,82],[113,155,82],[114,155,81],[115,155,80],[116,155,80],[117,155,79],[118,155,79],[118,155,79],[119,154,78],[120,154,78],[121,154,78],[121,154,78],[122,154,78],[123,153,77],[123,153,77],[124,153,77],[125,153,77],[126,153,77],[126,152,77],[127,152,76],[128,152,76],[128,152,76],[129,152,76],[130,151,76],[131,151,75],[131,151,75],[132,151,75],[133,150,75],[133,150,75],[134,150,74],[135,150,74],[136,150,74],[136,149,74],[137,149,74],[138,149,73],[138,149,73],[139,149,73],[140,148,73],[141,148,73],[141,148,72],[142,148,72],[143,148,72],[143,147,72],[144,147,72],[145,147,72],[145,147,71],[146,147,71],[147,146,71],[148,146,71],[148,146,71],[149,146,70],[150,146,70],[150,145,70],[151,145,70],[152,145,70],[153,145,69],[153,145,69],[154,144,69],[155,144,69],[155,144,69],[156,144,68],[157,143,68],[158,143,68],[158,143,68],[159,143,68],[160,143,67],[160,142,67],[161,142,67],[162,142,67],[163,142,67],[163,142,67],[164,141,66],[165,141,66],[165,141,66],[166,141,66],[167,141,66],[168,140,65],[168,140,65],[169,140,65],[169,140,65],[170,140,66],[170,139,66],[171,139,66],[171,139,67],[172,139,67],[172,139,67],[172,138,68],[173,138,68],[173,138,68],[174,138,69],[174,138,69],[175,137,69],[175,137,70],[175,137,70],[176,137,70],[176,137,71],[177,136,71],[177,136,71],[177,136,72],[178,136,72],[178,135,72],[179,135,73],[179,135,73],[180,135,73],[180,135,74],[180,134,74],[181,134,74],[181,134,75],[182,134,75],[182,134,75],[183,133,76],[183,133,76],[183,133,76],[184,133,77],[184,133,77],[185,132,77],[185,132,77],[186,132,78],[186,132,78],[186,132,78],[187,131,79],[187,131,79],[188,131,79],[188,131,80],[189,131,80],[189,130,80],[189,130,81],[190,130,81],[190,130,81],[191,130,82],[191,129,82],[192,129,82],[192,129,83],[192,129,83],[193,128,83],[193,128,84],[194,128,84],[194,128,84],[194,128,85],[195,127,85],[195,127,85],[196,127,86],[196,127,86],[197,127,86],[197,126,87],[197,126,87],[198,126,87],[198,126,88],[199,126,88],[199,125,88],[200,125,89],[200,125,89]],gradientHi:[[167,1,221],[131,4,228],[74,2,231],[47,2,242],[2,27,247],[3,33,251],[4,39,254],[5,51,254],[6,75,254],[7,101,254],[8,127,238],[9,151,213],[10,177,168],[19,202,123],[30,227,78],[41,252,40],[72,254,36],[126,254,33],[167,254,30],[194,253,30],[220,224,29],[253,203,31],[254,176,25],[254,148,21],[254,120,18],[254,90,13],[254,61,9],[254,30,6],[254,2,2],[254,1,1],[254,1,1],[255,0,0]],survey:[[166,206,227],[31,120,180],[178,223,138],[51,160,44],[251,154,153],[227,26,28],[253,191,111],[255,127,0],[202,178,214],[106,61,154],[255,255,153]],depth:[[255,255,204],[255,255,203],[255,255,203],[255,254,202],[255,254,202],[255,254,201],[255,254,200],[255,253,200],[255,253,199],[255,253,199],[255,253,198],[255,252,197],[255,252,197],[255,252,196],[255,252,196],[255,251,195],[255,251,194],[255,251,194],[255,251,193],[255,250,193],[255,250,192],[255,250,191],[255,250,191],[255,249,190],[255,249,190],[255,249,189],[255,249,188],[255,248,188],[255,248,187],[255,248,187],[255,248,186],[255,247,185],[255,247,185],[255,247,184],[255,247,184],[255,246,183],[255,246,182],[255,246,182],[255,246,181],[255,245,180],[255,245,180],[255,245,179],[255,245,179],[255,244,178],[255,244,177],[255,244,177],[255,244,176],[255,243,176],[255,243,175],[255,243,174],[255,243,174],[255,242,173],[255,242,173],[255,242,172],[255,242,171],[255,241,171],[255,241,170],[255,241,170],[255,241,169],[255,240,168],[255,240,168],[255,240,167],[255,240,167],[255,239,166],[255,239,165],[255,239,165],[255,239,164],[255,238,164],[255,238,163],[255,238,162],[255,238,162],[255,237,161],[255,237,161],[255,237,160],[255,237,159],[255,236,159],[255,236,158],[255,236,158],[255,236,157],[255,235,157],[255,235,156],[255,235,155],[255,235,155],[255,234,154],[255,234,154],[255,234,153],[255,233,153],[255,233,152],[255,233,151],[255,233,151],[255,232,150],[255,232,150],[255,232,149],[255,232,148],[255,231,148],[255,231,147],[255,231,147],[255,230,146],[255,230,146],[255,230,145],[255,230,144],[255,229,144],[255,229,143],[255,229,143],[255,229,142],[255,228,142],[255,228,141],[255,228,140],[255,227,140],[255,227,139],[254,227,139],[254,227,138],[254,226,138],[254,226,137],[254,226,136],[254,225,136],[254,225,135],[254,225,135],[254,225,134],[254,224,134],[254,224,133],[254,224,132],[254,224,132],[254,223,131],[254,223,131],[254,223,130],[254,222,130],[254,222,129],[254,222,128],[254,222,128],[254,221,127],[254,221,127],[254,221,126],[254,221,125],[254,220,125],[254,220,124],[254,220,124],[254,219,123],[254,219,123],[254,219,122],[254,219,121],[254,218,121],[254,218,120],[254,218,120],[254,218,119],[254,217,119],[254,217,118],[254,216,117],[254,216,117],[254,215,116],[254,215,116],[254,214,115],[254,214,115],[254,213,114],[254,213,113],[254,212,113],[254,212,112],[254,211,112],[254,211,111],[254,210,111],[254,210,110],[254,209,109],[254,208,109],[254,208,108],[254,207,108],[254,207,107],[254,206,106],[254,206,106],[254,205,105],[254,205,105],[254,204,104],[254,204,104],[254,203,103],[254,203,102],[254,202,102],[254,202,101],[254,201,101],[254,200,100],[254,200,100],[254,199,99],[254,199,98],[254,198,98],[254,198,97],[254,197,97],[254,197,96],[254,196,96],[254,196,95],[254,195,94],[254,195,94],[254,194,93],[254,193,93],[254,193,92],[254,192,92],[254,192,91],[254,191,90],[254,191,90],[254,190,89],[254,190,89],[254,189,88],[254,189,88],[254,188,87],[254,188,86],[254,187,86],[254,187,85],[254,186,85],[254,185,84],[254,185,83],[254,184,83],[254,184,82],[254,183,82],[254,183,81],[254,182,81],[254,182,80],[254,181,79],[254,181,79],[254,180,78],[254,180,78],[254,179,77],[254,179,77],[254,178,76],[254,177,76],[254,177,76],[254,176,75],[254,176,75],[254,175,75],[254,175,75],[254,174,74],[254,174,74],[254,173,74],[254,173,74],[254,172,74],[254,172,73],[254,171,73],[254,171,73],[254,170,73],[254,170,72],[254,169,72],[254,169,72],[254,168,72],[254,168,72],[254,167,71],[254,167,71],[254,166,71],[254,166,71],[254,165,71],[254,165,70],[254,164,70],[254,164,70],[254,163,70],[254,163,69],[254,162,69],[254,162,69],[254,161,69],[254,161,69],[254,160,68],[254,160,68],[253,159,68],[253,159,68],[253,158,67],[253,158,67],[253,157,67],[253,157,67],[253,156,67],[253,156,66],[253,155,66],[253,155,66],[253,154,66],[253,154,65],[253,153,65],[253,153,65],[253,152,65],[253,152,65],[253,151,64],[253,151,64],[253,150,64],[253,150,64],[253,149,64],[253,149,63],[253,148,63],[253,148,63],[253,147,63],[253,147,62],[253,146,62],[253,146,62],[253,145,62],[253,145,62],[253,144,61],[253,144,61],[253,143,61],[253,143,61],[253,142,60],[253,142,60],[253,141,60],[253,140,60],[253,139,60],[253,138,59],[253,138,59],[253,137,59],[253,136,59],[253,135,58],[253,134,58],[253,133,58],[253,132,58],[253,132,57],[253,131,57],[253,130,57],[253,129,57],[253,128,56],[253,127,56],[253,126,56],[253,125,56],[253,125,55],[253,124,55],[253,123,55],[253,122,55],[253,121,54],[253,120,54],[253,119,54],[253,119,54],[253,118,53],[253,117,53],[253,116,53],[253,115,53],[253,114,52],[253,113,52],[253,113,52],[253,112,52],[253,111,51],[253,110,51],[252,109,51],[252,108,51],[252,107,50],[252,106,50],[252,106,50],[252,105,50],[252,104,49],[252,103,49],[252,102,49],[252,101,49],[252,100,48],[252,100,48],[252,99,48],[252,98,48],[252,97,47],[252,96,47],[252,95,47],[252,94,47],[252,94,46],[252,93,46],[252,92,46],[252,91,46],[252,90,45],[252,89,45],[252,88,45],[252,87,45],[252,87,44],[252,86,44],[252,85,44],[252,84,44],[252,83,43],[252,82,43],[252,81,43],[252,81,43],[252,80,42],[252,79,42],[252,78,42],[252,77,42],[251,77,42],[251,76,41],[251,75,41],[250,74,41],[250,74,41],[250,73,41],[249,72,40],[249,72,40],[249,71,40],[248,70,40],[248,69,40],[248,69,40],[247,68,39],[247,67,39],[247,67,39],[246,66,39],[246,65,39],[245,64,38],[245,64,38],[245,63,38],[244,62,38],[244,62,38],[244,61,37],[243,60,37],[243,59,37],[243,59,37],[242,58,37],[242,57,36],[242,57,36],[241,56,36],[241,55,36],[241,54,36],[240,54,35],[240,53,35],[240,52,35],[239,52,35],[239,51,35],[239,50,35],[238,50,34],[238,49,34],[238,48,34],[237,47,34],[237,47,34],[237,46,33],[236,45,33],[236,45,33],[236,44,33],[235,43,33],[235,42,32],[235,42,32],[234,41,32],[234,40,32],[234,40,32],[233,39,31],[233,38,31],[232,37,31],[232,37,31],[232,36,31],[231,35,30],[231,35,30],[231,34,30],[230,33,30],[230,32,30],[230,32,30],[229,31,29],[229,30,29],[229,30,29],[228,29,29],[228,28,29],[228,27,28],[227,27,28],[227,26,28],[226,26,28],[226,25,28],[225,25,28],[224,25,29],[224,24,29],[223,24,29],[222,24,29],[222,23,29],[221,23,29],[220,22,29],[219,22,30],[219,22,30],[218,21,30],[217,21,30],[217,21,30],[216,20,30],[215,20,30],[215,20,30],[214,19,31],[213,19,31],[213,19,31],[212,18,31],[211,18,31],[211,17,31],[210,17,31],[209,17,32],[209,16,32],[208,16,32],[207,16,32],[206,15,32],[206,15,32],[205,15,32],[204,14,33],[204,14,33],[203,14,33],[202,13,33],[202,13,33],[201,12,33],[200,12,33],[200,12,33],[199,11,34],[198,11,34],[198,11,34],[197,10,34],[196,10,34],[195,10,34],[195,9,34],[194,9,35],[193,9,35],[193,8,35],[192,8,35],[191,7,35],[191,7,35],[190,7,35],[189,6,36],[189,6,36],[188,6,36],[187,5,36],[187,5,36],[186,5,36],[185,4,36],[185,4,36],[184,4,37],[183,3,37],[182,3,37],[182,2,37],[181,2,37],[180,2,37],[180,1,37],[179,1,38],[178,1,38],[178,0,38],[177,0,38]],hypsometric:[[148,191,139],[148,191,139],[168,198,143],[168,198,143],[189,204,150],[189,204,150],[209,215,171],[209,215,171],[225,228,181],[225,228,181],[239,235,192],[239,235,192],[232,225,182],[232,225,182],[222,214,163],[222,214,163],[211,202,157],[211,202,157],[202,185,130],[202,185,130],[195,167,107],[195,167,107],[192,154,83],[192,154,83],[184,146,71],[184,146,71],[175,140,71],[175,140,71],[168,136,71],[168,136,71],[159,128,72],[159,128,72]]};function Ra(){const t=[];this.getColors=function(e){var i=t[e];if(void 0===i){const n=Pa[e];void 0===n&&console.error("unknown colour scale requested "+e),i=function(t){const e=[];for(var i=0,n=t.length;i<n;i++){const n=t[i];e[i]=new Ut(n[0]/255,n[1]/255,n[2]/255)}return e}(n),t[e]=i}return i},this.white=new Ut(16777215)}function Da(){const t=[];this.getTexture=function(e){var i=t[e];if(void 0===i){if("disc"===e)i=(new hs).load("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg id='a' width='32mm' height='32mm' version='1.1' viewBox='0 0 32 32' xmlns='http://www.w3.org/2000/svg' %3E%3Ccircle id='d' cx='16' cy='16' r='14' color='%23000000' fill='%23fff' fill-rule='evenodd' stroke-width='0'/%3E%3C/svg%3E%0A");else if("disc-outlined"===e)i=(new hs).load("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg id='a' width='32mm' height='32mm' version='1.1' viewBox='0 0 32 32' xmlns='http://www.w3.org/2000/svg' %3E%3Ccircle id='d' cx='16' cy='16' r='14' color='%23000000' fill='%23fff' fill-rule='evenodd' stroke-width='1' stroke='%23000'/%3E%3C/svg%3E%0A");else{const t=Pa[e];void 0===t&&console.error("unknown colour scale requested "+e),i=function(t){const e=t.length,i=new Uint8Array(3*e);for(var n=0,r=e;r;){const e=t[--r];i[n++]=e[0],i[n++]=e[1],i[n++]=e[2]}const s=new Y(i,e,1,C,b);return s.minFilter=_,s.magFilter=_,s.needsUpdate=!0,s}(t)}t[e]=i}return i}}function Na(t){const e=512,i=document.createElement("canvas"),n=" ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789%,.-_/()[]'\"",r=n.length;if(this.cellScale=.0625,this.cellSize=32,this.glyphCount=r,this.divisions=16,this.map={},r>256)return void console.error("too many glyphs for atlas");i||console.error("creating canvas for glyph atlas failed"),i.width=e,i.height=e;const s=i.getContext("2d");s||console.error("cannot obtain 2D canvas"),s.fillStyle=t.background||"rgba( 0, 0, 0, 0 )",s.fillRect(0,0,e,e),s.textAlign="left",s.font="28px "+t.font,s.fillStyle=t.color||"#ffffff",this.ctx=s;for(var a=0;a<r;a++)this.addGlyphToCanvas(n.charAt(a),a);this.texture=new Kr(i),this.texture.minFilter=_,this.generateMipmaps=!1}function Ia(){const t=[];this.getAtlas=function(e){const i=JSON.stringify(e);var n=t[i];return void 0===n&&(n=new Na(e),t[i]=n),n}}function Oa(t){const e=new Map,i=t.ctx,n=this;var r=new Ia,s=new Set,a={},o=0;const h=new Ra,l=new Da;this.colourCache=h,this.textureCache=l;const c=i.cfg.value("saturatedGradient",!1)||i.cfg.themeValue("saturatedGradient")?"gradientHi":"gradientLow",u=i.cfg.themeValue("shading.single");this.commonUniforms={fogColor:{value:i.cfg.themeColor("background")},fogDensity:{value:.0025},fogEnabled:{value:0},distanceTransparency:{value:0}},this.commonDepthUniforms={datumShift:{value:0}},this.commonTerrainUniforms={scale:{value:0},accuracy:{value:0},target:{value:new k},ringColor:{value:new Ut(16711680)}},this.terrainOpacity=.5,Object.defineProperty(this,"cursorHeight",{get:function(){return o},set:function(t){s.forEach((function(e){o=e.setCursor(t)}))}});const d=this.commonUniforms.distanceTransparency;function p(t,i,n){var r=e.get("name");return void 0===r&&(r=function(t,i,n){return e.set(t,i),n&&(i.stencilWrite=!0,i.stencilZPass=I),i}(t,i(),n)),r}function f(t,e,i){const n=p(t,e,i);return a[t]=n,n}function m(t){n.commonDepthUniforms.datumShift.value=t.value}Object.defineProperty(this,"distanceTransparency",{get:function(){return d.value},set:function(t){d.value=t}}),this.getLine2Material=function(t=""){const e=f("line2-"+t,(function(){return new Aa(i,t)}),!0);return"cursor"!=t&&"depth-cursor"!=t||s.add(e),e},this.getHeightMaterial=function(t){return f("height"+t,(function(){return new wa(i,t)}),!0)},this.getHypsometricMaterial=function(){return f("hypsometric",(function(){return new Ta(i)}))},this.getDepthMapMaterial=function(t){return new _a(t)},this.getDepthMaterial=function(t){return f("depth"+t,(function(){return new ya(i,t)}),!0)},this.getCursorMaterial=function(t){const e=f("cursor"+t,(function(){return new da(i,t)}),!0);return s.add(e),e},this.getDepthCursorMaterial=function(t){const e=f("depthCursor"+t,(function(){return new xa(i,t)}),!0);return s.add(e),e},this.getBezelMaterial=function(){return p("bezel","flat"===i.cfg.themeValue("hud.bezelType")?function(){return new ei({color:i.cfg.themeValue("hud.bezel")})}:function(){return new ns({color:i.cfg.themeValue("hud.bezel"),specular:8947848})},!0)},this.getPlainMaterial=function(){return p("plain",(function(){return new ei({color:16777215,vertexColors:!0})}),!0)},this.getSurfaceMaterial=function(){return p("surface",(function(){return new is({color:u,vertexColors:!1})}),!0)},this.getLineMaterial=function(){return p("line",(function(){return new Or({color:16777215,vertexColors:!0})}),!0)},this.getExtendedPointsMaterial=function(){return p("extendedPoints",(function(){return new Ma(i)}),!0)},this.getMissingMaterial=function(){return p("missing",(function(){return new La(i)}))},this.getUnselectedMaterial=function(){return p("unselected",(function(){return new Or({color:4473924,vertexColors:!0})}))},this.getUnselectedWallMaterial=function(){return p("unselectedWall",(function(){return new is({color:4473924,vertexColors:!0})}))},this.getScaleMaterial=function(){return p("scale",(function(){return new ei({color:16777215,map:l.getTexture(c)})}))},this.getContourMaterial=function(){return f("contour",(function(){return new va(i)}))},this.getGlyphMaterial=function(e,n){const s=r.getAtlas(e);return p(JSON.stringify(e)+":"+n.toString(),(function(){return new ba(i,s,n,t)}))},this.getClusterMaterial=function(t){return p("cluster"+t,(function(){return new pa(t)}),!0)},this.setTerrain=function(t){t.addEventListener("datumShiftChange",m)},this.flushCache=function(){var t;for(t in s.clear(),a){a[t].dispose(),e.delete(t)}a={},i.glyphStringCache=new Map,o=0},this.setFog=function(t){n.commonUniforms.fogEnabled.value=t?1:0}}function Fa(t,e,i){this.colorMatrixLeft=(new B).fromArray([1.0671679973602295,-.0016435992438346148,.0001777536963345483,-.028107794001698494,-.00019593400065787137,-.0002875397040043026,-.04279090091586113,15809757314855233e-21,-.00024287120322696865]),this.colorMatrixRight=(new B).fromArray([-.0355340838432312,-.06440307199954987,.018319187685847282,-.10269022732973099,.8079727292060852,-.04835830628871918,.0001224992738571018,-.009558862075209618,.567823588848114]);var n=new fs(-1,1,1,-1,0,1),r=new Ir,s=new _s;s.cameraL.layers.mask=4294967295,s.cameraR.layers.mask=4294967295;var a={minFilter:_,magFilter:x,format:A};void 0===e&&(e=512),void 0===i&&(i=512);var o=t.getPixelRatio(),h=new q(e*o,i*o,a),l=new q(e*o,i*o,a),c=new Ie({uniforms:{mapLeft:{value:h.texture},mapRight:{value:l.texture},colorMatrixLeft:{value:this.colorMatrixLeft},colorMatrixRight:{value:this.colorMatrixRight}},vertexShader:ua.anaglyphVertexShader,fragmentShader:ua.anaglyphFragmentShader}),u=new xi(new Ce(2,2),c);r.add(u),this.setLayers=function(t){s.cameraL.layers.mask=t,s.cameraR.layers.mask=t},this.setSize=function(e,i){t.setSize(e,i);var n=t.getPixelRatio();h.setSize(e*n,i*n),l.setSize(e*n,i*n)},this.setEyeSeparation=function(t){s.eyeSep=t},this.render=function(e,i){e.updateMatrixWorld(),null===i.parent&&i.updateMatrixWorld(),s.update(i),t.setRenderTarget(h),t.clear(),t.render(e,s.cameraL),t.setRenderTarget(l),t.clear(),t.render(e,s.cameraR),t.setRenderTarget(null),t.render(r,n)},this.dispose=function(){h&&h.dispose(),l&&l.dispose(),c&&c.dispose(),u&&u.geometry.dispose()}}function Ua(t,e,i){const n=t.container;var r=n.clientWidth,s=n.clientHeight,a=n.getBoundingClientRect();const o=new fs(-r/2,r/2,s/2,-s/2,1,4e3),h=new Ri(t.cfg.themeValue("fieldOfView"),r/s,1,16e3),l=new k,c=this;i.add(h),i.add(o),v(h),v(o),this.activeCamera=h,this.mode=2;const u=new ei({side:1,colorWrite:!1});var d,p=.5,f=0;t.viewer.addEventListener("resized",(function(t){r=t.width,s=t.height,a=n.getBoundingClientRect(),o.zoom*=r/(o.right-o.left),o.left=-r/2,o.right=r/2,o.top=s/2,o.bottom=-s/2,o.updateProjectionMatrix(),h.aspect=r/s,h.updateProjectionMatrix(),null!==c.activeEffect&&c.activeEffect.setSize(r,s)}));const m=function(){e.render(i,c.activeCamera),e.getContext().flush(),f=e.info.render.frame},g=function(){const t=c.activeCamera;c.testCameraLayer(7)&&(t.layers.mask=129,i.overrideMaterial=u,e.render(i,t),i.overrideMaterial=null,t.layers.mask=d),e.render(i,t),e.getContext().flush(),f=e.info.render.frame};function v(t){t.zoom=1,t.layers.set(0),t.layers.enable(1),t.layers.enable(5)}this.maskedTerrain=!0,this.activeRenderer=g,this.activeEffect=null,this.resetCameras=function(){v(h),v(o)},this.setCameraLayer=function(t,e){e?(h.layers.enable(t),o.layers.enable(t)):(h.layers.disable(t),o.layers.disable(t)),d=this.activeCamera.layers.mask,null!==this.activeEffect&&this.activeEffect.setLayers(d)},this.testCameraLayer=function(t){return(d&1<<t)>0},this.setCamera=function(t,n){if(this.mode===t)return;var a,l=this.activeCamera;const u=l.position.clone().sub(n);null!==this.activeEffect&&this.activeEffect.dispose();var d=null;switch(t){case 3:if(d=new Fa(e,r,s),l.isPerspective)break;case 2:a=4*s*Math.tan(z.DEG2RAD*h.fov/2)/o.zoom/2,u.setLength(a),l=h;break;case 1:a=u.length(),o.zoom=2*s*Math.tan(z.DEG2RAD*h.fov/2)/a,l=o;break;default:return void console.warn("unknown camera mode",t)}null!==d?(d.setLayers(l.layers.mask),this.activeRenderer=function(){d.render(i,c.activeCamera)}):this.maskedTerrain?this.activeRenderer=g:this.activeRenderer=m,l.position.copy(u.add(n)),l.updateProjectionMatrix(),l.lookAt(n),this.activeCamera=l,this.activeEffect=d,this.mode=t},this.getLastFrame=function(){return f},this.getMouse=function(t,e){return l.set((t-a.left)/n.clientWidth*2-1,-(e-a.top)/n.clientHeight*2+1),l},Object.defineProperties(this,{eyeSeparation:{get:function(){return p},set:function(t){p=t,null!==this.activeEffect&&this.activeEffect.setEyeSeparation(.064+.06*(t-.5))}},focalLength:{get:function(){return h.getFocalLength()},set:function(t){h.setFocalLength(t)}}})}function za(t,e){const i=t.cfg,n=new J,r=new J,s=new gs(16777215),a=new vs(16777215,.3),o=i.themeAngle("lighting.inclination"),h=i.themeAngle("lighting.azimuth")-Math.PI/2;n.setFromSpherical(new Ps(1,o,h)),n.applyAxisAngle(new J(1,0,0),Math.PI/2),r.copy(n),s.position.copy(n),e.addStatic(s),e.addStatic(a),this.setRotation=function(t){r.copy(n),r.applyAxisAngle(ve.DefaultUp,t.z),s.position.copy(r),s.updateMatrix()},Object.defineProperty(this,"directionalLighting",{get:function(){return s.visible},set:function(t){s.visible=t,a.intensity=t?.3:1}})}Na.prototype.addGlyphToCanvas=function(t,e){const i=this.divisions,n=this.ctx,r=this.cellSize,s=n.measureText(t).width/r,a=Math.floor(e/i)+1,o=e%i,h={row:(i-a)/i,column:o/i,width:s};return this.map[t]=h,n.fillText(t,r*o,r*a-7),h},Na.prototype.getTexture=function(){return this.texture},Na.prototype.getGlyph=function(t){var e=this.map[t];if(void 0===e){if(this.glyphCount+1>this.divisions*this.divisions)return void console.warn("too many glyphs for atlas when adding ["+t+"]");e=this.addGlyphToCanvas(t,this.glyphCount++),this.texture.needsUpdate=!0}return e};const ka=new J,Ba=new wt,Ga=new te;function Ha(t,e){this.controls=t,this.renderFunction=e,this.endCameraPosition=new J,this.endPOI=new J,this.endZoom=1,this.endQuaternion=new Z,this.frameCount=0,this.skipNext=!1,this.rotation=0,this.delta=0,this.running=!1,this.animationFunction=null,this.rafID=0,this.doAnimate=this.animate.bind(this)}function Va(t,e){return void 0===t?"file set":t.split(".").shift()+"."+e}function Wa(t){return"data:text/json;charset=utf8,"+encodeURIComponent(JSON.stringify(t,null,"\t"))}Ha.fitBox=function(t,e,i){const n=e.getSize(ka);var r,s,a,o=600,h=1;if(void 0===i||0!==i.z?(r=n.x,s=n.y,a=n.z):0!==i.x?(r=n.y,s=n.z,a=n.x):(r=n.x,s=n.z,a=n.y),t.isPerspectiveCamera){const e=2*Math.tan(.5*z.DEG2RAD*t.getEffectiveFOV()),i=s/e,n=1/t.aspect*r/e;0===(o=1.1*Math.max(i,n)+a/2)&&(o=100)}else{const e=(t.right-t.left)/r,i=(t.top-t.bottom)/s;h=1*Math.min(e,i)/1.1}return{zoom:h,elevation:o}},Ha.prototype.getCardinalAxis=function(t){this.controls.cameraManager.activeCamera.getWorldDirection(ka);const e=Math.abs(ka.x),i=Math.abs(ka.y),n=Math.abs(ka.z);e>i&&e>n?t.set(Math.sign(ka.x),0,0):i>n?t.set(0,Math.sign(ka.y),0):t.set(0,0,Math.sign(ka.z))},Ha.prototype.prepareRotation=function(t,e){const i=this.controls.cameraManager.activeCamera;ka.copy(t).sub(this.endPOI).normalize();const n=ka.dot(ve.DefaultUp);Math.abs(n)>.99999&&void 0!==e&&t.add(e.multiplyScalar(.02*ka.z)),Ba.lookAt(t,this.endPOI,ve.DefaultUp),this.endQuaternion.setFromRotationMatrix(Ba).normalize(),this.rotation=Math.round(2*Math.acos(Math.abs(z.clamp(this.endQuaternion.dot(i.quaternion),-1,1)))*z.RAD2DEG)},Ha.prototype.prepare=function(){const t=new J,e=new J;return function(i,n){if(this.running)return this;const r=this.controls.cameraManager.activeCamera,s=this.endPOI,a=r.position,o=this.endCameraPosition;if(this.skipNext=!1,void 0===n){if(this.getCardinalAxis(t),0!==t.z){Ga.setFromQuaternion(r.quaternion);switch(Math.round(2*(Ga.z+Math.PI)/Math.PI)){case 0:case 4:e.set(0,1,0);break;case 1:e.set(-1,0,0);break;case 2:e.set(0,-1,0);break;case 3:e.set(1,0,0);break;default:e.set(0,-1,0)}}}else t.copy(n),e.set(0,-1,0);const h=Ha.fitBox(r,i,t);i.getCenter(s),this.endZoom=h.zoom,o.copy(s).add(t.negate().multiplyScalar(h.elevation));const l=a.distanceTo(o);return this.prepareRotation(o,e),l<.1*o.z?this.skipNext=0===this.rotation:this.rotation=0,this.animationFunction=this.animateMove,this}}(),Ha.prototype.preparePoint=function(t){if(this.running)return this;const e=this.controls.cameraManager.activeCamera;return this.endPOI.copy(t),this.endCameraPosition.copy(e.position),this.prepareRotation(e.position),this.skipNext=0===this.rotation,this.animationFunction=this.animateMove,this},Ha.prototype.prepareSimpleMove=function(t){return this.running||(this.endCameraPosition.copy(t),this.animationFunction=this.animateSimpleMove,this.skipNext=!1),this},Ha.prototype.start=function(t){if(this.running||this.skipNext)return;const e=this.controls;this.frameCount=t?this.rotation>0?Math.max(1,Math.round(this.rotation/2)):30:1,e.enabled=!1,this.running=!0,this.animate()},Ha.prototype.cancel=function(){0!==this.rafID&&window.cancelAnimationFrame(this.rafID),this.running&&(this.frameCount=1,this.running=!1,this.rafID=0,this.animate(),this.controls.enabled=!0,this.controls.autoRotate=!1)},Ha.prototype.animate=function(){const t=this.controls;t.autoRotate?t.update():this.animationFunction&&(this.animationFunction(),0==--this.frameCount&&(this.animationFunction=null,this.endAnimation())),this.running&&(this.rafID=window.requestAnimationFrame(this.doAnimate))},Ha.prototype.endAnimation=function(){const t=this.controls,e=t.cameraManager.activeCamera;t.target.copy(this.endPOI),this.rotation>0&&e.position.copy(this.endCameraPosition),this.running=!1,this.rotation=0,this.rafID=0,t.update(),t.enabled=!0,t.end()},Ha.prototype.animateMove=function(){const t=this.controls.cameraManager.activeCamera,e=this.controls.target,i=1-(this.frameCount-1)/this.frameCount;this.rotation||(t.position.lerp(this.endCameraPosition,i),t.zoom=t.zoom+(this.endZoom-t.zoom)*i,t.isOrthographicCamera&&t.updateProjectionMatrix(),t.lookAt(e.lerp(this.endPOI,i))),t.quaternion.slerp(this.endQuaternion,i),this.renderFunction()},Ha.prototype.animateSimpleMove=function(){const t=this.controls.cameraManager.activeCamera,e=1-(this.frameCount-1)/this.frameCount;t.position.lerp(this.endCameraPosition,e),this.renderFunction()},Ha.prototype.setAngleCommon=function(t){this.frameCount=Math.max(1,Math.round(90*Math.abs(t)/Math.PI)),this.delta=t/this.frameCount,this.running=!0,this.animate()},Ha.prototype.setAzimuthAngle=function(t){const e=this.controls;if(this.running||e.autoRotate)return this;var i=e.getAzimuthalAngle()-t,n=Math.abs(i);n>Math.PI&&(i=2*Math.PI-n),this.animationFunction=this.animateAzimuthMove,this.setAngleCommon(i)},Ha.prototype.animateAzimuthMove=function(){this.controls.rotateLeft(this.delta)},Ha.prototype.setPolarAngle=function(t){if(this.running)return this;this.animationFunction=this.animatePolarMove,this.setAngleCommon(this.controls.getPolarAngle()-t)},Ha.prototype.animatePolarMove=function(){this.controls.rotateUp(this.delta)},Ha.prototype.setAutoRotate=function(t){const e=this.controls;if(t){if(this.running)return;e.autoRotate=!0,this.running=!0,this.animationFunction=!1,this.animate()}else e.autoRotate&&(this.running=!1),e.autoRotate=!1,e.enabled=!0,this.rafID=0};class ja extends J{constructor(t,e,i){super(t,e,i)}}function Xa(t){this.fileName=t,this.groups=[],this.section=null}ja.scaleFactor=1,Object.assign(ja.prototype,J.prototype),ja.prototype.connections=0,ja.prototype.splays=0,ja.prototype.correctedDistanceTo=function(t){return Math.sqrt(this.correctedDistanceToSquared(t))},ja.prototype.correctedDistanceToSquared=function(t){var e=this.x-t.x,i=this.y-t.y,n=(this.z-t.z)*ja.scaleFactor;return e*e+i*i+n*n},Xa.prototype.constructor=Xa,Xa.prototype.type="arraybuffer",Xa.prototype.parse=function(t,e,i,n){t.metadata=i,this.section=n,this.groups=[],this.cave=t,this.stationMap=new Map,this.dataStream=e;var r=0;o(),this.version=o();const s=h();o();var a=void 0===s[1]?null:s[1];return console.log("Survex .3d version ",this.version),this.pos=r,t.setCRS(a).then(this.parse2.bind(this));function o(){return h()[0]}function h(){const t=new Uint8Array(e,0),i=[];var n,s=[];do{10===(n=t[r++])||0===n?(i.push(String.fromCharCode.apply(null,s).trim()),s=[]):s.push(n)}while(10!=n);return i}},Xa.prototype.parse2=function(){const t=this.cave;var e=this.pos;switch(this.version){case"Bv0.01":this.handleOld(this.dataStream,e,1);break;case"v3":case"v4":case"v5":case"v6":case"v7":case"v8":this.handleVx(this.dataStream,e,Number(this.version.charAt(1)),this.section);break;default:throw new Error("unsupported .3d version "+this.version)}return null!==this.section&&t.surveyTree.trim(this.section.split(".")),t.addStations(this.stationMap),t.addLineSegments(this.groups),t},Xa.prototype.handleOld=function(t,e,i){const n=this.cave,r=n.surveyTree,s=n.projection,a=n.limits,o=this.groups,h=this.stationMap,l=[],c=new Map,u=new DataView(t,0),d=new Uint8Array(t,0),p=d.length;var f,m,g,v,y="",x=[],_=new ja;function M(t){throw new Error("unhandled command: "+t.toString(16)+" @ "+e.toString(16))}for(f=0;f<256;f++)l[f]=M;for(l[0]=b,l[-1]=b,l[1]=function(){return console.log("SKIP"),!1},l[2]=w,l[3]=w,l[4]=function(){const t=T();if(_=t,1===i&&2===u.getInt32(e,!0))return!0;x.length>1&&o.push(x);return(x=[]).push({coords:t}),!0},l[5]=function(){const t=T();return x.push({coords:t,type:1,survey:0}),_.connections++,t.connections++,_=t,!0},l[6]=function(){return console.log("LABEL_V2"),!1},l[7]=function(){return console.log("LABEL_V3"),!1},f=64;f<128;f++)l[f]=S;for(f=128;f<256;f++)l[f]=E;if(1===i)for(;e<p;){const t=u.getInt32(e,!0);if(e+=4,!l[t]())break}else for(alert("Unsupported version"+i);e<p&&l[d[e]](d[e++]););for(o.push(x),f=0,g=o.length;f<g;f++){const t=o[f];for(m=0,v=t.length;m<v;m++){const e=t[m],i=e.coords,n=c.get(i);void 0!==n&&(e.survey=n.parent.id)}}function b(){return!0}function w(){const t=[];for(var i=d[e++];10!==i;)t.push(i),i=d[e++];92===t[0]&&t.shift(),y=String.fromCharCode.apply(null,t);var n=r.addLeaf(y.split("."),{p:_,type:0});return c.set(_,n),!0}function S(){return console.log("LABEL_V4"),!1}function E(){return console.log("LINE_V2"),!1}function T(){const i=new DataView(t,e);var n=new ja(i.getInt32(0,!0)/100,i.getInt32(4,!0)/100,i.getInt32(8,!0)/100);e+=12;const r=n.x+","+n.y+","+n.z,o=h.get(r);if(void 0!==o)n=o;else{if(null!==s){const t=s.forward({x:n.x,y:n.y});n.x=t.x,n.y=t.y}a.expandByPoint(n),h.set(r,n)}return n}},Xa.prototype.handleVx=function(t,e,i,n){const r=this.cave,s=r.surveyTree,a=r.messages,o=r.projection,h=r.limits,l=this.groups,c=[],u=this.stationMap,d=[],p=new Map,f=new Uint8Array(t,0),m=new DataView(t,0),g=f.length;var v,y,x,_=[],M="",b=[],w=0,S=!1,E=new ja,T=null,L=new J,C=!1,A=null===n,P=!1;function R(t){throw new Error("unhandled command: "+t.toString(16)+" @ "+e.toString(16))}for(v=0;v<256;v++)d[v]=R;if(8===i){for(d[0]=O,d[1]=O,d[2]=O,d[3]=O,d[4]=O,d[15]=z,d[16]=F,d[17]=function(){return e+=2,!0},d[18]=function(){return e+=3,!0},d[19]=function(){return e+=4,!0},d[31]=k,d[48]=G,d[49]=G,d[50]=H,d[51]=H,v=64;v<128;v++)d[v]=U;for(v=128;v<256;v++)d[v]=B;x=function(t){if(32&t)return!1;var i=f[e++],r=0,s=0;0!==i?(s=i>>4,r=15&i):(255!==(i=f[e++])?s=i:(s=m.getUint32(e,!0),e+=4),255!==(i=f[e++])?r=i:(r=m.getUint32(e,!0),e+=4));if(0===r&&0===s)return;s&&(M=M.slice(0,-s));r&&(M+=String.fromCharCode.apply(null,f.subarray(e,e+=r)));C=!0,null!==n&&(A=M.startsWith(n));return},e++}else{for(v=1;v<15;v++)d[v]=N;for(d[15]=z,v=16;v<32;v++)d[v]=I;for(d[0]=function(){M&&(M="");return!0},d[32]=function(){return e+=2,!0},d[33]=function(){return e+=3,!0},d[35]=function(){return e+=4,!0},d[36]=F,d[34]=k,d[48]=G,d[49]=G,d[50]=H,d[51]=H,v=64;v<128;v++)d[v]=B;for(v=128;v<192;v++)d[v]=U;x=function(){var t=0;switch(f[e]){case 254:t=m.getUint16(e,!0)+f[e],e+=2;break;case 255:t=m.getUint32(e,!0),e+=4;break;default:t=f[e++]}if(0===t)return;M+=String.fromCharCode.apply(null,f.subarray(e,e+=t)),C=!0,null!==n&&(A=M.startsWith(n));return}}for(i>=4&&i<=6&&(d[32]=function(){return e+=4,!0},d[33]=function(){return e+=8,!0});e<g&&d[f[e]](f[e++]););b.length>1&&c.push(b);const D=r.xGroups;for(v=0;v<c.length;v++){const t=c[v];if(t.length<2)continue;const e=t[0],i=t[1],n=e.end,r=i.end,s=(new J).copy(n).multiplyScalar(2).sub(r);e.start=s,D.push(t)}return u.forEach((function(t){h.expandByPoint(t)})),void l.push(_);function N(t){"."===(M=M.slice(0,-16)).charAt(M.length-1)&&(M=M.slice(0,-1));const e=M.split(".");return e.splice(-t),(M=e.join("."))&&(M+="."),C=!0,!0}function I(t){const e=t-15;return M=M.slice(0,-e),C=!0,!0}function O(){return!0}function F(){return!0}function U(t){const i=63&t;if(x(i),C&&""!==M&&(w=s.addPath(M).id,C=!1),A){S&&(_.push({coords:E}),S=!1);const t=W();if(t===E)return!0;1&i?_.push({coords:t,type:3,survey:w}):4&i?(E.splays++,_.push({coords:t,type:2,survey:w}),t.splays=-1):(E.connections++,t.connections++,_.push({coords:t,type:1,survey:w})),E=t}else S&&(j(),S=!1),e+=12;return!0}function z(){return _.length>1&&l.push(_),_=[],!A&&S&&j(),E=W(),S=!0,!0}function k(){return e+=20,!0}function B(t){const i=127&t;if(x(0),!(14&i)||32&i||!A)return e+=12,!0;const n=W();var r=M.split(".");return p.set(M,n),s.addLeaf(r,{p:n,type:4&i?1:0}),!0}function G(i){const n=1&i;x(n);const r=new DataView(t,e);return e+=8,V(n,{l:r.getInt16(0,!0)/100,r:r.getInt16(2,!0)/100,u:r.getInt16(4,!0)/100,d:r.getInt16(6,!0)/100})}function H(i){const n=1&i;x(n);const r=new DataView(t,e);return e+=16,V(n,{l:r.getInt32(0,!0)/100,r:r.getInt32(0,!0)/100,u:r.getInt32(0,!0)/100,d:r.getInt32(0,!0)/100})}function V(t,e){if(null!==n&&!M.startsWith(n))return!0;const i=p.get(M);if(!i)return!0;const r=M.split(".");r.pop();const o=s.getIdByPathArray(r);b.push({start:L,end:i,lrud:e,survey:o,type:2});var h=!1;return t?h=!0:1===i.connections&&b.length>1&&0==!E.connections?(y={station:M,text:"LRUD fault"},0===i.splays?(h=!0,a.push(y)):P=!0):P&&0!==i.connections&&(a.push(y),P=!1),h?(b.length>0&&c.push(b),L=new J,b=[],P=!1):L=i,!0}function W(){const i=new DataView(t,e);T=String.fromCharCode.apply(null,f.subarray(e,e+12));var n=new ja(i.getInt32(0,!0)/100,i.getInt32(4,!0)/100,i.getInt32(8,!0)/100);e+=12;const r=u.get(T);if(void 0!==r)n=r;else{if(null!==o){const t=o.forward({x:n.x,y:n.y});n.x=t.x,n.y=t.y}u.set(T,n)}return n}function j(){E.connections||u.delete(T)}},Xa.prototype.getLineSegments=function(){const t=[],e=this.groups;for(var i=0,n=e.length;i<n;i++){const n=e[i];for(var r=0,s=n.length-1;r<s;r++){const e=n[r],i=n[r+1],s=e.coords,a=i.coords;t.push({from:s,to:a,type:i.type,survey:i.survey})}}return t},Xa.prototype.getTerrainDimensions=function(){return{lines:0,samples:0}},Xa.prototype.getTerrainBitmap=function(){return!1};var qa=0;function Ya(t){this.fileName=t}Ya.prototype.constructor=Ya,Ya.prototype.type="arraybuffer",Ya.prototype.parse=function(t,e,i,n){qa+=1e5,t.metadata=i,t.setCRS(null);const r=t.lineSegments,s=t.surveyTree,a=t.limits,o=t.projection,h=[],l={},c=null!==o,u=new TextDecoder("utf-8");var d=e;const p=d.byteLength,f=qa,m=[];for(var g,v,y,x=0,_=new DataView(d,0),M=0;x<p;)b();return d=null,t.addStations(m),t.addXsects(h),Promise.resolve(t);function b(){const t=w(),e=w(),i=w(),n=w();var r;switch(g=x+e,t){case 1:r=L;break;case 2:r=C;break;case 3:r=A;break;case 4:r=D;break;case 5:r=N;break;case 6:r=O;break;default:throw new Error("unknown chunk header. type : ",t)}for(var s=0;s<i;s++)r();x+=n}function w(){const t=_.getUint32(x,!0);return x+=4,t}function S(){const t=_.getFloat64(x,!0);return x+=8,t}function E(){return{position:w(),size:w()}}function T(t){const e=new Uint8Array(d,g+t.position,t.size-1);return u.decode(e)}function L(){const t=w(),e=E(),i=w(),r=E();if(v!==i&&(y=s.findById(void 0===v?0:i+f),v=i,void 0===y&&(y=s)),i!=t){const i=y.addById(T(e),t+f);if(null===i)throw new Error("error constructing survey tree for",T(r));null!==n&&i.getPath()===n&&(M=t)}}function C(){const t=w(),e=w(),i=E(),n=E(),r=w(),h=function(){const t=new ja(S(),S(),S());if(null!==o){const e=o.forward({x:t.x,y:t.y});t.x=e.x,t.y=e.y}return a.expandByPoint(t),t}();m[t]=h,v!==e&&(y=s.findById(e+f),v=e);const l=0===i.size?"["+t+"]":T(i),c={p:h,type:2&r?1:0};n.size>0&&(c.comment=T(n)),y.addById(l,-(t+f),c)}function A(){const t=w(),e=w();var i,n,s,a;e>t?(i=t,n=e,s=P(),a=P()):(i=e,n=t,a=R(),s=R());const o=w(),l=w(),c=w();if(x+=8,0!==M&&c!==M)return;var u=1;1&o&&(u=3),8&o&&(u=2);const d=m[i],p=m[n],g=c+f;0!==l&&1===u&&h.push({m_from:i,m_to:n,start:d,end:p,fromLRUD:s,lrud:a,survey:g,type:l}),d.equals(p)||(1===u&&(d.connections++,p.connections++),r.push({from:d,to:p,type:u,survey:g}))}function P(){return{l:S(),r:S(),u:S(),d:S()}}function R(){return{r:S(),l:S(),u:S(),d:S()}}function D(){w();const e=w(),i=w(),n=E(),r=w(),s=E(),a={vertices:[],faces:[],survey:e+f};var o,h,l;if(0===M||e===M){for(h=0;h<i;h++){const t=g+n.position+24*h,e=new DataView(d,t);a.vertices.push(new J(e.getFloat64(0,!0),e.getFloat64(8,!0),e.getFloat64(16,!0)))}for(h=0;h<r;h++){const t=g+s.position+12*h,e=new DataView(d,t),i=[e.getUint32(0,!0),e.getUint32(4,!0),e.getUint32(8,!0)];t:if(void 0!==o){for(l=0;l<3;l++)if(i[l]==o[(l+2)%3]&&i[(l+1)%3]==o[(l+3)%3]){i.reverse();break t}for(l=0;l<3;l++)if(i[l]==o[l]&&i[(l+1)%3]==o[(l+1)%3]){i.reverse();break t}for(l=0;l<3;l++)if(i[l]==o[(l+1)%3]&&i[(l+1)%3]==o[(l+2)%3]){i.reverse();break t}}a.faces.push(i),o=i}t.scraps.push(a)}}function N(){w();const e=w(),i=w(),n=E(),r=I();if(c)return;const s=d.slice(x,x+n.size),a=new Float64Array(s,0);l.dtm={data:a,samples:e,lines:i,calib:r},t.terrains.push(l),t.hasTerrain=!0}function I(){return{xOrigin:S(),yOrigin:S(),xx:S(),xy:S(),yx:S(),yy:S()}}function O(){w(),w();const t=E(),e=I();c||(l.bitmap={image:F(t),calib:e})}function F(t){const e=new Uint8Array(d,g+t.position,t.size),i=e[0],n=e[1];var r;if(255===i&&216===n)r="image/jpeg";else{if(137!==i||80!==n)return"";r="image/png"}const s=new Blob([e],{type:r});return URL.createObjectURL(s)}};const Za=12*.0254;function Ja(t){this.fileName=t}function Qa(t,e,i,n){void 0===i?(this.id=0,this.maxId=0,this.root=this,this.parent=null,this.pathCache=[]):(this.root=i,this.parent=n,this.id=null===e?++i.maxId:e,n.children.push(this)),this.name=t||"",this.children=[]}Ja.prototype.constructor=Ja,Ja.prototype.type="text",Ja.prototype.parse=function(t,e,i){t.metadata=i,t.setCRS(null);const n=t.surveyTree,r=t.limits,s=t.projection,a=new Map,o=[],h=[],l=[],c=e.split(/[\n\r]+/),u=c.length;var d,p,f,m,g,v,y=[],x=[],_=0,M=-1,b="root";for(m=0;m<u;m++){const t=c[m].split(/\s+/),e=t[0].charAt(0);switch(e){case"M":x.length>1&&l.push(x),x=[],M=-1;case"D":if(d=t[4].substring(1),y[2]=d,g=(v=S(t)).stationIndex,x.push({coords:v,type:1,survey:_}),0===v.connections){const e={p:v,type:0};void 0!==t[13]&&(e.comment=t.slice(13).join(" ")),n.addLeaf(y,e)}if(v.connections++,"P"===t[5]){let e=+t[6],i=+t[7],n=+t[8],r=+t[9],s=0;if(e<0&&(e=0,s++),i<0&&(i=0,s++),n<0&&(n=0,s++),r<0&&(r=0,s++),4!==s){f={l:e*Za,u:i*Za,d:n*Za,r:r*Za};var w=-1!==M?h[M]:null;o.push({m_from:M,m_to:g,start:w,end:v,lrud:f,survey:_,type:2})}M=g}break;case"N":y=[b,p=t[0].substring(1)],_=n.addPath(b+"."+p).id;break;case"Z":break;case"F":case"L":case"X":case"O":case"G":case"P":case"R":case"C":case"":break;case"S":b=c[m].substring(1);break;default:console.log("unknown command ",e)}}return x.length>1&&l.push(x),t.addStations(h),t.addLineSegments(l),t.addXsects(o),Promise.resolve(t);function S(t){const e=t[1]+":"+t[2]+":"+t[3],i=a.get(e);var n;if(void 0!==i)n=i;else{if(n=new ja(+t[2]*Za,+t[1]*Za,+t[3]*Za),null!==s){const t=s.forward({x:n.x,y:n.y});n.x=t.x,n.y=t.y}n.stationIndex=h.length,h.push(n),a.set(e,n),r.expandByPoint(n)}return n}},Qa.prototype.sorted=!1,Qa.prototype.traverse=function(t){const e=this.children;t(this);for(var i=0;i<e.length;i++)e[i].traverse(t)},Qa.prototype.traverseDepthFirst=function(t){const e=this.children;for(var i=0;i<e.length;i++)e[i].traverseDepthFirst(t);t(this)},Qa.prototype.forEachChild=function(t){const e=this.children;for(var i=0;i<e.length;i++)t(e[i])},Qa.prototype.addById=function(t,e,i){const n=this.root,r=new Qa(t,e,n,this);return void 0!==i&&Object.assign(r,i),n.maxId=Math.max(n.maxId,e),r},Qa.prototype.findById=function(t){if(this.id==t)return this;for(var e=0,i=this.children.length;e<i;e++){const i=this.children[e].findById(t);if(i)return i}},Qa.prototype.getByPath=function(t){const e=t.split("."),i=this.getByPathArray(e);return 0===e.length?i:void 0},Qa.prototype.getByPathArray=function(t){for(var e=this.root,i=!0;i&&t.length>0;){i=!1;for(var n=0,r=e.children.length;n<r;n++){const r=e.children[n];if(r.name===t[0]){e=r,t.shift(),i=!0;break}}}return e},Qa.prototype.addLeaf=function(t,e){if(1===t.length){const i=new Qa(t[0],null,this.root,this);return void 0!==e&&Object.assign(i,e),i}for(var i,n=[];void 0===i&&t.length>1;)n.unshift(t.pop()),i=this.root.pathCache[t.join(".")];if(void 0!==i){const t=new Qa(n.join("."),null,this.root,i);return void 0!==e&&Object.assign(t,e),t}if(t=t.concat(n),i=this.getByPathArray(t),0===t.length)return i;for(;t.length>0;){i=new Qa(t.shift(),null,this.root,i)}return void 0!==e&&Object.assign(i,e),i},Qa.prototype.addPath=function(t){var e=t.split("."),i=this.getByPathArray(e);if(0===e.length)return i;for(;e.length>0;){const t=new Qa(e.shift(),null,this.root,i);this.root.pathCache[t.getPath()]=t,i=t}return i},Qa.prototype.getPath=function(t){const e=[];var i=this;void 0===t&&(t=this.root);do{e.push(i.name),i=i.parent}while(i!==t&&null!==i);return e.reverse().join(".")},Qa.prototype.getSubtreeIds=function(t){return this.traverse((function(e){t.add(e.id)})),t},Qa.prototype.getIdByPath=function(t){return this.getIdByPathArray(t.split("."))},Qa.prototype.getIdByPathArray=function(t){const e=this.getByPathArray(t);return 0===t.length?e.id:void 0},Qa.prototype.trim=function(t){const e=t.shift(),i=this.children;var n;if(void 0!==e){for(var r=0;r<i.length&&(n=i[r]).name!==e;r++);this.children=[n],n.trim(t)}},Qa.prototype.isStation=function(){return void 0!==this.p};var Ka=6378137,$a=.0066943799901413165,to=484813681109536e-20,eo=Math.PI/2,io=1e-10,no=.017453292519943295,ro=57.29577951308232,so=Math.PI/4,ao=2*Math.PI,oo=3.14159265359,ho={greenwich:0,lisbon:-9.131906111111,paris:2.337229166667,bogota:-74.080916666667,madrid:-3.687938888889,rome:12.452333333333,bern:7.439583333333,jakarta:106.807719444444,ferro:-17.666666666667,brussels:4.367975,stockholm:18.058277777778,athens:23.7163375,oslo:10.722916666667},lo={ft:{to_meter:.3048},"us-ft":{to_meter:1200/3937}},co=/[\s_\-\/\(\)]/g;function uo(t,e){if(t[e])return t[e];for(var i,n=Object.keys(t),r=e.toLowerCase().replace(co,""),s=-1;++s<n.length;)if((i=n[s]).toLowerCase().replace(co,"")===r)return t[i]}function po(t){var e,i,n,r={},s=t.split("+").map((function(t){return t.trim()})).filter((function(t){return t})).reduce((function(t,e){var i=e.split("=");return i.push(!0),t[i[0].toLowerCase()]=i[1],t}),{}),a={proj:"projName",datum:"datumCode",rf:function(t){r.rf=parseFloat(t)},lat_0:function(t){r.lat0=t*no},lat_1:function(t){r.lat1=t*no},lat_2:function(t){r.lat2=t*no},lat_ts:function(t){r.lat_ts=t*no},lon_0:function(t){r.long0=t*no},lon_1:function(t){r.long1=t*no},lon_2:function(t){r.long2=t*no},alpha:function(t){r.alpha=parseFloat(t)*no},lonc:function(t){r.longc=t*no},x_0:function(t){r.x0=parseFloat(t)},y_0:function(t){r.y0=parseFloat(t)},k_0:function(t){r.k0=parseFloat(t)},k:function(t){r.k0=parseFloat(t)},a:function(t){r.a=parseFloat(t)},b:function(t){r.b=parseFloat(t)},r_a:function(){r.R_A=!0},zone:function(t){r.zone=parseInt(t,10)},south:function(){r.utmSouth=!0},towgs84:function(t){r.datum_params=t.split(",").map((function(t){return parseFloat(t)}))},to_meter:function(t){r.to_meter=parseFloat(t)},units:function(t){r.units=t;var e=uo(lo,t);e&&(r.to_meter=e.to_meter)},from_greenwich:function(t){r.from_greenwich=t*no},pm:function(t){var e=uo(ho,t);r.from_greenwich=(e||parseFloat(t))*no},nadgrids:function(t){"@null"===t?r.datumCode="none":r.nadgrids=t},axis:function(t){var e="ewnsud";3===t.length&&-1!==e.indexOf(t.substr(0,1))&&-1!==e.indexOf(t.substr(1,1))&&-1!==e.indexOf(t.substr(2,1))&&(r.axis=t)},approx:function(){r.approx=!0}};for(e in s)i=s[e],e in a?"function"==typeof(n=a[e])?n(i):r[n]=i:r[e]=i;return"string"==typeof r.datumCode&&"WGS84"!==r.datumCode&&(r.datumCode=r.datumCode.toLowerCase()),r}var fo=/\s/,mo=/[A-Za-z]/,go=/[A-Za-z84]/,vo=/[,\]]/,yo=/[\d\.E\-\+]/;function xo(t){if("string"!=typeof t)throw new Error("not a string");this.text=t.trim(),this.level=0,this.place=0,this.root=null,this.stack=[],this.currentObject=null,this.state=1}function _o(t,e,i){Array.isArray(e)&&(i.unshift(e),e=null);var n=e?{}:t,r=i.reduce((function(t,e){return Mo(e,t),t}),n);e&&(t[e]=r)}function Mo(t,e){if(Array.isArray(t)){var i=t.shift();if("PARAMETER"===i&&(i=t.shift()),1===t.length)return Array.isArray(t[0])?(e[i]={},void Mo(t[0],e[i])):void(e[i]=t[0]);if(t.length)if("TOWGS84"!==i){if("AXIS"===i)return i in e||(e[i]=[]),void e[i].push(t);var n;switch(Array.isArray(i)||(e[i]={}),i){case"UNIT":case"PRIMEM":case"VERT_DATUM":return e[i]={name:t[0].toLowerCase(),convert:t[1]},void(3===t.length&&Mo(t[2],e[i]));case"SPHEROID":case"ELLIPSOID":return e[i]={name:t[0],a:t[1],rf:t[2]},void(4===t.length&&Mo(t[3],e[i]));case"PROJECTEDCRS":case"PROJCRS":case"GEOGCS":case"GEOCCS":case"PROJCS":case"LOCAL_CS":case"GEODCRS":case"GEODETICCRS":case"GEODETICDATUM":case"EDATUM":case"ENGINEERINGDATUM":case"VERT_CS":case"VERTCRS":case"VERTICALCRS":case"COMPD_CS":case"COMPOUNDCRS":case"ENGINEERINGCRS":case"ENGCRS":case"FITTED_CS":case"LOCAL_DATUM":case"DATUM":return t[0]=["name",t[0]],void _o(e,i,t);default:for(n=-1;++n<t.length;)if(!Array.isArray(t[n]))return Mo(t,e[i]);return _o(e,i,t)}}else e[i]=t;else e[i]=!0}else e[t]=!0}xo.prototype.readCharicter=function(){var t=this.text[this.place++];if(4!==this.state)for(;fo.test(t);){if(this.place>=this.text.length)return;t=this.text[this.place++]}switch(this.state){case 1:return this.neutral(t);case 2:return this.keyword(t);case 4:return this.quoted(t);case 5:return this.afterquote(t);case 3:return this.number(t);case-1:return}},xo.prototype.afterquote=function(t){if('"'===t)return this.word+='"',void(this.state=4);if(vo.test(t))return this.word=this.word.trim(),void this.afterItem(t);throw new Error("havn't handled \""+t+'" in afterquote yet, index '+this.place)},xo.prototype.afterItem=function(t){return","===t?(null!==this.word&&this.currentObject.push(this.word),this.word=null,void(this.state=1)):"]"===t?(this.level--,null!==this.word&&(this.currentObject.push(this.word),this.word=null),this.state=1,this.currentObject=this.stack.pop(),void(this.currentObject||(this.state=-1))):void 0},xo.prototype.number=function(t){if(!yo.test(t)){if(vo.test(t))return this.word=parseFloat(this.word),void this.afterItem(t);throw new Error("havn't handled \""+t+'" in number yet, index '+this.place)}this.word+=t},xo.prototype.quoted=function(t){'"'!==t?this.word+=t:this.state=5},xo.prototype.keyword=function(t){if(go.test(t))this.word+=t;else{if("["===t){var e=[];return e.push(this.word),this.level++,null===this.root?this.root=e:this.currentObject.push(e),this.stack.push(this.currentObject),this.currentObject=e,void(this.state=1)}if(!vo.test(t))throw new Error("havn't handled \""+t+'" in keyword yet, index '+this.place);this.afterItem(t)}},xo.prototype.neutral=function(t){if(mo.test(t))return this.word=t,void(this.state=2);if('"'===t)return this.word="",void(this.state=4);if(yo.test(t))return this.word=t,void(this.state=3);if(!vo.test(t))throw new Error("havn't handled \""+t+'" in neutral yet, index '+this.place);this.afterItem(t)},xo.prototype.output=function(){for(;this.place<this.text.length;)this.readCharicter();if(-1===this.state)return this.root;throw new Error('unable to parse string "'+this.text+'". State is '+this.state)};function bo(t){return.017453292519943295*t}function wo(t){var e=new xo(t).output(),i=e.shift(),n=e.shift();e.unshift(["name",n]),e.unshift(["type",i]);var r={};return Mo(e,r),function(t){if("GEOGCS"===t.type?t.projName="longlat":"LOCAL_CS"===t.type?(t.projName="identity",t.local=!0):"object"==typeof t.PROJECTION?t.projName=Object.keys(t.PROJECTION)[0]:t.projName=t.PROJECTION,t.AXIS){for(var e="",i=0,n=t.AXIS.length;i<n;++i){var r=t.AXIS[i][0].toLowerCase();-1!==r.indexOf("north")?e+="n":-1!==r.indexOf("south")?e+="s":-1!==r.indexOf("east")?e+="e":-1!==r.indexOf("west")&&(e+="w")}2===e.length&&(e+="u"),3===e.length&&(t.axis=e)}t.UNIT&&(t.units=t.UNIT.name.toLowerCase(),"metre"===t.units&&(t.units="meter"),t.UNIT.convert&&("GEOGCS"===t.type?t.DATUM&&t.DATUM.SPHEROID&&(t.to_meter=t.UNIT.convert*t.DATUM.SPHEROID.a):t.to_meter=t.UNIT.convert));var s=t.GEOGCS;function a(e){return e*(t.to_meter||1)}"GEOGCS"===t.type&&(s=t),s&&(s.DATUM?t.datumCode=s.DATUM.name.toLowerCase():t.datumCode=s.name.toLowerCase(),"d_"===t.datumCode.slice(0,2)&&(t.datumCode=t.datumCode.slice(2)),"new_zealand_geodetic_datum_1949"!==t.datumCode&&"new_zealand_1949"!==t.datumCode||(t.datumCode="nzgd49"),"wgs_1984"!==t.datumCode&&"world_geodetic_system_1984"!==t.datumCode||("Mercator_Auxiliary_Sphere"===t.PROJECTION&&(t.sphere=!0),t.datumCode="wgs84"),"_ferro"===t.datumCode.slice(-6)&&(t.datumCode=t.datumCode.slice(0,-6)),"_jakarta"===t.datumCode.slice(-8)&&(t.datumCode=t.datumCode.slice(0,-8)),~t.datumCode.indexOf("belge")&&(t.datumCode="rnb72"),s.DATUM&&s.DATUM.SPHEROID&&(t.ellps=s.DATUM.SPHEROID.name.replace("_19","").replace(/[Cc]larke\_18/,"clrk"),"international"===t.ellps.toLowerCase().slice(0,13)&&(t.ellps="intl"),t.a=s.DATUM.SPHEROID.a,t.rf=parseFloat(s.DATUM.SPHEROID.rf,10)),s.DATUM&&s.DATUM.TOWGS84&&(t.datum_params=s.DATUM.TOWGS84),~t.datumCode.indexOf("osgb_1936")&&(t.datumCode="osgb36"),~t.datumCode.indexOf("osni_1952")&&(t.datumCode="osni52"),(~t.datumCode.indexOf("tm65")||~t.datumCode.indexOf("geodetic_datum_of_1965"))&&(t.datumCode="ire65"),"ch1903+"===t.datumCode&&(t.datumCode="ch1903"),~t.datumCode.indexOf("israel")&&(t.datumCode="isr93")),t.b&&!isFinite(t.b)&&(t.b=t.a),[["standard_parallel_1","Standard_Parallel_1"],["standard_parallel_2","Standard_Parallel_2"],["false_easting","False_Easting"],["false_northing","False_Northing"],["central_meridian","Central_Meridian"],["latitude_of_origin","Latitude_Of_Origin"],["latitude_of_origin","Central_Parallel"],["scale_factor","Scale_Factor"],["k0","scale_factor"],["latitude_of_center","Latitude_Of_Center"],["latitude_of_center","Latitude_of_center"],["lat0","latitude_of_center",bo],["longitude_of_center","Longitude_Of_Center"],["longitude_of_center","Longitude_of_center"],["longc","longitude_of_center",bo],["x0","false_easting",a],["y0","false_northing",a],["long0","central_meridian",bo],["lat0","latitude_of_origin",bo],["lat0","standard_parallel_1",bo],["lat1","standard_parallel_1",bo],["lat2","standard_parallel_2",bo],["azimuth","Azimuth"],["alpha","azimuth",bo],["srsCode","name"]].forEach((function(e){return function(t,e){var i=e[0],n=e[1];!(i in t)&&n in t&&(t[i]=t[n],3===e.length&&(t[i]=e[2](t[i])))}(t,e)})),t.long0||!t.longc||"Albers_Conic_Equal_Area"!==t.projName&&"Lambert_Azimuthal_Equal_Area"!==t.projName||(t.long0=t.longc),t.lat_ts||!t.lat1||"Stereographic_South_Pole"!==t.projName&&"Polar Stereographic (variant B)"!==t.projName||(t.lat0=bo(t.lat1>0?90:-90),t.lat_ts=t.lat1)}(r),r}function So(t){var e=this;if(2===arguments.length){var i=arguments[1];"string"==typeof i?"+"===i.charAt(0)?So[t]=po(arguments[1]):So[t]=wo(arguments[1]):So[t]=i}else if(1===arguments.length){if(Array.isArray(t))return t.map((function(t){Array.isArray(t)?So.apply(e,t):So(t)}));if("string"==typeof t){if(t in So)return So[t]}else"EPSG"in t?So["EPSG:"+t.EPSG]=t:"ESRI"in t?So["ESRI:"+t.ESRI]=t:"IAU2000"in t?So["IAU2000:"+t.IAU2000]=t:console.log(t);return}}!function(t){t("EPSG:4326","+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees"),t("EPSG:4269","+title=NAD83 (long/lat) +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees"),t("EPSG:3857","+title=WGS 84 / Pseudo-Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs"),t.WGS84=t["EPSG:4326"],t["EPSG:3785"]=t["EPSG:3857"],t.GOOGLE=t["EPSG:3857"],t["EPSG:900913"]=t["EPSG:3857"],t["EPSG:102113"]=t["EPSG:3857"]}(So);var Eo=["PROJECTEDCRS","PROJCRS","GEOGCS","GEOCCS","PROJCS","LOCAL_CS","GEODCRS","GEODETICCRS","GEODETICDATUM","ENGCRS","ENGINEERINGCRS"];var To=["3857","900913","3785","102113"];function Lo(t){if(!function(t){return"string"==typeof t}(t))return t;if(function(t){return t in So}(t))return So[t];if(function(t){return Eo.some((function(e){return t.indexOf(e)>-1}))}(t)){var e=wo(t);if(function(t){var e=uo(t,"authority");if(e){var i=uo(e,"epsg");return i&&To.indexOf(i)>-1}}(e))return So["EPSG:3857"];var i=function(t){var e=uo(t,"extension");if(e)return uo(e,"proj4")}(e);return i?po(i):e}return function(t){return"+"===t[0]}(t)?po(t):void 0}function Co(t,e){var i,n;if(t=t||{},!e)return t;for(n in e)void 0!==(i=e[n])&&(t[n]=i);return t}function Ao(t,e,i){var n=t*e;return i/Math.sqrt(1-n*n)}function Po(t){return t<0?-1:1}function Ro(t){return Math.abs(t)<=oo?t:t-Po(t)*ao}function Do(t,e,i){var n=t*i,r=.5*t;return n=Math.pow((1-n)/(1+n),r),Math.tan(.5*(eo-e))/n}function No(t,e){for(var i,n,r=.5*t,s=eo-2*Math.atan(e),a=0;a<=15;a++)if(i=t*Math.sin(s),s+=n=eo-2*Math.atan(e*Math.pow((1-i)/(1+i),r))-s,Math.abs(n)<=1e-10)return s;return-9999}function Io(t){return t}var Oo=[{init:function(){var t=this.b/this.a;this.es=1-t*t,"x0"in this||(this.x0=0),"y0"in this||(this.y0=0),this.e=Math.sqrt(this.es),this.lat_ts?this.sphere?this.k0=Math.cos(this.lat_ts):this.k0=Ao(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)):this.k0||(this.k?this.k0=this.k:this.k0=1)},forward:function(t){var e,i,n=t.x,r=t.y;if(r*ro>90&&r*ro<-90&&n*ro>180&&n*ro<-180)return null;if(Math.abs(Math.abs(r)-eo)<=io)return null;if(this.sphere)e=this.x0+this.a*this.k0*Ro(n-this.long0),i=this.y0+this.a*this.k0*Math.log(Math.tan(so+.5*r));else{var s=Math.sin(r),a=Do(this.e,r,s);e=this.x0+this.a*this.k0*Ro(n-this.long0),i=this.y0-this.a*this.k0*Math.log(a)}return t.x=e,t.y=i,t},inverse:function(t){var e,i,n=t.x-this.x0,r=t.y-this.y0;if(this.sphere)i=eo-2*Math.atan(Math.exp(-r/(this.a*this.k0)));else{var s=Math.exp(-r/(this.a*this.k0));if(-9999===(i=No(this.e,s)))return null}return e=Ro(this.long0+n/(this.a*this.k0)),t.x=e,t.y=i,t},names:["Mercator","Popular Visualisation Pseudo Mercator","Mercator_1SP","Mercator_Auxiliary_Sphere","merc"]},{init:function(){},forward:Io,inverse:Io,names:["longlat","identity"]}],Fo={},Uo=[];function zo(t,e){var i=Uo.length;return t.names?(Uo[i]=t,t.names.forEach((function(t){Fo[t.toLowerCase()]=i})),this):(console.log(e),!0)}var ko={start:function(){Oo.forEach(zo)},add:zo,get:function(t){if(!t)return!1;var e=t.toLowerCase();return void 0!==Fo[e]&&Uo[Fo[e]]?Uo[Fo[e]]:void 0}},Bo={MERIT:{a:6378137,rf:298.257,ellipseName:"MERIT 1983"},SGS85:{a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},GRS80:{a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},IAU76:{a:6378140,rf:298.257,ellipseName:"IAU 1976"},airy:{a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"},APL4:{a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},NWL9D:{a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},mod_airy:{a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"},andrae:{a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},aust_SA:{a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},GRS67:{a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},bessel:{a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"},bess_nam:{a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},clrk66:{a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"},clrk80:{a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."},clrk58:{a:6378293.645208759,rf:294.2606763692654,ellipseName:"Clarke 1858"},CPM:{a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},delmbr:{a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},engelis:{a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"},evrst30:{a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"},evrst48:{a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"},evrst56:{a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"},evrst69:{a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"},evrstSS:{a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},fschr60:{a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},fschr60m:{a:6378155,rf:298.3,ellipseName:"Fischer 1960"},fschr68:{a:6378150,rf:298.3,ellipseName:"Fischer 1968"},helmert:{a:6378200,rf:298.3,ellipseName:"Helmert 1906"},hough:{a:6378270,rf:297,ellipseName:"Hough"},intl:{a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},kaula:{a:6378163,rf:298.24,ellipseName:"Kaula 1961"},lerch:{a:6378139,rf:298.257,ellipseName:"Lerch 1979"},mprts:{a:6397300,rf:191,ellipseName:"Maupertius 1738"},new_intl:{a:6378157.5,b:6356772.2,ellipseName:"New International 1967"},plessis:{a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},krass:{a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},SEasia:{a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"},walbeck:{a:6376896,b:6355834.8467,ellipseName:"Walbeck"},WGS60:{a:6378165,rf:298.3,ellipseName:"WGS 60"},WGS66:{a:6378145,rf:298.25,ellipseName:"WGS 66"},WGS7:{a:6378135,rf:298.26,ellipseName:"WGS 72"}},Go=Bo.WGS84={a:6378137,rf:298.257223563,ellipseName:"WGS 84"};Bo.sphere={a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"};var Ho={};Ho.wgs84={towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},Ho.ch1903={towgs84:"674.374,15.056,405.346",ellipse:"bessel",datumName:"swiss"},Ho.ggrs87={towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},Ho.nad83={towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},Ho.nad27={nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},Ho.potsdam={towgs84:"606.0,23.0,413.0",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},Ho.carthage={towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},Ho.hermannskogel={towgs84:"653.0,-212.0,449.0",ellipse:"bessel",datumName:"Hermannskogel"},Ho.osni52={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"airy",datumName:"Irish National"},Ho.ire65={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},Ho.rassadiran={towgs84:"-133.63,-157.5,-158.62",ellipse:"intl",datumName:"Rassadiran"},Ho.nzgd49={towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},Ho.osgb36={towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Airy 1830"},Ho.s_jtsk={towgs84:"589,76,480",ellipse:"bessel",datumName:"S-JTSK (Ferro)"},Ho.beduaram={towgs84:"-106,-87,188",ellipse:"clrk80",datumName:"Beduaram"},Ho.gunung_segara={towgs84:"-403,684,41",ellipse:"bessel",datumName:"Gunung Segara Jakarta"},Ho.rnb72={towgs84:"106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1",ellipse:"intl",datumName:"Reseau National Belge 1972"};var Vo={};function Wo(t){if(0===t.length)return null;var e="@"===t[0];return e&&(t=t.slice(1)),"null"===t?{name:"null",mandatory:!e,grid:null,isNull:!0}:{name:t,mandatory:!e,grid:Vo[t]||null,isNull:!1}}function jo(t){return t/3600*Math.PI/180}function Xo(t,e,i){return String.fromCharCode.apply(null,new Uint8Array(t.buffer.slice(e,i)))}function qo(t){return t.map((function(t){return[jo(t.longitudeShift),jo(t.latitudeShift)]}))}function Yo(t,e,i){return{name:Xo(t,e+8,e+16).trim(),parent:Xo(t,e+24,e+24+8).trim(),lowerLatitude:t.getFloat64(e+72,i),upperLatitude:t.getFloat64(e+88,i),lowerLongitude:t.getFloat64(e+104,i),upperLongitude:t.getFloat64(e+120,i),latitudeInterval:t.getFloat64(e+136,i),longitudeInterval:t.getFloat64(e+152,i),gridNodeCount:t.getInt32(e+168,i)}}function Zo(t,e,i,n){for(var r=e+176,s=[],a=0;a<i.gridNodeCount;a++){var o={latitudeShift:t.getFloat32(r+16*a,n),longitudeShift:t.getFloat32(r+16*a+4,n),latitudeAccuracy:t.getFloat32(r+16*a+8,n),longitudeAccuracy:t.getFloat32(r+16*a+12,n)};s.push(o)}return s}function Jo(t,e){if(!(this instanceof Jo))return new Jo(t);e=e||function(t){if(t)throw t};var i=Lo(t);if("object"==typeof i){var n=Jo.projections.get(i.projName);if(n){if(i.datumCode&&"none"!==i.datumCode){var r=uo(Ho,i.datumCode);r&&(i.datum_params=r.towgs84?r.towgs84.split(","):null,i.ellps=r.ellipse,i.datumName=r.datumName?r.datumName:i.datumCode)}i.k0=i.k0||1,i.axis=i.axis||"enu",i.ellps=i.ellps||"wgs84";var s,a,o,h,l,c,u,d=function(t,e,i,n,r){if(!t){var s=uo(Bo,n);s||(s=Go),t=s.a,e=s.b,i=s.rf}return i&&!e&&(e=(1-1/i)*t),(0===i||Math.abs(t-e)<io)&&(r=!0,e=t),{a:t,b:e,rf:i,sphere:r}}(i.a,i.b,i.rf,i.ellps,i.sphere),p=(s=d.a,a=d.b,d.rf,o=i.R_A,c=((h=s*s)-(l=a*a))/h,u=0,o?(h=(s*=1-c*(.16666666666666666+c*(.04722222222222222+.022156084656084655*c)))*s,c=0):u=Math.sqrt(c),{es:c,e:u,ep2:(h-l)/l}),f=function(t){return void 0===t?null:t.split(",").map(Wo)}(i.nadgrids),m=i.datum||function(t,e,i,n,r,s,a){var o={};return o.datum_type=void 0===t||"none"===t?5:4,e&&(o.datum_params=e.map(parseFloat),0===o.datum_params[0]&&0===o.datum_params[1]&&0===o.datum_params[2]||(o.datum_type=1),o.datum_params.length>3&&(0===o.datum_params[3]&&0===o.datum_params[4]&&0===o.datum_params[5]&&0===o.datum_params[6]||(o.datum_type=2,o.datum_params[3]*=to,o.datum_params[4]*=to,o.datum_params[5]*=to,o.datum_params[6]=o.datum_params[6]/1e6+1))),a&&(o.datum_type=3,o.grids=a),o.a=i,o.b=n,o.es=r,o.ep2=s,o}(i.datumCode,i.datum_params,d.a,d.b,p.es,p.ep2,f);Co(this,i),Co(this,n),this.a=d.a,this.b=d.b,this.rf=d.rf,this.sphere=d.sphere,this.es=p.es,this.e=p.e,this.ep2=p.ep2,this.datum=m,this.init(),e(null,this)}else e(t)}else e(t)}function Qo(t,e,i){var n,r,s,a,o=t.x,h=t.y,l=t.z?t.z:0;if(h<-eo&&h>-1.001*eo)h=-eo;else if(h>eo&&h<1.001*eo)h=eo;else{if(h<-eo)return{x:-1/0,y:-1/0,z:t.z};if(h>eo)return{x:1/0,y:1/0,z:t.z}}return o>Math.PI&&(o-=2*Math.PI),r=Math.sin(h),a=Math.cos(h),s=r*r,{x:((n=i/Math.sqrt(1-e*s))+l)*a*Math.cos(o),y:(n+l)*a*Math.sin(o),z:(n*(1-e)+l)*r}}function Ko(t,e,i,n){var r,s,a,o,h,l,c,u,d,p,f,m,g,v,y,x=1e-12,_=t.x,M=t.y,b=t.z?t.z:0;if(r=Math.sqrt(_*_+M*M),s=Math.sqrt(_*_+M*M+b*b),r/i<x){if(v=0,s/i<x)return eo,y=-n,{x:t.x,y:t.y,z:t.z}}else v=Math.atan2(M,_);a=b/s,u=(o=r/s)*(1-e)*(h=1/Math.sqrt(1-e*(2-e)*o*o)),d=a*h,g=0;do{g++,l=e*(c=i/Math.sqrt(1-e*d*d))/(c+(y=r*u+b*d-c*(1-e*d*d))),m=(f=a*(h=1/Math.sqrt(1-l*(2-l)*o*o)))*u-(p=o*(1-l)*h)*d,u=p,d=f}while(m*m>1e-24&&g<30);return{x:v,y:Math.atan(f/Math.abs(p)),z:y}}function $o(t){return 1===t||2===t}function th(t,e,i){if(function(t,e){return t.datum_type===e.datum_type&&!(t.a!==e.a||Math.abs(t.es-e.es)>5e-11)&&(1===t.datum_type?t.datum_params[0]===e.datum_params[0]&&t.datum_params[1]===e.datum_params[1]&&t.datum_params[2]===e.datum_params[2]:2!==t.datum_type||t.datum_params[0]===e.datum_params[0]&&t.datum_params[1]===e.datum_params[1]&&t.datum_params[2]===e.datum_params[2]&&t.datum_params[3]===e.datum_params[3]&&t.datum_params[4]===e.datum_params[4]&&t.datum_params[5]===e.datum_params[5]&&t.datum_params[6]===e.datum_params[6])}(t,e))return i;if(5===t.datum_type||5===e.datum_type)return i;var n=t.a,r=t.es;if(3===t.datum_type){if(0!==eh(t,!1,i))return;n=Ka,r=$a}var s=e.a,a=e.b,o=e.es;if(3===e.datum_type&&(s=Ka,a=6356752.314,o=$a),r===o&&n===s&&!$o(t.datum_type)&&!$o(e.datum_type))return i;if((i=Qo(i,r,n),$o(t.datum_type)&&(i=function(t,e,i){if(1===e)return{x:t.x+i[0],y:t.y+i[1],z:t.z+i[2]};if(2===e){var n=i[0],r=i[1],s=i[2],a=i[3],o=i[4],h=i[5],l=i[6];return{x:l*(t.x-h*t.y+o*t.z)+n,y:l*(h*t.x+t.y-a*t.z)+r,z:l*(-o*t.x+a*t.y+t.z)+s}}}(i,t.datum_type,t.datum_params)),$o(e.datum_type)&&(i=function(t,e,i){if(1===e)return{x:t.x-i[0],y:t.y-i[1],z:t.z-i[2]};if(2===e){var n=i[0],r=i[1],s=i[2],a=i[3],o=i[4],h=i[5],l=i[6],c=(t.x-n)/l,u=(t.y-r)/l,d=(t.z-s)/l;return{x:c+h*u-o*d,y:-h*c+u+a*d,z:o*c-a*u+d}}}(i,e.datum_type,e.datum_params)),i=Ko(i,o,s,a),3===e.datum_type)&&0!==eh(e,!0,i))return;return i}function eh(t,e,i){if(null===t.grids||0===t.grids.length)return console.log("Grid shift grids not found"),-1;for(var n={x:-i.x,y:i.y},r={x:Number.NaN,y:Number.NaN},s=[],a=0;a<t.grids.length;a++){var o=t.grids[a];if(s.push(o.name),o.isNull){r=n;break}if(o.mandatory,null!==o.grid){var h=o.grid.subgrids[0],l=(Math.abs(h.del[1])+Math.abs(h.del[0]))/1e4,c=h.ll[0]-l,u=h.ll[1]-l,d=h.ll[0]+(h.lim[0]-1)*h.del[0]+l,p=h.ll[1]+(h.lim[1]-1)*h.del[1]+l;if(!(u>n.y||c>n.x||p<n.y||d<n.x||(r=ih(n,e,h),isNaN(r.x))))break}else if(o.mandatory)return console.log("Unable to find mandatory grid '"+o.name+"'"),-1}return isNaN(r.x)?(console.log("Failed to find a grid shift table for location '"+-n.x*ro+" "+n.y*ro+" tried: '"+s+"'"),-1):(i.x=-r.x,i.y=r.y,0)}function ih(t,e,i){var n={x:Number.NaN,y:Number.NaN};if(isNaN(t.x))return n;var r={x:t.x,y:t.y};r.x-=i.ll[0],r.y-=i.ll[1],r.x=Ro(r.x-Math.PI)+Math.PI;var s=nh(r,i);if(e){if(isNaN(s.x))return n;s.x=r.x-s.x,s.y=r.y-s.y;var a,o,h=9;do{if(o=nh(s,i),isNaN(o.x)){console.log("Inverse grid shift iteration failed, presumably at grid edge.  Using first approximation.");break}a={x:r.x-(o.x+s.x),y:r.y-(o.y+s.y)},s.x+=a.x,s.y+=a.y}while(h--&&Math.abs(a.x)>1e-12&&Math.abs(a.y)>1e-12);if(h<0)return console.log("Inverse grid shift iterator failed to converge."),n;n.x=Ro(s.x+i.ll[0]),n.y=s.y+i.ll[1]}else isNaN(s.x)||(n.x=t.x+s.x,n.y=t.y+s.y);return n}function nh(t,e){var i,n={x:t.x/e.del[0],y:t.y/e.del[1]},r=Math.floor(n.x),s=Math.floor(n.y),a=n.x-1*r,o=n.y-1*s,h={x:Number.NaN,y:Number.NaN};if(r<0||r>=e.lim[0])return h;if(s<0||s>=e.lim[1])return h;i=s*e.lim[0]+r;var l=e.cvs[i][0],c=e.cvs[i][1];i++;var u=e.cvs[i][0],d=e.cvs[i][1];i+=e.lim[0];var p=e.cvs[i][0],f=e.cvs[i][1];i--;var m=e.cvs[i][0],g=e.cvs[i][1],v=a*o,y=a*(1-o),x=(1-a)*(1-o),_=(1-a)*o;return h.x=x*l+y*u+_*m+v*p,h.y=x*c+y*d+_*g+v*f,h}function rh(t,e,i){var n,r,s,a=i.x,o=i.y,h=i.z||0,l={};for(s=0;s<3;s++)if(!e||2!==s||void 0!==i.z)switch(0===s?(n=a,r=-1!=="ew".indexOf(t.axis[s])?"x":"y"):1===s?(n=o,r=-1!=="ns".indexOf(t.axis[s])?"y":"x"):(n=h,r="z"),t.axis[s]){case"e":l[r]=n;break;case"w":l[r]=-n;break;case"n":l[r]=n;break;case"s":l[r]=-n;break;case"u":void 0!==i[r]&&(l.z=n);break;case"d":void 0!==i[r]&&(l.z=-n);break;default:return null}return l}function sh(t){var e={x:t[0],y:t[1]};return t.length>2&&(e.z=t[2]),t.length>3&&(e.m=t[3]),e}function ah(t){if("function"==typeof Number.isFinite){if(Number.isFinite(t))return;throw new TypeError("coordinates must be finite numbers")}if("number"!=typeof t||t!=t||!isFinite(t))throw new TypeError("coordinates must be finite numbers")}function oh(t,e,i){var n;if(Array.isArray(i)&&(i=sh(i)),function(t){ah(t.x),ah(t.y)}(i),t.datum&&e.datum&&function(t,e){return(1===t.datum.datum_type||2===t.datum.datum_type)&&"WGS84"!==e.datumCode||(1===e.datum.datum_type||2===e.datum.datum_type)&&"WGS84"!==t.datumCode}(t,e)&&(i=oh(t,n=new Jo("WGS84"),i),t=n),"enu"!==t.axis&&(i=rh(t,!1,i)),"longlat"===t.projName)i={x:i.x*no,y:i.y*no,z:i.z||0};else if(t.to_meter&&(i={x:i.x*t.to_meter,y:i.y*t.to_meter,z:i.z||0}),!(i=t.inverse(i)))return;if(t.from_greenwich&&(i.x+=t.from_greenwich),i=th(t.datum,e.datum,i))return e.from_greenwich&&(i={x:i.x-e.from_greenwich,y:i.y,z:i.z||0}),"longlat"===e.projName?i={x:i.x*ro,y:i.y*ro,z:i.z||0}:(i=e.forward(i),e.to_meter&&(i={x:i.x/e.to_meter,y:i.y/e.to_meter,z:i.z||0})),"enu"!==e.axis?rh(e,!0,i):i}Jo.projections=ko,Jo.projections.start();var hh=Jo("WGS84");function lh(t,e,i){var n,r,s;return Array.isArray(i)?(n=oh(t,e,i)||{x:NaN,y:NaN},i.length>2?void 0!==t.name&&"geocent"===t.name||void 0!==e.name&&"geocent"===e.name?"number"==typeof n.z?[n.x,n.y,n.z].concat(i.splice(3)):[n.x,n.y,i[2]].concat(i.splice(3)):[n.x,n.y].concat(i.splice(2)):[n.x,n.y]):(r=oh(t,e,i),2===(s=Object.keys(i)).length||s.forEach((function(n){if(void 0!==t.name&&"geocent"===t.name||void 0!==e.name&&"geocent"===e.name){if("x"===n||"y"===n||"z"===n)return}else if("x"===n||"y"===n)return;r[n]=i[n]})),r)}function ch(t){return t instanceof Jo?t:t.oProj?t.oProj:Jo(t)}function uh(t,e,i){t=ch(t);var n,r=!1;return void 0===e?(e=t,t=hh,r=!0):(void 0!==e.x||Array.isArray(e))&&(i=e,e=t,t=hh,r=!0),e=ch(e),i?lh(t,e,i):(n={forward:function(i){return lh(t,e,i)},inverse:function(i){return lh(e,t,i)}},r&&(n.oProj=e),n)}var dh="AJSAJS",ph="AFAFAF",fh=65,mh=73,gh=79,vh=86,yh=90,xh={forward:_h,inverse:function(t){var e=Sh(Lh(t.toUpperCase()));if(e.lat&&e.lon)return[e.lon,e.lat,e.lon,e.lat];return[e.left,e.bottom,e.right,e.top]},toPoint:Mh};function _h(t,e){return e=e||5,function(t,e){var i="00000"+t.easting,n="00000"+t.northing;return t.zoneNumber+t.zoneLetter+(p=t.easting,f=t.northing,m=t.zoneNumber,g=Th(m),v=Math.floor(p/1e5),y=Math.floor(f/1e5)%20,r=v,s=y,a=g,o=a-1,h=dh.charCodeAt(o),l=ph.charCodeAt(o),c=h+r-1,u=l+s,d=!1,c>yh&&(c=c-yh+fh-1,d=!0),(c===mh||h<mh&&c>mh||(c>mh||h<mh)&&d)&&c++,(c===gh||h<gh&&c>gh||(c>gh||h<gh)&&d)&&++c===mh&&c++,c>yh&&(c=c-yh+fh-1),u>vh?(u=u-vh+fh-1,d=!0):d=!1,(u===mh||l<mh&&u>mh||(u>mh||l<mh)&&d)&&u++,(u===gh||l<gh&&u>gh||(u>gh||l<gh)&&d)&&++u===mh&&u++,u>vh&&(u=u-vh+fh-1),String.fromCharCode(c)+String.fromCharCode(u))+i.substr(i.length-5,e)+n.substr(n.length-5,e);var r,s,a,o,h,l,c,u,d;var p,f,m,g,v,y}(function(t){var e,i,n,r,s,a,o,h,l=t.lat,c=t.lon,u=6378137,d=.00669438,p=.9996,f=bh(l),m=bh(c);h=Math.floor((c+180)/6)+1,180===c&&(h=60);l>=56&&l<64&&c>=3&&c<12&&(h=32);l>=72&&l<84&&(c>=0&&c<9?h=31:c>=9&&c<21?h=33:c>=21&&c<33?h=35:c>=33&&c<42&&(h=37));o=bh(6*(h-1)-180+3),e=d/(1-d),i=u/Math.sqrt(1-d*Math.sin(f)*Math.sin(f)),n=Math.tan(f)*Math.tan(f),r=e*Math.cos(f)*Math.cos(f),s=Math.cos(f)*(m-o),a=u*((1-d/4-3*d*d/64-5*d*d*d/256)*f-(3*d/8+3*d*d/32+45*d*d*d/1024)*Math.sin(2*f)+(15*d*d/256+45*d*d*d/1024)*Math.sin(4*f)-35*d*d*d/3072*Math.sin(6*f));var g=p*i*(s+(1-n+r)*s*s*s/6+(5-18*n+n*n+72*r-58*e)*s*s*s*s*s/120)+5e5,v=p*(a+i*Math.tan(f)*(s*s/2+(5-n+9*r+4*r*r)*s*s*s*s/24+(61-58*n+n*n+600*r-330*e)*s*s*s*s*s*s/720));l<0&&(v+=1e7);return{northing:Math.round(v),easting:Math.round(g),zoneNumber:h,zoneLetter:Eh(l)}}({lat:t[1],lon:t[0]}),e)}function Mh(t){var e=Sh(Lh(t.toUpperCase()));return e.lat&&e.lon?[e.lon,e.lat]:[(e.left+e.right)/2,(e.top+e.bottom)/2]}function bh(t){return t*(Math.PI/180)}function wh(t){return t/Math.PI*180}function Sh(t){var e=t.northing,i=t.easting,n=t.zoneLetter,r=t.zoneNumber;if(r<0||r>60)return null;var s,a,o,h,l,c,u,d,p,f=.9996,m=6378137,g=.00669438,v=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),y=i-5e5,x=e;n<"N"&&(x-=1e7),u=6*(r-1)-180+3,s=.006739496752268451,p=(d=x/f/6367449.145945056)+(3*v/2-27*v*v*v/32)*Math.sin(2*d)+(21*v*v/16-55*v*v*v*v/32)*Math.sin(4*d)+151*v*v*v/96*Math.sin(6*d),a=m/Math.sqrt(1-g*Math.sin(p)*Math.sin(p)),o=Math.tan(p)*Math.tan(p),h=s*Math.cos(p)*Math.cos(p),l=.99330562*m/Math.pow(1-g*Math.sin(p)*Math.sin(p),1.5),c=y/(a*f);var _=p-a*Math.tan(p)/l*(c*c/2-(5+3*o+10*h-4*h*h-9*s)*c*c*c*c/24+(61+90*o+298*h+45*o*o-1.6983531815716497-3*h*h)*c*c*c*c*c*c/720);_=wh(_);var M,b=(c-(1+2*o+h)*c*c*c/6+(5-2*h+28*o-3*h*h+8*s+24*o*o)*c*c*c*c*c/120)/Math.cos(p);if(b=u+wh(b),t.accuracy){var w=Sh({northing:t.northing+t.accuracy,easting:t.easting+t.accuracy,zoneLetter:t.zoneLetter,zoneNumber:t.zoneNumber});M={top:w.lat,right:w.lon,bottom:_,left:b}}else M={lat:_,lon:b};return M}function Eh(t){var e="Z";return 84>=t&&t>=72?e="X":72>t&&t>=64?e="W":64>t&&t>=56?e="V":56>t&&t>=48?e="U":48>t&&t>=40?e="T":40>t&&t>=32?e="S":32>t&&t>=24?e="R":24>t&&t>=16?e="Q":16>t&&t>=8?e="P":8>t&&t>=0?e="N":0>t&&t>=-8?e="M":-8>t&&t>=-16?e="L":-16>t&&t>=-24?e="K":-24>t&&t>=-32?e="J":-32>t&&t>=-40?e="H":-40>t&&t>=-48?e="G":-48>t&&t>=-56?e="F":-56>t&&t>=-64?e="E":-64>t&&t>=-72?e="D":-72>t&&t>=-80&&(e="C"),e}function Th(t){var e=t%6;return 0===e&&(e=6),e}function Lh(t){if(t&&0===t.length)throw"MGRSPoint coverting from nothing";for(var e,i=t.length,n=null,r="",s=0;!/[A-Z]/.test(e=t.charAt(s));){if(s>=2)throw"MGRSPoint bad conversion from: "+t;r+=e,s++}var a=parseInt(r,10);if(0===s||s+3>i)throw"MGRSPoint bad conversion from: "+t;var o=t.charAt(s++);if(o<="A"||"B"===o||"Y"===o||o>="Z"||"I"===o||"O"===o)throw"MGRSPoint zone letter "+o+" not handled: "+t;n=t.substring(s,s+=2);for(var h=Th(a),l=function(t,e){var i=dh.charCodeAt(e-1),n=1e5,r=!1;for(;i!==t.charCodeAt(0);){if(++i===mh&&i++,i===gh&&i++,i>yh){if(r)throw"Bad character: "+t;i=fh,r=!0}n+=1e5}return n}(n.charAt(0),h),c=function(t,e){if(t>"V")throw"MGRSPoint given invalid Northing "+t;var i=ph.charCodeAt(e-1),n=0,r=!1;for(;i!==t.charCodeAt(0);){if(++i===mh&&i++,i===gh&&i++,i>vh){if(r)throw"Bad character: "+t;i=fh,r=!0}n+=1e5}return n}(n.charAt(1),h);c<Ch(o);)c+=2e6;var u=i-s;if(u%2!=0)throw"MGRSPoint has to have an even number \nof digits after the zone letter and two 100km letters - front \nhalf for easting meters, second half for \nnorthing meters"+t;var d,p,f,m=u/2,g=0,v=0;return m>0&&(d=1e5/Math.pow(10,m),p=t.substring(s,s+m),g=parseFloat(p)*d,f=t.substring(s+m),v=parseFloat(f)*d),{easting:g+l,northing:v+c,zoneLetter:o,zoneNumber:a,accuracy:d}}function Ch(t){var e;switch(t){case"C":e=11e5;break;case"D":e=2e6;break;case"E":e=28e5;break;case"F":e=37e5;break;case"G":e=46e5;break;case"H":e=55e5;break;case"J":e=64e5;break;case"K":e=73e5;break;case"L":e=82e5;break;case"M":e=91e5;break;case"N":e=0;break;case"P":e=8e5;break;case"Q":e=17e5;break;case"R":e=26e5;break;case"S":e=35e5;break;case"T":e=44e5;break;case"U":e=53e5;break;case"V":e=62e5;break;case"W":e=7e6;break;case"X":e=79e5;break;default:e=-1}if(e>=0)return e;throw"Invalid zone letter: "+t}function Ah(t,e,i){if(!(this instanceof Ah))return new Ah(t,e,i);if(Array.isArray(t))this.x=t[0],this.y=t[1],this.z=t[2]||0;else if("object"==typeof t)this.x=t.x,this.y=t.y,this.z=t.z||0;else if("string"==typeof t&&void 0===e){var n=t.split(",");this.x=parseFloat(n[0],10),this.y=parseFloat(n[1],10),this.z=parseFloat(n[2],10)||0}else this.x=t,this.y=e,this.z=i||0;console.warn("proj4.Point will be removed in version 3, use proj4.toPoint")}Ah.fromMGRS=function(t){return new Ah(Mh(t))},Ah.prototype.toMGRS=function(t){return _h([this.x,this.y],t)};var Ph=.046875,Rh=.01953125,Dh=.01068115234375;function Nh(t){var e=[];e[0]=1-t*(.25+t*(Ph+t*(Rh+t*Dh))),e[1]=t*(.75-t*(Ph+t*(Rh+t*Dh)));var i=t*t;return e[2]=i*(.46875-t*(.013020833333333334+.007120768229166667*t)),i*=t,e[3]=i*(.3645833333333333-.005696614583333333*t),e[4]=i*t*.3076171875,e}function Ih(t,e,i,n){return i*=e,e*=e,n[0]*t-i*(n[1]+e*(n[2]+e*(n[3]+e*n[4])))}function Oh(t,e,i){for(var n=1/(1-e),r=t,s=20;s;--s){var a=Math.sin(r),o=1-e*a*a;if(r-=o=(Ih(r,a,Math.cos(r),i)-t)*(o*Math.sqrt(o))*n,Math.abs(o)<io)return r}return r}var Fh={init:function(){this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.es&&(this.en=Nh(this.es),this.ml0=Ih(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en))},forward:function(t){var e,i,n,r=t.x,s=t.y,a=Ro(r-this.long0),o=Math.sin(s),h=Math.cos(s);if(this.es){var l=h*a,c=Math.pow(l,2),u=this.ep2*Math.pow(h,2),d=Math.pow(u,2),p=Math.abs(h)>io?Math.tan(s):0,f=Math.pow(p,2),m=Math.pow(f,2);e=1-this.es*Math.pow(o,2),l/=Math.sqrt(e);var g=Ih(s,o,h,this.en);i=this.a*(this.k0*l*(1+c/6*(1-f+u+c/20*(5-18*f+m+14*u-58*f*u+c/42*(61+179*m-m*f-479*f)))))+this.x0,n=this.a*(this.k0*(g-this.ml0+o*a*l/2*(1+c/12*(5-f+9*u+4*d+c/30*(61+m-58*f+270*u-330*f*u+c/56*(1385+543*m-m*f-3111*f))))))+this.y0}else{var v=h*Math.sin(a);if(Math.abs(Math.abs(v)-1)<io)return 93;if(i=.5*this.a*this.k0*Math.log((1+v)/(1-v))+this.x0,n=h*Math.cos(a)/Math.sqrt(1-Math.pow(v,2)),(v=Math.abs(n))>=1){if(v-1>io)return 93;n=0}else n=Math.acos(n);s<0&&(n=-n),n=this.a*this.k0*(n-this.lat0)+this.y0}return t.x=i,t.y=n,t},inverse:function(t){var e,i,n,r,s=(t.x-this.x0)*(1/this.a),a=(t.y-this.y0)*(1/this.a);if(this.es)if(i=Oh(e=this.ml0+a/this.k0,this.es,this.en),Math.abs(i)<eo){var o=Math.sin(i),h=Math.cos(i),l=Math.abs(h)>io?Math.tan(i):0,c=this.ep2*Math.pow(h,2),u=Math.pow(c,2),d=Math.pow(l,2),p=Math.pow(d,2);e=1-this.es*Math.pow(o,2);var f=s*Math.sqrt(e)/this.k0,m=Math.pow(f,2);n=i-(e*=l)*m/(1-this.es)*.5*(1-m/12*(5+3*d-9*c*d+c-4*u-m/30*(61+90*d-252*c*d+45*p+46*c-m/56*(1385+3633*d+4095*p+1574*p*d)))),r=Ro(this.long0+f*(1-m/6*(1+2*d+c-m/20*(5+28*d+24*p+8*c*d+6*c-m/42*(61+662*d+1320*p+720*p*d))))/h)}else n=eo*Po(a),r=0;else{var g=Math.exp(s/this.k0),v=.5*(g-1/g),y=this.lat0+a/this.k0,x=Math.cos(y);e=Math.sqrt((1-Math.pow(x,2))/(1+Math.pow(v,2))),n=Math.asin(e),a<0&&(n=-n),r=0===v&&0===x?0:Ro(Math.atan2(v,x)+this.long0)}return t.x=r,t.y=n,t},names:["Fast_Transverse_Mercator","Fast Transverse Mercator"]};function Uh(t){var e=Math.exp(t);return e=(e-1/e)/2}function zh(t,e){t=Math.abs(t),e=Math.abs(e);var i=Math.max(t,e),n=Math.min(t,e)/(i||1);return i*Math.sqrt(1+Math.pow(n,2))}function kh(t){var e=Math.abs(t);return e=function(t){var e=1+t,i=e-1;return 0===i?t:t*Math.log(e)/i}(e*(1+e/(zh(1,e)+1))),t<0?-e:e}function Bh(t,e){for(var i,n=2*Math.cos(2*e),r=t.length-1,s=t[r],a=0;--r>=0;)i=n*s-a+t[r],a=s,s=i;return e+i*Math.sin(2*e)}function Gh(t,e,i){for(var n,r,s=Math.sin(e),a=Math.cos(e),o=Uh(i),h=function(t){var e=Math.exp(t);return(e+1/e)/2}(i),l=2*a*h,c=-2*s*o,u=t.length-1,d=t[u],p=0,f=0,m=0;--u>=0;)n=f,r=p,d=l*(f=d)-n-c*(p=m)+t[u],m=c*f-r+l*p;return[(l=s*h)*d-(c=a*o)*m,l*m+c*d]}var Hh={init:function(){if(!this.approx&&(isNaN(this.es)||this.es<=0))throw new Error('Incorrect elliptical usage. Try using the +approx option in the proj string, or PROJECTION["Fast_Transverse_Mercator"] in the WKT.');this.approx&&(Fh.init.apply(this),this.forward=Fh.forward,this.inverse=Fh.inverse),this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.cgb=[],this.cbg=[],this.utg=[],this.gtu=[];var t=this.es/(1+Math.sqrt(1-this.es)),e=t/(2-t),i=e;this.cgb[0]=e*(2+e*(-2/3+e*(e*(116/45+e*(26/45+e*(-2854/675)))-2))),this.cbg[0]=e*(e*(2/3+e*(4/3+e*(-82/45+e*(32/45+e*(4642/4725)))))-2),i*=e,this.cgb[1]=i*(7/3+e*(e*(-227/45+e*(2704/315+e*(2323/945)))-1.6)),this.cbg[1]=i*(5/3+e*(-16/15+e*(-13/9+e*(904/315+e*(-1522/945))))),i*=e,this.cgb[2]=i*(56/15+e*(-136/35+e*(-1262/105+e*(73814/2835)))),this.cbg[2]=i*(-26/15+e*(34/21+e*(1.6+e*(-12686/2835)))),i*=e,this.cgb[3]=i*(4279/630+e*(-332/35+e*(-399572/14175))),this.cbg[3]=i*(1237/630+e*(e*(-24832/14175)-2.4)),i*=e,this.cgb[4]=i*(4174/315+e*(-144838/6237)),this.cbg[4]=i*(-734/315+e*(109598/31185)),i*=e,this.cgb[5]=i*(601676/22275),this.cbg[5]=i*(444337/155925),i=Math.pow(e,2),this.Qn=this.k0/(1+e)*(1+i*(1/4+i*(1/64+i/256))),this.utg[0]=e*(e*(2/3+e*(-37/96+e*(1/360+e*(81/512+e*(-96199/604800)))))-.5),this.gtu[0]=e*(.5+e*(-2/3+e*(5/16+e*(41/180+e*(-127/288+e*(7891/37800)))))),this.utg[1]=i*(-1/48+e*(-1/15+e*(437/1440+e*(-46/105+e*(1118711/3870720))))),this.gtu[1]=i*(13/48+e*(e*(557/1440+e*(281/630+e*(-1983433/1935360)))-.6)),i*=e,this.utg[2]=i*(-17/480+e*(37/840+e*(209/4480+e*(-5569/90720)))),this.gtu[2]=i*(61/240+e*(-103/140+e*(15061/26880+e*(167603/181440)))),i*=e,this.utg[3]=i*(-4397/161280+e*(11/504+e*(830251/7257600))),this.gtu[3]=i*(49561/161280+e*(-179/168+e*(6601661/7257600))),i*=e,this.utg[4]=i*(-4583/161280+e*(108847/3991680)),this.gtu[4]=i*(34729/80640+e*(-3418889/1995840)),i*=e,this.utg[5]=i*(-20648693/638668800),this.gtu[5]=.6650675310896665*i;var n=Bh(this.cbg,this.lat0);this.Zb=-this.Qn*(n+function(t,e){for(var i,n=2*Math.cos(e),r=t.length-1,s=t[r],a=0;--r>=0;)i=n*s-a+t[r],a=s,s=i;return Math.sin(e)*i}(this.gtu,2*n))},forward:function(t){var e=Ro(t.x-this.long0),i=t.y;i=Bh(this.cbg,i);var n=Math.sin(i),r=Math.cos(i),s=Math.sin(e),a=Math.cos(e);i=Math.atan2(n,a*r),e=Math.atan2(s*r,zh(n,r*a)),e=kh(Math.tan(e));var o,h,l=Gh(this.gtu,2*i,2*e);return i+=l[0],e+=l[1],Math.abs(e)<=2.623395162778?(o=this.a*(this.Qn*e)+this.x0,h=this.a*(this.Qn*i+this.Zb)+this.y0):(o=1/0,h=1/0),t.x=o,t.y=h,t},inverse:function(t){var e,i,n=(t.x-this.x0)*(1/this.a),r=(t.y-this.y0)*(1/this.a);if(r=(r-this.Zb)/this.Qn,n/=this.Qn,Math.abs(n)<=2.623395162778){var s=Gh(this.utg,2*r,2*n);r+=s[0],n+=s[1],n=Math.atan(Uh(n));var a=Math.sin(r),o=Math.cos(r),h=Math.sin(n),l=Math.cos(n);r=Math.atan2(a*l,zh(h,l*o)),e=Ro((n=Math.atan2(h,l*o))+this.long0),i=Bh(this.cgb,r)}else e=1/0,i=1/0;return t.x=e,t.y=i,t},names:["Extended_Transverse_Mercator","Extended Transverse Mercator","etmerc","Transverse_Mercator","Transverse Mercator","tmerc"]};var Vh={init:function(){var t=function(t,e){if(void 0===t){if((t=Math.floor(30*(Ro(e)+Math.PI)/Math.PI)+1)<0)return 0;if(t>60)return 60}return t}(this.zone,this.long0);if(void 0===t)throw new Error("unknown utm zone");this.lat0=0,this.long0=(6*Math.abs(t)-183)*no,this.x0=5e5,this.y0=this.utmSouth?1e7:0,this.k0=.9996,Hh.init.apply(this),this.forward=Hh.forward,this.inverse=Hh.inverse},names:["Universal Transverse Mercator System","utm"],dependsOn:"etmerc"};function Wh(t,e){return Math.pow((1-t)/(1+t),e)}var jh={init:function(){var t=Math.sin(this.lat0),e=Math.cos(this.lat0);e*=e,this.rc=Math.sqrt(1-this.es)/(1-this.es*t*t),this.C=Math.sqrt(1+this.es*e*e/(1-this.es)),this.phic0=Math.asin(t/this.C),this.ratexp=.5*this.C*this.e,this.K=Math.tan(.5*this.phic0+so)/(Math.pow(Math.tan(.5*this.lat0+so),this.C)*Wh(this.e*t,this.ratexp))},forward:function(t){var e=t.x,i=t.y;return t.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*i+so),this.C)*Wh(this.e*Math.sin(i),this.ratexp))-eo,t.x=this.C*e,t},inverse:function(t){for(var e=t.x/this.C,i=t.y,n=Math.pow(Math.tan(.5*i+so)/this.K,1/this.C),r=20;r>0&&(i=2*Math.atan(n*Wh(this.e*Math.sin(t.y),-.5*this.e))-eo,!(Math.abs(i-t.y)<1e-14));--r)t.y=i;return r?(t.x=e,t.y=i,t):null},names:["gauss"]};var Xh={init:function(){jh.init.apply(this),this.rc&&(this.sinc0=Math.sin(this.phic0),this.cosc0=Math.cos(this.phic0),this.R2=2*this.rc,this.title||(this.title="Oblique Stereographic Alternative"))},forward:function(t){var e,i,n,r;return t.x=Ro(t.x-this.long0),jh.forward.apply(this,[t]),e=Math.sin(t.y),i=Math.cos(t.y),n=Math.cos(t.x),r=this.k0*this.R2/(1+this.sinc0*e+this.cosc0*i*n),t.x=r*i*Math.sin(t.x),t.y=r*(this.cosc0*e-this.sinc0*i*n),t.x=this.a*t.x+this.x0,t.y=this.a*t.y+this.y0,t},inverse:function(t){var e,i,n,r,s;if(t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,t.x/=this.k0,t.y/=this.k0,s=Math.sqrt(t.x*t.x+t.y*t.y)){var a=2*Math.atan2(s,this.R2);e=Math.sin(a),i=Math.cos(a),r=Math.asin(i*this.sinc0+t.y*e*this.cosc0/s),n=Math.atan2(t.x*e,s*this.cosc0*i-t.y*this.sinc0*e)}else r=this.phic0,n=0;return t.x=n,t.y=r,jh.inverse.apply(this,[t]),t.x=Ro(t.x+this.long0),t},names:["Stereographic_North_Pole","Oblique_Stereographic","Polar_Stereographic","sterea","Oblique Stereographic Alternative","Double_Stereographic"]};var qh={init:function(){this.coslat0=Math.cos(this.lat0),this.sinlat0=Math.sin(this.lat0),this.sphere?1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=io&&(this.k0=.5*(1+Po(this.lat0)*Math.sin(this.lat_ts))):(Math.abs(this.coslat0)<=io&&(this.lat0>0?this.con=1:this.con=-1),this.cons=Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e)),1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=io&&(this.k0=.5*this.cons*Ao(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts))/Do(this.e,this.con*this.lat_ts,this.con*Math.sin(this.lat_ts))),this.ms1=Ao(this.e,this.sinlat0,this.coslat0),this.X0=2*Math.atan(this.ssfn_(this.lat0,this.sinlat0,this.e))-eo,this.cosX0=Math.cos(this.X0),this.sinX0=Math.sin(this.X0))},forward:function(t){var e,i,n,r,s,a,o=t.x,h=t.y,l=Math.sin(h),c=Math.cos(h),u=Ro(o-this.long0);return Math.abs(Math.abs(o-this.long0)-Math.PI)<=io&&Math.abs(h+this.lat0)<=io?(t.x=NaN,t.y=NaN,t):this.sphere?(e=2*this.k0/(1+this.sinlat0*l+this.coslat0*c*Math.cos(u)),t.x=this.a*e*c*Math.sin(u)+this.x0,t.y=this.a*e*(this.coslat0*l-this.sinlat0*c*Math.cos(u))+this.y0,t):(i=2*Math.atan(this.ssfn_(h,l,this.e))-eo,r=Math.cos(i),n=Math.sin(i),Math.abs(this.coslat0)<=io?(s=Do(this.e,h*this.con,this.con*l),a=2*this.a*this.k0*s/this.cons,t.x=this.x0+a*Math.sin(o-this.long0),t.y=this.y0-this.con*a*Math.cos(o-this.long0),t):(Math.abs(this.sinlat0)<io?(e=2*this.a*this.k0/(1+r*Math.cos(u)),t.y=e*n):(e=2*this.a*this.k0*this.ms1/(this.cosX0*(1+this.sinX0*n+this.cosX0*r*Math.cos(u))),t.y=e*(this.cosX0*n-this.sinX0*r*Math.cos(u))+this.y0),t.x=e*r*Math.sin(u)+this.x0,t))},inverse:function(t){var e,i,n,r,s;t.x-=this.x0,t.y-=this.y0;var a=Math.sqrt(t.x*t.x+t.y*t.y);if(this.sphere){var o=2*Math.atan(a/(2*this.a*this.k0));return e=this.long0,i=this.lat0,a<=io?(t.x=e,t.y=i,t):(i=Math.asin(Math.cos(o)*this.sinlat0+t.y*Math.sin(o)*this.coslat0/a),e=Math.abs(this.coslat0)<io?this.lat0>0?Ro(this.long0+Math.atan2(t.x,-1*t.y)):Ro(this.long0+Math.atan2(t.x,t.y)):Ro(this.long0+Math.atan2(t.x*Math.sin(o),a*this.coslat0*Math.cos(o)-t.y*this.sinlat0*Math.sin(o))),t.x=e,t.y=i,t)}if(Math.abs(this.coslat0)<=io){if(a<=io)return i=this.lat0,e=this.long0,t.x=e,t.y=i,t;t.x*=this.con,t.y*=this.con,n=a*this.cons/(2*this.a*this.k0),i=this.con*No(this.e,n),e=this.con*Ro(this.con*this.long0+Math.atan2(t.x,-1*t.y))}else r=2*Math.atan(a*this.cosX0/(2*this.a*this.k0*this.ms1)),e=this.long0,a<=io?s=this.X0:(s=Math.asin(Math.cos(r)*this.sinX0+t.y*Math.sin(r)*this.cosX0/a),e=Ro(this.long0+Math.atan2(t.x*Math.sin(r),a*this.cosX0*Math.cos(r)-t.y*this.sinX0*Math.sin(r)))),i=-1*No(this.e,Math.tan(.5*(eo+s)));return t.x=e,t.y=i,t},names:["stere","Stereographic_South_Pole","Polar Stereographic (variant B)"],ssfn_:function(t,e,i){return e*=i,Math.tan(.5*(eo+t))*Math.pow((1-e)/(1+e),.5*i)}};var Yh={init:function(){var t=this.lat0;this.lambda0=this.long0;var e=Math.sin(t),i=this.a,n=1/this.rf,r=2*n-Math.pow(n,2),s=this.e=Math.sqrt(r);this.R=this.k0*i*Math.sqrt(1-r)/(1-r*Math.pow(e,2)),this.alpha=Math.sqrt(1+r/(1-r)*Math.pow(Math.cos(t),4)),this.b0=Math.asin(e/this.alpha);var a=Math.log(Math.tan(Math.PI/4+this.b0/2)),o=Math.log(Math.tan(Math.PI/4+t/2)),h=Math.log((1+s*e)/(1-s*e));this.K=a-this.alpha*o+this.alpha*s/2*h},forward:function(t){var e=Math.log(Math.tan(Math.PI/4-t.y/2)),i=this.e/2*Math.log((1+this.e*Math.sin(t.y))/(1-this.e*Math.sin(t.y))),n=-this.alpha*(e+i)+this.K,r=2*(Math.atan(Math.exp(n))-Math.PI/4),s=this.alpha*(t.x-this.lambda0),a=Math.atan(Math.sin(s)/(Math.sin(this.b0)*Math.tan(r)+Math.cos(this.b0)*Math.cos(s))),o=Math.asin(Math.cos(this.b0)*Math.sin(r)-Math.sin(this.b0)*Math.cos(r)*Math.cos(s));return t.y=this.R/2*Math.log((1+Math.sin(o))/(1-Math.sin(o)))+this.y0,t.x=this.R*a+this.x0,t},inverse:function(t){for(var e=t.x-this.x0,i=t.y-this.y0,n=e/this.R,r=2*(Math.atan(Math.exp(i/this.R))-Math.PI/4),s=Math.asin(Math.cos(this.b0)*Math.sin(r)+Math.sin(this.b0)*Math.cos(r)*Math.cos(n)),a=Math.atan(Math.sin(n)/(Math.cos(this.b0)*Math.cos(n)-Math.sin(this.b0)*Math.tan(r))),o=this.lambda0+a/this.alpha,h=0,l=s,c=-1e3,u=0;Math.abs(l-c)>1e-7;){if(++u>20)return;h=1/this.alpha*(Math.log(Math.tan(Math.PI/4+s/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(l))/2)),c=l,l=2*Math.atan(Math.exp(h))-Math.PI/2}return t.x=o,t.y=l,t},names:["somerc"]};var Zh={init:function(){this.no_off=this.no_off||!1,this.no_rot=this.no_rot||!1,isNaN(this.k0)&&(this.k0=1);var t=Math.sin(this.lat0),e=Math.cos(this.lat0),i=this.e*t;this.bl=Math.sqrt(1+this.es/(1-this.es)*Math.pow(e,4)),this.al=this.a*this.bl*this.k0*Math.sqrt(1-this.es)/(1-i*i);var n,r,s=Do(this.e,this.lat0,t),a=this.bl/e*Math.sqrt((1-this.es)/(1-i*i));if(a*a<1&&(a=1),isNaN(this.longc)){var o=Do(this.e,this.lat1,Math.sin(this.lat1)),h=Do(this.e,this.lat2,Math.sin(this.lat2));this.lat0>=0?this.el=(a+Math.sqrt(a*a-1))*Math.pow(s,this.bl):this.el=(a-Math.sqrt(a*a-1))*Math.pow(s,this.bl);var l=Math.pow(o,this.bl),c=Math.pow(h,this.bl);r=.5*((n=this.el/l)-1/n);var u=(this.el*this.el-c*l)/(this.el*this.el+c*l),d=(c-l)/(c+l),p=Ro(this.long1-this.long2);this.long0=.5*(this.long1+this.long2)-Math.atan(u*Math.tan(.5*this.bl*p)/d)/this.bl,this.long0=Ro(this.long0);var f=Ro(this.long1-this.long0);this.gamma0=Math.atan(Math.sin(this.bl*f)/r),this.alpha=Math.asin(a*Math.sin(this.gamma0))}else n=this.lat0>=0?a+Math.sqrt(a*a-1):a-Math.sqrt(a*a-1),this.el=n*Math.pow(s,this.bl),r=.5*(n-1/n),this.gamma0=Math.asin(Math.sin(this.alpha)/a),this.long0=this.longc-Math.asin(r*Math.tan(this.gamma0))/this.bl;this.no_off?this.uc=0:this.lat0>=0?this.uc=this.al/this.bl*Math.atan2(Math.sqrt(a*a-1),Math.cos(this.alpha)):this.uc=-1*this.al/this.bl*Math.atan2(Math.sqrt(a*a-1),Math.cos(this.alpha))},forward:function(t){var e,i,n,r=t.x,s=t.y,a=Ro(r-this.long0);if(Math.abs(Math.abs(s)-eo)<=io)n=s>0?-1:1,i=this.al/this.bl*Math.log(Math.tan(so+n*this.gamma0*.5)),e=-1*n*eo*this.al/this.bl;else{var o=Do(this.e,s,Math.sin(s)),h=this.el/Math.pow(o,this.bl),l=.5*(h-1/h),c=.5*(h+1/h),u=Math.sin(this.bl*a),d=(l*Math.sin(this.gamma0)-u*Math.cos(this.gamma0))/c;i=Math.abs(Math.abs(d)-1)<=io?Number.POSITIVE_INFINITY:.5*this.al*Math.log((1-d)/(1+d))/this.bl,e=Math.abs(Math.cos(this.bl*a))<=io?this.al*this.bl*a:this.al*Math.atan2(l*Math.cos(this.gamma0)+u*Math.sin(this.gamma0),Math.cos(this.bl*a))/this.bl}return this.no_rot?(t.x=this.x0+e,t.y=this.y0+i):(e-=this.uc,t.x=this.x0+i*Math.cos(this.alpha)+e*Math.sin(this.alpha),t.y=this.y0+e*Math.cos(this.alpha)-i*Math.sin(this.alpha)),t},inverse:function(t){var e,i;this.no_rot?(i=t.y-this.y0,e=t.x-this.x0):(i=(t.x-this.x0)*Math.cos(this.alpha)-(t.y-this.y0)*Math.sin(this.alpha),e=(t.y-this.y0)*Math.cos(this.alpha)+(t.x-this.x0)*Math.sin(this.alpha),e+=this.uc);var n=Math.exp(-1*this.bl*i/this.al),r=.5*(n-1/n),s=.5*(n+1/n),a=Math.sin(this.bl*e/this.al),o=(a*Math.cos(this.gamma0)+r*Math.sin(this.gamma0))/s,h=Math.pow(this.el/Math.sqrt((1+o)/(1-o)),1/this.bl);return Math.abs(o-1)<io?(t.x=this.long0,t.y=eo):Math.abs(o+1)<io?(t.x=this.long0,t.y=-1*eo):(t.y=No(this.e,h),t.x=Ro(this.long0-Math.atan2(r*Math.cos(this.gamma0)-a*Math.sin(this.gamma0),Math.cos(this.bl*e/this.al))/this.bl)),t},names:["Hotine_Oblique_Mercator","Hotine Oblique Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin","Hotine_Oblique_Mercator_Azimuth_Center","omerc"]};var Jh={init:function(){if(this.lat2||(this.lat2=this.lat1),this.k0||(this.k0=1),this.x0=this.x0||0,this.y0=this.y0||0,!(Math.abs(this.lat1+this.lat2)<io)){var t=this.b/this.a;this.e=Math.sqrt(1-t*t);var e=Math.sin(this.lat1),i=Math.cos(this.lat1),n=Ao(this.e,e,i),r=Do(this.e,this.lat1,e),s=Math.sin(this.lat2),a=Math.cos(this.lat2),o=Ao(this.e,s,a),h=Do(this.e,this.lat2,s),l=Do(this.e,this.lat0,Math.sin(this.lat0));Math.abs(this.lat1-this.lat2)>io?this.ns=Math.log(n/o)/Math.log(r/h):this.ns=e,isNaN(this.ns)&&(this.ns=e),this.f0=n/(this.ns*Math.pow(r,this.ns)),this.rh=this.a*this.f0*Math.pow(l,this.ns),this.title||(this.title="Lambert Conformal Conic")}},forward:function(t){var e=t.x,i=t.y;Math.abs(2*Math.abs(i)-Math.PI)<=io&&(i=Po(i)*(eo-2e-10));var n,r,s=Math.abs(Math.abs(i)-eo);if(s>io)n=Do(this.e,i,Math.sin(i)),r=this.a*this.f0*Math.pow(n,this.ns);else{if((s=i*this.ns)<=0)return null;r=0}var a=this.ns*Ro(e-this.long0);return t.x=this.k0*(r*Math.sin(a))+this.x0,t.y=this.k0*(this.rh-r*Math.cos(a))+this.y0,t},inverse:function(t){var e,i,n,r,s,a=(t.x-this.x0)/this.k0,o=this.rh-(t.y-this.y0)/this.k0;this.ns>0?(e=Math.sqrt(a*a+o*o),i=1):(e=-Math.sqrt(a*a+o*o),i=-1);var h=0;if(0!==e&&(h=Math.atan2(i*a,i*o)),0!==e||this.ns>0){if(i=1/this.ns,n=Math.pow(e/(this.a*this.f0),i),-9999===(r=No(this.e,n)))return null}else r=-eo;return s=Ro(h/this.ns+this.long0),t.x=s,t.y=r,t},names:["Lambert Tangential Conformal Conic Projection","Lambert_Conformal_Conic","Lambert_Conformal_Conic_2SP","lcc"]};var Qh={init:function(){this.a=6377397.155,this.es=.006674372230614,this.e=Math.sqrt(this.es),this.lat0||(this.lat0=.863937979737193),this.long0||(this.long0=.4334234309119251),this.k0||(this.k0=.9999),this.s45=.785398163397448,this.s90=2*this.s45,this.fi0=this.lat0,this.e2=this.es,this.e=Math.sqrt(this.e2),this.alfa=Math.sqrt(1+this.e2*Math.pow(Math.cos(this.fi0),4)/(1-this.e2)),this.uq=1.04216856380474,this.u0=Math.asin(Math.sin(this.fi0)/this.alfa),this.g=Math.pow((1+this.e*Math.sin(this.fi0))/(1-this.e*Math.sin(this.fi0)),this.alfa*this.e/2),this.k=Math.tan(this.u0/2+this.s45)/Math.pow(Math.tan(this.fi0/2+this.s45),this.alfa)*this.g,this.k1=this.k0,this.n0=this.a*Math.sqrt(1-this.e2)/(1-this.e2*Math.pow(Math.sin(this.fi0),2)),this.s0=1.37008346281555,this.n=Math.sin(this.s0),this.ro0=this.k1*this.n0/Math.tan(this.s0),this.ad=this.s90-this.uq},forward:function(t){var e,i,n,r,s,a,o,h=t.x,l=t.y,c=Ro(h-this.long0);return e=Math.pow((1+this.e*Math.sin(l))/(1-this.e*Math.sin(l)),this.alfa*this.e/2),i=2*(Math.atan(this.k*Math.pow(Math.tan(l/2+this.s45),this.alfa)/e)-this.s45),n=-c*this.alfa,r=Math.asin(Math.cos(this.ad)*Math.sin(i)+Math.sin(this.ad)*Math.cos(i)*Math.cos(n)),s=Math.asin(Math.cos(i)*Math.sin(n)/Math.cos(r)),a=this.n*s,o=this.ro0*Math.pow(Math.tan(this.s0/2+this.s45),this.n)/Math.pow(Math.tan(r/2+this.s45),this.n),t.y=o*Math.cos(a)/1,t.x=o*Math.sin(a)/1,this.czech||(t.y*=-1,t.x*=-1),t},inverse:function(t){var e,i,n,r,s,a,o,h=t.x;t.x=t.y,t.y=h,this.czech||(t.y*=-1,t.x*=-1),s=Math.sqrt(t.x*t.x+t.y*t.y),r=Math.atan2(t.y,t.x)/Math.sin(this.s0),n=2*(Math.atan(Math.pow(this.ro0/s,1/this.n)*Math.tan(this.s0/2+this.s45))-this.s45),e=Math.asin(Math.cos(this.ad)*Math.sin(n)-Math.sin(this.ad)*Math.cos(n)*Math.cos(r)),i=Math.asin(Math.cos(n)*Math.sin(r)/Math.cos(e)),t.x=this.long0-i/this.alfa,a=e,o=0;var l=0;do{t.y=2*(Math.atan(Math.pow(this.k,-1/this.alfa)*Math.pow(Math.tan(e/2+this.s45),1/this.alfa)*Math.pow((1+this.e*Math.sin(a))/(1-this.e*Math.sin(a)),this.e/2))-this.s45),Math.abs(a-t.y)<1e-10&&(o=1),a=t.y,l+=1}while(0===o&&l<15);return l>=15?null:t},names:["Krovak","krovak"]};function Kh(t,e,i,n,r){return t*r-e*Math.sin(2*r)+i*Math.sin(4*r)-n*Math.sin(6*r)}function $h(t){return 1-.25*t*(1+t/16*(3+1.25*t))}function tl(t){return.375*t*(1+.25*t*(1+.46875*t))}function el(t){return.05859375*t*t*(1+.75*t)}function il(t){return t*t*t*(35/3072)}function nl(t,e,i){var n=e*i;return t/Math.sqrt(1-n*n)}function rl(t){return Math.abs(t)<eo?t:t-Po(t)*Math.PI}function sl(t,e,i,n,r){var s,a;s=t/e;for(var o=0;o<15;o++)if(s+=a=(t-(e*s-i*Math.sin(2*s)+n*Math.sin(4*s)-r*Math.sin(6*s)))/(e-2*i*Math.cos(2*s)+4*n*Math.cos(4*s)-6*r*Math.cos(6*s)),Math.abs(a)<=1e-10)return s;return NaN}var al={init:function(){this.sphere||(this.e0=$h(this.es),this.e1=tl(this.es),this.e2=el(this.es),this.e3=il(this.es),this.ml0=this.a*Kh(this.e0,this.e1,this.e2,this.e3,this.lat0))},forward:function(t){var e,i,n=t.x,r=t.y;if(n=Ro(n-this.long0),this.sphere)e=this.a*Math.asin(Math.cos(r)*Math.sin(n)),i=this.a*(Math.atan2(Math.tan(r),Math.cos(n))-this.lat0);else{var s=Math.sin(r),a=Math.cos(r),o=nl(this.a,this.e,s),h=Math.tan(r)*Math.tan(r),l=n*Math.cos(r),c=l*l,u=this.es*a*a/(1-this.es);e=o*l*(1-c*h*(1/6-(8-h+8*u)*c/120)),i=this.a*Kh(this.e0,this.e1,this.e2,this.e3,r)-this.ml0+o*s/a*c*(.5+(5-h+6*u)*c/24)}return t.x=e+this.x0,t.y=i+this.y0,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var e,i,n=t.x/this.a,r=t.y/this.a;if(this.sphere){var s=r+this.lat0;e=Math.asin(Math.sin(s)*Math.cos(n)),i=Math.atan2(Math.tan(n),Math.cos(s))}else{var a=sl(this.ml0/this.a+r,this.e0,this.e1,this.e2,this.e3);if(Math.abs(Math.abs(a)-eo)<=io)return t.x=this.long0,t.y=eo,r<0&&(t.y*=-1),t;var o=nl(this.a,this.e,Math.sin(a)),h=o*o*o/this.a/this.a*(1-this.es),l=Math.pow(Math.tan(a),2),c=n*this.a/o,u=c*c;e=a-o*Math.tan(a)/h*c*c*(.5-(1+3*l)*c*c/24),i=c*(1-u*(l/3+(1+3*l)*l*u/15))/Math.cos(a)}return t.x=Ro(i+this.long0),t.y=rl(e),t},names:["Cassini","Cassini_Soldner","cass"]};function ol(t,e){var i;return t>1e-7?(1-t*t)*(e/(1-(i=t*e)*i)-.5/t*Math.log((1-i)/(1+i))):2*e}var hl=.3333333333333333,ll=.17222222222222222,cl=.10257936507936508,ul=.06388888888888888,dl=.0664021164021164,pl=.016415012942191543;var fl={init:function(){var t,e=Math.abs(this.lat0);if(Math.abs(e-eo)<io?this.mode=this.lat0<0?this.S_POLE:this.N_POLE:Math.abs(e)<io?this.mode=this.EQUIT:this.mode=this.OBLIQ,this.es>0)switch(this.qp=ol(this.e,1),this.mmf=.5/(1-this.es),this.apa=function(t){var e,i=[];return i[0]=t*hl,e=t*t,i[0]+=e*ll,i[1]=e*ul,e*=t,i[0]+=e*cl,i[1]+=e*dl,i[2]=e*pl,i}(this.es),this.mode){case this.N_POLE:case this.S_POLE:this.dd=1;break;case this.EQUIT:this.rq=Math.sqrt(.5*this.qp),this.dd=1/this.rq,this.xmf=1,this.ymf=.5*this.qp;break;case this.OBLIQ:this.rq=Math.sqrt(.5*this.qp),t=Math.sin(this.lat0),this.sinb1=ol(this.e,t)/this.qp,this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1),this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*t*t)*this.rq*this.cosb1),this.ymf=(this.xmf=this.rq)/this.dd,this.xmf*=this.dd}else this.mode===this.OBLIQ&&(this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0))},forward:function(t){var e,i,n,r,s,a,o,h,l,c,u=t.x,d=t.y;if(u=Ro(u-this.long0),this.sphere){if(s=Math.sin(d),c=Math.cos(d),n=Math.cos(u),this.mode===this.OBLIQ||this.mode===this.EQUIT){if((i=this.mode===this.EQUIT?1+c*n:1+this.sinph0*s+this.cosph0*c*n)<=io)return null;e=(i=Math.sqrt(2/i))*c*Math.sin(u),i*=this.mode===this.EQUIT?s:this.cosph0*s-this.sinph0*c*n}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(n=-n),Math.abs(d+this.lat0)<io)return null;i=so-.5*d,e=(i=2*(this.mode===this.S_POLE?Math.cos(i):Math.sin(i)))*Math.sin(u),i*=n}}else{switch(o=0,h=0,l=0,n=Math.cos(u),r=Math.sin(u),s=Math.sin(d),a=ol(this.e,s),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(o=a/this.qp,h=Math.sqrt(1-o*o)),this.mode){case this.OBLIQ:l=1+this.sinb1*o+this.cosb1*h*n;break;case this.EQUIT:l=1+h*n;break;case this.N_POLE:l=eo+d,a=this.qp-a;break;case this.S_POLE:l=d-eo,a=this.qp+a}if(Math.abs(l)<io)return null;switch(this.mode){case this.OBLIQ:case this.EQUIT:l=Math.sqrt(2/l),i=this.mode===this.OBLIQ?this.ymf*l*(this.cosb1*o-this.sinb1*h*n):(l=Math.sqrt(2/(1+h*n)))*o*this.ymf,e=this.xmf*l*h*r;break;case this.N_POLE:case this.S_POLE:a>=0?(e=(l=Math.sqrt(a))*r,i=n*(this.mode===this.S_POLE?l:-l)):e=i=0}}return t.x=this.a*e+this.x0,t.y=this.a*i+this.y0,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var e,i,n,r,s,a,o,h,l,c,u=t.x/this.a,d=t.y/this.a;if(this.sphere){var p,f=0,m=0;if((i=.5*(p=Math.sqrt(u*u+d*d)))>1)return null;switch(i=2*Math.asin(i),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(m=Math.sin(i),f=Math.cos(i)),this.mode){case this.EQUIT:i=Math.abs(p)<=io?0:Math.asin(d*m/p),u*=m,d=f*p;break;case this.OBLIQ:i=Math.abs(p)<=io?this.lat0:Math.asin(f*this.sinph0+d*m*this.cosph0/p),u*=m*this.cosph0,d=(f-Math.sin(i)*this.sinph0)*p;break;case this.N_POLE:d=-d,i=eo-i;break;case this.S_POLE:i-=eo}e=0!==d||this.mode!==this.EQUIT&&this.mode!==this.OBLIQ?Math.atan2(u,d):0}else{if(o=0,this.mode===this.OBLIQ||this.mode===this.EQUIT){if(u/=this.dd,d*=this.dd,(a=Math.sqrt(u*u+d*d))<io)return t.x=this.long0,t.y=this.lat0,t;r=2*Math.asin(.5*a/this.rq),n=Math.cos(r),u*=r=Math.sin(r),this.mode===this.OBLIQ?(o=n*this.sinb1+d*r*this.cosb1/a,s=this.qp*o,d=a*this.cosb1*n-d*this.sinb1*r):(o=d*r/a,s=this.qp*o,d=a*n)}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(d=-d),!(s=u*u+d*d))return t.x=this.long0,t.y=this.lat0,t;o=1-s/this.qp,this.mode===this.S_POLE&&(o=-o)}e=Math.atan2(u,d),h=Math.asin(o),l=this.apa,c=h+h,i=h+l[0]*Math.sin(c)+l[1]*Math.sin(c+c)+l[2]*Math.sin(c+c+c)}return t.x=Ro(this.long0+e),t.y=i,t},names:["Lambert Azimuthal Equal Area","Lambert_Azimuthal_Equal_Area","laea"],S_POLE:1,N_POLE:2,EQUIT:3,OBLIQ:4};function ml(t){return Math.abs(t)>1&&(t=t>1?1:-1),Math.asin(t)}var gl={init:function(){Math.abs(this.lat1+this.lat2)<io||(this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e3=Math.sqrt(this.es),this.sin_po=Math.sin(this.lat1),this.cos_po=Math.cos(this.lat1),this.t1=this.sin_po,this.con=this.sin_po,this.ms1=Ao(this.e3,this.sin_po,this.cos_po),this.qs1=ol(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat2),this.cos_po=Math.cos(this.lat2),this.t2=this.sin_po,this.ms2=Ao(this.e3,this.sin_po,this.cos_po),this.qs2=ol(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat0),this.cos_po=Math.cos(this.lat0),this.t3=this.sin_po,this.qs0=ol(this.e3,this.sin_po,this.cos_po),Math.abs(this.lat1-this.lat2)>io?this.ns0=(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.ns0=this.con,this.c=this.ms1*this.ms1+this.ns0*this.qs1,this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0)},forward:function(t){var e=t.x,i=t.y;this.sin_phi=Math.sin(i),this.cos_phi=Math.cos(i);var n=ol(this.e3,this.sin_phi,this.cos_phi),r=this.a*Math.sqrt(this.c-this.ns0*n)/this.ns0,s=this.ns0*Ro(e-this.long0),a=r*Math.sin(s)+this.x0,o=this.rh-r*Math.cos(s)+this.y0;return t.x=a,t.y=o,t},inverse:function(t){var e,i,n,r,s,a;return t.x-=this.x0,t.y=this.rh-t.y+this.y0,this.ns0>=0?(e=Math.sqrt(t.x*t.x+t.y*t.y),n=1):(e=-Math.sqrt(t.x*t.x+t.y*t.y),n=-1),r=0,0!==e&&(r=Math.atan2(n*t.x,n*t.y)),n=e*this.ns0/this.a,this.sphere?a=Math.asin((this.c-n*n)/(2*this.ns0)):(i=(this.c-n*n)/this.ns0,a=this.phi1z(this.e3,i)),s=Ro(r/this.ns0+this.long0),t.x=s,t.y=a,t},names:["Albers_Conic_Equal_Area","Albers","aea"],phi1z:function(t,e){var i,n,r,s,a=ml(.5*e);if(t<io)return a;for(var o=t*t,h=1;h<=25;h++)if(a+=s=.5*(r=1-(n=t*(i=Math.sin(a)))*n)*r/Math.cos(a)*(e/(1-o)-i/r+.5/t*Math.log((1-n)/(1+n))),Math.abs(s)<=1e-7)return a;return null}};var vl={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0),this.infinity_dist=1e3*this.a,this.rc=1},forward:function(t){var e,i,n,r,s,a,o,h=t.x,l=t.y;return n=Ro(h-this.long0),e=Math.sin(l),i=Math.cos(l),r=Math.cos(n),1,(s=this.sin_p14*e+this.cos_p14*i*r)>0||Math.abs(s)<=io?(a=this.x0+1*this.a*i*Math.sin(n)/s,o=this.y0+1*this.a*(this.cos_p14*e-this.sin_p14*i*r)/s):(a=this.x0+this.infinity_dist*i*Math.sin(n),o=this.y0+this.infinity_dist*(this.cos_p14*e-this.sin_p14*i*r)),t.x=a,t.y=o,t},inverse:function(t){var e,i,n,r,s,a;return t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,t.x/=this.k0,t.y/=this.k0,(e=Math.sqrt(t.x*t.x+t.y*t.y))?(r=Math.atan2(e,this.rc),i=Math.sin(r),a=ml((n=Math.cos(r))*this.sin_p14+t.y*i*this.cos_p14/e),s=Math.atan2(t.x*i,e*this.cos_p14*n-t.y*this.sin_p14*i),s=Ro(this.long0+s)):(a=this.phic0,s=0),t.x=s,t.y=a,t},names:["gnom"]};var yl={init:function(){this.sphere||(this.k0=Ao(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))},forward:function(t){var e,i,n=t.x,r=t.y,s=Ro(n-this.long0);if(this.sphere)e=this.x0+this.a*s*Math.cos(this.lat_ts),i=this.y0+this.a*Math.sin(r)/Math.cos(this.lat_ts);else{var a=ol(this.e,Math.sin(r));e=this.x0+this.a*this.k0*s,i=this.y0+this.a*a*.5/this.k0}return t.x=e,t.y=i,t},inverse:function(t){var e,i;return t.x-=this.x0,t.y-=this.y0,this.sphere?(e=Ro(this.long0+t.x/this.a/Math.cos(this.lat_ts)),i=Math.asin(t.y/this.a*Math.cos(this.lat_ts))):(i=function(t,e){var i=1-(1-t*t)/(2*t)*Math.log((1-t)/(1+t));if(Math.abs(Math.abs(e)-i)<1e-6)return e<0?-1*eo:eo;for(var n,r,s,a,o=Math.asin(.5*e),h=0;h<30;h++)if(r=Math.sin(o),s=Math.cos(o),a=t*r,o+=n=Math.pow(1-a*a,2)/(2*s)*(e/(1-t*t)-r/(1-a*a)+.5/t*Math.log((1-a)/(1+a))),Math.abs(n)<=1e-10)return o;return NaN}(this.e,2*t.y*this.k0/this.a),e=Ro(this.long0+t.x/(this.a*this.k0))),t.x=e,t.y=i,t},names:["cea"]};var xl={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Equidistant Cylindrical (Plate Carre)",this.rc=Math.cos(this.lat_ts)},forward:function(t){var e=t.x,i=t.y,n=Ro(e-this.long0),r=rl(i-this.lat0);return t.x=this.x0+this.a*n*this.rc,t.y=this.y0+this.a*r,t},inverse:function(t){var e=t.x,i=t.y;return t.x=Ro(this.long0+(e-this.x0)/(this.a*this.rc)),t.y=rl(this.lat0+(i-this.y0)/this.a),t},names:["Equirectangular","Equidistant_Cylindrical","eqc"]};var _l={init:function(){this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=$h(this.es),this.e1=tl(this.es),this.e2=el(this.es),this.e3=il(this.es),this.ml0=this.a*Kh(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(t){var e,i,n,r=t.x,s=t.y,a=Ro(r-this.long0);if(n=a*Math.sin(s),this.sphere)Math.abs(s)<=io?(e=this.a*a,i=-1*this.a*this.lat0):(e=this.a*Math.sin(n)/Math.tan(s),i=this.a*(rl(s-this.lat0)+(1-Math.cos(n))/Math.tan(s)));else if(Math.abs(s)<=io)e=this.a*a,i=-1*this.ml0;else{var o=nl(this.a,this.e,Math.sin(s))/Math.tan(s);e=o*Math.sin(n),i=this.a*Kh(this.e0,this.e1,this.e2,this.e3,s)-this.ml0+o*(1-Math.cos(n))}return t.x=e+this.x0,t.y=i+this.y0,t},inverse:function(t){var e,i,n,r,s,a,o,h,l;if(n=t.x-this.x0,r=t.y-this.y0,this.sphere)if(Math.abs(r+this.a*this.lat0)<=io)e=Ro(n/this.a+this.long0),i=0;else{var c;for(a=this.lat0+r/this.a,o=n*n/this.a/this.a+a*a,h=a,s=20;s;--s)if(h+=l=-1*(a*(h*(c=Math.tan(h))+1)-h-.5*(h*h+o)*c)/((h-a)/c-1),Math.abs(l)<=io){i=h;break}e=Ro(this.long0+Math.asin(n*Math.tan(h)/this.a)/Math.sin(i))}else if(Math.abs(r+this.ml0)<=io)i=0,e=Ro(this.long0+n/this.a);else{var u,d,p,f,m;for(a=(this.ml0+r)/this.a,o=n*n/this.a/this.a+a*a,h=a,s=20;s;--s)if(m=this.e*Math.sin(h),u=Math.sqrt(1-m*m)*Math.tan(h),d=this.a*Kh(this.e0,this.e1,this.e2,this.e3,h),p=this.e0-2*this.e1*Math.cos(2*h)+4*this.e2*Math.cos(4*h)-6*this.e3*Math.cos(6*h),h-=l=(a*(u*(f=d/this.a)+1)-f-.5*u*(f*f+o))/(this.es*Math.sin(2*h)*(f*f+o-2*a*f)/(4*u)+(a-f)*(u*p-2/Math.sin(2*h))-p),Math.abs(l)<=io){i=h;break}u=Math.sqrt(1-this.es*Math.pow(Math.sin(i),2))*Math.tan(i),e=Ro(this.long0+Math.asin(n*u/this.a)/Math.sin(i))}return t.x=e,t.y=i,t},names:["Polyconic","poly"]};var Ml={init:function(){this.A=[],this.A[1]=.6399175073,this.A[2]=-.1358797613,this.A[3]=.063294409,this.A[4]=-.02526853,this.A[5]=.0117879,this.A[6]=-.0055161,this.A[7]=.0026906,this.A[8]=-.001333,this.A[9]=67e-5,this.A[10]=-34e-5,this.B_re=[],this.B_im=[],this.B_re[1]=.7557853228,this.B_im[1]=0,this.B_re[2]=.249204646,this.B_im[2]=.003371507,this.B_re[3]=-.001541739,this.B_im[3]=.04105856,this.B_re[4]=-.10162907,this.B_im[4]=.01727609,this.B_re[5]=-.26623489,this.B_im[5]=-.36249218,this.B_re[6]=-.6870983,this.B_im[6]=-1.1651967,this.C_re=[],this.C_im=[],this.C_re[1]=1.3231270439,this.C_im[1]=0,this.C_re[2]=-.577245789,this.C_im[2]=-.007809598,this.C_re[3]=.508307513,this.C_im[3]=-.112208952,this.C_re[4]=-.15094762,this.C_im[4]=.18200602,this.C_re[5]=1.01418179,this.C_im[5]=1.64497696,this.C_re[6]=1.9660549,this.C_im[6]=2.5127645,this.D=[],this.D[1]=1.5627014243,this.D[2]=.5185406398,this.D[3]=-.03333098,this.D[4]=-.1052906,this.D[5]=-.0368594,this.D[6]=.007317,this.D[7]=.0122,this.D[8]=.00394,this.D[9]=-.0013},forward:function(t){var e,i=t.x,n=t.y-this.lat0,r=i-this.long0,s=n/to*1e-5,a=r,o=1,h=0;for(e=1;e<=10;e++)o*=s,h+=this.A[e]*o;var l,c=h,u=a,d=1,p=0,f=0,m=0;for(e=1;e<=6;e++)l=p*c+d*u,d=d*c-p*u,p=l,f=f+this.B_re[e]*d-this.B_im[e]*p,m=m+this.B_im[e]*d+this.B_re[e]*p;return t.x=m*this.a+this.x0,t.y=f*this.a+this.y0,t},inverse:function(t){var e,i,n=t.x,r=t.y,s=n-this.x0,a=(r-this.y0)/this.a,o=s/this.a,h=1,l=0,c=0,u=0;for(e=1;e<=6;e++)i=l*a+h*o,h=h*a-l*o,l=i,c=c+this.C_re[e]*h-this.C_im[e]*l,u=u+this.C_im[e]*h+this.C_re[e]*l;for(var d=0;d<this.iterations;d++){var p,f=c,m=u,g=a,v=o;for(e=2;e<=6;e++)p=m*c+f*u,f=f*c-m*u,m=p,g+=(e-1)*(this.B_re[e]*f-this.B_im[e]*m),v+=(e-1)*(this.B_im[e]*f+this.B_re[e]*m);f=1,m=0;var y=this.B_re[1],x=this.B_im[1];for(e=2;e<=6;e++)p=m*c+f*u,f=f*c-m*u,m=p,y+=e*(this.B_re[e]*f-this.B_im[e]*m),x+=e*(this.B_im[e]*f+this.B_re[e]*m);var _=y*y+x*x;c=(g*y+v*x)/_,u=(v*y-g*x)/_}var M=c,b=u,w=1,S=0;for(e=1;e<=9;e++)w*=M,S+=this.D[e]*w;var E=this.lat0+S*to*1e5,T=this.long0+b;return t.x=T,t.y=E,t},names:["New_Zealand_Map_Grid","nzmg"]};var bl={init:function(){},forward:function(t){var e=t.x,i=t.y,n=Ro(e-this.long0),r=this.x0+this.a*n,s=this.y0+this.a*Math.log(Math.tan(Math.PI/4+i/2.5))*1.25;return t.x=r,t.y=s,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var e=Ro(this.long0+t.x/this.a),i=2.5*(Math.atan(Math.exp(.8*t.y/this.a))-Math.PI/4);return t.x=e,t.y=i,t},names:["Miller_Cylindrical","mill"]};var wl={init:function(){this.sphere?(this.n=1,this.m=0,this.es=0,this.C_y=Math.sqrt((this.m+1)/this.n),this.C_x=this.C_y/(this.m+1)):this.en=Nh(this.es)},forward:function(t){var e,i,n=t.x,r=t.y;if(n=Ro(n-this.long0),this.sphere){if(this.m)for(var s=this.n*Math.sin(r),a=20;a;--a){var o=(this.m*r+Math.sin(r)-s)/(this.m+Math.cos(r));if(r-=o,Math.abs(o)<io)break}else r=1!==this.n?Math.asin(this.n*Math.sin(r)):r;e=this.a*this.C_x*n*(this.m+Math.cos(r)),i=this.a*this.C_y*r}else{var h=Math.sin(r),l=Math.cos(r);i=this.a*Ih(r,h,l,this.en),e=this.a*n*l/Math.sqrt(1-this.es*h*h)}return t.x=e,t.y=i,t},inverse:function(t){var e,i,n;return t.x-=this.x0,i=t.x/this.a,t.y-=this.y0,e=t.y/this.a,this.sphere?(e/=this.C_y,i/=this.C_x*(this.m+Math.cos(e)),this.m?e=ml((this.m*e+Math.sin(e))/this.n):1!==this.n&&(e=ml(Math.sin(e)/this.n)),i=Ro(i+this.long0),e=rl(e)):(e=Oh(t.y/this.a,this.es,this.en),(n=Math.abs(e))<eo?(n=Math.sin(e),i=Ro(this.long0+t.x*Math.sqrt(1-this.es*n*n)/(this.a*Math.cos(e)))):n-io<eo&&(i=this.long0)),t.x=i,t.y=e,t},names:["Sinusoidal","sinu"]};var Sl={init:function(){},forward:function(t){for(var e=t.x,i=t.y,n=Ro(e-this.long0),r=i,s=Math.PI*Math.sin(i);;){var a=-(r+Math.sin(r)-s)/(1+Math.cos(r));if(r+=a,Math.abs(a)<io)break}r/=2,Math.PI/2-Math.abs(i)<io&&(n=0);var o=.900316316158*this.a*n*Math.cos(r)+this.x0,h=1.4142135623731*this.a*Math.sin(r)+this.y0;return t.x=o,t.y=h,t},inverse:function(t){var e,i;t.x-=this.x0,t.y-=this.y0,i=t.y/(1.4142135623731*this.a),Math.abs(i)>.999999999999&&(i=.999999999999),e=Math.asin(i);var n=Ro(this.long0+t.x/(.900316316158*this.a*Math.cos(e)));n<-Math.PI&&(n=-Math.PI),n>Math.PI&&(n=Math.PI),i=(2*e+Math.sin(2*e))/Math.PI,Math.abs(i)>1&&(i=1);var r=Math.asin(i);return t.x=n,t.y=r,t},names:["Mollweide","moll"]};var El={init:function(){Math.abs(this.lat1+this.lat2)<io||(this.lat2=this.lat2||this.lat1,this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=$h(this.es),this.e1=tl(this.es),this.e2=el(this.es),this.e3=il(this.es),this.sinphi=Math.sin(this.lat1),this.cosphi=Math.cos(this.lat1),this.ms1=Ao(this.e,this.sinphi,this.cosphi),this.ml1=Kh(this.e0,this.e1,this.e2,this.e3,this.lat1),Math.abs(this.lat1-this.lat2)<io?this.ns=this.sinphi:(this.sinphi=Math.sin(this.lat2),this.cosphi=Math.cos(this.lat2),this.ms2=Ao(this.e,this.sinphi,this.cosphi),this.ml2=Kh(this.e0,this.e1,this.e2,this.e3,this.lat2),this.ns=(this.ms1-this.ms2)/(this.ml2-this.ml1)),this.g=this.ml1+this.ms1/this.ns,this.ml0=Kh(this.e0,this.e1,this.e2,this.e3,this.lat0),this.rh=this.a*(this.g-this.ml0))},forward:function(t){var e,i=t.x,n=t.y;if(this.sphere)e=this.a*(this.g-n);else{var r=Kh(this.e0,this.e1,this.e2,this.e3,n);e=this.a*(this.g-r)}var s=this.ns*Ro(i-this.long0),a=this.x0+e*Math.sin(s),o=this.y0+this.rh-e*Math.cos(s);return t.x=a,t.y=o,t},inverse:function(t){var e,i,n,r;t.x-=this.x0,t.y=this.rh-t.y+this.y0,this.ns>=0?(i=Math.sqrt(t.x*t.x+t.y*t.y),e=1):(i=-Math.sqrt(t.x*t.x+t.y*t.y),e=-1);var s=0;return 0!==i&&(s=Math.atan2(e*t.x,e*t.y)),this.sphere?(r=Ro(this.long0+s/this.ns),n=rl(this.g-i/this.a),t.x=r,t.y=n,t):(n=sl(this.g-i/this.a,this.e0,this.e1,this.e2,this.e3),r=Ro(this.long0+s/this.ns),t.x=r,t.y=n,t)},names:["Equidistant_Conic","eqdc"]};var Tl={init:function(){this.R=this.a},forward:function(t){var e,i,n=t.x,r=t.y,s=Ro(n-this.long0);Math.abs(r)<=io&&(e=this.x0+this.R*s,i=this.y0);var a=ml(2*Math.abs(r/Math.PI));(Math.abs(s)<=io||Math.abs(Math.abs(r)-eo)<=io)&&(e=this.x0,i=r>=0?this.y0+Math.PI*this.R*Math.tan(.5*a):this.y0+Math.PI*this.R*-Math.tan(.5*a));var o=.5*Math.abs(Math.PI/s-s/Math.PI),h=o*o,l=Math.sin(a),c=Math.cos(a),u=c/(l+c-1),d=u*u,p=u*(2/l-1),f=p*p,m=Math.PI*this.R*(o*(u-f)+Math.sqrt(h*(u-f)*(u-f)-(f+h)*(d-f)))/(f+h);s<0&&(m=-m),e=this.x0+m;var g=h+u;return m=Math.PI*this.R*(p*g-o*Math.sqrt((f+h)*(h+1)-g*g))/(f+h),i=r>=0?this.y0+m:this.y0-m,t.x=e,t.y=i,t},inverse:function(t){var e,i,n,r,s,a,o,h,l,c,u,d;return t.x-=this.x0,t.y-=this.y0,u=Math.PI*this.R,s=(n=t.x/u)*n+(r=t.y/u)*r,u=3*(r*r/(h=-2*(a=-Math.abs(r)*(1+s))+1+2*r*r+s*s)+(2*(o=a-2*r*r+n*n)*o*o/h/h/h-9*a*o/h/h)/27)/(l=(a-o*o/3/h)/h)/(c=2*Math.sqrt(-l/3)),Math.abs(u)>1&&(u=u>=0?1:-1),d=Math.acos(u)/3,i=t.y>=0?(-c*Math.cos(d+Math.PI/3)-o/3/h)*Math.PI:-(-c*Math.cos(d+Math.PI/3)-o/3/h)*Math.PI,e=Math.abs(n)<io?this.long0:Ro(this.long0+Math.PI*(s-1+Math.sqrt(1+2*(n*n-r*r)+s*s))/2/n),t.x=e,t.y=i,t},names:["Van_der_Grinten_I","VanDerGrinten","vandg"]};var Ll={init:function(){this.sin_p12=Math.sin(this.lat0),this.cos_p12=Math.cos(this.lat0)},forward:function(t){var e,i,n,r,s,a,o,h,l,c,u,d,p,f,m,g,v,y,x,_,M,b,w=t.x,S=t.y,E=Math.sin(t.y),T=Math.cos(t.y),L=Ro(w-this.long0);return this.sphere?Math.abs(this.sin_p12-1)<=io?(t.x=this.x0+this.a*(eo-S)*Math.sin(L),t.y=this.y0-this.a*(eo-S)*Math.cos(L),t):Math.abs(this.sin_p12+1)<=io?(t.x=this.x0+this.a*(eo+S)*Math.sin(L),t.y=this.y0+this.a*(eo+S)*Math.cos(L),t):(y=this.sin_p12*E+this.cos_p12*T*Math.cos(L),v=(g=Math.acos(y))?g/Math.sin(g):1,t.x=this.x0+this.a*v*T*Math.sin(L),t.y=this.y0+this.a*v*(this.cos_p12*E-this.sin_p12*T*Math.cos(L)),t):(e=$h(this.es),i=tl(this.es),n=el(this.es),r=il(this.es),Math.abs(this.sin_p12-1)<=io?(s=this.a*Kh(e,i,n,r,eo),a=this.a*Kh(e,i,n,r,S),t.x=this.x0+(s-a)*Math.sin(L),t.y=this.y0-(s-a)*Math.cos(L),t):Math.abs(this.sin_p12+1)<=io?(s=this.a*Kh(e,i,n,r,eo),a=this.a*Kh(e,i,n,r,S),t.x=this.x0+(s+a)*Math.sin(L),t.y=this.y0+(s+a)*Math.cos(L),t):(o=E/T,h=nl(this.a,this.e,this.sin_p12),l=nl(this.a,this.e,E),c=Math.atan((1-this.es)*o+this.es*h*this.sin_p12/(l*T)),x=0===(u=Math.atan2(Math.sin(L),this.cos_p12*Math.tan(c)-this.sin_p12*Math.cos(L)))?Math.asin(this.cos_p12*Math.sin(c)-this.sin_p12*Math.cos(c)):Math.abs(Math.abs(u)-Math.PI)<=io?-Math.asin(this.cos_p12*Math.sin(c)-this.sin_p12*Math.cos(c)):Math.asin(Math.sin(L)*Math.cos(c)/Math.sin(u)),d=this.e*this.sin_p12/Math.sqrt(1-this.es),g=h*x*(1-(_=x*x)*(m=(p=this.e*this.cos_p12*Math.cos(u)/Math.sqrt(1-this.es))*p)*(1-m)/6+(M=_*x)/8*(f=d*p)*(1-2*m)+(b=M*x)/120*(m*(4-7*m)-3*d*d*(1-7*m))-b*x/48*f),t.x=this.x0+g*Math.sin(u),t.y=this.y0+g*Math.cos(u),t))},inverse:function(t){var e,i,n,r,s,a,o,h,l,c,u,d,p,f,m,g,v,y,x,_,M,b,w;if(t.x-=this.x0,t.y-=this.y0,this.sphere){if((e=Math.sqrt(t.x*t.x+t.y*t.y))>2*eo*this.a)return;return i=e/this.a,n=Math.sin(i),r=Math.cos(i),s=this.long0,Math.abs(e)<=io?a=this.lat0:(a=ml(r*this.sin_p12+t.y*n*this.cos_p12/e),o=Math.abs(this.lat0)-eo,s=Math.abs(o)<=io?this.lat0>=0?Ro(this.long0+Math.atan2(t.x,-t.y)):Ro(this.long0-Math.atan2(-t.x,t.y)):Ro(this.long0+Math.atan2(t.x*n,e*this.cos_p12*r-t.y*this.sin_p12*n))),t.x=s,t.y=a,t}return h=$h(this.es),l=tl(this.es),c=el(this.es),u=il(this.es),Math.abs(this.sin_p12-1)<=io?(a=sl(((d=this.a*Kh(h,l,c,u,eo))-(e=Math.sqrt(t.x*t.x+t.y*t.y)))/this.a,h,l,c,u),s=Ro(this.long0+Math.atan2(t.x,-1*t.y)),t.x=s,t.y=a,t):Math.abs(this.sin_p12+1)<=io?(d=this.a*Kh(h,l,c,u,eo),a=sl(((e=Math.sqrt(t.x*t.x+t.y*t.y))-d)/this.a,h,l,c,u),s=Ro(this.long0+Math.atan2(t.x,t.y)),t.x=s,t.y=a,t):(e=Math.sqrt(t.x*t.x+t.y*t.y),m=Math.atan2(t.x,t.y),p=nl(this.a,this.e,this.sin_p12),g=Math.cos(m),y=-(v=this.e*this.cos_p12*g)*v/(1-this.es),x=3*this.es*(1-y)*this.sin_p12*this.cos_p12*g/(1-this.es),b=1-y*(M=(_=e/p)-y*(1+y)*Math.pow(_,3)/6-x*(1+3*y)*Math.pow(_,4)/24)*M/2-_*M*M*M/6,f=Math.asin(this.sin_p12*Math.cos(M)+this.cos_p12*Math.sin(M)*g),s=Ro(this.long0+Math.asin(Math.sin(m)*Math.sin(M)/Math.cos(f))),w=Math.sin(f),a=Math.atan2((w-this.es*b*this.sin_p12)*Math.tan(f),w*(1-this.es)),t.x=s,t.y=a,t)},names:["Azimuthal_Equidistant","aeqd"]};var Cl={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0)},forward:function(t){var e,i,n,r,s,a,o,h=t.x,l=t.y;return n=Ro(h-this.long0),e=Math.sin(l),i=Math.cos(l),r=Math.cos(n),1,((s=this.sin_p14*e+this.cos_p14*i*r)>0||Math.abs(s)<=io)&&(a=1*this.a*i*Math.sin(n),o=this.y0+1*this.a*(this.cos_p14*e-this.sin_p14*i*r)),t.x=a,t.y=o,t},inverse:function(t){var e,i,n,r,s,a,o;return t.x-=this.x0,t.y-=this.y0,i=ml((e=Math.sqrt(t.x*t.x+t.y*t.y))/this.a),n=Math.sin(i),r=Math.cos(i),a=this.long0,Math.abs(e)<=io?(o=this.lat0,t.x=a,t.y=o,t):(o=ml(r*this.sin_p14+t.y*n*this.cos_p14/e),s=Math.abs(this.lat0)-eo,Math.abs(s)<=io?(a=this.lat0>=0?Ro(this.long0+Math.atan2(t.x,-t.y)):Ro(this.long0-Math.atan2(-t.x,t.y)),t.x=a,t.y=o,t):(a=Ro(this.long0+Math.atan2(t.x*n,e*this.cos_p14*r-t.y*this.sin_p14*n)),t.x=a,t.y=o,t))},names:["ortho"]},Al=1,Pl=2,Rl=3,Dl=4,Nl=5,Il=6,Ol=1,Fl=2,Ul=3,zl=4;function kl(t,e,i,n){var r;return t<io?(n.value=Ol,r=0):(r=Math.atan2(e,i),Math.abs(r)<=so?n.value=Ol:r>so&&r<=eo+so?(n.value=Fl,r-=eo):r>eo+so||r<=-(eo+so)?(n.value=Ul,r=r>=0?r-oo:r+oo):(n.value=zl,r+=eo)),r}function Bl(t,e){var i=t+e;return i<-oo?i+=ao:i>+oo&&(i-=ao),i}var Gl={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Quadrilateralized Spherical Cube",this.lat0>=eo-so/2?this.face=Nl:this.lat0<=-(eo-so/2)?this.face=Il:Math.abs(this.long0)<=so?this.face=Al:Math.abs(this.long0)<=eo+so?this.face=this.long0>0?Pl:Dl:this.face=Rl,0!==this.es&&(this.one_minus_f=1-(this.a-this.b)/this.a,this.one_minus_f_squared=this.one_minus_f*this.one_minus_f)},forward:function(t){var e,i,n,r,s,a,o={x:0,y:0},h={value:0};if(t.x-=this.long0,e=0!==this.es?Math.atan(this.one_minus_f_squared*Math.tan(t.y)):t.y,i=t.x,this.face===Nl)r=eo-e,i>=so&&i<=eo+so?(h.value=Ol,n=i-eo):i>eo+so||i<=-(eo+so)?(h.value=Fl,n=i>0?i-oo:i+oo):i>-(eo+so)&&i<=-so?(h.value=Ul,n=i+eo):(h.value=zl,n=i);else if(this.face===Il)r=eo+e,i>=so&&i<=eo+so?(h.value=Ol,n=-i+eo):i<so&&i>=-so?(h.value=Fl,n=-i):i<-so&&i>=-(eo+so)?(h.value=Ul,n=-i-eo):(h.value=zl,n=i>0?-i+oo:-i-oo);else{var l,c,u,d,p,f;this.face===Pl?i=Bl(i,+eo):this.face===Rl?i=Bl(i,+oo):this.face===Dl&&(i=Bl(i,-eo)),d=Math.sin(e),p=Math.cos(e),f=Math.sin(i),l=p*Math.cos(i),c=p*f,u=d,this.face===Al?n=kl(r=Math.acos(l),u,c,h):this.face===Pl?n=kl(r=Math.acos(c),u,-l,h):this.face===Rl?n=kl(r=Math.acos(-l),u,-c,h):this.face===Dl?n=kl(r=Math.acos(-c),u,l,h):(r=n=0,h.value=Ol)}return a=Math.atan(12/oo*(n+Math.acos(Math.sin(n)*Math.cos(so))-eo)),s=Math.sqrt((1-Math.cos(r))/(Math.cos(a)*Math.cos(a))/(1-Math.cos(Math.atan(1/Math.cos(n))))),h.value===Fl?a+=eo:h.value===Ul?a+=oo:h.value===zl&&(a+=1.5*oo),o.x=s*Math.cos(a),o.y=s*Math.sin(a),o.x=o.x*this.a+this.x0,o.y=o.y*this.a+this.y0,t.x=o.x,t.y=o.y,t},inverse:function(t){var e,i,n,r,s,a,o,h,l,c,u,d,p={lam:0,phi:0},f={value:0};if(t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,i=Math.atan(Math.sqrt(t.x*t.x+t.y*t.y)),e=Math.atan2(t.y,t.x),t.x>=0&&t.x>=Math.abs(t.y)?f.value=Ol:t.y>=0&&t.y>=Math.abs(t.x)?(f.value=Fl,e-=eo):t.x<0&&-t.x>=Math.abs(t.y)?(f.value=Ul,e=e<0?e+oo:e-oo):(f.value=zl,e+=eo),l=oo/12*Math.tan(e),s=Math.sin(l)/(Math.cos(l)-1/Math.sqrt(2)),a=Math.atan(s),(o=1-(n=Math.cos(e))*n*(r=Math.tan(i))*r*(1-Math.cos(Math.atan(1/Math.cos(a)))))<-1?o=-1:o>1&&(o=1),this.face===Nl)h=Math.acos(o),p.phi=eo-h,f.value===Ol?p.lam=a+eo:f.value===Fl?p.lam=a<0?a+oo:a-oo:f.value===Ul?p.lam=a-eo:p.lam=a;else if(this.face===Il)h=Math.acos(o),p.phi=h-eo,f.value===Ol?p.lam=-a+eo:f.value===Fl?p.lam=-a:f.value===Ul?p.lam=-a-eo:p.lam=a<0?-a-oo:-a+oo;else{var m,g,v;l=(m=o)*m,g=(l+=(v=l>=1?0:Math.sqrt(1-l)*Math.sin(a))*v)>=1?0:Math.sqrt(1-l),f.value===Fl?(l=g,g=-v,v=l):f.value===Ul?(g=-g,v=-v):f.value===zl&&(l=g,g=v,v=-l),this.face===Pl?(l=m,m=-g,g=l):this.face===Rl?(m=-m,g=-g):this.face===Dl&&(l=m,m=g,g=-l),p.phi=Math.acos(-v)-eo,p.lam=Math.atan2(g,m),this.face===Pl?p.lam=Bl(p.lam,-eo):this.face===Rl?p.lam=Bl(p.lam,-oo):this.face===Dl&&(p.lam=Bl(p.lam,+eo))}return 0!==this.es&&(c=p.phi<0?1:0,u=Math.tan(p.phi),d=this.b/Math.sqrt(u*u+this.one_minus_f_squared),p.phi=Math.atan(Math.sqrt(this.a*this.a-d*d)/(this.one_minus_f*d)),c&&(p.phi=-p.phi)),p.lam+=this.long0,t.x=p.lam,t.y=p.phi,t},names:["Quadrilateralized Spherical Cube","Quadrilateralized_Spherical_Cube","qsc"]},Hl=[[1,22199e-21,-715515e-10,31103e-10],[.9986,-482243e-9,-24897e-9,-13309e-10],[.9954,-83103e-8,-448605e-10,-9.86701e-7],[.99,-.00135364,-59661e-9,36777e-10],[.9822,-.00167442,-449547e-11,-572411e-11],[.973,-.00214868,-903571e-10,1.8736e-8],[.96,-.00305085,-900761e-10,164917e-11],[.9427,-.00382792,-653386e-10,-26154e-10],[.9216,-.00467746,-10457e-8,481243e-11],[.8962,-.00536223,-323831e-10,-543432e-11],[.8679,-.00609363,-113898e-9,332484e-11],[.835,-.00698325,-640253e-10,9.34959e-7],[.7986,-.00755338,-500009e-10,9.35324e-7],[.7597,-.00798324,-35971e-9,-227626e-11],[.7186,-.00851367,-701149e-10,-86303e-10],[.6732,-.00986209,-199569e-9,191974e-10],[.6213,-.010418,883923e-10,624051e-11],[.5722,-.00906601,182e-6,624051e-11],[.5322,-.00677797,275608e-9,624051e-11]],Vl=[[-520417e-23,.0124,121431e-23,-845284e-16],[.062,.0124,-1.26793e-9,4.22642e-10],[.124,.0124,5.07171e-9,-1.60604e-9],[.186,.0123999,-1.90189e-8,6.00152e-9],[.248,.0124002,7.10039e-8,-2.24e-8],[.31,.0123992,-2.64997e-7,8.35986e-8],[.372,.0124029,9.88983e-7,-3.11994e-7],[.434,.0123893,-369093e-11,-4.35621e-7],[.4958,.0123198,-102252e-10,-3.45523e-7],[.5571,.0121916,-154081e-10,-5.82288e-7],[.6176,.0119938,-241424e-10,-5.25327e-7],[.6769,.011713,-320223e-10,-5.16405e-7],[.7346,.0113541,-397684e-10,-6.09052e-7],[.7903,.0109107,-489042e-10,-104739e-11],[.8435,.0103431,-64615e-9,-1.40374e-9],[.8936,.00969686,-64636e-9,-8547e-9],[.9394,.00840947,-192841e-9,-42106e-10],[.9761,.00616527,-256e-6,-42106e-10],[1,.00328947,-319159e-9,-42106e-10]],Wl=.8487,jl=1.3523,Xl=ro/5,ql=18,Yl=function(t,e){return t[0]+e*(t[1]+e*(t[2]+e*t[3]))};var Zl={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.long0=this.long0||0,this.es=0,this.title=this.title||"Robinson"},forward:function(t){var e=Ro(t.x-this.long0),i=Math.abs(t.y),n=Math.floor(i*Xl);n<0?n=0:n>=ql&&(n=17);var r={x:Yl(Hl[n],i=ro*(i-.08726646259971647*n))*e,y:Yl(Vl[n],i)};return t.y<0&&(r.y=-r.y),r.x=r.x*this.a*Wl+this.x0,r.y=r.y*this.a*jl+this.y0,r},inverse:function(t){var e={x:(t.x-this.x0)/(this.a*Wl),y:Math.abs(t.y-this.y0)/(this.a*jl)};if(e.y>=1)e.x/=Hl[18][0],e.y=t.y<0?-eo:eo;else{var i=Math.floor(e.y*ql);for(i<0?i=0:i>=ql&&(i=17);;)if(Vl[i][0]>e.y)--i;else{if(!(Vl[i+1][0]<=e.y))break;++i}var n=Vl[i],r=5*(e.y-n[0])/(Vl[i+1][0]-n[0]);r=function(t,e,i,n){for(var r=e;n;--n){var s=t(r);if(r-=s,Math.abs(s)<i)break}return r}((function(t){return(Yl(n,t)-e.y)/function(t,e){return t[1]+e*(2*t[2]+3*e*t[3])}(n,t)}),r,io,100),e.x/=Yl(Hl[i],r),e.y=(5*i+r)*no,t.y<0&&(e.y=-e.y)}return e.x=Ro(e.x+this.long0),e},names:["Robinson","robin"]};var Jl={init:function(){this.name="geocent"},forward:function(t){return Qo(t,this.es,this.a)},inverse:function(t){return Ko(t,this.es,this.a,this.b)},names:["Geocentric","geocentric","geocent","Geocent"]},Ql=0,Kl=1,$l=2,tc=3,ec={h:{def:1e5,num:!0},azi:{def:0,num:!0,degrees:!0},tilt:{def:0,num:!0,degrees:!0},long0:{def:0,num:!0},lat0:{def:0,num:!0}};var ic={init:function(){if(Object.keys(ec).forEach(function(t){if(void 0===this[t])this[t]=ec[t].def;else{if(ec[t].num&&isNaN(this[t]))throw new Error("Invalid parameter value, must be numeric "+t+" = "+this[t]);ec[t].num&&(this[t]=parseFloat(this[t]))}ec[t].degrees&&(this[t]=this[t]*no)}.bind(this)),Math.abs(Math.abs(this.lat0)-eo)<io?this.mode=this.lat0<0?Kl:Ql:Math.abs(this.lat0)<io?this.mode=$l:(this.mode=tc,this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0)),this.pn1=this.h/this.a,this.pn1<=0||this.pn1>1e10)throw new Error("Invalid height");this.p=1+this.pn1,this.rp=1/this.p,this.h1=1/this.pn1,this.pfact=(this.p+1)*this.h1,this.es=0;var t=this.tilt,e=this.azi;this.cg=Math.cos(e),this.sg=Math.sin(e),this.cw=Math.cos(t),this.sw=Math.sin(t)},forward:function(t){t.x-=this.long0;var e,i,n,r,s=Math.sin(t.y),a=Math.cos(t.y),o=Math.cos(t.x);switch(this.mode){case tc:i=this.sinph0*s+this.cosph0*a*o;break;case $l:i=a*o;break;case Kl:i=-s;break;case Ql:i=s}switch(e=(i=this.pn1/(this.p-i))*a*Math.sin(t.x),this.mode){case tc:i*=this.cosph0*s-this.sinph0*a*o;break;case $l:i*=s;break;case Ql:i*=-a*o;break;case Kl:i*=a*o}return r=1/((n=i*this.cg+e*this.sg)*this.sw*this.h1+this.cw),e=(e*this.cg-i*this.sg)*this.cw*r,i=n*r,t.x=e*this.a,t.y=i*this.a,t},inverse:function(t){t.x/=this.a,t.y/=this.a;var e,i,n,r={x:t.x,y:t.y};n=1/(this.pn1-t.y*this.sw),e=this.pn1*t.x*n,i=this.pn1*t.y*this.cw*n,t.x=e*this.cg+i*this.sg,t.y=i*this.cg-e*this.sg;var s=zh(t.x,t.y);if(Math.abs(s)<io)r.x=0,r.y=t.y;else{var a,o;switch(o=1-s*s*this.pfact,o=(this.p-Math.sqrt(o))/(this.pn1/s+s/this.pn1),a=Math.sqrt(1-o*o),this.mode){case tc:r.y=Math.asin(a*this.sinph0+t.y*o*this.cosph0/s),t.y=(a-this.sinph0*Math.sin(r.y))*s,t.x*=o*this.cosph0;break;case $l:r.y=Math.asin(t.y*o/s),t.y=a*s,t.x*=o;break;case Ql:r.y=Math.asin(a),t.y=-t.y;break;case Kl:r.y=-Math.asin(a)}r.x=Math.atan2(t.x,t.y)}return t.x=r.x+this.long0,t.y=r.y,t},names:["Tilted_Perspective","tpers"]};function nc(t){this.surveyTree=new Qa,this.limits=new $,this.offsets=new J,this.allStations=[],this.lineSegments=[],this.xGroups=[],this.scraps=[],this.terrains=[],this.sourceCRS=null,this.targetCRS="EPSG:3857",this.displayCRS=null,this.projection=null,this.hasTerrain=!1,this.messages=[],this.metadata=null,this.fileCount=0,this.ctx=t}function rc(t,e){e||alert("No callback specified"),this.callback=e,this.dataResponse=null,this.metadataResponse=null,this.requests=[],this.ctx=t,this.reset()}function sc(t,e){const i=e.materials;return void 0===i.pointGeometry&&(i.pointGeometry=(new Te).setAttribute("position",new Qt([0,0,0],3))),Jr.call(this,i.pointGeometry,t),this.type="Point",this}function ac(t,e){const i=t.materials;return sc.call(this,i.getClusterMaterial(e),t),this.renderOrder=1,this}uh.defaultDatum="WGS84",uh.Proj=Jo,uh.WGS84=new uh.Proj("WGS84"),uh.Point=Ah,uh.toPoint=sh,uh.defs=So,uh.nadgrid=function(t,e){var i=new DataView(e),n=function(t){var e=t.getInt32(8,!1);if(11===e)return!1;11!==(e=t.getInt32(8,!0))&&console.warn("Failed to detect nadgrid endian-ness, defaulting to little-endian");return!0}(i),r=function(t,e){return{nFields:t.getInt32(8,e),nSubgridFields:t.getInt32(24,e),nSubgrids:t.getInt32(40,e),shiftType:Xo(t,56,64).trim(),fromSemiMajorAxis:t.getFloat64(120,e),fromSemiMinorAxis:t.getFloat64(136,e),toSemiMajorAxis:t.getFloat64(152,e),toSemiMinorAxis:t.getFloat64(168,e)}}(i,n);r.nSubgrids>1&&console.log("Only single NTv2 subgrids are currently supported, subsequent sub grids are ignored");var s={header:r,subgrids:function(t,e,i){for(var n=176,r=[],s=0;s<e.nSubgrids;s++){var a=Yo(t,n,i),o=Zo(t,n,a,i),h=Math.round(1+(a.upperLongitude-a.lowerLongitude)/a.longitudeInterval),l=Math.round(1+(a.upperLatitude-a.lowerLatitude)/a.latitudeInterval);r.push({ll:[jo(a.lowerLongitude),jo(a.lowerLatitude)],del:[jo(a.longitudeInterval),jo(a.latitudeInterval)],lim:[h,l],count:a.gridNodeCount,cvs:qo(o)})}return r}(i,r,n)};return Vo[t]=s,s},uh.transform=oh,uh.mgrs=xh,uh.version="__VERSION__",function(t){t.Proj.projections.add(Fh),t.Proj.projections.add(Hh),t.Proj.projections.add(Vh),t.Proj.projections.add(Xh),t.Proj.projections.add(qh),t.Proj.projections.add(Yh),t.Proj.projections.add(Zh),t.Proj.projections.add(Jh),t.Proj.projections.add(Qh),t.Proj.projections.add(al),t.Proj.projections.add(fl),t.Proj.projections.add(gl),t.Proj.projections.add(vl),t.Proj.projections.add(yl),t.Proj.projections.add(xl),t.Proj.projections.add(_l),t.Proj.projections.add(Ml),t.Proj.projections.add(bl),t.Proj.projections.add(wl),t.Proj.projections.add(Sl),t.Proj.projections.add(El),t.Proj.projections.add(Tl),t.Proj.projections.add(Ll),t.Proj.projections.add(Cl),t.Proj.projections.add(Gl),t.Proj.projections.add(Zl),t.Proj.projections.add(Jl),t.Proj.projections.add(ic)}(uh),nc.prototype.setCRS=function(t){if(null!==t){const i=t.match(/\+init=(.*)\s/);if(i&&2===i.length){const n=i[1];var e;switch(n){case"epsg:27700":t="+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs";break;default:if(null!=(e=n.match(/epsg:([0-9]+)/)))return console.log("looking up CRS code EPSG:"+e[1]),fetch("https://epsg.io/"+e[1]+".proj4").then((t=>t.text())).then((t=>{this._setCRS(t)})).catch((function(){console.log("CRS lookup failed")}));console.log("Unsupported projection:",t),t=null}}}return this._setCRS(t),Promise.resolve(null)},nc.prototype._setCRS=function(t){const e=this.ctx.cfg,i=e.value("displayCRS","EPSG:3857");null===t&&null!==(t=e.value("defaultCRS",null))&&console.log("Using default projection."),null!==t&&(this.sourceCRS=t,"ORIGINAL"===i?this.displayCRS="ORIGINAL":(console.log("Reprojecting from",t,"to",this.targetCRS),this.projection=uh(this.sourceCRS,this.targetCRS),this.displayCRS=this.targetCRS))},nc.prototype.addStations=function(t){this.fileCount++,this.allStations.push(t)},nc.prototype.addLineSegments=function(t){const e=this.lineSegments,i=t.length;var n;for(n=0;n<i;n++){const i=t[n],r=i.length-1;let s;for(s=0;s<r;s++){const t=i[s],n=i[s+1],r=t.coords,a=n.coords;e.push({from:r,to:a,type:n.type,survey:n.survey})}}},nc.prototype.addXsects=function(t){const e=[],i=[];var n,r,s;for(t.sort((function(t,e){return t.m_from-e.m_from})),s=0;s<t.length;s++){const i=t[s];i.m_from!==n&&(r=[],e.push(r)),n=i.m_to,r.push(i)}for(s=0;s<e.length;s++){const t=e[s],n=t[0].m_from,r=t[t.length-1].m_to,a=i.indexOf(n);-1!==a&&(e[s]=e[a].concat(t),e[a]=[],i[a]=void 0),i.push(r)}for(s=0;s<e.length;s++){const t=e[s];if(t.length<2)continue;const i=t[0],n=t[1];if(void 0===i)continue;const r=n.start,a=n.end;i.start=(new J).copy(r).multiplyScalar(2).sub(a),this.xGroups.push(t)}},nc.prototype.getSurvey=function(){const t=this.limits;if(!this.hasTerrain){const e=t.min,i=t.max;t.expandByVector(new J(.05*(i.x-e.x),.05*(i.y-e.y),0))}const e=t.getCenter(this.offsets);this.allStations.forEach((function(t){t.forEach((function(t){t.sub(e)}))}));const i=this.scraps;var n,r;for(n=0;n<i.length;n++){const t=i[n].vertices;for(r=0;r<t.length;r++)t[r].sub(e)}return{title:this.fileName,surveyTree:this.surveyTree,sourceCRS:this.sourceCRS,displayCRS:this.displayCRS,lineSegments:this.lineSegments,crossSections:this.xGroups,scraps:this.scraps,hasTerrain:this.hasTerrain,metadata:this.metadata,terrains:this.terrains,limits:this.limits,offsets:this.offsets}},rc.prototype=Object.create(u.prototype),rc.prototype.constructor=rc,rc.prototype.reset=function(){this.files=null,this.handler=null,this.section=null,this.requests.forEach((function(t){t.abort()})),this.requests=[],this.models=new nc(this.ctx)},rc.prototype.setHandler=function(t){const e=t.split(".").reverse().shift().toLowerCase();switch(e){case"3d":this.handler=new Xa(t);break;case"lox":this.handler=new Ya(t);break;case"plt":this.handler=new Ja(t);break;default:return console.warn("CaveView: unknown file extension [",e,"]"),!1}return!0},rc.prototype.loadFile=function(t,e){t instanceof File?this.loadLocalFile(t,e):this.loadURL(t,e)},rc.prototype.loadFiles=function(t){this.files=t,this.loadFile(t.pop())},rc.prototype.loadURL=function(t,e){const i=this.ctx.cfg;this.dispatchEvent({type:"progress",name:"start"}),void 0!==e&&(this.section=e);const n=this,r=i.value("surveyDirectory",""),s=i.value("loadMetadata",!1);if(!this.setHandler(t))return!1;const a=s?2:1;var o=0;const h=(new cs).setPath(r);if(s){h.setResponseType("json");const e=h.load(Va(t,"json"),(function(t){n.metadataResponse=t,++o===a&&n.callHandler()}),void 0,(function(t){if("abort"===t.type)return;++o===a&&n.callHandler()}));e&&this.requests.push(e)}h.setResponseType(this.handler.type);const l=h.load(t,(function(t){n.dataResponse=t,++o===a&&n.callHandler()}),(function(t){t.total>0&&n.dispatchEvent({type:"progress",name:"set",progress:Math.round(100*t.loaded/t.total)})}),(function(t){if("abort"===t.type)return;console.warn("error event",t),++o===a&&n.callHandler()}));return l&&this.requests.push(l),!0},rc.prototype.loadLocalFile=function(t,e){this.dispatchEvent({type:"progress",name:"start"}),void 0!==e&&(this.section=e);const i=this,n=t.name;if(!this.setHandler(n))return!1;const r=new FileReader;switch(r.addEventListener("load",(function t(){i.dataResponse=r.result,i.callHandler(),r.removeEventListener("load",t),r.removeEventListener("progress",s)})),r.addEventListener("progress",s),this.handler.type){case"arraybuffer":r.readAsArrayBuffer(t);break;case"text":r.readAsText(t);break;default:return alert("unknown file data type"),!1}return!0;function s(t){t.total>0&&i.dispatchEvent({type:"progress",name:"set",progress:Math.round(100*t.loaded/t.total)})}},rc.prototype.callHandler=function(){if(null===this.dataResponse)return this.callback(!1),void this.dispatchEvent({type:"progress",name:"end"});const t=this.dataResponse,e=this.metadataResponse,i=this.section,n=this.files;this.dataResponse=null,this.metadataResponse=null;const r=null!==n&&n.length>0,s=this.handler;this.handler=null,r&&this.loadFile(n.pop()),s.parse(this.models,t,e,i).then((t=>{r||(this.callback(t),this.dispatchEvent({type:"progress",name:"end"}))}))},sc.prototype=Object.create(Jr.prototype),ac.prototype=Object.create(sc.prototype),ac.prototype.isMarker=!0,ac.prototype.adjustHeight=function(t){this.position.setZ(t(this.position)+10)};const oc=new J,hc=new J,lc=new J,cc=new J,uc=new $e(oc,hc,lc),dc=new $e(oc,lc,cc),pc=new xt,fc=new J;function mc(t,e,i,n,r){this.nodes=new Array(4),this.count=0,this.markers=[],this.quadMarker=null,this.centroid=new J,this.ctx=t,this.xMin=e,this.xMax=i,this.yMin=n,this.yMax=r}function gc(t,e,i){ve.call(this);const n=e.min,r=e.max;return this.maxDepth=i,this.type="CV.ClusterMarker",this.quadTree=new mc(t,n.x,r.x,n.y,r.y),this.heightProvider=null,this.labels=[],this.ctx=t,this.addEventListener("removed",this.onRemoved),this}function vc(t,e){gc.call(this,t,e.modelLimits,4);const i=this,n=e.surveyTree,r=e.metadata.entrances,s=[],a=[],o=new Te,h=new jr({map:t.materials.textureCache.getTexture("disc-outlined"),opacity:1,alphaTest:.8,sizeAttenuation:!1,transparent:!0,size:Math.max(10,Math.floor(t.container.clientWidth/100)),vertexColors:!0});h.stencilWrite=!0,h.stencilZPass=I,t.viewer.addEventListener("resized",(t=>{h.size=Math.max(10,Math.floor(t.width/100))})),this.entranceColor=t.cfg.themeColor("stations.entrances.marker");const l=new Jr(o,h);l.layers.set(17);for(var c=n;1===c.children.length;)c=c.children[0];n.traverse((function(t){var e;if(1!==t.type)return;const n=r[t.getPath()];e=void 0!==n&&void 0!==n.name?n.name:void 0!==t.comment?t.comment:t.getPath(c);if(s.push(t.p),a.push(t),"-skip"===e)return;i.addMarker(t," "+e+" ")}));const u=3*s.length;if(u>0){const t=new Qt(u,3),e=new Qt(u,3);t.copyVector3sArray(s),o.setAttribute("position",t),o.setAttribute("color",e)}else this.visible=!1;return this.markers=l,this.stations=a,this.metadata=e.metadata,this.setSelection(null),this.addStatic(l),this}mc.prototype.addNode=function(t,e){if(0==e--)return;const i=t.position,n=this.ctx,r=(this.xMin+this.xMax)/2,s=(this.yMin+this.yMax)/2;this.markers.push(t),this.centroid.add(i),this.count++;var a=0;i.x>r&&(a+=1),i.y>s&&(a+=2);var o=this.nodes[a];if(void 0===o){switch(a){case 0:o=new mc(n,this.xMin,r,this.yMin,s);break;case 1:o=new mc(n,r,this.xMax,this.yMin,s);break;case 2:o=new mc(n,this.xMin,r,s,this.yMax);break;case 3:o=new mc(n,r,this.xMax,s,this.yMax)}this.nodes[a]=o}o.addNode(t,e)},mc.prototype.check=function(t,e,i,n){var r,s;for(s=0;s<4;s++)if(void 0!==(r=this.nodes[s])){if(r.count<2){this.nodes[s]=void 0;continue}const a=r.projectedArea(t);oc.subVectors(t.camera.position,e);const o=2*oc.length();oc.normalize(),pc.setFromNormalAndCoplanarPoint(oc,t.camera.position),null===this.quadMarker?hc.copy(this.centroid.clone().divideScalar(this.count)).applyMatrix4(t.matrixWorld):hc.copy(this.quadMarker.position).applyMatrix4(t.matrixWorld);a<10*((o-Math.abs(pc.distanceToPoint(hc)))/o)*i?r.clusterMarkers(t):(r.showMarkers(n),r.check(t,e,i,n))}},mc.prototype.showMarkers=function(t){this.markers.forEach((function(e){e.visible=t.contains(e.stationID)})),null!==this.quadMarker&&(this.quadMarker.visible=!1)},mc.prototype.hideMarkers=function(){this.markers.forEach((function(t){t.visible=!1})),null!==this.quadMarker&&(this.quadMarker.visible=!1)},mc.prototype.clusterMarkers=function(t){var e;for(this.hideMarkers(),e=0;e<4;e++){const t=this.nodes[e];void 0!==t&&t.hideQuadMarkers()}if(null===this.quadMarker){const e=new ac(this.ctx,this.count);e.position.copy(this.centroid).divideScalar(this.count),e.layers.set(16),null!==t.heightProvider&&e.adjustHeight(t.heightProvider),t.addStatic(e),this.quadMarker=e}this.quadMarker.visible=!0},mc.prototype.hideQuadMarkers=function(){var t;for(this.quadMarker&&(this.quadMarker.visible=!1),t=0;t<4;t++){const e=this.nodes[t];void 0!==e&&e.hideQuadMarkers()}},mc.prototype.projectedArea=function(t){const e=t.camera,i=t.matrixWorld,n=this.centroid.z/this.count;return oc.set(this.xMin,this.yMin,n).applyMatrix4(i).project(e),hc.set(this.xMin,this.yMax,n).applyMatrix4(i).project(e),lc.set(this.xMax,this.yMax,n).applyMatrix4(i).project(e),cc.set(this.xMax,this.yMin,n).applyMatrix4(i).project(e),uc.getArea()+dc.getArea()},gc.prototype=Object.create(ve.prototype),gc.prototype.addHeightProvider=function(t){this.heightProvider=t,this.traverse((function(e){e.isMarker&&e.adjustHeight(t)}))},gc.prototype.onRemoved=function(){this.traverse((function(t){"GlyphString"===t.type&&t.geometry.dispose()}))},gc.prototype.addMarker=function(t,e){const i=this.ctx.cfg,n=this.ctx.materials,r={background:i.themeColorCSS("stations.entrances.background"),color:i.themeColorCSS("stations.entrances.text"),font:"normal helvetica,sans-serif"},s=n.getGlyphMaterial(r,Math.PI/4);s.depthTest=!0,s.transparent=!1,s.alphaTest=0;const a=new qs(e,s,this.ctx);return a.layers.set(6),a.position.copy(t.p),a.stationID=t.id,this.labels.push(a),this.quadTree.addNode(a,this.maxDepth),this.addStatic(a),a},gc.prototype.cluster=function(t,e,i){if(this.children.length<2)return;this.camera=t;const n=this.camera.getWorldDirection(fc).dot(ve.DefaultUp);this.quadTree.check(this,e,Math.max(.05,1-Math.cos(n)),i)},vc.prototype=Object.create(gc.prototype),vc.prototype.getStation=function(t){const e=this.stations[t],i=e.getPath();return{station:e,name:i,info:this.metadata.entrances[i]}},vc.prototype.setStation=function(t,e){const i=this.metadata;i.entrances[t.getPath()]=e,i.saveLocal()},vc.prototype.intersectLabels=function(t,e,i){var n=this.labels.filter((function(n){return n.intersects(t,e,i)})).sort((function(t,e){return t.depth-e.depth}));return 0===n.length?null:n[0]},vc.prototype.setSelection=function(t){const e=this.markers.geometry.getAttribute("color"),i=this.entranceColor;if(void 0!==e){if(null===t||t.isEmpty()){const t=e.array,n=t.length;for(let e=0;e<n;e+=3)i.toArray(t,e)}else{const n=t.getIds();this.stations.forEach((function(t,r){n.has(t.id)?i.toArray(e,3*r):e.setXYZ(r,.5,.5,.5)}))}e.needsUpdate=!0}};function yc(t,e){const i=t.materials;void 0===i.pointerTexture&&(i.pointerTexture=(new hs).load("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='36px' height='36px'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M20.94 11c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z'/%3E%3C/svg%3E"));const n=new jr({size:32,map:i.pointerTexture,transparent:!0,sizeAttenuation:!1,alphaTest:.8,color:e});return sc.call(this,n,t),this}yc.prototype=Object.create(sc.prototype);const xc=new J;function _c(){this.array=null}function Mc(t,e){Jr.call(this,new Te,t.materials.getExtendedPointsMaterial()),this.type="CV.Stations",this.map=new Map,this.stationCount=0;const i=t.cfg;this.baseColor=i.themeColor("stations.default.marker"),this.junctionColor=i.themeColor("stations.junctions.marker"),this.entranceColor=i.themeColor("stations.entrances.marker"),this.pointSizes=[],this.vertices=[],this.colors=[],this.stations=[],this.selected=null,this.selectedSize=0,this.selection=e,this.splaysVisible=!1;const n=new yc(t,16711680);n.visible=!1,this.addStatic(n),this.highlightPoint=n}Mc.prototype=Object.create(Jr.prototype),Mc.prototype.addStation=function(t){const e=t.p;if(void 0!==this.map.get(e))return;const i=e.connections;this.vertices.push(e);var n=0;1===t.type?(this.colors.push(this.entranceColor),n=12):(this.colors.push(i>2?this.junctionColor:this.baseColor),n=8),this.pointSizes.push(n),this.map.set(e,t),this.stations.push(t),t.stationVertexIndex=this.stationCount++,t.linkedSegments=[],t.legs=[],t.distance=1/0},Mc.prototype.getStation=function(t){return this.map.get(t)},Mc.prototype.getVisibleStation=function(t){const e=this.map.get(t);return this.selection.contains(e.id)&&(e.p.connections>0||this.splaysVisible)?e:(void 0!==e.label&&(e.label.visible=!1),null)},Mc.prototype.getStationByIndex=function(t){return this.stations[t]},Mc.prototype.clearSelected=function(){if(null!==this.selected){const t=this.geometry.getAttribute("pSize");t.setX(this.selected,this.selectedSize),t.needsUpdate=!0,this.selected=null}},Mc.prototype.highlightStation=function(t){const e=this.highlightPoint;return e.position.copy(t.p),e.updateMatrix(),e.visible=!0,t},Mc.prototype.clearHighlight=function(){this.highlightPoint.visible=!1},Mc.prototype.selectStation=function(t){this.selectStationByIndex(t.stationVertexIndex)},Mc.prototype.selectStationByIndex=function(t){const e=this.geometry.getAttribute("pSize");null!==this.selected&&e.setX(this.selected,this.selectedSize),this.selectedSize=e.getX(t),e.setX(t,2*this.selectedSize),e.needsUpdate=!0,this.selected=t},Mc.prototype.selectStations=function(t){const e=this.stations,i=e.length,n=this.geometry.getAttribute("pSize"),r=this.splaysVisible?6:0,s=t.getIds(),a=t.isEmpty();var o;for(o=0;o<i;o++){const t=e[o];let i=8;a||s.has(t.id)?(1===t.type?i=12:0===t.p.connections&&(i=r),n.setX(o,i)):(n.setX(o,0),void 0!==t.label&&(t.label.visible=!1))}n.needsUpdate=!0},Mc.prototype.finalise=function(){const t=this.geometry,e=new Qt(3*this.vertices.length,3),i=new Qt(3*this.colors.length,3);t.setAttribute("pSize",new Qt(this.pointSizes,1)),t.setAttribute("position",e.copyVector3sArray(this.vertices)),t.setAttribute("color",i.copyColorsArray(this.colors)),t.getAttribute("color").onUpload(_c),this.pointSizes=null,this.colors=null},Mc.prototype.resetDistances=function(){this.stations.forEach((function(t){t.distance=1/0}))},Mc.prototype.getClosestVisibleStation=function(t,e){const i=this.splaysVisible,n=this;var r=1/0,s=null;return e.forEach((function(e){const a=n.getStationByIndex(e.index);if(!i&&null!==a&&0===a.p.connections)return;xc.copy(a.p).applyMatrix4(n.matrixWorld).project(t),xc.sub(e.point.project(t));const o=xc.x*xc.x+xc.y*xc.y;o<r&&(r=o,s=a)})),s},Mc.prototype.setSplaysVisibility=function(t){this.splaysVisible=t;const e=t?6:0,i=this.stations,n=this.geometry.getAttribute("pSize"),r=i.length,s=this.selection;var a;for(a=0;a<r;a++){const t=i[a];0!==t.p.connections||0!=e&&!s.contains(t.id)||n.setX(a,e)}n.needsUpdate=!0};const bc=new J;function wc(t,e,i){Cr.call(this),this.type="CV.StationLabels",this.stations=e,this.commentCount=i,this.ctx=t;const n=t.cfg,r=t.materials,s={color:n.themeColorCSS("stations.default.text"),font:n.themeValue("stations.font")};this.defaultLabelMaterial=r.getGlyphMaterial(s,0),this.splayLabelMaterial=r.getGlyphMaterial(s,0);const a={color:n.themeColorCSS("stations.junctions.text"),font:n.themeValue("stations.font")};this.junctionLabelMaterial=r.getGlyphMaterial(a,0)}function Sc(t,e){return Cr.call(this),this.markers=new Map,this.markerColor=e,this.ctx=t,this}function Ec(t,e){if(0===t.length||!e)return;this.stations=t,this.legsObject=e,this.vertexPairToSegment=[],this.segmentMap=new Map,this.segmentToInfo={},this.maxDistance=0,this.zeroStation=null;const i=e.legVertices,n=this.segmentMap,r=this.vertexPairToSegment,s=this.segmentToInfo,a=i.length;var o,h,l,c=!0,u=0;for(l=0;l<a;l+=2){const e=i[l],d=i[l+1];if(r.push(u),void 0!==(o=t.getStation(e))&&(o.legs.push(l),o.linkedSegments.push(u)),c){if(void 0===o)continue;h={segment:u,startStation:o,endStation:null},c=!1}void 0!==(o=t.getStation(d))&&o.legs.push(l),o&&(d.connections>2||l+2<a&&!d.equals(i[l+2]))&&(h.endStation=o,n.set(h.startStation.id+":"+o.id,h),s[u]=h,o.linkedSegments.push(u),u++,c=!0)}return c||(h.endStation=o,n.set(h.startStation.id+":"+o.id,h),o.linkedSegments.push(u)),this}function Tc(t){this.metadata=t.metadata,this.topology=t.topology,this.surveyTree=t.surveyTree,this.routes=new Map,this.routeNames=[],this.currentRoute=new Set,this.currentRouteName=null,this.adjacentSegments=new Set,Object.defineProperty(this,"setRoute",{set:function(t){this.loadRoute(t)},get:function(){return this.currentRouteName}});const e=this.metadata.getRoutes(),i=this.routeNames;var n;for(n in e){const t=e[n];i.push(n),this.routes.set(n,t.segments)}i.sort(),this.dispatchEvent({type:"changed",name:"download"})}wc.prototype=Object.create(Cr.prototype),wc.prototype.update=function(t,e,i){const n=bc.copy(t.position);t.isOrthographicCamera&&(n.sub(e),n.setLength(600/t.zoom),n.add(e)),n.applyMatrix4(i);const r=this.stations,s=r.vertices,a=s.length,o=0!=(8192&t.layers.mask),h=0!=(32768&t.layers.mask),l=a/this.commentCount;for(var c=0;c<a;c++){const t=s[c],e=r.getVisibleStation(t);if(null!==e){const i=e.label;let r=4e4;0===t.connections?r=250:t.connections<3&&(r=5e3),h&&void 0!==e.comment&&(r*=l);const s=t.distanceToSquared(n)<r;let a="";o&&(a+=e.name),o&&h&&void 0!==e.comment&&(a+=" "),h&&void 0!==e.comment&&(a+=e.comment),i&&i.name===a?i.visible=s:(void 0!==i&&(this.remove(i),e.label=null),s&&this.addLabel(e,a))}}},wc.prototype.addLabel=function(t,e){const i=t.p,n=i.connections,r=new qs(e,0===n?this.splayLabelMaterial:n<3?this.defaultLabelMaterial:this.junctionLabelMaterial,this.ctx);r.layers.mask=this.layers.mask,r.position.copy(i),t.label=r,this.addStatic(r)},Sc.prototype=Object.create(Cr.prototype),Sc.prototype.mark=function(t){const e=this.markers;if(e.has(t))return;const i=new yc(this.ctx,this.markerColor);i.position.copy(t.p),i.station=t,i.layers=this.layers,this.add(i),e.set(t,i)},Sc.prototype.unmark=function(t){const e=this.markers,i=e.get(t);void 0!==i&&(this.remove(i),e.delete(t))},Sc.prototype.clear=function(){const t=this;this.markers.forEach((function(e){t.remove(e)})),this.markers.clear()},Sc.prototype.getStations=function(){const t=[];return this.markers.forEach((function(e,i){t.push(i)})),t},Sc.prototype.setVisibility=function(t){this.markers.forEach((function(e){e.visible=t}))},Ec.prototype.vertexSegment=function(t){return this.vertexPairToSegment[t/2]},Ec.prototype.shortestPathSearch=function(t){const e=[t],i=this.legsObject,n=i.legVertices,r=this.stations;r.resetDistances();var s=0;for(t.distance=0;e.length>0;){const t=e.shift(),a=t.distance,o=t.legs;let h;for(s=Math.max(s,a),h=0;h<o.length;h++){const s=o[h],l=n[s],c=n[s+1],u=l!==t.p?l:c,d=r.getStation(u),p=i.legLengths[s/2];d.distance>a+p&&(d.distance=a+p,e.push(d))}}this.zeroStation=t,this.maxDistance=s},Ec.prototype.getShortestPath=function(t){const e=this.zeroStation,i=new Set;if(null===this.zeroStation||t.distance===1/0||this.zeroStation===t||0===t.distance)return i;const n=this.stations,r=this.legsObject.legVertices;for(var s=t,a=!0;a;){const t=s.legs,o=t.length;let h;for(h=0;h<o;h++){const o=t[h],l=r[o],c=r[o+1],u=l!==s.p?l:c,d=n.getStation(u);d.distance<s.distance&&(s=d,i.add(o),s===e&&(a=!1))}}return i},Object.assign(Tc.prototype,u.prototype),Tc.prototype.addRoute=function(t){t!==this.currentRouteName&&void 0!==t&&(this.routeNames.indexOf(t)<0&&(this.routeNames.push(t),this.routes.set(t,[])),this.loadRoute(t))},Tc.prototype.loadRoute=function(t){const e=this.surveyTree,i=this.currentRoute,n=this.topology.segmentMap,r=this.routes.get(t);var s;if(!r)return alert("route "+t+" does not exist"),!1;for(i.clear(),s=0;s<r.length;s++){const t=r[s],a=n.get(e.getIdByPath(t.start)+":"+e.getIdByPath(t.end));void 0!==a&&i.add(a.segment)}return this.currentRouteName=t,this.dispatchEvent({type:"changed",name:""}),!0},Tc.prototype.getCurrentRoute=function(){return this.currentRoute},Tc.prototype.saveCurrent=function(){const t=this.currentRouteName,e=this.topology.segmentMap,i=this.currentRoute;if(!t)return;const n=[];e.forEach((function(t){i.has(t.segment)&&n.push({start:t.startStation.getPath(),end:t.endStation.getPath()})})),this.routes.set(t,n),this.metadata.saveRoute(t,{segments:n})},Tc.prototype.getRouteNames=function(){return this.routeNames},Tc.prototype.toggleSegment=function(t){const e=this,i=this.currentRoute,n=this.topology.vertexSegment(t);if(this.adjacentSegments.clear(),i.has(n))i.delete(n);else{i.add(n);const t=this.topology.segmentToInfo[n];void 0!==t&&(t.startStation.linkedSegments.forEach(r),t.endStation.linkedSegments.forEach(r))}return;function r(t){i.has(t)||e.adjacentSegments.add(t)}},Tc.prototype.inCurrentRoute=function(t){return this.currentRoute.has(this.topology.vertexSegment(t))},Tc.prototype.adjacentToRoute=function(t){return this.adjacentSegments.has(this.topology.vertexSegment(t))};var Lc,Cc,Ac=function(){Ms.call(this),this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new Qt([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new Qt([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))};Ac.prototype=Object.assign(Object.create(Ms.prototype),{constructor:Ac,isLineSegmentsGeometry:!0,applyMatrix4:function(t){var e=this.attributes.instanceStart,i=this.attributes.instanceEnd;return void 0!==e&&(e.applyMatrix4(t),i.applyMatrix4(t),e.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new Ss(e,6,1);return this.setAttribute("instanceStart",new Ts(i,3,0)),this.setAttribute("instanceEnd",new Ts(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new Ss(e,6,1);return this.setAttribute("instanceColorStart",new Ts(i,3,0)),this.setAttribute("instanceColorEnd",new Ts(i,3,3)),this},computeBoundingBox:(Cc=new $,function(){null===this.boundingBox&&(this.boundingBox=new $);var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;void 0!==t&&void 0!==e&&(this.boundingBox.setFromBufferAttribute(t),Cc.setFromBufferAttribute(e),this.boundingBox.union(Cc))}),computeBoundingSphere:(Lc=new J,function(){null===this.boundingSphere&&(this.boundingSphere=new mt),null===this.boundingBox&&this.computeBoundingBox();var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;if(void 0!==t&&void 0!==e){var i=this.boundingSphere.center;this.boundingBox.getCenter(i);for(var n=0,r=0,s=t.count;r<s;r++)Lc.fromBufferAttribute(t,r),n=Math.max(n,i.distanceToSquared(Lc)),Lc.fromBufferAttribute(e,r),n=Math.max(n,i.distanceToSquared(Lc));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}})});var Pc=function(t,e){void 0===t&&(t=new Ac),void 0===e&&(e=new Aa({color:16777215*Math.random()})),xi.call(this,t,e),this.type="LineSegments2"};function Rc(t){return Cr.call(this),this.ctx=t,this.legLengths=[],this.legVertices=[],this.colors=[],this}function Dc(t){const e=new Te;return Wr.call(this,e,t.materials.getUnselectedMaterial()),this}function Nc(t){const e=new Ac;return Pc.call(this,e,t.materials.getUnselectedMaterial()),this.scale.set(1,1,1),this}function Ic(){return Ie.call(this,{vertexShader:ua.waterVertexShader,fragmentShader:ua.waterFragmentShader,depthWrite:!1,type:"CV.WaterMaterial",uniforms:{offset:{value:0}},side:2}),this}function Oc(t,e,i,n,r){r.uniforms.offset.value+=.1}function Fc(t){const e=new Te;xi.call(this,e,new Ic),this.metadata=t.metadata,this.vertices=[],this.ends=[],this.selected=[],this.stations=[],this.onBeforeRender=Oc,this.layers.set(9),this.visible=!1;const i=t.metadata.traces,n=i.length,r=t.surveyTree;if(n>0){let t;for(t=0;t<n;t++){const e=i[t],n=r.getByPath(e.start),s=r.getByPath(e.end);void 0!==s&&void 0!==n&&this._addTrace(n,s)}this.finish()}return this}function Uc(t,e){this.name=t;var i={},n=[],r={},s={};null!==e&&(e.routes&&(i=e.routes),e.traces&&(n=e.traces),e.entrances&&(r=e.entrances),e.annotations&&(s=e.annotations));var a=window.localStorage.getItem(t);if(null!==a){const t=(a=JSON.parse(a)).routes;var o;for(o in t){const e=t[o];e.local=!0,i[o]=e}void 0!==a.traces&&(n=a.traces),void 0!==a.entrances&&(r=a.entrances),void 0!==a.annotations&&(s=a.annotations)}this.routes=i,this.traces=n,this.entrances=r,this.annotations=s}Pc.prototype=Object.assign(Object.create(xi.prototype),{constructor:Pc,isLineSegments2:!0,computeLineDistances:function(){var t=new J,e=new J;return function(){for(var i=this.geometry,n=i.attributes.instanceStart,r=i.attributes.instanceEnd,s=new Float32Array(2*n.data.count),a=0,o=0,h=n.data.count;a<h;a++,o+=2)t.fromBufferAttribute(n,a),e.fromBufferAttribute(r,a),s[o]=0===o?0:s[o-1],s[o+1]=s[o]+t.distanceTo(e);var l=new Ss(s,2,1);return i.setAttribute("instanceDistanceStart",new Ts(l,1,0)),i.setAttribute("instanceDistanceEnd",new Ts(l,1,1)),this}}(),raycast:function(){var t=new X,e=new X,i=new X,n=new J,r=new wt,s=new Os,a=new J;return function(o,h){null===o.camera&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2.');var l=void 0!==o.params.Line2&&o.params.Line2.threshold||0,c=o.ray,u=o.camera,d=u.projectionMatrix,p=this.geometry,f=this.material,m=f.resolution,g=f.linewidth+l,v=p.attributes.instanceStart,y=p.attributes.instanceEnd;c.at(1,i),i.w=1,i.applyMatrix4(u.matrixWorldInverse),i.applyMatrix4(d),i.multiplyScalar(1/i.w),i.x*=m.x/2,i.y*=m.y/2,i.z=0,n.copy(i);var x=this.matrixWorld;r.multiplyMatrices(u.matrixWorldInverse,x);for(var _=0,M=v.count;_<M;_++){t.fromBufferAttribute(v,_),e.fromBufferAttribute(y,_),t.w=1,e.w=1,t.applyMatrix4(r),e.applyMatrix4(r),t.applyMatrix4(d),e.applyMatrix4(d),t.multiplyScalar(1/t.w),e.multiplyScalar(1/e.w);var b=t.z<-1&&e.z<-1,w=t.z>1&&e.z>1;if(!b&&!w){t.x*=m.x/2,t.y*=m.y/2,e.x*=m.x/2,e.y*=m.y/2,s.start.copy(t),s.start.z=0,s.end.copy(e),s.end.z=0;var S=s.closestPointToPointParameter(n,!0);s.at(S,a);var E=z.lerp(t.z,e.z,S),T=E>=-1&&E<=1,L=n.distanceTo(a)<.5*g;if(T&&L){s.start.fromBufferAttribute(v,_),s.end.fromBufferAttribute(y,_),s.start.applyMatrix4(x),s.end.applyMatrix4(x);var C=new J,A=new J;c.distanceSqToSegment(s.start,s.end,A,C),h.push({point:A,pointOnLine:C,distance:c.origin.distanceTo(A),object:this,face:null,faceIndex:_,uv:null,uv2:null})}}}}}()}),Rc.prototype=Object.create(Cr.prototype),Rc.prototype.type="Legs",Rc.prototype.addLegs=function(t,e){const i=this.ctx;this.legVertices=t,this.legRuns=e;var n=null;n=i.cfg.value("gl-lines",!1)?new Dc(i):new Nc(i);const r=new Qt(3*t.length,3),s=new Qt(3*t.length,3);return r.copyVector3sArray(t),s.array.fill(1),n.addLegs(r,s),n.setShading=function(){},n.layers=this.layers,this.computeStats(),this.addStatic(n),this.colors=s,this.legs=n,this},Rc.prototype.computeStats=function(){const t={maxLegLength:-1/0,minLegLength:1/0,legCount:0,legLength:0},e=this.legVertices,i=e.length,n=i/2,r=new Array(n);var s,a=0,o=0;for(s=0;s<i;s+=2){const i=e[s],n=e[s+1],h=i.correctedDistanceTo(n);r[s/2]=h,a+=h,o+=h*h,t.maxLegLength=Math.max(t.maxLegLength,h),t.minLegLength=Math.min(t.minLegLength,h)}return t.legLength=a,t.legLengthSD=Math.sqrt(o/n-Math.pow(a/n,2)),t.legLengthRange=t.maxLegLength-t.minLegLength,t.legCount=n,this.legLengths=r,this.stats=t,this},Rc.prototype.cutRuns=function(t){const e=t.getIds(),i=this.legRuns;if(!i)return;const n=this.legVertices,r=[],s=[],a=i.length;var o;for(o=0;o<a;o++){const t=i[o],a=t.survey,l=t.start,c=t.end;let u=0;if(e.has(a)){for(var h=l;h<c;h++)r.push(n[h]);t.start=u,u+=c-l,t.end=u,s.push(t)}}return 0!==r.length&&(this.legs.geometry.dispose(),this.remove(this.legs),this.addLegs(r,s),!0)},Rc.prototype.setShading=function(t,e,i){this.legs.updateMaterial(this.ctx,i);const n=this.legRuns,r=this.ctx.cfg.themeColor("shading.unselected");var s,a,o;const h=this.legVertices,l=this.colors.array;if(t.size>0&&n)for(a=0,s=n.length;a<s;a++){const i=n[a],s=i.survey,c=i.start,u=i.end;if(t.has(s))for(o=c;o<u;o+=2)e(h,l,o,o+1,s);else for(o=c;o<u;o+=2)r.toArray(l,3*o),r.toArray(l,3*(o+1))}else for(o=0,s=h.length;o<s;o+=2)e(h,l,o,o+1,null);this.legs.updateColors()},Dc.prototype=Object.create(Wr.prototype),Nc.prototype.type="CV.FatLegs",Dc.prototype.addLegs=function(t,e){const i=this.geometry;return i.setAttribute("position",t),i.setAttribute("color",e),i.computeBoundingBox(),this},Dc.prototype.updateColors=function(){this.geometry.getAttribute("color").needsUpdate=!0},Dc.prototype.updateMaterial=function(t,e){const i=t.materials;switch(e){case"height":this.material=i.getHeightMaterial(1);break;case"depth":this.material=i.getDepthMaterial(1);break;case"depth-cursor":this.material=i.getDepthCursorMaterial(1);break;case"cursor":this.material=i.getCursorMaterial(1);break;case"basic":this.material=i.getLineMaterial()}this.material.needsUpdate=!0},Nc.prototype=Object.create(Pc.prototype),Nc.prototype.type="CV.FatLegs",Nc.prototype.addLegs=function(t,e){const i=this.geometry;return i.setPositions(t.array),i.setColors(e.array),this},Nc.prototype.updateColors=function(){this.geometry.getAttribute("instanceColorStart").needsUpdate=!0,this.geometry.getAttribute("instanceColorEnd").needsUpdate=!0},Nc.prototype.updateMaterial=function(t,e){this.material=t.materials.getLine2Material(e),this.material.needsUpdate=!0},Ic.prototype=Object.create(Ie.prototype),Fc.prototype=Object.create(xi.prototype),Fc.prototype.finish=function(){const t=this.geometry,e=this.vertices,i=this.selected;if(0===e.length)return;const n=this.ends,r=e.length,s=new Qt(3*r,3),a=new Qt(3*r,3),o=new Qt(3*r,3);return s.copyVector3sArray(e),a.copyArray(i),o.copyVector3sArray(n),this.visible?(t.getAttribute("position").copy(s).needsUpdate=!0,t.getAttribute("selection").copy(a).needsUpdate=!0,t.getAttribute("sinks").copy(o).needsUpdate=!0):(t.setAttribute("position",s),t.setAttribute("selection",a),t.setAttribute("sinks",o)),this.visible=!0,this.metadata.traces=this.serialise(),this.metadata.saveLocal(),this},Fc.prototype.getTraceStations=function(t){const e=this.stations;return{start:e[2*t].getPath(),end:e[2*t+1].getPath()}},Fc.prototype.deleteTrace=function(t){this.stations.splice(2*t,2),this.vertices.splice(3*t,3),this.selected.splice(3*t,3),this.ends.splice(3*t,3),this.finish()},Fc.prototype._addTrace=function(t,e){const i=this.vertices,n=this.selected,r=this.ends,s=(new J).copy(e.p),a=(new J).subVectors(e.p,t.p).cross(ve.DefaultUp).setLength(2),o=(new J).add(t.p).add(a),h=(new J).add(t.p).sub(a);i.push(o,h,s),r.push(s,s,s),n.push(0,0,0),this.stations.push(t,e)},Fc.prototype.addTrace=function(t,e){this._addTrace(t,e),this.finish()},Fc.prototype.outlineTrace=function(t){if(!this.visible)return;const e=this.geometry.getAttribute("selection"),i=e.count;for(var n=0;n<i;n++)e.setX(n,0);if(null!==t){let i=3*t;e.setX(i++,1),e.setX(i++,1),e.setX(i++,1)}e.needsUpdate=!0},Fc.prototype.serialise=function(){const t=this.stations,e=[];for(var i=0,n=t.length;i<n;i+=2)e.push({start:t[i].getPath(),end:t[i+1].getPath()});return e},Uc.annotators={},Uc.addAnnotator=function(t){console.log(t),Uc.annotators[t.name]=t},Uc.prototype=Object.create(u.prototype),Uc.prototype.getRoutes=function(){return this.routes},Uc.prototype.saveRoute=function(t,e){this.routes[t]=e,this.saveLocal(),this.dispatchEvent({name:"change",type:"routes"})},Uc.prototype.saveLocal=function(){const t={routes:this.routes,traces:this.traces,entrances:this.entrances,annotations:this.annotations};window.localStorage.setItem(this.name,JSON.stringify(t))},Uc.prototype.getURL=function(){return Wa({name:"test",version:1,routes:this.routes,traces:this.traces,entrances:this.entrances,annotations:this.annotations})};function zc(t){return is.call(this),this.transparent=!0,this.onBeforeCompile=function(e){Object.assign(e.uniforms,t.materials.commonTerrainUniforms);var i=e.vertexShader.replace("#include <common>","$&\nvarying vec2 vPosition;\n").replace("include <begin_vertex>","$&\nvPosition = vec2( position.x, position.y );\n"),n=e.fragmentShader.replace("#include <common>","$&\n"+ua.commonTerrainCodePars+"\n").replace("#include <color_fragment>",ua.commonTerrainCodeColor);e.vertexShader=i,e.fragmentShader=n},Object.defineProperty(this,"opacity",{get:function(){return t.materials.terrainOpacity}}),this}function kc(t,e){this.provider=e,this.active=!1,this.hasCoverage=!1,this.crsSupported=void 0===e.crsSupported?["EPSG:3857","EPSG:4326","ORIGINAL"]:e.crsSupported,this.throughMode=2,this.ctx=t;const i=e.getAttribution();if(i){const e={h:0,s:0,l:0};new Ut(t.cfg.themeValue("background")).getHSL(e),i.classList.add("overlay-branding"),i.style.color=e.l<.5?"white":"black",this.attribution=i}this.materialCache={},this.missing=new Set;const n=e.coverage;void 0!==n&&(this.coverage=new Ds(new k(n.minX,n.minY),new k(n.maxX,n.maxY)))}zc.prototype=Object.create(is.prototype),Object.assign(zc.prototype,fa.prototype),kc.prototype.getMinZoom=function(){return this.provider.minZoom},kc.prototype.checkCoverage=function(t,e,i){const n=this.coverage;if(-1===this.crsSupported.indexOf(e))return!1;const r=uh("ORIGINAL"===e?i:e,"WGS84"),s=new Ds;return s.expandByPoint(r.forward({x:t.min.x,y:t.min.y})),s.expandByPoint(r.forward({x:t.min.x,y:t.max.y})),s.expandByPoint(r.forward({x:t.max.x,y:t.min.y})),s.expandByPoint(r.forward({x:t.max.x,y:t.max.y})),this.provider.crs=e,this.hasCoverage=void 0===n||n.intersectsBox(s),this.hasCoverage},kc.prototype.showAttribution=function(){const t=this.attribution;void 0!==t&&this.ctx.container.appendChild(t)},kc.prototype.hideAttribution=function(){const t=this.attribution,e=t.parentNode;null!==e&&e.removeChild(t)},kc.prototype.getTile=function(t,e,i,n){const r=this,s=t+":"+e+":"+i,a=this.ctx.cfg,o=this.ctx.materials,h=this.materialCache[s],l=this.provider.maxZoom;var c=1,u=0,d=0;if(void 0!==h)return void n(this.active?h:null);const p=i-l;if(p>0){const n=Math.pow(2,p);c=1/n;const r=Math.floor(t*c),s=Math.floor(e*c);u=(t-r*n)/n,d=1-(e-s*n)/n,d-=c,t=r,e=s,i=l}const f=this.provider.getUrl(t,e,i);null===f||this.missing.has(f)?n(o.getMissingMaterial()):(new hs).setCrossOrigin("anonymous").load(f,(function(t){if(!r.active)return t.dispose(),void n(null);const e=new zc(r.ctx);t.anisotropy=a.value("anisotropy",4),t.repeat.setScalar(c),t.offset.set(u,d),e.map=t,e.needsUpdate=!0,r.materialCache[s]=e,n(e)}),void 0,(function(){r.missing.add(f),n(r.active?o.getMissingMaterial():null)}))},kc.prototype.setActive=function(){this.showAttribution(),this.active=!0},kc.prototype.setInactive=function(){const t=this.materialCache;for(var e in t){const i=t[e];i.map.dispose(),i.dispose()}this.materialCache={},this.hideAttribution(),this.active=!1},kc.prototype.constructor=kc;var Bc=null;const Gc=new J,Hc=new J,Vc=new Uint8Array(4);function Wc(t){Cr.call(this),this.hasOverlay=!1,this.activeOverlay=null,this.depthTexture=null,this.renderer=null,this.renderTarget=null,this.datumShift=0,this.activeDatumShift=0,this.terrainBase=null,this.terrainRange=null,this.isFlat=!1,this.screenAttribution=null,this.terrainShadingModes={},this.throughMode=1,this.commonUniforms=t.materials.commonTerrainUniforms,this.ctx=t,this.addEventListener("removed",(function(){this.removed()}))}function jc(t,e){Te.call(this),this.type="LoxTerrainGeometry";const i=t.data,n=t.lines,r=t.samples,s=t.calib,a=[],o=[],h=s.xx,l=s.xy,c=s.yx,u=s.yy,d=s.xOrigin-e.x,p=s.yOrigin-e.y,f=-e.z,m=r-1,g=n-1;var v,y,x=1/0,_=-1/0;for(y=0;y<n;y++){const t=(n-1-y)*r;for(v=0;v<r;v++){const e=v*h+(g-y)*l+d,n=v*c+(g-y)*u+p,r=i[t+v]+f;o.push(e,n,r),r<x&&(x=r),r>_&&(_=r)}}const M=m*h+g*l+d,b=m*c+g*u+p;for(this.boundingBox=new $(new J(d,p,x),new J(M,b,_)),y=0;y<g;y++)for(v=0;v<m;v++){const t=v+r*y,e=v+r*(y+1),i=v+1+r*(y+1),n=v+1+r*y;Math.abs(o[3*t+2]-o[3*n+2])<Math.abs(o[3*e+2]-o[3*i+2])?(a.push(t,e,n),a.push(e,i,n)):(a.push(t,e,i),a.push(i,n,t))}this.setIndex(a),this.setAttribute("position",new Qt(o,3)),this.computeVertexNormals()}function Xc(t,e,i){xi.call(this,new jc(e.dtm,i),t.materials.getSurfaceMaterial()),this.type="CV.LoxTile",this.layers.set(7),this.overlayMaterial=null,this.ctx=t,void 0===e.bitmap?this.bitmap=null:(this.bitmap=e.bitmap,this.offsets=i)}function qc(t,e,i){Wc.call(this,t),this.type="CV.Terrain",this.overlayMaterial=null,this.attributions=[];const n=this;var r=0;e.forEach((function(e){const s=new Xc(t,e,i);null!==s.bitmap&&r++,n.add(s)})),this.overlayLoaded=!1,this.hasOverlay=r>0}function Yc(t){const e=new Te;return xi.call(this,e,t.materials.getUnselectedWallMaterial()),this.ctx=t,this}function Zc(t,e){!function(t,e){const i=t.scraps,n=i.length;if(0===n)return null;const r=e.addFeature(new Yc(e.ctx),h,"Scraps"),s=[],a=[],o=[];var l,c=0,u=0;for(l=0;l<n;l++)d(i[l]);return r.addWalls(a,s,o),void e.addFeature(r,h,"CV.Survey:faces:scraps");function d(t){var e,i;for(e=0,i=t.vertices.length;e<i;e++)a.push(t.vertices[e]);for(e=0,i=t.faces.length;e<i;e++){const i=t.faces[e];s.push(i[0]+c,i[2]+c,i[1]+c)}const n=s.length;o.push({start:u,count:n-u,survey:t.survey}),u=n,c+=t.vertices.length}}(t,e),function(t,e){const i=t.crossSections;if(0===i.length)return;const n=e.addFeature(new Yc(e.ctx),o,"Walls"),r=[],s=[],a=i.length,h=[],l=ve.DefaultUp;var c,u,d,p,f,m,g,v,y,x,_,M,b,w,S,E,T,L,C,A=0,P=0;const R=new J,D=new J,N=new J;var I,O=null;if(0!==a){for(L=0;L<a;L++){const t=i[L],e=t.length;if(!(e<2)){for(I=U(t[0],t[1]),C=1;C<e;C++){const e=t[C],i=e.survey;I=U(e,t[C+1]),i!==c&&(c=i,null!==O&&(F(),P=r.length,O.count=P-O.start,h.push(O),O=null)),u=A++,d=A++,p=A++,f=A++,8===I?(x=A++,b=A++,_=A++,M=A++):(x=u,b=d,_=d,M=u),m=A++,g=A++,v=A++,y=A++,8===I?(w=A++,T=A++,S=A++,E=A++):(w=u,T=d,S=d,E=u),4===I?(r.push(p,d,g),r.push(p,g,v),r.push(p,v,m),r.push(p,m,u),r.push(f,g,d),r.push(f,y,g),r.push(f,m,y),r.push(f,u,m)):(r.push(p,_,S),r.push(p,S,v),r.push(p,v,w),r.push(p,w,x),r.push(_,d,g),r.push(_,g,S),r.push(x,w,m),r.push(x,m,u),r.push(b,g,d),r.push(b,T,g),r.push(M,m,E),r.push(M,u,m),r.push(f,T,b),r.push(f,y,T),r.push(f,E,y),r.push(f,M,E)),A-=I,null===O&&(O={start:P,survey:i},r.push(p,f,d),r.push(p,u,f),8===I&&(r.push(p,x,u),r.push(p,d,_),r.push(f,u,M),r.push(f,b,d)))}c=null,A+=I}}if(null!==O&&(F(),O.count=r.length-O.start,h.push(O)),0!==r.length)return n.addWalls(s,r,h),void e.addFeature(n,o,"CV.Survey:faces:walls")}function F(){r.push(v,g,y),r.push(v,y,m),8===I&&(r.push(v,m,w),r.push(v,S,g),r.push(y,E,m),r.push(y,g,T))}function U(t,e){const i=.293,n=t.end,r=t.lrud;var a;R.subVectors(t.start,t.end).normalize();const o=Math.abs(R.dot(l))>.97;var h,c,u,d,p,f,m,g;if(e&&(N.subVectors(e.start,e.end).normalize(),R.add(N)),R.cross(l),o&&r.u+r.d<5){R.copy(D);const t=R.clone().cross(l);u=t.clone().setLength(-r.u).add(n),d=t.clone().setLength(r.d).add(n)}else u=new J(n.x,n.y,n.z+r.u),d=new J(n.x,n.y,n.z-r.d);switch(h=R.clone().setLength(r.l).add(n),c=R.clone().setLength(-r.r).add(n),D.copy(R),t.type){case 3:s.push(h,c,u,d),a=4;break;case 2:p=h.clone().setZ(u.z),f=c.clone().setZ(u.z),m=h.clone().setZ(d.z),g=c.clone().setZ(d.z),s.push(p,g,f,m),a=4;break;case 1:s.push(h,c,u,d),p=h.clone().setZ(u.z).lerp(n,i),f=c.clone().setZ(u.z).lerp(n,i),m=h.clone().setZ(d.z).lerp(n,i),g=c.clone().setZ(d.z).lerp(n,i),s.push(p,g,f,m),a=8;break;default:console.error("unsupported lrud shape",t.type)}return a}}(t,e)}function Jc(t){var e=[],i=0;this.getColour=function(e){const i=t.materials.colourCache.getColors("survey");return i[e%i.length]},this.getColourMap=function(t){if(i===t&&e.length>0)return e;e=[];var n=i=t,r=this.getColour(i.id);h(n);for(var s=n.children;1===s.length;)h(n=s[0]),s=n.children;for(var a=0,o=s.length;a<o;a++){const t=s[a];r=this.getColour(t.id),t.traverse(h)}return e;function h(t){t.isStation()||(e[t.id]=r)}}}function Qc(t,e,i){this.box3=e,void 0===i&&(i=16776960);const n=new J(.5,.5,.5),r=new J(-.5,.5,.5),s=new J(-.5,-.5,.5),a=new J(.5,-.5,.5),o=new J(.5,.5,-.5),h=new J(-.5,.5,-.5),l=new J(-.5,-.5,-.5),c=new J(.5,-.5,-.5),u=[n,r,r,s,s,a,a,n,o,h,h,l,l,c,c,o,n,o,r,h,s,l,a,c],d=new Qt(3*u.length,3),p=new Ac;d.copyVector3sArray(u),p.setPositions(d.array),Pc.call(this,p,t.materials.getLine2Material("basic")),this.material.vertexColors=!1,this.material.color=new Ut(i),e&&this.update(e)}function Kc(t,e){const i=t.survey,n=new $;var r=i.surveyTree,s=r;Qc.call(this,t,r.boundingBox,e);const a=this.material;a.stencilWrite=!0,a.stencilZPass=I,this.layers.set(5),i.addStatic(this);const o=new Set;this.setRoot=function(t){r=t},this.set=function(t){s=t,o.clear(),s===r?this.visible=!1:(t.getSubtreeIds(o),this.visible=!0,t.isStation()||void 0===t.boundingBox||this.update(t.boundingBox))},this.getIds=function(){return o},this.isEmpty=function(){return s===r},this.contains=function(t){return s===r||o.has(t)},this.getWorldBoundingBox=function(){return this.isEmpty()?i.getWorldBoundingBox():n.copy(s.boundingBox).applyMatrix4(i.matrixWorld)},this.getName=function(){return this.isEmpty()?"":s.getPath()},this.getNode=function(){return s},this.isStation=function(){return s.isStation()}}Wc.addOverlay=function(t,e,i,n){void 0===t.overlays&&(t.overlays={}),t.overlays[e]=new kc(t,i),n&&(Bc=e)},Wc.prototype=Object.create(Cr.prototype),Wc.prototype.shadingMode=8,Wc.prototype.removed=function(){},Wc.prototype.getOpacity=function(){return this.ctx.materials.terrainOpacity},Wc.prototype.setOpacity=function(t){this.ctx.materials.terrainOpacity=t},Wc.prototype.commonRemoved=function(){const t=this.activeOverlay;null!==t&&t.setInactive(),null!==this.renderTarget&&this.renderTarget.dispose()},Wc.prototype.checkTerrainShadingModes=function(t){const e=this.ctx.overlays,i={};var n;if(i["terrain.shading.height"]=8,(t.capabilities.isWebGL2||null!==t.extensions.get("OES_standard_derivatives")&&!this.isFlat)&&(i["terrain.shading.contours ("+this.ctx.cfg.themeValue("shading.contours.interval")+"m)"]=15),this.isTiled)for(n in e){const t=e[n];t.checkCoverage(this.limits,this.displayCRS,this.surveyCRS)&&(t.active=this.activeOverlay===t,i[n]=n)}else this.hasOverlay&&(i["terrain.shading.overlay"]=7);return this.terrainShadingModes=i,i},Wc.prototype.setup=function(t,e,i){this.computeBoundingBox(),i.addStatic(this);const n=1024,r=this.ctx.materials,s=this.ctx.container;var a=s.clientWidth,o=s.clientHeight;const h=i.combinedLimits.getSize(Gc),l=a/h.x,c=o/h.y;l<c?o=o*l/c:a=a*c/l;const u=new fs(-a/2,a/2,o/2,-o/2,-1e4,1e4);u.layers.set(7);const d=new q(n,n,{minFilter:_,magFilter:x,format:A,stencilBuffer:!0});d.texture.generateMipmaps=!1,d.texture.name="CV.DepthMapTexture",t.setSize(n,n),t.setPixelRatio(1),t.clear(),t.setRenderTarget(d),e.overrideMaterial=r.getDepthMapMaterial(this),t.render(e,u),e.overrideMaterial=null,this.addHeightMap(t,d),this.checkTerrainShadingModes(t),t.renderLists.dispose(),t.setRenderTarget(null),t.setSize(s.clientWidth,s.clientHeight),t.setPixelRatio(window.devicePixelRatio),i.setupTerrain(this),r.setTerrain(this)},Wc.prototype.setShadingMode=function(t,e){const i=this.activeOverlay,n=this.ctx.materials,r=this.ctx.overlays;var s,a=!0,o=null;switch(t){case 8:s=n.getHypsometricMaterial();break;case 7:this.setOverlay(e),a=!1;break;case 15:s=n.getContourMaterial();break;case 16:if(null===Bc){s=n.getHypsometricMaterial(),t=8;break}t=Bc;default:if(void 0===(o=r[t]))return console.warn("unknown mode",t),!1;this.isTiled&&o.hasCoverage?(o.throughMode=this.throughMode,this.setOverlay(o,e),a=!1):(s=n.getHypsometricMaterial(),t=8)}return a&&null!==i&&(i.setInactive(),this.activeOverlay=null),void 0!==s&&(s.setThroughMode(this.throughMode),this.setMaterial(s)),this.shadingMode=t,!0},Wc.prototype.setThroughMode=function(t){this.throughMode=t},Wc.prototype.setVisibility=function(t){this.visible=t,t?this.showAttribution():this.hideAttribution()},Wc.prototype.showAttribution=function(){const t=this.screenAttribution;null!==t&&this.ctx.container.appendChild(t),null!==this.activeOverlay&&this.activeOverlay.showAttribution()},Wc.prototype.hideAttribution=function(){const t=this.screenAttribution;if(null!==t){const e=t.parentNode;null!==e&&e.removeChild(t)}null!==this.activeOverlay&&this.activeOverlay.hideAttribution()},Wc.prototype.applyDatumShift=function(t){t&&0===this.activeDatumShift?(this.translateZ(this.datumShift),this.activeDatumShift=this.datumShift):t||0===this.activeDatumShift||(this.translateZ(-this.datumShift),this.activeDatumShift=0),this.updateMatrix(),this.dispatchEvent({type:"datumShiftChange",value:this.activeDatumShift})},Wc.prototype.computeBoundingBox=function(){const t=new $;return this.traverse((function(e){e.isTile&&e.isMesh&&t.union(e.geometry.boundingBox)})),this.boundingBox=t,t},Wc.prototype.addHeightMap=function(t,e){this.depthTexture=e.texture,this.renderer=t,this.renderTarget=e},Wc.prototype.getHeight=function(t){const e=this.renderTarget;null===this.terrainBase&&(void 0===this.boundingBox&&this.computeBoundingBox(),this.terrainBase=this.boundingBox.min,this.terrainRange=this.boundingBox.getSize(new J),Hc.set(e.width,e.height,1).divide(this.terrainRange));const i=this.terrainBase;return Gc.copy(t).sub(i).multiply(Hc).round(),this.renderer.readRenderTargetPixels(e,Gc.x,Gc.y,1,1,Vc),(2.319211489520967e-10*(n=Vc)[0]+5.9371814131736755e-8*n[1]+1519918441772461e-20*n[2]+.0038909912109375*n[3])*this.terrainRange.z+i.z;var n},Wc.prototype.setScale=function(t){this.commonUniforms.scale.value=t},Wc.prototype.setAccuracy=function(t){this.commonUniforms.accuracy.value=t,this.commonUniforms.ringColor.value.g=1-t/1e3},Wc.prototype.setTarget=function(t){this.commonUniforms.target.value.copy(t)},Wc.prototype._fitSurface=function(t){const e=this;var i=0,n=0,r=0;t.forEach((function(t){const s=e.getHeight(t);n+=s,r+=s*s,i++}));const s=Math.sqrt(r/i-Math.pow(n/i,2));this.datumShift=n/i,console.log("Adjustmenting terrain height by:",this.datumShift,"sd:",s)},jc.prototype=Object.create(Te.prototype),jc.prototype.setupUVs=function(t,e,i){const n=t.calib,r=n.xx*n.yy-n.xy*n.yx;if(0===r)return!1;const s=n.yy/r,a=-n.xy/r,o=-n.yx/r,h=n.xx/r,l=this.getAttribute("position").array,c=e.naturalWidth,u=e.naturalHeight,d=-(s*n.xOrigin+a*n.yOrigin),p=-(o*n.xOrigin+h*n.yOrigin),f=[];for(var m=0;m<l.length;m+=3){const t=l[m]+i.x,e=l[m+1]+i.y,n=(t*s+e*a+d)/c,r=(t*o+e*h+p)/u;f.push(n,r)}void 0!==this.getAttribute("uv")&&console.alert("replacing attribute uv"),this.setAttribute("uv",new Qt(f,2))},Xc.prototype=Object.create(xi.prototype),Xc.prototype.isTile=!0,Xc.prototype.loadOverlay=function(t,e){if(null===this.bitmap)return;const i=(new hs).load(this.bitmap.image,(function(){const r=n.bitmap;n.geometry.setupUVs(r,i.image,n.offsets),i.onUpdate=function(t){URL.revokeObjectURL(t.image.src),t.image=null},n.overlayMaterial=new zc(t),n.overlayMaterial.map=i,n.overlayMaterial.setThroughMode(n.parent.throughMode),r.data=null,r.image=null,n.material=n.overlayMaterial,e()})),n=this;return void(i.anisotropy=this.ctx.cfg.value("anisotropy",4))},Xc.prototype.removed=function(){const t=this.overlayMaterial;null!==t&&(t.map.dispose(),t.dispose()),this.geometry.dispose()},qc.prototype=Object.create(Wc.prototype),qc.prototype.isTiled=!1,qc.prototype.isLoaded=!0,qc.prototype.setOverlay=function(t){if(!this.hasOverlay)return;const e=this;if(this.overlayLoaded)return this.children.forEach((function(t){null!==t.overlayMaterial&&(t.material=t.overlayMaterial,t.material.setThroughMode(e.throughMode))})),void t();this.children.forEach((function(i){i.loadOverlay(e.ctx,t)})),this.overlayLoaded=!0},qc.prototype.removed=function(){this.children.forEach((function(t){t.removed()})),this.commonRemoved()},qc.prototype.setMaterial=function(t){this.children.forEach((function(e){e.material=t}))},qc.prototype.fitSurface=Wc.prototype._fitSurface,Yc.prototype=Object.create(xi.prototype),Yc.prototype.ready=!0,Yc.prototype.type="Walls",Yc.prototype.flat=!1,Yc.prototype.flatGeometry=null,Yc.prototype.indexedGeometry=null,Yc.prototype.addWalls=function(t,e,i){const n=this.geometry,r=new Qt(3*t.length,3);return n.setAttribute("position",r.copyVector3sArray(t)),n.setIndex(e),n.computeVertexNormals(),n.computeBoundingBox(),this.indexRuns=i,this},Yc.prototype.setShading=function(t,e){const i=this.geometry,n=this.indexRuns,r=this.ctx.materials;if(i.clearGroups(),this.visible=this.ready,t.length>0&&n){this.material=[e,r.getUnselectedWallMaterial()];let o,h=n[0],l=h.start,c=h.count,u=t.has(h.survey)?0:1;for(var s=1,a=n.length;s<a;s++)h=n[s],o=t.has(h.survey)?0:1,o===u&&h.start===l+c?c+=h.count:(i.addGroup(l,c,u),l=h.start,c=h.count,u=o);i.addGroup(l,c,u)}else this.material=e},Yc.prototype.cutRuns=function(t){const e=this.flat;this.setFlat(!1),this.flatGeometry&&(this.flatGeometry.dispose(),this.flatGeometry=null);const i=this.geometry,n=i.getAttribute("position"),r=i.index,s=t.getIds(),a=this.indexRuns,o=[],h=[],l=[],c=new Map,u=a.length;var d,p=0,f=0;for(d=0;d<u;d++){const t=a[d];let e;if(s.has(t.survey)){const i=t.start,s=t.count,a=i+s,u=n.itemSize,d=n.array;for(e=i;e<a;e++){const t=r.getX(e);let i=c.get(t);if(void 0===i){const e=t*u;i=p++,c.set(t,i),h.push(d[e],d[e+1],d[e+2])}o.push(i)}t.start=f,f+=s,l.push(t)}}return 0!==o.length&&(i.index=new r.constructor(o),i.setAttribute("position",new Qt(h,3)),i.computeVertexNormals(),i.computeBoundingBox(),this.indexRuns=l,this.setFlat(e),!0)},Yc.prototype.setFlat=function(t){if(t===this.flat)return;console.log(t,this.flatGeometry);const e=this.geometry;var i=this.flatGeometry;t?(null===i&&((i=e.toNonIndexed()).computeVertexNormals(),i.computeBoundingBox()),this.indexedGeometry=e,this.geometry=i):(this.flatGeometry=e,this.geometry=this.indexedGeometry),this.flat=t},Qc.prototype.type="SurveyBox",Qc.prototype=Object.create(Pc.prototype),Qc.prototype.update=function(t){t.getSize(this.scale),t.getCenter(this.position),this.updateMatrix(),this.box3=t,this.geometry.computeBoundingSphere()},Qc.prototype.removed=function(){this.geometry&&this.geometry.dispose()},Kc.prototype=Object.create(Qc.prototype);const $c=new Set;function tu(t,e){ve.call(this),this.highlightBox=null,this.highlightPath=null,this.lastMarkedStation=null,this.markers=new Sc(t,65280),this.featureBox=null,this.surveyTree=null,this.projection=null,this.projectionWGS84=null,this.worldBoundingBox=null,this.caveShading=1,this.surfaceShading=5,this.wallsMode=!1,this.ctx=t,this.pointTargets=[],this.legTargets=[],this.entranceTargets=[],this.type="CV.Survey",this.cutInProgress=!1,this.features=new Map,this.routes=null,this.stations=null,this.terrain=null,this.topology=null,this.annotations=null,this.inverseWorld=new wt,this.lightDirection=new J(-1,-1,2).normalize();const i=this;this.gradientName=t.cfg.value("saturatedGradient",!1)?"gradientHi":"gradientLow",t.surveyColourMapper=new Jc(t),t.survey=this;var n=e.getSurvey();this.name=n.title,this.CRS=n.sourceCRS,this.displayCRS=n.displayCRS,this.limits=n.limits,this.offsets=n.offsets,this.messages=e.messages;const r=(new $).copy(this.limits);r.min.sub(this.offsets),r.max.sub(this.offsets),this.modelLimits=r,this.combinedLimits=r,function(){const t=n.displayCRS;if(null===n.sourceCRS||null===t||"ORIGINAL"===t)return i.scaleFactor=1,void(null!==n.sourceCRS&&(i.projectionWGS84=uh("WGS84",n.sourceCRS)));const e=i.limits,r=e.min.clone(),s=e.max.clone();r.z=0,s.z=0;const a=r.distanceTo(s),o=uh(t,n.sourceCRS);r.copy(o.forward(r)),s.copy(o.forward(s)),i.projection=o;const h=r.distanceTo(s);i.scaleFactor=a/h,ja.scaleFactor=1/i.scaleFactor,i.projectionWGS84=uh("WGS84",n.displayCRS)}(),this.loadCave(n),this.loadWarnings(),this.legTargets=[this.features.get(1)],this.loadEntrances(),this.setFeatureBox(),this.addStatic(this.markers),this.addEventListener("removed",this.onRemoved);var s=.5;return n=null,void Object.defineProperty(this,"zScale",{get:function(){return s},set:function(t){const e=Math.pow(2,4*(s-.5)),n=Math.pow(2,4*(t-.5));i.applyMatrix4((new wt).makeScale(1,1,n/e)),i.updateMatrix(),s=t}})}function eu(t,e,i,n){const r=Math.cos(i),s=Math.sin(i),a=window.devicePixelRatio||1,o=e.image,h=new Float32Array([r,s,-s,r]),l=new k(o.width*a/t.clientWidth,o.height*a/t.clientHeight);return n=n||[1,1,1],Ie.call(this,{vertexShader:ua.popupVertexShader,fragmentShader:ua.popupFragmentShader,type:"CV.PopupMaterial",uniforms:{rotate:{value:h},popupImage:{value:e},scale:{value:l}},defines:{USE_COLOR:!0}}),this.opacity=1,this.alphaTest=.8,this.depthTest=!1,this.transparent=!0,this.texture=e,this.defaultAttributeValues.color=n,this}function iu(){Te.call(this),this.type="PopupGeometry",this.setIndex(Fs.index),this.setAttribute("position",Fs.position)}tu.prototype=Object.create(ve.prototype),tu.prototype.onRemoved=function(){if(this.cutInProgress)this.cutInProgress=!1;else for(this.traverse((function(t){t.geometry&&t.geometry.dispose()}));this.children.length>0;)this.remove(this.children[0])},tu.prototype.loadWarnings=function(){const t=this.surveyTree,e=this.messages,i=this.selection;if(e.length>0){const n=new Sc(this.ctx,16711935);e.forEach((function(e){const r=t.getByPath(e.station);void 0!==r&&i.contains(r.id)&&(n.mark(r),r.messageText=e.text)})),this.addFeature(n,14,"CV.Survey:warnings")}},tu.prototype.refreshColors=function(){if(this.hasFeature(6)){const t=this.getFeature(6);this.removeFeature(t),this.remove(t),this.entrances=null}if(this.loadEntrances(),this.featureBox){const t=this.getFeature(4);this.removeFeature(t),this.remove(t),this.featureBox=null}this.setFeatureBox(),this.setShadingMode(this.caveShading),this.setSurfaceShading(this.surfaceShading)},tu.prototype.loadEntrances=function(){const t=new vc(this.ctx,this);this.addFeature(t,6,"CV.Survey:entrances"),this.entranceTargets=[t.markers],this.entrances=t},tu.prototype.setupTerrain=function(t){if(t.isFlat)return;this.combinedLimits=(new $).copy(t.boundingBox).union(this.modelLimits),this.setFeatureBox();const e=[];this.surveyTree.traverse((function(t){if(1!==t.type)return;e.push(t.p)})),t.fitSurface(e,this.offsets),null===this.terrain&&(this.terrain=t);const i=this.getFeature(6);return void(void 0!==i&&i.addHeightProvider(t.getHeight.bind(t)))},tu.prototype.loadCave=function(t){const e=this,i=this.ctx,n=t.surveyTree;this.surveyTree=n,this.selection=new Kc(i,this.ctx.cfg.themeValue("box.select")),function(t){const i=t.length,n=[];var r,s,a,o,h;if(n[1]={vertices:[],runs:[]},n[3]={vertices:[],runs:[]},n[2]={vertices:[],runs:[]},0===i)return null;for(a=0;a<i;a++){const e=t[a],i=e.type,l=e.survey;if(r=n[i],void 0===e){console.warn("unknown segment type: ",i);break}if(l!==h||i!==o){if(void 0!==s){const t=n[o];s.end=t.vertices.length,t.runs.push(s)}(s={}).survey=l,s.start=r.vertices.length,h=l,o=i}r.vertices.push(e.from),r.vertices.push(e.to)}void 0===s.end&&(s.end=r.vertices.length,r.runs.push(s));return l(1,"CV.Survey:cave:cave"),l(3,"CV.Survey:surface:surface"),void l(2,"CV.Survey:cave:splay");function l(t,i){const r=n[t];if(0===r.vertices.length)return;const s=new Rc(e.ctx);s.addLegs(r.vertices,r.runs),e.addFeature(s,t,i+":g")}}(t.lineSegments),this.loadStations(n),function(t){if(!1===t.hasTerrain)return;const n=new qc(i,t.terrains,e.offsets);e.terrain=n}(t),this.computeBoundingBoxes(n),this.pointTargets.push(this.stations);const r=new Uc(this.name,t.metadata);return this.metadata=r,this.loadDyeTraces(),this.topology=new Ec(this.stations,this.getFeature(1)),this.routes=new Tc(this),void Zc(t,this)},tu.prototype.getFeature=function(t,e){var i=this.features.get(t);return void 0===i&&e&&(i=new e).layers.set(t),i},tu.prototype.update=function(t,e,i){const n=t.activeCamera,r=this.features.get(6);r&&t.testCameraLayer(6)?(t.setCameraLayer(16,i),r.cluster(n,e,this.selection,i)):t.setCameraLayer(16,!1);const s=this.features.get(l);(s&&t.testCameraLayer(l)||s.commentCount>0&&t.testCameraLayer(c))&&s.update(n,e,this.inverseWorld)},tu.prototype.addFeature=function(t,e,i){return t.name=i,t.layers.set(e),this.features.set(e,t),this.addStatic(t),t},tu.prototype.removeFeature=function(t){this.layers.mask&=~t.layers.mask;const e=this.features;e.forEach((function(i,n){i===t&&e.delete(n)}))},tu.prototype.hasFeature=function(t){return this.features.has(t)},tu.prototype.loadStations=function(t){const e=new Mc(this.ctx,this.selection);var i=0;t.traverse((function(t){void 0!==t.comment&&i++;if(!t.isStation())return;e.addStation(t)})),e.finalise();const n=new wc(this.ctx,e,i);return this.addFeature(e,8,"CV.Stations"),this.addFeature(n,l,"CV.StationLabels"),i>0&&(this.features.set(c,n),n.layers.enable(c)),void(this.stations=e)},tu.prototype.computeBoundingBoxes=function(t){return void t.traverseDepthFirst((function(t){const e=t.parent;e&&void 0===e.boundingBox&&(e.boundingBox=new $);if(t.isStation())e.boundingBox.expandByPoint(t.p);else if(e){if(0===t.children.length||void 0!==t.boundingBox&&t.boundingBox.isEmpty())return;e.boundingBox.expandByPoint(t.boundingBox.min),e.boundingBox.expandByPoint(t.boundingBox.max)}}))},tu.prototype.loadDyeTraces=function(){const t=new Fc(this);this.addFeature(t,9,"CV.DyeTraces"),this.dyeTraces=t},tu.prototype.setScale=function(t,e){this.scale.set(t,t,e),this.position.copy(this.combinedLimits.getCenter(new J).multiply(this.scale).negate()),this.updateMatrix(),this.updateMatrixWorld(),this.inverseWorld.copy(this.matrixWorld).invert()},tu.prototype.getLegs=function(){return this.getFeature(1).geometry.vertices},tu.prototype.getRoutes=function(){return this.routes},tu.prototype.getWorldPosition=function(t){return t.applyMatrix4(this.matrixWorld)},tu.prototype.getGeographicalPosition=function(t){const e=this.offsets,i=this.projection;var n={x:t.x+e.x,y:t.y+e.y,z:0};return null!==i&&(n=i.forward(n)),n.z=t.z+e.z,n},tu.prototype.containsWGS84Position=function(t){t.copy(this.projectionWGS84.forward(t));const e=this.limits.min,i=this.limits.max;return t.x>=e.x&&t.x<=i.x&&t.y>=e.y&&t.y<=i.y},tu.prototype.getModelSurfaceFromWGS84=function(t,e){const i=this;return t.copy(this.projectionWGS84.forward(t)),void this.terrain.getHeights([t],(function(n){t.z=n[0].z,t.sub(i.offsets),e()}))},tu.prototype.shortestPathSearch=function(t){this.highlightPath=null,this.markers.clear(),this.topology.shortestPathSearch(t),this.markers.mark(t),this.setShadingMode(a)},tu.prototype.showShortestPath=function(t){this.highlightPath=this.topology.getShortestPath(t),null!==this.lastMarkedStation&&this.markers.unmark(this.lastMarkedStation),this.markers.mark(t),this.lastMarkedStation=t,this.setLegShading(1,a)},tu.prototype.getMaxDistance=function(){return this.topology.maxDistance},tu.prototype.selectStation=function(t){this.stations.selectStation(t)},tu.prototype.highlightSelection=function(t){if(t.isStation())this.stations.highlightStation(t);else{let e=this.highlightBox;null===e&&(e=new Kc(this.ctx,this.ctx.cfg.themeValue("box.highlight")),this.highlightBox=e),e.set(t),this.stations.clearHighlight(),t===this.surveyTree?this.entrances.setSelection(this.selection):this.entrances.setSelection(e)}},tu.prototype.selectSection=function(t){const e=this.selection;return this.highlightSelection(this.surveyTree),e.set(t),this.stations.selectStations(e),this.entrances.setSelection(e),this.setShadingMode(this.caveShading),t},tu.prototype.setFeatureBox=function(){if(null===this.featureBox){const t=new Qc(this.ctx,this.combinedLimits,this.ctx.cfg.themeColorCSS("box.bounding"));this.addFeature(t,4,"survey-boundingbox"),this.featureBox=t}else this.featureBox.update(this.combinedLimits)},tu.prototype.getWorldBoundingBox=function(){return null===this.worldBoundingBox&&(this.worldBoundingBox=this.featureBox.box3.clone().applyMatrix4(this.matrixWorld)),this.worldBoundingBox},tu.prototype.cutSection=function(t){const e=this.selection,i=this;if(e.set(t),e.isEmpty())return;this.pointTargets=[],this.legTargets=[],this.entranceTargets=[],this.terrain=null;const n=[];return this.traverse((function(t){switch(t.type){case"Legs":case"Walls":t.cutRuns(e)||n.push(t);break;case"SurveyBox":case"CV.Stations":case"CV.StationLabels":case"CV.ClusterMarker":n.push(t)}})),n.forEach((function(t){const e=t.parent;e&&e.remove(t),t.geometry&&t.geometry.dispose(),i.removeFeature(t)})),this.surveyTree=t,this.selection.setRoot(t),this.highlightBox&&this.highlightBox.setRoot(t),this.loadStations(t),this.pointTargets.push(this.stations),this.selectSection(t),this.modelLimits=this.getBounds(),this.combinedLimits=this.modelLimits,this.limits.copy(this.modelLimits),this.limits.min.add(this.offsets),this.limits.max.add(this.offsets),this.setFeatureBox(),this.worldBoundingBox=null,this.loadEntrances(),this.topology=new Ec(this.stations,this.getFeature(1)),void(this.cutInProgress=!0)},tu.prototype.getBounds=function(){const t=new $,e=t.min,i=t.max;return this.traverse((function(t){if("CV.Survey"===t.type||"CV.Box3"===t.type)return;const n=t.geometry;n&&n.boundingBox&&(e.min(n.boundingBox.min),i.max(n.boundingBox.max))})),t},tu.prototype.setWallsMode=function(t){this.getFeature(o).setFlat(t),this.wallsMode=t},tu.prototype.setShadingMode=function(t){const e=this.ctx.materials;var i;switch(t){case 1:i=e.getHeightMaterial(2);break;case 4:i=e.getCursorMaterial(2);break;case 5:i=e.getSurfaceMaterial();break;case 9:if(null===this.terrain)return!1;if(!(i=e.getDepthMaterial(2)))return!1;break;case s:if(null===this.terrain)return!1;if(!(i=e.getDepthCursorMaterial(2)))return!1;break;case a:case 6:i=!1}return this.markers.setVisibility(t===a),this.setLegShading(1,t)&&(this.setWallShading(this.features.get(o),i),this.setWallShading(this.features.get(h),i),this.caveShading=t),this.caveShading},tu.prototype.setWallShading=function(t,e){t&&(e?t.setShading(this.selection,e):t.visible=!1)},tu.prototype.setSurfaceShading=function(t){return this.setLegShading(3,t)&&(this.surfaceShading=t),this.surfaceShading},tu.prototype.setLegShading=function(t,e){const i=this.features.get(t);if(void 0===i)return!1;switch(e){case 1:this.setLegColourByMaterial(i,"height");break;case 2:this.setLegColourByLength(i);break;case 3:this.setLegColourByInclination(i,ve.DefaultUp);break;case 4:this.setLegColourByMaterial(i,"cursor");break;case s:this.setLegColourByMaterial(i,"depth-cursor");break;case 5:this.setLegColourByColour(i,this.ctx.cfg.themeColor("shading.single"));break;case 17:this.setLegColourByColour(i,this.ctx.cfg.themeColor("shading.surface"));break;case 6:this.setLegColourBySurvey(i);break;case r:this.setLegColourByPath(i);break;case 7:case 8:break;case 9:this.setLegColourByMaterial(i,"depth");break;case a:0===this.topology.maxDistance?this.setLegColourByColour(i,this.ctx.cfg.themeColor("shading.unconnected")):this.setLegColourByDistance(i);break;default:return console.warn("invalid leg shading mode"),!1}return!0},tu.prototype.setLegColourByMaterial=function(t,e){const i=this.ctx.materials.colourCache;t.setShading(this.selection.getIds(),(function(t,e,n,r){i.white.toArray(e,3*n),i.white.toArray(e,3*r)}),e)},tu.prototype.setLegColourByColour=function(t,e){t.setShading(this.selection.getIds(),(function(t,i,n,r){e.toArray(i,3*n),e.toArray(i,3*r)}),"basic")},tu.prototype.setLegColourByLength=function(t){const e=this.ctx.materials.colourCache.getColors(this.gradientName),i=e.length-1,n=t.stats,r=t.legLengths;t.setShading(this.selection.getIds(),(function(t,s,a,o){const h=(r[a/2]-n.minLegLength)/n.legLengthRange,l=e[Math.floor(h*i)];l.toArray(s,3*a),l.toArray(s,3*o)}),"basic")},tu.prototype.setLegColourByDistance=function(t){const e=this.ctx.cfg,i=this.ctx.materials.colourCache.getColors(this.gradientName),n=e.themeColor("shading.unconnected"),r=e.themeColor("routes.active"),s=this.stations,a=i.length-1,o=this.topology.maxDistance,h=this.highlightPath;function l(t,e){const r=t[e],h=s.getStation(r).distance;return h===1/0?n:i[Math.floor(a*h/o)]}t.setShading(this.selection.getIds(),(function(t,e,i,n){const s=null!==h&&h.has(i),a=s?r:l(t,i),o=s?r:l(t,n);a.toArray(e,3*i),o.toArray(e,3*n)}),"basic")},tu.prototype.setLegColourBySurvey=function(t){for(var e=this.selection.getNode();1===e.children.length;)e=e.children[0];$c.clear(),e.getSubtreeIds($c);const i=this.ctx.surveyColourMapper.getColourMap(e);t.setShading($c,(function(t,e,n,r,s){const a=i[s];a.toArray(e,3*n),a.toArray(e,3*r)}),"basic")},tu.prototype.setLegColourByPath=function(t){const e=this.routes,i=this.ctx.cfg,n=i.themeColor("routes.active"),r=i.themeColor("routes.adjacent"),s=i.themeColor("routes.default");t.setShading(this.selection.getIds(),(function(t,i,a,o){var h;h=e.inCurrentRoute(a)?n:e.adjacentToRoute(a)?r:s;h.toArray(i,3*a),h.toArray(i,3*o)}),"basic")},tu.prototype.setLegColourByInclination=function(t,e){const i=this.ctx.materials.colourCache.getColors("inclination"),n=2*(i.length-1)/Math.PI,r=new J;t.setShading(this.selection.getIds(),(function(t,s,a,o){const h=t[a],l=t[o];r.subVectors(h,l).normalize();const c=r.dot(e),u=Math.floor(n*Math.acos(Math.abs(c))),d=i[u];d.toArray(s,3*a),d.toArray(s,3*o)}),"basic")},tu.prototype.gltfExport=function(t,e,i){const n=[];if(t.walls&&n.push(this.getMesh(o)),t.scraps&&n.push(this.getMesh(h)),t.legs){const t=this.getFeature(1).geometry;n.push({type:"lines",index:t.index,position:t.getAttribute("position"),modelLimits:this.modelLimits})}if(0===n.length)return;const r=new Worker(this.ctx.cfg.value("home","")+"js/workers/gltfWorker.js");r.addEventListener("message",(function(t){var n;n=e.binary?"application/octet-stream":"application/gltf+json",i(new Blob([t.data.gltf],{type:n}),e.binary)})),r.postMessage({items:n,options:e})},tu.prototype.getMesh=function(t){const e=this.getFeature(t).geometry;return{type:"walls",index:e.index,position:e.getAttribute("position"),modelLimits:this.modelLimits}},eu.prototype=Object.create(Ie.prototype),iu.prototype=Object.create(Te.prototype);var nu=null;function ru(t){return null===nu&&(nu=new iu),xi.call(this,nu),this.layers.set(1),this.type="Popup",this.renderOrder=1/0,this.ctx=t,this}function su(t){return ru.call(this,t),this.lines=[],this.type="CanvasPopup",this}function au(t,e,i,n,r,s,a){su.call(this,t);const o=i.getGeographicalPosition(e.p);for(var h,l,c=e.getPath(),u=!1,d=null;c.length>20;)(h=c.split(".")).shift(),c=h.join("."),u=!0;if(l=s?e.distance!==1/0?Math.round(e.distance):"unconnected":null,u&&(c="..."+c),this.addLine(c),a&&void 0!==e.messageText)this.addLine(e.messageText);else if(void 0!==r&&(d=r(i.CRS,o,n,l)),null!==d)for(let t=0;t<d.length;t++)this.addLine(d[t]);else this.addLine("x: "+Math.round(o.x)+" m, y: "+Math.round(o.y)+" m").addLine("z: "+Math.round(o.z)+" m"),null!==n&&this.addLine("depth from surface: "+Math.round(n)+" m"),s&&this.addLine("distance: "+l+"m");return this.finish(),this.position.copy(e.p),this}function ou(t,e,i,n){ru.call(this,t),this.type="ImagePopup";(new hs).load(i,(function(t){r.material=new eu(r.ctx.container,t,0),r.material.needsUpdate=!0,n()})).onUpdate=function(t){t.image=null},this.position.copy(e.p);const r=this;return this}ru.prototype=Object.create(xi.prototype),ru.prototype.close=function(){this.parent&&this.parent.remove(this);const t=this.materal;t&&(t.dispose(),t.texture&&t.texture.dispose())},su.prototype=Object.create(ru.prototype),su.prototype.addLine=function(t){return this.lines.push(t),this},su.prototype.finish=function(){const t=this.ctx.cfg,e=this.ctx.container,i=this.lines,n=i.length,r=32*n,s=document.createElement("canvas");s||console.error("creating canvas for CanvasPopup failed"),s.width=256,s.height=r;const a=s.getContext("2d");var o;for(a||console.error("cannot obtain 2D canvas"),a.fillStyle=t.themeColorCSS("popup.background"),a.fillRect(0,0,256,r),a.strokeStyle=t.themeColorCSS("popup.border"),a.lineWidth=2,a.strokeRect(0,0,256,r),a.textAlign="left",a.font="20px normal helvetica,sans-serif",a.fillStyle=t.themeColorCSS("popup.text"),o=0;o<n;o++)a.fillText(i[o],10,32*(o+1)-6);const h=new Kr(s);h.onUpdate=function(t){t.image=null};const l=new eu(e,h,0);return this.material=l,this.material.needsUpdate=!0,this},au.prototype=Object.create(su.prototype),ou.prototype=Object.create(ru.prototype);const hu=new J,lu=new J,cu=new J,uu=new J,du=new $e(hu,lu,cu),pu=new $e(hu,cu,uu);function fu(){this.array=null}function mu(t,e,i,n,r){return this.x=e,this.y=i,this.zoom=n,this.tileSet=r.tileSet,this.clip=r.clip,this.clippedFraction=r.clippedFraction,this.canZoom=n<r.tileSet.overlayMaxZoom,this.evicted=!1,this.replaced=!1,this.evictionCount=0,this.lastFrame=0,this.childrenLoading=0,this.childErrors=0,this.area=0,this.boundingBox=null,this.worldBoundingBox=null,xi.call(this,new Te,t.materials.getSurfaceMaterial()),this.type="Tile",this.isTile=!1,this}function gu(t,e,i){this.CRS=i,this.transform=uh(i,"EPSG:4326"),this.transformedLimits=null;const n=this,r="https://api.cesium.com/v1/assets/1/endpoint?access_token="+t.cfg.value("cesiumAccessToken","no access token");(new cs).setResponseType("text").load(r,(function(t){const i=JSON.parse(t);n.url=i.url,n.accessToken=i.accessToken,n.attributions=i.attributions,gu.defaultTileSet.valid=!0,e()}),(function(){}),(function(){console.warn("cesium api error"),e()}))}mu.liveTiles=0,mu.prototype=Object.create(xi.prototype),mu.prototype.onBeforeRender=function(t){this.lastFrame=t.info.render.frame},mu.prototype.createFromBufferAttributes=function(t,e,i,n){var r,s,a=this.geometry;for(r in e)s=e[r],a.setAttribute(r,new Qt(s.array,s.itemSize));for(var o in a.setIndex(new qt(t,1)),a.boundingBox=new $(new J(i.min.x,i.min.y,i.min.z),new J(i.max.x,i.max.y,i.max.z)),this.boundingBox=a.boundingBox,e=a.attributes)e[o].onUpload(fu);return this.geometry.index.onUpload(fu),this.layers.set(7),this.material=n,this.isTile=!0,this},mu.prototype.getWorldBoundingBox=function(){return null===this.worldBoundingBox&&(this.updateWorldMatrix(!0,!1),this.worldBoundingBox=this.boundingBox.clone().applyMatrix4(this.matrixWorld)),this.worldBoundingBox},mu.prototype.empty=function(){this.isMesh=!1,this.geometry&&(this.geometry.dispose(),this.geometry=new Te),--mu.liveTiles},mu.prototype.evict=function(){this.evicted=!0,this.replaced=!1,this.evictionCount=0,this.empty()},mu.prototype.setReplaced=function(){this.evicted=!1,this.replaced=!0,this.empty()},mu.prototype.setSkipped=function(){this.parent.childrenLoading--,this.evicted=!1,this.replaced=!0},mu.prototype.setPending=function(t){t&&null===this.parent&&t.addStatic(this),this.parent.childrenLoading++,this.isMesh=!1,this.evicted=!1,this.replaced=!1,this.evictionCount=0},mu.prototype.setFailed=function(){const t=this.parent;t.childErrors++,t.childrenLoading--,t.canZoom=!1,t.remove(this)},mu.prototype.setLoaded=function(t,e){const i=this.parent;var n=0;if(0==--i.childrenLoading){if(0===i.childErrors)return i.isTile&&i.setReplaced(),i.children.forEach((function(e){e.replaced||e.evicted||(null===t?(e.isMesh=!0,mu.liveTiles++):(e.setOverlay(t,r),n++))})),0===n&&e(i.childErrors),!0;i.remove(this)}return!1;function r(t){t.isMesh=!0,mu.liveTiles++,0==--n&&e(i.childErrors)}},mu.prototype.removed=function(){this.geometry&&this.geometry.dispose()},mu.prototype.setMaterial=function(t){this.material=t},mu.prototype.setThroughMode=function(t){this.material.setThroughMode(t)},mu.prototype.setOverlay=function(t,e){const i=this;return void t.getTile(this.x,this.y,this.zoom,(function(n){null!==n&&(i.material=n,n.setThroughMode(t.throughMode));e(i)}))},mu.prototype.computeProjectedArea=function(t){const e=this.getWorldBoundingBox(),i=e.max.z;return hu.copy(e.min).setZ(i),cu.copy(e.max),lu.set(hu.x,cu.y,i),uu.set(cu.x,hu.y,i),hu.project(t),lu.project(t),cu.project(t),uu.project(t),this.area=(du.getArea()+pu.getArea())/this.clippedFraction,this},gu.defaultTileSet={title:"Cesium",initialZoom:12,overlayMaxZoom:16,maxZoom:17,minZoom:10,divisions:1,subdirectory:null,dtmScale:64,minX:0,maxX:2048,minY:0,maxY:1023,attributions:[],log:!0,valid:!1},gu.prototype.workerScript="webMeshWorker.js",gu.prototype.getTileSets=function(){return[gu.defaultTileSet]},gu.prototype.getScreenAttribution=function(){const t=this.attributions;if(0===t.length)return null;const e=document.createElement("div");e.classList.add("overlay-branding");for(var i=0;i<t.length;i++){const n=t[i];e.innerHTML=n.html;break}return e},gu.prototype.getCoverage=function(t,e){const i={zoom:e};null===this.transformedLimits&&(this.transformedLimits=new Ds);const n=this.transformedLimits;n.expandByPoint(this.transform.forward(t.min.clone())),n.expandByPoint(this.transform.forward(t.max.clone()));const r=n.min,s=n.max,a=Math.pow(2,e)/180;return i.minX=Math.floor((r.x- -180)*a),i.maxX=Math.floor((s.x- -180)*a),i.minY=Math.floor((r.y- -90)*a),i.maxY=Math.floor((s.y- -90)*a),i.count=(i.maxX-i.minX+1)*(i.maxY-i.minY+1),i},gu.prototype.getTileSpec=function(t,e,i,n){const r=new Ds,s=180/Math.pow(2,i);if(r.min.x=t*s-180,r.min.y=e*s-90,r.max.x=(t+1)*s-180,r.max.y=(e+1)*s-90,!this.transformedLimits.intersectsBox(r))return null;const a=new k;return r.clone().intersect(this.transformedLimits).getSize(a),{tileSet:this.tileSet,divisions:1,resolution:s,x:t,y:e,z:i,clip:n,offsets:null,flatZ:null,displayCRS:this.CRS,url:this.url,accessToken:this.accessToken,clippedFraction:a.x*a.y/s*s,request:"tile"}};const vu=6378137*Math.PI;var yu;function xu(t,e){return void(new cs).setResponseType("text").load(t.cfg.value("terrainDirectory","")+"/tileSets.json",(function(t){(yu=JSON.parse(t)).push(xu.defaultTileSet),e()}),(function(){}),(function(){yu=[xu.defaultTileSet],e()}))}xu.defaultTileSet={isFlat:!0,title:"flat",overlayMaxZoom:18,maxZoom:16,minZoom:10,divisions:128,subdirectory:null,dtmScale:64,minX:0,maxX:1023,minY:0,maxY:1023,attributions:[],log:!0},xu.prototype.workerScript="webTileWorker.js",xu.prototype.getTileSets=function(){return yu},xu.prototype.getScreenAttribution=function(){return null},xu.prototype.getCoverage=function(t,e){const i={zoom:e},n=vu,r=-vu,s=Math.pow(2,e-1)/vu;return i.minX=Math.floor((t.min.x-r)*s),i.maxX=Math.floor((t.max.x-r)*s),i.maxY=Math.floor((n-t.min.y)*s),i.minY=Math.floor((n-t.max.y)*s),i.count=(i.maxX-i.minX+1)*(i.maxY-i.minY+1),i},xu.prototype.getTileSpec=function(t,e,i,n){const r=this.tileSet,s=i>r.maxZoom?Math.pow(2,r.maxZoom-i):1;if(1!==s&&null===this.activeOverlay)return null;this.log&&console.log("load: [ ",i+"/"+t+"/"+e,"]");const a=vu/Math.pow(2,i-1),o={top:0,bottom:0,left:0,right:0},h=a*t-vu,l=h+a,c=vu-a*e,u=c-a,d=r.divisions*s,p=a/d;if(c>n.max.y&&(o.top=Math.floor((c-n.max.y)/p)),u<n.min.y&&(o.bottom=Math.floor((n.min.y-u)/p)),h<n.min.x&&(o.left=Math.floor((n.min.x-h)/p)),l>n.max.x&&(o.right=Math.floor((l-n.max.x)/p)),o.top>=d||o.bottom>=d||o.left>=d||o.right>=d)return null;return{tileSet:r,divisions:d,resolution:p,x:t,y:e,z:i,clip:o,offsets:null,flatZ:null,clippedFraction:(d-o.top-o.bottom)*(d-o.left-o.right)/(d*d),request:"tile"}},xu.prototype.findTile=function(t){const e=this.tileSet,i=vu/Math.pow(2,e.maxZoom-1),n=(t.x+vu)/i,r=(vu-t.y)/i,s=Math.floor(n),a=Math.floor(r),o=e.maxZoom,h=n-s,l=r-a,c=e.divisions+1;return{x:s,y:a,z:o,tileSet:e,dataOffsets:[Math.floor(c*h)+c*Math.floor(c*l)],points:[t],request:"height",clip:{}}};const _u=new bt,Mu=new wt,bu={type:"progress",name:"start"},wu={type:"progress",name:"end"};function Su(t,e,i){Wc.call(this,t),this.name="WebTerrain",this.type="CV.WebTerrain",this.attributions=[],this.log=!1,this.ctx=t,this.displayCRS=e.displayCRS,this.surveyCRS=e.CRS,this.limits=e.limits,this.flatZ=e.modelLimits.max.z,this.offsets=e.offsets,this.onLoaded=i,this.childrenLoading=0,this.childErrors=0,this.isLoaded=!1,this.material=null,this.initialZoom=null,this.dying=!1,this.tilesLoading=0,this.maxTilesLoading=0,this.overlaysLoading=0,this.debug=!0,this.coverage=null,this.TS=null,this.maxTiles=t.cfg.value("maxTiles",128),this.retile_timeout=80,this.retileScaler=4,this.lastActivityTime=0,this.timerId=null,this.material=t.materials.getCursorMaterial(),this.canZoom=!0,this.watcher=this.scheduleRetile.bind(this),this.updateFunc=Su.prototype.zoomCheck.bind(this);const n=this;switch(this.displayCRS){case"EPSG:3857":this.TS=new xu(t,r);break;case"EPSG:4326":case"ORIGINAL":this.TS=new gu(t,r,this.surveyCRS);break;default:return void i(this)}return void(this.workerPool=this.ctx.workerPools.getPool(this.TS.workerScript));function r(){n.tileSets=n.TS.getTileSets(),n.screenAttribution=n.TS.getScreenAttribution(),n.hasCoverage()?n.tileArea(n.limits):(console.log("no terrain found"),i(n))}}Su.prototype=Object.create(Wc.prototype),Su.prototype.isTiled=!0,Su.prototype.hasCoverage=function(){const t=this.limits,e=this.ctx.cfg.value("terrainDirectory",""),i=this.tileSets,n=this.TS;for(var r=0,s=i.length;r<s;r++){const s=i[r];if(!1===s.valid)continue;const a=n.getCoverage(t,s.minZoom);if(a.minX>=s.minX&&a.maxX<=s.maxX&&a.minY>=s.minY&&a.maxY<=s.maxY)return s.directory=e+s.subdirectory,n.tileSet=s,this.isFlat=s.isFlat,this.log=void 0!==s.log&&s.log,this.attributions=s.attributions,console.log("selected tile set:",s.title),!0}return!1},Su.prototype.pickCoverage=function(t){const e=this.TS.tileSet;var i,n=e.initialZoom||e.overlayMaxZoom+1;do{i=this.TS.getCoverage(t,--n)}while(i.count>4&&n>e.minZoom);return i},Su.prototype.loadTile=function(t,e,i,n,r){void 0===r&&(r=n.children.find((function(n){return n.x===t&&n.y===e&&n.zoom===i})));const s=this,a=this.TS.getTileSpec(t,e,i,this.limits);if(null===a)return;a.offsets=this.offsets,a.flatZ=this.flatZ,this.maxTilesLoading=Math.max(this.maxTilesLoading,++this.tilesLoading),this.log&&console.log("load: [ ",i+"/"+t+"/"+e,"]",this.tilesLoading);const o=r||new mu(this.ctx,t,e,i,a);return o.setPending(n),void this.workerPool.runWorker(a,(function(t){const e=t.data,i=t.currentTarget,n=s.activeOverlay;if(s.workerPool.putWorker(i),--s.tilesLoading,s.dying)return void s.dispatchEvent(wu);if("zoom"===e.status)return o.setSkipped(),void s.zoomTile(o);if("ok"!==e.status||0!==o.parent.childErrors)return o.setFailed(),0!==s.tilesLoading||s.isLoaded||s.onLoaded(s),void s.dispatchEvent(wu);o.createFromBufferAttributes(e.index,e.attributes,e.boundingBox,s.material),o.canZoom=e.canZoom,s.dispatchEvent({type:"progress",name:"set",progress:100*(s.maxTilesLoading-s.tilesLoading)/s.maxTilesLoading}),o.setLoaded(n,h)&&null!==n&&o.zoom<n.getMinZoom()&&o.canZoom&&s.zoomTile(o)}));function h(){0===s.tilesLoading&&(0===s.tilesLoading&&s.dispatchEvent(wu),s.isLoaded||(s.isLoaded=!0,s.onLoaded(s)))}},Su.prototype.initProgress=function(){this.tilesLoading>0&&this.dispatchEvent(bu)},Su.prototype.tileArea=function(t){const e=this.pickCoverage(t),i=e.zoom;this.initialZoom=i,this.coverage=e;for(var n=e.minX;n<e.maxX+1;n++)for(var r=e.minY;r<e.maxY+1;r++)this.loadTile(n,r,i,this);this.initProgress()},Su.prototype.tileSet=function(){const t=Object.assign({},xu.defaultTileSet),e=this.coverage;return delete t.isFlat,delete t.directory,t.title="new tile set",t.subdirectory="new_tile_set",t.minZoom=e.zoom,t.minX=e.minX,t.maxX=e.maxX,t.minY=e.minY,t.maxY=e.maxY,Wa(t)},Su.prototype.zoomTile=function(t){const e=t.zoom+1,i=2*t.x,n=2*t.y;this.loadTile(i,n,e,t),this.loadTile(i+1,n,e,t),this.loadTile(i,n+1,e,t),this.loadTile(i+1,n+1,e,t)},Su.prototype.setOverlay=function(t,e){if(this.tilesLoading>0)return;const i=this,n=this.activeOverlay,r=t.throughMode;if(null!==n){if(n===t)return void this.traverse((function(t){if(!t.isTile||!t.isMesh)return;t.setThroughMode(r)}));n.setInactive()}t.setActive(),this.activeOverlay=t;const s=t.getMinZoom();return void this.traverse((function(e){if(!e.isTile||!e.isMesh)return;e.zoom<s?i.zoomTile(e):(e.setOverlay(t,a),i.overlaysLoading++)}));function a(){0==--i.overlaysLoading&&e()}},Su.prototype.removed=function(){const t=this;return this.dying=!0,this.traverse((function(e){e!==t&&e.removed(e)})),void this.commonRemoved()},Su.prototype.setMaterial=function(t){if(!(this.tilesLoading>0))return this.traverse((function(e){if(!e.isTile)return;e.setMaterial(t)})),this.activeOverlay=null,t.needsUpdate=!0,t.fog=!1,void(this.material=t)},Su.prototype.zoomCheck=function(t){if(performance.now()-this.lastActivityTime<this.retile_timeout)return;if(this.tilesLoading>0)return!0;const e=this,i=_u,n=t.activeCamera,r=t.getLastFrame(),s=[],a=[],o=[];var h,l=!1;i.setFromProjectionMatrix(Mu.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse)),this.traverse((function(t){const e=t.parent;if(!t.isTile||!e.canZoom)return;t.isMesh&&t.canZoom&&t.lastFrame===r?(t.computeProjectedArea(n),t.area/4>.81&&s.push(t)):!e.isMesh&&t.evicted&&i.intersectsBox(t.getWorldBoundingBox())?(t.traverse((function(e){e.evicted=!1,e!==t&&(e.replaced=!0)})),o.push(t)):t.isMesh&&t.lastFrame!==r&&a.push(t)}));const c=o.length,u=s.length;if(function(){const t=a.length,i=mu.liveTiles-e.maxTiles,n=Math.min(t,i);if(n>0){let t;a.sort((function(t,e){const i=e.zoom-t.zoom;if(0!==i)return i;const n=t.lastFrame-e.lastFrame;if(0!==n)return n;const r=t.x-e.x;return 0!==r?r:t.y-e.y}));const e=performance.now();for(t=0;t<n;t++){const i=a[t];0===i.evictionCount?i.evictionCount=e:e-i.evictionCount>1e3&&i.evict()}}}(),0!==c){for(h=0;h<c;h++){const t=o[h];this.loadTile(t.x,t.y,t.zoom,t.parent,t)}l=!0}else if(0!==u){for(h=0;h<u;h++)this.zoomTile(s[h]);l=!0}return this.initProgress(),void(l&&(this.timerId=setTimeout(this.updateFunc,this.retile_timeout*this.retileScaler,t),this.retileScaler*=2))},Su.prototype.getHeights=function(t,e){const i=this.TS,n=this,r={},s=[];t.forEach((function(t,e){const n=i.findTile(t),s=n.x+":"+n.y+":"+n.z;t.index=e,void 0===r[s]?r[s]=n:(r[s].dataOffsets.push(n.dataOffsets[0]),r[s].points.push(n.points[0]))}));let a=0;for(var o in r)this.workerPool.runWorker(r[o],h),a++;return;function h(t){n.workerPool.putWorker(t.currentTarget);t.data.points.forEach((function(t){s[t.index]=t})),0==--a&&e(s)}},Su.prototype.fitSurface=function(t,e){if(void 0===this.TS.findTile)return void this._fitSurface(t);const i=this,n=t.map((function(t){return t.clone().add(e)}));this.getHeights(n,(function(t){var e=0,r=0,s=0;t.forEach((function(t){const i=n[t.index].z-t.z;r+=i,s+=i*i,e++}));const a=Math.sqrt(s/e-Math.pow(r/e,2));i.datumShift=r/e,console.log("Adjustmenting terrain height by:",i.datumShift,"sd:",a)}))},Su.prototype.scheduleRetile=function(t){this.visible&&(null!==this.timerId&&clearTimeout(this.timerId),this.retileScaler=4,this.lastActivityTime=performance.now(),this.timerId=setTimeout(this.updateFunc,this.retile_timeout,t.cameraManager))},Su.prototype.watch=function(t){t.addEventListener("moved",this.watcher)},Su.prototype.unwatch=function(t){t.removeEventListener("moved",this.watcher)};var Eu="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Tu(t){var e={exports:{}};return t(e,e.exports),e.exports}var Lu=Tu((function(t,e){(function(){var e,i,n,r;n=function(t,e){return Object.prototype.toString.call(e).match(/\s(\w+)/)[1].toLowerCase()===t},i=function(t){return!!t&&n("object",t)},r=function(t){return n("array",t)?t:[t]},e=function(){function t(){this.__eventStore={},this.__asyncEvents=!0}return t.mixin=function(e){var i,n,r,s;for(n in e.__eventStore={},s=[],r=t.prototype)i=r[n],s.push(e[n]=i);return s},t.prototype.on=function(t,e,n){var s,a,o,h,l;if(null==n&&(n=!1),i(t))for(l in t)e=t[l],this.on(l,e);else for(a=0,o=(h=r(t)).length;a<o;a++)l=h[a],(s=this.__eventStore)[l]||(s[l]=[]),this.__eventStore[l].push({fn:e,once:n});return this},t.prototype.once=function(t,e){return e?this.on(t,e,!0):this.on(t,!0)},t.prototype.off=function(t,e){var n,s,a,o,h,l,c;if(!e)for(n=0,a=(h=r(t)).length;n<a;n++)c=h[n],this.__eventStore[c]=[];if(i(t))for(c in t)e=t[c],this.off(c,e);else for(s=0,o=(l=r(t)).length;s<o;s++)c=l[s],this.__eventStore[c]=(this.__eventStore[c]||[]).filter((function(t){return t.fn!==e}));return this},t.prototype.trigger=function(t,e){var i,n;return e||(e=[]),null!=(i=this.__eventStore[t])&&i.forEach((n=this,function(i){var r,s;if(r=i.fn,s=i.once,n.__asyncEvents?setTimeout((function(){return r.apply(null,e)}),1):r.apply(null,e),s)return n.off(t,r)})),this},t}(),t.exports=e}).call(Eu)})),Cu=Tu((function(t,e){(function(){var e,i,n,r;n=function(t,e){return Object.prototype.toString.call(e).match(/\s(\w+)/)[1].toLowerCase()===t},i=function(t){return!!t&&n("object",t)},r=function(t){return n("array",t)?t:[t]},e=function(){function t(){this.__eventStore={},this.__asyncEvents=!0}return t.mixin=function(e){var i,n,r,s;for(n in e.__eventStore={},s=[],r=t.prototype)i=r[n],s.push(e[n]=i);return s},t.prototype.on=function(t,e,n){var s,a,o,h,l;if(null==n&&(n=!1),i(t))for(l in t)e=t[l],this.on(l,e);else for(a=0,o=(h=r(t)).length;a<o;a++)l=h[a],(s=this.__eventStore)[l]||(s[l]=[]),this.__eventStore[l].push({fn:e,once:n});return this},t.prototype.once=function(t,e){return e?this.on(t,e,!0):this.on(t,!0)},t.prototype.off=function(t,e){var n,s,a,o,h,l,c;if(!e)for(n=0,a=(h=r(t)).length;n<a;n++)c=h[n],this.__eventStore[c]=[];if(i(t))for(c in t)e=t[c],this.off(c,e);else for(s=0,o=(l=r(t)).length;s<o;s++)c=l[s],this.__eventStore[c]=(this.__eventStore[c]||[]).filter((function(t){return t.fn!==e}));return this},t.prototype.trigger=function(t,e){var i,n;return e||(e=[]),null!=(i=this.__eventStore[t])&&i.forEach((n=this,function(i){var r,s;if(r=i.fn,s=i.once,n.__asyncEvents?setTimeout((function(){return r.apply(null,e)}),1):r.apply(null,e),s)return n.off(t,r)})),this},t}(),t.exports=e}).call(Eu),function(){var e,i,n={}.hasOwnProperty,r=[].slice,s=[].indexOf||function(t){for(var e=0,i=this.length;e<i;e++)if(e in this&&this[e]===t)return e;return-1};i=function(t){return new(function(t){function e(){var t,i,n;this.t=(t=this.t,i=this,function(){return t.apply(i,arguments)}),e.__super__.constructor.call(this),this.dict={},this.defaultlocal="en",this.chosenLocal=void 0,this.availableLocales=[],this.locales=[],this.missingTranslations={},this.on("dict:change",(n=this,function(){return n.sortLocales()}))}return function(t,e){for(var i in e)n.call(e,i)&&(t[i]=e[i]);function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype}(e,t),e.prototype.utils={merge:function(t,e){var i,n,r;for(i in n=[],e)"object"==typeof(r=e[i])&&"object"==typeof t[i]?n.push(this.merge(t[i],r)):n.push(t[i]=r);return n},filter:function(t,e){var i,n,r,s;for(r=[],i=0,n=t.length;i<n;i++)e(s=t[i])&&r.push(s);return r},unique:function(t){var e,i,n,r,s,a;for(s={},e=0,n=t.length;e<n;e++)s[a=t[e]]=a;for(i in r=[],s)a=s[i],r.push(a);return r},getByDotNotation:function(t,e){var i;for(i=e.split(".");0!==i.length&&void 0!==t;)t=t[i[0]],i.shift();return t},isPlainObject:function(t){return!!t&&"[object Object]"===Object.prototype.toString.call(t)}},e.prototype.register=function(t,e){return t in this.dict||(this.dict[t]={},this.availableLocales.push(t)),this.utils.merge(this.dict[t],e),this.trigger("dict:change",[t])},e.prototype.set=function(t){return this.chosenLocal=t,this.sortLocales()},e.prototype.setDefault=function(t){return this.defaultLocal=t,this.sortLocales()},e.prototype.detectLocal=function(){return navigator.userLanguage||navigator.language},e.prototype.similiarLocales=function(t){return t=String(t).slice(0,2).toLowerCase(),this.utils.filter(this.availableLocales,(function(e){return t!==e&&0===e.toLowerCase().indexOf(t)}))},e.prototype.sortLocales=function(){var t,e,i,n,a,o;for(o=this.locales.slice(),a=[],e=0,i=(t=[this.chosenLocal].concat(r.call(this.similiarLocales(this.chosenLocal)),[this.detectLocal()],r.call(this.similiarLocales(this.detectLocal())),[this.defaultLocal],r.call(this.similiarLocales(this.defaultlocal)),["en"],r.call(this.similiarLocales("en")))).length;e<i;e++)n=t[e],s.call(this.availableLocales,n)>=0&&a.push(n);if(a.push.apply(a,this.availableLocales),this.locales=this.utils.unique(a),o.join(",")!==this.locales.join(","))return this.trigger("lang:change",[this.locales,o])},e.prototype.interpolate=function(){var t,e;return e=arguments[0],t=2<=arguments.length?r.call(arguments,1):[],e=this.utils.isPlainObject(t[0])?e.replace(/%\{([^}]+)\}/g,(function(e,i){return t[0][i]})):e.replace(/%(\d+)/g,(function(e,i){return t[Number(i)-1]}))},e.prototype.t=function(){var t,e,i,n,s,a,o,h;for(i=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],o=void 0,t=0,n=(a=this.locales).length;t<n&&(s=a[t],!(o=this.utils.getByDotNotation(this.dict[s],i)));t++)s in this.missingTranslations||(this.missingTranslations[s]=[]),this.missingTranslations[s].push(i),this.missingTranslations[s]=this.utils.unique(this.missingTranslations[s]),this.trigger("missing-translation",[s,i]);return"string"==typeof o?o=this.interpolate.apply(this,[o].concat(r.call(e))):void 0!==o&&(o.plural=(h=this,function(t){return t in o?o[t]:h.interpolate(o.n,t)})),o},e}(t))},null!==t&&null!=t.exports?(e=Lu,t.exports=i(e)):window.x18n=i(window.Observable)}.call(Eu)}));var Au={settings:{title:"Settings",survey:{header:"Survey",caption:"File"},view:{header:"View",camera:{caption:"Camera type",orthographic:"Orthographic",perspective:"Perspective",anaglyph:"Anaglyph"},viewpoints:{caption:"Viewpoint",none:"<select viewpoint>",plan:"Plan",elevation_n:"N Elevation",elevation_s:"S Elevation",elevation_e:"E Elevation",elevation_w:"W Elevation"},eye_separation:"Eye Separation",vertical_scaling:"Vertical Scaling",autorotate:"Auto Rotate",rotation_speed:"Rotation Speed"},shading:{header:"Shading",caption:"Underground legs",height:"by height",length:"by leg length",inclination:"by leg inclination",height_cursor:"height cursor",fixed:"fixed",survey:"survey",route:"route",depth:"depth",depth_cursor:"depth cursor",distance:"distance",beck:"beck"},selected_route:"Selected route",no_routes:"no routes defined",visibility:{header:"Visibility",legs:"Center lines",entrances:"Entrance labels",entrance_dots:"Entrance dots",stations:"Stations",labels:"Station Labels",comments:"Station Comments",walls:"Walls (LRUD)",scraps:"Scraps",splays:"Splay Legs",traces:"Dye Traces",warnings:"Warnings",box:"Bounding box",hud:"Indicators",fog:"Fog"},controls:{header:"Controls",svx_control_mode:"'Aven' controls",zoom_to_cursor:"Zoom to cursor",wheel_tilt:"Mouse wheel - tilt"},ui:{selection_tree:"Use tree selection"},colors:{header:"Colours",background_color:"Background",entrance_text:"Entrance text",entrance_background:"Entrance background",entrance_marker:"Entrance marker",bounding_box:"Bounding box",legs_fixed:"Passage lines (fixed)",surface_fixed:"Surface lines (fixed)",hud_text:"Scale text",defaults:"Restore default colours"}},surface:{title:"Surface",surface:{header:"Surface Features",legs:"Surface Legs",shading:{caption:"Shading",height:"by height",inclination:"by inclination",height_cursor:"height cursor",fixed:"fixed"}},terrain:{header:"Terrain",terrain:"Terrain visible",shading:{caption:"Shading",relief:"relief shading",height:"by height",overlay:"map overlay",contours:"contours"},overlay:{caption:"Overlay"},opacity:"Opacity",datum_shift:"Vertical datum shift",lighting:"Directional Lighting",downloadTileSet:"download tile set spec"}},selection:{title:"Selection",header:"Selection"},edit:{title:"Edit",mode:"edit mode",modes:{none:"- none -",route:"Routes",trace:"Traces",entrances:"Entrances"},entrance:{header:"Entrances"},route:{header:"Routes",current:"Current route",save:"Save",new:"New route",add:"Add",download:"Download"},trace:{header:"Traces"}},info:{title:"Information",header:"Information",stats:{header:"Survey Stats",legs:"Leg count",totalLength:"Total length",minLength:"Shortest leg",maxLength:"Longest leg"}},help:{title:"Help",header_svx:"Key commands (survex)",header_native:"Key commands (native)",shading:{header:"Shading",height:"height",inclination:"leg inclination",length:"leg length",height_cursor:"height cursor",single:"single colour",survey:"survey section",route:"route",depth:"depth below surface",depth_cursor:"depth cursor",cursor_up:"move cursor up",cursor_down:"move cursor down",distance:"distance"},view:{header:"View",full_screen:"toggle full screen",orthogonal:"orthogonal view",perspective:"perspective view",reset:"reset to inital view",center:"center on selected feature",next:"next cave",plan:"plan",elevation:"elevation",north:"face north",east:"face east",south:"face south",west:"face west",rotate_clockwise:"rotate clockwise",rotate_anticlockwise:"rotate anticlockwise",zoom_in:"zoom in",zoom_out:"zoom out",auto_rotate:"rotate continuosly",rotate_speed_up:"increase speed of rotation",rotate_speed_down:"decrease speed of rotation",reverse_rotation:"reverse direction of rotation",zoom_to_cursor:"toggle zoom to cursor mode",control_mode:"toggle control mode",decrease_focal_length:"decrease focal length",increase_focal_length:"increase focal length"},visibility:{header:"Visibility",scraps:"scraps on/off [lox only]",station_labels:"station labels on/off",entrance_labels:"entrancel abels on/off",splays:"splay legs on/off",survey:"underground legs on/off",surface:"surface legs on/off",terrain:"terrain on/off",walls:"LRUD walls on/off",stations:"station markers on/off",opacity_down:"decrease terrain opacity",opacity_up:"increase terrain opacity"},selection:{header:"Selection",remove:"remove all except selected section"}},exports:{title:"Exports",gltf_export:{header:"glTF Export",walls:"include LRUD walls",scraps:"include scraps",legs:"include centre lines",rotate_axes:"rotate axes",export:"Download"},png_export:{header:"Image (PNG) Export",export:"Snapshot",size:"Size (px)",line_scale:"Line scale"}},hud:{height:"height",leg_length:"leg length",depth:"depth",inclination:"inclination"},dnd:{splash_text:"Drag&nbsp;and&nbsp;drop a .3d or .lox model here to&nbsp;load"}};const Pu={fieldOfView:50,background:"black",sky:1077133,maxPolarAngle:180,saturatedGradient:!1,lighting:{azimuth:315,inclination:45},hud:{font:"normal Arial, sans-serif",text:"white",progress:"green",progressBackground:"dimgray",bezel:"gray",widgetSize:40,scale:{bar1:"white",bar2:"red"},compass:{top1:11549204,top2:1750245,bottom1:5774602,bottom2:807786},ahi:{sky:1077133,earth:8397056,bar:"yellow",marks:"white"},cursor:"yellow"},box:{bounding:"white",select:"blue",highlight:"red"},routes:{active:"yellow",adjacent:"red",default:"gray"},stations:{font:"normal Arial, sans-serif",entrances:{text:"white",background:"darkred",marker:"white"},junctions:{text:"yellow",marker:"yellow"},default:{text:"white",marker:"red"}},shading:{single:"red",surface:"yellow",cursor:"yellow",cursorBase:"gray",unselected:"gray",contours:{line:14793634,line10:15900002,interval:10,base:"white"},unconnected:"gray"},popup:{text:"white",border:"white",background:1118481}};function Ru(t){if(this.environment=new Map,this.themeColors=new Map,this.i18n=Cu.t,void 0!==t){var e;for(e in t)this.environment.set(e,t[e]);void 0!==Ru.home&&this.environment.set("home",Ru.home),this.setLanguage(this.value("language",navigator.language.slice(0,2)))}}function Du(t){this.script=t,this.workers=[],this.activeWorkers=new Set}Cu.register("en",Au),Cu.set("en"),void 0!==document.currentScript&&(Ru.home=document.currentScript.src.match(/^(.*\/)js\//)[1]),Ru.prototype=Object.create(u.prototype),Ru.prototype.setLanguage=function(t){if(console.log("home:",Ru.home),"en"===t)Cu.set("en");else{console.log("loading language file for:",t);(new cs).setPath(this.value("home")+"lib/").load("lang-"+t+".json",(function(e){console.log("loaded language ["+t+"]"),Cu.register(t,JSON.parse(e)),Cu.set(t)}),null,(function(){console.log("error loading language file",t)}))}const e=this;return void Cu.on(["lang:change"],(function(){e.dispatchEvent({type:"change",name:"language"})}))},Ru.prototype.value=function(t,e){return this.environment.has(t)?this.environment.get(t):e},Ru.prototype.setPropertyValue=function(t,e){this.environment.set(t,this.value(t,e)),Object.defineProperty(this,t,{set:function(e){this.environment.set(t,e),this.dispatchEvent({type:"change",name:t})},get:function(){return this.environment.get(t)}})},Ru.prototype.themeValue=function(t){const e=this.environment.get("theme"),i=t.split(".");var n;return void 0!==e&&(n=this.treeValue(e,i)),void 0===n&&(n=this.treeValue(Pu,i)),n},Ru.prototype.themeAngle=function(t){return z.degToRad(this.themeValue(t))},Ru.prototype.treeValue=function(t,e){var i,n,r=t;for(i=0;i<e.length;i++){if(void 0===r[n=e[i]])return;r=r[n]}return r},Ru.prototype.themeColorCSS=function(t){return this.themeColor(t).getStyle()},Ru.prototype.themeColor=function(t){var e=this.themeColors.get(t);if(void 0===e){var i=window.localStorage.getItem("cv-color:"+t);e=new Ut(i||this.themeValue(t)),this.themeColors.set(t,e)}return e},Ru.prototype.themeColorHex=function(t){return"#"+this.themeColor(t).getHexString()},Ru.prototype.setThemeColorCSS=function(t,e){const i=window.localStorage,n=new Ut(e);this.themeColors.set(t,n),i.setItem("cv-color:"+t,"#"+n.getHexString()),this.dispatchEvent({type:"colors",name:t})},Ru.prototype.resetColors=function(){this.themeColors.clear(),window.localStorage.clear(),this.dispatchEvent({type:"colors",name:"all"})};const Nu=window.navigator.hardwareConcurrency;function Iu(t){const e=new Map;this.getPool=function(i){var n=t.value("home","")+"js/workers/"+i,r=e.get(n);return void 0===r&&(r=new Du(n),e.set(n,r)),r},this.terminateActive=function(){e.forEach((function(t){t.terminateActive()}))},this.dispose=function(){e.forEach((function(t){t.terminateActive(),t.dispose()})),e.clear()}}Du.maxActive=void 0===Nu?4:Nu,Du.pendingWork=[],Du.activeWorkers=0,Du.prototype.terminateActive=function(){const t=this.activeWorkers;t.forEach((function(t){t.terminate()})),t.clear()},Du.prototype.getWorker=function(){var t;return t=0===this.workers.length?new Worker(this.script):this.workers.pop(),this.activeWorkers.add(t),t},Du.prototype.putWorker=function(t){this.activeWorkers.delete(t),this.workers.length<4?this.workers.push(t):t.terminate();const e=Du.pendingWork;if(e.length>0){const t=e.shift();t.pool.queueWork(t.message,t.callback)}},Du.prototype.runWorker=function(t,e){Du.activeWorkers++;const i=this.getWorker();return i.onmessage=e,i.postMessage(t),i},Du.prototype.queueWork=function(t,e){Du.activeWorkers!==Du.maxActive?this.runWorker(t,e):Du.pendingWork.push({pool:this,message:t,callback:e})},Du.prototype.dispose=function(){this.workers.forEach((function(t){t.terminate()})),this.workers=null,this.activeWorkers=null};const Ou={autoRotate:!1,autoRotateSpeed:.5,box:!0,cameraType:2,view:1,editMode:0,shadingMode:1,surfaceShading:1,terrainShading:8,terrainDirectionalLighting:!0,terrainOpacity:.5,terrainDatumShift:!1,surfaceLegs:!1,walls:!1,scraps:!1,splays:!1,stations:!1,stationLabels:!1,entrances:!0,entrance_dots:!0,terrain:!1,traces:!1,HUD:!0,fog:!1,warnings:!1,fullscreen:!1},Fu={autoRotate:!1,walls:!0,scraps:!0,box:!1,terrain:!0,terrainOpacity:1,terrainDatumShift:!0,terrainThrough:2,terrainShading:16};function Uu(t){const e=Object.keys(t),i=[];Object.getOwnPropertyNames(t).forEach((function(n){if(e.includes(n))return;const r=Object.getOwnPropertyDescriptor(t,n);void 0!==r.set&&void 0!==r.get&&i.push(n)})),this.saveState=function(){const e={};return i.forEach((function(i){const n=t[i];"object"!=typeof n&&(e[i]=n)})),e}}const zu=Math.PI/60,ku=new J;function Bu(t,e,i){this.cameraManager=t;const n=e;this.enabled=!0,this.target=new J,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.zoomSpeed=1,this.zoomToCursor=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.wheelTilt=!1;const r=t.activeCamera;this.target0=this.target.clone(),this.position0=r.position.clone(),this.zoom0=r.zoom,this.getPolarAngle=function(){return v.phi},this.getAzimuthalAngle=function(){return v.theta},this.rotateUp=function(t){K(t),this.update()},this.rotateLeft=function(t){Q(t),this.update()},this.scaleDolly=function(t){x*=t,this.update()},this.saveState=function(){const e=t.activeCamera;s.target0.copy(s.target),s.position0.copy(e.position),s.zoom0=e.zoom},this.reset=function(){const e=t.activeCamera;s.target.copy(s.target0),e.position.copy(s.position0),e.zoom=s.zoom0,e.updateProjectionMatrix(),s.dispatchEvent(a),s.update(),m=u.NONE},this.update=function(){var e=new J;const i=t.activeCamera.up;var n=(new Z).setFromUnitVectors(i,new J(0,1,0)),r=n.clone().invert(),o=new J,h=new Z;return function(){var i=t.activeCamera,l=s.target,c=i.position;e.copy(c).sub(l),e.applyQuaternion(n),v.setFromVector3(e),s.autoRotate&&m===u.NONE&&Q(2*Math.PI/60/60*s.autoRotateSpeed),v.theta+=y.theta,v.phi+=y.phi,v.theta=Math.max(s.minAzimuthAngle,Math.min(s.maxAzimuthAngle,v.theta)),v.phi=Math.max(s.minPolarAngle,Math.min(s.maxPolarAngle,v.phi)),v.makeSafe();var d=Math.max(v.radius,g);return v.radius*=x,v.radius=Math.max(s.minDistance,Math.min(s.maxDistance,v.radius)),l.add(_),s.zoomToCursor&&(i.isPerspectiveCamera?s.target.lerp(D,1-v.radius/d):i.isOrthographicCamera&&s.target.lerp(D,1-b)),e.setFromSpherical(v),e.applyQuaternion(r),c.copy(l).add(e),i.lookAt(l),y.set(0,0,0),_.set(0,0,0),x=1,!!(M||o.distanceToSquared(c)>g||8*(1-h.dot(i.quaternion))>g)&&(s.dispatchEvent(a),o.copy(c),h.copy(i.quaternion),M=!1,b=1,!0)}}(),this.dispose=function(){n.removeEventListener("contextmenu",_t,!1),n.removeEventListener("mousedown",dt,!1),n.removeEventListener("wheel",mt,!1),n.removeEventListener("touchstart",vt,!1),n.removeEventListener("touchend",xt,!1),n.removeEventListener("touchmove",yt,!1),document.removeEventListener("mousemove",pt,!1),document.removeEventListener("mouseup",ft,!1),n.removeEventListener("keydown",gt,!1)},this.end=function(){s.dispatchEvent(h)},Object.defineProperty(this,"svxControlMode",{set:q,get:function(){return X}});var s=this,a={type:"change"},o={type:"start"},h={type:"end"};var l=0,c=0;const u={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY_PAN:4};var m=u.NONE,g=1e-6;const v=new Ps,y=new Ps;var x=1,_=new J,M=!1,b=1;const w=new k,S=new k,E=new k,T=new k,L=new k,C=new k,A=new k,P=new k,R=new k,D=new J,N=new J;var I,O,F,U,z=!0,B=new k,G=new k,H=new k,V=0,W=0,j=-1,X=!1;function q(t){t?(I=rt,O=st,F=ot,U=ht):(I=st,O=at,F=lt,U=ct),X=t}function Y(){return Math.pow(.95,s.zoomSpeed)}function Q(t){y.theta-=t}function K(t){y.phi-=t}var $=function(t,e){t*=j,ku.setFromMatrixColumn(e,0),ku.multiplyScalar(t),_.add(ku)},tt=function(t,e){t*=j,ku.setFromMatrixColumn(e,1),ku.multiplyScalar(-t),_.add(ku)},et=function(e,i){const r=t.activeCamera;if(r.isPerspectiveCamera){ku.copy(r.position).sub(s.target);var a=ku.length();a*=Math.tan(r.fov/2*Math.PI/180),$(2*e*a/n.clientHeight,r.matrix),tt(2*i*a/n.clientHeight,r.matrix)}else r.isOrthographicCamera&&($(e*(r.right-r.left)/(r.zoom*n.clientWidth),r.matrix),tt(i*(r.top-r.bottom)/(r.zoom*n.clientHeight),r.matrix))};function it(e){const i=t.activeCamera;i.isPerspectiveCamera?x/=e:i.isOrthographicCamera&&(b=i.zoom,i.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,i.zoom*e)),b/=i.zoom,i.updateProjectionMatrix(),M=!0)}function nt(e){const i=t.activeCamera;i.isPerspectiveCamera?x*=e:i.isOrthographicCamera&&(b=i.zoom,i.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,i.zoom/e)),b/=i.zoom,i.updateProjectionMatrix(),M=!0)}function rt(t){B.set(t.clientX,t.clientY),V=0}function st(t){w.set(t.clientX,t.clientY)}function at(t){A.set(t.clientX,t.clientY)}function ot(t){G.set(t.clientX,t.clientY),H.subVectors(G,B);const e=performance.now();e>W+1e3&&(V=0),W=e;const i=H.x*H.x,r=H.y*H.y;switch(V){case 0:V=Math.abs(H.x)>Math.abs(H.y)?1:2;break;case 1:r>8*i&&(V=2);break;case 2:i>8*r&&(V=1)}1===V?(w.copy(B),Q(2*Math.PI*H.x*j/n.clientWidth),w.copy(G),s.update()):function(t){A.copy(B),ct(t,j)}(t),B.copy(G)}function ht(t){S.set(t.clientX,t.clientY),E.subVectors(S,w),K(2*Math.PI*E.y*j/n.clientHeight),w.copy(S),s.update()}function lt(t){S.set(t.clientX,t.clientY),E.subVectors(S,w),Q(2*Math.PI*E.x/n.clientWidth),K(2*Math.PI*E.y/n.clientHeight),w.copy(S),s.update()}function ct(t,e){P.set(t.clientX,t.clientY),R.subVectors(P,A),R.y*=e,ut(t.clientX,t.clientY),R.y>0?it(Y()):R.y<0&&nt(Y()),A.copy(P),s.update()}var ut=function(){const e=new J,n=new J;return function(r,a){const o=t.activeCamera,h=o.up;var l;const c=t.getMouse(r,a);if(z||N.x!=c.x||N.y!=c.y){const t=i.getStation(c);null!==t&&t.project(o),N.set(c.x,c.y,null==t?.5:t.z),z=!1}o.isPerspectiveCamera?(e.set(c.x,c.y,N.z),e.unproject(o),e.sub(o.position).normalize(),l=n.copy(s.target).sub(o.position).dot(h)/e.dot(h),D.copy(o.position).add(e.multiplyScalar(l))):o.isOrthographicCamera?(e.set(c.x,c.y,(o.near+o.far)/(o.near-o.far)),e.unproject(o),n.set(0,0,-1).applyQuaternion(o.quaternion),l=-e.dot(h)/n.dot(h),D.copy(e).add(n.multiplyScalar(l))):console.warn("WARNING: OrbitControls.js encountered an unknown camera type.")}}();function dt(t){if(!1!==s.enabled){switch(t.preventDefault(),function(t){var e=0;switch(t){case d:e=1;break;case p:e=4;break;case f:e=2}var i=performance.now();i-c<100?l|=e:l=e,c=i}(t.button),l){case 1:I(t),m=u.ROTATE;break;case 4:case 3:O(t),m=u.DOLLY;break;case 2:!function(t){T.set(t.clientX,t.clientY)}(t),n.style.cursor="all-scroll",m=u.PAN}m!==u.NONE&&(document.addEventListener("mousemove",pt,!1),document.addEventListener("mouseup",ft,!1),s.dispatchEvent(o)),z=!0}}function pt(t){if(!1!==s.enabled){switch(t.preventDefault(),m){case u.ROTATE:F(t);break;case u.DOLLY:U(t,1);break;case u.PAN:!function(t){L.set(t.clientX,t.clientY),C.subVectors(L,T),et(C.x,C.y),T.copy(L),s.update()}(t)}z=!0}}function ft(){!1!==s.enabled&&(n.style.cursor="default",document.removeEventListener("mousemove",pt,!1),document.removeEventListener("mouseup",ft,!1),s.dispatchEvent(h),m=u.NONE,l=0)}function mt(t){!1===s.enabled||m!==u.NONE&&m!==u.ROTATE||(t.preventDefault(),t.stopPropagation(),s.dispatchEvent(o),function(t){const e=t.deltaY;s.wheelTilt?K(2*Math.PI*e/12500):(ut(t.clientX,t.clientY),e<0?nt(Y()):e>0&&it(Y())),s.update()}(t),s.dispatchEvent(h))}function gt(t){t.preventDefault(),!1!==s.enabled&&!1!==s.enableKeys&&i.mouseOver&&function(t){switch(t.keyCode){case s.keys.UP:et(0,s.keyPanSpeed),s.update();break;case s.keys.BOTTOM:et(0,-s.keyPanSpeed),s.update();break;case s.keys.LEFT:et(s.keyPanSpeed,0),s.update();break;case s.keys.RIGHT:et(-s.keyPanSpeed,0),s.update();break;case 67:if(!X)break;Q(-zu),s.update();break;case 82:if(!X||!t.ctrlKey)break;t.preventDefault(),j*=-1;break;case 86:if(!X)break;Q(zu),s.update();break;case 191:if(!X)break;K(-zu),s.update();break;case 192:if(!X)break;K(zu),s.update();break;case 219:if(!X)break;nt(Y()),s.update();break;case 221:if(!X)break;it(Y()),s.update()}}(t)}function vt(t){if(!1!==s.enabled){switch(t.preventDefault(),t.touches.length){case 1:!function(t){w.set(t.touches[0].pageX,t.touches[0].pageY)}(t),m=u.TOUCH_ROTATE;break;case 2:!function(t){const e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;var n=Math.sqrt(e*e+i*i);A.set(0,n);const r=.5*(t.touches[0].pageX+t.touches[1].pageX),s=.5*(t.touches[0].pageY+t.touches[1].pageY);ut(r,s),T.set(r,s)}(t),m=u.TOUCH_DOLLY_PAN;break;default:m=u.NONE}m!==u.NONE&&s.dispatchEvent(o)}}function yt(t){if(!1!==s.enabled)switch(t.preventDefault(),t.stopPropagation(),t.touches.length){case 1:if(m!==u.TOUCH_ROTATE)return;!function(t){S.set(t.touches[0].pageX,t.touches[0].pageY),E.subVectors(S,w),Q(2*Math.PI*E.x/n.clientWidth),K(2*Math.PI*E.y/n.clientHeight),w.copy(S),s.update()}(t);break;case 2:if(m!==u.TOUCH_DOLLY_PAN)return;!function(t){const e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;var n=Math.sqrt(e*e+i*i);P.set(0,n),R.set(0,Math.pow(P.y/A.y,s.zoomSpeed)),it(R.y),A.copy(P);const r=.5*(t.touches[0].pageX+t.touches[1].pageX),a=.5*(t.touches[0].pageY+t.touches[1].pageY);ut(r,a),L.set(r,a),C.subVectors(L,T),et(C.x,C.y),T.copy(L),s.update()}(t);break;default:m=u.NONE}}function xt(){!1!==s.enabled&&(s.dispatchEvent(h),m=u.NONE)}function _t(t){!1!==s.enabled&&t.preventDefault()}n.addEventListener("contextmenu",_t,!1),n.addEventListener("mousedown",dt,!1),n.addEventListener("wheel",mt,!1),n.addEventListener("touchstart",vt,!1),n.addEventListener("touchend",xt,!1),n.addEventListener("touchmove",yt,!1),n.addEventListener("keydown",gt,!1);q(i.ctx.cfg.value("avenControls",!0)),this.update()}Bu.prototype=Object.create(u.prototype),Bu.prototype.constructor=Bu;const Gu=new J,Hu=new te,Vu=new Z,Wu=new Z,ju={type:"change"},Xu={type:"end"},qu={type:"accuracy",value:1e3};var Yu,Zu=function(t,e){var i=this,n=null;this.enabled=!1;const r=new J,s=new k,a=new k;var o=0;const h=e.container,l=e.materials;var c={alpha:0,beta:0,gamma:0},u=null,d=null,p=!1;function f(t){c=t,x()}function m(){u=window.orientation||0,x()}function g(t){if(p)return;p=!0;const e=t.coords;e.accuracy!==qu.value&&(qu.value=e.accuracy,i.dispatchEvent(qu)),r.set(e.longitude,e.latitude,0),n.getModelSurfaceFromWGS84(r,v)}function v(){y(),p=!1}function y(){Gu.copy(r);const e=t.activeCamera,s=e.position;if(1===t.mode){Gu.z+=500,n.getWorldPosition(Gu),s.copy(Gu),e.lookAt(Gu);const t=e.right-e.left,i=e.top-e.bottom;e.zoom=Math.min(t,i)/(2*qu.value*n.scale.x),e.updateProjectionMatrix()}else Gu.z+=2,n.getWorldPosition(Gu),s.copy(Gu);i.dispatchEvent(ju),i.dispatchEvent(Xu)}function x(){if(!1===i.enabled)return;const e=c.alpha?z.degToRad(c.alpha)+0:0,n=c.beta?z.degToRad(c.beta):0,s=c.gamma?z.degToRad(c.gamma):0,a=u?z.degToRad(u):0;!function(t,e,i,n,r){Hu.set(i,-n,e,"ZXY"),t.setFromEuler(Hu),t.multiply(Wu.setFromAxisAngle(ve.DefaultUp,-r))}(Vu,e,n,s,a),Gu.set(0,0,1).applyQuaternion(Vu);const o=Gu.angleTo(ve.DefaultUp);!function(e){var i=t.mode;e>60?i=1:e<30?i=2:0===i&&(i=1),i!==t.mode&&(t.setCamera(i,r),y())}(Math.abs(o*z.RAD2DEG-90)),2===t.mode?t.activeCamera.quaternion.copy(Vu):t.activeCamera.setRotationFromAxisAngle(ve.DefaultUp,e),i.dispatchEvent(ju),i.dispatchEvent(Xu)}function _(t){const e=t.touches.item(0);s.set(e.clientX,e.clientY),o=0}function M(e){const n=t.activeCamera,r=e.touches.item(0);a.set(r.clientX,r.clientY),s.sub(a);const c=100*s.x/h.clientWidth,u=100*s.y/h.clientHeight;0===o&&(o=Math.abs(u)>Math.abs(c)?1:-1),1===o?(n.zoom=Math.max(n.zoom+u,1),n.updateProjectionMatrix()):l.distanceTransparency=Math.max(l.distanceTransparency-c,0),s.copy(a),i.dispatchEvent(ju)}function b(){o=0}this.location=r,this.hasLocation=function(t,e){n=t,"geolocation"in navigator&&null!==n.CRS&&navigator.geolocation.getCurrentPosition((function(t){const i=t.coords;r.set(i.longitude,i.latitude,0),n.containsWGS84Position(r)&&e()}))},this.connect=function(){m(),window.addEventListener("orientationchange",m,!1),window.addEventListener("deviceorientation",f,!1),h.addEventListener("touchstart",_,!1),h.addEventListener("touchend",b,!1),h.addEventListener("touchmove",M,!1);var t=navigator.geolocation;t.getCurrentPosition(g),d=t.watchPosition(g),i.enabled=!0,x()},this.disconnect=function(){window.removeEventListener("orientationchange",m,!1),window.removeEventListener("deviceorientation",f,!1),h.removeEventListener("touchstart",_,!1),h.removeEventListener("touchend",b,!1),h.removeEventListener("touchmove",M,!1),navigator.geolocation.clearWatch(d),i.enabled=!1},this.dispose=function(){i.disconnect()}};function Ju(t,e){console.log("CaveView v"+n);const i=document.getElementById(t);this.container=i,i||alert("No container DOM object ["+t+"] available"),i.classList.add("cv-container");const s=new Ru(e),u={cfg:s,container:i,workerPools:new Iu(s),glyphStringCache:new Map,viewer:this};this.ctx=u;const p=new Oa(this);u.materials=p,i.style.backgroundColor=s.themeColorCSS("background");var m=new Dr({antialias:!0,alpha:!0});m.setSize(i.clientWidth,i.clientHeight),m.setPixelRatio(window.devicePixelRatio),m.setClearColor(s.themeColor("background"),0),m.setRenderTarget(null),m.clear(),m.autoClear=!1,i.appendChild(m.domElement);const g=new Nr(s.themeColorCSS("background"),.0025),v=new Ir;v.fog=g,v.name="CV.Viewer";var y=new Ua(u,m,v);const M=new Ls;M.layers.enableAll();const b=new za(u,v),w=new Bu(y,m.domElement,this);w.maxPolarAngle=s.themeAngle("maxPolarAngle"),w.addEventListener("change",ut),w.addEventListener("end",Tt);const S=new Zu(y,u);S.addEventListener("change",ut),S.addEventListener("end",Tt),S.addEventListener("accuracy",(function(t){I.setAccuracy(t.value)}));const E=new Ha(w,ut),T={type:"moved",cameraManager:y},L={};var C=!1,P=0,R=0,D=[],N=0,I=null,O=null,F=null,U={},z=!1,k=!0,B=null,G=!1;const H=new te,V=new Z,W=new J,j=this;var X,Y=null,Q=!1,K=!1,$=!1;function tt(){Q=!0}function et(){Q=!1}window.addEventListener("resize",ft),Object.defineProperties(this,{mouseOver:{get:function(){return Q}},reset:{set:function(){mt(!1)}},surveyLoaded:{get:function(){return C}},terrain:{get:function(){return y.testCameraLayer(7)},set:function(t){null!==I&&I.isLoaded&&(I.setVisibility(t),y.setCameraLayer(7,t),j.dispatchEvent({type:"change",name:"terrain"}),Et())}},terrainShading:{get:function(){return null!==I?I.shadingMode:null},set:st(ht,"terrainShading")},hasTerrain:{get:function(){return!!I}},hasRealTerrain:{get:function(){return I&&!I.isFlat}},terrainAttributions:{get:function(){return null!==I?I.attributions:[]}},terrainDirectionalLighting:{get:function(){return b.directionalLighting},set:function(t){b.directionalLighting=t,Et()}},terrainThrough:{get:function(){return null!==I?I.throughMode:null},set:st((function(t){if(null===I)return;I.setThroughMode(t),p.distanceTransparency=2===t?200:0,ht(I.shadingMode)}),"terrainThrough")},terrainShadingModes:{get:function(){return null!==I?I.terrainShadingModes:{}}},terrainTileSet:{get:function(){return I.tileSet.bind(I)}},terrainDatumShift:{get:function(){return!!I.activeDatumShift},set:function(t){if(null===I)return;I.applyDatumShift(t),j.dispatchEvent({type:"change",name:"terrainDatumShift"}),Et()}},terrainOpacity:{get:function(){return null!==I?I.getOpacity():0},set:function(t){if(null===I)return;I.setOpacity(t),j.dispatchEvent({type:"change",name:"terrainOpacity"}),Et()}},shadingMode:{get:function(){return O.caveShading},set:st(dt,"shadingMode")},flatShading:{get:function(){return O.wallsMode},set:function(t){O.setWallsMode(t),Et()}},route:{get:function(){return O.getRoutes().setRoute},set:function(t){O.getRoutes().setRoute=t}},routeNames:{get:function(){return O.getRoutes().getRouteNames()}},surfaceShading:{get:function(){return O.surfaceShading},set:st((function(t){O.setSurfaceShading(t),Et()}),"surfaceShading")},cameraType:{get:function(){return y.mode},set:st((function(t){y.setCamera(t,w.target),Et()}),"cameraType")},eyeSeparation:{get:function(){return y.eyeSeparation},set:function(t){y.eyeSeparation=t,Et()}},view:{get:function(){return 0},set:st((function(t){const e=W;switch(t){case 0:return;case 1:e.set(0,0,-1);break;case 2:e.set(0,1,0);break;case 3:e.set(0,-1,0);break;case 4:e.set(1,0,0);break;case 5:e.set(-1,0,0);break;default:return void console.warn("invalid view mode specified: ",t)}E.prepare(O.getWorldBoundingBox(),e),E.start(k)}),"view")},cursorHeight:{get:function(){return p.cursorHeight},set:function(t){p.cursorHeight=t,j.dispatchEvent({type:"cursorChange",name:"cursorHeight"}),Et()}},maxDistance:{get:function(){return O.getMaxDistance()}},maxHeight:{get:function(){return null===F?0:F.max.z}},minHeight:{get:function(){return null===F?0:F.min.z}},maxLegLength:{get:function(){return U.maxLegLength}},minLegLength:{get:function(){return U.minLegLength}},section:{get:function(){return O.selection.getNode()},set:st(pt,"section")},sectionByName:{get:function(){return O.selection.getName()},set:function(t){pt(O.surveyTree.getByPath(t)||O.surveyTree)}},popup:{set:function(t){_t(),t.isStation()&&xt(t)}},highlight:{set:st((function(t){O.highlightSelection(t),Et()}),"highlight")},polarAngle:{get:function(){return w.getPolarAngle()},set:function(t){E.setPolarAngle(t)}},azimuthAngle:{set:function(t){E.setAzimuthAngle(t)}},editMode:{get:function(){return R},set:function(t){!function(t){switch(R=Number(t),P=R,N=0,O.markers.clear(),O.selectSection(O.surveyTree),Et(),M.params.Points.threshold=3,R){case 3:D=O.pointTargets.concat([O.dyeTraces]);break;case 0:D=O.pointTargets;break;case 1:D=O.legTargets;break;case 4:D=O.entranceTargets,M.params.Points.threshold=15;break;default:console.warn("invalid mouse mode",t)}}(t),j.dispatchEvent({type:"change",name:"editMode"})}},setPOI:{set:st((function(){E.start(!0)}),"setPOI")},HUD:{get:function(){return it.getVisibility()},set:function(t){it.setVisibility(t)}},cut:{set:function(){const t=O.selection;if(t.isEmpty()||t.isStation())return;E.cancel(),O.remove(I),O.cutSection(t.getNode());const e=O;Y=X.saveState(),j.clearView(),G=!0,gt(e)}},zScale:{get:function(){return O.zScale},set:function(t){O.zScale=t,Et()}},autoRotate:{get:function(){return w.autoRotate},set:function(t){var e;e=!!t,E.setAutoRotate(e),j.dispatchEvent({type:"change",name:"autoRotate"})}},wheelTilt:{get:function(){return w.wheelTilt},set:function(t){w.wheelTilt=!!t,j.dispatchEvent({type:"change",name:"wheelTilt"})}},svxControlMode:{get:function(){return w.svxControlMode},set:function(t){w.svxControlMode=!!t,j.dispatchEvent({type:"newCave",name:"newCave"})}},zoomToCursor:{get:function(){return w.zoomToCursor},set:function(t){w.zoomToCursor=!!t,j.dispatchEvent({type:"change",name:"zoomToCursor"})}},autoRotateSpeed:{get:function(){return w.autoRotateSpeed/11},set:function(t){w.autoRotateSpeed=11*Math.max(Math.min(t,1),-1),j.dispatchEvent({type:"change",name:"autoRotateSpeed"})}},fullscreen:{get:at,set:function(t){if(at()===t)return;t?(i.classList.add("toggle-fullscreen"),null===document.fullscreenElement?i.requestFullscreen():null===document.msfullscreenElement?i.msRequestFullscreen():null===document.webkitFullscreenElement&&i.webkitRequestFullscreen()):(i.classList.remove("toggle-fullscreen"),document.fullscreenElement?document.exitFullscreen():document.msFullscreenElement?document.msExitFullscreen():document.webkitFullscreenElement&&(document.webkitExitFullscreen?document.webkitExitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()))}},hasContours:{get:function(){return!(null===m.extensions.get("OES_standard_derivatives"))}},fog:{get:function(){return z},set:function(t){z=t,g.density=z?.0025:0,Et()}},isClipped:{get:function(){return G}},hasLocation:{get:function(){return K}},trackLocation:{get:function(){return $},set:function(t){t?(Y=X.saveState(),w.saveState(),S.connect(),j.setView(Fu,null),E.cancel()):(S.disconnect(),null!==I&&I.setScale(0),j.setView(Y,null),E.cancel(),w.reset(),Y=null);w.enabled=!t,$=t,Et()}},maxSnapshotSize:{get:function(){const t=m.getContext();return t.getParameter(t.MAX_RENDERBUFFER_SIZE)}},focalLength:{get:function(){return y.focalLength},set:function(t){const e=t/y.focalLength;y.focalLength=t,w.scaleDolly(e)}}}),rt(4,"box"),rt(6,"entrances"),rt(17,"entrance_dots"),rt(8,"stations"),rt(9,"traces"),rt(h,"scraps"),rt(o,"walls"),rt(1,"legs"),rt(2,"splays"),rt(3,"surfaceLegs"),rt(l,"stationLabels"),rt(c,"stationComments"),rt(14,"warnings"),i.addEventListener("mouseover",tt),i.addEventListener("mouseleave",et),i.addEventListener("fullscreenchange",ot),i.addEventListener("msfullscreenchange",ot),i.addEventListener("webkitfullscreenchange",ot),this.addEventListener("change",(function(t){null!==O&&"splays"===t.name&&O.stations.setSplaysVisibility(j.splays)})),s.addEventListener("colors",(()=>{i.style.backgroundColor=s.themeColorCSS("background"),m.setClearColor(s.themeColor("background"),0),O&&O.refreshColors(),Et()})),this.getControls=function(){return w};const it=new ca(this,m),nt=new rc(u,(function(t){if(!t)return void alert("failed loading cave information");ft(),gt(new tu(u,t)),nt.reset()}));function rt(t,e){Object.defineProperty(j,e,{get:function(){return y.testCameraLayer(t)},set:function(i){y.setCameraLayer(t,i),j.dispatchEvent({type:"change",name:e}),Et()}});const i="has"+e.substr(0,1).toUpperCase()+e.substr(1);Object.defineProperty(j,i,{get:function(){return O.hasFeature(t)}})}function st(t,e){return function(i){t(isNaN(i)?i:Number(i)),j.dispatchEvent({type:"change",name:e})}}function at(){return window.innerHeight===i.clientHeight&&window.innerWidth===i.clientWidth}function ot(){document.fullscreenElement||document.msFullscreenElement||document.webkitFullscreenElement?i.classList.add("toggle-fullscreen"):i.classList.remove("toggle-fullscreen"),ft(),j.dispatchEvent({type:"change",name:"fullscreen"})}function ht(t){null!==O.terrain&&(I.setShadingMode(t,Et),Et(),I.isTiled&&I.zoomCheck(y))}function lt(t){t.isLoaded&&((I=t).setup(m,v,O),s.value("useGPS",!1)&&S.hasLocation(O,ct),I.isTiled&&(I.addEventListener("progress",vt),I.watch(j))),mt(!0)}function ct(){K=!0,j.dispatchEvent({type:"newCave",name:"newCave"})}function ut(){const t=y.activeCamera;H.setFromQuaternion(t.getWorldQuaternion(V)),b.setRotation(H),$&&null!==I&&(t.isOrthographicCamera?(I.setScale(t.zoom*O.scale.z),I.setTarget(S.location)):I.setScale(0)),Et()}function dt(t){O.setShadingMode(t)===a?(P=R,R=2,D=O.pointTargets):R=P,Et()}function pt(t){return t.isStation()?function(t){3===R?wt(t):(O.selectStation(t),E.preparePoint(O.getWorldPosition(t.p.clone())))}(t):function(t){O.selectSection(t),E.cancel(),E.prepare(O.selection.getWorldBoundingBox()),O.selection.isEmpty()&&E.start(k)}(t),void Et()}function ft(){const t=i.clientWidth,e=i.clientHeight;m.setSize(t,e),j.dispatchEvent({type:"resized",name:"rts",width:t,height:e}),Et()}function mt(t){k=!0,null===Y?j.setView(Ou,s.value("view",{})):(j.setView(Y),Y=null),t&&j.dispatchEvent({type:"newCave",name:"newCave"})}function gt(t){k=!1,O=t,it.getProgressDial(1).watch(O),U=j.getLegStats(1),function(){const t=i.clientWidth,e=i.clientHeight,n=O.scaleFactor;F=O.limits;const r=O.combinedLimits.getSize(W);var s=Math.min(t/r.x,e/r.y);s===1/0&&(s=1);const a=s*n;O.setScale(s,a),it.setScale(a)}(),p.flushCache(),v.addStatic(O),D=O.pointTargets,v.matrixAutoUpdate=!1,i.addEventListener("mousedown",bt,!1),w.enabled=!0,O.getRoutes().addEventListener("changed",yt),O.addEventListener("changed",yt),C=!0;let e=O.terrain;null!==e?lt(e):navigator.onLine?(e=new Su(u,O,lt),it.getProgressDial(0).watch(e),mt(!1)):mt(!0)}function vt(t){"end"===t.name&&Et()}function yt(){dt(O.caveShading)}function xt(t){if(null!==B)return;const e=I?t.p.z-I.getHeight(t.p):null;B=new au(u,t,O,e,L.station,O.caveShading===a,j.warnings),O.add(B),Et()}function _t(){null!==B&&(B.close(),B=null)}function Mt(){i.removeEventListener("mouseup",Mt),_t(),Et(),j.dispatchEvent({type:"select",node:null})}function bt(t){if(t.target!==m.domElement)return;const e=W.set(i.clientWidth/2,i.clientHeight/2,0),n=y.getMouse(t.clientX,t.clientY);M.setFromCamera(n,y.activeCamera);const s=M.intersectObjects(D,!1);var a;if(0===R&&j.entrances&&null!==(a=O.entrances.intersectLabels(n,y.activeCamera,e))){const e=O.surveyTree.findById(a.stationID),i={type:"entrance",node:e,handled:!1,mouseEvent:t};if(j.dispatchEvent(i),i.handled)return;h(e)}else{var o;if(!(s.length<1))switch(R){case 0:h(St(s));break;case 1:o=s[0],O.getRoutes().toggleSegment(o.index),dt(r),Et();break;case 2:!function(e){if(null===e)return;t.button===d?(O.showShortestPath(e),l(e)):t.button===f&&(O.shortestPathSearch(e),j.dispatchEvent({type:"change",name:"shadingMode"}),Et())}(St(s));break;case 3:t.button===d&&("Mesh"===s[0].object.type?function(t){const e=O.dyeTraces,i=t.faceIndex;O.markers.clear(),e.outlineTrace(i),j.dispatchEvent({type:"selectedTrace",trace:e.getTraceStations(i),delete:function(){e.deleteTrace(i),Et()}}),Et()}(s[0]):wt(St(s)))}}function h(e){if(null===e)return;O.selectStation(e);const n={type:"select",node:e,handled:!1,mouseEvent:t};j.dispatchEvent(n),n.handled||(t.button===d?l(e):t.button===f&&function(e){O.selection.contains(e.id)||O.selectSection(O.surveyTree);pt(e),E.start(!0),t.stopPropagation(),i.addEventListener("mouseup",c)}(e))}function l(t){return xt(t),i.addEventListener("mouseup",Mt),E.preparePoint(O.getWorldPosition(t.p.clone())),!0}function c(){i.removeEventListener("mouseup",c),$||(w.enabled=!0),Et(),j.dispatchEvent({type:"select",node:null})}}function wt(t){if(null===t)return;const e=O.dyeTraces,i=O.markers;e.outlineTrace(null),3==++N&&(i.clear(),N=1),i.mark(t);const n=i.getStations();var r,s;void 0!==n[0]&&(r=n[0].getPath()),void 0!==n[1]&&(s=n[1].getPath()),j.dispatchEvent({type:"selectedTrace",start:r,end:s,add:function(){2===n.length&&(e.addTrace(n[0],n[1]),i.clear(),Et())}}),Et()}function St(t){return O.stations.getClosestVisibleStation(y.activeCamera,t)}function Et(){k&&(m.clear(),C&&(O.update(y,w.target,!$),z&&p.setFog(!0),y.activeRenderer()),z&&p.setFog(!1),it.renderHUD())}function Tt(){j.dispatchEvent(T)}it.getProgressDial(0).watch(nt),X=new Uu(this),this.renderView=Et,ft(),this.addOverlay=function(t,e,i){Wc.addOverlay(u,t,e,i)},this.addFormatters=function(t){L.station=t},this.clearView=function(){C=!1,m.clear(),it.setVisibility(!1),u.workerPools.terminateActive(),I&&I.isTiled&&I.unwatch(j),v.remove(O),w.enabled=!1,O=null,I=null,F=null,R=0,D=[],K=!1,i.removeEventListener("mousedown",bt),y.resetCameras(),w.reset()},this.loadCave=function(t,e){nt.reset(),nt.loadFile(t,e),G=void 0!==e&&""!=e},this.loadCaves=function(t){nt.reset(),nt.loadFiles(t)},this.setView=function(t,e){k&&(k=!1,Object.assign(this,t,e),k=!0,Et())},this.getStation=function(t){const e=M.params.Points.threshold;M.setFromCamera(t,y.activeCamera),M.params.Points.threshold=20;const i=M.intersectObjects(O.pointTargets,!1);if(M.params.Points.threshold=e,i.length<1)return null;const n=St(i);return null===n?null:O.getWorldPosition(n.p.clone())},this.renderView=Et,this.getLegStats=function(t){return void 0!==O.getFeature(t)?O.getFeature(t).stats:{legs:0,legLength:0,minLegLength:0,maxLegLength:0}},this.getControls=function(){return w},this.getMetadata=function(){return O.metadata},this.getGLTFExport=function(t,e,i){O.gltfExport(t,e,i)},this.getSurveyTree=function(){return O.surveyTree},this.showImagePopup=function(t,e){!function(t,e){null===B&&(B=new ou(u,t,e,Et),O.add(B),Et())}(t.node,e),i.addEventListener("mouseup",Mt)},this.getSnapshot=function(t,e){var n=i.clientWidth,r=i.clientHeight,s=t,a=Math.round(r*s/n);const o=new q(s,a,{minFilter:_,magFilter:x,format:A,stencilBuffer:!0});o.texture.generateMipmaps=!1,o.texture.name="CV.snapshot",m.setSize(s,a),m.setPixelRatio(1),m.setRenderTarget(o),m.setClearAlpha(1),j.dispatchEvent({type:"resized",name:"rts",width:s,height:a,lineScale:e}),Et();const h=s*a*4,l=new Uint8ClampedArray(h);m.readRenderTargetPixels(o,0,0,s,a,l);const c=4*s,u=new Uint8ClampedArray(h);for(let t=0;t<h;t+=c){const e=h-t-c;for(let i=0;i<c;i++)u[e+i]=l[t+i]}const d=new ImageData(u,s,a);var p=document.createElement("canvas");return p.width=s,p.height=a,p.getContext("2d").putImageData(d,0,0),o.dispose(),m.setRenderTarget(null),m.setPixelRatio(window.devicePixelRatio),m.setClearAlpha(0),ft(),p.toDataURL()},this.dispose=function(){u.workerPools.dispose(),v.remove(O),w.dispose(),S.dispose(),it.dispose(),u.glyphStringCache=null,u.cfg=null,u.workerPools=null,u.materials=null,u.container=null,window.removeEventListener("resize",ft),i.removeChild(m.domElement),i.removeEventListener("mouseover",tt),i.removeEventListener("mouseleave",et),i.removeEventListener("mousedown",bt),i.removeEventListener("fullscreenchange",ot),i.removeEventListener("msfullscreenchange",ot),m.clear(),m.dispose(),m=null}}(Zu.prototype=Object.create(u.prototype)).constructor=Zu,Ju.prototype=Object.create(u.prototype);var Qu={init:function(t,e){Yu=new Ju(t,e),CV.Viewer=Yu}};function Ku(t){this.ctx=t,this.openPageId=null,this.reset()}function $u(t,e,i,n){const r=document.createElement("div"),s=document.createElement("div");s.classList.add("page"),r.classList.add(t),r.classList.add("tab"),this.page=s,this.tab=r,this.onTop=i,this.frame=null,this.onLeave=n,this.slide=void 0,this.x18nPrefix=e+".",this.onChange=null,this.id=t}function td(t,e){$u.call(this,"icon_help","help"),t.addPage(this);const i=this;var n;function r(t,e){const r=document.createElement("dt"),s=document.createElement("dd");r.textContent=t,s.textContent=i.i18n(e),n.appendChild(r),n.appendChild(s)}this.addHeader(e?"header_svx":"header_native"),this.addHeader("shading.header"),n=document.createElement("dl"),r("1","shading.height"),r("2","shading.inclination"),r("3","shading.length"),r("4","shading.height_cursor"),r("5","shading.single"),r("6","shading.survey"),r("7","shading.route"),r("8","shading.depth"),r("9","shading.depth_cursor"),r("0","shading.distance"),e||(r("[","shading.cursor_up"),r("]","shading.cursor_down")),this.appendChild(n),this.addHeader("view.header"),n=document.createElement("dl"),e?(r("P","view.plan"),r("L","view.elevation"),r("","-"),r("N","view.north"),r("E","view.east"),r("S","view.south"),r("W","view.west"),r("","-"),r("C","view.rotate_clockwise"),r("V","view.rotate_anticlockwise"),r("]","view.zoom_in"),r("[","view.zoom_out"),r("F","view.full_screen"),r("","-"),r('" "',"view.auto_rotate"),r("Z","view.rotate_speed_up"),r("V","view.rotate_speed_down"),r("R","view.reverse_rotation"),r("","-"),r("<del>","view.reset")):(r("F","view.full_screen"),r("O","view.orthogonal"),r("P","view.perspective"),r("R","view.reset"),r(".","view.center"),r("N","view.next")),r("<alt>S","view.control_mode"),r("<alt>X","view.zoom_to_cursor"),r("(","view.decrease_focal_length"),r(")","view.increase_focal_length"),this.appendChild(n),this.addHeader("visibility.header"),n=document.createElement("dl"),e?(r("J","visibility.station_labels"),r("Q","visibility.splays"),r("T","visibility.terrain"),r("<ctrl>N","visibility.station_labels"),r("<ctrl>X","visibility.stations"),r("<ctrl>L","visibility.survey"),r("<ctrl>F","visibility.surface"),r("","-"),r("<","visibility.opacity_down"),r(">","visibility.opacity_up")):(r("C","visibility.scraps"),r("J","visibility.station_labels"),r("L","visibility.entrance_labels"),r("Q","visibility.splays"),r("S","visibility.surface"),r("T","visibility.terrain"),r("W","visibility.walls"),r("Z","visibility.stations"),r("","-"),r("<","visibility.opacity_down"),r(">","visibility.opacity_up")),this.appendChild(n),e||(this.addHeader("selection.header"),n=document.createElement("dl"),r("V","selection.remove"),this.appendChild(n))}function ed(t,e,i){$u.call(this,"icon_info","info"),t.addPage(this),this.addHeader("header"),this.addHeader("stats.header"),this.addText("file: "+i.file);const n=e.getLegStats(1);this.addLine(this.i18n("stats.legs")+": "+n.legCount),this.addLine(this.i18n("stats.totalLength")+": "+n.legLength.toFixed(2)+"m"),this.addLine(this.i18n("stats.minLength")+": "+n.minLegLength.toFixed(2)+"m"),this.addLine(this.i18n("stats.maxLength")+": "+n.maxLegLength.toFixed(2)+"m"),this.addHeader("CaveView v2.1.test5."),this.addLogo(),this.addText("A WebGL 3d cave viewer for Survex (.3d), Therion (.lox) and Compass (.plt) models."),this.addText("For more information see: "),this.addLink("https://aardgoose.github.io/CaveView.js/","CaveView on GitHub"),this.addText(" Angus Sawyer, 2020")}function id(t,e,i,n){$u.call(this,"icon_explore","selection",(function(){a.isOntop=!0}),(function(){a.isOntop=!1})),t.addPage(this),this.surveyTree=e.getSurveyTree(),this.currentTop=this.surveyTree,this.nodes=new WeakMap,this.leafSections=new WeakSet,this.lastSelected=null,this.lastSection=0,this.lastShadingMode=e.shadingMode,this.currentHover=null,this.stringCompare=new Intl.Collator("en-GB",{numeric:!0}).compare,this.isOntop=!1;const r=document.createElement("div"),s=e.ctx.cfg;r.id="ui-path",r.classList.add("header"),e.isClipped?(this.addListener(r,"click",(function(){n.reload()})),r.classList.add("reload"),r.textContent=this.currentTop.name):(r.textContent=this.currentTop.name,this.nodes.set(r,this.currentTop)),this.titleBar=r,this.appendChild(r),this.addListener(this.page,"mouseover",(function(t){const i=t.target;if("LI"!==i.nodeName)return;const n=a.nodes.get(i);n!==a.currentHover&&(e.highlight=e.section!==n?n:a.surveyTree,e.popup=n,a.currentHover=n)})),this.addListener(this.page,"mouseleave",(function(){e.highlight=a.surveyTree,e.popup=a.surveyTree})),this.addListener(this.page,"click",(function(t){t.stopPropagation(),t.preventDefault();const i=t.target,n=a.nodes.get(i);switch(i.tagName){case"LI":e.section=n,e.setPOI=!0,i.classList.add("selected"),null!==a.lastSelected&&a.lastSelected.classList.remove("selected"),a.lastSelected=i;break;case"DIV":a.handleNext(i,n);break;case"SPAN":a.handleBack(i)}})),this.addListener(this.page,"dblclick",(function(t){t.stopPropagation(),t.preventDefault();const i=t.target,n=a.nodes.get(i);if(!i.classList.contains("section"))return;n!==a.surveyTree&&(e.cut=!0)}));const a=this;return i.clientHeight,this.addLine=function(t,i){const n=void 0===i.p?null:i.p.connections;if(null===n||this.leafSections.has(t)||this.leafSections.add(t),0===n&&!e.splays&&1!==i.type)return;const r=document.createElement("li"),h=void 0===i.comment?i.name:i.name+" ( "+i.comment+" )",l=document.createTextNode(h);var c;if(a.nodes.set(r,i),e.section===i&&r.classList.add("selected"),null===n?(c=o(" ","#444444"),r.classList.add("section")):void 0!==i.type&&1===i.type?(c=o(" ",s.themeColorCSS("stations.entrances.marker"))).classList.add("cv-entrance"):c=n>2?o(" ",s.themeColorCSS("stations.junctions.marker")):o(0===n?" ":" ",s.themeColorCSS("stations.default.marker")),r.appendChild(c),r.appendChild(l),i.children.length>0){const t=document.createElement("div");t.classList.add("descend-tree"),a.nodes.set(t,i),r.appendChild(t)}t.appendChild(r)},this.displaySectionCommon=function(t){const i=t.children,n=this;t.sorted||(i.sort((function(t,e){return n.stringCompare(t.name,e.name)})),t.sorted=!0);const r=document.createElement("ul");return r.classList.add("cv-tree"),t.forEachChild((function(t){n.addLine(r,t)})),h(r),this.currentTop=t,this.lastShadingMode=e.shadingMode,r},this.reloadSections=function(){const t=this.page.getElementsByTagName("UL"),e=[],i=this;var n;for(n=0;n<t.length;n++){const i=t[n];this.leafSections.has(i)&&e.push(i)}e.forEach((function(t){const e=i.nodes.get(t.previousSibling)||i.currentTop;e&&t.replaceWith(i.displaySectionCommon(e))}))},void(this.onChange=function(t){if(!e.surveyLoaded)return;if("splays"===t.name)return void a.reloadSections();(a.lastSection!==e.section||6===a.lastShadingMode&&6!==e.shadingMode||6!==a.lastShadingMode&&6===e.shadingMode)&&(h(),a.lastShadingMode=e.shadingMode,a.lastSection=e.section)});function o(t,e){const i=document.createElement("span");return i.style.color=e,i.textContent=t,i}function h(t){const i=(void 0===t?a.page:t).getElementsByTagName("li");var n;const r=e.ctx.surveyColourMapper,s=6===e.shadingMode?r.getColourMap(e.section):null;for(n=0;n<i.length;n++){const t=i[n],e=a.nodes.get(i[n]);if(void 0!==e&&void 0===e.p){const i=t.firstChild,n=e.id;let r;r=null!==s&&void 0!==s[n]?"#"+s[n].getHexString():"#444444",i.style.color=r}}}}function nd(t,e,i,n){id.call(this,t,e,i,n);const r=this;var s=0;return this.addSlide(a(r.currentTop),s),i.clientHeight,this.handleNext=function(t,i){void 0!==i&&i!==r.surveyTree?r.replaceSlide(a(i),++s):"ui-path"===t.id&&(e.section=r.currentTop)},this.handleBack=function(t){if("surveyBack"===t.id){if(r.currentTop===r.surveyTree)return;r.replaceSlide(a(r.currentTop.parent),--s)}},this;function a(t){var e;for(r.nodes=new WeakMap;e=r.titleBar.firstChild;)r.titleBar.removeChild(e);if(t===r.surveyTree)r.titleBar.textContent=""===t.name?"[model]":t.name,r.nodes.set(r.titleBar,t);else{const e=document.createElement("span");e.id="surveyBack",e.textContent=" ",r.nodes.set(e,t),r.titleBar.appendChild(e),r.titleBar.appendChild(document.createTextNode(" "+t.name))}return r.displaySectionCommon(t)}}function rd(t,e,i,n){id.call(this,t,e,i,n);const r=this,s=r.displaySectionCommon(this.currentTop);var a=null,o=0;return this.appendChild(s),i.clientHeight,this.handleNext=function(t,i){if(void 0!==i&&i!==r.surveyTree){const e=t.parentNode;if(!t.classList.contains("open")){const n=r.displaySectionCommon(i);return e.appendChild(n),t.classList.add("open"),n}e.removeChild(e.lastElementChild),t.classList.remove("open")}else"ui-path"===t.id&&(e.section=r.currentTop)},this.handleBack=function(){},e.addEventListener("select",h),this._dispose=function(){e.removeEventListener("select",h)},this;function h(t){if(!r.isOntop)return;const e=t.node;if(null===e)return r.frame.frame.removeEventListener("scroll",u),void(o>performance.now()-1e3?setTimeout(c,1e3):c());const i=[];var n=e;do{i.push(n),n=n.parent}while(0!==n.id);var a=s,h=a.childNodes;for(n=i.pop();void 0!==n;){let t,s=0;for(s=0;s<h.length&&(t=h[s],r.nodes.get(t)!=n);s++);if(s==h.length)break;if(n===e){l(t);break}{let e=t.lastElementChild;"DIV"===e.tagName&&(e=r.handleNext(e,n)),n=i.pop(),h=e.childNodes,a=e}}}function l(t){o=0,r.frame.frame.addEventListener("scroll",u),t.classList.add("highlight"),t.scrollIntoView({behavior:"smooth",block:"center"}),null!==a&&c(),a=t}function c(){null!=a&&(a.classList.remove("highlight"),a=null,o=0)}function u(t){o=t.timeStamp}}Ku.prototype.reset=function(){const t=this,e=document.createElement("div");e.classList.add("cv-frame");const i=document.createElement("div");i.classList.add("cv-frame-header"),i.textContent="frame header",e.appendChild(i);const n=document.createElement("div");n.classList.add("cv-tab-box"),this.pages&&this.pages.forEach((function(t){t.owner.dispose()})),this.frame=e,this.header=i,this.tabBox=n,this.pages=[],this.listeners=[],this.inHandler=!1,this.controls=[],this.seq=0;const r=document.createElement("div");r.classList.add("close"),r.classList.add("tab"),this.addListener(r,"click",(function(){t.openPageId=null,t.tabBox.classList.remove("onscreen"),t.frame.classList.remove("onscreen")})),n.appendChild(r)},Ku.seq=0,Ku.prototype.addPage=function(t){const e=t.page,i=t.tab;return t.frame=this,this.addListener(i,"click",t.tabHandleClick.bind(t)),void 0!==t.onTop&&this.addListener(i,"click",t.onTop),this.tabBox.appendChild(i),this.frame.appendChild(e),this.pages.push({tab:i,page:e,owner:t}),this.openPageId===t.id&&t.open(),this},Ku.prototype.getSeq=function(){return Ku.seq++},Ku.prototype.onScreen=function(t){this.tabBox.classList.add("onscreen"),this.frame.classList.add("onscreen"),this.header.textContent=t},Ku.prototype.setParent=function(t){t.appendChild(this.tabBox),t.appendChild(this.frame)},Ku.prototype.setControlsVisibility=function(t,e){const i=e?"block":"none";t.forEach((function(t){null!==t&&(t.style.display=i)}))},Ku.prototype.clear=function(){const t=this.frame,e=this.tabBox;null!==t&&null!==t.parentElement&&t.parentElement.removeChild(t),null!==e&&null!==e.parentElement&&e.parentElement.removeChild(e),this.listeners.forEach((function(t){t.obj.removeEventListener(t.name,t.handler)})),this.reset()},Ku.prototype.addFullscreenButton=function(t,e,i){const n=this.tabBox,r=document.createElement("div");return r.classList.add(t),r.classList.add("tab"),this.addListener(r,"click",(function(){e[i]=!e[i],s()})),this.addListener(e,"change",s),n.appendChild(r),s(),r;function s(){e[i]?(r.classList.remove("expand"),r.classList.add("collapse")):(r.classList.add("expand"),r.classList.remove("collapse"))}},Ku.prototype.addListener=function(t,e,i){t.addEventListener(e,i,!1),this.listeners.push({obj:t,name:e,handler:i})},Ku.prototype.handleChange=function(t){const e=t.target,i=t.name;if(!this.displayinHandle&&this.controls[i]){const t=this.controls[i];switch(t.type){case"checkbox":t.checked=e[i];break;case"select-one":case"range":t.value=e[i];break;case"download":t.href=e[i]}}this.pages.forEach((function(e){const i=e.owner;null!==i.onChange&&i.onChange(t)}))},$u.prototype.constructor=$u,$u.prototype.i18n=function(t){const e=this.frame.ctx.cfg.i18n(this.x18nPrefix+t);return void 0===e?t:e},$u.prototype.addListener=function(t,e,i){this.frame.addListener(t,e,i)},$u.prototype.tabHandleClick=function(t){t.preventDefault(),t.stopPropagation(),this.open()},$u.prototype.open=function(){const t=this.tab,e=this.frame.pages;t.classList.add("toptab"),this.frame.onScreen(this.i18n("title")),this.frame.openPageId=this.id,e.forEach((function(e){const i=e.page,n=e.tab,r=e.owner;n===t?i.style.display="block":(i.style.display="none",n.classList.contains("toptab")&&(n.classList.remove("toptab"),void 0!==r.onLeave&&r.onLeave()))}))},$u.prototype.appendChild=function(t){return this.page.appendChild(t),t},$u.prototype.addHeader=function(t){const e=document.createElement("div");return e.classList.add("header"),e.textContent=this.i18n(t),this.page.appendChild(e),e},$u.prototype.addCollapsingHeader=function(t){const e=document.createElement("div");e.classList.add("header"),e.textContent=this.i18n(t),e.classList.add("header_full"),this.page.appendChild(e);const i=document.createElement("div");return i.classList.add("container_full"),this.page.appendChild(i),e.addEventListener("click",(function(){e.classList.contains("header_collapsed")?(i.style.display="block",i.addEventListener("transitionend",(function t(){i.removeEventListener("transitionend",t),e.classList.remove("header_collapsed")})),i.clientHeight,i.classList.remove("container_collapsed")):(i.addEventListener("transitionend",(function t(){i.removeEventListener("transitionend",t),e.classList.add("header_collapsed"),i.style.display="none"})),i.classList.add("container_collapsed"))})),i},$u.prototype.addText=function(t){const e=this.addLine(t);return e.classList.add("spaced"),e},$u.prototype.addLine=function(t){const e=document.createElement("p");return e.textContent=t,this.page.appendChild(e),e},$u.prototype.addLink=function(t,e){const i=document.createElement("a");return i.href=t,i.textContent=e,i.target="_blank",this.page.appendChild(i),i},$u.prototype.makeLabel=function(t,e,i="na"){const n=document.createElement("label");return n.textContent=this.i18n(t),n.htmlFor=i,n.classList.add(e),n},$u.prototype.addSelect=function(t,e,i,n,r){const s=document.createElement("div"),a=document.createElement("select");if(s.classList.add("control"),e instanceof Array)e.forEach((function(t){const e=document.createElement("option");e.value=t,e.text=t,e.text===i[n]&&(e.selected=!0),a.add(e,null)}));else for(var o in e){const t=document.createElement("option");t.text=o.split(" ").reduce(((t,e)=>t+" "+this.i18n(e)),"").trim(),t.value=e[o],t.value==i[n]&&(t.selected=!0),a.add(t,null)}const h=this.frame;return this.addListener(a,"change",(function(t){h.inHandler=!0,i[n]=t.target.value,h.inHandler=!1})),h.controls[n]=a,s.appendChild(this.makeLabel(t,"cv-select")),s.appendChild(a),void 0===r?this.page.appendChild(s):this.page.replaceChild(s,r),s},$u.prototype.addFileSelect=function(t,e,i,n){const r=this.frame,s=this.addSelect(t,e,i,n),a=s.firstChild,o="cv-"+r.getSeq();a.for=o,a.classList.add("cv-file-label");const h=document.createElement("input");return h.id=o,h.classList.add("cv-file"),h.type="file",h.accept=".svx,.lox,.plt",h.multiple=!0,this.addListener(h,"change",(function(){const t=h.files.length,e=[];if(t>0){for(var r=0;r<t;r++)e.push(h.files[r]);i[n]=e}})),a.appendChild(h),s},$u.prototype.addCheckbox=function(t,e,i){const n=this.frame,r=document.createElement("input"),s=document.createElement("div"),a="cv-"+n.getSeq();return s.classList.add("control"),r.type="checkbox",r.checked=e[i],r.id=a,this.addListener(r,"change",(function(t){n.inHandler=!0,e[i]=t.target.checked,n.inHandler=!1})),n.controls[i]=r,s.appendChild(r),s.appendChild(this.makeLabel(t,"check",a)),this.page.appendChild(s),s},$u.prototype.addRange=function(t,e,i){const n=this.frame,r=document.createElement("div"),s=document.createElement("input");return r.classList.add("control"),s.type="range",s.min=0,s.max=1,s.step=.05,s.value=e[i],this.addListener(s,"input",a),this.addListener(s,"change",a),n.controls[i]=s,r.appendChild(this.makeLabel(t,"cv-range")),r.appendChild(s),this.page.appendChild(r),r;function a(t){n.inHandler=!0,e[i]=t.target.value,n.inHandler=!1}},$u.prototype.addSlide=function(t,e){const i=document.createElement("div");return i.classList.add("slide"),i.style.zIndex=200-e,i.appendChild(t),this.page.appendChild(i),this.slide=i,this.slideDepth=e,i},$u.prototype.replaceSlide=function(t,e){const i=document.createElement("div"),n=this.page;var r=this.slide;return i.classList.add("slide"),i.style.zIndex=200-e,e<this.slideDepth&&i.classList.add("slide-out"),i.appendChild(t),n.appendChild(i),e>this.slideDepth?(r.addEventListener("transitionend",(function t(){r.removeEventListener("transitionend",t),n.removeChild(r),r=null})),r.classList.add("slide-out"),r.clientHeight):e<this.slideDepth?(i.addEventListener("transitionend",(function t(){n.removeChild(r),i.removeEventListener("transitionend",t),r=null})),i.clientHeight,i.classList.remove("slide-out")):n.removeChild(r),this.slide=i,this.slideDepth=e,i},$u.prototype.addButton=function(t,e){const i=document.createElement("button");return i.type="button",i.textContent=this.i18n(t),this.addListener(i,"click",e),this.page.appendChild(i),i},$u.prototype.addTextBox=function(t,e,i){const n=document.createElement("div"),r=document.createElement("input");var s;return r.type="text",r.placeholder=e,n.appendChild(this.makeLabel(t,"text")),n.appendChild(r),this.page.appendChild(n),this.addListener(r,"change",(function(t){return s=t.target.value,!0})),i((function(){return r.value="",s})),n},$u.prototype.addDownloadButton=function(t,e,i){const n=document.createElement("a");return void 0===n.download?null:(this.addListener(n,"click",(function(){n.href=e(n)})),n.textContent=this.i18n(t),n.type="download",n.download=i,n.href="javascript:void();",n.classList.add("download"),this.page.appendChild(n),n)},$u.canDownload=function(){return void 0!==document.createElement("a").download},$u.prototype.download=function(t,e){const i=document.createElement("a");if(void 0===i.download)return null;i.type="download",i.download=e,i.href=t,i.click()},$u.prototype.addColor=function(t,e){const i=this.frame,n=document.createElement("input"),r=document.createElement("div"),s=i.ctx.cfg,a="cv-"+i.getSeq();return r.classList.add("control"),n.type="color",n.value=s.themeColorHex(e),n.id=a,this.addListener(n,"change",(function(t){i.inHandler=!0,s.setThemeColorCSS(e,t.target.value),i.inHandler=!1})),i.controls[e]=n,r.appendChild(n),r.appendChild(this.makeLabel(t,"color",a)),this.page.appendChild(r),this.addListener(s,"colors",(t=>{"all"===t.name&&(n.value=s.themeColorHex(e))})),r},$u.prototype.addLogo=function(){const t=document.createElement("div");t.classList.add("logo"),t.title="logo",this.appendChild(t)},$u.prototype.dispose=function(){this._dispose&&this._dispose()},td.prototype=Object.create($u.prototype),ed.prototype=Object.create($u.prototype),id.prototype=Object.create($u.prototype),nd.prototype=Object.create(id.prototype),rd.prototype=Object.create(id.prototype);const sd={"shading.height":1,"shading.length":2,"shading.inclination":3,"shading.height_cursor":4,"shading.fixed":5,"shading.survey":6,"shading.route":r,"shading.distance":a},ad={"view.viewpoints.none":0,"view.viewpoints.plan":1,"view.viewpoints.elevation_n":2,"view.viewpoints.elevation_s":3,"view.viewpoints.elevation_e":4,"view.viewpoints.elevation_w":5},od={"view.camera.orthographic":1,"view.camera.perspective":2,"view.camera.anaglyph":3};function hd(t,e,i){$u.call(this,"icon_settings","settings"),t.addPage(this);const n=[],a=[],o=e.ctx.cfg,h=Object.assign({},sd),l=e.routeNames;e.hasRealTerrain&&(h["shading.depth"]=9,h["shading.depth_cursor"]=s),this.addHeader("survey.header"),i.fileCount>1?this.addFileSelect("survey.caption",i.fileList,i,"file"):this.addLine(i.selectedFile);const c=this.addCollapsingHeader("view.header");c.appendChild(this.addSelect("view.camera.caption",od,e,"cameraType")),c.appendChild(this.addSelect("view.viewpoints.caption",ad,e,"view")),c.appendChild(this.addRange("view.vertical_scaling",e,"zScale")),c.appendChild(this.addCheckbox("view.autorotate",e,"autoRotate")),c.appendChild(this.addRange("view.rotation_speed",e,"autoRotateSpeed"));this.addCollapsingHeader("shading.header").appendChild(this.addSelect("shading.caption",h,e,"shadingMode")),0!==l.length?(e.route||(e.route=l[0]),a.push(this.addSelect("selected_route",l,e,"route"))):a.push(this.addText(this.i18n("no_routes")));const u=this.addCollapsingHeader("visibility.header");e.hasLegs&&u.appendChild(this.addCheckbox("visibility.legs",e,"legs")),e.hasEntrances&&u.appendChild(this.addCheckbox("visibility.entrances",e,"entrances")),e.hasEntrances&&u.appendChild(this.addCheckbox("visibility.entrance_dots",e,"entrance_dots")),e.hasStations&&u.appendChild(this.addCheckbox("visibility.stations",e,"stations")),e.hasStationLabels&&u.appendChild(this.addCheckbox("visibility.labels",e,"stationLabels")),e.hasStationComments&&u.appendChild(this.addCheckbox("visibility.comments",e,"stationComments")),e.hasSplays&&u.appendChild(this.addCheckbox("visibility.splays",e,"splays")),e.hasWalls&&u.appendChild(this.addCheckbox("visibility.walls",e,"walls")),e.hasScraps&&u.appendChild(this.addCheckbox("visibility.scraps",e,"scraps")),e.hasTraces&&u.appendChild(this.addCheckbox("visibility.traces",e,"traces")),u.appendChild(this.addCheckbox("visibility.fog",e,"fog")),u.appendChild(this.addCheckbox("visibility.hud",e,"HUD")),u.appendChild(this.addCheckbox("visibility.box",e,"box")),e.hasWarnings&&u.appendChild(this.addCheckbox("visibility.warnings",e,"warnings"));const d=this.addCollapsingHeader("controls.header");d.appendChild(this.addCheckbox("controls.svx_control_mode",e,"svxControlMode")),d.appendChild(this.addCheckbox("controls.zoom_to_cursor",e,"zoomToCursor")),d.appendChild(this.addCheckbox("ui.selection_tree",o,"selectionTree"));const p=this.addCollapsingHeader("colors.header");return p.appendChild(this.addColor("colors.background_color","background")),p.appendChild(this.addColor("colors.entrance_text","stations.entrances.text")),p.appendChild(this.addColor("colors.entrance_background","stations.entrances.background")),p.appendChild(this.addColor("colors.entrance_marker","stations.entrances.marker")),p.appendChild(this.addColor("colors.bounding_box","box.bounding")),p.appendChild(this.addColor("colors.legs_fixed","shading.single")),p.appendChild(this.addColor("colors.surface_fixed","shading.surface")),p.appendChild(this.addColor("colors.hud_text","hud.text")),p.appendChild(this.addButton("colors.defaults",o.resetColors.bind(o))),e.svxControlMode&&d.appendChild(this.addCheckbox("controls.wheel_tilt",e,"wheelTilt")),f({name:"cameraType"}),f({name:"shadingMode"}),this.onChange=f,this;function f(i){"shadingMode"===i.name&&t.setControlsVisibility(a,e.shadingMode===r),"cameraType"===i.name&&t.setControlsVisibility(n,3===e.cameraType)}}hd.prototype=Object.create($u.prototype);const ld={"surface.shading.height":1,"surface.shading.inclination":3,"surface.shading.height_cursor":4,"surface.shading.fixed":17};function cd(t,e){const i=[];if($u.call(this,"icon_terrain","surface"),t.addPage(this),this.addHeader("surface.header"),e.hasSurfaceLegs&&(this.addCheckbox("surface.legs",e,"surfaceLegs"),this.addSelect("surface.shading.caption",ld,e,"surfaceShading")),e.hasTerrain){this.addHeader("terrain.header"),this.addCheckbox("terrain.terrain",e,"terrain"),i.push(this.addSelect("terrain.shading.caption",e.terrainShadingModes,e,"terrainShading")),i.push(this.addRange("terrain.opacity",e,"terrainOpacity")),i.push(this.addCheckbox("terrain.datum_shift",e,"terrainDatumShift")),i.push(this.addCheckbox("terrain.lighting",e,"terrainDirectionalLighting")),e.hasRealTerrain||i.push(this.addDownloadButton("terrain.downloadTileSet",e.terrainTileSet,"tileSetEntry.json"));const t=e.terrainAttributions;for(var n=0;n<t.length;n++)this.addText(t[n])}return r({name:"terrain"}),this.onChange=r,this;function r(n){"terrain"===n.name&&t.setControlsVisibility(i,e.terrain)}}function ud(t){this.page=t,this.elements=[],this.dynamic=[],this.onShow=function(){this.dynamic.forEach((function(t){t.parentElement.removeChild(t)})),this.dynamic=[]}}function dd(t,e,i){ud.call(this,t);const n=this,r=e.getMetadata(),s=e.routeNames;this.add(t.addHeader("route.header"));var a,o=t.addSelect("route.current",s,e,"route");this.add(o),this.add(t.addButton("route.save",(function(){}))),this.add(t.addTextBox("route.new","---",(function(t){a=t}))),this.add(t.addButton("route.add",(function(){console.log(a),o=n.addSelect("Current Route",e.routeNames,e,"route",o)}))),this.add(t.addDownloadButton("route.download",r.getURL,Va(i.file,"json")))}function pd(t,e){ud.call(this,t);const i=this;t.addListener(e,"selectedTrace",(function(e){void 0!==e.add?function(e){s(),void 0!==e.start&&(n.textContent="Start: "+e.start);void 0!==e.end&&(r.textContent="End: "+e.end,i.addDynamic(t.addButton("trace.add",(function(){e.add(),s()}))))}(e):void 0!==e.delete&&function(e){const a=e.trace;s(),n.textContent="Start: "+a.start,r.textContent="End: "+a.end,i.addDynamic(t.addButton("trace.delete",(function(){e.delete(),s()})))}(e)})),this.add(t.addHeader("trace.header"));var n=this.add(t.addLine("Start:")),r=this.add(t.addLine("End:"));function s(){i.onShow(),n.textContent="Start:",r.textContent="End:"}}cd.prototype=Object.create($u.prototype),ud.prototype.add=function(t){return this.elements.push(t),t},ud.prototype.addDynamic=function(t){return this.dynamic.push(t),t},ud.prototype.setVisibility=function(t){const e=this.page.frame;e.setControlsVisibility(this.elements,t),e.setControlsVisibility(this.dynamic,t),t&&null!==this.onShow&&this.onShow()},dd.prototype=Object.create(ud.prototype),pd.prototype=Object.create(ud.prototype);const fd={"modes.none":0,"modes.route":1,"modes.trace":3};function md(t,e,i){$u.call(this,"icon_route","edit",(function(){a={shadingMode:e.shadingMode,stations:e.stations,traces:e.traces},l({type:"change",name:"editMode"})}),(function(){e.setView(a)})),t.addPage(this);const n=this,s=[];var a,o=null,h=null;return this.addSelect("mode",fd,e,"editMode"),s.push(this.addText(this.i18n("intro"))),this.onChange=l,this;function l(l){if("editMode"===l.name){const l=Object.assign({},a);switch(e.editMode){case 3:null===h&&(h=new pd(n,e)),l.traces=!0;break;case 1:null===o&&(o=new dd(n,e,i)),l.shadingMode=r}e.setView(l),t.setControlsVisibility(s,0===e.editMode),null!==o&&o.setVisibility(1===e.editMode),null!==h&&h.setVisibility(3===e.editMode)}}}function gd(t,e){var i=e.getElementsByClassName("cv-gps-button");if(0!=i.length&&e.removeChild(i[0]),t.hasLocation){var n=document.createElement("div");n.classList.add("cv-gps-button"),n.addEventListener("click",(function(){t.trackLocation?n.classList.remove("on"):n.classList.add("on"),t.trackLocation=!t.trackLocation})),e.appendChild(n),this.dispose=function(){e.removeChild(n)}}}function vd(t,e,i){function n(n){n.preventDefault(),t.surveyLoaded&&t.mouseOver&&(function(e){if(e.ctrlKey)return!1;var i=!0;if(e.altKey)switch(e.key){case"s":t.svxControlMode=!t.svxControlMode;break;case"f":t.flatShading=!t.flatShading;break;case"x":t.zoomToCursor=!t.zoomToCursor;break;default:i=!1}else switch(e.key){case"0":t.shadingMode=a;break;case"1":t.shadingMode=1;break;case"2":t.shadingMode=3;break;case"3":t.shadingMode=2;break;case"4":t.shadingMode=4;break;case"5":t.shadingMode=5;break;case"6":t.shadingMode=6;break;case"7":t.shadingMode=r;break;case"8":t.shadingMode=9;break;case"9":t.shadingMode=s;break;case"f":t.fullscreen=!t.fullscreen;break;case"j":t.hasStationLabels&&(t.stationLabels=!t.stationLabels);break;case"o":t.cameraType=1;break;case"q":t.hasSplays&&(t.splays=!t.splays);break;case"t":t.hasTerrain&&(t.terrain=!t.terrain);break;case"+":t.cursorHeight++;break;case"-":t.cursorHeight--;break;case"<":t.hasTerrain&&(t.terrainOpacity=Math.max(t.terrainOpacity-.05,0));break;case">":t.hasTerrain&&(t.terrainOpacity=Math.min(t.terrainOpacity+.05,1));break;case"(":t.focalLength=Math.max(10,t.focalLength-10);break;case")":t.focalLength=Math.min(300,t.focalLength+10);break;default:i=!1}return i}(n)||(i?function(e){if(e.ctrlKey)switch(e.key){case"b":t.box=!t.box;break;case"e":t.wheelTilt=!t.wheelTilt;break;case"f":t.hasSurfaceLegs&&(t.surfaceLegs=!t.surfaceLegs);break;case"l":t.hasLegs&&(t.legs=!t.legs);break;case"n":t.hasStationLabels&&(t.stationLabels=!t.stationLabels);break;case"x":t.stations=!t.stations}else switch(e.key){case"Delete":t.reset=!0;break;case"Enter":t.autoRotate=!0;break;case" ":t.autoRotate=!t.autoRotate;break;case"l":t.polarAngle=Math.PI/2;break;case"e":t.azimuthAngle=3*Math.PI/2;break;case"n":t.azimuthAngle=0;break;case"p":t.polarAngle=0;break;case"r":t.autoRotateSpeed*=-1;break;case"s":t.azimuthAngle=Math.PI;break;case"w":t.azimuthAngle=Math.PI/2;break;case"x":t.autoRotateSpeed-=.1;break;case"z":t.autoRotateSpeed+=.1}}(n):function(i){if(i.ctrlKey)return;switch(i.key){case"c":t.hasScraps&&(t.scraps=!t.scraps);break;case"d":t.hasTraces&&(t.traces=!t.traces);break;case"f":t.fullscreen=!t.fullscreen;break;case"j":t.hasStationLabels&&(t.stationLabels=!t.stationLabels);break;case"l":t.hasEntrances&&(t.entrances=!t.entrances);break;case"n":e.nextFile();break;case"o":t.cameraType=1;break;case"p":t.cameraType=2;break;case"q":t.hasSplays&&(t.splays=!t.splays);break;case"r":t.view=1;break;case"s":t.hasSurfaceLegs&&(t.surfaceLegs=!t.surfaceLegs);break;case"t":t.hasTerrain&&(t.terrain=!t.terrain);break;case"v":$u.clear(),t.cut=!0;break;case"w":t.hasWalls&&(t.walls=!t.walls);break;case"x":t.setPOI=!0;break;case"z":t.stations=!t.stations;break;case"]":t.cursorHeight++;break;case"[":t.cursorHeight--}}(n)))}document.addEventListener("keydown",n),this.dispose=function(){document.removeEventListener("keydown",n)}}function yd(t,e){this.fileList=[],this.fileCount=0,this.currentIndex=1/0,this.loadedFile=null,this.isMultiple=!1,this.splash=null,this.localFilename=null;const i=this;function n(){const e=i.splash;t.classList.remove("cv-splash"),null!==e&&(e.parentNode.removeChild(e),i.splash=null)}function r(n){if(n.preventDefault(),null!==i.splash)return;const r=document.createElement("div");r.innerHTML=e.cfg.i18n("dnd.splash_text")||"dnd.splash_text",r.id="cv-splash",t.appendChild(r),t.classList.add("cv-splash"),i.splash=r}function s(t){t.preventDefault(),t.dataTransfer.dropEffect="copy"}function a(e){e.preventDefault(),e.relatedTarget===t.parentNode&&n()}function o(t){n();const e=t.dataTransfer;t.preventDefault();const r=e.files.length,s=[];if(r>0){for(var a=0;a<r;a++)s.push(e.files[a]);i.selectFile(s,null)}}t.addEventListener("drop",o),t.addEventListener("dragenter",r),t.addEventListener("dragover",s),t.addEventListener("dragleave",a),Object.defineProperty(this,"file",{get:function(){return this.selectedFile},set:this.selectFile}),this.dispose=function(){t.removeEventListener("drop",o),t.removeEventListener("dragover",s),t.removeEventListener("dragleave",a),t.removeEventListener("dragenter",r)}}function xd(t,e,i){$u.call(this,"icon_export","exports"),t.addPage(this),this.addHeader("png_export.header");const n=[];let r=e.maxSnapshotSize;do{n.push(r)}while((r/=2)>512);const s={exportSize:n[0],lineScale:1};this.addSelect("png_export.line_scale",[1,2,3,4,5,6],s,"lineScale"),this.addSelect("png_export.size",n,s,"exportSize"),this.addDownloadButton("png_export.export",(()=>e.getSnapshot(s.exportSize,s.lineScale)),"snapshot.png"),this.addHeader("gltf_export.header");const a={legs:!1,walls:!1,scraps:!1},o={rotate:!1,binary:!1};e.hasWalls&&(a.walls=!0,this.addCheckbox("gltf_export.walls",a,"walls")),e.hasScraps&&(a.scraps=!0,this.addCheckbox("gltf_export.scraps",a,"scraps")),this.addCheckbox("gltf_export.legs",a,"legs"),this.addCheckbox("gltf_export.rotate_axes",o,"rotate"),this.addButton("gltf_export.export",(function(){e.getGLTFExport(a,o,l)}));const h=this;return this;function l(t,e){var n=Va(i.localFilename,e?"glb":"gltf");h.download(URL.createObjectURL(t),n)}}function _d(t){const e=t.ctx,i=t.container,n=new Ku(e),r=e.cfg,s=new yd(i,e);s.addEventListener("selected",(function(e){n.clear(),t.clearView(),Array.isArray(e.file)?t.loadCaves(e.file):t.loadCave(e.file,e.section)})),r.setPropertyValue("selectionTree",!0),t.addEventListener("change",n.handleChange.bind(n)),t.addEventListener("newCave",h),r.addEventListener("change",h);const a=new vd(t,s,r.value("avenControls",!0));var o;function h(){t.surveyLoaded&&(n.clear(),new hd(n,t,s),(t.hasSurfaceLegs||t.hasTerrain)&&new cd(n,t),r.selectionTree?new rd(n,t,i,s):new nd(n,t,i,s),r.value("showEditPage",!1)&&!s.isMultiple&&new md(n,t,s),r.value("showExportPage",!1)&&$u.canDownload()&&new xd(n,t,s),new ed(n,t,s),new td(n,t.svxControlMode),n.setParent(i),n.addFullscreenButton("fullscreen",t,"fullscreen"),o=new gd(t,i))}this.loadCaveList=function(t){s.addList(t),s.nextFile()},this.loadCave=function(t,e){s.selectFile(t,e)},this.loadCaves=function(e){t.clearView(),t.loadCaves(e)},this.clearView=function(){n.clear(),t.clearView()},this.dispose=function(){n.clear(),t.clearView(),s.dispose(),o.dispose(),a.dispose(),t.dispose()}}md.prototype=Object.create($u.prototype),yd.prototype=Object.create(u.prototype),yd.prototype.addList=function(t){this.fileList=t,this.fileCount=t.length},yd.prototype.nextFile=function(){const t=this.fileList;if(0===this.fileCount)return!1;++this.currentIndex>=this.fileCount&&(this.currentIndex=0),this.selectFile(t[this.currentIndex])},yd.prototype.selectFile=function(t,e){Array.isArray(t)?1===t.length?(this.localFilename=t[0].name,this.selectedFile=t[0],this.isMultiple=!1):(this.selectedFile="[multiple]",this.localFilename="multiple",this.isMultiple=!0):(this.selectedFile=t,this.localFilename=t),this.loadedFile=t,this.dispatchEvent({type:"selected",file:t,section:e})},yd.prototype.reload=function(){this.selectFile(this.loadedFile)},xd.prototype=Object.create($u.prototype);var Md={init:function(t,e){CV.Viewer.init(t,e);var i=new _d(CV.Viewer);CV.UI=i}};t.CAMERA_ANAGLYPH=3,t.CAMERA_NONE=0,t.CAMERA_OFFSET=600,t.CAMERA_ORTHOGRAPHIC=1,t.CAMERA_PERSPECTIVE=2,t.CLUSTER_MARKERS=16,t.DIVING=3,t.FACE_SCRAPS=h,t.FACE_WALLS=o,t.FEATURE_BOX=4,t.FEATURE_ENTRANCES=6,t.FEATURE_ENTRANCE_DOTS=17,t.FEATURE_SELECTED_BOX=5,t.FEATURE_STATIONS=8,t.FEATURE_SURVEY=0,t.FEATURE_TERRAIN=7,t.FEATURE_TRACES=9,t.LABEL_STATION=l,t.LABEL_STATION_COMMENT=c,t.LEG_CAVE=1,t.LEG_SPLAY=2,t.LEG_SURFACE=3,t.MATERIAL_LINE=1,t.MATERIAL_SURFACE=2,t.MOUSE_MODE_DISTANCE=2,t.MOUSE_MODE_ENTRANCES=4,t.MOUSE_MODE_NORMAL=0,t.MOUSE_MODE_ROUTE_EDIT=1,t.MOUSE_MODE_TRACE_EDIT=3,t.NORMAL=0,t.SHADING_BECK=14,t.SHADING_CONTOURS=15,t.SHADING_CURSOR=4,t.SHADING_DEPTH=9,t.SHADING_DEPTH_CURSOR=s,t.SHADING_DISTANCE=a,t.SHADING_HEIGHT=1,t.SHADING_INCLINATION=3,t.SHADING_LENGTH=2,t.SHADING_LOCATION=16,t.SHADING_OVERLAY=7,t.SHADING_PATH=r,t.SHADING_RELIEF=8,t.SHADING_SHADED=8,t.SHADING_SINGLE=5,t.SHADING_SURFACE=17,t.SHADING_SURVEY=6,t.SPLAY=2,t.STATION_ENTRANCE=1,t.STATION_NORMAL=0,t.SURFACE=1,t.SURVEY_WARNINGS=14,t.TERRAIN_BASIC=0,t.TERRAIN_BLEND=2,t.TERRAIN_STENCIL=1,t.UI=Md,t.VERSION=n,t.VIEW_ELEVATION_E=4,t.VIEW_ELEVATION_N=2,t.VIEW_ELEVATION_S=3,t.VIEW_ELEVATION_W=5,t.VIEW_NONE=0,t.VIEW_PLAN=1,t.Viewer=Qu,t.WALL_DIAMOND=3,t.WALL_OVAL=1,t.WALL_SQUARE=2,Object.defineProperty(t,"__esModule",{value:!0})}));
