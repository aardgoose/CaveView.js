!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).CV2={})}(this,(function(t){"use strict";const e="2.2.0",i=10,n=11,r=13,s=11,a=12,o=13,l=15,h=19;class c{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}hasEventListener(t,e){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)}removeEventListener(t,e){if(void 0===this._listeners)return;const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}dispatchEvent(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const i=e.slice(0);for(let e=0,n=i.length;e<n;e++)i[e].call(this,t);t.target=null}}}const u=0,d=1,p=2,f=100,m=301,g=302,v=306,y=1e3,x=1001,_=1002,M=1003,b=1006,S=1008,w=1009,E=1012,T=1014,C=1015,L=1016,A=1020,R=1022,P=1023,D=1026,N=1027,I=3e3,F=3001,O=3007,z=3002,U=7680,B=7682,k=35044,G="300 es",H=[];for(let t=0;t<256;t++)H[t]=(t<16?"0":"")+t.toString(16);const V=Math.PI/180,W=180/Math.PI;function j(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(H[255&t]+H[t>>8&255]+H[t>>16&255]+H[t>>24&255]+"-"+H[255&e]+H[e>>8&255]+"-"+H[e>>16&15|64]+H[e>>24&255]+"-"+H[63&i|128]+H[i>>8&255]+"-"+H[i>>16&255]+H[i>>24&255]+H[255&n]+H[n>>8&255]+H[n>>16&255]+H[n>>24&255]).toUpperCase()}function X(t,e,i){return Math.max(e,Math.min(i,t))}function q(t,e,i){return(1-i)*t+i*e}function Y(t){return t*V}function Z(t){return t*W}function J(t){return 0==(t&t-1)&&0!==t}function K(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}class Q{constructor(t=0,e=0){this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this)}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this)}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,i=this.y,n=t.elements;return this.x=n[0]*e+n[3]*i+n[6],this.y=n[1]*e+n[4]*i+n[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y;return e*e+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const i=Math.cos(e),n=Math.sin(e),r=this.x-t.x,s=this.y-t.y;return this.x=r*i-s*n+t.x,this.y=r*n+s*i+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}}Q.prototype.isVector2=!0;class ${constructor(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(t,e,i,n,r,s,a,o,l){const h=this.elements;return h[0]=t,h[1]=n,h[2]=a,h[3]=e,h[4]=r,h[5]=o,h[6]=i,h[7]=s,h[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],this}extractBasis(t,e,i){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,r=this.elements,s=i[0],a=i[3],o=i[6],l=i[1],h=i[4],c=i[7],u=i[2],d=i[5],p=i[8],f=n[0],m=n[3],g=n[6],v=n[1],y=n[4],x=n[7],_=n[2],M=n[5],b=n[8];return r[0]=s*f+a*v+o*_,r[3]=s*m+a*y+o*M,r[6]=s*g+a*x+o*b,r[1]=l*f+h*v+c*_,r[4]=l*m+h*y+c*M,r[7]=l*g+h*x+c*b,r[2]=u*f+d*v+p*_,r[5]=u*m+d*y+p*M,r[8]=u*g+d*x+p*b,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],a=t[5],o=t[6],l=t[7],h=t[8];return e*s*h-e*a*l-i*r*h+i*a*o+n*r*l-n*s*o}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],a=t[5],o=t[6],l=t[7],h=t[8],c=h*s-a*l,u=a*o-h*r,d=l*r-s*o,p=e*c+i*u+n*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const f=1/p;return t[0]=c*f,t[1]=(n*l-h*i)*f,t[2]=(a*i-n*s)*f,t[3]=u*f,t[4]=(h*e-n*o)*f,t[5]=(n*r-a*e)*f,t[6]=d*f,t[7]=(i*o-l*e)*f,t[8]=(s*e-i*r)*f,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,i,n,r,s,a){const o=Math.cos(r),l=Math.sin(r);return this.set(i*o,i*l,-i*(o*s+l*a)+s+t,-n*l,n*o,-n*(-l*s+o*a)+a+e,0,0,1),this}scale(t,e){const i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=e,i[4]*=e,i[7]*=e,this}rotate(t){const e=Math.cos(t),i=Math.sin(t),n=this.elements,r=n[0],s=n[3],a=n[6],o=n[1],l=n[4],h=n[7];return n[0]=e*r+i*o,n[3]=e*s+i*l,n[6]=e*a+i*h,n[1]=-i*r+e*o,n[4]=-i*s+e*l,n[7]=-i*a+e*h,this}translate(t,e){const i=this.elements;return i[0]+=t*i[2],i[3]+=t*i[5],i[6]+=t*i[8],i[1]+=e*i[2],i[4]+=e*i[5],i[7]+=e*i[8],this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<9;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<9;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}let tt;$.prototype.isMatrix3=!0;let et=0;class it extends c{constructor(t=it.DEFAULT_IMAGE,e=it.DEFAULT_MAPPING,i=1001,n=1001,r=1006,s=1008,a=1023,o=1009,l=1,h=3e3){super(),Object.defineProperty(this,"id",{value:et++}),this.uuid=j(),this.name="",this.image=t,this.mipmaps=[],this.mapping=e,this.wrapS=i,this.wrapT=n,this.magFilter=r,this.minFilter=s,this.anisotropy=l,this.format=a,this.internalFormat=null,this.type=o,this.offset=new Q(0,0),this.repeat=new Q(1,1),this.center=new Q(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new $,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=h,this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(t){return this.name=t.name,this.image=t.image,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.encoding=t.encoding,this}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const i={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(void 0!==this.image){const n=this.image;if(void 0===n.uuid&&(n.uuid=j()),!e&&void 0===t.images[n.uuid]){let e;if(Array.isArray(n)){e=[];for(let t=0,i=n.length;t<i;t++)n[t].isDataTexture?e.push(nt(n[t].image)):e.push(nt(n[t]))}else e=nt(n);t.images[n.uuid]={uuid:n.uuid,url:e}}i.image=n.uuid}return e||(t.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(300!==this.mapping)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case y:t.x=t.x-Math.floor(t.x);break;case x:t.x=t.x<0?0:1;break;case _:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case y:t.y=t.y-Math.floor(t.y);break;case x:t.y=t.y<0?0:1;break;case _:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){!0===t&&this.version++}}function nt(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?class{static getDataURL(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{void 0===tt&&(tt=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),tt.width=t.width,tt.height=t.height;const i=tt.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):i.drawImage(t,0,0,t.width,t.height),e=tt}return e.width>2048||e.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",t),e.toDataURL("image/jpeg",.6)):e.toDataURL("image/png")}}.getDataURL(t):t.data?{data:Array.prototype.slice.call(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}it.DEFAULT_IMAGE=void 0,it.DEFAULT_MAPPING=300,it.prototype.isTexture=!0;class rt{constructor(t=0,e=0,i=0,n=1){this.x=t,this.y=e,this.z=i,this.w=n}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,r=this.w,s=t.elements;return this.x=s[0]*e+s[4]*i+s[8]*n+s[12]*r,this.y=s[1]*e+s[5]*i+s[9]*n+s[13]*r,this.z=s[2]*e+s[6]*i+s[10]*n+s[14]*r,this.w=s[3]*e+s[7]*i+s[11]*n+s[15]*r,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,i,n,r;const s=.01,a=.1,o=t.elements,l=o[0],h=o[4],c=o[8],u=o[1],d=o[5],p=o[9],f=o[2],m=o[6],g=o[10];if(Math.abs(h-u)<s&&Math.abs(c-f)<s&&Math.abs(p-m)<s){if(Math.abs(h+u)<a&&Math.abs(c+f)<a&&Math.abs(p+m)<a&&Math.abs(l+d+g-3)<a)return this.set(1,0,0,0),this;e=Math.PI;const t=(l+1)/2,o=(d+1)/2,v=(g+1)/2,y=(h+u)/4,x=(c+f)/4,_=(p+m)/4;return t>o&&t>v?t<s?(i=0,n=.707106781,r=.707106781):(i=Math.sqrt(t),n=y/i,r=x/i):o>v?o<s?(i=.707106781,n=0,r=.707106781):(n=Math.sqrt(o),i=y/n,r=_/n):v<s?(i=.707106781,n=.707106781,r=0):(r=Math.sqrt(v),i=x/r,n=_/r),this.set(i,n,r,e),this}let v=Math.sqrt((m-p)*(m-p)+(c-f)*(c-f)+(u-h)*(u-h));return Math.abs(v)<.001&&(v=1),this.x=(m-p)/v,this.y=(c-f)/v,this.z=(u-h)/v,this.w=Math.acos((l+d+g-1)/2),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this.w=Math.max(t,Math.min(e,this.w)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this.w=t.w+(e.w-t.w)*i,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}}rt.prototype.isVector4=!0;class st extends c{constructor(t,e,i={}){super(),this.width=t,this.height=e,this.depth=1,this.scissor=new rt(0,0,t,e),this.scissorTest=!1,this.viewport=new rt(0,0,t,e),this.texture=new it(void 0,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.texture.isRenderTargetTexture=!0,this.texture.image={width:t,height:e,depth:1},this.texture.generateMipmaps=void 0!==i.generateMipmaps&&i.generateMipmaps,this.texture.minFilter=void 0!==i.minFilter?i.minFilter:b,this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0!==i.stencilBuffer&&i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null}setTexture(t){t.image={width:this.width,height:this.height,depth:this.depth},this.texture=t}setSize(t,e,i=1){this.width===t&&this.height===e&&this.depth===i||(this.width=t,this.height=e,this.depth=i,this.texture.image.width=t,this.texture.image.height=e,this.texture.image.depth=i,this.dispose()),this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this.viewport.copy(t.viewport),this.texture=t.texture.clone(),this.texture.image={...this.texture.image},this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,this.depthTexture=t.depthTexture,this}dispose(){this.dispatchEvent({type:"dispose"})}}st.prototype.isWebGLRenderTarget=!0;class at{constructor(t=0,e=0,i=0,n=1){this._x=t,this._y=e,this._z=i,this._w=n}static slerp(t,e,i,n){return console.warn("THREE.Quaternion: Static .slerp() has been deprecated. Use qm.slerpQuaternions( qa, qb, t ) instead."),i.slerpQuaternions(t,e,n)}static slerpFlat(t,e,i,n,r,s,a){let o=i[n+0],l=i[n+1],h=i[n+2],c=i[n+3];const u=r[s+0],d=r[s+1],p=r[s+2],f=r[s+3];if(0===a)return t[e+0]=o,t[e+1]=l,t[e+2]=h,void(t[e+3]=c);if(1===a)return t[e+0]=u,t[e+1]=d,t[e+2]=p,void(t[e+3]=f);if(c!==f||o!==u||l!==d||h!==p){let t=1-a;const e=o*u+l*d+h*p+c*f,i=e>=0?1:-1,n=1-e*e;if(n>Number.EPSILON){const r=Math.sqrt(n),s=Math.atan2(r,e*i);t=Math.sin(t*s)/r,a=Math.sin(a*s)/r}const r=a*i;if(o=o*t+u*r,l=l*t+d*r,h=h*t+p*r,c=c*t+f*r,t===1-a){const t=1/Math.sqrt(o*o+l*l+h*h+c*c);o*=t,l*=t,h*=t,c*=t}}t[e]=o,t[e+1]=l,t[e+2]=h,t[e+3]=c}static multiplyQuaternionsFlat(t,e,i,n,r,s){const a=i[n],o=i[n+1],l=i[n+2],h=i[n+3],c=r[s],u=r[s+1],d=r[s+2],p=r[s+3];return t[e]=a*p+h*c+o*d-l*u,t[e+1]=o*p+h*u+l*c-a*d,t[e+2]=l*p+h*d+a*u-o*c,t[e+3]=h*p-a*c-o*u-l*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e){if(!t||!t.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const i=t._x,n=t._y,r=t._z,s=t._order,a=Math.cos,o=Math.sin,l=a(i/2),h=a(n/2),c=a(r/2),u=o(i/2),d=o(n/2),p=o(r/2);switch(s){case"XYZ":this._x=u*h*c+l*d*p,this._y=l*d*c-u*h*p,this._z=l*h*p+u*d*c,this._w=l*h*c-u*d*p;break;case"YXZ":this._x=u*h*c+l*d*p,this._y=l*d*c-u*h*p,this._z=l*h*p-u*d*c,this._w=l*h*c+u*d*p;break;case"ZXY":this._x=u*h*c-l*d*p,this._y=l*d*c+u*h*p,this._z=l*h*p+u*d*c,this._w=l*h*c-u*d*p;break;case"ZYX":this._x=u*h*c-l*d*p,this._y=l*d*c+u*h*p,this._z=l*h*p-u*d*c,this._w=l*h*c+u*d*p;break;case"YZX":this._x=u*h*c+l*d*p,this._y=l*d*c+u*h*p,this._z=l*h*p-u*d*c,this._w=l*h*c-u*d*p;break;case"XZY":this._x=u*h*c-l*d*p,this._y=l*d*c-u*h*p,this._z=l*h*p+u*d*c,this._w=l*h*c+u*d*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!1!==e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const i=e/2,n=Math.sin(i);return this._x=t.x*n,this._y=t.y*n,this._z=t.z*n,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,i=e[0],n=e[4],r=e[8],s=e[1],a=e[5],o=e[9],l=e[2],h=e[6],c=e[10],u=i+a+c;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(h-o)*t,this._y=(r-l)*t,this._z=(s-n)*t}else if(i>a&&i>c){const t=2*Math.sqrt(1+i-a-c);this._w=(h-o)/t,this._x=.25*t,this._y=(n+s)/t,this._z=(r+l)/t}else if(a>c){const t=2*Math.sqrt(1+a-i-c);this._w=(r-l)/t,this._x=(n+s)/t,this._y=.25*t,this._z=(o+h)/t}else{const t=2*Math.sqrt(1+c-i-a);this._w=(s-n)/t,this._x=(r+l)/t,this._y=(o+h)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let i=t.dot(e)+1;return i<Number.EPSILON?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=i):(this._x=0,this._y=-t.z,this._z=t.y,this._w=i)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=i),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(X(this.dot(t),-1,1)))}rotateTowards(t,e){const i=this.angleTo(t);if(0===i)return this;const n=Math.min(1,e/i);return this.slerp(t,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const i=t._x,n=t._y,r=t._z,s=t._w,a=e._x,o=e._y,l=e._z,h=e._w;return this._x=i*h+s*a+n*l-r*o,this._y=n*h+s*o+r*a-i*l,this._z=r*h+s*l+i*o-n*a,this._w=s*h-i*a-n*o-r*l,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const i=this._x,n=this._y,r=this._z,s=this._w;let a=s*t._w+i*t._x+n*t._y+r*t._z;if(a<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,a=-a):this.copy(t),a>=1)return this._w=s,this._x=i,this._y=n,this._z=r,this;const o=1-a*a;if(o<=Number.EPSILON){const t=1-e;return this._w=t*s+e*this._w,this._x=t*i+e*this._x,this._y=t*n+e*this._y,this._z=t*r+e*this._z,this.normalize(),this._onChangeCallback(),this}const l=Math.sqrt(o),h=Math.atan2(l,a),c=Math.sin((1-e)*h)/l,u=Math.sin(e*h)/l;return this._w=s*c+this._w*u,this._x=i*c+this._x*u,this._y=n*c+this._y*u,this._z=r*c+this._z*u,this._onChangeCallback(),this}slerpQuaternions(t,e,i){this.copy(t).slerp(e,i)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}}at.prototype.isQuaternion=!0;class ot{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}set(t,e,i){return void 0===i&&(i=this.z),this.x=t,this.y=e,this.z=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(ht.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(ht.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,i=this.y,n=this.z,r=t.elements;return this.x=r[0]*e+r[3]*i+r[6]*n,this.y=r[1]*e+r[4]*i+r[7]*n,this.z=r[2]*e+r[5]*i+r[8]*n,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,r=t.elements,s=1/(r[3]*e+r[7]*i+r[11]*n+r[15]);return this.x=(r[0]*e+r[4]*i+r[8]*n+r[12])*s,this.y=(r[1]*e+r[5]*i+r[9]*n+r[13])*s,this.z=(r[2]*e+r[6]*i+r[10]*n+r[14])*s,this}applyQuaternion(t){const e=this.x,i=this.y,n=this.z,r=t.x,s=t.y,a=t.z,o=t.w,l=o*e+s*n-a*i,h=o*i+a*e-r*n,c=o*n+r*i-s*e,u=-r*e-s*i-a*n;return this.x=l*o+u*-r+h*-a-c*-s,this.y=h*o+u*-s+c*-r-l*-a,this.z=c*o+u*-a+l*-s-h*-r,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,i=this.y,n=this.z,r=t.elements;return this.x=r[0]*e+r[4]*i+r[8]*n,this.y=r[1]*e+r[5]*i+r[9]*n,this.z=r[2]*e+r[6]*i+r[10]*n,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this}cross(t,e){return void 0!==e?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)}crossVectors(t,e){const i=t.x,n=t.y,r=t.z,s=e.x,a=e.y,o=e.z;return this.x=n*o-r*a,this.y=r*s-i*o,this.z=i*a-n*s,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const i=t.dot(this)/e;return this.copy(t).multiplyScalar(i)}projectOnPlane(t){return lt.copy(this).projectOnVector(t),this.sub(lt)}reflect(t){return this.sub(lt.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;return Math.acos(X(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return e*e+i*i+n*n}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,i){const n=Math.sin(e)*t;return this.x=n*Math.sin(i),this.y=Math.cos(e)*t,this.z=n*Math.cos(i),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,i){return this.x=t*Math.sin(e),this.y=i,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),n=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=n,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}ot.prototype.isVector3=!0;const lt=new ot,ht=new at;class ct{constructor(t=new ot(1/0,1/0,1/0),e=new ot(-1/0,-1/0,-1/0)){this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){let e=1/0,i=1/0,n=1/0,r=-1/0,s=-1/0,a=-1/0;for(let o=0,l=t.length;o<l;o+=3){const l=t[o],h=t[o+1],c=t[o+2];l<e&&(e=l),h<i&&(i=h),c<n&&(n=c),l>r&&(r=l),h>s&&(s=h),c>a&&(a=c)}return this.min.set(e,i,n),this.max.set(r,s,a),this}setFromBufferAttribute(t){let e=1/0,i=1/0,n=1/0,r=-1/0,s=-1/0,a=-1/0;for(let o=0,l=t.count;o<l;o++){const l=t.getX(o),h=t.getY(o),c=t.getZ(o);l<e&&(e=l),h<i&&(i=h),c<n&&(n=c),l>r&&(r=l),h>s&&(s=h),c>a&&(a=c)}return this.min.set(e,i,n),this.max.set(r,s,a),this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=dt.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}setFromObject(t){return this.makeEmpty(),this.expandByObject(t)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t){t.updateWorldMatrix(!1,!1);const e=t.geometry;void 0!==e&&(null===e.boundingBox&&e.computeBoundingBox(),pt.copy(e.boundingBox),pt.applyMatrix4(t.matrixWorld),this.union(pt));const i=t.children;for(let t=0,e=i.length;t<e;t++)this.expandByObject(i[t]);return this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}intersectsSphere(t){return this.clampPoint(t.center,dt),dt.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,i;return t.normal.x>0?(e=t.normal.x*this.min.x,i=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,i=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,i+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,i+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,i+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,i+=t.normal.z*this.min.z),e<=-t.constant&&i>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(_t),Mt.subVectors(this.max,_t),ft.subVectors(t.a,_t),mt.subVectors(t.b,_t),gt.subVectors(t.c,_t),vt.subVectors(mt,ft),yt.subVectors(gt,mt),xt.subVectors(ft,gt);let e=[0,-vt.z,vt.y,0,-yt.z,yt.y,0,-xt.z,xt.y,vt.z,0,-vt.x,yt.z,0,-yt.x,xt.z,0,-xt.x,-vt.y,vt.x,0,-yt.y,yt.x,0,-xt.y,xt.x,0];return!!wt(e,ft,mt,gt,Mt)&&(e=[1,0,0,0,1,0,0,0,1],!!wt(e,ft,mt,gt,Mt)&&(bt.crossVectors(vt,yt),e=[bt.x,bt.y,bt.z],wt(e,ft,mt,gt,Mt)))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return dt.copy(t).clamp(this.min,this.max).sub(t).length()}getBoundingSphere(t){return this.getCenter(t.center),t.radius=.5*this.getSize(dt).length(),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(ut[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),ut[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),ut[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),ut[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),ut[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),ut[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),ut[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),ut[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(ut)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}ct.prototype.isBox3=!0;const ut=[new ot,new ot,new ot,new ot,new ot,new ot,new ot,new ot],dt=new ot,pt=new ct,ft=new ot,mt=new ot,gt=new ot,vt=new ot,yt=new ot,xt=new ot,_t=new ot,Mt=new ot,bt=new ot,St=new ot;function wt(t,e,i,n,r){for(let s=0,a=t.length-3;s<=a;s+=3){St.fromArray(t,s);const a=r.x*Math.abs(St.x)+r.y*Math.abs(St.y)+r.z*Math.abs(St.z),o=e.dot(St),l=i.dot(St),h=n.dot(St);if(Math.max(-Math.max(o,l,h),Math.min(o,l,h))>a)return!1}return!0}const Et=new ct,Tt=new ot,Ct=new ot,Lt=new ot;class At{constructor(t=new ot,e=-1){this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const i=this.center;void 0!==e?i.copy(e):Et.setFromPoints(t).getCenter(i);let n=0;for(let e=0,r=t.length;e<r;e++)n=Math.max(n,i.distanceToSquared(t[e]));return this.radius=Math.sqrt(n),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const i=this.center.distanceToSquared(t);return e.copy(t),i>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){Lt.subVectors(t,this.center);const e=Lt.lengthSq();if(e>this.radius*this.radius){const t=Math.sqrt(e),i=.5*(t-this.radius);this.center.add(Lt.multiplyScalar(i/t)),this.radius+=i}return this}union(t){return Ct.subVectors(t.center,this.center).normalize().multiplyScalar(t.radius),this.expandByPoint(Tt.copy(t.center).add(Ct)),this.expandByPoint(Tt.copy(t.center).sub(Ct)),this}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const Rt=new ot,Pt=new ot,Dt=new $;class Nt{constructor(t=new ot(1,0,0),e=0){this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,i,n){return this.normal.set(t,e,i),this.constant=n,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,i){const n=Rt.subVectors(i,e).cross(Pt.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(n,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(this.normal).multiplyScalar(-this.distanceToPoint(t)).add(t)}intersectLine(t,e){const i=t.delta(Rt),n=this.normal.dot(i);if(0===n)return 0===this.distanceToPoint(t.start)?e.copy(t.start):null;const r=-(t.start.dot(this.normal)+this.constant)/n;return r<0||r>1?null:e.copy(i).multiplyScalar(r).add(t.start)}intersectsLine(t){const e=this.distanceToPoint(t.start),i=this.distanceToPoint(t.end);return e<0&&i>0||i<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const i=e||Dt.getNormalMatrix(t),n=this.coplanarPoint(Rt).applyMatrix4(t),r=this.normal.applyMatrix3(i).normalize();return this.constant=-n.dot(r),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return(new this.constructor).copy(this)}}Nt.prototype.isPlane=!0;const It=new At,Ft=new ot;class Ot{constructor(t=new Nt,e=new Nt,i=new Nt,n=new Nt,r=new Nt,s=new Nt){this.planes=[t,e,i,n,r,s]}set(t,e,i,n,r,s){const a=this.planes;return a[0].copy(t),a[1].copy(e),a[2].copy(i),a[3].copy(n),a[4].copy(r),a[5].copy(s),this}copy(t){const e=this.planes;for(let i=0;i<6;i++)e[i].copy(t.planes[i]);return this}setFromProjectionMatrix(t){const e=this.planes,i=t.elements,n=i[0],r=i[1],s=i[2],a=i[3],o=i[4],l=i[5],h=i[6],c=i[7],u=i[8],d=i[9],p=i[10],f=i[11],m=i[12],g=i[13],v=i[14],y=i[15];return e[0].setComponents(a-n,c-o,f-u,y-m).normalize(),e[1].setComponents(a+n,c+o,f+u,y+m).normalize(),e[2].setComponents(a+r,c+l,f+d,y+g).normalize(),e[3].setComponents(a-r,c-l,f-d,y-g).normalize(),e[4].setComponents(a-s,c-h,f-p,y-v).normalize(),e[5].setComponents(a+s,c+h,f+p,y+v).normalize(),this}intersectsObject(t){const e=t.geometry;return null===e.boundingSphere&&e.computeBoundingSphere(),It.copy(e.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(It)}intersectsSprite(t){return It.center.set(0,0,0),It.radius=.7071067811865476,It.applyMatrix4(t.matrixWorld),this.intersectsSphere(It)}intersectsSphere(t){const e=this.planes,i=t.center,n=-t.radius;for(let t=0;t<6;t++){if(e[t].distanceToPoint(i)<n)return!1}return!0}intersectsBox(t){const e=this.planes;for(let i=0;i<6;i++){const n=e[i];if(Ft.x=n.normal.x>0?t.max.x:t.min.x,Ft.y=n.normal.y>0?t.max.y:t.min.y,Ft.z=n.normal.z>0?t.max.z:t.min.z,n.distanceToPoint(Ft)<0)return!1}return!0}containsPoint(t){const e=this.planes;for(let i=0;i<6;i++)if(e[i].distanceToPoint(t)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}class zt{constructor(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(t,e,i,n,r,s,a,o,l,h,c,u,d,p,f,m){const g=this.elements;return g[0]=t,g[4]=e,g[8]=i,g[12]=n,g[1]=r,g[5]=s,g[9]=a,g[13]=o,g[2]=l,g[6]=h,g[10]=c,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new zt).fromArray(this.elements)}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}copyPosition(t){const e=this.elements,i=t.elements;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,i=t.elements,n=1/Ut.setFromMatrixColumn(t,0).length(),r=1/Ut.setFromMatrixColumn(t,1).length(),s=1/Ut.setFromMatrixColumn(t,2).length();return e[0]=i[0]*n,e[1]=i[1]*n,e[2]=i[2]*n,e[3]=0,e[4]=i[4]*r,e[5]=i[5]*r,e[6]=i[6]*r,e[7]=0,e[8]=i[8]*s,e[9]=i[9]*s,e[10]=i[10]*s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){t&&t.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const e=this.elements,i=t.x,n=t.y,r=t.z,s=Math.cos(i),a=Math.sin(i),o=Math.cos(n),l=Math.sin(n),h=Math.cos(r),c=Math.sin(r);if("XYZ"===t.order){const t=s*h,i=s*c,n=a*h,r=a*c;e[0]=o*h,e[4]=-o*c,e[8]=l,e[1]=i+n*l,e[5]=t-r*l,e[9]=-a*o,e[2]=r-t*l,e[6]=n+i*l,e[10]=s*o}else if("YXZ"===t.order){const t=o*h,i=o*c,n=l*h,r=l*c;e[0]=t+r*a,e[4]=n*a-i,e[8]=s*l,e[1]=s*c,e[5]=s*h,e[9]=-a,e[2]=i*a-n,e[6]=r+t*a,e[10]=s*o}else if("ZXY"===t.order){const t=o*h,i=o*c,n=l*h,r=l*c;e[0]=t-r*a,e[4]=-s*c,e[8]=n+i*a,e[1]=i+n*a,e[5]=s*h,e[9]=r-t*a,e[2]=-s*l,e[6]=a,e[10]=s*o}else if("ZYX"===t.order){const t=s*h,i=s*c,n=a*h,r=a*c;e[0]=o*h,e[4]=n*l-i,e[8]=t*l+r,e[1]=o*c,e[5]=r*l+t,e[9]=i*l-n,e[2]=-l,e[6]=a*o,e[10]=s*o}else if("YZX"===t.order){const t=s*o,i=s*l,n=a*o,r=a*l;e[0]=o*h,e[4]=r-t*c,e[8]=n*c+i,e[1]=c,e[5]=s*h,e[9]=-a*h,e[2]=-l*h,e[6]=i*c+n,e[10]=t-r*c}else if("XZY"===t.order){const t=s*o,i=s*l,n=a*o,r=a*l;e[0]=o*h,e[4]=-c,e[8]=l*h,e[1]=t*c+r,e[5]=s*h,e[9]=i*c-n,e[2]=n*c-i,e[6]=a*h,e[10]=r*c+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(kt,t,Gt)}lookAt(t,e,i){const n=this.elements;return Wt.subVectors(t,e),0===Wt.lengthSq()&&(Wt.z=1),Wt.normalize(),Ht.crossVectors(i,Wt),0===Ht.lengthSq()&&(1===Math.abs(i.z)?Wt.x+=1e-4:Wt.z+=1e-4,Wt.normalize(),Ht.crossVectors(i,Wt)),Ht.normalize(),Vt.crossVectors(Wt,Ht),n[0]=Ht.x,n[4]=Vt.x,n[8]=Wt.x,n[1]=Ht.y,n[5]=Vt.y,n[9]=Wt.y,n[2]=Ht.z,n[6]=Vt.z,n[10]=Wt.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(t,e)):this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,r=this.elements,s=i[0],a=i[4],o=i[8],l=i[12],h=i[1],c=i[5],u=i[9],d=i[13],p=i[2],f=i[6],m=i[10],g=i[14],v=i[3],y=i[7],x=i[11],_=i[15],M=n[0],b=n[4],S=n[8],w=n[12],E=n[1],T=n[5],C=n[9],L=n[13],A=n[2],R=n[6],P=n[10],D=n[14],N=n[3],I=n[7],F=n[11],O=n[15];return r[0]=s*M+a*E+o*A+l*N,r[4]=s*b+a*T+o*R+l*I,r[8]=s*S+a*C+o*P+l*F,r[12]=s*w+a*L+o*D+l*O,r[1]=h*M+c*E+u*A+d*N,r[5]=h*b+c*T+u*R+d*I,r[9]=h*S+c*C+u*P+d*F,r[13]=h*w+c*L+u*D+d*O,r[2]=p*M+f*E+m*A+g*N,r[6]=p*b+f*T+m*R+g*I,r[10]=p*S+f*C+m*P+g*F,r[14]=p*w+f*L+m*D+g*O,r[3]=v*M+y*E+x*A+_*N,r[7]=v*b+y*T+x*R+_*I,r[11]=v*S+y*C+x*P+_*F,r[15]=v*w+y*L+x*D+_*O,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[4],n=t[8],r=t[12],s=t[1],a=t[5],o=t[9],l=t[13],h=t[2],c=t[6],u=t[10],d=t[14];return t[3]*(+r*o*c-n*l*c-r*a*u+i*l*u+n*a*d-i*o*d)+t[7]*(+e*o*d-e*l*u+r*s*u-n*s*d+n*l*h-r*o*h)+t[11]*(+e*l*c-e*a*d-r*s*c+i*s*d+r*a*h-i*l*h)+t[15]*(-n*a*h-e*o*c+e*a*u+n*s*c-i*s*u+i*o*h)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,i){const n=this.elements;return t.isVector3?(n[12]=t.x,n[13]=t.y,n[14]=t.z):(n[12]=t,n[13]=e,n[14]=i),this}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],a=t[5],o=t[6],l=t[7],h=t[8],c=t[9],u=t[10],d=t[11],p=t[12],f=t[13],m=t[14],g=t[15],v=c*m*l-f*u*l+f*o*d-a*m*d-c*o*g+a*u*g,y=p*u*l-h*m*l-p*o*d+s*m*d+h*o*g-s*u*g,x=h*f*l-p*c*l+p*a*d-s*f*d-h*a*g+s*c*g,_=p*c*o-h*f*o-p*a*u+s*f*u+h*a*m-s*c*m,M=e*v+i*y+n*x+r*_;if(0===M)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const b=1/M;return t[0]=v*b,t[1]=(f*u*r-c*m*r-f*n*d+i*m*d+c*n*g-i*u*g)*b,t[2]=(a*m*r-f*o*r+f*n*l-i*m*l-a*n*g+i*o*g)*b,t[3]=(c*o*r-a*u*r-c*n*l+i*u*l+a*n*d-i*o*d)*b,t[4]=y*b,t[5]=(h*m*r-p*u*r+p*n*d-e*m*d-h*n*g+e*u*g)*b,t[6]=(p*o*r-s*m*r-p*n*l+e*m*l+s*n*g-e*o*g)*b,t[7]=(s*u*r-h*o*r+h*n*l-e*u*l-s*n*d+e*o*d)*b,t[8]=x*b,t[9]=(p*c*r-h*f*r-p*i*d+e*f*d+h*i*g-e*c*g)*b,t[10]=(s*f*r-p*a*r+p*i*l-e*f*l-s*i*g+e*a*g)*b,t[11]=(h*a*r-s*c*r-h*i*l+e*c*l+s*i*d-e*a*d)*b,t[12]=_*b,t[13]=(h*f*n-p*c*n+p*i*u-e*f*u-h*i*m+e*c*m)*b,t[14]=(p*a*n-s*f*n-p*i*o+e*f*o+s*i*m-e*a*m)*b,t[15]=(s*c*n-h*a*n+h*i*o-e*c*o-s*i*u+e*a*u)*b,this}scale(t){const e=this.elements,i=t.x,n=t.y,r=t.z;return e[0]*=i,e[4]*=n,e[8]*=r,e[1]*=i,e[5]*=n,e[9]*=r,e[2]*=i,e[6]*=n,e[10]*=r,e[3]*=i,e[7]*=n,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],n=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,n))}makeTranslation(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const i=Math.cos(e),n=Math.sin(e),r=1-i,s=t.x,a=t.y,o=t.z,l=r*s,h=r*a;return this.set(l*s+i,l*a-n*o,l*o+n*a,0,l*a+n*o,h*a+i,h*o-n*s,0,l*o-n*a,h*o+n*s,r*o*o+i,0,0,0,0,1),this}makeScale(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}makeShear(t,e,i,n,r,s){return this.set(1,i,r,0,t,1,s,0,e,n,1,0,0,0,0,1),this}compose(t,e,i){const n=this.elements,r=e._x,s=e._y,a=e._z,o=e._w,l=r+r,h=s+s,c=a+a,u=r*l,d=r*h,p=r*c,f=s*h,m=s*c,g=a*c,v=o*l,y=o*h,x=o*c,_=i.x,M=i.y,b=i.z;return n[0]=(1-(f+g))*_,n[1]=(d+x)*_,n[2]=(p-y)*_,n[3]=0,n[4]=(d-x)*M,n[5]=(1-(u+g))*M,n[6]=(m+v)*M,n[7]=0,n[8]=(p+y)*b,n[9]=(m-v)*b,n[10]=(1-(u+f))*b,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,this}decompose(t,e,i){const n=this.elements;let r=Ut.set(n[0],n[1],n[2]).length();const s=Ut.set(n[4],n[5],n[6]).length(),a=Ut.set(n[8],n[9],n[10]).length();this.determinant()<0&&(r=-r),t.x=n[12],t.y=n[13],t.z=n[14],Bt.copy(this);const o=1/r,l=1/s,h=1/a;return Bt.elements[0]*=o,Bt.elements[1]*=o,Bt.elements[2]*=o,Bt.elements[4]*=l,Bt.elements[5]*=l,Bt.elements[6]*=l,Bt.elements[8]*=h,Bt.elements[9]*=h,Bt.elements[10]*=h,e.setFromRotationMatrix(Bt),i.x=r,i.y=s,i.z=a,this}makePerspective(t,e,i,n,r,s){void 0===s&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const a=this.elements,o=2*r/(e-t),l=2*r/(i-n),h=(e+t)/(e-t),c=(i+n)/(i-n),u=-(s+r)/(s-r),d=-2*s*r/(s-r);return a[0]=o,a[4]=0,a[8]=h,a[12]=0,a[1]=0,a[5]=l,a[9]=c,a[13]=0,a[2]=0,a[6]=0,a[10]=u,a[14]=d,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(t,e,i,n,r,s){const a=this.elements,o=1/(e-t),l=1/(i-n),h=1/(s-r),c=(e+t)*o,u=(i+n)*l,d=(s+r)*h;return a[0]=2*o,a[4]=0,a[8]=0,a[12]=-c,a[1]=0,a[5]=2*l,a[9]=0,a[13]=-u,a[2]=0,a[6]=0,a[10]=-2*h,a[14]=-d,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<16;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<16;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}zt.prototype.isMatrix4=!0;const Ut=new ot,Bt=new zt,kt=new ot(0,0,0),Gt=new ot(1,1,1),Ht=new ot,Vt=new ot,Wt=new ot;function jt(){let t=null,e=!1,i=null,n=null;function r(e,s){i(e,s),n=t.requestAnimationFrame(r)}return{start:function(){!0!==e&&null!==i&&(n=t.requestAnimationFrame(r),e=!0)},stop:function(){t.cancelAnimationFrame(n),e=!1},setAnimationLoop:function(t){i=t},setContext:function(e){t=e}}}function Xt(t,e){const i=e.isWebGL2,n=new WeakMap;return{get:function(t){return t.isInterleavedBufferAttribute&&(t=t.data),n.get(t)},remove:function(e){e.isInterleavedBufferAttribute&&(e=e.data);const i=n.get(e);i&&(t.deleteBuffer(i.buffer),n.delete(e))},update:function(e,r){if(e.isGLBufferAttribute){const t=n.get(e);return void((!t||t.version<e.version)&&n.set(e,{buffer:e.buffer,type:e.type,bytesPerElement:e.elementSize,version:e.version}))}e.isInterleavedBufferAttribute&&(e=e.data);const s=n.get(e);void 0===s?n.set(e,function(e,n){const r=e.array,s=e.usage,a=t.createBuffer();t.bindBuffer(n,a),t.bufferData(n,r,s),e.onUploadCallback();let o=t.FLOAT;return r instanceof Float32Array?o=t.FLOAT:r instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):r instanceof Uint16Array?e.isFloat16BufferAttribute?i?o=t.HALF_FLOAT:console.warn("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2."):o=t.UNSIGNED_SHORT:r instanceof Int16Array?o=t.SHORT:r instanceof Uint32Array?o=t.UNSIGNED_INT:r instanceof Int32Array?o=t.INT:r instanceof Int8Array?o=t.BYTE:(r instanceof Uint8Array||r instanceof Uint8ClampedArray)&&(o=t.UNSIGNED_BYTE),{buffer:a,type:o,bytesPerElement:r.BYTES_PER_ELEMENT,version:e.version}}(e,r)):s.version<e.version&&(!function(e,n,r){const s=n.array,a=n.updateRange;t.bindBuffer(r,e),-1===a.count?t.bufferSubData(r,0,s):(i?t.bufferSubData(r,a.offset*s.BYTES_PER_ELEMENT,s,a.offset,a.count):t.bufferSubData(r,a.offset*s.BYTES_PER_ELEMENT,s.subarray(a.offset,a.offset+a.count)),a.count=-1)}(s.buffer,e,r),s.version=e.version)}}}const qt={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Yt={h:0,s:0,l:0},Zt={h:0,s:0,l:0};function Jt(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}function Kt(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function Qt(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}class $t{constructor(t,e,i){return void 0===e&&void 0===i?this.set(t):this.setRGB(t,e,i)}set(t){return t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t),this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this}setRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}setHSL(t,e,i){var n;if(t=(t%(n=1)+n)%n,e=X(e,0,1),i=X(i,0,1),0===e)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+e):i+e-i*e,r=2*i-n;this.r=Jt(r,n,t+1/3),this.g=Jt(r,n,t),this.b=Jt(r,n,t-1/3)}return this}setStyle(t){function e(e){void 0!==e&&parseFloat(e)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}let i;if(i=/^((?:rgb|hsl)a?)\(([^\)]*)\)/.exec(t)){let t;const n=i[1],r=i[2];switch(n){case"rgb":case"rgba":if(t=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255,e(t[4]),this;if(t=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100,e(t[4]),this;break;case"hsl":case"hsla":if(t=/^\s*(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r)){const i=parseFloat(t[1])/360,n=parseInt(t[2],10)/100,r=parseInt(t[3],10)/100;return e(t[4]),this.setHSL(i,n,r)}}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(t)){const t=i[1],e=t.length;if(3===e)return this.r=parseInt(t.charAt(0)+t.charAt(0),16)/255,this.g=parseInt(t.charAt(1)+t.charAt(1),16)/255,this.b=parseInt(t.charAt(2)+t.charAt(2),16)/255,this;if(6===e)return this.r=parseInt(t.charAt(0)+t.charAt(1),16)/255,this.g=parseInt(t.charAt(2)+t.charAt(3),16)/255,this.b=parseInt(t.charAt(4)+t.charAt(5),16)/255,this}return t&&t.length>0?this.setColorName(t):this}setColorName(t){const e=qt[t.toLowerCase()];return void 0!==e?this.setHex(e):console.warn("THREE.Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copyGammaToLinear(t,e=2){return this.r=Math.pow(t.r,e),this.g=Math.pow(t.g,e),this.b=Math.pow(t.b,e),this}copyLinearToGamma(t,e=2){const i=e>0?1/e:1;return this.r=Math.pow(t.r,i),this.g=Math.pow(t.g,i),this.b=Math.pow(t.b,i),this}convertGammaToLinear(t){return this.copyGammaToLinear(this,t),this}convertLinearToGamma(t){return this.copyLinearToGamma(this,t),this}copySRGBToLinear(t){return this.r=Kt(t.r),this.g=Kt(t.g),this.b=Kt(t.b),this}copyLinearToSRGB(t){return this.r=Qt(t.r),this.g=Qt(t.g),this.b=Qt(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(t){const e=this.r,i=this.g,n=this.b,r=Math.max(e,i,n),s=Math.min(e,i,n);let a,o;const l=(s+r)/2;if(s===r)a=0,o=0;else{const t=r-s;switch(o=l<=.5?t/(r+s):t/(2-r-s),r){case e:a=(i-n)/t+(i<n?6:0);break;case i:a=(n-e)/t+2;break;case n:a=(e-i)/t+4}a/=6}return t.h=a,t.s=o,t.l=l,t}getStyle(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"}offsetHSL(t,e,i){return this.getHSL(Yt),Yt.h+=t,Yt.s+=e,Yt.l+=i,this.setHSL(Yt.h,Yt.s,Yt.l),this}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,i){return this.r=t.r+(e.r-t.r)*i,this.g=t.g+(e.g-t.g)*i,this.b=t.b+(e.b-t.b)*i,this}lerpHSL(t,e){this.getHSL(Yt),t.getHSL(Zt);const i=q(Yt.h,Zt.h,e),n=q(Yt.s,Zt.s,e),r=q(Yt.l,Zt.l,e);return this.setHSL(i,n,r),this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),!0===t.normalized&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}}$t.NAMES=qt,$t.prototype.isColor=!0,$t.prototype.r=1,$t.prototype.g=1,$t.prototype.b=1;const te=new ot,ee=new Q;class ie{constructor(t,e,i){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=!0===i,this.usage=k,this.updateRange={offset:0,count:-1},this.version=0}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}setUsage(t){return this.usage=t,this}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this}copyAt(t,e,i){t*=this.itemSize,i*=e.itemSize;for(let n=0,r=this.itemSize;n<r;n++)this.array[t+n]=e.array[i+n];return this}copyArray(t){return this.array.set(t),this}copyColorsArray(t){const e=this.array;let i=0;for(let n=0,r=t.length;n<r;n++){let r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",n),r=new $t),e[i++]=r.r,e[i++]=r.g,e[i++]=r.b}return this}copyVector2sArray(t){const e=this.array;let i=0;for(let n=0,r=t.length;n<r;n++){let r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",n),r=new Q),e[i++]=r.x,e[i++]=r.y}return this}copyVector3sArray(t){const e=this.array;let i=0;for(let n=0,r=t.length;n<r;n++){let r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",n),r=new ot),e[i++]=r.x,e[i++]=r.y,e[i++]=r.z}return this}copyVector4sArray(t){const e=this.array;let i=0;for(let n=0,r=t.length;n<r;n++){let r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",n),r=new rt),e[i++]=r.x,e[i++]=r.y,e[i++]=r.z,e[i++]=r.w}return this}applyMatrix3(t){if(2===this.itemSize)for(let e=0,i=this.count;e<i;e++)ee.fromBufferAttribute(this,e),ee.applyMatrix3(t),this.setXY(e,ee.x,ee.y);else if(3===this.itemSize)for(let e=0,i=this.count;e<i;e++)te.fromBufferAttribute(this,e),te.applyMatrix3(t),this.setXYZ(e,te.x,te.y,te.z);return this}applyMatrix4(t){for(let e=0,i=this.count;e<i;e++)te.x=this.getX(e),te.y=this.getY(e),te.z=this.getZ(e),te.applyMatrix4(t),this.setXYZ(e,te.x,te.y,te.z);return this}applyNormalMatrix(t){for(let e=0,i=this.count;e<i;e++)te.x=this.getX(e),te.y=this.getY(e),te.z=this.getZ(e),te.applyNormalMatrix(t),this.setXYZ(e,te.x,te.y,te.z);return this}transformDirection(t){for(let e=0,i=this.count;e<i;e++)te.x=this.getX(e),te.y=this.getY(e),te.z=this.getZ(e),te.transformDirection(t),this.setXYZ(e,te.x,te.y,te.z);return this}set(t,e=0){return this.array.set(t,e),this}getX(t){return this.array[t*this.itemSize]}setX(t,e){return this.array[t*this.itemSize]=e,this}getY(t){return this.array[t*this.itemSize+1]}setY(t,e){return this.array[t*this.itemSize+1]=e,this}getZ(t){return this.array[t*this.itemSize+2]}setZ(t,e){return this.array[t*this.itemSize+2]=e,this}getW(t){return this.array[t*this.itemSize+3]}setW(t,e){return this.array[t*this.itemSize+3]=e,this}setXY(t,e,i){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this}setXYZ(t,e,i,n){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this}setXYZW(t,e,i,n,r){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this.array[t+3]=r,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized};return""!==this.name&&(t.name=this.name),this.usage!==k&&(t.usage=this.usage),0===this.updateRange.offset&&-1===this.updateRange.count||(t.updateRange=this.updateRange),t}}ie.prototype.isBufferAttribute=!0;class ne extends ie{constructor(t,e,i){super(new Uint16Array(t),e,i)}}class re extends ie{constructor(t,e,i){super(new Uint32Array(t),e,i)}}(class extends ie{constructor(t,e,i){super(new Uint16Array(t),e,i)}}).prototype.isFloat16BufferAttribute=!0;class se extends ie{constructor(t,e,i){super(new Float32Array(t),e,i)}}const ae=new zt,oe=new at;class le{constructor(t=0,e=0,i=0,n=le.DefaultOrder){this._x=t,this._y=e,this._z=i,this._order=n}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,i,n=this._order){return this._x=t,this._y=e,this._z=i,this._order=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,i=!0){const n=t.elements,r=n[0],s=n[4],a=n[8],o=n[1],l=n[5],h=n[9],c=n[2],u=n[6],d=n[10];switch(e){case"XYZ":this._y=Math.asin(X(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-h,d),this._z=Math.atan2(-s,r)):(this._x=Math.atan2(u,l),this._z=0);break;case"YXZ":this._x=Math.asin(-X(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(a,d),this._z=Math.atan2(o,l)):(this._y=Math.atan2(-c,r),this._z=0);break;case"ZXY":this._x=Math.asin(X(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-c,d),this._z=Math.atan2(-s,l)):(this._y=0,this._z=Math.atan2(o,r));break;case"ZYX":this._y=Math.asin(-X(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(u,d),this._z=Math.atan2(o,r)):(this._x=0,this._z=Math.atan2(-s,l));break;case"YZX":this._z=Math.asin(X(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-h,l),this._y=Math.atan2(-c,r)):(this._x=0,this._y=Math.atan2(a,d));break;case"XZY":this._z=Math.asin(-X(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(u,l),this._y=Math.atan2(a,r)):(this._x=Math.atan2(-h,d),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,!0===i&&this._onChangeCallback(),this}setFromQuaternion(t,e,i){return ae.makeRotationFromQuaternion(t),this.setFromRotationMatrix(ae,e,i)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return oe.setFromEuler(this),this.setFromQuaternion(oe,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}toVector3(t){return t?t.set(this._x,this._y,this._z):new ot(this._x,this._y,this._z)}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}}le.prototype.isEuler=!0,le.DefaultOrder="XYZ",le.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];class he{constructor(){this.mask=1}set(t){this.mask=1<<t|0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return 0!=(this.mask&t.mask)}}let ce=0;const ue=new ot,de=new at,pe=new zt,fe=new ot,me=new ot,ge=new ot,ve=new at,ye=new ot(1,0,0),xe=new ot(0,1,0),_e=new ot(0,0,1),Me={type:"added"},be={type:"removed"};class Se extends c{constructor(){super(),Object.defineProperty(this,"id",{value:ce++}),this.uuid=j(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Se.DefaultUp.clone();const t=new ot,e=new le,i=new at,n=new ot(1,1,1);e._onChange((function(){i.setFromEuler(e,!1)})),i._onChange((function(){e.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new zt},normalMatrix:{value:new $}}),this.matrix=new zt,this.matrixWorld=new zt,this.matrixAutoUpdate=Se.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new he,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return de.setFromAxisAngle(t,e),this.quaternion.multiply(de),this}rotateOnWorldAxis(t,e){return de.setFromAxisAngle(t,e),this.quaternion.premultiply(de),this}rotateX(t){return this.rotateOnAxis(ye,t)}rotateY(t){return this.rotateOnAxis(xe,t)}rotateZ(t){return this.rotateOnAxis(_e,t)}translateOnAxis(t,e){return ue.copy(t).applyQuaternion(this.quaternion),this.position.add(ue.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(ye,t)}translateY(t){return this.translateOnAxis(xe,t)}translateZ(t){return this.translateOnAxis(_e,t)}localToWorld(t){return t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return t.applyMatrix4(pe.copy(this.matrixWorld).invert())}lookAt(t,e,i){t.isVector3?fe.copy(t):fe.set(t,e,i);const n=this.parent;this.updateWorldMatrix(!0,!1),me.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?pe.lookAt(me,fe,this.up):pe.lookAt(fe,me,this.up),this.quaternion.setFromRotationMatrix(pe),n&&(pe.extractRotation(n.matrixWorld),de.setFromRotationMatrix(pe),this.quaternion.premultiply(de.invert()))}add(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(Me)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}remove(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(be)),this}removeFromParent(){const t=this.parent;return null!==t&&t.remove(this),this}clear(){for(let t=0;t<this.children.length;t++){const e=this.children[t];e.parent=null,e.dispatchEvent(be)}return this.children.length=0,this}attach(t){return this.updateWorldMatrix(!0,!1),pe.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),pe.multiply(t.parent.matrixWorld)),t.applyMatrix4(pe),this.add(t),t.updateWorldMatrix(!1,!0),this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let i=0,n=this.children.length;i<n;i++){const n=this.children[i].getObjectByProperty(t,e);if(void 0!==n)return n}}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(me,t,ge),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(me,ve,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverse(t)}traverseVisible(t){if(!1===this.visible)return;t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverseVisible(t)}traverseAncestors(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].updateMatrixWorld(t)}updateWorldMatrix(t,e){const i=this.parent;if(!0===t&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e){const t=this.children;for(let e=0,i=t.length;e<i;e++)t[e].updateWorldMatrix(!1,!0)}}toJSON(t){const e=void 0===t||"string"==typeof t,i={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const n={};function r(e,i){return void 0===e[i.uuid]&&(e[i.uuid]=i.toJSON(t)),i.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(n.instanceColor=this.instanceColor.toJSON())),this.isScene)this.background&&(this.background.isColor?n.background=this.background.toJSON():this.background.isTexture&&(n.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&(n.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){n.geometry=r(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const i=e.shapes;if(Array.isArray(i))for(let e=0,n=i.length;e<n;e++){const n=i[e];r(t.shapes,n)}else r(t.shapes,i)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(t.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let i=0,n=this.material.length;i<n;i++)e.push(r(t.materials,this.material[i]));n.material=e}else n.material=r(t.materials,this.material);if(this.children.length>0){n.children=[];for(let e=0;e<this.children.length;e++)n.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){n.animations=[];for(let e=0;e<this.animations.length;e++){const i=this.animations[e];n.animations.push(r(t.animations,i))}}if(e){const e=s(t.geometries),n=s(t.materials),r=s(t.textures),a=s(t.images),o=s(t.shapes),l=s(t.skeletons),h=s(t.animations);e.length>0&&(i.geometries=e),n.length>0&&(i.materials=n),r.length>0&&(i.textures=r),a.length>0&&(i.images=a),o.length>0&&(i.shapes=o),l.length>0&&(i.skeletons=l),h.length>0&&(i.animations=h)}return i.object=n,i;function s(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}}clone(t){return(new this.constructor).copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const i=t.children[e];this.add(i.clone())}return this}}function we(t){if(0===t.length)return-1/0;let e=t[0];for(let i=1,n=t.length;i<n;++i)t[i]>e&&(e=t[i]);return e}Se.DefaultUp=new ot(0,1,0),Se.DefaultMatrixAutoUpdate=!0,Se.prototype.isObject3D=!0;let Ee=0;const Te=new zt,Ce=new Se,Le=new ot,Ae=new ct,Re=new ct,Pe=new ot;class De extends c{constructor(){super(),Object.defineProperty(this,"id",{value:Ee++}),this.uuid=j(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(t){return Array.isArray(t)?this.index=new(we(t)>65535?re:ne)(t,1):this.index=t,this}getAttribute(t){return this.attributes[t]}setAttribute(t,e){return this.attributes[t]=e,this}deleteAttribute(t){return delete this.attributes[t],this}hasAttribute(t){return void 0!==this.attributes[t]}addGroup(t,e,i=0){this.groups.push({start:t,count:e,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}applyMatrix4(t){const e=this.attributes.position;void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const e=(new $).getNormalMatrix(t);i.applyNormalMatrix(e),i.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(t),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(t){return Te.makeRotationFromQuaternion(t),this.applyMatrix4(Te),this}rotateX(t){return Te.makeRotationX(t),this.applyMatrix4(Te),this}rotateY(t){return Te.makeRotationY(t),this.applyMatrix4(Te),this}rotateZ(t){return Te.makeRotationZ(t),this.applyMatrix4(Te),this}translate(t,e,i){return Te.makeTranslation(t,e,i),this.applyMatrix4(Te),this}scale(t,e,i){return Te.makeScale(t,e,i),this.applyMatrix4(Te),this}lookAt(t){return Ce.lookAt(t),Ce.updateMatrix(),this.applyMatrix4(Ce.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Le).negate(),this.translate(Le.x,Le.y,Le.z),this}setFromPoints(t){const e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i];e.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new se(e,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new ct);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingBox.set(new ot(-1/0,-1/0,-1/0),new ot(1/0,1/0,1/0));if(void 0!==t){if(this.boundingBox.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];Ae.setFromBufferAttribute(i),this.morphTargetsRelative?(Pe.addVectors(this.boundingBox.min,Ae.min),this.boundingBox.expandByPoint(Pe),Pe.addVectors(this.boundingBox.max,Ae.max),this.boundingBox.expandByPoint(Pe)):(this.boundingBox.expandByPoint(Ae.min),this.boundingBox.expandByPoint(Ae.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new At);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingSphere.set(new ot,1/0);if(t){const i=this.boundingSphere.center;if(Ae.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];Re.setFromBufferAttribute(i),this.morphTargetsRelative?(Pe.addVectors(Ae.min,Re.min),Ae.expandByPoint(Pe),Pe.addVectors(Ae.max,Re.max),Ae.expandByPoint(Pe)):(Ae.expandByPoint(Re.min),Ae.expandByPoint(Re.max))}Ae.getCenter(i);let n=0;for(let e=0,r=t.count;e<r;e++)Pe.fromBufferAttribute(t,e),n=Math.max(n,i.distanceToSquared(Pe));if(e)for(let r=0,s=e.length;r<s;r++){const s=e[r],a=this.morphTargetsRelative;for(let e=0,r=s.count;e<r;e++)Pe.fromBufferAttribute(s,e),a&&(Le.fromBufferAttribute(t,e),Pe.add(Le)),n=Math.max(n,i.distanceToSquared(Pe))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeFaceNormals(){}computeTangents(){const t=this.index,e=this.attributes;if(null===t||void 0===e.position||void 0===e.normal||void 0===e.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const i=t.array,n=e.position.array,r=e.normal.array,s=e.uv.array,a=n.length/3;void 0===e.tangent&&this.setAttribute("tangent",new ie(new Float32Array(4*a),4));const o=e.tangent.array,l=[],h=[];for(let t=0;t<a;t++)l[t]=new ot,h[t]=new ot;const c=new ot,u=new ot,d=new ot,p=new Q,f=new Q,m=new Q,g=new ot,v=new ot;function y(t,e,i){c.fromArray(n,3*t),u.fromArray(n,3*e),d.fromArray(n,3*i),p.fromArray(s,2*t),f.fromArray(s,2*e),m.fromArray(s,2*i),u.sub(c),d.sub(c),f.sub(p),m.sub(p);const r=1/(f.x*m.y-m.x*f.y);isFinite(r)&&(g.copy(u).multiplyScalar(m.y).addScaledVector(d,-f.y).multiplyScalar(r),v.copy(d).multiplyScalar(f.x).addScaledVector(u,-m.x).multiplyScalar(r),l[t].add(g),l[e].add(g),l[i].add(g),h[t].add(v),h[e].add(v),h[i].add(v))}let x=this.groups;0===x.length&&(x=[{start:0,count:i.length}]);for(let t=0,e=x.length;t<e;++t){const e=x[t],n=e.start;for(let t=n,r=n+e.count;t<r;t+=3)y(i[t+0],i[t+1],i[t+2])}const _=new ot,M=new ot,b=new ot,S=new ot;function w(t){b.fromArray(r,3*t),S.copy(b);const e=l[t];_.copy(e),_.sub(b.multiplyScalar(b.dot(e))).normalize(),M.crossVectors(S,e);const i=M.dot(h[t])<0?-1:1;o[4*t]=_.x,o[4*t+1]=_.y,o[4*t+2]=_.z,o[4*t+3]=i}for(let t=0,e=x.length;t<e;++t){const e=x[t],n=e.start;for(let t=n,r=n+e.count;t<r;t+=3)w(i[t+0]),w(i[t+1]),w(i[t+2])}}computeVertexNormals(){const t=this.index,e=this.getAttribute("position");if(void 0!==e){let i=this.getAttribute("normal");if(void 0===i)i=new ie(new Float32Array(3*e.count),3),this.setAttribute("normal",i);else for(let t=0,e=i.count;t<e;t++)i.setXYZ(t,0,0,0);const n=new ot,r=new ot,s=new ot,a=new ot,o=new ot,l=new ot,h=new ot,c=new ot;if(t)for(let u=0,d=t.count;u<d;u+=3){const d=t.getX(u+0),p=t.getX(u+1),f=t.getX(u+2);n.fromBufferAttribute(e,d),r.fromBufferAttribute(e,p),s.fromBufferAttribute(e,f),h.subVectors(s,r),c.subVectors(n,r),h.cross(c),a.fromBufferAttribute(i,d),o.fromBufferAttribute(i,p),l.fromBufferAttribute(i,f),a.add(h),o.add(h),l.add(h),i.setXYZ(d,a.x,a.y,a.z),i.setXYZ(p,o.x,o.y,o.z),i.setXYZ(f,l.x,l.y,l.z)}else for(let t=0,a=e.count;t<a;t+=3)n.fromBufferAttribute(e,t+0),r.fromBufferAttribute(e,t+1),s.fromBufferAttribute(e,t+2),h.subVectors(s,r),c.subVectors(n,r),h.cross(c),i.setXYZ(t+0,h.x,h.y,h.z),i.setXYZ(t+1,h.x,h.y,h.z),i.setXYZ(t+2,h.x,h.y,h.z);this.normalizeNormals(),i.needsUpdate=!0}}merge(t,e){if(!t||!t.isBufferGeometry)return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",t);void 0===e&&(e=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));const i=this.attributes;for(const n in i){if(void 0===t.attributes[n])continue;const r=i[n].array,s=t.attributes[n],a=s.array,o=s.itemSize*e,l=Math.min(a.length,r.length-o);for(let t=0,e=o;t<l;t++,e++)r[e]=a[t]}return this}normalizeNormals(){const t=this.attributes.normal;for(let e=0,i=t.count;e<i;e++)Pe.fromBufferAttribute(t,e),Pe.normalize(),t.setXYZ(e,Pe.x,Pe.y,Pe.z)}toNonIndexed(){function t(t,e){const i=t.array,n=t.itemSize,r=t.normalized,s=new i.constructor(e.length*n);let a=0,o=0;for(let r=0,l=e.length;r<l;r++){a=t.isInterleavedBufferAttribute?e[r]*t.data.stride+t.offset:e[r]*n;for(let t=0;t<n;t++)s[o++]=i[a++]}return new ie(s,n,r)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const e=new De,i=this.index.array,n=this.attributes;for(const r in n){const s=t(n[r],i);e.setAttribute(r,s)}const r=this.morphAttributes;for(const n in r){const s=[],a=r[n];for(let e=0,n=a.length;e<n;e++){const n=t(a[e],i);s.push(n)}e.morphAttributes[n]=s}e.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let t=0,i=s.length;t<i;t++){const i=s[t];e.addGroup(i.start,i.count,i.materialIndex)}return e}toJSON(){const t={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){const e=this.parameters;for(const i in e)void 0!==e[i]&&(t[i]=e[i]);return t}t.data={attributes:{}};const e=this.index;null!==e&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const i=this.attributes;for(const e in i){const n=i[e];t.data.attributes[e]=n.toJSON(t.data)}const n={};let r=!1;for(const e in this.morphAttributes){const i=this.morphAttributes[e],s=[];for(let e=0,n=i.length;e<n;e++){const n=i[e];s.push(n.toJSON(t.data))}s.length>0&&(n[e]=s,r=!0)}r&&(t.data.morphAttributes=n,t.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(t.data.groups=JSON.parse(JSON.stringify(s)));const a=this.boundingSphere;return null!==a&&(t.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),t}clone(){return(new De).copy(this)}copy(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const i=t.index;null!==i&&this.setIndex(i.clone(e));const n=t.attributes;for(const t in n){const i=n[t];this.setAttribute(t,i.clone(e))}const r=t.morphAttributes;for(const t in r){const i=[],n=r[t];for(let t=0,r=n.length;t<r;t++)i.push(n[t].clone(e));this.morphAttributes[t]=i}this.morphTargetsRelative=t.morphTargetsRelative;const s=t.groups;for(let t=0,e=s.length;t<e;t++){const e=s[t];this.addGroup(e.start,e.count,e.materialIndex)}const a=t.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=t.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}De.prototype.isBufferGeometry=!0;class Ne extends De{constructor(t=1,e=1,i=1,n=1,r=1,s=1){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:n,heightSegments:r,depthSegments:s};const a=this;n=Math.floor(n),r=Math.floor(r),s=Math.floor(s);const o=[],l=[],h=[],c=[];let u=0,d=0;function p(t,e,i,n,r,s,p,f,m,g,v){const y=s/m,x=p/g,_=s/2,M=p/2,b=f/2,S=m+1,w=g+1;let E=0,T=0;const C=new ot;for(let s=0;s<w;s++){const a=s*x-M;for(let o=0;o<S;o++){const u=o*y-_;C[t]=u*n,C[e]=a*r,C[i]=b,l.push(C.x,C.y,C.z),C[t]=0,C[e]=0,C[i]=f>0?1:-1,h.push(C.x,C.y,C.z),c.push(o/m),c.push(1-s/g),E+=1}}for(let t=0;t<g;t++)for(let e=0;e<m;e++){const i=u+e+S*t,n=u+e+S*(t+1),r=u+(e+1)+S*(t+1),s=u+(e+1)+S*t;o.push(i,n,s),o.push(n,r,s),T+=6}a.addGroup(d,T,v),d+=T,u+=E}p("z","y","x",-1,-1,i,e,t,s,r,0),p("z","y","x",1,-1,i,e,-t,s,r,1),p("x","z","y",1,1,t,i,e,n,s,2),p("x","z","y",1,-1,t,i,-e,n,s,3),p("x","y","z",1,-1,t,e,i,n,r,4),p("x","y","z",-1,-1,t,e,-i,n,r,5),this.setIndex(o),this.setAttribute("position",new se(l,3)),this.setAttribute("normal",new se(h,3)),this.setAttribute("uv",new se(c,2))}static fromJSON(t){return new Ne(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}}class Ie extends De{constructor(t=1,e=1,i=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:n};const r=t/2,s=e/2,a=Math.floor(i),o=Math.floor(n),l=a+1,h=o+1,c=t/a,u=e/o,d=[],p=[],f=[],m=[];for(let t=0;t<h;t++){const e=t*u-s;for(let i=0;i<l;i++){const n=i*c-r;p.push(n,-e,0),f.push(0,0,1),m.push(i/a),m.push(1-t/o)}}for(let t=0;t<o;t++)for(let e=0;e<a;e++){const i=e+l*t,n=e+l*(t+1),r=e+1+l*(t+1),s=e+1+l*t;d.push(i,n,s),d.push(n,r,s)}this.setIndex(d),this.setAttribute("position",new se(p,3)),this.setAttribute("normal",new se(f,3)),this.setAttribute("uv",new se(m,2))}static fromJSON(t){return new Ie(t.width,t.height,t.widthSegments,t.heightSegments)}}let Fe=0;class Oe extends c{constructor(){super(),Object.defineProperty(this,"id",{value:Fe++}),this.uuid=j(),this.name="",this.type="Material",this.fog=!0,this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=f,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=U,this.stencilZFail=U,this.stencilZPass=U,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0}onBuild(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(t){if(void 0!==t)for(const e in t){const i=t[e];if(void 0===i){console.warn("THREE.Material: '"+e+"' parameter is undefined.");continue}if("shading"===e){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===i;continue}const n=this[e];void 0!==n?n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[e]=i:console.warn("THREE."+this.type+": '"+e+"' is not a property of this material.")}}toJSON(t){const e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{}});const i={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function n(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),this.sheen&&this.sheen.isColor&&(i.sheen=this.sheen.getHex()),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(i.specularIntensity=this.specularIntensity),this.specularTint&&this.specularTint.isColor&&(i.specularTint=this.specularTint.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(t).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(t).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(t).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(t).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(t).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(t).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(t).uuid),this.specularTintMap&&this.specularTintMap.isTexture&&(i.specularTintMap=this.specularTintMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(t).uuid,void 0!==this.combine&&(i.combine=this.combine)),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(i.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.transmission&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(t).uuid),void 0!==this.thickness&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(t).uuid),void 0!==this.attenuationDistance&&(i.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationTint&&(i.attenuationTint=this.attenuationTint.getHex()),void 0!==this.size&&(i.size=this.size),null!==this.shadowSide&&(i.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(i.blending=this.blending),0!==this.side&&(i.side=this.side),this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=this.transparent),i.depthFunc=this.depthFunc,i.depthTest=this.depthTest,i.depthWrite=this.depthWrite,i.colorWrite=this.colorWrite,i.stencilWrite=this.stencilWrite,i.stencilWriteMask=this.stencilWriteMask,i.stencilFunc=this.stencilFunc,i.stencilRef=this.stencilRef,i.stencilFuncMask=this.stencilFuncMask,i.stencilFail=this.stencilFail,i.stencilZFail=this.stencilZFail,i.stencilZPass=this.stencilZPass,this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.alphaToCoverage&&(i.alphaToCoverage=this.alphaToCoverage),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(i.wireframe=this.wireframe),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(i.flatShading=this.flatShading),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),e){const e=n(t.textures),r=n(t.images);e.length>0&&(i.textures=e),r.length>0&&(i.images=r)}return i}clone(){return(new this.constructor).copy(this)}copy(t){this.name=t.name,this.fog=t.fog,this.blending=t.blending,this.side=t.side,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let i=null;if(null!==e){const t=e.length;i=new Array(t);for(let n=0;n!==t;++n)i[n]=e[n].clone()}return this.clippingPlanes=i,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.alphaToCoverage=t.alphaToCoverage,this.premultipliedAlpha=t.premultipliedAlpha,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(t){!0===t&&this.version++}}function ze(t){const e={};for(const i in t){e[i]={};for(const n in t[i]){const r=t[i][n];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?e[i][n]=r.clone():Array.isArray(r)?e[i][n]=r.slice():e[i][n]=r}}return e}function Ue(t){const e={};for(let i=0;i<t.length;i++){const n=ze(t[i]);for(const t in n)e[t]=n[t]}return e}Oe.prototype.isMaterial=!0;const Be={clone:ze,merge:Ue};class ke extends Oe{constructor(t){super(),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==t&&(void 0!==t.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(t))}copy(t){return super.copy(t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=ze(t.uniforms),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.lights=t.lights,this.clipping=t.clipping,this.extensions=Object.assign({},t.extensions),this.glslVersion=t.glslVersion,this}toJSON(t){const e=super.toJSON(t);e.glslVersion=this.glslVersion,e.uniforms={};for(const i in this.uniforms){const n=this.uniforms[i].value;n&&n.isTexture?e.uniforms[i]={type:"t",value:n.toJSON(t).uuid}:n&&n.isColor?e.uniforms[i]={type:"c",value:n.getHex()}:n&&n.isVector2?e.uniforms[i]={type:"v2",value:n.toArray()}:n&&n.isVector3?e.uniforms[i]={type:"v3",value:n.toArray()}:n&&n.isVector4?e.uniforms[i]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?e.uniforms[i]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?e.uniforms[i]={type:"m4",value:n.toArray()}:e.uniforms[i]={value:n}}Object.keys(this.defines).length>0&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader;const i={};for(const t in this.extensions)!0===this.extensions[t]&&(i[t]=!0);return Object.keys(i).length>0&&(e.extensions=i),e}}ke.prototype.isShaderMaterial=!0;const Ge=new ot,He=new ot,Ve=new ot,We=new ot,je=new ot,Xe=new ot,qe=new ot;class Ye{constructor(t=new ot,e=new ot(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return e.copy(this.direction).multiplyScalar(t).add(this.origin)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,Ge)),this}closestPointToPoint(t,e){e.subVectors(t,this.origin);const i=e.dot(this.direction);return i<0?e.copy(this.origin):e.copy(this.direction).multiplyScalar(i).add(this.origin)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=Ge.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(Ge.copy(this.direction).multiplyScalar(e).add(this.origin),Ge.distanceToSquared(t))}distanceSqToSegment(t,e,i,n){He.copy(t).add(e).multiplyScalar(.5),Ve.copy(e).sub(t).normalize(),We.copy(this.origin).sub(He);const r=.5*t.distanceTo(e),s=-this.direction.dot(Ve),a=We.dot(this.direction),o=-We.dot(Ve),l=We.lengthSq(),h=Math.abs(1-s*s);let c,u,d,p;if(h>0)if(c=s*o-a,u=s*a-o,p=r*h,c>=0)if(u>=-p)if(u<=p){const t=1/h;c*=t,u*=t,d=c*(c+s*u+2*a)+u*(s*c+u+2*o)+l}else u=r,c=Math.max(0,-(s*u+a)),d=-c*c+u*(u+2*o)+l;else u=-r,c=Math.max(0,-(s*u+a)),d=-c*c+u*(u+2*o)+l;else u<=-p?(c=Math.max(0,-(-s*r+a)),u=c>0?-r:Math.min(Math.max(-r,-o),r),d=-c*c+u*(u+2*o)+l):u<=p?(c=0,u=Math.min(Math.max(-r,-o),r),d=u*(u+2*o)+l):(c=Math.max(0,-(s*r+a)),u=c>0?r:Math.min(Math.max(-r,-o),r),d=-c*c+u*(u+2*o)+l);else u=s>0?-r:r,c=Math.max(0,-(s*u+a)),d=-c*c+u*(u+2*o)+l;return i&&i.copy(this.direction).multiplyScalar(c).add(this.origin),n&&n.copy(Ve).multiplyScalar(u).add(He),d}intersectSphere(t,e){Ge.subVectors(t.center,this.origin);const i=Ge.dot(this.direction),n=Ge.dot(Ge)-i*i,r=t.radius*t.radius;if(n>r)return null;const s=Math.sqrt(r-n),a=i-s,o=i+s;return a<0&&o<0?null:a<0?this.at(o,e):this.at(a,e)}intersectsSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(t.normal)+t.constant)/e;return i>=0?i:null}intersectPlane(t,e){const i=this.distanceToPlane(t);return null===i?null:this.at(i,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);if(0===e)return!0;return t.normal.dot(this.direction)*e<0}intersectBox(t,e){let i,n,r,s,a,o;const l=1/this.direction.x,h=1/this.direction.y,c=1/this.direction.z,u=this.origin;return l>=0?(i=(t.min.x-u.x)*l,n=(t.max.x-u.x)*l):(i=(t.max.x-u.x)*l,n=(t.min.x-u.x)*l),h>=0?(r=(t.min.y-u.y)*h,s=(t.max.y-u.y)*h):(r=(t.max.y-u.y)*h,s=(t.min.y-u.y)*h),i>s||r>n?null:((r>i||i!=i)&&(i=r),(s<n||n!=n)&&(n=s),c>=0?(a=(t.min.z-u.z)*c,o=(t.max.z-u.z)*c):(a=(t.max.z-u.z)*c,o=(t.min.z-u.z)*c),i>o||a>n?null:((a>i||i!=i)&&(i=a),(o<n||n!=n)&&(n=o),n<0?null:this.at(i>=0?i:n,e)))}intersectsBox(t){return null!==this.intersectBox(t,Ge)}intersectTriangle(t,e,i,n,r){je.subVectors(e,t),Xe.subVectors(i,t),qe.crossVectors(je,Xe);let s,a=this.direction.dot(qe);if(a>0){if(n)return null;s=1}else{if(!(a<0))return null;s=-1,a=-a}We.subVectors(this.origin,t);const o=s*this.direction.dot(Xe.crossVectors(We,Xe));if(o<0)return null;const l=s*this.direction.dot(je.cross(We));if(l<0)return null;if(o+l>a)return null;const h=-s*We.dot(qe);return h<0?null:this.at(h/a,r)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}const Ze=new ot,Je=new ot,Ke=new ot,Qe=new ot,$e=new ot,ti=new ot,ei=new ot,ii=new ot,ni=new ot,ri=new ot;class si{constructor(t=new ot,e=new ot,i=new ot){this.a=t,this.b=e,this.c=i}static getNormal(t,e,i,n){n.subVectors(i,e),Ze.subVectors(t,e),n.cross(Ze);const r=n.lengthSq();return r>0?n.multiplyScalar(1/Math.sqrt(r)):n.set(0,0,0)}static getBarycoord(t,e,i,n,r){Ze.subVectors(n,e),Je.subVectors(i,e),Ke.subVectors(t,e);const s=Ze.dot(Ze),a=Ze.dot(Je),o=Ze.dot(Ke),l=Je.dot(Je),h=Je.dot(Ke),c=s*l-a*a;if(0===c)return r.set(-2,-1,-1);const u=1/c,d=(l*o-a*h)*u,p=(s*h-a*o)*u;return r.set(1-d-p,p,d)}static containsPoint(t,e,i,n){return this.getBarycoord(t,e,i,n,Qe),Qe.x>=0&&Qe.y>=0&&Qe.x+Qe.y<=1}static getUV(t,e,i,n,r,s,a,o){return this.getBarycoord(t,e,i,n,Qe),o.set(0,0),o.addScaledVector(r,Qe.x),o.addScaledVector(s,Qe.y),o.addScaledVector(a,Qe.z),o}static isFrontFacing(t,e,i,n){return Ze.subVectors(i,e),Je.subVectors(t,e),Ze.cross(Je).dot(n)<0}set(t,e,i){return this.a.copy(t),this.b.copy(e),this.c.copy(i),this}setFromPointsAndIndices(t,e,i,n){return this.a.copy(t[e]),this.b.copy(t[i]),this.c.copy(t[n]),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return Ze.subVectors(this.c,this.b),Je.subVectors(this.a,this.b),.5*Ze.cross(Je).length()}getMidpoint(t){return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return si.getNormal(this.a,this.b,this.c,t)}getPlane(t){return t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return si.getBarycoord(t,this.a,this.b,this.c,e)}getUV(t,e,i,n,r){return si.getUV(t,this.a,this.b,this.c,e,i,n,r)}containsPoint(t){return si.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return si.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){const i=this.a,n=this.b,r=this.c;let s,a;$e.subVectors(n,i),ti.subVectors(r,i),ii.subVectors(t,i);const o=$e.dot(ii),l=ti.dot(ii);if(o<=0&&l<=0)return e.copy(i);ni.subVectors(t,n);const h=$e.dot(ni),c=ti.dot(ni);if(h>=0&&c<=h)return e.copy(n);const u=o*c-h*l;if(u<=0&&o>=0&&h<=0)return s=o/(o-h),e.copy(i).addScaledVector($e,s);ri.subVectors(t,r);const d=$e.dot(ri),p=ti.dot(ri);if(p>=0&&d<=p)return e.copy(r);const f=d*l-o*p;if(f<=0&&l>=0&&p<=0)return a=l/(l-p),e.copy(i).addScaledVector(ti,a);const m=h*p-d*c;if(m<=0&&c-h>=0&&d-p>=0)return ei.subVectors(r,n),a=(c-h)/(c-h+(d-p)),e.copy(n).addScaledVector(ei,a);const g=1/(m+f+u);return s=f*g,a=u*g,e.copy(i).addScaledVector($e,s).addScaledVector(ti,a)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}class ai extends Oe{constructor(t){super(),this.type="MeshBasicMaterial",this.color=new $t(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this}}ai.prototype.isMeshBasicMaterial=!0;const oi=new zt,li=new Ye,hi=new At,ci=new ot,ui=new ot,di=new ot,pi=new ot,fi=new ot,mi=new ot,gi=new ot,vi=new ot,yi=new ot,xi=new Q,_i=new Q,Mi=new Q,bi=new ot,Si=new ot;class wi extends Se{constructor(t=new De,e=new ai){super(),this.type="Mesh",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t){return super.copy(t),void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=t.material,this.geometry=t.geometry,this}updateMorphTargets(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,i=Object.keys(e);if(i.length>0){const t=e[i[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=t.length;e<i;e++){const i=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}}raycast(t,e){const i=this.geometry,n=this.material,r=this.matrixWorld;if(void 0===n)return;if(null===i.boundingSphere&&i.computeBoundingSphere(),hi.copy(i.boundingSphere),hi.applyMatrix4(r),!1===t.ray.intersectsSphere(hi))return;if(oi.copy(r).invert(),li.copy(t.ray).applyMatrix4(oi),null!==i.boundingBox&&!1===li.intersectsBox(i.boundingBox))return;let s;if(i.isBufferGeometry){const r=i.index,a=i.attributes.position,o=i.morphAttributes.position,l=i.morphTargetsRelative,h=i.attributes.uv,c=i.attributes.uv2,u=i.groups,d=i.drawRange;if(null!==r)if(Array.isArray(n))for(let i=0,p=u.length;i<p;i++){const p=u[i],f=n[p.materialIndex];for(let i=Math.max(p.start,d.start),n=Math.min(p.start+p.count,d.start+d.count);i<n;i+=3){const n=r.getX(i),u=r.getX(i+1),d=r.getX(i+2);s=Ei(this,f,t,li,a,o,l,h,c,n,u,d),s&&(s.faceIndex=Math.floor(i/3),s.face.materialIndex=p.materialIndex,e.push(s))}}else{for(let i=Math.max(0,d.start),u=Math.min(r.count,d.start+d.count);i<u;i+=3){const u=r.getX(i),d=r.getX(i+1),p=r.getX(i+2);s=Ei(this,n,t,li,a,o,l,h,c,u,d,p),s&&(s.faceIndex=Math.floor(i/3),e.push(s))}}else if(void 0!==a)if(Array.isArray(n))for(let i=0,r=u.length;i<r;i++){const r=u[i],p=n[r.materialIndex];for(let i=Math.max(r.start,d.start),n=Math.min(r.start+r.count,d.start+d.count);i<n;i+=3){s=Ei(this,p,t,li,a,o,l,h,c,i,i+1,i+2),s&&(s.faceIndex=Math.floor(i/3),s.face.materialIndex=r.materialIndex,e.push(s))}}else{for(let i=Math.max(0,d.start),r=Math.min(a.count,d.start+d.count);i<r;i+=3){s=Ei(this,n,t,li,a,o,l,h,c,i,i+1,i+2),s&&(s.faceIndex=Math.floor(i/3),e.push(s))}}}else i.isGeometry&&console.error("THREE.Mesh.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}}function Ei(t,e,i,n,r,s,a,o,l,h,c,u){ci.fromBufferAttribute(r,h),ui.fromBufferAttribute(r,c),di.fromBufferAttribute(r,u);const d=t.morphTargetInfluences;if(s&&d){gi.set(0,0,0),vi.set(0,0,0),yi.set(0,0,0);for(let t=0,e=s.length;t<e;t++){const e=d[t],i=s[t];0!==e&&(pi.fromBufferAttribute(i,h),fi.fromBufferAttribute(i,c),mi.fromBufferAttribute(i,u),a?(gi.addScaledVector(pi,e),vi.addScaledVector(fi,e),yi.addScaledVector(mi,e)):(gi.addScaledVector(pi.sub(ci),e),vi.addScaledVector(fi.sub(ui),e),yi.addScaledVector(mi.sub(di),e)))}ci.add(gi),ui.add(vi),di.add(yi)}t.isSkinnedMesh&&(t.boneTransform(h,ci),t.boneTransform(c,ui),t.boneTransform(u,di));const p=function(t,e,i,n,r,s,a,o){let l;if(l=1===e.side?n.intersectTriangle(a,s,r,!0,o):n.intersectTriangle(r,s,a,2!==e.side,o),null===l)return null;Si.copy(o),Si.applyMatrix4(t.matrixWorld);const h=i.ray.origin.distanceTo(Si);return h<i.near||h>i.far?null:{distance:h,point:Si.clone(),object:t}}(t,e,i,n,ci,ui,di,bi);if(p){o&&(xi.fromBufferAttribute(o,h),_i.fromBufferAttribute(o,c),Mi.fromBufferAttribute(o,u),p.uv=si.getUV(bi,ci,ui,di,xi,_i,Mi,new Q)),l&&(xi.fromBufferAttribute(l,h),_i.fromBufferAttribute(l,c),Mi.fromBufferAttribute(l,u),p.uv2=si.getUV(bi,ci,ui,di,xi,_i,Mi,new Q));const t={a:h,b:c,c:u,normal:new ot,materialIndex:0};si.getNormal(ci,ui,di,t.normal),p.face=t}return p}wi.prototype.isMesh=!0;const Ti={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"vec3 transformed = vec3( position );",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"vec2 integrateSpecularBRDF( const in float dotNV, const in float roughness ) {\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\treturn vec2( -1.04, 1.04 ) * a004 + r.zw;\n}\nfloat punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n#else\n\tif( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t}\n\treturn 1.0;\n#endif\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in vec3 f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn ( f90 - f0 ) * fresnel + f0;\n}\nvec3 F_Schlick_RoughnessDependent( const in vec3 F0, const in float dotNV, const in float roughness ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotNV - 6.98316 ) * dotNV );\n\tvec3 Fr = max( vec3( 1.0 - roughness ), F0 ) - F0;\n\treturn Fr * fresnel + F0;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in vec3 viewDir, const in vec3 normal, const in vec3 f0, const in vec3 f90, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + viewDir );\n\tfloat dotNL = saturate( dot( normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\nvec3 BRDF_Specular_GGX_Environment( const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\treturn specularColor * brdf.x + brdf.y;\n}\nvoid BRDF_Specular_Multiscattering_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tvec3 F = F_Schlick_RoughnessDependent( specularColor, dotNV, roughness );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\tvec3 FssEss = F * brdf.x + brdf.y;\n\tfloat Ess = brdf.x + brdf.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, vec3( 1.0 ), dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie(float roughness, float NoH) {\n\tfloat invAlpha = 1.0 / roughness;\n\tfloat cos2h = NoH * NoH;\n\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\treturn (2.0 + invAlpha) * pow(sin2h, invAlpha * 0.5) / (2.0 * PI);\n}\nfloat V_Neubelt(float NoV, float NoL) {\n\treturn saturate(1.0 / (4.0 * (NoL + NoV - NoL * NoV)));\n}\nvec3 BRDF_Specular_Sheen( const in float roughness, const in vec3 L, const in GeometricContext geometry, vec3 specularColor ) {\n\tvec3 N = geometry.normal;\n\tvec3 V = geometry.viewDir;\n\tvec3 H = normalize( V + L );\n\tfloat dotNH = saturate( dot( N, H ) );\n\treturn specularColor * D_Charlie( roughness, dotNH ) * V_Neubelt( dot(N, V), dot(N, L) );\n}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#pragma unroll_loop_end\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\tif ( clipped ) discard;\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat max3( vec3 v ) { return max( max( v.x, v.y ), v.z ); }\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n#ifdef CLEARCOAT\n\tvec3 clearcoatNormal;\n#endif\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\treturn dot( weights, color.rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_maxMipLevel 8.0\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_maxTileSize 256.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\tfloat texelSize = 1.0 / ( 3.0 * cubeUV_maxTileSize );\n\t\tvec2 uv = getUV( direction, face ) * ( faceSize - 1.0 );\n\t\tvec2 f = fract( uv );\n\t\tuv += 0.5 - f;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tif ( mipInt < cubeUV_maxMipLevel ) {\n\t\t\tuv.y += 2.0 * cubeUV_maxTileSize;\n\t\t}\n\t\tuv.y += filterInt * 2.0 * cubeUV_minTileSize;\n\t\tuv.x += 3.0 * max( 0.0, cubeUV_maxTileSize - 2.0 * faceSize );\n\t\tuv *= texelSize;\n\t\tvec3 tl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.x += texelSize;\n\t\tvec3 tr = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.y += texelSize;\n\t\tvec3 br = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.x -= texelSize;\n\t\tvec3 bl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tvec3 tm = mix( tl, tr, f.x );\n\t\tvec3 bm = mix( bl, br, f.x );\n\t\treturn mix( tm, bm, f.y );\n\t}\n\t#define r0 1.0\n\t#define v0 0.339\n\t#define m0 - 2.0\n\t#define r1 0.8\n\t#define v1 0.276\n\t#define m1 - 1.0\n\t#define r4 0.4\n\t#define v4 0.046\n\t#define m4 2.0\n\t#define r5 0.305\n\t#define v5 0.016\n\t#define m5 3.0\n\t#define r6 0.21\n\t#define v6 0.0038\n\t#define m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= r1 ) {\n\t\t\tmip = ( r0 - roughness ) * ( m1 - m0 ) / ( r0 - r1 ) + m0;\n\t\t} else if ( roughness >= r4 ) {\n\t\t\tmip = ( r1 - roughness ) * ( m4 - m1 ) / ( r1 - r4 ) + m1;\n\t\t} else if ( roughness >= r5 ) {\n\t\t\tmip = ( r4 - roughness ) * ( m5 - m4 ) / ( r4 - r5 ) + m4;\n\t\t} else if ( roughness >= r6 ) {\n\t\t\tmip = ( r5 - roughness ) * ( m6 - m5 ) / ( r5 - r6 ) + m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), m0, cubeUV_maxMipLevel );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_INSTANCING\n\tmat3 m = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n\ttransformedNormal = m * transformedNormal;\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",encodings_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( gammaFactor ) ), value.a );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( 1.0 / gammaFactor ) ), value.a );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * value.a * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat M = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat D = max( maxRange / maxRGB, 1.0 );\n\tD = clamp( floor( D ) / 255.0, 0.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value ) {\n\tvec3 Xp_Y_XYZp = cLogLuvM * value.rgb;\n\tXp_Y_XYZp = max( Xp_Y_XYZp, vec3( 1e-6, 1e-6, 1e-6 ) );\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract( Le );\n\tvResult.z = ( Le - ( floor( vResult.w * 255.0 ) ) / 255.0 ) / 255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2( ( Le - 127.0 ) / 2.0 );\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;\n\treturn vec4( max( vRGB, 0.0 ), 1.0 );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 envColor = textureCubeUV( envMap, reflectVec, 0.0 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifndef ENVMAP_TYPE_CUBE_UV\n\t\tenvColor = envMapTexelToLinear( envColor );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform int maxMipLevel;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ||defined( PHONG )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#if defined( USE_ENVMAP )\n\t#ifdef ENVMAP_MODE_REFRACTION\n\t\tuniform float refractionRatio;\n\t#endif\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float roughness, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat sigma = PI * roughness * roughness / ( 1.0 + roughness );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar + log2( sigma );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -viewDir, normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( roughness, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tfogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float fogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * fogDepth * fogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn texture2D( gradientMap, coord ).rgb;\n\t#else\n\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\treflectedLight.indirectDiffuse += PI * lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\nvIndirectFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n\tvIndirectBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\nvIndirectFront += getAmbientLightIrradiance( ambientLightColor );\nvIndirectFront += getLightProbeIrradiance( lightProbe, geometry );\n#ifdef DOUBLE_SIDED\n\tvIndirectBack += getAmbientLightIrradiance( ambientLightColor );\n\tvIndirectBack += getLightProbeIrradiance( lightProbe, backGeometry );\n#endif\n#if NUM_POINT_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_DIR_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\nuniform vec3 lightProbe[ 9 ];\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in GeometricContext geometry ) {\n\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon\n#define Material_LightProbeLOD( material )\t(0)",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.specularRoughness = max( roughnessFactor, 0.0525 );material.specularRoughness += geometryRoughness;\nmaterial.specularRoughness = min( material.specularRoughness, 1.0 );\n#ifdef REFLECTIVITY\n\t#ifdef SPECULAR\n\t\tvec3 specularIntensityFactor = vec3( specularIntensity );\n\t\tvec3 specularTintFactor = specularTint;\n\t\t#ifdef USE_SPECULARINTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vUv ).a;\n\t\t#endif\n\t\t#ifdef USE_SPECULARTINTMAP\n\t\t\tspecularTintFactor *= specularTintMapTexelToLinear( texture2D( specularTintMap, vUv ) ).rgb;\n\t\t#endif\n\t\tmaterial.specularColorF90 = mix( specularIntensityFactor, vec3( 1.0 ), metalnessFactor );\n\t#else\n\t\tvec3 specularIntensityFactor = vec3( 1.0 );\n\t\tvec3 specularTintFactor = vec3( 1.0 );\n\t\tmaterial.specularColorF90 = vec3( 1.0 );\n\t#endif\n\tmaterial.specularColor = mix( min( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ) * specularTintFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularColorF90 = vec3( 1.0 );\n#endif\n#ifdef CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheen;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat specularRoughness;\n\tvec3 specularColor;\n\tvec3 specularColorF90;\n#ifdef CLEARCOAT\n\tfloat clearcoat;\n\tfloat clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tvec3 sheenColor;\n#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearcoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifdef CLEARCOAT\n\t\tfloat ccDotNL = saturate( dot( geometry.clearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = ccDotNL * directLight.color;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tccIrradiance *= PI;\n\t\t#endif\n\t\tfloat clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );\n\t\treflectedLight.directSpecular += ccIrradiance * material.clearcoat * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), vec3( 1.0 ), material.clearcoatRoughness );\n\t#else\n\t\tfloat clearcoatDHR = 0.0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\treflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_Sheen(\n\t\t\tmaterial.specularRoughness,\n\t\t\tdirectLight.direction,\n\t\t\tgeometry,\n\t\t\tmaterial.sheenColor\n\t\t);\n\t#else\n\t\treflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.normal, material.specularColor, material.specularColorF90, material.specularRoughness);\n\t#endif\n\treflectedLight.directDiffuse += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef CLEARCOAT\n\t\tfloat ccDotNV = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular += clearcoatRadiance * material.clearcoat * BRDF_Specular_GGX_Environment( geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );\n\t\tfloat ccDotNL = ccDotNV;\n\t\tfloat clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );\n\t#else\n\t\tfloat clearcoatDHR = 0.0;\n\t#endif\n\tfloat clearcoatInv = 1.0 - clearcoatDHR;\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\tBRDF_Specular_Multiscattering_Environment( geometry, material.specularColor, material.specularRoughness, singleScattering, multiScattering );\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );\n\treflectedLight.indirectSpecular += clearcoatInv * radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n#ifdef CLEARCOAT\n\tgeometry.clearcoatNormal = clearcoatNormal;\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\tirradiance += getLightProbeIrradiance( lightProbe, geometry );\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\tvec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getLightProbeIndirectIrradiance( geometry, maxMipLevel );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tradiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, maxMipLevel );\n\t#ifdef CLEARCOAT\n\t\tclearcoatRadiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, maxMipLevel );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometry, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n#endif\n#ifdef USE_MAP\n\tvec4 mapTexel = texture2D( map, uv );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tuniform mat3 uvTransform;\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifndef USE_MORPHNORMALS\n\t\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\t\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t#endif\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\t#ifdef USE_TANGENT\n\t\tvec3 tangent = normalize( vTangent );\n\t\tvec3 bitangent = normalize( vBitangent );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\ttangent = tangent * faceDirection;\n\t\t\tbitangent = bitangent * faceDirection;\n\t\t#endif\n\t\t#if defined( TANGENTSPACE_NORMALMAP ) || defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tmat3 vTBN = mat3( tangent, bitangent, normal );\n\t\t#endif\n\t#endif\n#endif\nvec3 geometryNormal = normal;",normal_fragment_maps:"#ifdef OBJECTSPACE_NORMALMAP\n\tnormal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( TANGENTSPACE_NORMALMAP )\n\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\t#ifdef USE_TANGENT\n\t\tnormal = normalize( vTBN * mapN );\n\t#else\n\t\tnormal = perturbNormal2Arb( -vViewPosition, normal, mapN, faceDirection );\n\t#endif\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( TANGENTSPACE_NORMALMAP ) || defined ( USE_CLEARCOAT_NORMALMAP ) )\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 mapN, float faceDirection ) {\n\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : faceDirection * inversesqrt( det );\n\t\treturn normalize( T * ( mapN.x * scale ) + B * ( mapN.y * scale ) + N * mapN.z );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef CLEARCOAT\n\tvec3 clearcoatNormal = geometryNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\t#ifdef USE_TANGENT\n\t\tclearcoatNormal = normalize( vTBN * clearcoatMapN );\n\t#else\n\t\tclearcoatNormal = perturbNormal2Arb( - vViewPosition, clearcoatNormal, clearcoatMapN, faceDirection );\n\t#endif\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ));\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w);\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0 || NUM_SPOT_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0\n\t\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\tvec4 shadowWorldPosition;\n\t#endif\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform highp sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tfloat transmissionFactor = transmission;\n\tfloat thicknessFactor = thickness;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\ttransmissionFactor *= texture2D( transmissionMap, vUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tthicknessFactor *= texture2D( thicknessMap, vUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition.xyz / vWorldPosition.w;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tfloat ior = ( 1.0 + 0.4 * reflectivity ) / ( 1.0 - 0.4 * reflectivity );\n\tvec3 transmission = transmissionFactor * getIBLVolumeRefraction(\n\t\tn, v, roughnessFactor, material.diffuseColor, material.specularColor,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, ior, thicknessFactor,\n\t\tattenuationTint, attenuationDistance );\n\ttotalDiffuse = mix( totalDiffuse, transmission, transmissionFactor );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec4 vWorldPosition;\n\tvec3 getVolumeTransmissionRay(vec3 n, vec3 v, float thickness, float ior, mat4 modelMatrix) {\n\t\tvec3 refractionVector = refract(-v, normalize(n), 1.0 / ior);\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length(vec3(modelMatrix[0].xyz));\n\t\tmodelScale.y = length(vec3(modelMatrix[1].xyz));\n\t\tmodelScale.z = length(vec3(modelMatrix[2].xyz));\n\t\treturn normalize(refractionVector) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness(float roughness, float ior) {\n\t\treturn roughness * clamp(ior * 2.0 - 2.0, 0.0, 1.0);\n\t}\n\tvec3 getTransmissionSample(vec2 fragCoord, float roughness, float ior) {\n\t\tfloat framebufferLod = log2(transmissionSamplerSize.x) * applyIorToRoughness(roughness, ior);\n\t\treturn texture2DLodEXT(transmissionSamplerMap, fragCoord.xy, framebufferLod).rgb;\n\t}\n\tvec3 applyVolumeAttenuation(vec3 radiance, float transmissionDistance, vec3 attenuationColor, float attenuationDistance) {\n\t\tif (attenuationDistance == 0.0) {\n\t\t\treturn radiance;\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log(attenuationColor) / attenuationDistance;\n\t\t\tvec3 transmittance = exp(-attenuationCoefficient * transmissionDistance);\t\t\treturn transmittance * radiance;\n\t\t}\n\t}\n\tvec3 getIBLVolumeRefraction(vec3 n, vec3 v, float perceptualRoughness, vec3 baseColor, vec3 specularColor,\n\t\tvec3 position, mat4 modelMatrix, mat4 viewMatrix, mat4 projMatrix, float ior, float thickness,\n\t\tvec3 attenuationColor, float attenuationDistance) {\n\t\tvec3 transmissionRay = getVolumeTransmissionRay(n, v, thickness, ior, modelMatrix);\n\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4(refractedRayExit, 1.0);\n\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\trefractionCoords += 1.0;\n\t\trefractionCoords /= 2.0;\n\t\tvec3 transmittedLight = getTransmissionSample(refractionCoords, perceptualRoughness, ior);\n\t\tvec3 attenuatedColor = applyVolumeAttenuation(transmittedLight, length(transmissionRay), attenuationColor, attenuationDistance);\n\t\treturn (1.0 - specularColor) * attenuatedColor * baseColor;\n\t}\n#endif",uv_pars_fragment:"#if ( defined( USE_UV ) && ! defined( UVS_VERTEX_ONLY ) )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#ifdef USE_UV\n\t#ifdef UVS_VERTEX_ONLY\n\t\tvec2 vUv;\n\t#else\n\t\tvarying vec2 vUv;\n\t#endif\n\tuniform mat3 uvTransform;\n#endif",uv_vertex:"#ifdef USE_UV\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n\tuniform mat3 uv2Transform;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = ( uv2Transform * vec3( uv2, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION )\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_frag:"uniform sampler2D t2D;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",cube_frag:"#include <envmap_common_pars_fragment>\nuniform float opacity;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\tvec3 vReflect = vWorldDirection;\n\t#include <envmap_fragment>\n\tgl_FragColor = envColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tvec4 texColor = texture2D( tEquirect, sampleUV );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;\n\t#else\n\t\treflectedLight.indirectDiffuse += vIndirectFront;\n\t#endif\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t\tmatcapColor = matcapTexelToLinear( matcapColor );\n\t#else\n\t\tvec4 matcapColor = vec4( 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#ifndef FLAT_SHADED\n\t\tvNormal = normalize( transformedNormal );\n\t\t#ifdef USE_TANGENT\n\t\t\tvTangent = normalize( transformedTangent );\n\t\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t\t#endif\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define REFLECTIVITY\n\t#define CLEARCOAT\n\t#define SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationTint;\n#endif\n#ifdef REFLECTIVITY\n\tuniform float reflectivity;\n#endif\n#ifdef SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularTint;\n\t#ifdef USE_SPECULARINTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n\t#ifdef USE_SPECULARTINTMAP\n\t\tuniform sampler2D specularTintMap;\n\t#endif\n#endif\n#ifdef CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheen;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <transmission_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#ifdef USE_TRANSMISSION\n\tvarying vec4 vWorldPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition;\n#endif\n}",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}",normal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",shadow_vert:"#include <common>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}"},Ci={common:{diffuse:{value:new $t(16777215)},opacity:{value:1},map:{value:null},uvTransform:{value:new $},uv2Transform:{value:new $},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new Q(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new $t(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new $t(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},uvTransform:{value:new $}},sprite:{diffuse:{value:new $t(16777215)},opacity:{value:1},center:{value:new Q(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},uvTransform:{value:new $}}},Li={basic:{uniforms:Ue([Ci.common,Ci.specularmap,Ci.envmap,Ci.aomap,Ci.lightmap,Ci.fog]),vertexShader:Ti.meshbasic_vert,fragmentShader:Ti.meshbasic_frag},lambert:{uniforms:Ue([Ci.common,Ci.specularmap,Ci.envmap,Ci.aomap,Ci.lightmap,Ci.emissivemap,Ci.fog,Ci.lights,{emissive:{value:new $t(0)}}]),vertexShader:Ti.meshlambert_vert,fragmentShader:Ti.meshlambert_frag},phong:{uniforms:Ue([Ci.common,Ci.specularmap,Ci.envmap,Ci.aomap,Ci.lightmap,Ci.emissivemap,Ci.bumpmap,Ci.normalmap,Ci.displacementmap,Ci.fog,Ci.lights,{emissive:{value:new $t(0)},specular:{value:new $t(1118481)},shininess:{value:30}}]),vertexShader:Ti.meshphong_vert,fragmentShader:Ti.meshphong_frag},standard:{uniforms:Ue([Ci.common,Ci.envmap,Ci.aomap,Ci.lightmap,Ci.emissivemap,Ci.bumpmap,Ci.normalmap,Ci.displacementmap,Ci.roughnessmap,Ci.metalnessmap,Ci.fog,Ci.lights,{emissive:{value:new $t(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Ti.meshphysical_vert,fragmentShader:Ti.meshphysical_frag},toon:{uniforms:Ue([Ci.common,Ci.aomap,Ci.lightmap,Ci.emissivemap,Ci.bumpmap,Ci.normalmap,Ci.displacementmap,Ci.gradientmap,Ci.fog,Ci.lights,{emissive:{value:new $t(0)}}]),vertexShader:Ti.meshtoon_vert,fragmentShader:Ti.meshtoon_frag},matcap:{uniforms:Ue([Ci.common,Ci.bumpmap,Ci.normalmap,Ci.displacementmap,Ci.fog,{matcap:{value:null}}]),vertexShader:Ti.meshmatcap_vert,fragmentShader:Ti.meshmatcap_frag},points:{uniforms:Ue([Ci.points,Ci.fog]),vertexShader:Ti.points_vert,fragmentShader:Ti.points_frag},dashed:{uniforms:Ue([Ci.common,Ci.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Ti.linedashed_vert,fragmentShader:Ti.linedashed_frag},depth:{uniforms:Ue([Ci.common,Ci.displacementmap]),vertexShader:Ti.depth_vert,fragmentShader:Ti.depth_frag},normal:{uniforms:Ue([Ci.common,Ci.bumpmap,Ci.normalmap,Ci.displacementmap,{opacity:{value:1}}]),vertexShader:Ti.normal_vert,fragmentShader:Ti.normal_frag},sprite:{uniforms:Ue([Ci.sprite,Ci.fog]),vertexShader:Ti.sprite_vert,fragmentShader:Ti.sprite_frag},background:{uniforms:{uvTransform:{value:new $},t2D:{value:null}},vertexShader:Ti.background_vert,fragmentShader:Ti.background_frag},cube:{uniforms:Ue([Ci.envmap,{opacity:{value:1}}]),vertexShader:Ti.cube_vert,fragmentShader:Ti.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Ti.equirect_vert,fragmentShader:Ti.equirect_frag},distanceRGBA:{uniforms:Ue([Ci.common,Ci.displacementmap,{referencePosition:{value:new ot},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Ti.distanceRGBA_vert,fragmentShader:Ti.distanceRGBA_frag},shadow:{uniforms:Ue([Ci.lights,Ci.fog,{color:{value:new $t(0)},opacity:{value:1}}]),vertexShader:Ti.shadow_vert,fragmentShader:Ti.shadow_frag}};function Ai(t,e,i,n,r){const s=new $t(0);let a,o,l=0,h=null,c=0,u=null;function d(t,e){i.buffers.color.setClear(t.r,t.g,t.b,e,r)}return{getClearColor:function(){return s},setClearColor:function(t,e=1){s.set(t),l=e,d(s,l)},getClearAlpha:function(){return l},setClearAlpha:function(t){l=t,d(s,l)},render:function(i,r){let p=!1,f=!0===r.isScene?r.background:null;f&&f.isTexture&&(f=e.get(f));const m=t.xr,g=m.getSession&&m.getSession();g&&"additive"===g.environmentBlendMode&&(f=null),null===f?d(s,l):f&&f.isColor&&(d(f,1),p=!0),(t.autoClear||p)&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),f&&(f.isCubeTexture||f.mapping===v)?(void 0===o&&(o=new wi(new Ne(1,1,1),new ke({name:"BackgroundCubeMaterial",uniforms:ze(Li.cube.uniforms),vertexShader:Li.cube.vertexShader,fragmentShader:Li.cube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1})),o.geometry.deleteAttribute("normal"),o.geometry.deleteAttribute("uv"),o.onBeforeRender=function(t,e,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(o.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),n.update(o)),o.material.uniforms.envMap.value=f,o.material.uniforms.flipEnvMap.value=f.isCubeTexture&&!1===f.isRenderTargetTexture?-1:1,h===f&&c===f.version&&u===t.toneMapping||(o.material.needsUpdate=!0,h=f,c=f.version,u=t.toneMapping),i.unshift(o,o.geometry,o.material,0,0,null)):f&&f.isTexture&&(void 0===a&&(a=new wi(new Ie(2,2),new ke({name:"BackgroundMaterial",uniforms:ze(Li.background.uniforms),vertexShader:Li.background.vertexShader,fragmentShader:Li.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1})),a.geometry.deleteAttribute("normal"),Object.defineProperty(a.material,"map",{get:function(){return this.uniforms.t2D.value}}),n.update(a)),a.material.uniforms.t2D.value=f,!0===f.matrixAutoUpdate&&f.updateMatrix(),a.material.uniforms.uvTransform.value.copy(f.matrix),h===f&&c===f.version&&u===t.toneMapping||(a.material.needsUpdate=!0,h=f,c=f.version,u=t.toneMapping),i.unshift(a,a.geometry,a.material,0,0,null))}}}function Ri(t,e,i,n){const r=t.getParameter(t.MAX_VERTEX_ATTRIBS),s=n.isWebGL2?null:e.get("OES_vertex_array_object"),a=n.isWebGL2||null!==s,o={},l=d(null);let h=l;function c(e){return n.isWebGL2?t.bindVertexArray(e):s.bindVertexArrayOES(e)}function u(e){return n.isWebGL2?t.deleteVertexArray(e):s.deleteVertexArrayOES(e)}function d(t){const e=[],i=[],n=[];for(let t=0;t<r;t++)e[t]=0,i[t]=0,n[t]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:e,enabledAttributes:i,attributeDivisors:n,object:t,attributes:{},index:null}}function p(){const t=h.newAttributes;for(let e=0,i=t.length;e<i;e++)t[e]=0}function f(t){m(t,0)}function m(i,r){const s=h.newAttributes,a=h.enabledAttributes,o=h.attributeDivisors;if(s[i]=1,0===a[i]&&(t.enableVertexAttribArray(i),a[i]=1),o[i]!==r){(n.isWebGL2?t:e.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](i,r),o[i]=r}}function g(){const e=h.newAttributes,i=h.enabledAttributes;for(let n=0,r=i.length;n<r;n++)i[n]!==e[n]&&(t.disableVertexAttribArray(n),i[n]=0)}function v(e,i,r,s,a,o){!0!==n.isWebGL2||r!==t.INT&&r!==t.UNSIGNED_INT?t.vertexAttribPointer(e,i,r,s,a,o):t.vertexAttribIPointer(e,i,r,a,o)}function y(){x(),h!==l&&(h=l,c(h.object))}function x(){l.geometry=null,l.program=null,l.wireframe=!1}return{setup:function(r,l,u,y,x){let _=!1;if(a){const e=function(e,i,r){const a=!0===r.wireframe;let l=o[e.id];void 0===l&&(l={},o[e.id]=l);let h=l[i.id];void 0===h&&(h={},l[i.id]=h);let c=h[a];void 0===c&&(c=d(n.isWebGL2?t.createVertexArray():s.createVertexArrayOES()),h[a]=c);return c}(y,u,l);h!==e&&(h=e,c(h.object)),_=function(t,e){const i=h.attributes,n=t.attributes;let r=0;for(const t in n){const e=i[t],s=n[t];if(void 0===e)return!0;if(e.attribute!==s)return!0;if(e.data!==s.data)return!0;r++}return h.attributesNum!==r||h.index!==e}(y,x),_&&function(t,e){const i={},n=t.attributes;let r=0;for(const t in n){const e=n[t],s={};s.attribute=e,e.data&&(s.data=e.data),i[t]=s,r++}h.attributes=i,h.attributesNum=r,h.index=e}(y,x)}else{const t=!0===l.wireframe;h.geometry===y.id&&h.program===u.id&&h.wireframe===t||(h.geometry=y.id,h.program=u.id,h.wireframe=t,_=!0)}!0===r.isInstancedMesh&&(_=!0),null!==x&&i.update(x,t.ELEMENT_ARRAY_BUFFER),_&&(!function(r,s,a,o){if(!1===n.isWebGL2&&(r.isInstancedMesh||o.isInstancedBufferGeometry)&&null===e.get("ANGLE_instanced_arrays"))return;p();const l=o.attributes,h=a.getAttributes(),c=s.defaultAttributeValues;for(const e in h){const n=h[e];if(n>=0){const s=l[e];if(void 0!==s){const e=s.normalized,r=s.itemSize,a=i.get(s);if(void 0===a)continue;const l=a.buffer,h=a.type,c=a.bytesPerElement;if(s.isInterleavedBufferAttribute){const i=s.data,a=i.stride,u=s.offset;i&&i.isInstancedInterleavedBuffer?(m(n,i.meshPerAttribute),void 0===o._maxInstanceCount&&(o._maxInstanceCount=i.meshPerAttribute*i.count)):f(n),t.bindBuffer(t.ARRAY_BUFFER,l),v(n,r,h,e,a*c,u*c)}else s.isInstancedBufferAttribute?(m(n,s.meshPerAttribute),void 0===o._maxInstanceCount&&(o._maxInstanceCount=s.meshPerAttribute*s.count)):f(n),t.bindBuffer(t.ARRAY_BUFFER,l),v(n,r,h,e,0,0)}else if("instanceMatrix"===e){const e=i.get(r.instanceMatrix);if(void 0===e)continue;const s=e.buffer,a=e.type;m(n+0,1),m(n+1,1),m(n+2,1),m(n+3,1),t.bindBuffer(t.ARRAY_BUFFER,s),t.vertexAttribPointer(n+0,4,a,!1,64,0),t.vertexAttribPointer(n+1,4,a,!1,64,16),t.vertexAttribPointer(n+2,4,a,!1,64,32),t.vertexAttribPointer(n+3,4,a,!1,64,48)}else if("instanceColor"===e){const e=i.get(r.instanceColor);if(void 0===e)continue;const s=e.buffer,a=e.type;m(n,1),t.bindBuffer(t.ARRAY_BUFFER,s),t.vertexAttribPointer(n,3,a,!1,12,0)}else if(void 0!==c){const i=c[e];if(void 0!==i)switch(i.length){case 2:t.vertexAttrib2fv(n,i);break;case 3:t.vertexAttrib3fv(n,i);break;case 4:t.vertexAttrib4fv(n,i);break;default:t.vertexAttrib1fv(n,i)}}}}g()}(r,l,u,y),null!==x&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i.get(x).buffer))},reset:y,resetDefaultState:x,dispose:function(){y();for(const t in o){const e=o[t];for(const t in e){const i=e[t];for(const t in i)u(i[t].object),delete i[t];delete e[t]}delete o[t]}},releaseStatesOfGeometry:function(t){if(void 0===o[t.id])return;const e=o[t.id];for(const t in e){const i=e[t];for(const t in i)u(i[t].object),delete i[t];delete e[t]}delete o[t.id]},releaseStatesOfProgram:function(t){for(const e in o){const i=o[e];if(void 0===i[t.id])continue;const n=i[t.id];for(const t in n)u(n[t].object),delete n[t];delete i[t.id]}},initAttributes:p,enableAttribute:f,disableUnusedAttributes:g}}function Pi(t,e,i,n){const r=n.isWebGL2;let s;this.setMode=function(t){s=t},this.render=function(e,n){t.drawArrays(s,e,n),i.update(n,s,1)},this.renderInstances=function(n,a,o){if(0===o)return;let l,h;if(r)l=t,h="drawArraysInstanced";else if(l=e.get("ANGLE_instanced_arrays"),h="drawArraysInstancedANGLE",null===l)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");l[h](s,n,a,o),i.update(a,s,o)}}function Di(t,e,i){let n;function r(e){if("highp"===e){if(t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0)return"highp";e="mediump"}return"mediump"===e&&t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}const s="undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||"undefined"!=typeof WebGL2ComputeRenderingContext&&t instanceof WebGL2ComputeRenderingContext;let a=void 0!==i.precision?i.precision:"highp";const o=r(a);o!==a&&(console.warn("THREE.WebGLRenderer:",a,"not supported, using",o,"instead."),a=o);const l=s||e.has("WEBGL_draw_buffers"),h=!0===i.logarithmicDepthBuffer,c=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),u=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),d=t.getParameter(t.MAX_TEXTURE_SIZE),p=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),f=t.getParameter(t.MAX_VERTEX_ATTRIBS),m=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),g=t.getParameter(t.MAX_VARYING_VECTORS),v=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),y=u>0,x=s||e.has("OES_texture_float");return{isWebGL2:s,drawBuffers:l,getMaxAnisotropy:function(){if(void 0!==n)return n;if(!0===e.has("EXT_texture_filter_anisotropic")){const i=e.get("EXT_texture_filter_anisotropic");n=t.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else n=0;return n},getMaxPrecision:r,precision:a,logarithmicDepthBuffer:h,maxTextures:c,maxVertexTextures:u,maxTextureSize:d,maxCubemapSize:p,maxAttributes:f,maxVertexUniforms:m,maxVaryings:g,maxFragmentUniforms:v,vertexTextures:y,floatFragmentTextures:x,floatVertexTextures:y&&x,maxSamples:s?t.getParameter(t.MAX_SAMPLES):0}}function Ni(t){const e=this;let i=null,n=0,r=!1,s=!1;const a=new Nt,o=new $,l={value:null,needsUpdate:!1};function h(){l.value!==i&&(l.value=i,l.needsUpdate=n>0),e.numPlanes=n,e.numIntersection=0}function c(t,i,n,r){const s=null!==t?t.length:0;let h=null;if(0!==s){if(h=l.value,!0!==r||null===h){const e=n+4*s,r=i.matrixWorldInverse;o.getNormalMatrix(r),(null===h||h.length<e)&&(h=new Float32Array(e));for(let e=0,i=n;e!==s;++e,i+=4)a.copy(t[e]).applyMatrix4(r,o),a.normal.toArray(h,i),h[i+3]=a.constant}l.value=h,l.needsUpdate=!0}return e.numPlanes=s,e.numIntersection=0,h}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(t,e,s){const a=0!==t.length||e||0!==n||r;return r=e,i=c(t,s,0),n=t.length,a},this.beginShadows=function(){s=!0,c(null)},this.endShadows=function(){s=!1,h()},this.setState=function(e,a,o){const u=e.clippingPlanes,d=e.clipIntersection,p=e.clipShadows,f=t.get(e);if(!r||null===u||0===u.length||s&&!p)s?c(null):h();else{const t=s?0:n,e=4*t;let r=f.clippingState||null;l.value=r,r=c(u,a,e,o);for(let t=0;t!==e;++t)r[t]=i[t];f.clippingState=r,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=t}}}Li.physical={uniforms:Ue([Li.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new Q(1,1)},clearcoatNormalMap:{value:null},sheen:{value:new $t(0)},transmission:{value:0},transmissionMap:{value:null},transmissionSamplerSize:{value:new Q},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},attenuationDistance:{value:0},attenuationTint:{value:new $t(0)},specularIntensity:{value:0},specularIntensityMap:{value:null},specularTint:{value:new $t(1,1,1)},specularTintMap:{value:null}}]),vertexShader:Ti.meshphysical_vert,fragmentShader:Ti.meshphysical_frag};class Ii extends Se{constructor(){super(),this.type="Camera",this.matrixWorldInverse=new zt,this.projectionMatrix=new zt,this.projectionMatrixInverse=new zt}copy(t,e){return super.copy(t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(-e[8],-e[9],-e[10]).normalize()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}Ii.prototype.isCamera=!0;class Fi extends Ii{constructor(t=50,e=1,i=.1,n=2e3){super(),this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=i,this.far=n,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this}setFocalLength(t){const e=.5*this.getFilmHeight()/t;this.fov=2*W*Math.atan(e),this.updateProjectionMatrix()}getFocalLength(){const t=Math.tan(.5*V*this.fov);return.5*this.getFilmHeight()/t}getEffectiveFOV(){return 2*W*Math.atan(Math.tan(.5*V*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(t,e,i,n,r,s){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=this.near;let e=t*Math.tan(.5*V*this.fov)/this.zoom,i=2*e,n=this.aspect*i,r=-.5*n;const s=this.view;if(null!==this.view&&this.view.enabled){const t=s.fullWidth,a=s.fullHeight;r+=s.offsetX*n/t,e-=s.offsetY*i/a,n*=s.width/t,i*=s.height/a}const a=this.filmOffset;0!==a&&(r+=t*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+n,e,e-i,t,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}Fi.prototype.isPerspectiveCamera=!0;const Oi=90;class zi extends Se{constructor(t,e,i){if(super(),this.type="CubeCamera",!0!==i.isWebGLCubeRenderTarget)return void console.error("THREE.CubeCamera: The constructor now expects an instance of WebGLCubeRenderTarget as third parameter.");this.renderTarget=i;const n=new Fi(Oi,1,t,e);n.layers=this.layers,n.up.set(0,-1,0),n.lookAt(new ot(1,0,0)),this.add(n);const r=new Fi(Oi,1,t,e);r.layers=this.layers,r.up.set(0,-1,0),r.lookAt(new ot(-1,0,0)),this.add(r);const s=new Fi(Oi,1,t,e);s.layers=this.layers,s.up.set(0,0,1),s.lookAt(new ot(0,1,0)),this.add(s);const a=new Fi(Oi,1,t,e);a.layers=this.layers,a.up.set(0,0,-1),a.lookAt(new ot(0,-1,0)),this.add(a);const o=new Fi(Oi,1,t,e);o.layers=this.layers,o.up.set(0,-1,0),o.lookAt(new ot(0,0,1)),this.add(o);const l=new Fi(Oi,1,t,e);l.layers=this.layers,l.up.set(0,-1,0),l.lookAt(new ot(0,0,-1)),this.add(l)}update(t,e){null===this.parent&&this.updateMatrixWorld();const i=this.renderTarget,[n,r,s,a,o,l]=this.children,h=t.xr.enabled,c=t.getRenderTarget();t.xr.enabled=!1;const u=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,t.setRenderTarget(i,0),t.render(e,n),t.setRenderTarget(i,1),t.render(e,r),t.setRenderTarget(i,2),t.render(e,s),t.setRenderTarget(i,3),t.render(e,a),t.setRenderTarget(i,4),t.render(e,o),i.texture.generateMipmaps=u,t.setRenderTarget(i,5),t.render(e,l),t.setRenderTarget(c),t.xr.enabled=h}}class Ui extends it{constructor(t,e,i,n,r,s,a,o,l,h){super(t=void 0!==t?t:[],e=void 0!==e?e:m,i,n,r,s,a=void 0!==a?a:R,o,l,h),this.flipY=!1}get images(){return this.image}set images(t){this.image=t}}Ui.prototype.isCubeTexture=!0;class Bi extends st{constructor(t,e,i){Number.isInteger(e)&&(console.warn("THREE.WebGLCubeRenderTarget: constructor signature is now WebGLCubeRenderTarget( size, options )"),e=i),super(t,t,e),e=e||{},this.texture=new Ui(void 0,e.mapping,e.wrapS,e.wrapT,e.magFilter,e.minFilter,e.format,e.type,e.anisotropy,e.encoding),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==e.generateMipmaps&&e.generateMipmaps,this.texture.minFilter=void 0!==e.minFilter?e.minFilter:b,this.texture._needsFlipEnvMap=!1}fromEquirectangularTexture(t,e){this.texture.type=e.type,this.texture.format=P,this.texture.encoding=e.encoding,this.texture.generateMipmaps=e.generateMipmaps,this.texture.minFilter=e.minFilter,this.texture.magFilter=e.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},n=new Ne(5,5,5),r=new ke({name:"CubemapFromEquirect",uniforms:ze(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:1,blending:0});r.uniforms.tEquirect.value=e;const s=new wi(n,r),a=e.minFilter;e.minFilter===S&&(e.minFilter=b);return new zi(1,10,this).update(t,s),e.minFilter=a,s.geometry.dispose(),s.material.dispose(),this}clear(t,e,i,n){const r=t.getRenderTarget();for(let r=0;r<6;r++)t.setRenderTarget(this,r),t.clear(e,i,n);t.setRenderTarget(r)}}function ki(t){let e=new WeakMap;function i(t,e){return 303===e?t.mapping=m:304===e&&(t.mapping=g),t}function n(t){const i=t.target;i.removeEventListener("dispose",n);const r=e.get(i);void 0!==r&&(e.delete(i),r.dispose())}return{get:function(r){if(r&&r.isTexture&&!1===r.isRenderTargetTexture){const s=r.mapping;if(303===s||304===s){if(e.has(r)){return i(e.get(r).texture,r.mapping)}{const s=r.image;if(s&&s.height>0){const a=t.getRenderTarget(),o=new Bi(s.height/2);return o.fromEquirectangularTexture(t,r),e.set(r,o),t.setRenderTarget(a),r.addEventListener("dispose",n),i(o.texture,r.mapping)}return null}}}return r},dispose:function(){e=new WeakMap}}}Bi.prototype.isWebGLCubeRenderTarget=!0;class Gi extends Ii{constructor(t=-1,e=1,i=1,n=-1,r=.1,s=2e3){super(),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=i,this.bottom=n,this.near=r,this.far=s,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this}setViewOffset(t,e,i,n,r,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2;let r=i-t,s=i+t,a=n+e,o=n-e;if(null!==this.view&&this.view.enabled){const t=(this.right-this.left)/this.view.fullWidth/this.zoom,e=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=t*this.view.offsetX,s=r+t*this.view.width,a-=e*this.view.offsetY,o=a-e*this.view.height}this.projectionMatrix.makeOrthographic(r,s,a,o,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}Gi.prototype.isOrthographicCamera=!0;class Hi extends ke{constructor(t){super(t),this.type="RawShaderMaterial"}}Hi.prototype.isRawShaderMaterial=!0;const Vi=Math.pow(2,8),Wi=[.125,.215,.35,.446,.526,.582],ji=5+Wi.length,Xi=20,qi={[I]:0,[F]:1,[z]:2,3004:3,3005:4,3006:5,[O]:6},Yi=new ai({side:1,depthWrite:!1,depthTest:!1}),Zi=new wi(new Ne,Yi),Ji=new Gi,{_lodPlanes:Ki,_sizeLods:Qi,_sigmas:$i}=hn(),tn=new $t;let en=null;const nn=(1+Math.sqrt(5))/2,rn=1/nn,sn=[new ot(1,1,1),new ot(-1,1,1),new ot(1,1,-1),new ot(-1,1,-1),new ot(0,nn,rn),new ot(0,nn,-rn),new ot(rn,0,nn),new ot(-rn,0,nn),new ot(nn,rn,0),new ot(-nn,rn,0)];function an(t){const e=Math.max(t.r,t.g,t.b),i=Math.min(Math.max(Math.ceil(Math.log2(e)),-128),127);t.multiplyScalar(Math.pow(2,-i));return(i+128)/255}class on{constructor(t){this._renderer=t,this._pingPongRenderTarget=null,this._blurMaterial=function(t){const e=new Float32Array(t),i=new ot(0,1,0);return new Hi({name:"SphericalGaussianBlur",defines:{n:t},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:e},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:i},inputEncoding:{value:qi[3e3]},outputEncoding:{value:qi[3e3]}},vertexShader:fn(),fragmentShader:`\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t${mn()}\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t\tgl_FragColor = linearToOutputTexel( gl_FragColor );\n\n\t\t\t}\n\t\t`,blending:0,depthTest:!1,depthWrite:!1})}(Xi),this._equirectShader=null,this._cubemapShader=null,this._compileMaterial(this._blurMaterial)}fromScene(t,e=0,i=.1,n=100){en=this._renderer.getRenderTarget();const r=this._allocateTargets();return this._sceneToCubeUV(t,i,n,r),e>0&&this._blur(r,0,0,e),this._applyPMREM(r),this._cleanup(r),r}fromEquirectangular(t){return this._fromTexture(t)}fromCubemap(t){return this._fromTexture(t)}compileCubemapShader(){null===this._cubemapShader&&(this._cubemapShader=pn(),this._compileMaterial(this._cubemapShader))}compileEquirectangularShader(){null===this._equirectShader&&(this._equirectShader=dn(),this._compileMaterial(this._equirectShader))}dispose(){this._blurMaterial.dispose(),null!==this._cubemapShader&&this._cubemapShader.dispose(),null!==this._equirectShader&&this._equirectShader.dispose();for(let t=0;t<Ki.length;t++)Ki[t].dispose()}_cleanup(t){this._pingPongRenderTarget.dispose(),this._renderer.setRenderTarget(en),t.scissorTest=!1,un(t,0,0,t.width,t.height)}_fromTexture(t){en=this._renderer.getRenderTarget();const e=this._allocateTargets(t);return this._textureToCubeUV(t,e),this._applyPMREM(e),this._cleanup(e),e}_allocateTargets(t){const e={magFilter:M,minFilter:M,generateMipmaps:!1,type:w,format:1023,encoding:ln(t)?t.encoding:z,depthBuffer:!1},i=cn(e);return i.depthBuffer=!t,this._pingPongRenderTarget=cn(e),i}_compileMaterial(t){const e=new wi(Ki[0],t);this._renderer.compile(e,Ji)}_sceneToCubeUV(t,e,i,n){const r=new Fi(90,1,e,i),s=[1,-1,1,1,1,1],a=[1,1,1,-1,-1,-1],o=this._renderer,l=o.autoClear,h=o.outputEncoding,c=o.toneMapping;o.getClearColor(tn),o.toneMapping=0,o.outputEncoding=I,o.autoClear=!1;let u=!1;const d=t.background;if(d){if(d.isColor){Yi.color.copy(d).convertSRGBToLinear(),t.background=null;const e=an(Yi.color);Yi.opacity=e,u=!0}}else{Yi.color.copy(tn).convertSRGBToLinear();const t=an(Yi.color);Yi.opacity=t,u=!0}for(let e=0;e<6;e++){const i=e%3;0==i?(r.up.set(0,s[e],0),r.lookAt(a[e],0,0)):1==i?(r.up.set(0,0,s[e]),r.lookAt(0,a[e],0)):(r.up.set(0,s[e],0),r.lookAt(0,0,a[e])),un(n,i*Vi,e>2?Vi:0,Vi,Vi),o.setRenderTarget(n),u&&o.render(Zi,r),o.render(t,r)}o.toneMapping=c,o.outputEncoding=h,o.autoClear=l}_textureToCubeUV(t,e){const i=this._renderer;t.isCubeTexture?null==this._cubemapShader&&(this._cubemapShader=pn()):null==this._equirectShader&&(this._equirectShader=dn());const n=t.isCubeTexture?this._cubemapShader:this._equirectShader,r=new wi(Ki[0],n),s=n.uniforms;s.envMap.value=t,t.isCubeTexture||s.texelSize.value.set(1/t.image.width,1/t.image.height),s.inputEncoding.value=qi[t.encoding],s.outputEncoding.value=qi[e.texture.encoding],un(e,0,0,3*Vi,2*Vi),i.setRenderTarget(e),i.render(r,Ji)}_applyPMREM(t){const e=this._renderer,i=e.autoClear;e.autoClear=!1;for(let e=1;e<ji;e++){const i=Math.sqrt($i[e]*$i[e]-$i[e-1]*$i[e-1]),n=sn[(e-1)%sn.length];this._blur(t,e-1,e,i,n)}e.autoClear=i}_blur(t,e,i,n,r){const s=this._pingPongRenderTarget;this._halfBlur(t,s,e,i,n,"latitudinal",r),this._halfBlur(s,t,i,i,n,"longitudinal",r)}_halfBlur(t,e,i,n,r,s,a){const o=this._renderer,l=this._blurMaterial;"latitudinal"!==s&&"longitudinal"!==s&&console.error("blur direction must be either latitudinal or longitudinal!");const h=new wi(Ki[n],l),c=l.uniforms,u=Qi[i]-1,d=isFinite(r)?Math.PI/(2*u):2*Math.PI/39,p=r/d,f=isFinite(r)?1+Math.floor(3*p):Xi;f>Xi&&console.warn(`sigmaRadians, ${r}, is too large and will clip, as it requested ${f} samples when the maximum is set to 20`);const m=[];let g=0;for(let t=0;t<Xi;++t){const e=t/p,i=Math.exp(-e*e/2);m.push(i),0==t?g+=i:t<f&&(g+=2*i)}for(let t=0;t<m.length;t++)m[t]=m[t]/g;c.envMap.value=t.texture,c.samples.value=f,c.weights.value=m,c.latitudinal.value="latitudinal"===s,a&&(c.poleAxis.value=a),c.dTheta.value=d,c.mipInt.value=8-i,c.inputEncoding.value=qi[t.texture.encoding],c.outputEncoding.value=qi[t.texture.encoding];const v=Qi[n];un(e,3*Math.max(0,Vi-2*v),(0===n?0:2*Vi)+2*v*(n>4?n-8+4:0),3*v,2*v),o.setRenderTarget(e),o.render(h,Ji)}}function ln(t){return void 0!==t&&t.type===w&&(t.encoding===I||t.encoding===F||t.encoding===O)}function hn(){const t=[],e=[],i=[];let n=8;for(let r=0;r<ji;r++){const s=Math.pow(2,n);e.push(s);let a=1/s;r>4?a=Wi[r-8+4-1]:0==r&&(a=0),i.push(a);const o=1/(s-1),l=-o/2,h=1+o/2,c=[l,l,h,l,h,h,l,l,h,h,l,h],u=6,d=6,p=3,f=2,m=1,g=new Float32Array(p*d*u),v=new Float32Array(f*d*u),y=new Float32Array(m*d*u);for(let t=0;t<u;t++){const e=t%3*2/3-1,i=t>2?0:-1,n=[e,i,0,e+2/3,i,0,e+2/3,i+1,0,e,i,0,e+2/3,i+1,0,e,i+1,0];g.set(n,p*d*t),v.set(c,f*d*t);const r=[t,t,t,t,t,t];y.set(r,m*d*t)}const x=new De;x.setAttribute("position",new ie(g,p)),x.setAttribute("uv",new ie(v,f)),x.setAttribute("faceIndex",new ie(y,m)),t.push(x),n>4&&n--}return{_lodPlanes:t,_sizeLods:e,_sigmas:i}}function cn(t){const e=new st(3*Vi,3*Vi,t);return e.texture.mapping=v,e.texture.name="PMREM.cubeUv",e.scissorTest=!0,e}function un(t,e,i,n,r){t.viewport.set(e,i,n,r),t.scissor.set(e,i,n,r)}function dn(){const t=new Q(1,1);return new Hi({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null},texelSize:{value:t},inputEncoding:{value:qi[3e3]},outputEncoding:{value:qi[3e3]}},vertexShader:fn(),fragmentShader:`\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform vec2 texelSize;\n\n\t\t\t${mn()}\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tvec2 f = fract( uv / texelSize - 0.5 );\n\t\t\t\tuv -= f * texelSize;\n\t\t\t\tvec3 tl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t\tuv.x += texelSize.x;\n\t\t\t\tvec3 tr = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t\tuv.y += texelSize.y;\n\t\t\t\tvec3 br = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t\tuv.x -= texelSize.x;\n\t\t\t\tvec3 bl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\n\t\t\t\tvec3 tm = mix( tl, tr, f.x );\n\t\t\t\tvec3 bm = mix( bl, br, f.x );\n\t\t\t\tgl_FragColor.rgb = mix( tm, bm, f.y );\n\n\t\t\t\tgl_FragColor = linearToOutputTexel( gl_FragColor );\n\n\t\t\t}\n\t\t`,blending:0,depthTest:!1,depthWrite:!1})}function pn(){return new Hi({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},inputEncoding:{value:qi[3e3]},outputEncoding:{value:qi[3e3]}},vertexShader:fn(),fragmentShader:`\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\t${mn()}\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb = envMapTexelToLinear( textureCube( envMap, vec3( - vOutputDirection.x, vOutputDirection.yz ) ) ).rgb;\n\t\t\t\tgl_FragColor = linearToOutputTexel( gl_FragColor );\n\n\t\t\t}\n\t\t`,blending:0,depthTest:!1,depthWrite:!1})}function fn(){return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute vec3 position;\n\t\tattribute vec2 uv;\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function mn(){return"\n\n\t\tuniform int inputEncoding;\n\t\tuniform int outputEncoding;\n\n\t\t#include <encodings_pars_fragment>\n\n\t\tvec4 inputTexelToLinear( vec4 value ) {\n\n\t\t\tif ( inputEncoding == 0 ) {\n\n\t\t\t\treturn value;\n\n\t\t\t} else if ( inputEncoding == 1 ) {\n\n\t\t\t\treturn sRGBToLinear( value );\n\n\t\t\t} else if ( inputEncoding == 2 ) {\n\n\t\t\t\treturn RGBEToLinear( value );\n\n\t\t\t} else if ( inputEncoding == 3 ) {\n\n\t\t\t\treturn RGBMToLinear( value, 7.0 );\n\n\t\t\t} else if ( inputEncoding == 4 ) {\n\n\t\t\t\treturn RGBMToLinear( value, 16.0 );\n\n\t\t\t} else if ( inputEncoding == 5 ) {\n\n\t\t\t\treturn RGBDToLinear( value, 256.0 );\n\n\t\t\t} else {\n\n\t\t\t\treturn GammaToLinear( value, 2.2 );\n\n\t\t\t}\n\n\t\t}\n\n\t\tvec4 linearToOutputTexel( vec4 value ) {\n\n\t\t\tif ( outputEncoding == 0 ) {\n\n\t\t\t\treturn value;\n\n\t\t\t} else if ( outputEncoding == 1 ) {\n\n\t\t\t\treturn LinearTosRGB( value );\n\n\t\t\t} else if ( outputEncoding == 2 ) {\n\n\t\t\t\treturn LinearToRGBE( value );\n\n\t\t\t} else if ( outputEncoding == 3 ) {\n\n\t\t\t\treturn LinearToRGBM( value, 7.0 );\n\n\t\t\t} else if ( outputEncoding == 4 ) {\n\n\t\t\t\treturn LinearToRGBM( value, 16.0 );\n\n\t\t\t} else if ( outputEncoding == 5 ) {\n\n\t\t\t\treturn LinearToRGBD( value, 256.0 );\n\n\t\t\t} else {\n\n\t\t\t\treturn LinearToGamma( value, 2.2 );\n\n\t\t\t}\n\n\t\t}\n\n\t\tvec4 envMapTexelToLinear( vec4 color ) {\n\n\t\t\treturn inputTexelToLinear( color );\n\n\t\t}\n\t"}function gn(t){let e=new WeakMap,i=null;function n(t){const i=t.target;i.removeEventListener("dispose",n);const r=e.get(i);void 0!==r&&(r.delete(i),r.dispose())}return{get:function(r){if(r&&r.isTexture&&!1===r.isRenderTargetTexture){const s=r.mapping,a=303===s||304===s,o=s===m||s===g;if(a||o){if(e.has(r))return e.get(r).texture;{const s=r.image;if(a&&s&&s.height>0||o&&s&&function(t){let e=0;const i=6;for(let n=0;n<i;n++)void 0!==t[n]&&e++;return e===i}(s)){const s=t.getRenderTarget();null===i&&(i=new on(t));const o=a?i.fromEquirectangular(r):i.fromCubemap(r);return e.set(r,o),t.setRenderTarget(s),r.addEventListener("dispose",n),o.texture}return null}}}return r},dispose:function(){e=new WeakMap,null!==i&&(i.dispose(),i=null)}}}function vn(t){const e={};function i(i){if(void 0!==e[i])return e[i];let n;switch(i){case"WEBGL_depth_texture":n=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=t.getExtension(i)}return e[i]=n,n}return{has:function(t){return null!==i(t)},init:function(t){t.isWebGL2?i("EXT_color_buffer_float"):(i("WEBGL_depth_texture"),i("OES_texture_float"),i("OES_texture_half_float"),i("OES_texture_half_float_linear"),i("OES_standard_derivatives"),i("OES_element_index_uint"),i("OES_vertex_array_object"),i("ANGLE_instanced_arrays")),i("OES_texture_float_linear"),i("EXT_color_buffer_half_float")},get:function(t){const e=i(t);return null===e&&console.warn("THREE.WebGLRenderer: "+t+" extension not supported."),e}}}function yn(t,e,i,n){const r={},s=new WeakMap;function a(t){const o=t.target;null!==o.index&&e.remove(o.index);for(const t in o.attributes)e.remove(o.attributes[t]);o.removeEventListener("dispose",a),delete r[o.id];const l=s.get(o);l&&(e.remove(l),s.delete(o)),n.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,i.memory.geometries--}function o(t){const i=[],n=t.index,r=t.attributes.position;let a=0;if(null!==n){const t=n.array;a=n.version;for(let e=0,n=t.length;e<n;e+=3){const n=t[e+0],r=t[e+1],s=t[e+2];i.push(n,r,r,s,s,n)}}else{const t=r.array;a=r.version;for(let e=0,n=t.length/3-1;e<n;e+=3){const t=e+0,n=e+1,r=e+2;i.push(t,n,n,r,r,t)}}const o=new(we(i)>65535?re:ne)(i,1);o.version=a;const l=s.get(t);l&&e.remove(l),s.set(t,o)}return{get:function(t,e){return!0===r[e.id]||(e.addEventListener("dispose",a),r[e.id]=!0,i.memory.geometries++),e},update:function(i){const n=i.attributes;for(const i in n)e.update(n[i],t.ARRAY_BUFFER);const r=i.morphAttributes;for(const i in r){const n=r[i];for(let i=0,r=n.length;i<r;i++)e.update(n[i],t.ARRAY_BUFFER)}},getWireframeAttribute:function(t){const e=s.get(t);if(e){const i=t.index;null!==i&&e.version<i.version&&o(t)}else o(t);return s.get(t)}}}function xn(t,e,i,n){const r=n.isWebGL2;let s,a,o;this.setMode=function(t){s=t},this.setIndex=function(t){a=t.type,o=t.bytesPerElement},this.render=function(e,n){t.drawElements(s,n,a,e*o),i.update(n,s,1)},this.renderInstances=function(n,l,h){if(0===h)return;let c,u;if(r)c=t,u="drawElementsInstanced";else if(c=e.get("ANGLE_instanced_arrays"),u="drawElementsInstancedANGLE",null===c)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");c[u](s,l,a,n*o,h),i.update(l,s,h)}}function _n(t){const e={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:e,programs:null,autoReset:!0,reset:function(){e.frame++,e.calls=0,e.triangles=0,e.points=0,e.lines=0},update:function(i,n,r){switch(e.calls++,n){case t.TRIANGLES:e.triangles+=r*(i/3);break;case t.LINES:e.lines+=r*(i/2);break;case t.LINE_STRIP:e.lines+=r*(i-1);break;case t.LINE_LOOP:e.lines+=r*i;break;case t.POINTS:e.points+=r*i;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",n)}}}}function Mn(t,e){return t[0]-e[0]}function bn(t,e){return Math.abs(e[1])-Math.abs(t[1])}function Sn(t){const e={},i=new Float32Array(8),n=[];for(let t=0;t<8;t++)n[t]=[t,0];return{update:function(r,s,a,o){const l=r.morphTargetInfluences,h=void 0===l?0:l.length;let c=e[s.id];if(void 0===c||c.length!==h){c=[];for(let t=0;t<h;t++)c[t]=[t,0];e[s.id]=c}for(let t=0;t<h;t++){const e=c[t];e[0]=t,e[1]=l[t]}c.sort(bn);for(let t=0;t<8;t++)t<h&&c[t][1]?(n[t][0]=c[t][0],n[t][1]=c[t][1]):(n[t][0]=Number.MAX_SAFE_INTEGER,n[t][1]=0);n.sort(Mn);const u=s.morphAttributes.position,d=s.morphAttributes.normal;let p=0;for(let t=0;t<8;t++){const e=n[t],r=e[0],a=e[1];r!==Number.MAX_SAFE_INTEGER&&a?(u&&s.getAttribute("morphTarget"+t)!==u[r]&&s.setAttribute("morphTarget"+t,u[r]),d&&s.getAttribute("morphNormal"+t)!==d[r]&&s.setAttribute("morphNormal"+t,d[r]),i[t]=a,p+=a):(u&&!0===s.hasAttribute("morphTarget"+t)&&s.deleteAttribute("morphTarget"+t),d&&!0===s.hasAttribute("morphNormal"+t)&&s.deleteAttribute("morphNormal"+t),i[t]=0)}const f=s.morphTargetsRelative?1:1-p;o.getUniforms().setValue(t,"morphTargetBaseInfluence",f),o.getUniforms().setValue(t,"morphTargetInfluences",i)}}}class wn extends st{constructor(t,e,i){super(t,e,i),this.samples=4}copy(t){return super.copy.call(this,t),this.samples=t.samples,this}}function En(t,e,i,n){let r=new WeakMap;function s(t){const e=t.target;e.removeEventListener("dispose",s),i.remove(e.instanceMatrix),null!==e.instanceColor&&i.remove(e.instanceColor)}return{update:function(a){const o=n.render.frame,l=a.geometry,h=e.get(a,l);return r.get(h)!==o&&(e.update(h),r.set(h,o)),a.isInstancedMesh&&(!1===a.hasEventListener("dispose",s)&&a.addEventListener("dispose",s),i.update(a.instanceMatrix,t.ARRAY_BUFFER),null!==a.instanceColor&&i.update(a.instanceColor,t.ARRAY_BUFFER)),h},dispose:function(){r=new WeakMap}}}wn.prototype.isWebGLMultisampleRenderTarget=!0;class Tn extends it{constructor(t=null,e=1,i=1,n=1){super(null),this.image={data:t,width:e,height:i,depth:n},this.magFilter=M,this.minFilter=M,this.wrapR=x,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}Tn.prototype.isDataTexture2DArray=!0;class Cn extends it{constructor(t=null,e=1,i=1,n=1){super(null),this.image={data:t,width:e,height:i,depth:n},this.magFilter=M,this.minFilter=M,this.wrapR=x,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}Cn.prototype.isDataTexture3D=!0;const Ln=new it,An=new Tn,Rn=new Cn,Pn=new Ui,Dn=[],Nn=[],In=new Float32Array(16),Fn=new Float32Array(9),On=new Float32Array(4);function zn(t,e,i){const n=t[0];if(n<=0||n>0)return t;const r=e*i;let s=Dn[r];if(void 0===s&&(s=new Float32Array(r),Dn[r]=s),0!==e){n.toArray(s,0);for(let n=1,r=0;n!==e;++n)r+=i,t[n].toArray(s,r)}return s}function Un(t,e){if(t.length!==e.length)return!1;for(let i=0,n=t.length;i<n;i++)if(t[i]!==e[i])return!1;return!0}function Bn(t,e){for(let i=0,n=e.length;i<n;i++)t[i]=e[i]}function kn(t,e){let i=Nn[e];void 0===i&&(i=new Int32Array(e),Nn[e]=i);for(let n=0;n!==e;++n)i[n]=t.allocateTextureUnit();return i}function Gn(t,e){const i=this.cache;i[0]!==e&&(t.uniform1f(this.addr,e),i[0]=e)}function Hn(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2f(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(Un(i,e))return;t.uniform2fv(this.addr,e),Bn(i,e)}}function Vn(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3f(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else if(void 0!==e.r)i[0]===e.r&&i[1]===e.g&&i[2]===e.b||(t.uniform3f(this.addr,e.r,e.g,e.b),i[0]=e.r,i[1]=e.g,i[2]=e.b);else{if(Un(i,e))return;t.uniform3fv(this.addr,e),Bn(i,e)}}function Wn(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(Un(i,e))return;t.uniform4fv(this.addr,e),Bn(i,e)}}function jn(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(Un(i,e))return;t.uniformMatrix2fv(this.addr,!1,e),Bn(i,e)}else{if(Un(i,n))return;On.set(n),t.uniformMatrix2fv(this.addr,!1,On),Bn(i,n)}}function Xn(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(Un(i,e))return;t.uniformMatrix3fv(this.addr,!1,e),Bn(i,e)}else{if(Un(i,n))return;Fn.set(n),t.uniformMatrix3fv(this.addr,!1,Fn),Bn(i,n)}}function qn(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(Un(i,e))return;t.uniformMatrix4fv(this.addr,!1,e),Bn(i,e)}else{if(Un(i,n))return;In.set(n),t.uniformMatrix4fv(this.addr,!1,In),Bn(i,n)}}function Yn(t,e){const i=this.cache;i[0]!==e&&(t.uniform1i(this.addr,e),i[0]=e)}function Zn(t,e){const i=this.cache;Un(i,e)||(t.uniform2iv(this.addr,e),Bn(i,e))}function Jn(t,e){const i=this.cache;Un(i,e)||(t.uniform3iv(this.addr,e),Bn(i,e))}function Kn(t,e){const i=this.cache;Un(i,e)||(t.uniform4iv(this.addr,e),Bn(i,e))}function Qn(t,e){const i=this.cache;i[0]!==e&&(t.uniform1ui(this.addr,e),i[0]=e)}function $n(t,e){const i=this.cache;Un(i,e)||(t.uniform2uiv(this.addr,e),Bn(i,e))}function tr(t,e){const i=this.cache;Un(i,e)||(t.uniform3uiv(this.addr,e),Bn(i,e))}function er(t,e){const i=this.cache;Un(i,e)||(t.uniform4uiv(this.addr,e),Bn(i,e))}function ir(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.safeSetTexture2D(e||Ln,r)}function nr(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture3D(e||Rn,r)}function rr(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.safeSetTextureCube(e||Pn,r)}function sr(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture2DArray(e||An,r)}function ar(t,e){t.uniform1fv(this.addr,e)}function or(t,e){const i=zn(e,this.size,2);t.uniform2fv(this.addr,i)}function lr(t,e){const i=zn(e,this.size,3);t.uniform3fv(this.addr,i)}function hr(t,e){const i=zn(e,this.size,4);t.uniform4fv(this.addr,i)}function cr(t,e){const i=zn(e,this.size,4);t.uniformMatrix2fv(this.addr,!1,i)}function ur(t,e){const i=zn(e,this.size,9);t.uniformMatrix3fv(this.addr,!1,i)}function dr(t,e){const i=zn(e,this.size,16);t.uniformMatrix4fv(this.addr,!1,i)}function pr(t,e){t.uniform1iv(this.addr,e)}function fr(t,e){t.uniform2iv(this.addr,e)}function mr(t,e){t.uniform3iv(this.addr,e)}function gr(t,e){t.uniform4iv(this.addr,e)}function vr(t,e){t.uniform1uiv(this.addr,e)}function yr(t,e){t.uniform2uiv(this.addr,e)}function xr(t,e){t.uniform3uiv(this.addr,e)}function _r(t,e){t.uniform4uiv(this.addr,e)}function Mr(t,e,i){const n=e.length,r=kn(i,n);t.uniform1iv(this.addr,r);for(let t=0;t!==n;++t)i.safeSetTexture2D(e[t]||Ln,r[t])}function br(t,e,i){const n=e.length,r=kn(i,n);t.uniform1iv(this.addr,r);for(let t=0;t!==n;++t)i.safeSetTextureCube(e[t]||Pn,r[t])}function Sr(t,e,i){this.id=t,this.addr=i,this.cache=[],this.setValue=function(t){switch(t){case 5126:return Gn;case 35664:return Hn;case 35665:return Vn;case 35666:return Wn;case 35674:return jn;case 35675:return Xn;case 35676:return qn;case 5124:case 35670:return Yn;case 35667:case 35671:return Zn;case 35668:case 35672:return Jn;case 35669:case 35673:return Kn;case 5125:return Qn;case 36294:return $n;case 36295:return tr;case 36296:return er;case 35678:case 36198:case 36298:case 36306:case 35682:return ir;case 35679:case 36299:case 36307:return nr;case 35680:case 36300:case 36308:case 36293:return rr;case 36289:case 36303:case 36311:case 36292:return sr}}(e.type)}function wr(t,e,i){this.id=t,this.addr=i,this.cache=[],this.size=e.size,this.setValue=function(t){switch(t){case 5126:return ar;case 35664:return or;case 35665:return lr;case 35666:return hr;case 35674:return cr;case 35675:return ur;case 35676:return dr;case 5124:case 35670:return pr;case 35667:case 35671:return fr;case 35668:case 35672:return mr;case 35669:case 35673:return gr;case 5125:return vr;case 36294:return yr;case 36295:return xr;case 36296:return _r;case 35678:case 36198:case 36298:case 36306:case 35682:return Mr;case 35680:case 36300:case 36308:case 36293:return br}}(e.type)}function Er(t){this.id=t,this.seq=[],this.map={}}wr.prototype.updateCache=function(t){const e=this.cache;t instanceof Float32Array&&e.length!==t.length&&(this.cache=new Float32Array(t.length)),Bn(e,t)},Er.prototype.setValue=function(t,e,i){const n=this.seq;for(let r=0,s=n.length;r!==s;++r){const s=n[r];s.setValue(t,e[s.id],i)}};const Tr=/(\w+)(\])?(\[|\.)?/g;function Cr(t,e){t.seq.push(e),t.map[e.id]=e}function Lr(t,e,i){const n=t.name,r=n.length;for(Tr.lastIndex=0;;){const s=Tr.exec(n),a=Tr.lastIndex;let o=s[1];const l="]"===s[2],h=s[3];if(l&&(o|=0),void 0===h||"["===h&&a+2===r){Cr(i,void 0===h?new Sr(o,t,e):new wr(o,t,e));break}{let t=i.map[o];void 0===t&&(t=new Er(o),Cr(i,t)),i=t}}}function Ar(t,e){this.seq=[],this.map={};const i=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let n=0;n<i;++n){const i=t.getActiveUniform(e,n);Lr(i,t.getUniformLocation(e,i.name),this)}}function Rr(t,e,i){const n=t.createShader(e);return t.shaderSource(n,i),t.compileShader(n),n}Ar.prototype.setValue=function(t,e,i,n){const r=this.map[e];void 0!==r&&r.setValue(t,i,n)},Ar.prototype.setOptional=function(t,e,i){const n=e[i];void 0!==n&&this.setValue(t,i,n)},Ar.upload=function(t,e,i,n){for(let r=0,s=e.length;r!==s;++r){const s=e[r],a=i[s.id];!1!==a.needsUpdate&&s.setValue(t,a.value,n)}},Ar.seqWithValue=function(t,e){const i=[];for(let n=0,r=t.length;n!==r;++n){const r=t[n];r.id in e&&i.push(r)}return i};let Pr=0;function Dr(t){switch(t){case I:return["Linear","( value )"];case F:return["sRGB","( value )"];case z:return["RGBE","( value )"];case 3004:return["RGBM","( value, 7.0 )"];case 3005:return["RGBM","( value, 16.0 )"];case 3006:return["RGBD","( value, 256.0 )"];case O:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case 3003:return["LogLuv","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",t),["Linear","( value )"]}}function Nr(t,e,i){const n=t.getShaderParameter(e,t.COMPILE_STATUS),r=t.getShaderInfoLog(e).trim();if(n&&""===r)return"";return"THREE.WebGLShader: gl.getShaderInfoLog() "+i+"\n"+r+function(t){const e=t.split("\n");for(let t=0;t<e.length;t++)e[t]=t+1+": "+e[t];return e.join("\n")}(t.getShaderSource(e))}function Ir(t,e){const i=Dr(e);return"vec4 "+t+"( vec4 value ) { return "+i[0]+"ToLinear"+i[1]+"; }"}function Fr(t,e){const i=Dr(e);return"vec4 "+t+"( vec4 value ) { return LinearTo"+i[0]+i[1]+"; }"}function Or(t,e){let i;switch(e){case 1:i="Linear";break;case 2:i="Reinhard";break;case 3:i="OptimizedCineon";break;case 4:i="ACESFilmic";break;case 5:i="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",e),i="Linear"}return"vec3 "+t+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function zr(t){return""!==t}function Ur(t,e){return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function Br(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const kr=/^[ \t]*#include +<([\w\d./]+)>/gm;function Gr(t){return t.replace(kr,Hr)}function Hr(t,e){const i=Ti[e];if(void 0===i)throw new Error("Can not resolve #include <"+e+">");return Gr(i)}const Vr=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,Wr=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function jr(t){return t.replace(Wr,qr).replace(Vr,Xr)}function Xr(t,e,i,n){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),qr(t,e,i,n)}function qr(t,e,i,n){let r="";for(let t=parseInt(e);t<parseInt(i);t++)r+=n.replace(/\[\s*i\s*\]/g,"[ "+t+" ]").replace(/UNROLLED_LOOP_INDEX/g,t);return r}function Yr(t){let e="precision "+t.precision+" float;\nprecision "+t.precision+" int;";return"highp"===t.precision?e+="\n#define HIGH_PRECISION":"mediump"===t.precision?e+="\n#define MEDIUM_PRECISION":"lowp"===t.precision&&(e+="\n#define LOW_PRECISION"),e}function Zr(t,e,i,n){const r=t.getContext(),s=i.defines;let a=i.vertexShader,o=i.fragmentShader;const l=function(t){let e="SHADOWMAP_TYPE_BASIC";return 1===t.shadowMapType?e="SHADOWMAP_TYPE_PCF":2===t.shadowMapType?e="SHADOWMAP_TYPE_PCF_SOFT":3===t.shadowMapType&&(e="SHADOWMAP_TYPE_VSM"),e}(i),h=function(t){let e="ENVMAP_TYPE_CUBE";if(t.envMap)switch(t.envMapMode){case m:case g:e="ENVMAP_TYPE_CUBE";break;case v:case 307:e="ENVMAP_TYPE_CUBE_UV"}return e}(i),c=function(t){let e="ENVMAP_MODE_REFLECTION";if(t.envMap)switch(t.envMapMode){case g:case 307:e="ENVMAP_MODE_REFRACTION"}return e}(i),u=function(t){let e="ENVMAP_BLENDING_NONE";if(t.envMap)switch(t.combine){case 0:e="ENVMAP_BLENDING_MULTIPLY";break;case 1:e="ENVMAP_BLENDING_MIX";break;case 2:e="ENVMAP_BLENDING_ADD"}return e}(i),d=t.gammaFactor>0?t.gammaFactor:1,p=i.isWebGL2?"":function(t){return[t.extensionDerivatives||t.envMapCubeUV||t.bumpMap||t.tangentSpaceNormalMap||t.clearcoatNormalMap||t.flatShading||"physical"===t.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(t.extensionFragDepth||t.logarithmicDepthBuffer)&&t.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",t.extensionDrawBuffers&&t.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(t.extensionShaderTextureLOD||t.envMap||t.transmission>0)&&t.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(zr).join("\n")}(i),f=function(t){const e=[];for(const i in t){const n=t[i];!1!==n&&e.push("#define "+i+" "+n)}return e.join("\n")}(s),y=r.createProgram();let x,_,M=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(x=[f].filter(zr).join("\n"),x.length>0&&(x+="\n"),_=[p,f].filter(zr).join("\n"),_.length>0&&(_+="\n")):(x=[Yr(i),"#define SHADER_NAME "+i.shaderName,f,i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+d,"#define MAX_BONES "+i.maxBones,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+c:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.displacementMap&&i.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",i.specularTintMap?"#define USE_SPECULARTINTMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.useVertexTexture?"#define BONE_TEXTURE":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(zr).join("\n"),_=[p,Yr(i),"#define SHADER_NAME "+i.shaderName,f,i.alphaTest?"#define ALPHATEST "+i.alphaTest+(i.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+d,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+h:"",i.envMap?"#define "+c:"",i.envMap?"#define "+u:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",i.specularTintMap?"#define USE_SPECULARTINTMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.sheen?"#define USE_SHEEN":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(i.extensionShaderTextureLOD||i.envMap)&&i.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==i.toneMapping?"#define TONE_MAPPING":"",0!==i.toneMapping?Ti.tonemapping_pars_fragment:"",0!==i.toneMapping?Or("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",Ti.encodings_pars_fragment,i.map?Ir("mapTexelToLinear",i.mapEncoding):"",i.matcap?Ir("matcapTexelToLinear",i.matcapEncoding):"",i.envMap?Ir("envMapTexelToLinear",i.envMapEncoding):"",i.emissiveMap?Ir("emissiveMapTexelToLinear",i.emissiveMapEncoding):"",i.specularTintMap?Ir("specularTintMapTexelToLinear",i.specularTintMapEncoding):"",i.lightMap?Ir("lightMapTexelToLinear",i.lightMapEncoding):"",Fr("linearToOutputTexel",i.outputEncoding),i.depthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(zr).join("\n")),a=Gr(a),a=Ur(a,i),a=Br(a,i),o=Gr(o),o=Ur(o,i),o=Br(o,i),a=jr(a),o=jr(o),i.isWebGL2&&!0!==i.isRawShaderMaterial&&(M="#version 300 es\n",x=["#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+x,_=["#define varying in",i.glslVersion===G?"":"out highp vec4 pc_fragColor;",i.glslVersion===G?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+_);const b=M+x+a,S=M+_+o,w=Rr(r,r.VERTEX_SHADER,b),E=Rr(r,r.FRAGMENT_SHADER,S);if(r.attachShader(y,w),r.attachShader(y,E),void 0!==i.index0AttributeName?r.bindAttribLocation(y,0,i.index0AttributeName):!0===i.morphTargets&&r.bindAttribLocation(y,0,"position"),r.linkProgram(y),t.debug.checkShaderErrors){const t=r.getProgramInfoLog(y).trim(),e=r.getShaderInfoLog(w).trim(),i=r.getShaderInfoLog(E).trim();let n=!0,s=!0;if(!1===r.getProgramParameter(y,r.LINK_STATUS)){n=!1;const e=Nr(r,w,"vertex"),i=Nr(r,E,"fragment");console.error("THREE.WebGLProgram: shader error: ",r.getError(),"gl.VALIDATE_STATUS",r.getProgramParameter(y,r.VALIDATE_STATUS),"gl.getProgramInfoLog",t,e,i)}else""!==t?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",t):""!==e&&""!==i||(s=!1);s&&(this.diagnostics={runnable:n,programLog:t,vertexShader:{log:e,prefix:x},fragmentShader:{log:i,prefix:_}})}let T,C;return r.deleteShader(w),r.deleteShader(E),this.getUniforms=function(){return void 0===T&&(T=new Ar(r,y)),T},this.getAttributes=function(){return void 0===C&&(C=function(t,e){const i={},n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let r=0;r<n;r++){const n=t.getActiveAttrib(e,r).name;i[n]=t.getAttribLocation(e,n)}return i}(r,y)),C},this.destroy=function(){n.releaseStatesOfProgram(this),r.deleteProgram(y),this.program=void 0},this.name=i.shaderName,this.id=Pr++,this.cacheKey=e,this.usedTimes=1,this.program=y,this.vertexShader=w,this.fragmentShader=E,this}function Jr(t,e,i,n,r,s,a){const o=[],l=r.isWebGL2,h=r.logarithmicDepthBuffer,c=r.floatVertexTextures,u=r.maxVertexUniforms,d=r.vertexTextures;let p=r.precision;const f={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},m=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","instancingColor","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap","specularIntensityMap","specularTintMap","specularTintMapEncoding","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","vertexAlphas","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","sheen","transmission","transmissionMap","thicknessMap"];function g(t){let e;return t&&t.isTexture?e=t.encoding:t&&t.isWebGLRenderTarget?(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),e=t.texture.encoding):e=I,e}return{getParameters:function(s,o,m,y,x){const _=y.fog,M=s.isMeshStandardMaterial?y.environment:null,b=(s.isMeshStandardMaterial?i:e).get(s.envMap||M),S=f[s.type],w=x.isSkinnedMesh?function(t){const e=t.skeleton.bones;if(c)return 1024;{const t=u,i=Math.floor((t-20)/4),n=Math.min(i,e.length);return n<e.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+e.length+" bones. This GPU supports "+n+"."),0):n}}(x):0;let E,T;if(null!==s.precision&&(p=r.getMaxPrecision(s.precision),p!==s.precision&&console.warn("THREE.WebGLProgram.getParameters:",s.precision,"not supported, using",p,"instead.")),S){const t=Li[S];E=t.vertexShader,T=t.fragmentShader}else E=s.vertexShader,T=s.fragmentShader;const C=t.getRenderTarget();return{isWebGL2:l,shaderID:S,shaderName:s.type,vertexShader:E,fragmentShader:T,defines:s.defines,isRawShaderMaterial:!0===s.isRawShaderMaterial,glslVersion:s.glslVersion,precision:p,instancing:!0===x.isInstancedMesh,instancingColor:!0===x.isInstancedMesh&&null!==x.instanceColor,supportsVertexTextures:d,outputEncoding:null!==C?g(C.texture):t.outputEncoding,map:!!s.map,mapEncoding:g(s.map),matcap:!!s.matcap,matcapEncoding:g(s.matcap),envMap:!!b,envMapMode:b&&b.mapping,envMapEncoding:g(b),envMapCubeUV:!!b&&(b.mapping===v||307===b.mapping),lightMap:!!s.lightMap,lightMapEncoding:g(s.lightMap),aoMap:!!s.aoMap,emissiveMap:!!s.emissiveMap,emissiveMapEncoding:g(s.emissiveMap),bumpMap:!!s.bumpMap,normalMap:!!s.normalMap,objectSpaceNormalMap:1===s.normalMapType,tangentSpaceNormalMap:0===s.normalMapType,clearcoatMap:!!s.clearcoatMap,clearcoatRoughnessMap:!!s.clearcoatRoughnessMap,clearcoatNormalMap:!!s.clearcoatNormalMap,displacementMap:!!s.displacementMap,roughnessMap:!!s.roughnessMap,metalnessMap:!!s.metalnessMap,specularMap:!!s.specularMap,specularIntensityMap:!!s.specularIntensityMap,specularTintMap:!!s.specularTintMap,specularTintMapEncoding:g(s.specularTintMap),alphaMap:!!s.alphaMap,gradientMap:!!s.gradientMap,sheen:!!s.sheen,transmission:!!s.transmission,transmissionMap:!!s.transmissionMap,thicknessMap:!!s.thicknessMap,combine:s.combine,vertexTangents:!!s.normalMap&&!!x.geometry&&!!x.geometry.attributes.tangent,vertexColors:s.vertexColors,vertexAlphas:!0===s.vertexColors&&!!x.geometry&&!!x.geometry.attributes.color&&4===x.geometry.attributes.color.itemSize,vertexUvs:!!(s.map||s.bumpMap||s.normalMap||s.specularMap||s.alphaMap||s.emissiveMap||s.roughnessMap||s.metalnessMap||s.clearcoatMap||s.clearcoatRoughnessMap||s.clearcoatNormalMap||s.displacementMap||s.transmissionMap||s.thicknessMap||s.specularIntensityMap||s.specularTintMap),uvsVertexOnly:!(s.map||s.bumpMap||s.normalMap||s.specularMap||s.alphaMap||s.emissiveMap||s.roughnessMap||s.metalnessMap||s.clearcoatNormalMap||s.transmission||s.transmissionMap||s.thicknessMap||s.specularIntensityMap||s.specularTintMap||!s.displacementMap),fog:!!_,useFog:s.fog,fogExp2:_&&_.isFogExp2,flatShading:!!s.flatShading,sizeAttenuation:s.sizeAttenuation,logarithmicDepthBuffer:h,skinning:!0===x.isSkinnedMesh&&w>0,maxBones:w,useVertexTexture:c,morphTargets:!!x.geometry&&!!x.geometry.morphAttributes.position,morphNormals:!!x.geometry&&!!x.geometry.morphAttributes.normal,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numDirLightShadows:o.directionalShadowMap.length,numPointLightShadows:o.pointShadowMap.length,numSpotLightShadows:o.spotShadowMap.length,numClippingPlanes:a.numPlanes,numClipIntersection:a.numIntersection,dithering:s.dithering,shadowMapEnabled:t.shadowMap.enabled&&m.length>0,shadowMapType:t.shadowMap.type,toneMapping:s.toneMapped?t.toneMapping:0,physicallyCorrectLights:t.physicallyCorrectLights,premultipliedAlpha:s.premultipliedAlpha,alphaTest:s.alphaTest,doubleSided:2===s.side,flipSided:1===s.side,depthPacking:void 0!==s.depthPacking&&s.depthPacking,index0AttributeName:s.index0AttributeName,extensionDerivatives:s.extensions&&s.extensions.derivatives,extensionFragDepth:s.extensions&&s.extensions.fragDepth,extensionDrawBuffers:s.extensions&&s.extensions.drawBuffers,extensionShaderTextureLOD:s.extensions&&s.extensions.shaderTextureLOD,rendererExtensionFragDepth:l||n.has("EXT_frag_depth"),rendererExtensionDrawBuffers:l||n.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:l||n.has("EXT_shader_texture_lod"),customProgramCacheKey:s.customProgramCacheKey()}},getProgramCacheKey:function(e){const i=[];if(e.shaderID?i.push(e.shaderID):(i.push(e.fragmentShader),i.push(e.vertexShader)),void 0!==e.defines)for(const t in e.defines)i.push(t),i.push(e.defines[t]);if(!1===e.isRawShaderMaterial){for(let t=0;t<m.length;t++)i.push(e[m[t]]);i.push(t.outputEncoding),i.push(t.gammaFactor)}return i.push(e.customProgramCacheKey),i.join()},getUniforms:function(t){const e=f[t.type];let i;if(e){const t=Li[e];i=Be.clone(t.uniforms)}else i=t.uniforms;return i},acquireProgram:function(e,i){let n;for(let t=0,e=o.length;t<e;t++){const e=o[t];if(e.cacheKey===i){n=e,++n.usedTimes;break}}return void 0===n&&(n=new Zr(t,i,e,s),o.push(n)),n},releaseProgram:function(t){if(0==--t.usedTimes){const e=o.indexOf(t);o[e]=o[o.length-1],o.pop(),t.destroy()}},programs:o}}function Kr(){let t=new WeakMap;return{get:function(e){let i=t.get(e);return void 0===i&&(i={},t.set(e,i)),i},remove:function(e){t.delete(e)},update:function(e,i,n){t.get(e)[i]=n},dispose:function(){t=new WeakMap}}}function Qr(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program!==e.program?t.program.id-e.program.id:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function $r(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function ts(t){const e=[];let i=0;const n=[],r=[],s=[],a={id:-1};function o(n,r,s,o,l,h){let c=e[i];const u=t.get(s);return void 0===c?(c={id:n.id,object:n,geometry:r,material:s,program:u.program||a,groupOrder:o,renderOrder:n.renderOrder,z:l,group:h},e[i]=c):(c.id=n.id,c.object=n,c.geometry=r,c.material=s,c.program=u.program||a,c.groupOrder=o,c.renderOrder=n.renderOrder,c.z=l,c.group=h),i++,c}return{opaque:n,transmissive:r,transparent:s,init:function(){i=0,n.length=0,r.length=0,s.length=0},push:function(t,e,i,a,l,h){const c=o(t,e,i,a,l,h);i.transmission>0?r.push(c):!0===i.transparent?s.push(c):n.push(c)},unshift:function(t,e,i,a,l,h){const c=o(t,e,i,a,l,h);i.transmission>0?r.unshift(c):!0===i.transparent?s.unshift(c):n.unshift(c)},finish:function(){for(let t=i,n=e.length;t<n;t++){const i=e[t];if(null===i.id)break;i.id=null,i.object=null,i.geometry=null,i.material=null,i.program=null,i.group=null}},sort:function(t,e){n.length>1&&n.sort(t||Qr),r.length>1&&r.sort(e||$r),s.length>1&&s.sort(e||$r)}}}function es(t){let e=new WeakMap;return{get:function(i,n){let r;return!1===e.has(i)?(r=new ts(t),e.set(i,[r])):n>=e.get(i).length?(r=new ts(t),e.get(i).push(r)):r=e.get(i)[n],r},dispose:function(){e=new WeakMap}}}function is(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":i={direction:new ot,color:new $t};break;case"SpotLight":i={position:new ot,direction:new ot,color:new $t,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new ot,color:new $t,distance:0,decay:0};break;case"HemisphereLight":i={direction:new ot,skyColor:new $t,groundColor:new $t};break;case"RectAreaLight":i={color:new $t,position:new ot,halfWidth:new ot,halfHeight:new ot}}return t[e.id]=i,i}}}let ns=0;function rs(t,e){return(e.castShadow?1:0)-(t.castShadow?1:0)}function ss(t,e){const i=new is,n=function(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":case"SpotLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Q};break;case"PointLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Q,shadowCameraNear:1,shadowCameraFar:1e3}}return t[e.id]=i,i}}}(),r={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let t=0;t<9;t++)r.probe.push(new ot);const s=new ot,a=new zt,o=new zt;return{setup:function(s){let a=0,o=0,l=0;for(let t=0;t<9;t++)r.probe[t].set(0,0,0);let h=0,c=0,u=0,d=0,p=0,f=0,m=0,g=0;s.sort(rs);for(let t=0,e=s.length;t<e;t++){const e=s[t],v=e.color,y=e.intensity,x=e.distance,_=e.shadow&&e.shadow.map?e.shadow.map.texture:null;if(e.isAmbientLight)a+=v.r*y,o+=v.g*y,l+=v.b*y;else if(e.isLightProbe)for(let t=0;t<9;t++)r.probe[t].addScaledVector(e.sh.coefficients[t],y);else if(e.isDirectionalLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity),e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,r.directionalShadow[h]=i,r.directionalShadowMap[h]=_,r.directionalShadowMatrix[h]=e.shadow.matrix,f++}r.directional[h]=t,h++}else if(e.isSpotLight){const t=i.get(e);if(t.position.setFromMatrixPosition(e.matrixWorld),t.color.copy(v).multiplyScalar(y),t.distance=x,t.coneCos=Math.cos(e.angle),t.penumbraCos=Math.cos(e.angle*(1-e.penumbra)),t.decay=e.decay,e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,r.spotShadow[u]=i,r.spotShadowMap[u]=_,r.spotShadowMatrix[u]=e.shadow.matrix,g++}r.spot[u]=t,u++}else if(e.isRectAreaLight){const t=i.get(e);t.color.copy(v).multiplyScalar(y),t.halfWidth.set(.5*e.width,0,0),t.halfHeight.set(0,.5*e.height,0),r.rectArea[d]=t,d++}else if(e.isPointLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity),t.distance=e.distance,t.decay=e.decay,e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,i.shadowCameraNear=t.camera.near,i.shadowCameraFar=t.camera.far,r.pointShadow[c]=i,r.pointShadowMap[c]=_,r.pointShadowMatrix[c]=e.shadow.matrix,m++}r.point[c]=t,c++}else if(e.isHemisphereLight){const t=i.get(e);t.skyColor.copy(e.color).multiplyScalar(y),t.groundColor.copy(e.groundColor).multiplyScalar(y),r.hemi[p]=t,p++}}d>0&&(e.isWebGL2||!0===t.has("OES_texture_float_linear")?(r.rectAreaLTC1=Ci.LTC_FLOAT_1,r.rectAreaLTC2=Ci.LTC_FLOAT_2):!0===t.has("OES_texture_half_float_linear")?(r.rectAreaLTC1=Ci.LTC_HALF_1,r.rectAreaLTC2=Ci.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),r.ambient[0]=a,r.ambient[1]=o,r.ambient[2]=l;const v=r.hash;v.directionalLength===h&&v.pointLength===c&&v.spotLength===u&&v.rectAreaLength===d&&v.hemiLength===p&&v.numDirectionalShadows===f&&v.numPointShadows===m&&v.numSpotShadows===g||(r.directional.length=h,r.spot.length=u,r.rectArea.length=d,r.point.length=c,r.hemi.length=p,r.directionalShadow.length=f,r.directionalShadowMap.length=f,r.pointShadow.length=m,r.pointShadowMap.length=m,r.spotShadow.length=g,r.spotShadowMap.length=g,r.directionalShadowMatrix.length=f,r.pointShadowMatrix.length=m,r.spotShadowMatrix.length=g,v.directionalLength=h,v.pointLength=c,v.spotLength=u,v.rectAreaLength=d,v.hemiLength=p,v.numDirectionalShadows=f,v.numPointShadows=m,v.numSpotShadows=g,r.version=ns++)},setupView:function(t,e){let i=0,n=0,l=0,h=0,c=0;const u=e.matrixWorldInverse;for(let e=0,d=t.length;e<d;e++){const d=t[e];if(d.isDirectionalLight){const t=r.directional[i];t.direction.setFromMatrixPosition(d.matrixWorld),s.setFromMatrixPosition(d.target.matrixWorld),t.direction.sub(s),t.direction.transformDirection(u),i++}else if(d.isSpotLight){const t=r.spot[l];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),t.direction.setFromMatrixPosition(d.matrixWorld),s.setFromMatrixPosition(d.target.matrixWorld),t.direction.sub(s),t.direction.transformDirection(u),l++}else if(d.isRectAreaLight){const t=r.rectArea[h];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),o.identity(),a.copy(d.matrixWorld),a.premultiply(u),o.extractRotation(a),t.halfWidth.set(.5*d.width,0,0),t.halfHeight.set(0,.5*d.height,0),t.halfWidth.applyMatrix4(o),t.halfHeight.applyMatrix4(o),h++}else if(d.isPointLight){const t=r.point[n];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),n++}else if(d.isHemisphereLight){const t=r.hemi[c];t.direction.setFromMatrixPosition(d.matrixWorld),t.direction.transformDirection(u),t.direction.normalize(),c++}}},state:r}}function as(t,e){const i=new ss(t,e),n=[],r=[];return{init:function(){n.length=0,r.length=0},state:{lightsArray:n,shadowsArray:r,lights:i},setupLights:function(){i.setup(n)},setupLightsView:function(t){i.setupView(n,t)},pushLight:function(t){n.push(t)},pushShadow:function(t){r.push(t)}}}function os(t,e){let i=new WeakMap;return{get:function(n,r=0){let s;return!1===i.has(n)?(s=new as(t,e),i.set(n,[s])):r>=i.get(n).length?(s=new as(t,e),i.get(n).push(s)):s=i.get(n)[r],s},dispose:function(){i=new WeakMap}}}class ls extends Oe{constructor(t){super(),this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.setValues(t)}copy(t){return super.copy(t),this.depthPacking=t.depthPacking,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this}}ls.prototype.isMeshDepthMaterial=!0;class hs extends Oe{constructor(t){super(),this.type="MeshDistanceMaterial",this.referencePosition=new ot,this.nearDistance=1,this.farDistance=1e3,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.setValues(t)}copy(t){return super.copy(t),this.referencePosition.copy(t.referencePosition),this.nearDistance=t.nearDistance,this.farDistance=t.farDistance,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this}}hs.prototype.isMeshDistanceMaterial=!0;function cs(t,e,i){let n=new Ot;const r=new Q,s=new Q,a=new rt,o=new ls({depthPacking:3201}),l=new hs,h={},c=i.maxTextureSize,u={0:1,1:0,2:2},d=new ke({defines:{SAMPLE_RATE:2/8,HALF_SAMPLE_RATE:1/8},uniforms:{shadow_pass:{value:null},resolution:{value:new Q},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy ) / resolution ) );\n\tfor ( float i = -1.0; i < 1.0 ; i += SAMPLE_RATE) {\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( i, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, i ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean * HALF_SAMPLE_RATE;\n\tsquared_mean = squared_mean * HALF_SAMPLE_RATE;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),p=d.clone();p.defines.HORIZONTAL_PASS=1;const f=new De;f.setAttribute("position",new ie(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const m=new wi(f,d),g=this;function v(i,n){const r=e.update(m);d.uniforms.shadow_pass.value=i.map.texture,d.uniforms.resolution.value=i.mapSize,d.uniforms.radius.value=i.radius,t.setRenderTarget(i.mapPass),t.clear(),t.renderBufferDirect(n,null,r,d,m,null),p.uniforms.shadow_pass.value=i.mapPass.texture,p.uniforms.resolution.value=i.mapSize,p.uniforms.radius.value=i.radius,t.setRenderTarget(i.map),t.clear(),t.renderBufferDirect(n,null,r,p,m,null)}function y(e,i,n,r,s,a,c){let d=null;const p=!0===r.isPointLight?e.customDistanceMaterial:e.customDepthMaterial;if(d=void 0!==p?p:!0===r.isPointLight?l:o,t.localClippingEnabled&&!0===n.clipShadows&&0!==n.clippingPlanes.length){const t=d.uuid,e=n.uuid;let i=h[t];void 0===i&&(i={},h[t]=i);let r=i[e];void 0===r&&(r=d.clone(),i[e]=r),d=r}return d.visible=n.visible,d.wireframe=n.wireframe,d.side=3===c?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:u[n.side],d.clipShadows=n.clipShadows,d.clippingPlanes=n.clippingPlanes,d.clipIntersection=n.clipIntersection,d.wireframeLinewidth=n.wireframeLinewidth,d.linewidth=n.linewidth,!0===r.isPointLight&&!0===d.isMeshDistanceMaterial&&(d.referencePosition.setFromMatrixPosition(r.matrixWorld),d.nearDistance=s,d.farDistance=a),d}function x(i,r,s,a,o){if(!1===i.visible)return;if(i.layers.test(r.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&3===o)&&(!i.frustumCulled||n.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,i.matrixWorld);const n=e.update(i),r=i.material;if(Array.isArray(r)){const e=n.groups;for(let l=0,h=e.length;l<h;l++){const h=e[l],c=r[h.materialIndex];if(c&&c.visible){const e=y(i,0,c,a,s.near,s.far,o);t.renderBufferDirect(s,null,n,e,i,h)}}}else if(r.visible){const e=y(i,0,r,a,s.near,s.far,o);t.renderBufferDirect(s,null,n,e,i,null)}}const l=i.children;for(let t=0,e=l.length;t<e;t++)x(l[t],r,s,a,o)}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1,this.render=function(e,i,o){if(!1===g.enabled)return;if(!1===g.autoUpdate&&!1===g.needsUpdate)return;if(0===e.length)return;const l=t.getRenderTarget(),h=t.getActiveCubeFace(),u=t.getActiveMipmapLevel(),d=t.state;d.setBlending(0),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);for(let l=0,h=e.length;l<h;l++){const h=e[l],u=h.shadow;if(void 0===u){console.warn("THREE.WebGLShadowMap:",h,"has no shadow.");continue}if(!1===u.autoUpdate&&!1===u.needsUpdate)continue;r.copy(u.mapSize);const p=u.getFrameExtents();if(r.multiply(p),s.copy(u.mapSize),(r.x>c||r.y>c)&&(r.x>c&&(s.x=Math.floor(c/p.x),r.x=s.x*p.x,u.mapSize.x=s.x),r.y>c&&(s.y=Math.floor(c/p.y),r.y=s.y*p.y,u.mapSize.y=s.y)),null===u.map&&!u.isPointLightShadow&&3===this.type){const t={minFilter:b,magFilter:b,format:P};u.map=new st(r.x,r.y,t),u.map.texture.name=h.name+".shadowMap",u.mapPass=new st(r.x,r.y,t),u.camera.updateProjectionMatrix()}if(null===u.map){const t={minFilter:M,magFilter:M,format:P};u.map=new st(r.x,r.y,t),u.map.texture.name=h.name+".shadowMap",u.camera.updateProjectionMatrix()}t.setRenderTarget(u.map),t.clear();const f=u.getViewportCount();for(let t=0;t<f;t++){const e=u.getViewport(t);a.set(s.x*e.x,s.y*e.y,s.x*e.z,s.y*e.w),d.viewport(a),u.updateMatrices(h,t),n=u.getFrustum(),x(i,o,u.camera,h,this.type)}u.isPointLightShadow||3!==this.type||v(u,o),u.needsUpdate=!1}g.needsUpdate=!1,t.setRenderTarget(l,h,u)}}function us(t,e,i){const n=i.isWebGL2;const r=new function(){let e=!1;const i=new rt;let n=null;const r=new rt(0,0,0,0);return{setMask:function(i){n===i||e||(t.colorMask(i,i,i,i),n=i)},setLocked:function(t){e=t},setClear:function(e,n,s,a,o){!0===o&&(e*=a,n*=a,s*=a),i.set(e,n,s,a),!1===r.equals(i)&&(t.clearColor(e,n,s,a),r.copy(i))},reset:function(){e=!1,n=null,r.set(-1,0,0,0)}}},s=new function(){let e=!1,i=null,n=null,r=null;return{setTest:function(e){e?U(t.DEPTH_TEST):B(t.DEPTH_TEST)},setMask:function(n){i===n||e||(t.depthMask(n),i=n)},setFunc:function(e){if(n!==e){if(e)switch(e){case 0:t.depthFunc(t.NEVER);break;case 1:t.depthFunc(t.ALWAYS);break;case 2:t.depthFunc(t.LESS);break;case 3:t.depthFunc(t.LEQUAL);break;case 4:t.depthFunc(t.EQUAL);break;case 5:t.depthFunc(t.GEQUAL);break;case 6:t.depthFunc(t.GREATER);break;case 7:t.depthFunc(t.NOTEQUAL);break;default:t.depthFunc(t.LEQUAL)}else t.depthFunc(t.LEQUAL);n=e}},setLocked:function(t){e=t},setClear:function(e){r!==e&&(t.clearDepth(e),r=e)},reset:function(){e=!1,i=null,n=null,r=null}}},a=new function(){let e=!1,i=null,n=null,r=null,s=null,a=null,o=null,l=null,h=null;return{setTest:function(i){e||(i?U(t.STENCIL_TEST):B(t.STENCIL_TEST))},setMask:function(n){i===n||e||(t.stencilMask(n),i=n)},setFunc:function(e,i,a){n===e&&r===i&&s===a||(t.stencilFunc(e,i,a),n=e,r=i,s=a)},setOp:function(e,i,n){a===e&&o===i&&l===n||(t.stencilOp(e,i,n),a=e,o=i,l=n)},setLocked:function(t){e=t},setClear:function(e){h!==e&&(t.clearStencil(e),h=e)},reset:function(){e=!1,i=null,n=null,r=null,s=null,a=null,o=null,l=null,h=null}}};let o={},l=null,h={},c=null,u=!1,d=null,p=null,m=null,g=null,v=null,y=null,x=null,_=!1,M=null,b=null,S=null,w=null,E=null;const T=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let C=!1,L=0;const A=t.getParameter(t.VERSION);-1!==A.indexOf("WebGL")?(L=parseFloat(/^WebGL (\d)/.exec(A)[1]),C=L>=1):-1!==A.indexOf("OpenGL ES")&&(L=parseFloat(/^OpenGL ES (\d)/.exec(A)[1]),C=L>=2);let R=null,P={};const D=t.getParameter(t.SCISSOR_BOX),N=t.getParameter(t.VIEWPORT),I=(new rt).fromArray(D),F=(new rt).fromArray(N);function O(e,i,n){const r=new Uint8Array(4),s=t.createTexture();t.bindTexture(e,s),t.texParameteri(e,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(e,t.TEXTURE_MAG_FILTER,t.NEAREST);for(let e=0;e<n;e++)t.texImage2D(i+e,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,r);return s}const z={};function U(e){!0!==o[e]&&(t.enable(e),o[e]=!0)}function B(e){!1!==o[e]&&(t.disable(e),o[e]=!1)}z[t.TEXTURE_2D]=O(t.TEXTURE_2D,t.TEXTURE_2D,1),z[t.TEXTURE_CUBE_MAP]=O(t.TEXTURE_CUBE_MAP,t.TEXTURE_CUBE_MAP_POSITIVE_X,6),r.setClear(0,0,0,1),s.setClear(1),a.setClear(0),U(t.DEPTH_TEST),s.setFunc(3),V(!1),W(1),U(t.CULL_FACE),H(0);const k={[f]:t.FUNC_ADD,101:t.FUNC_SUBTRACT,102:t.FUNC_REVERSE_SUBTRACT};if(n)k[103]=t.MIN,k[104]=t.MAX;else{const t=e.get("EXT_blend_minmax");null!==t&&(k[103]=t.MIN_EXT,k[104]=t.MAX_EXT)}const G={200:t.ZERO,201:t.ONE,202:t.SRC_COLOR,204:t.SRC_ALPHA,210:t.SRC_ALPHA_SATURATE,208:t.DST_COLOR,206:t.DST_ALPHA,203:t.ONE_MINUS_SRC_COLOR,205:t.ONE_MINUS_SRC_ALPHA,209:t.ONE_MINUS_DST_COLOR,207:t.ONE_MINUS_DST_ALPHA};function H(e,i,n,r,s,a,o,l){if(0!==e){if(!1===u&&(U(t.BLEND),u=!0),5===e)s=s||i,a=a||n,o=o||r,i===p&&s===v||(t.blendEquationSeparate(k[i],k[s]),p=i,v=s),n===m&&r===g&&a===y&&o===x||(t.blendFuncSeparate(G[n],G[r],G[a],G[o]),m=n,g=r,y=a,x=o),d=e,_=null;else if(e!==d||l!==_){if(p===f&&v===f||(t.blendEquation(t.FUNC_ADD),p=f,v=f),l)switch(e){case 1:t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case 2:t.blendFunc(t.ONE,t.ONE);break;case 3:t.blendFuncSeparate(t.ZERO,t.ZERO,t.ONE_MINUS_SRC_COLOR,t.ONE_MINUS_SRC_ALPHA);break;case 4:t.blendFuncSeparate(t.ZERO,t.SRC_COLOR,t.ZERO,t.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}else switch(e){case 1:t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case 2:t.blendFunc(t.SRC_ALPHA,t.ONE);break;case 3:t.blendFunc(t.ZERO,t.ONE_MINUS_SRC_COLOR);break;case 4:t.blendFunc(t.ZERO,t.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}m=null,g=null,y=null,x=null,d=e,_=l}}else!0===u&&(B(t.BLEND),u=!1)}function V(e){M!==e&&(e?t.frontFace(t.CW):t.frontFace(t.CCW),M=e)}function W(e){0!==e?(U(t.CULL_FACE),e!==b&&(1===e?t.cullFace(t.BACK):2===e?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):B(t.CULL_FACE),b=e}function j(e,i,n){e?(U(t.POLYGON_OFFSET_FILL),w===i&&E===n||(t.polygonOffset(i,n),w=i,E=n)):B(t.POLYGON_OFFSET_FILL)}function X(e){void 0===e&&(e=t.TEXTURE0+T-1),R!==e&&(t.activeTexture(e),R=e)}return{buffers:{color:r,depth:s,stencil:a},enable:U,disable:B,bindFramebuffer:function(e,i){return null===i&&null!==l&&(i=l),h[e]!==i&&(t.bindFramebuffer(e,i),h[e]=i,n&&(e===t.DRAW_FRAMEBUFFER&&(h[t.FRAMEBUFFER]=i),e===t.FRAMEBUFFER&&(h[t.DRAW_FRAMEBUFFER]=i)),!0)},bindXRFramebuffer:function(e){e!==l&&(t.bindFramebuffer(t.FRAMEBUFFER,e),l=e)},useProgram:function(e){return c!==e&&(t.useProgram(e),c=e,!0)},setBlending:H,setMaterial:function(e,i){2===e.side?B(t.CULL_FACE):U(t.CULL_FACE);let n=1===e.side;i&&(n=!n),V(n),1===e.blending&&!1===e.transparent?H(0):H(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),s.setFunc(e.depthFunc),s.setTest(e.depthTest),s.setMask(e.depthWrite),r.setMask(e.colorWrite);const o=e.stencilWrite;a.setTest(o),o&&(a.setMask(e.stencilWriteMask),a.setFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),a.setOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),j(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),!0===e.alphaToCoverage?U(t.SAMPLE_ALPHA_TO_COVERAGE):B(t.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:V,setCullFace:W,setLineWidth:function(e){e!==S&&(C&&t.lineWidth(e),S=e)},setPolygonOffset:j,setScissorTest:function(e){e?U(t.SCISSOR_TEST):B(t.SCISSOR_TEST)},activeTexture:X,bindTexture:function(e,i){null===R&&X();let n=P[R];void 0===n&&(n={type:void 0,texture:void 0},P[R]=n),n.type===e&&n.texture===i||(t.bindTexture(e,i||z[e]),n.type=e,n.texture=i)},unbindTexture:function(){const e=P[R];void 0!==e&&void 0!==e.type&&(t.bindTexture(e.type,null),e.type=void 0,e.texture=void 0)},compressedTexImage2D:function(){try{t.compressedTexImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage2D:function(){try{t.texImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage3D:function(){try{t.texImage3D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},scissor:function(e){!1===I.equals(e)&&(t.scissor(e.x,e.y,e.z,e.w),I.copy(e))},viewport:function(e){!1===F.equals(e)&&(t.viewport(e.x,e.y,e.z,e.w),F.copy(e))},reset:function(){t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.SCISSOR_TEST),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.clearColor(0,0,0,0),t.depthMask(!0),t.depthFunc(t.LESS),t.clearDepth(1),t.stencilMask(4294967295),t.stencilFunc(t.ALWAYS,0,4294967295),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.clearStencil(0),t.cullFace(t.BACK),t.frontFace(t.CCW),t.polygonOffset(0,0),t.activeTexture(t.TEXTURE0),t.bindFramebuffer(t.FRAMEBUFFER,null),!0===n&&(t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.bindFramebuffer(t.READ_FRAMEBUFFER,null)),t.useProgram(null),t.lineWidth(1),t.scissor(0,0,t.canvas.width,t.canvas.height),t.viewport(0,0,t.canvas.width,t.canvas.height),o={},R=null,P={},l=null,h={},c=null,u=!1,d=null,p=null,m=null,g=null,v=null,y=null,x=null,_=!1,M=null,b=null,S=null,w=null,E=null,I.set(0,0,t.canvas.width,t.canvas.height),F.set(0,0,t.canvas.width,t.canvas.height),r.reset(),s.reset(),a.reset()}}}function ds(t,e,i,n,r,s,a){const o=r.isWebGL2,l=r.maxTextures,h=r.maxCubemapSize,c=r.maxTextureSize,u=r.maxSamples,d=new WeakMap;let p,f=!1;try{f="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(t){}function m(t,e){return f?new OffscreenCanvas(t,e):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function g(t,e,i,n){let r=1;if((t.width>n||t.height>n)&&(r=n/Math.max(t.width,t.height)),r<1||!0===e){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const n=e?K:Math.floor,s=n(r*t.width),a=n(r*t.height);void 0===p&&(p=m(s,a));const o=i?m(s,a):p;o.width=s,o.height=a;return o.getContext("2d").drawImage(t,0,0,s,a),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+t.width+"x"+t.height+") to ("+s+"x"+a+")."),o}return"data"in t&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+t.width+"x"+t.height+")."),t}return t}function v(t){return J(t.width)&&J(t.height)}function w(t,e){return t.generateMipmaps&&e&&t.minFilter!==M&&t.minFilter!==b}function I(e,i,r,s,a=1){t.generateMipmap(e);n.get(i).__maxMipLevel=Math.log2(Math.max(r,s,a))}function F(i,n,r){if(!1===o)return n;if(null!==i){if(void 0!==t[i])return t[i];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+i+"'")}let s=n;return n===t.RED&&(r===t.FLOAT&&(s=t.R32F),r===t.HALF_FLOAT&&(s=t.R16F),r===t.UNSIGNED_BYTE&&(s=t.R8)),n===t.RGB&&(r===t.FLOAT&&(s=t.RGB32F),r===t.HALF_FLOAT&&(s=t.RGB16F),r===t.UNSIGNED_BYTE&&(s=t.RGB8)),n===t.RGBA&&(r===t.FLOAT&&(s=t.RGBA32F),r===t.HALF_FLOAT&&(s=t.RGBA16F),r===t.UNSIGNED_BYTE&&(s=t.RGBA8)),s!==t.R16F&&s!==t.R32F&&s!==t.RGBA16F&&s!==t.RGBA32F||e.get("EXT_color_buffer_float"),s}function O(e){return e===M||1004===e||1005===e?t.NEAREST:t.LINEAR}function z(e){const i=e.target;i.removeEventListener("dispose",z),function(e){const i=n.get(e);if(void 0===i.__webglInit)return;t.deleteTexture(i.__webglTexture),n.remove(e)}(i),i.isVideoTexture&&d.delete(i),a.memory.textures--}function U(e){const i=e.target;i.removeEventListener("dispose",U),function(e){const i=e.texture,r=n.get(e),s=n.get(i);if(!e)return;void 0!==s.__webglTexture&&(t.deleteTexture(s.__webglTexture),a.memory.textures--);e.depthTexture&&e.depthTexture.dispose();if(e.isWebGLCubeRenderTarget)for(let e=0;e<6;e++)t.deleteFramebuffer(r.__webglFramebuffer[e]),r.__webglDepthbuffer&&t.deleteRenderbuffer(r.__webglDepthbuffer[e]);else t.deleteFramebuffer(r.__webglFramebuffer),r.__webglDepthbuffer&&t.deleteRenderbuffer(r.__webglDepthbuffer),r.__webglMultisampledFramebuffer&&t.deleteFramebuffer(r.__webglMultisampledFramebuffer),r.__webglColorRenderbuffer&&t.deleteRenderbuffer(r.__webglColorRenderbuffer),r.__webglDepthRenderbuffer&&t.deleteRenderbuffer(r.__webglDepthRenderbuffer);if(e.isWebGLMultipleRenderTargets)for(let e=0,r=i.length;e<r;e++){const r=n.get(i[e]);r.__webglTexture&&(t.deleteTexture(r.__webglTexture),a.memory.textures--),n.remove(i[e])}n.remove(i),n.remove(e)}(i)}let B=0;function k(e,r){const s=n.get(e);if(e.isVideoTexture&&function(t){const e=a.render.frame;d.get(t)!==e&&(d.set(t,e),t.update())}(e),e.version>0&&s.__version!==e.version){const t=e.image;if(void 0===t)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined");else{if(!1!==t.complete)return void X(s,e,r);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}i.activeTexture(t.TEXTURE0+r),i.bindTexture(t.TEXTURE_2D,s.__webglTexture)}function G(e,r){const a=n.get(e);e.version>0&&a.__version!==e.version?function(e,n,r){if(6!==n.image.length)return;j(e,n),i.activeTexture(t.TEXTURE0+r),i.bindTexture(t.TEXTURE_CUBE_MAP,e.__webglTexture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,n.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,n.unpackAlignment),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE);const a=n&&(n.isCompressedTexture||n.image[0].isCompressedTexture),l=n.image[0]&&n.image[0].isDataTexture,c=[];for(let t=0;t<6;t++)c[t]=a||l?l?n.image[t].image:n.image[t]:g(n.image[t],!1,!0,h);const u=c[0],d=v(u)||o,p=s.convert(n.format),f=s.convert(n.type),m=F(n.internalFormat,p,f);let y;if(W(t.TEXTURE_CUBE_MAP,n,d),a){for(let e=0;e<6;e++){y=c[e].mipmaps;for(let r=0;r<y.length;r++){const s=y[r];n.format!==P&&n.format!==R?null!==p?i.compressedTexImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,m,s.width,s.height,0,s.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,m,s.width,s.height,0,p,f,s.data)}}e.__maxMipLevel=y.length-1}else{y=n.mipmaps;for(let e=0;e<6;e++)if(l){i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,m,c[e].width,c[e].height,0,p,f,c[e].data);for(let n=0;n<y.length;n++){const r=y[n].image[e].image;i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n+1,m,r.width,r.height,0,p,f,r.data)}}else{i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,m,p,f,c[e]);for(let n=0;n<y.length;n++){const r=y[n];i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n+1,m,p,f,r.image[e])}}e.__maxMipLevel=y.length}w(n,d)&&I(t.TEXTURE_CUBE_MAP,n,u.width,u.height);e.__version=n.version,n.onUpdate&&n.onUpdate(n)}(a,e,r):(i.activeTexture(t.TEXTURE0+r),i.bindTexture(t.TEXTURE_CUBE_MAP,a.__webglTexture))}const H={[y]:t.REPEAT,[x]:t.CLAMP_TO_EDGE,[_]:t.MIRRORED_REPEAT},V={[M]:t.NEAREST,1004:t.NEAREST_MIPMAP_NEAREST,1005:t.NEAREST_MIPMAP_LINEAR,[b]:t.LINEAR,1007:t.LINEAR_MIPMAP_NEAREST,[S]:t.LINEAR_MIPMAP_LINEAR};function W(i,s,a){if(a?(t.texParameteri(i,t.TEXTURE_WRAP_S,H[s.wrapS]),t.texParameteri(i,t.TEXTURE_WRAP_T,H[s.wrapT]),i!==t.TEXTURE_3D&&i!==t.TEXTURE_2D_ARRAY||t.texParameteri(i,t.TEXTURE_WRAP_R,H[s.wrapR]),t.texParameteri(i,t.TEXTURE_MAG_FILTER,V[s.magFilter]),t.texParameteri(i,t.TEXTURE_MIN_FILTER,V[s.minFilter])):(t.texParameteri(i,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(i,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),i!==t.TEXTURE_3D&&i!==t.TEXTURE_2D_ARRAY||t.texParameteri(i,t.TEXTURE_WRAP_R,t.CLAMP_TO_EDGE),s.wrapS===x&&s.wrapT===x||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),t.texParameteri(i,t.TEXTURE_MAG_FILTER,O(s.magFilter)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,O(s.minFilter)),s.minFilter!==M&&s.minFilter!==b&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),!0===e.has("EXT_texture_filter_anisotropic")){const a=e.get("EXT_texture_filter_anisotropic");if(s.type===C&&!1===e.has("OES_texture_float_linear"))return;if(!1===o&&s.type===L&&!1===e.has("OES_texture_half_float_linear"))return;(s.anisotropy>1||n.get(s).__currentAnisotropy)&&(t.texParameterf(i,a.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s.anisotropy,r.getMaxAnisotropy())),n.get(s).__currentAnisotropy=s.anisotropy)}}function j(e,i){void 0===e.__webglInit&&(e.__webglInit=!0,i.addEventListener("dispose",z),e.__webglTexture=t.createTexture(),a.memory.textures++)}function X(e,n,r){let a=t.TEXTURE_2D;n.isDataTexture2DArray&&(a=t.TEXTURE_2D_ARRAY),n.isDataTexture3D&&(a=t.TEXTURE_3D),j(e,n),i.activeTexture(t.TEXTURE0+r),i.bindTexture(a,e.__webglTexture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,n.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,n.unpackAlignment),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE);const l=function(t){return!o&&(t.wrapS!==x||t.wrapT!==x||t.minFilter!==M&&t.minFilter!==b)}(n)&&!1===v(n.image),h=g(n.image,l,!1,c),u=v(h)||o,d=s.convert(n.format);let p,f=s.convert(n.type),m=F(n.internalFormat,d,f);W(a,n,u);const y=n.mipmaps;if(n.isDepthTexture)m=t.DEPTH_COMPONENT,o?m=n.type===C?t.DEPTH_COMPONENT32F:n.type===T?t.DEPTH_COMPONENT24:n.type===A?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT16:n.type===C&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),n.format===D&&m===t.DEPTH_COMPONENT&&n.type!==E&&n.type!==T&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),n.type=E,f=s.convert(n.type)),n.format===N&&m===t.DEPTH_COMPONENT&&(m=t.DEPTH_STENCIL,n.type!==A&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),n.type=A,f=s.convert(n.type))),i.texImage2D(t.TEXTURE_2D,0,m,h.width,h.height,0,d,f,null);else if(n.isDataTexture)if(y.length>0&&u){for(let e=0,n=y.length;e<n;e++)p=y[e],i.texImage2D(t.TEXTURE_2D,e,m,p.width,p.height,0,d,f,p.data);n.generateMipmaps=!1,e.__maxMipLevel=y.length-1}else i.texImage2D(t.TEXTURE_2D,0,m,h.width,h.height,0,d,f,h.data),e.__maxMipLevel=0;else if(n.isCompressedTexture){for(let e=0,r=y.length;e<r;e++)p=y[e],n.format!==P&&n.format!==R?null!==d?i.compressedTexImage2D(t.TEXTURE_2D,e,m,p.width,p.height,0,p.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):i.texImage2D(t.TEXTURE_2D,e,m,p.width,p.height,0,d,f,p.data);e.__maxMipLevel=y.length-1}else if(n.isDataTexture2DArray)i.texImage3D(t.TEXTURE_2D_ARRAY,0,m,h.width,h.height,h.depth,0,d,f,h.data),e.__maxMipLevel=0;else if(n.isDataTexture3D)i.texImage3D(t.TEXTURE_3D,0,m,h.width,h.height,h.depth,0,d,f,h.data),e.__maxMipLevel=0;else if(y.length>0&&u){for(let e=0,n=y.length;e<n;e++)p=y[e],i.texImage2D(t.TEXTURE_2D,e,m,d,f,p);n.generateMipmaps=!1,e.__maxMipLevel=y.length-1}else i.texImage2D(t.TEXTURE_2D,0,m,d,f,h),e.__maxMipLevel=0;w(n,u)&&I(a,n,h.width,h.height),e.__version=n.version,n.onUpdate&&n.onUpdate(n)}function q(e,r,a,o,l){const h=s.convert(a.format),c=s.convert(a.type),u=F(a.internalFormat,h,c);l===t.TEXTURE_3D||l===t.TEXTURE_2D_ARRAY?i.texImage3D(l,0,u,r.width,r.height,r.depth,0,h,c,null):i.texImage2D(l,0,u,r.width,r.height,0,h,c,null),i.bindFramebuffer(t.FRAMEBUFFER,e),t.framebufferTexture2D(t.FRAMEBUFFER,o,l,n.get(a).__webglTexture,0),i.bindFramebuffer(t.FRAMEBUFFER,null)}function Y(e,i,n){if(t.bindRenderbuffer(t.RENDERBUFFER,e),i.depthBuffer&&!i.stencilBuffer){let r=t.DEPTH_COMPONENT16;if(n){const e=i.depthTexture;e&&e.isDepthTexture&&(e.type===C?r=t.DEPTH_COMPONENT32F:e.type===T&&(r=t.DEPTH_COMPONENT24));const n=Q(i);t.renderbufferStorageMultisample(t.RENDERBUFFER,n,r,i.width,i.height)}else t.renderbufferStorage(t.RENDERBUFFER,r,i.width,i.height);t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e)}else if(i.depthBuffer&&i.stencilBuffer){if(n){const e=Q(i);t.renderbufferStorageMultisample(t.RENDERBUFFER,e,t.DEPTH24_STENCIL8,i.width,i.height)}else t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,i.width,i.height);t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,e)}else{const e=!0===i.isWebGLMultipleRenderTargets?i.texture[0]:i.texture,r=s.convert(e.format),a=s.convert(e.type),o=F(e.internalFormat,r,a);if(n){const e=Q(i);t.renderbufferStorageMultisample(t.RENDERBUFFER,e,o,i.width,i.height)}else t.renderbufferStorage(t.RENDERBUFFER,o,i.width,i.height)}t.bindRenderbuffer(t.RENDERBUFFER,null)}function Z(e){const r=n.get(e),s=!0===e.isWebGLCubeRenderTarget;if(e.depthTexture){if(s)throw new Error("target.depthTexture not supported in Cube render targets");!function(e,r){if(r&&r.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(i.bindFramebuffer(t.FRAMEBUFFER,e),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(r.depthTexture).__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),k(r.depthTexture,0);const s=n.get(r.depthTexture).__webglTexture;if(r.depthTexture.format===D)t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,s,0);else{if(r.depthTexture.format!==N)throw new Error("Unknown depthTexture format");t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,s,0)}}(r.__webglFramebuffer,e)}else if(s){r.__webglDepthbuffer=[];for(let n=0;n<6;n++)i.bindFramebuffer(t.FRAMEBUFFER,r.__webglFramebuffer[n]),r.__webglDepthbuffer[n]=t.createRenderbuffer(),Y(r.__webglDepthbuffer[n],e,!1)}else i.bindFramebuffer(t.FRAMEBUFFER,r.__webglFramebuffer),r.__webglDepthbuffer=t.createRenderbuffer(),Y(r.__webglDepthbuffer,e,!1);i.bindFramebuffer(t.FRAMEBUFFER,null)}function Q(t){return o&&t.isWebGLMultisampleRenderTarget?Math.min(u,t.samples):0}let $=!1,tt=!1;this.allocateTextureUnit=function(){const t=B;return t>=l&&console.warn("THREE.WebGLTextures: Trying to use "+t+" texture units while this GPU supports only "+l),B+=1,t},this.resetTextureUnits=function(){B=0},this.setTexture2D=k,this.setTexture2DArray=function(e,r){const s=n.get(e);e.version>0&&s.__version!==e.version?X(s,e,r):(i.activeTexture(t.TEXTURE0+r),i.bindTexture(t.TEXTURE_2D_ARRAY,s.__webglTexture))},this.setTexture3D=function(e,r){const s=n.get(e);e.version>0&&s.__version!==e.version?X(s,e,r):(i.activeTexture(t.TEXTURE0+r),i.bindTexture(t.TEXTURE_3D,s.__webglTexture))},this.setTextureCube=G,this.setupRenderTarget=function(e){const l=e.texture,h=n.get(e),c=n.get(l);e.addEventListener("dispose",U),!0!==e.isWebGLMultipleRenderTargets&&(c.__webglTexture=t.createTexture(),c.__version=l.version,a.memory.textures++);const u=!0===e.isWebGLCubeRenderTarget,d=!0===e.isWebGLMultipleRenderTargets,p=!0===e.isWebGLMultisampleRenderTarget,f=l.isDataTexture3D||l.isDataTexture2DArray,m=v(e)||o;if(!o||l.format!==R||l.type!==C&&l.type!==L||(l.format=P,console.warn("THREE.WebGLRenderer: Rendering to textures with RGB format is not supported. Using RGBA format instead.")),u){h.__webglFramebuffer=[];for(let e=0;e<6;e++)h.__webglFramebuffer[e]=t.createFramebuffer()}else if(h.__webglFramebuffer=t.createFramebuffer(),d)if(r.drawBuffers){const i=e.texture;for(let e=0,r=i.length;e<r;e++){const r=n.get(i[e]);void 0===r.__webglTexture&&(r.__webglTexture=t.createTexture(),a.memory.textures++)}}else console.warn("THREE.WebGLRenderer: WebGLMultipleRenderTargets can only be used with WebGL2 or WEBGL_draw_buffers extension.");else if(p)if(o){h.__webglMultisampledFramebuffer=t.createFramebuffer(),h.__webglColorRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,h.__webglColorRenderbuffer);const n=s.convert(l.format),r=s.convert(l.type),a=F(l.internalFormat,n,r),o=Q(e);t.renderbufferStorageMultisample(t.RENDERBUFFER,o,a,e.width,e.height),i.bindFramebuffer(t.FRAMEBUFFER,h.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,h.__webglColorRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null),e.depthBuffer&&(h.__webglDepthRenderbuffer=t.createRenderbuffer(),Y(h.__webglDepthRenderbuffer,e,!0)),i.bindFramebuffer(t.FRAMEBUFFER,null)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(u){i.bindTexture(t.TEXTURE_CUBE_MAP,c.__webglTexture),W(t.TEXTURE_CUBE_MAP,l,m);for(let i=0;i<6;i++)q(h.__webglFramebuffer[i],e,l,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+i);w(l,m)&&I(t.TEXTURE_CUBE_MAP,l,e.width,e.height),i.bindTexture(t.TEXTURE_CUBE_MAP,null)}else if(d){const r=e.texture;for(let s=0,a=r.length;s<a;s++){const a=r[s],o=n.get(a);i.bindTexture(t.TEXTURE_2D,o.__webglTexture),W(t.TEXTURE_2D,a,m),q(h.__webglFramebuffer,e,a,t.COLOR_ATTACHMENT0+s,t.TEXTURE_2D),w(a,m)&&I(t.TEXTURE_2D,a,e.width,e.height)}i.bindTexture(t.TEXTURE_2D,null)}else{let n=t.TEXTURE_2D;if(f)if(o){n=l.isDataTexture3D?t.TEXTURE_3D:t.TEXTURE_2D_ARRAY}else console.warn("THREE.DataTexture3D and THREE.DataTexture2DArray only supported with WebGL2.");i.bindTexture(n,c.__webglTexture),W(n,l,m),q(h.__webglFramebuffer,e,l,t.COLOR_ATTACHMENT0,n),w(l,m)&&I(n,l,e.width,e.height,e.depth),i.bindTexture(n,null)}e.depthBuffer&&Z(e)},this.updateRenderTargetMipmap=function(e){const r=v(e)||o,s=!0===e.isWebGLMultipleRenderTargets?e.texture:[e.texture];for(let a=0,o=s.length;a<o;a++){const o=s[a];if(w(o,r)){const r=e.isWebGLCubeRenderTarget?t.TEXTURE_CUBE_MAP:t.TEXTURE_2D,s=n.get(o).__webglTexture;i.bindTexture(r,s),I(r,o,e.width,e.height),i.bindTexture(r,null)}}},this.updateMultisampleRenderTarget=function(e){if(e.isWebGLMultisampleRenderTarget)if(o){const r=e.width,s=e.height;let a=t.COLOR_BUFFER_BIT;e.depthBuffer&&(a|=t.DEPTH_BUFFER_BIT),e.stencilBuffer&&(a|=t.STENCIL_BUFFER_BIT);const o=n.get(e);i.bindFramebuffer(t.READ_FRAMEBUFFER,o.__webglMultisampledFramebuffer),i.bindFramebuffer(t.DRAW_FRAMEBUFFER,o.__webglFramebuffer),t.blitFramebuffer(0,0,r,s,0,0,r,s,a,t.NEAREST),i.bindFramebuffer(t.READ_FRAMEBUFFER,null),i.bindFramebuffer(t.DRAW_FRAMEBUFFER,o.__webglMultisampledFramebuffer)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")},this.safeSetTexture2D=function(t,e){t&&t.isWebGLRenderTarget&&(!1===$&&(console.warn("THREE.WebGLTextures.safeSetTexture2D: don't use render targets as textures. Use their .texture property instead."),$=!0),t=t.texture),k(t,e)},this.safeSetTextureCube=function(t,e){t&&t.isWebGLCubeRenderTarget&&(!1===tt&&(console.warn("THREE.WebGLTextures.safeSetTextureCube: don't use cube render targets as textures. Use their .texture property instead."),tt=!0),t=t.texture),G(t,e)}}function ps(t,e,i){const n=i.isWebGL2;return{convert:function(i){let r;if(i===w)return t.UNSIGNED_BYTE;if(1017===i)return t.UNSIGNED_SHORT_4_4_4_4;if(1018===i)return t.UNSIGNED_SHORT_5_5_5_1;if(1019===i)return t.UNSIGNED_SHORT_5_6_5;if(1010===i)return t.BYTE;if(1011===i)return t.SHORT;if(i===E)return t.UNSIGNED_SHORT;if(1013===i)return t.INT;if(i===T)return t.UNSIGNED_INT;if(i===C)return t.FLOAT;if(i===L)return n?t.HALF_FLOAT:(r=e.get("OES_texture_half_float"),null!==r?r.HALF_FLOAT_OES:null);if(1021===i)return t.ALPHA;if(i===R)return t.RGB;if(i===P)return t.RGBA;if(1024===i)return t.LUMINANCE;if(1025===i)return t.LUMINANCE_ALPHA;if(i===D)return t.DEPTH_COMPONENT;if(i===N)return t.DEPTH_STENCIL;if(1028===i)return t.RED;if(1029===i)return t.RED_INTEGER;if(1030===i)return t.RG;if(1031===i)return t.RG_INTEGER;if(1032===i)return t.RGB_INTEGER;if(1033===i)return t.RGBA_INTEGER;if(33776===i||33777===i||33778===i||33779===i){if(r=e.get("WEBGL_compressed_texture_s3tc"),null===r)return null;if(33776===i)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(33777===i)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(33778===i)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(33779===i)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(35840===i||35841===i||35842===i||35843===i){if(r=e.get("WEBGL_compressed_texture_pvrtc"),null===r)return null;if(35840===i)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(35841===i)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(35842===i)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(35843===i)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(36196===i)return r=e.get("WEBGL_compressed_texture_etc1"),null!==r?r.COMPRESSED_RGB_ETC1_WEBGL:null;if((37492===i||37496===i)&&(r=e.get("WEBGL_compressed_texture_etc"),null!==r)){if(37492===i)return r.COMPRESSED_RGB8_ETC2;if(37496===i)return r.COMPRESSED_RGBA8_ETC2_EAC}return 37808===i||37809===i||37810===i||37811===i||37812===i||37813===i||37814===i||37815===i||37816===i||37817===i||37818===i||37819===i||37820===i||37821===i||37840===i||37841===i||37842===i||37843===i||37844===i||37845===i||37846===i||37847===i||37848===i||37849===i||37850===i||37851===i||37852===i||37853===i?(r=e.get("WEBGL_compressed_texture_astc"),null!==r?i:null):36492===i?(r=e.get("EXT_texture_compression_bptc"),null!==r?i:null):i===A?n?t.UNSIGNED_INT_24_8:(r=e.get("WEBGL_depth_texture"),null!==r?r.UNSIGNED_INT_24_8_WEBGL:null):void 0}}}class fs extends Fi{constructor(t=[]){super(),this.cameras=t}}fs.prototype.isArrayCamera=!0;class ms extends Se{constructor(){super(),this.type="Group"}}ms.prototype.isGroup=!0;const gs={type:"move"};class vs{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new ms,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new ms,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new ot,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new ot),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new ms,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new ot,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new ot),this._grip}dispatchEvent(t){return null!==this._targetRay&&this._targetRay.dispatchEvent(t),null!==this._grip&&this._grip.dispatchEvent(t),null!==this._hand&&this._hand.dispatchEvent(t),this}disconnect(t){return this.dispatchEvent({type:"disconnected",data:t}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(t,e,i){let n=null,r=null,s=null;const a=this._targetRay,o=this._grip,l=this._hand;if(t&&"visible-blurred"!==e.session.visibilityState)if(null!==a&&(n=e.getPose(t.targetRaySpace,i),null!==n&&(a.matrix.fromArray(n.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),n.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(n.linearVelocity)):a.hasLinearVelocity=!1,n.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(n.angularVelocity)):a.hasAngularVelocity=!1,this.dispatchEvent(gs))),l&&t.hand){s=!0;for(const n of t.hand.values()){const t=e.getJointPose(n,i);if(void 0===l.joints[n.jointName]){const t=new ms;t.matrixAutoUpdate=!1,t.visible=!1,l.joints[n.jointName]=t,l.add(t)}const r=l.joints[n.jointName];null!==t&&(r.matrix.fromArray(t.transform.matrix),r.matrix.decompose(r.position,r.rotation,r.scale),r.jointRadius=t.radius),r.visible=null!==t}const n=l.joints["index-finger-tip"],r=l.joints["thumb-tip"],a=n.position.distanceTo(r.position),o=.02,h=.005;l.inputState.pinching&&a>o+h?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:t.handedness,target:this})):!l.inputState.pinching&&a<=o-h&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:t.handedness,target:this}))}else null!==o&&t.gripSpace&&(r=e.getPose(t.gripSpace,i),null!==r&&(o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),r.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(r.linearVelocity)):o.hasLinearVelocity=!1,r.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(r.angularVelocity)):o.hasAngularVelocity=!1));return null!==a&&(a.visible=null!==n),null!==o&&(o.visible=null!==r),null!==l&&(l.visible=null!==s),this}}class ys extends c{constructor(t,e){super();const i=this,n=t.state;let r=null,s=1,a=null,o="local-floor",l=null,h=null,c=null,u=null,d=null;const p=[],f=new Map,m=new Fi;m.layers.enable(1),m.viewport=new rt;const g=new Fi;g.layers.enable(2),g.viewport=new rt;const v=[m,g],y=new fs;y.layers.enable(1),y.layers.enable(2);let x=null,_=null;function M(t){const e=f.get(t.inputSource);e&&e.dispatchEvent({type:t.type,data:t.inputSource})}function b(){f.forEach((function(t,e){t.disconnect(e)})),f.clear(),x=null,_=null,n.bindXRFramebuffer(null),t.setRenderTarget(t.getRenderTarget()),L.stop(),i.isPresenting=!1,i.dispatchEvent({type:"sessionend"})}function S(t){const e=r.inputSources;for(let t=0;t<p.length;t++)f.set(e[t],p[t]);for(let e=0;e<t.removed.length;e++){const i=t.removed[e],n=f.get(i);n&&(n.dispatchEvent({type:"disconnected",data:i}),f.delete(i))}for(let e=0;e<t.added.length;e++){const i=t.added[e],n=f.get(i);n&&n.dispatchEvent({type:"connected",data:i})}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(t){let e=p[t];return void 0===e&&(e=new vs,p[t]=e),e.getTargetRaySpace()},this.getControllerGrip=function(t){let e=p[t];return void 0===e&&(e=new vs,p[t]=e),e.getGripSpace()},this.getHand=function(t){let e=p[t];return void 0===e&&(e=new vs,p[t]=e),e.getHandSpace()},this.setFramebufferScaleFactor=function(t){s=t,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(t){o=t,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return a},this.getSession=function(){return r},this.setSession=async function(t){if(r=t,null!==r){r.addEventListener("select",M),r.addEventListener("selectstart",M),r.addEventListener("selectend",M),r.addEventListener("squeeze",M),r.addEventListener("squeezestart",M),r.addEventListener("squeezeend",M),r.addEventListener("end",b),r.addEventListener("inputsourceschange",S);const t=e.getContextAttributes();if(!0!==t.xrCompatible&&await e.makeXRCompatible(),void 0===r.renderState.layers){const i={antialias:t.antialias,alpha:t.alpha,depth:t.depth,stencil:t.stencil,framebufferScaleFactor:s};d=new XRWebGLLayer(r,e,i),r.updateRenderState({baseLayer:d})}else{let i=0;if(t.antialias){const i={antialias:!0,alpha:t.alpha,depth:t.depth,stencil:t.stencil,framebufferScaleFactor:s};d=new XRWebGLLayer(r,e,i),r.updateRenderState({layers:[d]})}else{t.depth&&(i=t.stencil?e.DEPTH_STENCIL:e.DEPTH_COMPONENT);const n={colorFormat:t.alpha?e.RGBA:e.RGB,depthFormat:i,scaleFactor:s};h=new XRWebGLBinding(r,e),u=h.createProjectionLayer(n),c=e.createFramebuffer(),r.updateRenderState({layers:[u]})}}a=await r.requestReferenceSpace(o),L.setContext(r),L.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}};const w=new ot,E=new ot;function T(t,e){null===e?t.matrixWorld.copy(t.matrix):t.matrixWorld.multiplyMatrices(e.matrixWorld,t.matrix),t.matrixWorldInverse.copy(t.matrixWorld).invert()}this.updateCamera=function(t){if(null===r)return;y.near=g.near=m.near=t.near,y.far=g.far=m.far=t.far,x===y.near&&_===y.far||(r.updateRenderState({depthNear:y.near,depthFar:y.far}),x=y.near,_=y.far);const e=t.parent,i=y.cameras;T(y,e);for(let t=0;t<i.length;t++)T(i[t],e);y.matrixWorld.decompose(y.position,y.quaternion,y.scale),t.position.copy(y.position),t.quaternion.copy(y.quaternion),t.scale.copy(y.scale),t.matrix.copy(y.matrix),t.matrixWorld.copy(y.matrixWorld);const n=t.children;for(let t=0,e=n.length;t<e;t++)n[t].updateMatrixWorld(!0);2===i.length?function(t,e,i){w.setFromMatrixPosition(e.matrixWorld),E.setFromMatrixPosition(i.matrixWorld);const n=w.distanceTo(E),r=e.projectionMatrix.elements,s=i.projectionMatrix.elements,a=r[14]/(r[10]-1),o=r[14]/(r[10]+1),l=(r[9]+1)/r[5],h=(r[9]-1)/r[5],c=(r[8]-1)/r[0],u=(s[8]+1)/s[0],d=a*c,p=a*u,f=n/(-c+u),m=f*-c;e.matrixWorld.decompose(t.position,t.quaternion,t.scale),t.translateX(m),t.translateZ(f),t.matrixWorld.compose(t.position,t.quaternion,t.scale),t.matrixWorldInverse.copy(t.matrixWorld).invert();const g=a+f,v=o+f,y=d-m,x=p+(n-m),_=l*o/v*g,M=h*o/v*g;t.projectionMatrix.makePerspective(y,x,_,M,g,v)}(y,m,g):y.projectionMatrix.copy(m.projectionMatrix)},this.getCamera=function(){return y},this.getFoveation=function(){return null!==u?u.fixedFoveation:null!==d?d.fixedFoveation:void 0},this.setFoveation=function(t){null!==u&&(u.fixedFoveation=t),null!==d&&void 0!==d.fixedFoveation&&(d.fixedFoveation=t)};let C=null;const L=new jt;L.setAnimationLoop((function(t,i){if(l=i.getViewerPose(a),null!==l){const t=l.views;null!==d&&n.bindXRFramebuffer(d.framebuffer);let i=!1;t.length!==y.cameras.length&&(y.cameras.length=0,i=!0);for(let r=0;r<t.length;r++){const s=t[r];let a=null;if(null!==d)a=d.getViewport(s);else{const t=h.getViewSubImage(u,s);n.bindXRFramebuffer(c),void 0!==t.depthStencilTexture&&e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,t.depthStencilTexture,0),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t.colorTexture,0),a=t.viewport}const o=v[r];o.matrix.fromArray(s.transform.matrix),o.projectionMatrix.fromArray(s.projectionMatrix),o.viewport.set(a.x,a.y,a.width,a.height),0===r&&y.matrix.copy(o.matrix),!0===i&&y.cameras.push(o)}}const s=r.inputSources;for(let t=0;t<p.length;t++){const e=p[t],n=s[t];e.update(n,i,a)}C&&C(t,i)})),this.setAnimationLoop=function(t){C=t},this.dispose=function(){}}}function xs(t){function e(e,i){e.opacity.value=i.opacity,i.color&&e.diffuse.value.copy(i.color),i.emissive&&e.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),i.map&&(e.map.value=i.map),i.alphaMap&&(e.alphaMap.value=i.alphaMap),i.specularMap&&(e.specularMap.value=i.specularMap);const n=t.get(i).envMap;if(n){e.envMap.value=n,e.flipEnvMap.value=n.isCubeTexture&&!1===n.isRenderTargetTexture?-1:1,e.reflectivity.value=i.reflectivity,e.refractionRatio.value=i.refractionRatio;const r=t.get(n).__maxMipLevel;void 0!==r&&(e.maxMipLevel.value=r)}let r,s;i.lightMap&&(e.lightMap.value=i.lightMap,e.lightMapIntensity.value=i.lightMapIntensity),i.aoMap&&(e.aoMap.value=i.aoMap,e.aoMapIntensity.value=i.aoMapIntensity),i.map?r=i.map:i.specularMap?r=i.specularMap:i.displacementMap?r=i.displacementMap:i.normalMap?r=i.normalMap:i.bumpMap?r=i.bumpMap:i.roughnessMap?r=i.roughnessMap:i.metalnessMap?r=i.metalnessMap:i.alphaMap?r=i.alphaMap:i.emissiveMap?r=i.emissiveMap:i.clearcoatMap?r=i.clearcoatMap:i.clearcoatNormalMap?r=i.clearcoatNormalMap:i.clearcoatRoughnessMap?r=i.clearcoatRoughnessMap:i.specularIntensityMap?r=i.specularIntensityMap:i.specularTintMap&&(r=i.specularTintMap),void 0!==r&&(r.isWebGLRenderTarget&&(r=r.texture),!0===r.matrixAutoUpdate&&r.updateMatrix(),e.uvTransform.value.copy(r.matrix)),i.aoMap?s=i.aoMap:i.lightMap&&(s=i.lightMap),void 0!==s&&(s.isWebGLRenderTarget&&(s=s.texture),!0===s.matrixAutoUpdate&&s.updateMatrix(),e.uv2Transform.value.copy(s.matrix))}function i(e,i){e.roughness.value=i.roughness,e.metalness.value=i.metalness,i.roughnessMap&&(e.roughnessMap.value=i.roughnessMap),i.metalnessMap&&(e.metalnessMap.value=i.metalnessMap),i.emissiveMap&&(e.emissiveMap.value=i.emissiveMap),i.bumpMap&&(e.bumpMap.value=i.bumpMap,e.bumpScale.value=i.bumpScale,1===i.side&&(e.bumpScale.value*=-1)),i.normalMap&&(e.normalMap.value=i.normalMap,e.normalScale.value.copy(i.normalScale),1===i.side&&e.normalScale.value.negate()),i.displacementMap&&(e.displacementMap.value=i.displacementMap,e.displacementScale.value=i.displacementScale,e.displacementBias.value=i.displacementBias);t.get(i).envMap&&(e.envMapIntensity.value=i.envMapIntensity)}return{refreshFogUniforms:function(t,e){t.fogColor.value.copy(e.color),e.isFog?(t.fogNear.value=e.near,t.fogFar.value=e.far):e.isFogExp2&&(t.fogDensity.value=e.density)},refreshMaterialUniforms:function(t,n,r,s,a){n.isMeshBasicMaterial?e(t,n):n.isMeshLambertMaterial?(e(t,n),function(t,e){e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap)}(t,n)):n.isMeshToonMaterial?(e(t,n),function(t,e){e.gradientMap&&(t.gradientMap.value=e.gradientMap);e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap);e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,1===e.side&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),1===e.side&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isMeshPhongMaterial?(e(t,n),function(t,e){t.specular.value.copy(e.specular),t.shininess.value=Math.max(e.shininess,1e-4),e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap);e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,1===e.side&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),1===e.side&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isMeshStandardMaterial?(e(t,n),n.isMeshPhysicalMaterial?function(t,e,n){i(t,e),t.reflectivity.value=e.reflectivity,t.clearcoat.value=e.clearcoat,t.clearcoatRoughness.value=e.clearcoatRoughness,e.sheen&&t.sheen.value.copy(e.sheen);e.clearcoatMap&&(t.clearcoatMap.value=e.clearcoatMap);e.clearcoatRoughnessMap&&(t.clearcoatRoughnessMap.value=e.clearcoatRoughnessMap);e.clearcoatNormalMap&&(t.clearcoatNormalScale.value.copy(e.clearcoatNormalScale),t.clearcoatNormalMap.value=e.clearcoatNormalMap,1===e.side&&t.clearcoatNormalScale.value.negate());t.transmission.value=e.transmission,e.transmissionMap&&(t.transmissionMap.value=e.transmissionMap);e.transmission>0&&(t.transmissionSamplerMap.value=n.texture,t.transmissionSamplerSize.value.set(n.width,n.height));t.thickness.value=e.thickness,e.thicknessMap&&(t.thicknessMap.value=e.thicknessMap);t.attenuationDistance.value=e.attenuationDistance,t.attenuationTint.value.copy(e.attenuationTint),t.specularIntensity.value=e.specularIntensity,t.specularTint.value.copy(e.specularTint),e.specularIntensityMap&&(t.specularIntensityMap.value=e.specularIntensityMap);e.specularTintMap&&(t.specularTintMap.value=e.specularTintMap)}(t,n,a):i(t,n)):n.isMeshMatcapMaterial?(e(t,n),function(t,e){e.matcap&&(t.matcap.value=e.matcap);e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,1===e.side&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),1===e.side&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isMeshDepthMaterial?(e(t,n),function(t,e){e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isMeshDistanceMaterial?(e(t,n),function(t,e){e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias);t.referencePosition.value.copy(e.referencePosition),t.nearDistance.value=e.nearDistance,t.farDistance.value=e.farDistance}(t,n)):n.isMeshNormalMaterial?(e(t,n),function(t,e){e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,1===e.side&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),1===e.side&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isLineBasicMaterial?(function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity}(t,n),n.isLineDashedMaterial&&function(t,e){t.dashSize.value=e.dashSize,t.totalSize.value=e.dashSize+e.gapSize,t.scale.value=e.scale}(t,n)):n.isPointsMaterial?function(t,e,i,n){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.size.value=e.size*i,t.scale.value=.5*n,e.map&&(t.map.value=e.map);e.alphaMap&&(t.alphaMap.value=e.alphaMap);let r;e.map?r=e.map:e.alphaMap&&(r=e.alphaMap);void 0!==r&&(!0===r.matrixAutoUpdate&&r.updateMatrix(),t.uvTransform.value.copy(r.matrix))}(t,n,r,s):n.isSpriteMaterial?function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.rotation.value=e.rotation,e.map&&(t.map.value=e.map);e.alphaMap&&(t.alphaMap.value=e.alphaMap);let i;e.map?i=e.map:e.alphaMap&&(i=e.alphaMap);void 0!==i&&(!0===i.matrixAutoUpdate&&i.updateMatrix(),t.uvTransform.value.copy(i.matrix))}(t,n):n.isShadowMaterial?(t.color.value.copy(n.color),t.opacity.value=n.opacity):n.isShaderMaterial&&(n.uniformsNeedUpdate=!1)}}}function _s(t={}){const e=void 0!==t.canvas?t.canvas:function(){const t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return t.style.display="block",t}(),i=void 0!==t.context?t.context:null,n=void 0!==t.alpha&&t.alpha,r=void 0===t.depth||t.depth,s=void 0===t.stencil||t.stencil,a=void 0!==t.antialias&&t.antialias,o=void 0===t.premultipliedAlpha||t.premultipliedAlpha,l=void 0!==t.preserveDrawingBuffer&&t.preserveDrawingBuffer,h=void 0!==t.powerPreference?t.powerPreference:"default",c=void 0!==t.failIfMajorPerformanceCaveat&&t.failIfMajorPerformanceCaveat;let u=null,d=null;const p=[],f=[];this.domElement=e,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=I,this.physicallyCorrectLights=!1,this.toneMapping=0,this.toneMappingExposure=1;const m=this;let g=!1,v=0,y=0,_=null,b=-1,E=null;const T=new rt,A=new rt;let R=null,D=e.width,N=e.height,F=1,O=null,z=null;const U=new rt(0,0,D,N),B=new rt(0,0,D,N);let k=!1;const G=[],H=new Ot;let V=!1,W=!1,j=null;const X=new zt,q=new ot,Y={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function Z(){return null===_?F:1}let J,K,Q,$,tt,et,it,nt,at,lt,ht,ct,ut,dt,pt,ft,mt,gt,vt,yt,xt,_t,Mt,bt=i;function St(t,i){for(let n=0;n<t.length;n++){const r=t[n],s=e.getContext(r,i);if(null!==s)return s}return null}try{const t={alpha:n,depth:r,stencil:s,antialias:a,premultipliedAlpha:o,preserveDrawingBuffer:l,powerPreference:h,failIfMajorPerformanceCaveat:c};if(e.addEventListener("webglcontextlost",Tt,!1),e.addEventListener("webglcontextrestored",Ct,!1),null===bt){const e=["webgl2","webgl","experimental-webgl"];if(!0===m.isWebGL1Renderer&&e.shift(),bt=St(e,t),null===bt)throw St(e)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}void 0===bt.getShaderPrecisionFormat&&(bt.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(t){throw console.error("THREE.WebGLRenderer: "+t.message),t}function wt(){J=new vn(bt),K=new Di(bt,J,t),J.init(K),_t=new ps(bt,J,K),Q=new us(bt,J,K),G[0]=bt.BACK,$=new _n(bt),tt=new Kr,et=new ds(bt,J,Q,tt,K,_t,$),it=new ki(m),nt=new gn(m),at=new Xt(bt,K),Mt=new Ri(bt,J,at,K),lt=new yn(bt,at,$,Mt),ht=new En(bt,lt,at,$),vt=new Sn(bt),ft=new Ni(tt),ct=new Jr(m,it,nt,J,K,Mt,ft),ut=new xs(tt),dt=new es(tt),pt=new os(J,K),gt=new Ai(m,it,Q,ht,o),mt=new cs(m,ht,K),yt=new Pi(bt,J,$,K),xt=new xn(bt,J,$,K),$.programs=ct.programs,m.capabilities=K,m.extensions=J,m.properties=tt,m.renderLists=dt,m.shadowMap=mt,m.state=Q,m.info=$}wt();const Et=new ys(m,bt);function Tt(t){t.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),g=!0}function Ct(){console.log("THREE.WebGLRenderer: Context Restored."),g=!1;const t=$.autoReset,e=mt.enabled,i=mt.autoUpdate,n=mt.needsUpdate,r=mt.type;wt(),$.autoReset=t,mt.enabled=e,mt.autoUpdate=i,mt.needsUpdate=n,mt.type=r}function Lt(t){const e=t.target;e.removeEventListener("dispose",Lt),function(t){(function(t){const e=tt.get(t).programs;void 0!==e&&e.forEach((function(t){ct.releaseProgram(t)}))})(t),tt.remove(t)}(e)}this.xr=Et,this.getContext=function(){return bt},this.getContextAttributes=function(){return bt.getContextAttributes()},this.forceContextLoss=function(){const t=J.get("WEBGL_lose_context");t&&t.loseContext()},this.forceContextRestore=function(){const t=J.get("WEBGL_lose_context");t&&t.restoreContext()},this.getPixelRatio=function(){return F},this.setPixelRatio=function(t){void 0!==t&&(F=t,this.setSize(D,N,!1))},this.getSize=function(t){return t.set(D,N)},this.setSize=function(t,i,n){Et.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(D=t,N=i,e.width=Math.floor(t*F),e.height=Math.floor(i*F),!1!==n&&(e.style.width=t+"px",e.style.height=i+"px"),this.setViewport(0,0,t,i))},this.getDrawingBufferSize=function(t){return t.set(D*F,N*F).floor()},this.setDrawingBufferSize=function(t,i,n){D=t,N=i,F=n,e.width=Math.floor(t*n),e.height=Math.floor(i*n),this.setViewport(0,0,t,i)},this.getCurrentViewport=function(t){return t.copy(T)},this.getViewport=function(t){return t.copy(U)},this.setViewport=function(t,e,i,n){t.isVector4?U.set(t.x,t.y,t.z,t.w):U.set(t,e,i,n),Q.viewport(T.copy(U).multiplyScalar(F).floor())},this.getScissor=function(t){return t.copy(B)},this.setScissor=function(t,e,i,n){t.isVector4?B.set(t.x,t.y,t.z,t.w):B.set(t,e,i,n),Q.scissor(A.copy(B).multiplyScalar(F).floor())},this.getScissorTest=function(){return k},this.setScissorTest=function(t){Q.setScissorTest(k=t)},this.setOpaqueSort=function(t){O=t},this.setTransparentSort=function(t){z=t},this.getClearColor=function(t){return t.copy(gt.getClearColor())},this.setClearColor=function(){gt.setClearColor.apply(gt,arguments)},this.getClearAlpha=function(){return gt.getClearAlpha()},this.setClearAlpha=function(){gt.setClearAlpha.apply(gt,arguments)},this.clear=function(t,e,i){let n=0;(void 0===t||t)&&(n|=bt.COLOR_BUFFER_BIT),(void 0===e||e)&&(n|=bt.DEPTH_BUFFER_BIT),(void 0===i||i)&&(n|=bt.STENCIL_BUFFER_BIT),bt.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){e.removeEventListener("webglcontextlost",Tt,!1),e.removeEventListener("webglcontextrestored",Ct,!1),dt.dispose(),pt.dispose(),tt.dispose(),it.dispose(),nt.dispose(),ht.dispose(),Mt.dispose(),Et.dispose(),Et.removeEventListener("sessionstart",Rt),Et.removeEventListener("sessionend",Pt),j&&(j.dispose(),j=null),Dt.stop()},this.renderBufferImmediate=function(t,e){Mt.initAttributes();const i=tt.get(t);t.hasPositions&&!i.position&&(i.position=bt.createBuffer()),t.hasNormals&&!i.normal&&(i.normal=bt.createBuffer()),t.hasUvs&&!i.uv&&(i.uv=bt.createBuffer()),t.hasColors&&!i.color&&(i.color=bt.createBuffer());const n=e.getAttributes();t.hasPositions&&(bt.bindBuffer(bt.ARRAY_BUFFER,i.position),bt.bufferData(bt.ARRAY_BUFFER,t.positionArray,bt.DYNAMIC_DRAW),Mt.enableAttribute(n.position),bt.vertexAttribPointer(n.position,3,bt.FLOAT,!1,0,0)),t.hasNormals&&(bt.bindBuffer(bt.ARRAY_BUFFER,i.normal),bt.bufferData(bt.ARRAY_BUFFER,t.normalArray,bt.DYNAMIC_DRAW),Mt.enableAttribute(n.normal),bt.vertexAttribPointer(n.normal,3,bt.FLOAT,!1,0,0)),t.hasUvs&&(bt.bindBuffer(bt.ARRAY_BUFFER,i.uv),bt.bufferData(bt.ARRAY_BUFFER,t.uvArray,bt.DYNAMIC_DRAW),Mt.enableAttribute(n.uv),bt.vertexAttribPointer(n.uv,2,bt.FLOAT,!1,0,0)),t.hasColors&&(bt.bindBuffer(bt.ARRAY_BUFFER,i.color),bt.bufferData(bt.ARRAY_BUFFER,t.colorArray,bt.DYNAMIC_DRAW),Mt.enableAttribute(n.color),bt.vertexAttribPointer(n.color,3,bt.FLOAT,!1,0,0)),Mt.disableUnusedAttributes(),bt.drawArrays(bt.TRIANGLES,0,t.count),t.count=0},this.renderBufferDirect=function(t,e,i,n,r,s){null===e&&(e=Y);const a=r.isMesh&&r.matrixWorld.determinant()<0,o=kt(t,e,n,r);Q.setMaterial(n,a);let l=i.index;const h=i.attributes.position;if(null===l){if(void 0===h||0===h.count)return}else if(0===l.count)return;let c,u=1;!0===n.wireframe&&(l=lt.getWireframeAttribute(i),u=2),void 0===i.morphAttributes.position&&void 0===i.morphAttributes.normal||vt.update(r,i,n,o),Mt.setup(r,n,o,i,l);let d=yt;null!==l&&(c=at.get(l),d=xt,d.setIndex(c));const p=null!==l?l.count:h.count,f=i.drawRange.start*u,m=i.drawRange.count*u,g=null!==s?s.start*u:0,v=null!==s?s.count*u:1/0,y=Math.max(f,g),x=Math.min(p,f+m,g+v)-1,_=Math.max(0,x-y+1);if(0!==_){if(r.isMesh)!0===n.wireframe?(Q.setLineWidth(n.wireframeLinewidth*Z()),d.setMode(bt.LINES)):d.setMode(bt.TRIANGLES);else if(r.isLine){let t=n.linewidth;void 0===t&&(t=1),Q.setLineWidth(t*Z()),r.isLineSegments?d.setMode(bt.LINES):r.isLineLoop?d.setMode(bt.LINE_LOOP):d.setMode(bt.LINE_STRIP)}else r.isPoints?d.setMode(bt.POINTS):r.isSprite&&d.setMode(bt.TRIANGLES);if(r.isInstancedMesh)d.renderInstances(y,_,r.count);else if(i.isInstancedBufferGeometry){const t=Math.min(i.instanceCount,i._maxInstanceCount);d.renderInstances(y,_,t)}else d.render(y,_)}},this.compile=function(t,e){d=pt.get(t),d.init(),f.push(d),t.traverseVisible((function(t){t.isLight&&t.layers.test(e.layers)&&(d.pushLight(t),t.castShadow&&d.pushShadow(t))})),d.setupLights(),t.traverse((function(e){const i=e.material;if(i)if(Array.isArray(i))for(let n=0;n<i.length;n++){Ut(i[n],t,e)}else Ut(i,t,e)})),f.pop(),d=null};let At=null;function Rt(){Dt.stop()}function Pt(){Dt.start()}const Dt=new jt;function Nt(t,e,i,n){if(!1===t.visible)return;if(t.layers.test(e.layers))if(t.isGroup)i=t.renderOrder;else if(t.isLOD)!0===t.autoUpdate&&t.update(e);else if(t.isLight)d.pushLight(t),t.castShadow&&d.pushShadow(t);else if(t.isSprite){if(!t.frustumCulled||H.intersectsSprite(t)){n&&q.setFromMatrixPosition(t.matrixWorld).applyMatrix4(X);const e=ht.update(t),r=t.material;r.visible&&u.push(t,e,r,i,q.z,null)}}else if(t.isImmediateRenderObject)n&&q.setFromMatrixPosition(t.matrixWorld).applyMatrix4(X),u.push(t,null,t.material,i,q.z,null);else if((t.isMesh||t.isLine||t.isPoints)&&(t.isSkinnedMesh&&t.skeleton.frame!==$.render.frame&&(t.skeleton.update(),t.skeleton.frame=$.render.frame),!t.frustumCulled||H.intersectsObject(t))){n&&q.setFromMatrixPosition(t.matrixWorld).applyMatrix4(X);const e=ht.update(t),r=t.material;if(Array.isArray(r)){const n=e.groups;for(let s=0,a=n.length;s<a;s++){const a=n[s],o=r[a.materialIndex];o&&o.visible&&u.push(t,e,o,i,q.z,a)}}else r.visible&&u.push(t,e,r,i,q.z,null)}const r=t.children;for(let t=0,s=r.length;t<s;t++)Nt(r[t],e,i,n)}function It(t,e,i){const n=!0===e.isScene?e.overrideMaterial:null;if(i.isArrayCamera){const r=i.cameras;for(let i=0,s=r.length;i<s;i++){const s=r[i];Q.viewport(T.copy(s.viewport)),d.setupLightsView(s);for(let i=0,r=t.length;i<r;i++){const r=t[i],a=r.object,o=r.geometry,l=null===n?r.material:n,h=r.group;a.layers.test(s.layers)&&Ft(a,e,s,o,l,h)}}}else for(let r=0,s=t.length;r<s;r++){const s=t[r];Ft(s.object,e,i,s.geometry,null===n?s.material:n,s.group)}}function Ft(t,e,i,n,r,s){if(t.onBeforeRender(m,e,i,n,r,s),t.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix),t.isImmediateRenderObject){const n=kt(i,e,r,t);Q.setMaterial(r),Mt.reset(),function(t,e){t.render((function(t){m.renderBufferImmediate(t,e)}))}(t,n)}else!0===r.transparent&&2===r.side?(r.side=1,r.needsUpdate=!0,m.renderBufferDirect(i,e,n,r,t,s),r.side=0,r.needsUpdate=!0,m.renderBufferDirect(i,e,n,r,t,s),r.side=2):m.renderBufferDirect(i,e,n,r,t,s);t.onAfterRender(m,e,i,n,r,s)}function Ut(t,e,i){!0!==e.isScene&&(e=Y);const n=tt.get(t),r=d.state.lights,s=d.state.shadowsArray,a=r.state.version,o=ct.getParameters(t,r.state,s,e,i),l=ct.getProgramCacheKey(o);let h=n.programs;n.environment=t.isMeshStandardMaterial?e.environment:null,n.fog=e.fog,n.envMap=(t.isMeshStandardMaterial?nt:it).get(t.envMap||n.environment),void 0===h&&(t.addEventListener("dispose",Lt),h=new Map,n.programs=h);let c=h.get(l);if(void 0!==c){if(n.currentProgram===c&&n.lightsStateVersion===a)return Bt(t,o),c}else o.uniforms=ct.getUniforms(t),t.onBuild(o,m),t.onBeforeCompile(o,m),c=ct.acquireProgram(o,l),h.set(l,c),n.uniforms=o.uniforms;const u=n.uniforms;(t.isShaderMaterial||t.isRawShaderMaterial)&&!0!==t.clipping||(u.clippingPlanes=ft.uniform),Bt(t,o),n.needsLights=function(t){return t.isMeshLambertMaterial||t.isMeshToonMaterial||t.isMeshPhongMaterial||t.isMeshStandardMaterial||t.isShadowMaterial||t.isShaderMaterial&&!0===t.lights}(t),n.lightsStateVersion=a,n.needsLights&&(u.ambientLightColor.value=r.state.ambient,u.lightProbe.value=r.state.probe,u.directionalLights.value=r.state.directional,u.directionalLightShadows.value=r.state.directionalShadow,u.spotLights.value=r.state.spot,u.spotLightShadows.value=r.state.spotShadow,u.rectAreaLights.value=r.state.rectArea,u.ltc_1.value=r.state.rectAreaLTC1,u.ltc_2.value=r.state.rectAreaLTC2,u.pointLights.value=r.state.point,u.pointLightShadows.value=r.state.pointShadow,u.hemisphereLights.value=r.state.hemi,u.directionalShadowMap.value=r.state.directionalShadowMap,u.directionalShadowMatrix.value=r.state.directionalShadowMatrix,u.spotShadowMap.value=r.state.spotShadowMap,u.spotShadowMatrix.value=r.state.spotShadowMatrix,u.pointShadowMap.value=r.state.pointShadowMap,u.pointShadowMatrix.value=r.state.pointShadowMatrix);const p=c.getUniforms(),f=Ar.seqWithValue(p.seq,u);return n.currentProgram=c,n.uniformsList=f,c}function Bt(t,e){const i=tt.get(t);i.outputEncoding=e.outputEncoding,i.instancing=e.instancing,i.skinning=e.skinning,i.morphTargets=e.morphTargets,i.morphNormals=e.morphNormals,i.numClippingPlanes=e.numClippingPlanes,i.numIntersection=e.numClipIntersection,i.vertexAlphas=e.vertexAlphas,i.vertexTangents=e.vertexTangents}function kt(t,e,i,n){!0!==e.isScene&&(e=Y),et.resetTextureUnits();const r=e.fog,s=i.isMeshStandardMaterial?e.environment:null,a=null===_?m.outputEncoding:_.texture.encoding,o=(i.isMeshStandardMaterial?nt:it).get(i.envMap||s),l=!0===i.vertexColors&&!!n.geometry&&!!n.geometry.attributes.color&&4===n.geometry.attributes.color.itemSize,h=!!n.geometry&&!!n.geometry.attributes.tangent,c=!!n.geometry&&!!n.geometry.morphAttributes.position,u=!!n.geometry&&!!n.geometry.morphAttributes.normal,p=tt.get(i),f=d.state.lights;if(!0===V&&(!0===W||t!==E)){const e=t===E&&i.id===b;ft.setState(i,t,e)}let g=!1;i.version===p.__version?p.needsLights&&p.lightsStateVersion!==f.state.version||p.outputEncoding!==a||n.isInstancedMesh&&!1===p.instancing?g=!0:n.isInstancedMesh||!0!==p.instancing?n.isSkinnedMesh&&!1===p.skinning?g=!0:n.isSkinnedMesh||!0!==p.skinning?p.envMap!==o||i.fog&&p.fog!==r?g=!0:void 0===p.numClippingPlanes||p.numClippingPlanes===ft.numPlanes&&p.numIntersection===ft.numIntersection?(p.vertexAlphas!==l||p.vertexTangents!==h||p.morphTargets!==c||p.morphNormals!==u)&&(g=!0):g=!0:g=!0:g=!0:(g=!0,p.__version=i.version);let v=p.currentProgram;!0===g&&(v=Ut(i,e,n));let y=!1,x=!1,M=!1;const S=v.getUniforms(),w=p.uniforms;if(Q.useProgram(v.program)&&(y=!0,x=!0,M=!0),i.id!==b&&(b=i.id,x=!0),y||E!==t){if(S.setValue(bt,"projectionMatrix",t.projectionMatrix),K.logarithmicDepthBuffer&&S.setValue(bt,"logDepthBufFC",2/(Math.log(t.far+1)/Math.LN2)),E!==t&&(E=t,x=!0,M=!0),i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshStandardMaterial||i.envMap){const e=S.map.cameraPosition;void 0!==e&&e.setValue(bt,q.setFromMatrixPosition(t.matrixWorld))}(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial)&&S.setValue(bt,"isOrthographic",!0===t.isOrthographicCamera),(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.isShadowMaterial||n.isSkinnedMesh)&&S.setValue(bt,"viewMatrix",t.matrixWorldInverse)}if(n.isSkinnedMesh){S.setOptional(bt,n,"bindMatrix"),S.setOptional(bt,n,"bindMatrixInverse");const t=n.skeleton;t&&(K.floatVertexTextures?(null===t.boneTexture&&t.computeBoneTexture(),S.setValue(bt,"boneTexture",t.boneTexture,et),S.setValue(bt,"boneTextureSize",t.boneTextureSize)):S.setOptional(bt,t,"boneMatrices"))}return(x||p.receiveShadow!==n.receiveShadow)&&(p.receiveShadow=n.receiveShadow,S.setValue(bt,"receiveShadow",n.receiveShadow)),x&&(S.setValue(bt,"toneMappingExposure",m.toneMappingExposure),p.needsLights&&function(t,e){t.ambientLightColor.needsUpdate=e,t.lightProbe.needsUpdate=e,t.directionalLights.needsUpdate=e,t.directionalLightShadows.needsUpdate=e,t.pointLights.needsUpdate=e,t.pointLightShadows.needsUpdate=e,t.spotLights.needsUpdate=e,t.spotLightShadows.needsUpdate=e,t.rectAreaLights.needsUpdate=e,t.hemisphereLights.needsUpdate=e}(w,M),r&&i.fog&&ut.refreshFogUniforms(w,r),ut.refreshMaterialUniforms(w,i,F,N,j),Ar.upload(bt,p.uniformsList,w,et)),i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(Ar.upload(bt,p.uniformsList,w,et),i.uniformsNeedUpdate=!1),i.isSpriteMaterial&&S.setValue(bt,"center",n.center),S.setValue(bt,"modelViewMatrix",n.modelViewMatrix),S.setValue(bt,"normalMatrix",n.normalMatrix),S.setValue(bt,"modelMatrix",n.matrixWorld),v}Dt.setAnimationLoop((function(t){At&&At(t)})),"undefined"!=typeof window&&Dt.setContext(window),this.setAnimationLoop=function(t){At=t,Et.setAnimationLoop(t),null===t?Dt.stop():Dt.start()},Et.addEventListener("sessionstart",Rt),Et.addEventListener("sessionend",Pt),this.render=function(t,e){if(void 0!==e&&!0!==e.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===g)return;!0===t.autoUpdate&&t.updateMatrixWorld(),null===e.parent&&e.updateMatrixWorld(),!0===Et.enabled&&!0===Et.isPresenting&&(!0===Et.cameraAutoUpdate&&Et.updateCamera(e),e=Et.getCamera()),!0===t.isScene&&t.onBeforeRender(m,t,e,_),d=pt.get(t,f.length),d.init(),f.push(d),X.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),H.setFromProjectionMatrix(X),W=this.localClippingEnabled,V=ft.init(this.clippingPlanes,W,e),u=dt.get(t,p.length),u.init(),p.push(u),Nt(t,e,0,m.sortObjects),u.finish(),!0===m.sortObjects&&u.sort(O,z),!0===V&&ft.beginShadows();const i=d.state.shadowsArray;mt.render(i,t,e),d.setupLights(),d.setupLightsView(e),!0===V&&ft.endShadows(),!0===this.info.autoReset&&this.info.reset(),gt.render(u,t);const n=u.opaque,r=u.transmissive,s=u.transparent;n.length>0&&It(n,t,e),r.length>0&&function(t,e,i,n){if(null===j){const t=!0===a&&!0===K.isWebGL2;j=new(t?wn:st)(1024,1024,{generateMipmaps:!0,type:null!==_t.convert(L)?L:w,minFilter:S,magFilter:M,wrapS:x,wrapT:x})}const r=m.getRenderTarget();m.setRenderTarget(j),m.clear();const s=m.toneMapping;m.toneMapping=0,It(t,i,n),m.toneMapping=s,et.updateMultisampleRenderTarget(j),et.updateRenderTargetMipmap(j),m.setRenderTarget(r),It(e,i,n)}(n,r,t,e),s.length>0&&It(s,t,e),null!==_&&(et.updateMultisampleRenderTarget(_),et.updateRenderTargetMipmap(_)),!0===t.isScene&&t.onAfterRender(m,t,e),Q.buffers.depth.setTest(!0),Q.buffers.depth.setMask(!0),Q.buffers.color.setMask(!0),Q.setPolygonOffset(!1),Mt.resetDefaultState(),b=-1,E=null,f.pop(),d=f.length>0?f[f.length-1]:null,p.pop(),u=p.length>0?p[p.length-1]:null},this.getActiveCubeFace=function(){return v},this.getActiveMipmapLevel=function(){return y},this.getRenderTarget=function(){return _},this.setRenderTarget=function(t,e=0,i=0){_=t,v=e,y=i,t&&void 0===tt.get(t).__webglFramebuffer&&et.setupRenderTarget(t);let n=null,r=!1,s=!1;if(t){const i=t.texture;(i.isDataTexture3D||i.isDataTexture2DArray)&&(s=!0);const a=tt.get(t).__webglFramebuffer;t.isWebGLCubeRenderTarget?(n=a[e],r=!0):n=t.isWebGLMultisampleRenderTarget?tt.get(t).__webglMultisampledFramebuffer:a,T.copy(t.viewport),A.copy(t.scissor),R=t.scissorTest}else T.copy(U).multiplyScalar(F).floor(),A.copy(B).multiplyScalar(F).floor(),R=k;if(Q.bindFramebuffer(bt.FRAMEBUFFER,n)&&K.drawBuffers){let e=!1;if(t)if(t.isWebGLMultipleRenderTargets){const i=t.texture;if(G.length!==i.length||G[0]!==bt.COLOR_ATTACHMENT0){for(let t=0,e=i.length;t<e;t++)G[t]=bt.COLOR_ATTACHMENT0+t;G.length=i.length,e=!0}}else 1===G.length&&G[0]===bt.COLOR_ATTACHMENT0||(G[0]=bt.COLOR_ATTACHMENT0,G.length=1,e=!0);else 1===G.length&&G[0]===bt.BACK||(G[0]=bt.BACK,G.length=1,e=!0);e&&(K.isWebGL2?bt.drawBuffers(G):J.get("WEBGL_draw_buffers").drawBuffersWEBGL(G))}if(Q.viewport(T),Q.scissor(A),Q.setScissorTest(R),r){const n=tt.get(t.texture);bt.framebufferTexture2D(bt.FRAMEBUFFER,bt.COLOR_ATTACHMENT0,bt.TEXTURE_CUBE_MAP_POSITIVE_X+e,n.__webglTexture,i)}else if(s){const n=tt.get(t.texture),r=e||0;bt.framebufferTextureLayer(bt.FRAMEBUFFER,bt.COLOR_ATTACHMENT0,n.__webglTexture,i||0,r)}},this.readRenderTargetPixels=function(t,e,i,n,r,s,a){if(!t||!t.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let o=tt.get(t).__webglFramebuffer;if(t.isWebGLCubeRenderTarget&&void 0!==a&&(o=o[a]),o){Q.bindFramebuffer(bt.FRAMEBUFFER,o);try{const a=t.texture,o=a.format,l=a.type;if(o!==P&&_t.convert(o)!==bt.getParameter(bt.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");const h=l===L&&(J.has("EXT_color_buffer_half_float")||K.isWebGL2&&J.has("EXT_color_buffer_float"));if(!(l===w||_t.convert(l)===bt.getParameter(bt.IMPLEMENTATION_COLOR_READ_TYPE)||l===C&&(K.isWebGL2||J.has("OES_texture_float")||J.has("WEBGL_color_buffer_float"))||h))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");bt.checkFramebufferStatus(bt.FRAMEBUFFER)===bt.FRAMEBUFFER_COMPLETE?e>=0&&e<=t.width-n&&i>=0&&i<=t.height-r&&bt.readPixels(e,i,n,r,_t.convert(o),_t.convert(l),s):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{const t=null!==_?tt.get(_).__webglFramebuffer:null;Q.bindFramebuffer(bt.FRAMEBUFFER,t)}}},this.copyFramebufferToTexture=function(t,e,i=0){const n=Math.pow(2,-i),r=Math.floor(e.image.width*n),s=Math.floor(e.image.height*n);let a=_t.convert(e.format);K.isWebGL2&&(a===bt.RGB&&(a=bt.RGB8),a===bt.RGBA&&(a=bt.RGBA8)),et.setTexture2D(e,0),bt.copyTexImage2D(bt.TEXTURE_2D,i,a,t.x,t.y,r,s,0),Q.unbindTexture()},this.copyTextureToTexture=function(t,e,i,n=0){const r=e.image.width,s=e.image.height,a=_t.convert(i.format),o=_t.convert(i.type);et.setTexture2D(i,0),bt.pixelStorei(bt.UNPACK_FLIP_Y_WEBGL,i.flipY),bt.pixelStorei(bt.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i.premultiplyAlpha),bt.pixelStorei(bt.UNPACK_ALIGNMENT,i.unpackAlignment),e.isDataTexture?bt.texSubImage2D(bt.TEXTURE_2D,n,t.x,t.y,r,s,a,o,e.image.data):e.isCompressedTexture?bt.compressedTexSubImage2D(bt.TEXTURE_2D,n,t.x,t.y,e.mipmaps[0].width,e.mipmaps[0].height,a,e.mipmaps[0].data):bt.texSubImage2D(bt.TEXTURE_2D,n,t.x,t.y,a,o,e.image),0===n&&i.generateMipmaps&&bt.generateMipmap(bt.TEXTURE_2D),Q.unbindTexture()},this.copyTextureToTexture3D=function(t,e,i,n,r=0){if(m.isWebGL1Renderer)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");const s=t.max.x-t.min.x+1,a=t.max.y-t.min.y+1,o=t.max.z-t.min.z+1,l=_t.convert(n.format),h=_t.convert(n.type);let c;if(n.isDataTexture3D)et.setTexture3D(n,0),c=bt.TEXTURE_3D;else{if(!n.isDataTexture2DArray)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");et.setTexture2DArray(n,0),c=bt.TEXTURE_2D_ARRAY}bt.pixelStorei(bt.UNPACK_FLIP_Y_WEBGL,n.flipY),bt.pixelStorei(bt.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),bt.pixelStorei(bt.UNPACK_ALIGNMENT,n.unpackAlignment);const u=bt.getParameter(bt.UNPACK_ROW_LENGTH),d=bt.getParameter(bt.UNPACK_IMAGE_HEIGHT),p=bt.getParameter(bt.UNPACK_SKIP_PIXELS),f=bt.getParameter(bt.UNPACK_SKIP_ROWS),g=bt.getParameter(bt.UNPACK_SKIP_IMAGES),v=i.isCompressedTexture?i.mipmaps[0]:i.image;bt.pixelStorei(bt.UNPACK_ROW_LENGTH,v.width),bt.pixelStorei(bt.UNPACK_IMAGE_HEIGHT,v.height),bt.pixelStorei(bt.UNPACK_SKIP_PIXELS,t.min.x),bt.pixelStorei(bt.UNPACK_SKIP_ROWS,t.min.y),bt.pixelStorei(bt.UNPACK_SKIP_IMAGES,t.min.z),i.isDataTexture||i.isDataTexture3D?bt.texSubImage3D(c,r,e.x,e.y,e.z,s,a,o,l,h,v.data):i.isCompressedTexture?(console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: untested support for compressed srcTexture."),bt.compressedTexSubImage3D(c,r,e.x,e.y,e.z,s,a,o,l,v.data)):bt.texSubImage3D(c,r,e.x,e.y,e.z,s,a,o,l,h,v),bt.pixelStorei(bt.UNPACK_ROW_LENGTH,u),bt.pixelStorei(bt.UNPACK_IMAGE_HEIGHT,d),bt.pixelStorei(bt.UNPACK_SKIP_PIXELS,p),bt.pixelStorei(bt.UNPACK_SKIP_ROWS,f),bt.pixelStorei(bt.UNPACK_SKIP_IMAGES,g),0===r&&n.generateMipmaps&&bt.generateMipmap(c),Q.unbindTexture()},this.initTexture=function(t){et.setTexture2D(t,0),Q.unbindTexture()},this.resetState=function(){v=0,y=0,_=null,Q.reset(),Mt.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}class Ms{constructor(t,e=25e-5){this.name="",this.color=new $t(t),this.density=e}clone(){return new Ms(this.color,this.density)}toJSON(){return{type:"FogExp2",color:this.color.getHex(),density:this.density}}}Ms.prototype.isFogExp2=!0;class bs extends Se{constructor(){super(),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(t,e){return super.copy(t,e),null!==t.background&&(this.background=t.background.clone()),null!==t.environment&&(this.environment=t.environment.clone()),null!==t.fog&&(this.fog=t.fog.clone()),null!==t.overrideMaterial&&(this.overrideMaterial=t.overrideMaterial.clone()),this.autoUpdate=t.autoUpdate,this.matrixAutoUpdate=t.matrixAutoUpdate,this}toJSON(t){const e=super.toJSON(t);return null!==this.fog&&(e.object.fog=this.fog.toJSON()),e}}bs.prototype.isScene=!0;class Ss extends Oe{constructor(t){super(),this.type="LineBasicMaterial",this.color=new $t(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this}}Ss.prototype.isLineBasicMaterial=!0;const ws=new ot,Es=new ot,Ts=new zt,Cs=new Ye,Ls=new At;class As extends Se{constructor(t=new De,e=new Ss){super(),this.type="Line",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t){return super.copy(t),this.material=t.material,this.geometry=t.geometry,this}computeLineDistances(){const t=this.geometry;if(t.isBufferGeometry)if(null===t.index){const e=t.attributes.position,i=[0];for(let t=1,n=e.count;t<n;t++)ws.fromBufferAttribute(e,t-1),Es.fromBufferAttribute(e,t),i[t]=i[t-1],i[t]+=ws.distanceTo(Es);t.setAttribute("lineDistance",new se(i,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else t.isGeometry&&console.error("THREE.Line.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this}raycast(t,e){const i=this.geometry,n=this.matrixWorld,r=t.params.Line.threshold,s=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),Ls.copy(i.boundingSphere),Ls.applyMatrix4(n),Ls.radius+=r,!1===t.ray.intersectsSphere(Ls))return;Ts.copy(n).invert(),Cs.copy(t.ray).applyMatrix4(Ts);const a=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,l=new ot,h=new ot,c=new ot,u=new ot,d=this.isLineSegments?2:1;if(i.isBufferGeometry){const n=i.index,r=i.attributes.position;if(null!==n){for(let i=Math.max(0,s.start),a=Math.min(n.count,s.start+s.count)-1;i<a;i+=d){const s=n.getX(i),a=n.getX(i+1);l.fromBufferAttribute(r,s),h.fromBufferAttribute(r,a);if(Cs.distanceSqToSegment(l,h,u,c)>o)continue;u.applyMatrix4(this.matrixWorld);const d=t.ray.origin.distanceTo(u);d<t.near||d>t.far||e.push({distance:d,point:c.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}else{for(let i=Math.max(0,s.start),n=Math.min(r.count,s.start+s.count)-1;i<n;i+=d){l.fromBufferAttribute(r,i),h.fromBufferAttribute(r,i+1);if(Cs.distanceSqToSegment(l,h,u,c)>o)continue;u.applyMatrix4(this.matrixWorld);const n=t.ray.origin.distanceTo(u);n<t.near||n>t.far||e.push({distance:n,point:c.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}}else i.isGeometry&&console.error("THREE.Line.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}updateMorphTargets(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,i=Object.keys(e);if(i.length>0){const t=e[i[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=t.length;e<i;e++){const i=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Line.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}As.prototype.isLine=!0;const Rs=new ot,Ps=new ot;class Ds extends As{constructor(t,e){super(t,e),this.type="LineSegments"}computeLineDistances(){const t=this.geometry;if(t.isBufferGeometry)if(null===t.index){const e=t.attributes.position,i=[];for(let t=0,n=e.count;t<n;t+=2)Rs.fromBufferAttribute(e,t),Ps.fromBufferAttribute(e,t+1),i[t]=0===t?0:i[t-1],i[t+1]=i[t]+Rs.distanceTo(Ps);t.setAttribute("lineDistance",new se(i,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else t.isGeometry&&console.error("THREE.LineSegments.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this}}Ds.prototype.isLineSegments=!0;class Ns extends Oe{constructor(t){super(),this.type="PointsMaterial",this.color=new $t(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this}}Ns.prototype.isPointsMaterial=!0;const Is=new zt,Fs=new Ye,Os=new At,zs=new ot;class Us extends Se{constructor(t=new De,e=new Ns){super(),this.type="Points",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t){return super.copy(t),this.material=t.material,this.geometry=t.geometry,this}raycast(t,e){const i=this.geometry,n=this.matrixWorld,r=t.params.Points.threshold,s=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),Os.copy(i.boundingSphere),Os.applyMatrix4(n),Os.radius+=r,!1===t.ray.intersectsSphere(Os))return;Is.copy(n).invert(),Fs.copy(t.ray).applyMatrix4(Is);const a=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a;if(i.isBufferGeometry){const r=i.index,a=i.attributes.position;if(null!==r){for(let i=Math.max(0,s.start),l=Math.min(r.count,s.start+s.count);i<l;i++){const s=r.getX(i);zs.fromBufferAttribute(a,s),Bs(zs,s,o,n,t,e,this)}}else{for(let i=Math.max(0,s.start),r=Math.min(a.count,s.start+s.count);i<r;i++)zs.fromBufferAttribute(a,i),Bs(zs,i,o,n,t,e,this)}}else console.error("THREE.Points.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}updateMorphTargets(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,i=Object.keys(e);if(i.length>0){const t=e[i[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=t.length;e<i;e++){const i=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Points.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}function Bs(t,e,i,n,r,s,a){const o=Fs.distanceSqToPoint(t);if(o<i){const i=new ot;Fs.closestPointToPoint(t,i),i.applyMatrix4(n);const l=r.ray.origin.distanceTo(i);if(l<r.near||l>r.far)return;s.push({distance:l,distanceToRay:Math.sqrt(o),point:i,index:e,face:null,object:a})}}Us.prototype.isPoints=!0;class ks extends it{constructor(t=null,e=1,i=1,n,r,s,a,o,l=1003,h=1003,c,u){super(null,s,a,o,l,h,n,r,c,u),this.image={data:t,width:e,height:i},this.magFilter=l,this.minFilter=h,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}ks.prototype.isDataTexture=!0;class Gs extends it{constructor(t,e,i,n,r,s,a,o,l){super(t,e,i,n,r,s,a,o,l),this.needsUpdate=!0}}Gs.prototype.isCanvasTexture=!0;class Hs extends De{constructor(t=1,e=32,i=16,n=0,r=2*Math.PI,s=0,a=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:n,phiLength:r,thetaStart:s,thetaLength:a},e=Math.max(3,Math.floor(e)),i=Math.max(2,Math.floor(i));const o=Math.min(s+a,Math.PI);let l=0;const h=[],c=new ot,u=new ot,d=[],p=[],f=[],m=[];for(let d=0;d<=i;d++){const g=[],v=d/i;let y=0;0==d&&0==s?y=.5/e:d==i&&o==Math.PI&&(y=-.5/e);for(let i=0;i<=e;i++){const o=i/e;c.x=-t*Math.cos(n+o*r)*Math.sin(s+v*a),c.y=t*Math.cos(s+v*a),c.z=t*Math.sin(n+o*r)*Math.sin(s+v*a),p.push(c.x,c.y,c.z),u.copy(c).normalize(),f.push(u.x,u.y,u.z),m.push(o+y,1-v),g.push(l++)}h.push(g)}for(let t=0;t<i;t++)for(let n=0;n<e;n++){const e=h[t][n+1],r=h[t][n],a=h[t+1][n],l=h[t+1][n+1];(0!==t||s>0)&&d.push(e,r,l),(t!==i-1||o<Math.PI)&&d.push(r,a,l)}this.setIndex(d),this.setAttribute("position",new se(p,3)),this.setAttribute("normal",new se(f,3)),this.setAttribute("uv",new se(m,2))}static fromJSON(t){return new Hs(t.radius,t.widthSegments,t.heightSegments,t.phiStart,t.phiLength,t.thetaStart,t.thetaLength)}}class Vs extends De{constructor(t=.5,e=1,i=8,n=1,r=0,s=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:t,outerRadius:e,thetaSegments:i,phiSegments:n,thetaStart:r,thetaLength:s},i=Math.max(3,i);const a=[],o=[],l=[],h=[];let c=t;const u=(e-t)/(n=Math.max(1,n)),d=new ot,p=new Q;for(let t=0;t<=n;t++){for(let t=0;t<=i;t++){const n=r+t/i*s;d.x=c*Math.cos(n),d.y=c*Math.sin(n),o.push(d.x,d.y,d.z),l.push(0,0,1),p.x=(d.x/e+1)/2,p.y=(d.y/e+1)/2,h.push(p.x,p.y)}c+=u}for(let t=0;t<n;t++){const e=t*(i+1);for(let t=0;t<i;t++){const n=t+e,r=n,s=n+i+1,o=n+i+2,l=n+1;a.push(r,s,l),a.push(s,o,l)}}this.setIndex(a),this.setAttribute("position",new se(o,3)),this.setAttribute("normal",new se(l,3)),this.setAttribute("uv",new se(h,2))}static fromJSON(t){return new Vs(t.innerRadius,t.outerRadius,t.thetaSegments,t.phiSegments,t.thetaStart,t.thetaLength)}}class Ws extends De{constructor(t=1,e=1,i=1,n=8,r=1,s=!1,a=0,o=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:t,radiusBottom:e,height:i,radialSegments:n,heightSegments:r,openEnded:s,thetaStart:a,thetaLength:o};const l=this;n=Math.floor(n),r=Math.floor(r);const h=[],c=[],u=[],d=[];let p=0;const f=[],m=i/2;let g=0;function v(i){const r=p,s=new Q,f=new ot;let v=0;const y=!0===i?t:e,x=!0===i?1:-1;for(let t=1;t<=n;t++)c.push(0,m*x,0),u.push(0,x,0),d.push(.5,.5),p++;const _=p;for(let t=0;t<=n;t++){const e=t/n*o+a,i=Math.cos(e),r=Math.sin(e);f.x=y*r,f.y=m*x,f.z=y*i,c.push(f.x,f.y,f.z),u.push(0,x,0),s.x=.5*i+.5,s.y=.5*r*x+.5,d.push(s.x,s.y),p++}for(let t=0;t<n;t++){const e=r+t,n=_+t;!0===i?h.push(n,n+1,e):h.push(n+1,n,e),v+=3}l.addGroup(g,v,!0===i?1:2),g+=v}!function(){const s=new ot,v=new ot;let y=0;const x=(e-t)/i;for(let l=0;l<=r;l++){const h=[],g=l/r,y=g*(e-t)+t;for(let t=0;t<=n;t++){const e=t/n,r=e*o+a,l=Math.sin(r),f=Math.cos(r);v.x=y*l,v.y=-g*i+m,v.z=y*f,c.push(v.x,v.y,v.z),s.set(l,x,f).normalize(),u.push(s.x,s.y,s.z),d.push(e,1-g),h.push(p++)}f.push(h)}for(let t=0;t<n;t++)for(let e=0;e<r;e++){const i=f[e][t],n=f[e+1][t],r=f[e+1][t+1],s=f[e][t+1];h.push(i,n,s),h.push(n,r,s),y+=6}l.addGroup(g,y,0),g+=y}(),!1===s&&(t>0&&v(!0),e>0&&v(!1)),this.setIndex(h),this.setAttribute("position",new se(c,3)),this.setAttribute("normal",new se(u,3)),this.setAttribute("uv",new se(d,2))}static fromJSON(t){return new Ws(t.radiusTop,t.radiusBottom,t.height,t.radialSegments,t.heightSegments,t.openEnded,t.thetaStart,t.thetaLength)}}class js extends Oe{constructor(t){super(),this.type="MeshLambertMaterial",this.color=new $t(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new $t(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this}}js.prototype.isMeshLambertMaterial=!0;class Xs extends Oe{constructor(t){super(),this.type="MeshPhongMaterial",this.color=new $t(16777215),this.specular=new $t(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new $t(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Q(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.specular.copy(t.specular),this.shininess=t.shininess,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this}}Xs.prototype.isMeshPhongMaterial=!0;const qs={enabled:!1,files:{},add:function(t,e){!1!==this.enabled&&(this.files[t]=e)},get:function(t){if(!1!==this.enabled)return this.files[t]},remove:function(t){delete this.files[t]},clear:function(){this.files={}}};const Ys=new class{constructor(t,e,i){const n=this;let r,s=!1,a=0,o=0;const l=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=i,this.itemStart=function(t){o++,!1===s&&void 0!==n.onStart&&n.onStart(t,a,o),s=!0},this.itemEnd=function(t){a++,void 0!==n.onProgress&&n.onProgress(t,a,o),a===o&&(s=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(t){void 0!==n.onError&&n.onError(t)},this.resolveURL=function(t){return r?r(t):t},this.setURLModifier=function(t){return r=t,this},this.addHandler=function(t,e){return l.push(t,e),this},this.removeHandler=function(t){const e=l.indexOf(t);return-1!==e&&l.splice(e,2),this},this.getHandler=function(t){for(let e=0,i=l.length;e<i;e+=2){const i=l[e],n=l[e+1];if(i.global&&(i.lastIndex=0),i.test(t))return n}return null}}};class Zs{constructor(t){this.manager=void 0!==t?t:Ys,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(t,e){const i=this;return new Promise((function(n,r){i.load(t,n,e,r)}))}parse(){}setCrossOrigin(t){return this.crossOrigin=t,this}setWithCredentials(t){return this.withCredentials=t,this}setPath(t){return this.path=t,this}setResourcePath(t){return this.resourcePath=t,this}setRequestHeader(t){return this.requestHeader=t,this}}class Js extends Zs{constructor(t){super(t)}load(t,e,i,n){void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,s=qs.get(t);if(void 0!==s)return r.manager.itemStart(t),setTimeout((function(){e&&e(s),r.manager.itemEnd(t)}),0),s;const a=document.createElementNS("http://www.w3.org/1999/xhtml","img");function o(){a.removeEventListener("load",o,!1),a.removeEventListener("error",l,!1),qs.add(t,this),e&&e(this),r.manager.itemEnd(t)}function l(e){a.removeEventListener("load",o,!1),a.removeEventListener("error",l,!1),n&&n(e),r.manager.itemError(t),r.manager.itemEnd(t)}return a.addEventListener("load",o,!1),a.addEventListener("error",l,!1),"data:"!==t.substr(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),r.manager.itemStart(t),a.src=t,a}}class Ks extends Zs{constructor(t){super(t)}load(t,e,i,n){const r=new it,s=new Js(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(t,(function(i){r.image=i;const n=t.search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/);r.format=n?R:P,r.needsUpdate=!0,void 0!==e&&e(r)}),i,n),r}}const Qs={};class $s extends Zs{constructor(t){super(t)}load(t,e,i,n){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,s=qs.get(t);if(void 0!==s)return r.manager.itemStart(t),setTimeout((function(){e&&e(s),r.manager.itemEnd(t)}),0),s;if(void 0!==Qs[t])return void Qs[t].push({onLoad:e,onProgress:i,onError:n});const a=t.match(/^data:(.*?)(;base64)?,(.*)$/);let o;if(a){const i=a[1],s=!!a[2];let o=a[3];o=decodeURIComponent(o),s&&(o=atob(o));try{let n;const s=(this.responseType||"").toLowerCase();switch(s){case"arraybuffer":case"blob":const t=new Uint8Array(o.length);for(let e=0;e<o.length;e++)t[e]=o.charCodeAt(e);n="blob"===s?new Blob([t.buffer],{type:i}):t.buffer;break;case"document":const e=new DOMParser;n=e.parseFromString(o,i);break;case"json":n=JSON.parse(o);break;default:n=o}setTimeout((function(){e&&e(n),r.manager.itemEnd(t)}),0)}catch(e){setTimeout((function(){n&&n(e),r.manager.itemError(t),r.manager.itemEnd(t)}),0)}}else{Qs[t]=[],Qs[t].push({onLoad:e,onProgress:i,onError:n}),o=new XMLHttpRequest,o.open("GET",t,!0),o.addEventListener("load",(function(e){const i=this.response,n=Qs[t];if(delete Qs[t],200===this.status||0===this.status){0===this.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),qs.add(t,i);for(let t=0,e=n.length;t<e;t++){const e=n[t];e.onLoad&&e.onLoad(i)}r.manager.itemEnd(t)}else{for(let t=0,i=n.length;t<i;t++){const i=n[t];i.onError&&i.onError(e)}r.manager.itemError(t),r.manager.itemEnd(t)}}),!1),o.addEventListener("progress",(function(e){const i=Qs[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onProgress&&n.onProgress(e)}}),!1),o.addEventListener("error",(function(e){const i=Qs[t];delete Qs[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onError&&n.onError(e)}r.manager.itemError(t),r.manager.itemEnd(t)}),!1),o.addEventListener("abort",(function(e){const i=Qs[t];delete Qs[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onError&&n.onError(e)}r.manager.itemError(t),r.manager.itemEnd(t)}),!1),void 0!==this.responseType&&(o.responseType=this.responseType),void 0!==this.withCredentials&&(o.withCredentials=this.withCredentials),o.overrideMimeType&&o.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(const t in this.requestHeader)o.setRequestHeader(t,this.requestHeader[t]);o.send(null)}return r.manager.itemStart(t),o}setResponseType(t){return this.responseType=t,this}setMimeType(t){return this.mimeType=t,this}}class ta extends Se{constructor(t,e=1){super(),this.type="Light",this.color=new $t(t),this.intensity=e}dispose(){}copy(t){return super.copy(t),this.color.copy(t.color),this.intensity=t.intensity,this}toJSON(t){const e=super.toJSON(t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,void 0!==this.groundColor&&(e.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(e.object.distance=this.distance),void 0!==this.angle&&(e.object.angle=this.angle),void 0!==this.decay&&(e.object.decay=this.decay),void 0!==this.penumbra&&(e.object.penumbra=this.penumbra),void 0!==this.shadow&&(e.object.shadow=this.shadow.toJSON()),e}}ta.prototype.isLight=!0;const ea=new zt,ia=new ot,na=new ot;class ra extends class{constructor(t){this.camera=t,this.bias=0,this.normalBias=0,this.radius=1,this.mapSize=new Q(512,512),this.map=null,this.mapPass=null,this.matrix=new zt,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Ot,this._frameExtents=new Q(1,1),this._viewportCount=1,this._viewports=[new rt(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(t){const e=this.camera,i=this.matrix;ia.setFromMatrixPosition(t.matrixWorld),e.position.copy(ia),na.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(na),e.updateMatrixWorld(),ea.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromProjectionMatrix(ea),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(e.projectionMatrix),i.multiply(e.matrixWorldInverse)}getViewport(t){return this._viewports[t]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(t){return this.camera=t.camera.clone(),this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const t={};return 0!==this.bias&&(t.bias=this.bias),0!==this.normalBias&&(t.normalBias=this.normalBias),1!==this.radius&&(t.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}{constructor(){super(new Gi(-5,5,5,-5,.5,500))}}ra.prototype.isDirectionalLightShadow=!0;class sa extends ta{constructor(t,e){super(t,e),this.type="DirectionalLight",this.position.copy(Se.DefaultUp),this.updateMatrix(),this.target=new Se,this.shadow=new ra}dispose(){this.shadow.dispose()}copy(t){return super.copy(t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}sa.prototype.isDirectionalLight=!0;class aa extends ta{constructor(t,e){super(t,e),this.type="AmbientLight"}}aa.prototype.isAmbientLight=!0;const oa=new zt,la=new zt;class ha{constructor(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new Fi,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new Fi,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}update(t){const e=this._cache;if(e.focus!==t.focus||e.fov!==t.fov||e.aspect!==t.aspect*this.aspect||e.near!==t.near||e.far!==t.far||e.zoom!==t.zoom||e.eyeSep!==this.eyeSep){e.focus=t.focus,e.fov=t.fov,e.aspect=t.aspect*this.aspect,e.near=t.near,e.far=t.far,e.zoom=t.zoom,e.eyeSep=this.eyeSep;const i=t.projectionMatrix.clone(),n=e.eyeSep/2,r=n*e.near/e.focus,s=e.near*Math.tan(V*e.fov*.5)/e.zoom;let a,o;la.elements[12]=-n,oa.elements[12]=n,a=-s*e.aspect+r,o=s*e.aspect+r,i.elements[0]=2*e.near/(o-a),i.elements[8]=(o+a)/(o-a),this.cameraL.projectionMatrix.copy(i),a=-s*e.aspect-r,o=s*e.aspect-r,i.elements[0]=2*e.near/(o-a),i.elements[8]=(o+a)/(o-a),this.cameraR.projectionMatrix.copy(i)}this.cameraL.matrixWorld.copy(t.matrixWorld).multiply(la),this.cameraR.matrixWorld.copy(t.matrixWorld).multiply(oa)}}class ca extends De{constructor(){super(),this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(t){return super.copy(t),this.instanceCount=t.instanceCount,this}clone(){return(new this.constructor).copy(this)}toJSON(){const t=super.toJSON(this);return t.instanceCount=this.instanceCount,t.isInstancedBufferGeometry=!0,t}}ca.prototype.isInstancedBufferGeometry=!0;class ua extends ie{constructor(t,e,i,n=1){"number"==typeof i&&(n=i,i=!1,console.error("THREE.InstancedBufferAttribute: The constructor now expects normalized as the third argument.")),super(t,e,i),this.meshPerAttribute=n}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}toJSON(){const t=super.toJSON();return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}ua.prototype.isInstancedBufferAttribute=!0;class da{constructor(t,e){this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.usage=k,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=j()}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}setUsage(t){return this.usage=t,this}copy(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.usage=t.usage,this}copyAt(t,e,i){t*=this.stride,i*=e.stride;for(let n=0,r=this.stride;n<r;n++)this.array[t+n]=e.array[i+n];return this}set(t,e=0){return this.array.set(t,e),this}clone(t){void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=j()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const e=new this.array.constructor(t.arrayBuffers[this.array.buffer._uuid]),i=new this.constructor(e,this.stride);return i.setUsage(this.usage),i}onUpload(t){return this.onUploadCallback=t,this}toJSON(t){return void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=j()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=Array.prototype.slice.call(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}da.prototype.isInterleavedBuffer=!0;class pa extends da{constructor(t,e,i=1){super(t,e),this.meshPerAttribute=i}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}clone(t){const e=super.clone(t);return e.meshPerAttribute=this.meshPerAttribute,e}toJSON(t){const e=super.toJSON(t);return e.isInstancedInterleavedBuffer=!0,e.meshPerAttribute=this.meshPerAttribute,e}}pa.prototype.isInstancedInterleavedBuffer=!0;const fa=new ot;class ma{constructor(t,e,i,n=!1){this.name="",this.data=t,this.itemSize=e,this.offset=i,this.normalized=!0===n}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(t){this.data.needsUpdate=t}applyMatrix4(t){for(let e=0,i=this.data.count;e<i;e++)fa.x=this.getX(e),fa.y=this.getY(e),fa.z=this.getZ(e),fa.applyMatrix4(t),this.setXYZ(e,fa.x,fa.y,fa.z);return this}applyNormalMatrix(t){for(let e=0,i=this.count;e<i;e++)fa.x=this.getX(e),fa.y=this.getY(e),fa.z=this.getZ(e),fa.applyNormalMatrix(t),this.setXYZ(e,fa.x,fa.y,fa.z);return this}transformDirection(t){for(let e=0,i=this.count;e<i;e++)fa.x=this.getX(e),fa.y=this.getY(e),fa.z=this.getZ(e),fa.transformDirection(t),this.setXYZ(e,fa.x,fa.y,fa.z);return this}setX(t,e){return this.data.array[t*this.data.stride+this.offset]=e,this}setY(t,e){return this.data.array[t*this.data.stride+this.offset+1]=e,this}setZ(t,e){return this.data.array[t*this.data.stride+this.offset+2]=e,this}setW(t,e){return this.data.array[t*this.data.stride+this.offset+3]=e,this}getX(t){return this.data.array[t*this.data.stride+this.offset]}getY(t){return this.data.array[t*this.data.stride+this.offset+1]}getZ(t){return this.data.array[t*this.data.stride+this.offset+2]}getW(t){return this.data.array[t*this.data.stride+this.offset+3]}setXY(t,e,i){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this}setXYZ(t,e,i,n){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this}setXYZW(t,e,i,n,r){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this.data.array[t+3]=r,this}clone(t){if(void 0===t){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interlaved buffer attribute will deinterleave buffer data.");const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return new ie(new this.array.constructor(t),this.itemSize,this.normalized)}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new ma(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(t){if(void 0===t){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interlaved buffer attribute will deinterleave buffer data.");const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:t,normalized:this.normalized}}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.toJSON(t)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}ma.prototype.isInterleavedBufferAttribute=!0;class ga{constructor(t,e,i=0,n=1/0){this.ray=new Ye(t,e),this.near=i,this.far=n,this.camera=null,this.layers=new he,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(t,e){this.ray.set(t,e)}setFromCamera(t,e){e&&e.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(e).sub(this.ray.origin).normalize(),this.camera=e):e&&e.isOrthographicCamera?(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld),this.camera=e):console.error("THREE.Raycaster: Unsupported camera type: "+e.type)}intersectObject(t,e=!1,i=[]){return ya(t,this,i,e),i.sort(va),i}intersectObjects(t,e=!1,i=[]){for(let n=0,r=t.length;n<r;n++)ya(t[n],this,i,e);return i.sort(va),i}}function va(t,e){return t.distance-e.distance}function ya(t,e,i,n){if(t.layers.test(e.layers)&&t.raycast(e,i),!0===n){const n=t.children;for(let t=0,r=n.length;t<r;t++)ya(n[t],e,i,!0)}}class xa{constructor(t=1,e=0,i=0){return this.radius=t,this.phi=e,this.theta=i,this}set(t,e,i){return this.radius=t,this.phi=e,this.theta=i,this}copy(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this}makeSafe(){const t=1e-6;return this.phi=Math.max(t,Math.min(Math.PI-t,this.phi)),this}setFromVector3(t){return this.setFromCartesianCoords(t.x,t.y,t.z)}setFromCartesianCoords(t,e,i){return this.radius=Math.sqrt(t*t+e*e+i*i),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(t,i),this.phi=Math.acos(X(e/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}const _a=new Q;class Ma{constructor(t=new Q(1/0,1/0),e=new Q(-1/0,-1/0)){this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=_a.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(t){return this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return _a.copy(t).clamp(this.min,this.max).sub(t).length()}intersect(t){return this.min.max(t.min),this.max.min(t.max),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}Ma.prototype.isBox2=!0;const ba=new ot,Sa=new ot;class wa{constructor(t=new ot,e=new ot){this.start=t,this.end=e}set(t,e){return this.start.copy(t),this.end.copy(e),this}copy(t){return this.start.copy(t.start),this.end.copy(t.end),this}getCenter(t){return t.addVectors(this.start,this.end).multiplyScalar(.5)}delta(t){return t.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,e){return this.delta(e).multiplyScalar(t).add(this.start)}closestPointToPointParameter(t,e){ba.subVectors(t,this.start),Sa.subVectors(this.end,this.start);const i=Sa.dot(Sa);let n=Sa.dot(ba)/i;return e&&(n=X(n,0,1)),n}closestPointToPoint(t,e,i){const n=this.closestPointToPointParameter(t,e);return this.delta(i).multiplyScalar(n).add(this.start)}applyMatrix4(t){return this.start.applyMatrix4(t),this.end.applyMatrix4(t),this}equals(t){return t.start.equals(this.start)&&t.end.equals(this.end)}clone(){return(new this.constructor).copy(this)}}Se.onUploadDropBuffer=function(){this.array=null},Se.DefaultUp.set(0,0,1),Se.prototype.addStatic=function(t){t.matrixAutoUpdate=!1,t.updateMatrix(),this.add(t)},Se.prototype.dropBuffers=function(t=!0){const e=this.geometry,i=e.attributes;for(var n in i)(t||"color"!==n)&&i[n].onUpload(Se.onUploadDropBuffer);e.index&&e.index.onUpload(Se.onUploadDropBuffer)};const Ea={index:new ne([0,2,1,0,3,2],1),position:new se([0,0,0,0,1,0,1,1,0,1,0,0],3)};function Ta(t){this.material=t,this.cache={}}Ta.prototype.getGeometry=function(t){var e=this.cache[t];return void 0===e&&(e=new Ia(t,this.material.getAtlas()),this.cache[t]=e,e.isCached=!0),e};const Ca=new ot,La=new ot,Aa=new ot,Ra=new ot,Pa=new ot,Da=new si,Na=new si;class Ia extends ca{constructor(t,e){super(),this.type="GlyphStringGeometry",this.width=0,this.setIndex(Ea.index),this.setAttribute("position",Ea.position);const i=t.length;this.glyphAtlas=e,this.setAttribute("instanceUvs",new ua(new Float32Array(2*i),2,!1,1)),this.setAttribute("instanceOffsets",new ua(new Float32Array(i),1,!1,1)),this.setAttribute("instanceWidths",new ua(new Float32Array(i),1,!1,1)),this.setString(t),this.computeBoundingSphere()}dispose(){this.isCached||(this.deleteAttribute("position"),this.setIndex(null),super.dispose())}}Ia.prototype.setString=function(t){const e=this.getAttribute("instanceUvs"),i=this.getAttribute("instanceOffsets"),n=this.getAttribute("instanceWidths"),r=t.length,s=this.glyphAtlas;var a,o=0;for(a=0;a<r;a++){if(0===t.charCodeAt(a))continue;const r=s.getGlyph(t[a]);e.setXY(a,r.column,r.row),n.setX(a,r.width),i.setX(a,o),o+=r.width}e.needsUpdate=!0,i.needsUpdate=!0,n.needsUpdate=!0,this.width=o,this.name=t,this.instanceCount=r};class Fa extends wi{constructor(t,e,i){super(i,e),this.name=t}}Fa.prototype.getWidth=function(){return this.geometry.width*this.material.scaleFactor},Fa.prototype.getHeight=function(){return this.material.scaleFactor},Fa.prototype.intersects=function(t,e,i){if(!this.visible)return!1;const n=this.getWidth()/i.x,r=this.getHeight()/i.y,s=this.material.rotation;return Ca.set(t.x,t.y,0),La.setFromMatrixPosition(this.modelViewMatrix),La.applyMatrix4(e.projectionMatrix),this.depth=La.z,La.z=0,isNaN(La.x)?void 0:(Aa.set(n,0,0).applyAxisAngle(Se.DefaultUp,s),Ra.set(n,r,0).applyAxisAngle(Se.DefaultUp,s),Pa.set(0,r,0).applyAxisAngle(Se.DefaultUp,s),Aa.y*=i.x/i.y,Ra.y*=i.x/i.y,Pa.y*=i.x/i.y,Aa.add(La),Ra.add(La),Pa.add(La),Da.set(La,Aa,Ra),Na.set(La,Ra,Pa),Da.containsPoint(Ca)||Na.containsPoint(Ca))};class Oa extends Fa{constructor(t,e,i){var n;const r=i.glyphStringCache;let s=r.get(e);void 0===s&&(s=new Ta(e),r.set(e,s)),super(t,e,n=s.getGeometry(t)),n.getAttribute("instanceUvs").onUpload(Se.onUploadDropBuffer),n.getAttribute("instanceOffsets").onUpload(Se.onUploadDropBuffer),n.getAttribute("instanceWidths").onUpload(Se.onUploadDropBuffer)}}class za extends Fa{constructor(t,e){super(t,e,new Ia(t,e.getAtlas()))}replaceString(t){t.length===this.name.length?this.geometry.setString(t):console.warn("new string has invalid length",t,this.name.length,t.length)}}Se.onUploadDropBuffer=function(){this.array=null},Se.DefaultUp.set(0,0,1),Se.prototype.addStatic=function(t){t.matrixAutoUpdate=!1,t.updateMatrix(),this.add(t)},Se.prototype.dropBuffers=function(t=!0){const e=this.geometry,i=e.attributes;for(var n in i)(t||"color"!==n)&&i[n].onUpload(Se.onUploadDropBuffer);e.index&&e.index.onUpload(Se.onUploadDropBuffer)};class Ua extends ca{constructor(){super(),this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new se([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new se([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}}var Ba,ka;Object.assign(Ua.prototype,{isLineSegmentsGeometry:!0,applyMatrix4:function(t){var e=this.attributes.instanceStart,i=this.attributes.instanceEnd;return void 0!==e&&(e.applyMatrix4(t),i.applyMatrix4(t),e.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new pa(e,6,1);return this.setAttribute("instanceStart",new ma(i,3,0)),this.setAttribute("instanceEnd",new ma(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new pa(e,6,1);return this.setAttribute("instanceColorStart",new ma(i,3,0)),this.setAttribute("instanceColorEnd",new ma(i,3,3)),this},setHide:function(t){var e;return t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t)),this.setAttribute("instanceHideVertex",new ua(e,1,!1,1)),this},clearHide:function(){this.deleteAttribute("instanceHideVertex")},computeBoundingBox:(ka=new ct,function(){null===this.boundingBox&&(this.boundingBox=new ct);var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;void 0!==t&&void 0!==e&&(this.boundingBox.setFromBufferAttribute(t),ka.setFromBufferAttribute(e),this.boundingBox.union(ka))}),computeBoundingSphere:(Ba=new ot,function(){null===this.boundingSphere&&(this.boundingSphere=new At),null===this.boundingBox&&this.computeBoundingBox();var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;if(void 0!==t&&void 0!==e){var i=this.boundingSphere.center;this.boundingBox.getCenter(i);for(var n=0,r=0,s=t.count;r<s;r++)Ba.fromBufferAttribute(t,r),n=Math.max(n,i.distanceToSquared(Ba)),Ba.fromBufferAttribute(e,r),n=Math.max(n,i.distanceToSquared(Ba));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}})});const Ga={anaglyphVertexShader:"varying vec2 vUv;\nvoid main() {\n\tvUv = vec2( uv.x, uv.y );\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",anaglyphFragmentShader:"uniform sampler2D mapLeft;\nuniform sampler2D mapRight;\nvarying vec2 vUv;\nuniform mat3 colorMatrixLeft;\nuniform mat3 colorMatrixRight;\nfloat lin( float c ) {\n\treturn c <= 0.04045 ? c * 0.0773993808 : pow( c * 0.9478672986 + 0.0521327014, 2.4 );\n}\nvec4 lin( vec4 c ) {\n\treturn vec4( lin( c.r ), lin( c.g ), lin( c.b ), c.a );\n}\nfloat dev( float c ) {\n\treturn c <= 0.0031308 ? c * 12.92 : pow( c, 0.41666 ) * 1.055 - 0.055;\n}\nvoid main() {\n\tvec2 uv = vUv;\n\tvec4 colorL = lin( texture2D( mapLeft, uv ) );\n\tvec4 colorR = lin( texture2D( mapRight, uv ) );\n\tvec3 color = clamp(\n\t\t\tcolorMatrixLeft * colorL.rgb +\n\t\t\tcolorMatrixRight * colorR.rgb, 0., 1.\n\t);\n\tgl_FragColor = vec4(\n\t\t\tdev( color.r ), dev( color.g ), dev( color.b ),\n\t\t\tmax( colorL.a, colorR.a )\n\t);\n}",cursorVertexShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform vec3 uLight;\nvarying vec3 vColor;\nvarying float height;\nvarying float fogDepth;\nvoid main() {\n#ifdef SURFACE\n\tvec3 sNormal = normalMatrix * normal;\n\tfloat dotNL = dot( normalize( sNormal ), uLight );\n\tvColor = saturate( dotNL ) * color + vec3( 0.3, 0.3, 0.3 );\n#else\n\tvColor = color;\n#endif\n\theight = position.z;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tfogDepth = -mvPosition.z;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",cursorFragmentShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n#define LOG2 1.442695\nuniform float cursor;\nuniform float cursorWidth;\nuniform vec3 baseColor;\nuniform vec3 cursorColor;\nuniform vec3 fogColor;\nuniform int fogEnabled;\nuniform float fogDensity;\nvarying float height;\nvarying vec3 vColor;\nvarying float fogDepth;\nvoid main() {\n\tfloat delta = abs( height - cursor );\n\tfloat ss = smoothstep( 0.0, cursorWidth, cursorWidth - delta );\n\tif ( delta < cursorWidth * 0.05 ) {\n\t\tgl_FragColor = vec4( vColor, 1.0 );\n\t} else {\n\t\tgl_FragColor = vec4( mix( baseColor, cursorColor, ss ), 1.0 ) * vec4( vColor, 1.0 );\n\t}\n\tif ( fogEnabled != 0 ) {\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n\t}\n}",depthMapVertexShader:"uniform float minZ;\nuniform float scaleZ;\nvarying float vHeight;\nvoid main() {\n\tvHeight = ( position.z - minZ ) * scaleZ;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",depthMapFragmentShader:"const float PackUpscale = 256. / 255.;const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packFloatToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\n\treturn r * PackUpscale;\n}\nvarying float vHeight;\nvoid main() {\n\tgl_FragColor = packFloatToRGBA( vHeight );\n}",depthVertexShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\nconst float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nfloat unpackRGBAToFloat( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nuniform vec3 modelMin;\nuniform float scaleX;\nuniform float scaleY;\nuniform float rangeZ;\nuniform float depthScale;\nuniform sampler2D depthMap;\nuniform float datumShift;\nuniform vec3 uLight;\nvarying vec3 vColor;\nvarying float vDepth;\nvarying float fogDepth;\nvoid main() {\n#ifdef SURFACE\n\tvec3 sNormal = normalMatrix * normal;\n\tfloat dotNL = dot( normalize( sNormal ), uLight );\n\tvColor = saturate( dotNL ) * color + vec3( 0.3, 0.3, 0.3 );\n#else\n\tvColor = color;\n#endif\n\tvec2 terrainCoords = vec2( ( position.x - modelMin.x ) * scaleX, ( position.y - modelMin.y ) * scaleY );\n\tfloat terrainHeight = unpackRGBAToFloat( texture2D( depthMap, terrainCoords ) );\n\tterrainHeight = terrainHeight * rangeZ + modelMin.z + datumShift;\n\tvDepth = ( terrainHeight - position.z ) * depthScale;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tfogDepth = -mvPosition.z;\n\tgl_Position = projectionMatrix * mvPosition;\n}",depthFragmentShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n#define LOG2 1.442695\nuniform sampler2D cmap;\nuniform vec3 fogColor;\nuniform int fogEnabled;\nuniform float fogDensity;\nvarying float vDepth;\nvarying vec3 vColor;\nvarying float fogDepth;\nvoid main() {\n\tgl_FragColor = texture2D( cmap, vec2( vDepth, 1.0 ) ) * vec4( vColor, 1.0 );\n\tif ( fogEnabled != 0 ) {\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n\t}\n}",depthCursorVertexShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\nconst float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nfloat unpackRGBAToFloat( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nuniform vec3 modelMin;\nuniform float scaleX;\nuniform float scaleY;\nuniform float rangeZ;\nuniform sampler2D depthMap;\nuniform float datumShift;\nuniform vec3 uLight;\nvarying vec3 vColor;\nvarying float vDepth;\nvarying float fogDepth;\nvoid main() {\n#ifdef SURFACE\n\tvec3 sNormal = normalMatrix * normal;\n\tfloat dotNL = dot( normalize( sNormal ), uLight );\n\tvColor = saturate( dotNL ) * color + vec3( 0.3, 0.3, 0.3 );\n#else\n\tvColor = color;\n#endif\n\tvec2 terrainCoords = vec2( ( position.x - modelMin.x ) * scaleX, ( position.y - modelMin.y ) * scaleY );\n\tfloat terrainHeight = unpackRGBAToFloat( texture2D( depthMap, terrainCoords ) );\n\tvDepth = terrainHeight * rangeZ + datumShift + modelMin.z - position.z;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tfogDepth = -mvPosition.z;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",depthCursorFragmentShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n#define LOG2 1.442695\nuniform float cursor;\nuniform float cursorWidth;\nuniform vec3 baseColor;\nuniform vec3 cursorColor;\nuniform vec3 fogColor;\nuniform int fogEnabled;\nuniform float fogDensity;\nvarying float vDepth;\nvarying vec3 vColor;\nvarying float fogDepth;\nvoid main() {\n\tfloat delta = abs( vDepth - cursor );\n\tfloat ss = smoothstep( 0.0, cursorWidth, cursorWidth - delta );\n\tif ( delta < cursorWidth * 0.05 ) {\n\t\tgl_FragColor = vec4( vColor, 1.0 );\n\t} else {\n\t\tgl_FragColor = vec4( mix( baseColor, cursorColor, ss ), 1.0 ) * vec4( vColor, 1.0 );\n\t}\n\tif ( fogEnabled != 0 ) {\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n\t}\n}",glyphVertexShader:"\nuniform float cellScale;\nuniform vec2 scale;\nuniform mat2 rotate;\nattribute vec2 instanceUvs;\nattribute float instanceOffsets;\nattribute float instanceWidths;\nvarying vec2 vUv;\nvarying float fogDepth;\nvoid main() {\n\tvUv = instanceUvs + vec2( position.x * cellScale * instanceWidths, position.y * cellScale );\n\tvec2 newPosition = vec2( position.x * instanceWidths, position.y );\n\tnewPosition.x += instanceOffsets;\n\tnewPosition = rotate * newPosition;\n\tvec4 offset = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tnewPosition *= scale;\n\tnewPosition.xy *= offset.w;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tfogDepth = -mvPosition.z;\n\tgl_Position = vec4( newPosition, 0.0, 0.0 ) + offset;\n}",glyphFragmentShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n#define LOG2 1.442695\nuniform sampler2D atlas;\nuniform vec3 fogColor;\nuniform int fogEnabled;\nuniform float fogDensity;\nvarying float fogDepth;\nvarying vec2 vUv;\nvoid main() {\n\tgl_FragColor = texture2D( atlas, vUv );\n\tif ( fogEnabled != 0 ) {\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t\tgl_FragColor = mix( gl_FragColor, vec4( fogColor, 0.0 ), fogFactor );\n\t}\n}",heightVertexShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform sampler2D cmap;\nuniform float minZ;\nuniform float scaleZ;\nuniform vec3 uLight;\nvarying vec3 vColor;\nvarying float zMap;\nvarying float fogDepth;\nvarying vec3 vMvPosition;\nvoid main() {\n#ifdef SURFACE\n\tvec3 sNormal = normalMatrix * normal;\n\tfloat dotNL = dot( normalize( sNormal ), uLight );\n\tvColor = saturate( dotNL ) * color + vec3( 0.3, 0.3, 0.3 );\n#else\n\tvColor = color;\n#endif\n\tzMap = ( position.z - minZ ) * scaleZ;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tvMvPosition = mvPosition.xyz;\n\tfogDepth = -mvPosition.z;\n\tgl_Position = projectionMatrix * mvPosition;\n}",heightFragmentShader:"#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n#define LOG2 1.442695\nuniform sampler2D cmap;\nuniform vec3 fogColor;\nuniform int fogEnabled;\nuniform float fogDensity;\nuniform float distanceTransparency;\nvarying float fogDepth;\nvarying float zMap;\nvarying vec3 vColor;\nvarying vec3 vMvPosition;\nvoid main() {\n\tgl_FragColor = texture2D( cmap, vec2( 1.0 - zMap, 1.0 ) ) * vec4( vColor, 1.0 );\n\tif ( distanceTransparency > 0.0 ) {\n\t\tgl_FragColor.a = 1.0 - length( vMvPosition.xyz ) / distanceTransparency;\n\t}\n\tif ( fogEnabled != 0 ) {\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n\t}\n}",popupVertexShader:"\nuniform mat2 rotate;\nuniform vec2 scale;\nvarying vec2 vUv;\nvarying vec3 vColor;\nvoid main() {\n\tvec2 newPosition = vec2( position.x, position.y );\n\tvColor = color;\n\tvUv = newPosition;\n\tnewPosition = rotate * newPosition;\n\tvec4 offset = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tnewPosition *= scale;\n\tnewPosition *= offset.w;\n\tgl_Position = vec4( newPosition, 0.0, 0.0 ) + offset;\n}",popupFragmentShader:"uniform sampler2D popupImage;\nvarying vec2 vUv;\nvarying vec3 vColor;\nvoid main() {\n\tgl_FragColor = texture2D( popupImage, vUv ) * vec4( vColor, 1.0 );\n}",waterVertexShader:"attribute vec3 sinks;\nattribute float selection;\nvarying vec3 vPosition;\nvarying float vSelection;\nvarying vec3 vSink;\nvoid main() {\n\tvPosition = position;\n\tvSelection = selection;\n\tvSink = sinks;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",waterFragmentShader:"uniform float offset;\nvarying vec3 vPosition;\nvarying float vSelection;\nvarying vec3 vSink;\nvoid main() {\n\tgl_FragColor = vec4( 0.1, 0.1, sin( offset + distance( vPosition, vSink ) ) * 0.4 + 0.6, 0.0 );\n\tgl_FragColor = mix( gl_FragColor, vec4( 1.0, 0.0, 0.0, 1.0 ), vSelection );\n}",lineVertexShader:"#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nuniform float linewidth;\nuniform vec2 resolution;\nattribute vec3 instanceStart;\nattribute vec3 instanceEnd;\nattribute vec3 instanceColorStart;\nattribute vec3 instanceColorEnd;\nattribute float instanceHideVertex;\nvarying vec2 vUv;\nvarying float vHide;\n#ifdef CV_HEIGHT\n\tuniform sampler2D cmap;\n\tuniform float minZ;\n\tuniform float scaleZ;\n\tvarying float zMap;\n#endif\n#if defined( CV_DEPTH ) || defined( CV_DEPTH_CURSOR )\n\tconst float UnpackDownscale = 255. / 256.;\n\tconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\n\tconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n\tfloat unpackRGBAToFloat( const in vec4 v ) {\n\t\treturn dot( v, UnpackFactors );\n\t}\n\tuniform vec3 modelMin;\n\tuniform float scaleX;\n\tuniform float scaleY;\n\tuniform float rangeZ;\n\tuniform float depthScale;\n\tuniform sampler2D depthMap;\n\tuniform float datumShift;\n\tvarying float height;\n#endif\n#ifdef CV_CURSOR\n\tvarying float height;\n#endif\n#ifdef USE_DASH\n\tuniform float dashScale;\n\tattribute float instanceDistanceStart;\n\tattribute float instanceDistanceEnd;\n\tvarying float vLineDistance;\n#endif\nvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\tfloat a = projectionMatrix[ 2 ][ 2 ];\tfloat b = projectionMatrix[ 3 ][ 2 ];\tfloat nearEstimate = - 0.5 * b / a;\n\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\tend.xyz = mix( start.xyz, end.xyz, alpha );\n}\nvoid main() {\n\t#ifdef USE_COLOR\n\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\t#endif\n\t#ifdef USE_DASH\n\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\t#endif\n\tfloat aspect = resolution.x / resolution.y;\n\tvUv = uv;\n\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 );\n\tif ( perspective ) {\n\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\t\t\ttrimSegment( start, end );\n\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\t\t\ttrimSegment( end, start );\n\t\t}\n\t}\n\tvec4 clipStart = projectionMatrix * start;\n\tvec4 clipEnd = projectionMatrix * end;\n\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\tvec2 dir = ndcEnd - ndcStart;\n\tdir.x *= aspect;\n\tdir = normalize( dir );\n\tvec2 offset = vec2( dir.y, - dir.x );\n\tdir.x /= aspect;\n\toffset.x /= aspect;\n\tif ( position.x < 0.0 ) offset *= - 1.0;\n\tif ( position.y < 0.0 ) {\n\t\toffset += - dir;\n\t} else if ( position.y > 1.0 ) {\n\t\toffset += dir;\n\t}\n\toffset *= linewidth;\n\toffset /= resolution.y;\n\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\toffset *= clip.w;\n\tclip.xy += offset;\n\t#ifdef CV_CURSOR\n\t\theight = instanceStart.z + ( instanceEnd.z - instanceStart.z) * position.y;\n\t#endif\n\t#ifdef CV_HEIGHT\n\t\tzMap = ( instanceStart.z + ( instanceEnd.z - instanceStart.z) * position.y - minZ ) * scaleZ;\n\t#endif\n\t#if defined( CV_DEPTH ) || defined( CV_DEPTH_CURSOR )\n\t\tvec3 realPosition = instanceStart + ( instanceEnd - instanceStart ) * position.y;\n\t\tvec2 terrainCoords = vec2( ( realPosition.x - modelMin.x ) * scaleX, ( realPosition.y - modelMin.y ) * scaleY );\n\t\tfloat terrainHeight = unpackRGBAToFloat( texture2D( depthMap, terrainCoords ) );\n\t\tterrainHeight = terrainHeight * rangeZ + modelMin.z + datumShift;\n\t\theight = terrainHeight - realPosition.z;\n\t#endif\n\t#ifdef CV_DEPTH\n\t\theight *= depthScale;\n\t#endif\n\tvHide = instanceHideVertex;\n\tgl_Position = clip;\n\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",lineFragmentShader:"uniform vec3 diffuse;\nuniform float opacity;\n#ifdef CV_HEIGHT\n\tuniform sampler2D cmap;\n\tvarying float zMap;\n#endif\n#ifdef CV_DEPTH\n\tuniform sampler2D cmap;\n\tvarying float height;\n#endif\n#if defined( CV_CURSOR ) || defined( CV_DEPTH_CURSOR )\n\tuniform float cursor;\n\tuniform float cursorWidth;\n\tuniform vec3 baseColor;\n\tuniform vec3 cursorColor;\n\tvarying float height;\n#endif\n#ifdef USE_DASH\n\tuniform float dashSize;\n\tuniform float dashOffset;\n\tuniform float gapSize;\n#endif\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vUv;\nvarying float vHide;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( vHide > 0.0 ) discard;\n\t#ifdef USE_DASH\n\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard;\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard;\n\t#endif\n\tif ( abs( vUv.y ) > 1.0 ) {\n\t\tfloat a = vUv.x;\n\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\tfloat len2 = a * a + b * b;\n\t\tif ( len2 > 1.0 ) discard;\n\t}\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\t#ifdef CV_HEIGHT\n\t\tgl_FragColor = texture2D( cmap, vec2( 1.0 - zMap, 1.0 ) ) * vec4( vColor, 1.0 );\n\t#endif\n\t#ifdef CV_DEPTH\n\t\tgl_FragColor = texture2D( cmap, vec2( height, 1.0 ) ) * vec4( vColor, 1.0 );\n\t#endif\n\t#if defined( CV_CURSOR ) || defined( CV_DEPTH_CURSOR )\n\t\tfloat delta = abs( height - cursor );\n\t\tfloat ss = smoothstep( 0.0, cursorWidth, cursorWidth - delta );\n\t\tif ( delta < cursorWidth * 0.05 ) {\n\t\t\tgl_FragColor = vec4( vColor, 1.0 );\n\t\t} else {\n\t\t\tgl_FragColor = vec4( mix( baseColor, cursorColor, ss ), 1.0 ) * vec4( vColor, 1.0 );\n\t\t}\n\t#endif\n\t#ifdef CV_BASIC\n\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\t#endif\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",commonTerrainCodeColor:"if ( scale > 0.0 ) {\n\tfloat targetDistance = distance( target, vPosition );\n\tfloat f = abs( targetDistance - accuracy ) * scale;\n\tfloat c = smoothstep( 1.0, 6.0, f );\n\tdiffuseColor = mix( vec4( ringColor, 1.0 ), diffuseColor, c );\n}",commonTerrainCodePars:"uniform float scale;\nuniform float accuracy;\nuniform vec2 target;\nuniform vec3 ringColor;\nvarying vec2 vPosition;"},Ha=Be.merge([Ci.common,Ci.fog,{linewidth:{value:1},resolution:{value:new Q(1,1)},dashScale:{value:1},dashSize:{value:1},dashOffset:{value:0},gapSize:{value:1},opacity:{value:1}}]);class Va extends ke{constructor(t,e,i={CV_BASIC:!0},n={}){super({type:"LineMaterial",uniforms:Object.assign(Be.clone(Ha),t.materials.commonUniforms,n),vertexShader:Ga.lineVertexShader,fragmentShader:Ga.lineFragmentShader,clipping:!0,defines:i}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(t){this.uniforms.dashOffset.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(e),this.resolution=new Q(t.container.clientWidth,t.container.clientHeight),t.viewer.addEventListener("resized",(t=>{const e=t.lineScale?t.lineScale:1;this.resolution=new Q(t.width,t.height),this.linewidth=Math.max(1,Math.floor(t.width/1e3)*e)}))}}Va.prototype.isLineMaterial=!0;class Wa extends Va{constructor(t,e="height",i){const n=t.survey,r=t.cfg,s=r.value("saturatedGradient",!1)?"gradientHi":"gradientLow",a=t.materials.textureCache,o=n.modelLimits,l=o.max.z,h=o.min.z,c={};let u=null,d=null,p=null,f=null;n.terrain&&(u=n.terrain,u.boundingBox&&(d=u.boundingBox,p=d.getSize(new ot)));let m={};switch(e){case"height":c.CV_HEIGHT=!0,m={minZ:{value:h},scaleZ:{value:1/(l-h)},cmap:{value:a.getTexture(s)}};break;case"cursor":c.CV_CURSOR=!0,m={cursor:{value:0},cursorWidth:{value:5},baseColor:{value:r.themeColor("shading.cursorBase")},cursorColor:{value:r.themeColor("shading.cursor")}};break;case"depth":c.CV_DEPTH=!0,m=Object.assign({modelMin:{value:d.min},scaleX:{value:1/p.x},scaleY:{value:1/p.y},rangeZ:{value:p.z},depthScale:{value:1/(o.max.z-o.min.z)},cmap:{value:a.getTexture(s)},depthMap:{value:u.depthTexture}},t.materials.commonDepthUniforms);break;case"depth-cursor":f=o.max.z-o.min.z,c.CV_DEPTH_CURSOR=!0,m=Object.assign({modelMin:{value:d.min},scaleX:{value:1/p.x},scaleY:{value:1/p.y},rangeZ:{value:p.z},depthMap:{value:u.depthTexture},cursor:{value:f/2},cursorWidth:{value:5},baseColor:{value:r.themeColor("shading.cursorBase")},cursorColor:{value:r.themeColor("shading.cursor")}},t.materials.commonDepthUniforms);break;default:c.CV_BASIC=!0}i&&(c.USE_DASH=!0);super(t,{color:16777215,vertexColors:!0,dashSize:2,gapSize:2},c,m),this.halfRange=(o.max.z-o.min.z)/2,this.max=f}}Wa.prototype.setCursor=function(t){var e;return e=void 0!==this.max?Math.max(Math.min(t,this.max),0):Math.max(Math.min(t,this.halfRange),-this.halfRange),this.uniforms.cursor.value=e,e},Wa.prototype.getCursor=function(){return this.uniforms.cursor.value};class ja extends wi{constructor(t,e){void 0===t&&(t=new Ua),void 0===e&&(e=new Wa({color:16777215*Math.random()})),super(t,e),this.type="LineSegments2"}}Object.assign(ja.prototype,{isLineSegments2:!0,computeLineDistances:function(){var t=new ot,e=new ot;return function(){for(var i=this.geometry,n=i.attributes.instanceStart,r=i.attributes.instanceEnd,s=new Float32Array(2*n.data.count),a=0,o=0,l=n.data.count;a<l;a++,o+=2)t.fromBufferAttribute(n,a),e.fromBufferAttribute(r,a),s[o]=0===o?0:s[o-1],s[o+1]=s[o]+t.distanceTo(e);var h=new pa(s,2,1);return i.setAttribute("instanceDistanceStart",new ma(h,1,0)),i.setAttribute("instanceDistanceEnd",new ma(h,1,1)),this}}(),raycast:function(){var t=new rt,e=new rt,i=new rt,n=new ot,r=new zt,s=new wa,a=new ot;return function(o,l){null===o.camera&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2.');var h=void 0!==o.params.Line2&&o.params.Line2.threshold||0,c=o.ray,u=o.camera,d=u.projectionMatrix,p=this.geometry,f=this.material,m=f.resolution,g=f.linewidth+h,v=p.attributes.instanceStart,y=p.attributes.instanceEnd;c.at(1,i),i.w=1,i.applyMatrix4(u.matrixWorldInverse),i.applyMatrix4(d),i.multiplyScalar(1/i.w),i.x*=m.x/2,i.y*=m.y/2,i.z=0,n.copy(i);var x=this.matrixWorld;r.multiplyMatrices(u.matrixWorldInverse,x);for(var _=0,M=v.count;_<M;_++){t.fromBufferAttribute(v,_),e.fromBufferAttribute(y,_),t.w=1,e.w=1,t.applyMatrix4(r),e.applyMatrix4(r),t.applyMatrix4(d),e.applyMatrix4(d),t.multiplyScalar(1/t.w),e.multiplyScalar(1/e.w);var b=t.z<-1&&e.z<-1,S=t.z>1&&e.z>1;if(!b&&!S){t.x*=m.x/2,t.y*=m.y/2,e.x*=m.x/2,e.y*=m.y/2,s.start.copy(t),s.start.z=0,s.end.copy(e),s.end.z=0;var w=s.closestPointToPointParameter(n,!0);s.at(w,a);var E=q(t.z,e.z,w),T=E>=-1&&E<=1,C=n.distanceTo(a)<.5*g;if(T&&C){s.start.fromBufferAttribute(v,_),s.end.fromBufferAttribute(y,_),s.start.applyMatrix4(x),s.end.applyMatrix4(x);var L=new ot,A=new ot;c.distanceSqToSegment(s.start,s.end,A,L),l.push({point:A,pointOnLine:L,distance:c.origin.distanceTo(A),object:this,face:null,faceIndex:_,uv:null,uv2:null})}}}}}()});const Xa=new ot(1,0,0),qa=new ot;class Ya extends ms{constructor(t){const e=t.stdWidth,i=t.stdMargin,n=t.ctx,r=n.cfg,s=n.materials,a=r.themeColor("hud.ahi.sky"),o=r.themeColor("hud.ahi.earth");super(),this.name="CV.AHI",this.lastPitch=0;const l=new ms,h=t.getCommonRing(),c=.75*e,u=new Hs(c,31,31),d=new Ua,p=new Ua,f=u.getAttribute("position").count,m=new se(new Float32Array(3*f),3);for(let t=0;t<f;t++)(t<f/2?a:o).toArray(m.array,3*t);u.setAttribute("color",m);var g=[];g.push(4-e,0,c),g.push(e-4,0,c),d.setPositions(g);const v=e/10,y=new ot(v,0,c+1),x=new ot(-v,0,c+1);g=[];for(let t=0;t<12;t++){const e=y.clone(),i=x.clone();t%3==0&&(e.x*=2,i.x*=2),e.applyAxisAngle(Xa,t*Math.PI/6),i.applyAxisAngle(Xa,t*Math.PI/6),g.push(e.x,e.y,e.z,i.x,i.y,i.z)}p.setPositions(g);const _=new wi(h,s.getBezelMaterial()),M=new wi(u,new Xs({vertexColors:!0,specular:6710886,shininess:20})),b=new ja(d,new Va(n,{color:r.themeValue("hud.ahi.bar")})),S=new ja(p,new Va(n,{color:r.themeValue("hud.ahi.marks")}));M.rotateOnAxis(new ot(0,1,0),Math.PI/2),S.rotateOnAxis(new ot(1,0,0),Math.PI/2),_.rotateOnAxis(new ot(0,0,1),Math.PI/8),M.dropBuffers(),l.addStatic(M),l.addStatic(S),this.addStatic(_),this.addStatic(b),this.add(l);const w=e+i;this.translateX(-3*w),this.translateY(w),this.globe=l;const E=s.getGlyphMaterial(t.atlasSpec,0),T=new za("-90",E);return T.translateX(-T.getWidth()/2),T.translateY(e+5),this.addStatic(T),this.label=T,this}}function Za(t,e){const i=e.container,n=e.getControls(),r=t.createHitRegion(2*t.stdWidth,2*t.stdWidth,(function(n){if(!e.HUD)return;const s=n.currentTarget;s.addEventListener("mouseleave",h),s.addEventListener("mousemove",p),s.addEventListener("mousedown",c),s.addEventListener("mouseup",u),s.addEventListener("dblclick",d);const o=i.getBoundingClientRect();a=o.top+r.offsetTop+t.stdWidth,r.style.cursor="pointer"})),s=t.stdWidth-10;var a,o,l=!1;function h(t){const e=t.currentTarget;l&&n.end(),e.removeEventListener("mouseleave",h),e.removeEventListener("mousemove",p),e.removeEventListener("mousedown",c),e.removeEventListener("mouseup",u),e.removeEventListener("dblclick",d),r.style.cursor="default",l=!1}function c(t){t.stopPropagation(),l=!0,o=Math.atan((t.clientY-a)/s)}function u(t){t.stopPropagation(),n.end(),l=!1}function d(t){t.stopPropagation(),e.polarAngle<1e-4?e.polarAngle=Math.PI/2:e.polarAngle=0}function p(t){if(t.stopPropagation(),t.preventDefault(),!l)return;const e=Math.atan((t.clientY-a)/s);n.rotateUp(o-e),o=e}r.style.right=3*t.stdMargin+2*t.stdWidth+"px",r.style.bottom=t.stdMargin+"px",i.appendChild(r),this.dispose=function(){i.removeChild(r)}}Ya.prototype.set=function(t){t.getWorldDirection(qa);const e=Math.PI/2-qa.angleTo(Se.DefaultUp);e!==this.lastPitch&&(this.globe.rotateOnAxis(Xa,e-this.lastPitch),this.lastPitch=e,this.label.replaceString(String(Math.round(Z(e))+"").padStart(4," ")))};class Ja extends wi{constructor(t,e){const i=t.stdWidth,n=t.stdMargin,r=t.ctx.materials,s=new ot(1,0,0),a=new Vs(1,40,36,1,Math.PI,Math.PI),o=r.colourCache.getColors("inclination"),l=[],h=a.getAttribute("position"),c=h.count,u=new se(3*c,3),d=new ot;for(let t=0;t<c;t++){d.fromBufferAttribute(h,t).normalize();const e=Math.floor(254*Math.asin(Math.abs(d.dot(s)))/Math.PI);l.push(o[e])}a.setAttribute("color",u.copyColorsArray(l)),super(a,new ai({color:16777215,vertexColors:!0})),this.translateY(3*(i+n)+n+30),this.translateX(-45),this.dropBuffers(),this.name="CV.AngleScale";const p=r.getGlyphMaterial(t.atlasSpec,0),f=new Oa(e,p,t.ctx);f.translateX(-f.getWidth()/2),f.translateY(5),this.addStatic(f),this.visible=!1}}const Ka=new ot,Qa=new ot(0,0,-1),$a=new le;class to extends ms{constructor(t){const e=t.stdWidth,i=t.stdMargin,n=t.ctx.cfg,r=t.ctx.materials;super(),this.name="CV.Compass";const s=t.getCommonRing(),a=new wi(s,r.getBezelMaterial()),o=new Vs(.9*e,e,4,1,-Math.PI/32+Math.PI/2,Math.PI/16);o.translate(0,0,5);const l=new wi(o,new ai({color:n.themeValue("hud.compass.top1")}));a.dropBuffers(),l.dropBuffers();const h=function(){const t=new De,i=new js({vertexColors:!0}),r=new wi(t,i),s=[],a=[];h(n.themeColor("hud.compass.bottom1"),n.themeColor("hud.compass.bottom2"),Math.PI/4),h(n.themeColor("hud.compass.top1"),n.themeColor("hud.compass.top2"),0);const o=new se(s.length,3),l=new se(3*s.length,3);return t.setAttribute("position",o.copyArray(s)),t.setAttribute("color",l.copyColorsArray(a)),t.computeVertexNormals(),r;function h(t,i,n){const r=.9*e,o=.2*r,l=Math.PI/4,h=Math.PI/2;for(let e=0;e<4;e++){const c=e*Math.PI/2+n;s.push(Math.sin(c)*r,Math.cos(c)*r,0),s.push(0,0,2),s.push(Math.sin(c+l)*o,Math.cos(c+l)*o,0),a.push(t,t,t),s.push(Math.sin(c+l)*o,Math.cos(c+l)*o,0),s.push(0,0,2),s.push(Math.sin(c+h)*r,Math.cos(c+h)*r,0),a.push(i,i,i)}}}(),c=new ms;c.addStatic(a),c.addStatic(l),c.addStatic(h),this.add(c),this.rotaryGroup=c;const u=e+i;this.translateX(-u),this.translateY(u),this.lastRotation=0;const d=r.getGlyphMaterial(t.atlasSpec,0),p=new za("000",d);return p.translateX(-p.getWidth()/2),p.translateY(e+5),this.addStatic(p),void(this.label=p)}}function eo(t,e){const i=e.container,n=e.getControls(),r=new Q,s=new Q;var a=!1,o=0;const l=t.createHitRegion(2*t.stdWidth,2*t.stdWidth,(function(n){if(!e.HUD)return;const r=n.currentTarget;r.addEventListener("mouseleave",h),r.addEventListener("mousemove",p),r.addEventListener("mousedown",c),r.addEventListener("mouseup",u),r.addEventListener("dblclick",d);const a=i.getBoundingClientRect();s.set(a.left+l.offsetLeft+t.stdWidth,a.top+l.offsetTop+t.stdWidth),l.style.cursor="pointer"}));function h(t){const e=t.currentTarget;a&&n.end(),e.removeEventListener("mouseleave",h),e.removeEventListener("mousemove",p),e.removeEventListener("mousedown",c),e.removeEventListener("mouseup",u),e.removeEventListener("dblclick",d),l.style.cursor="default",a=!1}function c(t){t.stopPropagation(),a=!0,r.set(t.clientX,t.clientY).sub(s),o=r.angle()}function u(t){t.stopPropagation(),n.end(),a=!1}function d(t){t.stopPropagation(),r.x>r.y?r.x<-r.y?e.azimuthAngle=0:e.azimuthAngle=Math.PI/2:r.x>-r.y?e.azimuthAngle=Math.PI:e.azimuthAngle=3*Math.PI/2}function p(t){if(t.stopPropagation(),t.preventDefault(),!a)return;r.set(t.clientX,t.clientY).sub(s);const e=r.angle();n.rotateLeft(o-e),o=e}l.style.right=t.stdMargin+"px",l.style.bottom=t.stdMargin+"px",i.appendChild(l),this.dispose=function(){i.removeChild(l)}}to.prototype.set=function(t){var e;if(t.getWorldDirection(Ka),Math.abs(Ka.z)<.999?e=Math.atan2(-Ka.x,Ka.y):($a.setFromQuaternion(t.quaternion),e=$a.z),e===this.lastRotation)return;e<0&&(e=2*Math.PI+e);let i=Math.round(Z(e));360===i&&(i=0);const n=i.toString().padStart(3,"0")+"";this.label.replaceString(n),this.rotaryGroup.rotateOnAxis(Qa,e-this.lastRotation),this.lastRotation=e};class io extends ms{constructor(t,e,i,n){const r=t.ctx.materials,s=e.clientWidth,a=e.clientHeight,o=t.stdWidth,l=t.stdMargin,h=3*(o+l),c=(a-h)/2,u=o/2;super(),this.ctx=t.ctx,this.barHeight=c,this.barWidth=u,this.barOffset=h,this.offsetX=-u/2-5,this.offsetY=c/2,this.translateX(s/2-u/2-l),this.translateY(-a/2+c/2+h),this.scaleBar=new wi(i,n),this.scaleBar.name="scale bar",this.textMaterial=r.getGlyphMaterial(t.atlasSpec,0),this.add(this.scaleBar),this.min=null,this.max=null,this.caption=null}}io.prototype.setRange=function(t,e,i){const n=this.offsetX,r=this.offsetY,s=this.textMaterial;if(t!==this.min||e!==this.max){for(let t=this.children.length;t--;){const e=this.children[t];e.isRange&&this.remove(e)}const i=new Oa(Math.round(e)+"m",s,this.ctx),a=new Oa(Math.round(t)+"m",s,this.ctx);i.translateX(n-i.getWidth()),a.translateX(n-a.getWidth()),i.translateY(r-i.getHeight()),a.translateY(-r),i.isRange=!0,a.isRange=!0,this.addStatic(i),this.addStatic(a),this.min=t,this.max=e}return this.setCaption(i),this},io.prototype.setCaption=function(t){var e=this.caption;if(null!==e){if(e.name===t)return this;this.remove(e)}return(e=new Oa(t,this.textMaterial,this.ctx)).translateX(this.barWidth/2-e.getWidth()),e.translateY(this.offsetY+this.barWidth/2),this.addStatic(e),this.caption=e,this},io.prototype.dispose=function(){this.traverse((t=>{void 0!==t.geometry&&t.geometry.dispose()}))};class no extends io{constructor(t,e){const i=t.ctx,n=i.cfg,r=i.materials,s=new Ie;super(t,e,s,new ai({color:6776679})),this.name="CV.CursorScale";const a=this.barWidth,o=this.barHeight;s.scale(a,o,1);const l=new Ua;l.setPositions([a/2,-o/2,10,-a/2,-o/2,10]);const h=new ja(l,new Va(i,{color:n.themeColor("hud.cursor")})),c={color:n.themeColorCSS("hud.cursor"),background:"#444444",font:"bold helvetica,sans-serif"},u=r.getGlyphMaterial(c,0),d=new za("      ",u);d.translateY(-o/2-d.getHeight()/2),this.addStatic(h),h.addStatic(d),this.cursor=h,this.cursorLabel=d}}function ro(t,e,i){const r=e.container,s=t.createHitRegion(i.barWidth,i.barHeight,(function(t){if(!e.HUD)return;if(4!==e.shadingMode&&e.shadingMode!==n)return;const i=t.currentTarget;i.addEventListener("mouseleave",h),i.addEventListener("mousemove",d),i.addEventListener("mousedown",c),i.addEventListener("mouseup",u);const o=r.getBoundingClientRect();a=o.top+s.offsetTop,s.style.cursor="pointer"}));var a,o=!1;function l(t){const r=(i.barHeight-t+a)/i.barHeight,s=e.maxHeight-e.minHeight;e.shadingMode===n?e.cursorHeight=s-s*r:e.cursorHeight=s*r-s/2}function h(t){const e=t.currentTarget;e.removeEventListener("mouseleave",h),e.removeEventListener("mousemove",d),e.removeEventListener("mousedown",c),e.removeEventListener("mouseup",u),s.style.cursor="default",o=!1}function c(t){t.stopPropagation(),l(t.clientY),o=!0}function u(t){t.stopPropagation(),o=!1}function d(t){t.stopPropagation(),t.preventDefault(),o&&l(t.clientY)}s.style.right=t.stdMargin+"px",s.style.bottom=i.barOffset+"px",r.appendChild(s),this.hr=s}no.prototype.setCursor=function(t,e){const i=this.cursor,n=this.cursorLabel;return i.position.setY(this.barHeight*t),i.updateMatrix(),n.replaceString(String(e+"m").padStart(6," ")),n.position.setX(this.offsetX-n.getWidth()),n.updateMatrix(),this},ro.prototype.dispose=function(){const t=this.hr;t.parentNode.removeChild(t)};class so extends io{constructor(t,e){const i=t.ctx.materials,n=new Ie;super(t,e,n,i.getScaleMaterial()),this.name="CV.LinearScale",n.rotateZ(-Math.PI/2),n.scale(this.barWidth,this.barHeight,1)}}class ao extends wi{constructor(t,e,i,n){const r=t.ctx.cfg,s=t.ctx.materials,a=t.stdWidth,o=a+t.stdMargin,l=new Vs(a*(.9-.1*i),a*(1-.1*i)-(0===i?0:1),50),h=new se(306,3);if(l.setAttribute("color",h),super(l,s.getPlainMaterial()),this.backgroundColor=r.themeColor("hud.progressBackground"),this.setColor=r.themeColor("hud.progress"),this.viewer=n,this.dropBuffers(!1),this.name="CV.ProgressDial",this.translateX(5*-o),this.translateY(o),this.rotateOnAxis(Se.DefaultUp,Math.PI/2),this.visible=!1,this.isVisible=!0,this.colorRange(0),e){var c=s.getGlyphMaterial(t.atlasSpec,0);const e=new za("----",c);e.translateY(e.getWidth()/2),e.translateX(-10),this.add(e),this.pcent=e}else this.pcent=null}}ao.prototype.colorRange=function(t){const e=this.geometry.getAttribute("color"),i=50-Math.round(t/2),n=e.count,r=this.setColor,s=this.backgroundColor;for(let t=n/2;t>=0;t--){const n=t>i?r:s;n.toArray(e.array,3*t),n.toArray(e.array,3*(t+51))}e.needsUpdate=!0},ao.prototype.set=function(t){if(t===this.progress)return;this.progress=t;const e=2*Math.floor(Math.min(100,Math.round(t))/2),i=this.pcent;if(this.colorRange(e),null!==i){var n=Math.round(t)+"%";i.replaceString(n.padStart(4," ")),i.translateY(i.getWidth()/2-i.position.y)}this.viewer.renderView()},ao.prototype.start=function(){this.colorRange(0),this.progress=0,this.visible=!0,null!==this.pcent&&this.pcent.replaceString("  0%"),this.viewer.renderView()},ao.prototype.end=function(){const t=this;setTimeout((function(){t.visible=!1,t.viewer.renderView()}),500)},ao.prototype.setVisibility=function(t){this.isVisible=t,this.visible=this.visible&&t},ao.prototype.watch=function(t){t.addEventListener("progress",this.handleProgess.bind(this))},ao.prototype.handleProgess=function(t){switch(t.name){case"start":this.start();break;case"set":this.set(t.progress);break;case"end":this.end()}};class oo extends De{constructor(t,e,i,n){super();const r=t.cfg,s=r.themeColor("hud.scale.bar1"),a=r.themeColor("hud.scale.bar2"),o=[],l=[];c(10*n,0),c(n,i+1);const h=new se(3*l.length,3);function c(t,n){const r=e/t;for(let e=0;e<t;e++){const t=e*r,h=t+r,c=n,u=c+i;o.push(t,c,0,h,u,0,t,u,0,h,u,0,t,c,0,h,c,0);const d=e%2?s:a;l.push(d,d,d,d,d,d)}}this.setAttribute("position",new se(o,3)),this.setAttribute("color",h.copyColorsArray(l))}}class lo extends ms{constructor(t,e,i,n){const r=t.ctx.materials;super(),this.name="CV.ScaleBar",this.hScale=i,this.scaleBars=[],this.currentLength=0,this.wScale=e.clientHeight/e.clientWidth,this.hudObject=t,this.position.set(-e.clientWidth/2+45,-e.clientHeight/2+10,0),this.scaleMax=e.clientWidth-(50+n);const s=r.getGlyphMaterial(t.atlasSpec,0),a=new za("--------",s);a.translateX(0),a.translateY(10),this.add(a),this.label=a}}function ho(t){const e=t.cfg;this.stdWidth=e.themeValue("hud.widgetSize"),this.atlasSpec={color:e.themeColorCSS("hud.text"),font:e.themeValue("hud.font")},this.commonRing=null,this.ctx=t}function co(t,e){const i=this,s=t.ctx.cfg,a=t.container,o=a.clientHeight/2,l=a.clientWidth/2;var h,c,u,d,p=0,f=null,m=null,g=null,v=null,y=!0,x=!1;const _=new Gi(-l,l,o,-o,1,1e3);_.position.z=600;const M=new bs;M.name="HUD";const b=new ms;b.position.set(l,-o,0),M.addStatic(b);var S=new ho(t.ctx);const w=new aa(8947848),E=new sa(16777215);E.position.set(-1,1,1),M.addStatic(w),M.addStatic(E);const T=[new ao(S,!0,0,t),new ao(S,!1,1,t)],C=T[0];D(),b.addStatic(T[0]),b.addStatic(T[1]),t.addEventListener("newCave",P),t.addEventListener("change",I),t.addEventListener("resized",(function(){const e=t.container,i=e.clientWidth/2,n=e.clientHeight/2;_.left=-i,_.right=i,_.top=n,_.bottom=-n,_.updateProjectionMatrix(),b.position.set(i,-n,0),b.updateMatrix(),N()})),s.addEventListener("change",(function(){x&&P()})),s.addEventListener("colors",(function(){S=new ho(t.ctx),D(),P()})),d=t.getControls();const L=new eo(S,t),A=new Za(S,t);function R(t){const e=s.i18n("hud."+t);return void 0===e?t:e}function P(){x=!0,N(),I({type:"change",name:"shadingMode"})}function D(){h&&b.remove(h),c&&b.remove(c),u&&b.remove(u),h=new Ya(S),c=new to(S),u=new Ja(S,R("inclination")),b.addStatic(h),b.addStatic(c),b.addStatic(u)}function N(){const e=t.container,n=t.minHeight!==1/0&&t.maxHeight!==-1/0;f&&(f.dispose(),M.remove(f)),n&&(f=new so(S,e),M.addStatic(f)),m&&(m.dispose(),M.remove(m)),n&&(m=new no(S,e),v&&v.dispose(),v=new ro(S,t,m),M.addStatic(m)),g&&(M.remove(g),g=null),O(d.cameraManager.activeCamera),i.setVisibility(y)}function I(e){if("shadingMode"===e.name&&y&&x){var i=!1,s=!1,a=!1;switch(t.shadingMode){case 1:s=!0,f.setRange(t.minHeight,t.maxHeight,R("height"));break;case 9:s=!0,f.setRange(t.maxHeight-t.minHeight,0,R("depth"));break;case r:s=!0,f.setRange(0,t.maxDistance,R("distance"));break;case 4:a=!0,m.setRange(t.minHeight,t.maxHeight,R("height")),F();break;case n:a=!0,m.setRange(t.maxHeight-t.minHeight,0,R("depth")),F();break;case 2:s=!0,f.setRange(t.minLegLength,t.maxLegLength,R("leg_length"));break;case 3:i=!0}u.visible=i,f.visible=s,m.visible=a,a?t.addEventListener("cursorChange",F):t.removeEventListener("cursorChange",F),t.renderView()}}function F(){const e=t.cursorHeight,i=t.maxHeight-t.minHeight;var n=0,r=0;4===t.shadingMode?(n=(t.cursorHeight+i/2)/i,r=e+i/2+t.minHeight):(n=1-e/i,r=e),n=Math.max(Math.min(n,1),0),m.setCursor(n,Math.round(r))}function O(e){e.isOrthographicCamera?(null===g&&(g=new lo(S,t.container,p,4*(S.stdWidth+S.stdMargin)),M.addStatic(g)),g.visible=y,g.setScale(e.zoom)):null!==g&&g.visible&&(g.visible=!1)}this.setVisibility=function(e){c.visible=e,h.visible=e,C.setVisibility(e),g&&(g.visible=e),y=e,f&&(e?I({type:"change",name:"shadingMode"}):(f.visible=!1,m.visible=!1,u.visible=!1)),t.renderView()},this.getVisibility=function(){return y},this.getProgressDial=function(t){return T[t]},this.setScale=function(t){p=t},this.renderHUD=function(){const t=d.cameraManager.activeCamera;c.set(t),h.set(t),O(t),e.clearDepth(),e.render(M,_)},this.dispose=function(){A.dispose(),L.dispose(),v&&v.dispose()}}lo.prototype.setScale=function(t){const e=this.scaleBars,i=this,n=this.hudObject.ctx,r=this.scaleMax/(t*this.hScale);var s=Math.ceil(Math.log(r)/Math.LN10)-1;const a=r/Math.pow(10,s);var o,l=0;if(a<2?(l=10,s-=1):l=a<5?2:5,o=s>=3?l*Math.pow(10,s-3)+"km":l*Math.pow(10,s)+"m",t*=Math.pow(10,s),this.currentLength!==l){if(!e[l]){const t=function(t){const e=new oo(n,t*i.hScale,4,t);return e.computeBoundingBox(),{mesh:new wi(e,n.materials.getPlainMaterial()),topRight:e.boundingBox.max.x}}(l);e[l]=t,this.add(t.mesh)}this.currentLength>0&&(e[this.currentLength].mesh.visible=!1),e[l].mesh.visible=this.visible,this.currentLength=l}e[l].mesh.scale.x=t;const h=this.label;h.replaceString(o.padStart(8," "));const c=h.getWidth();return h.translateX(t*e[l].topRight-h.position.x-c),this},Object.assign(ho.prototype,{stdMargin:5,createHitRegion:function(t,e,i){const n=document.createElement("div");return n.style.width=t+"px",n.style.height=e+"px",n.style.position="absolute",n.setAttribute("draggable","false"),n.addEventListener("dragstart",(function(t){t.preventDefault()})),n.addEventListener("mouseenter",i),n},getCommonRing:function(){var t=this.commonRing;return null===t&&((t=new Ws(.9*this.stdWidth,this.stdWidth,3,32,1,!0)).rotateX(Math.PI/2),this.commonRing=t),t}});class uo extends ke{constructor(t,e){const i=t.survey,n=t.cfg,r=i.modelLimits;super({vertexShader:Ga.cursorVertexShader,fragmentShader:Ga.cursorFragmentShader,type:"CV.CursorMaterial",uniforms:Object.assign({uLight:{value:i.lightDirection},cursor:{value:0},cursorWidth:{value:5},baseColor:{value:n.themeColor("shading.cursorBase")},cursorColor:{value:n.themeColor("shading.cursor")}},t.materials.commonUniforms),defines:{USE_COLOR:!0,SURFACE:1!==e}}),this.halfRange=(r.max.z-r.min.z)/2}}uo.prototype.setCursor=function(t){const e=Math.max(Math.min(t,this.halfRange),-this.halfRange);return this.uniforms.cursor.value=e,e},uo.prototype.getCursor=function(){return this.uniforms.cursor.value};class po extends Ns{constructor(t){const e=32,i=document.createElement("canvas");i||console.error("creating canvas for cluster marker failed"),i.width=64,i.height=64;const n=i.getContext("2d");n||console.error("cannot obtain 2D canvas"),n.fillStyle="rgba( 0, 0, 0, 0 )",n.fillRect(0,0,64,64),n.textAlign="center",n.font="bold 40px helvetica,sans-serif",n.fillStyle="#ffffff";const r=n.createRadialGradient(e,e,30,e,e,0);r.addColorStop(0,"rgba( 255, 128, 0, 64 )"),r.addColorStop(.3,"rgba( 255, 200, 0, 255 )"),r.addColorStop(1,"rgba( 255, 255, 0, 255 )"),n.fillStyle=r,n.beginPath(),n.arc(e,e,30,0,2*Math.PI),n.fill(),n.fillStyle="rgba( 0, 0, 0, 255 )",n.fillText(t,e,47);const s=new Gs(i);super({map:s,size:32,depthTest:!1,transparent:!0,alphaTest:.8,sizeAttenuation:!1}),s.onUpdate=function(t){t.image=null},this.name="ClusterMaterial"}}function fo(){}fo.prototype.setThroughMode=function(t){switch(this.stencilWrite=!1,this.blending=1,t){case 2:this.blending=5,this.blendSrc=207,this.blendDst=206;break;case 1:this.stencilWrite=!0,this.stencilFunc=514}};const mo=["uniform vec3 contourColor;","uniform vec3 contourColor10;","uniform float contourInterval;","uniform vec3 baseColor;","varying float vPositionZ;"].join("\n"),go=["float f = fract( vPositionZ / contourInterval );","if ( f > 0.5 ) f = 1.0 - f;","float f10 = fract( vPositionZ / ( contourInterval * 10.0 ) );","float df = fwidth( vPositionZ / contourInterval );","float contourColorSelection = step( 0.90, f10 );","float c = smoothstep( df * 0.5, df * 1.0, f );","vec4 finalColor = vec4( mix( contourColor, contourColor10, contourColorSelection ), 1.0 );","vec4 baseColorAlpha = vec4( baseColor, opacity );","diffuseColor = mix( finalColor, baseColorAlpha, c );"].join("\n");class vo extends js{constructor(t){const e=t.survey,i=t.cfg,n=t.materials;super(),this.transparent=!0,this.extensions={derivatives:!0},this.onBeforeCompile=function(t){Object.assign(t.uniforms,{zOffset:{value:e.offsets.z},contourInterval:{value:i.themeValue("shading.contours.interval")},contourColor:{value:i.themeColor("shading.contours.line")},contourColor10:{value:i.themeColor("shading.contours.line10")},baseColor:{value:i.themeColor("shading.contours.base")}},n.commonDepthUniforms,n.commonTerrainUniforms);var r=t.vertexShader.replace("#include <common>","$&\nuniform float zOffset;\nuniform float datumShift;\nvarying float vPositionZ;\n").replace("include <begin_vertex>","$&\nvPositionZ = position.z + zOffset + datumShift;\n"),s=t.fragmentShader.replace("#include <common>","$&\n"+mo+"\n").replace("#include <color_fragment>",go);t.vertexShader=r,t.fragmentShader=s},Object.defineProperty(this,"opacity",{get:function(){return t.materials.terrainOpacity}})}}Object.assign(vo.prototype,fo.prototype);class yo extends ke{constructor(t,e){const i=t.survey,n=i.modelLimits,r=i.terrain,s=r.boundingBox,a=s.getSize(new ot),o=t.cfg.value("saturatedGradient",!1)?"gradientHi":"gradientLow",l=t.materials.textureCache;super({vertexShader:Ga.depthVertexShader,fragmentShader:Ga.depthFragmentShader,type:"CV.DepthMaterial",uniforms:Object.assign({uLight:{value:i.lightDirection},modelMin:{value:s.min},scaleX:{value:1/a.x},scaleY:{value:1/a.y},rangeZ:{value:a.z},depthScale:{value:1/(n.max.z-n.min.z)},cmap:{value:l.getTexture(o)},depthMap:{value:r.depthTexture}},t.materials.commonUniforms,t.materials.commonDepthUniforms),defines:{USE_COLOR:!0,SURFACE:1!==e}})}}class xo extends ke{constructor(t,e){const i=t.survey,n=t.cfg,r=i.modelLimits,s=i.terrain,a=s.boundingBox,o=a.getSize(new ot),l=r.max.z-r.min.z;super({vertexShader:Ga.depthCursorVertexShader,fragmentShader:Ga.depthCursorFragmentShader,type:"CV.DepthCursorMaterial",uniforms:Object.assign({uLight:{value:i.lightDirection},modelMin:{value:a.min},scaleX:{value:1/o.x},scaleY:{value:1/o.y},rangeZ:{value:o.z},depthMap:{value:s.depthTexture},cursor:{value:l/2},cursorWidth:{value:5},baseColor:{value:n.themeColor("shading.cursorBase")},cursorColor:{value:n.themeColor("shading.cursor")}},t.materials.commonUniforms,t.materials.commonDepthUniforms),defines:{USE_COLOR:!0,SURFACE:1!==e}}),this.max=l}}xo.prototype.setCursor=function(t){const e=Math.max(Math.min(t,this.max),0);return this.uniforms.cursor.value=e,e},xo.prototype.getCursor=function(){return this.uniforms.cursor.value};class _o extends ke{constructor(t){const e=t.boundingBox,i=e.min.z,n=e.max.z;super({vertexShader:Ga.depthMapVertexShader,fragmentShader:Ga.depthMapFragmentShader,type:"CV.DepthMapMaterial",depthWrite:!1,uniforms:{minZ:{value:i},scaleZ:{value:1/(n-i)}}})}}class Mo extends Ns{constructor(t){super();const e=t.materials.textureCache;return this.map=e.getTexture("disc"),this.color=new $t(16777215),this.opacity=1,this.alphaTest=.8,this.sizeAttenuation=!1,this.transparent=!0,this.vertexColors=!0,this.onBeforeCompile=function(t){var e=t.vertexShader.replace("#include <common>","\nattribute float pSize;\n\n$&").replace("\tgl_PointSize = size;","\tgl_PointSize = pSize;");t.vertexShader=e},this}}class bo extends ke{constructor(t,e,i,n){const r=e.cellScale,s=n.container,a=e.cellSize,o=Math.cos(i),l=Math.sin(i),h=new Q(a/s.clientWidth,a/s.clientHeight),c=new Float32Array([o,l,-l,o]);super({vertexShader:Ga.glyphVertexShader,fragmentShader:Ga.glyphFragmentShader,type:"CV.GlyphMaterial",uniforms:Object.assign({cellScale:{value:r},atlas:{value:e.getTexture()},rotate:{value:c},scale:{value:h}},t.materials.commonUniforms)}),this.rotation=i,this.alphaTest=.9,this.depthTest=!1,this.transparent=!0,this.type="CV.GlyphMaterial",this.atlas=e,this.scaleFactor=1/e.cellScale,n.addEventListener("resized",(function(){u.uniforms.scale.value.set(a/s.clientWidth,a/s.clientHeight)}));const u=this}}bo.prototype.getAtlas=function(){return this.atlas};class So extends ke{constructor(t,e){const i=t.survey,n=i.modelLimits,r=n.min.z,s=n.max.z,a=t.cfg.value("saturatedGradient",!1)?"gradientHi":"gradientLow",o=t.materials.textureCache;super({vertexShader:Ga.heightVertexShader,fragmentShader:Ga.heightFragmentShader,type:"CV.HeightMaterial",uniforms:Object.assign({uLight:{value:i.lightDirection},minZ:{value:r},scaleZ:{value:1/(s-r)},cmap:{value:o.getTexture(a)}},t.materials.commonUniforms),defines:{USE_COLOR:!0,SURFACE:1!==e}}),this.midRange=(s+r)/2}}const wo=["uniform sampler2D cmap;","varying float zMap;",Ga.commonTerrainCodePars].join("\n"),Eo=["diffuseColor = texture2D( cmap, vec2( 1.0 - zMap, 1.0 ) );","diffuseColor.a = opacity;",Ga.commonTerrainCodeColor].join("\n");class To extends js{constructor(t){const e=t.survey,i=t.cfg,n=e.terrain,r=t.materials.textureCache;super();var s=i.themeValue("shading.hypsometric.min"),a=i.themeValue("shading.hypsometric.max");void 0===n.boundBox&&n.computeBoundingBox(),void 0===s&&(s=n.boundingBox.min.z),void 0===a&&(a=n.boundingBox.max.z),this.transparent=!0,this.onBeforeCompile=function(e){Object.assign(e.uniforms,t.materials.commonTerrainUniforms,{minZ:{value:s},scaleZ:{value:1/(a-s)},cmap:{value:r.getTexture("hypsometric")}});var i=e.vertexShader.replace("#include <common>","\nuniform float minZ;\nuniform float scaleZ;\nvarying float zMap;\nvarying vec2 vPosition;\n$&").replace("include <begin_vertex>","$&\nvPosition = vec2( position.x, position.y );\nzMap = saturate( ( position.z - minZ ) * scaleZ );"),n=e.fragmentShader.replace("#include <common>","$&\n"+wo+"\n").replace("#include <color_fragment>",Eo);e.vertexShader=i,e.fragmentShader=n},Object.defineProperty(this,"opacity",{get:function(){return t.materials.terrainOpacity}})}}Object.assign(To.prototype,fo.prototype);class Co extends js{constructor(t){super({color:16746632}),this.transparent=!0,Object.defineProperty(this,"opacity",{get:function(){return t.materials.terrainOpacity}})}}Object.assign(Co.prototype,fo.prototype);const Lo={inclination:[[255,255,0],[253,254,2],[251,253,4],[249,252,5],[247,251,7],[245,250,9],[243,249,11],[241,249,13],[239,248,14],[237,247,16],[235,246,18],[233,245,20],[231,244,22],[229,243,23],[227,242,25],[225,241,27],[223,240,29],[221,239,31],[219,238,32],[217,237,34],[215,237,36],[213,236,38],[211,235,40],[209,234,41],[207,233,43],[205,232,45],[203,231,47],[201,230,49],[199,229,50],[197,228,52],[195,227,54],[193,226,56],[191,226,58],[189,225,60],[187,224,61],[185,223,63],[183,222,65],[181,221,67],[179,220,69],[177,219,70],[175,218,72],[173,217,74],[171,216,76],[169,215,78],[167,214,79],[165,214,81],[163,213,83],[161,212,85],[159,211,87],[157,210,88],[155,209,90],[153,208,92],[151,207,94],[149,206,96],[147,205,97],[145,204,99],[143,203,101],[141,202,103],[139,202,105],[137,201,106],[135,200,108],[133,199,110],[131,198,112],[129,197,114],[126,196,115],[124,195,117],[122,194,119],[120,193,121],[118,192,123],[116,191,124],[114,191,126],[112,190,128],[110,189,130],[108,188,132],[106,187,133],[104,186,135],[102,185,137],[100,184,139],[98,183,141],[96,182,142],[94,181,144],[92,180,146],[90,179,148],[88,179,150],[86,178,151],[84,177,153],[82,176,155],[80,175,157],[78,174,159],[76,173,160],[74,172,162],[72,171,164],[70,170,166],[68,169,168],[66,168,169],[64,167,171],[62,167,173],[60,166,175],[58,165,177],[56,164,179],[54,163,180],[52,162,182],[50,161,184],[48,160,186],[46,159,188],[44,158,189],[42,157,191],[40,156,193],[38,156,195],[36,155,197],[34,154,198],[32,153,200],[30,152,202],[28,151,204],[26,150,206],[24,149,207],[22,148,209],[20,147,211],[18,146,213],[16,145,215],[14,144,216],[12,144,218],[10,143,220],[8,142,222],[6,141,224],[4,140,225],[2,139,227],[0,138,229]],gradientLow:[[235,99,111],[235,99,112],[234,99,113],[234,100,114],[233,100,114],[233,100,115],[232,100,116],[232,101,117],[231,101,118],[231,101,119],[230,101,119],[230,101,120],[230,102,121],[229,102,122],[229,102,123],[228,102,124],[228,103,124],[227,103,125],[227,103,126],[226,103,127],[226,103,128],[226,104,129],[225,104,129],[225,104,130],[224,104,131],[224,104,132],[223,105,133],[223,105,134],[222,105,134],[222,105,135],[221,106,136],[221,106,137],[221,106,138],[220,106,139],[220,106,139],[219,107,140],[219,107,141],[218,107,142],[218,107,143],[217,108,144],[217,108,144],[216,108,145],[216,108,146],[216,108,147],[215,109,148],[215,109,149],[214,109,149],[214,109,150],[213,110,151],[213,110,152],[212,110,153],[212,110,154],[211,110,154],[211,111,155],[211,111,156],[210,111,157],[210,111,158],[209,111,159],[209,112,159],[208,112,160],[208,112,161],[207,112,162],[207,113,163],[207,113,164],[206,113,164],[206,113,165],[205,113,166],[205,114,167],[204,114,168],[204,114,169],[203,114,169],[203,115,170],[202,115,171],[202,115,172],[201,115,172],[200,116,173],[199,116,173],[198,116,173],[197,117,174],[196,117,174],[194,118,174],[193,118,175],[192,118,175],[191,119,176],[190,119,176],[189,119,176],[188,120,177],[187,120,177],[186,121,177],[185,121,178],[184,121,178],[183,122,178],[181,122,179],[180,122,179],[179,123,179],[178,123,180],[177,124,180],[176,124,181],[175,124,181],[174,125,181],[173,125,182],[172,125,182],[171,126,182],[170,126,183],[168,126,183],[167,127,183],[166,127,184],[165,128,184],[164,128,184],[163,128,185],[162,129,185],[161,129,186],[160,129,186],[159,130,186],[158,130,187],[157,131,187],[155,131,187],[154,131,188],[153,132,188],[152,132,188],[151,132,189],[150,133,189],[149,133,189],[148,133,190],[147,134,190],[146,134,191],[145,135,191],[144,135,191],[142,135,192],[141,136,192],[140,136,192],[139,136,193],[138,137,193],[137,137,193],[136,138,194],[135,138,194],[134,138,194],[133,139,195],[132,139,195],[131,139,196],[129,140,196],[128,140,196],[127,141,197],[126,141,197],[125,141,197],[124,142,198],[123,142,198],[122,142,198],[120,142,197],[119,143,197],[117,143,197],[116,143,197],[114,143,196],[113,144,196],[111,144,196],[110,144,195],[108,144,195],[107,144,195],[105,145,195],[104,145,194],[102,145,194],[101,145,194],[100,146,193],[98,146,193],[97,146,193],[95,146,193],[94,146,192],[92,147,192],[91,147,192],[89,147,191],[88,147,191],[86,147,191],[85,148,191],[83,148,190],[82,148,190],[80,148,190],[79,149,189],[78,149,189],[76,149,189],[75,149,189],[73,149,188],[72,150,188],[70,150,188],[69,150,187],[67,150,187],[66,151,187],[64,151,186],[63,151,186],[61,151,186],[60,151,186],[59,152,185],[57,152,185],[56,152,185],[54,152,184],[53,153,184],[51,153,184],[50,153,184],[48,153,183],[47,153,183],[45,154,183],[44,154,182],[42,154,182],[41,154,182],[39,154,182],[38,155,181],[37,155,181],[35,155,181],[34,155,180],[32,156,180],[31,156,180],[29,156,180],[28,156,179],[26,156,179],[25,157,179],[23,157,178],[22,157,178],[20,157,178],[19,158,178],[17,158,177],[16,158,177],[16,158,176],[17,158,176],[17,158,175],[18,158,174],[18,158,174],[19,158,173],[19,158,172],[20,158,171],[20,158,171],[21,158,170],[21,158,169],[22,158,169],[22,159,168],[23,159,167],[23,159,167],[23,159,166],[24,159,165],[24,159,164],[25,159,164],[25,159,163],[26,159,162],[26,159,162],[27,159,161],[27,159,160],[28,159,160],[28,159,159],[29,159,158],[29,159,157],[30,159,157],[30,159,156],[30,159,155],[31,159,155],[31,159,154],[32,159,153],[32,159,153],[33,159,152],[33,160,151],[34,160,150],[34,160,150],[35,160,149],[35,160,148],[36,160,148],[36,160,147],[36,160,146],[37,160,146],[37,160,145],[38,160,144],[38,160,143],[39,160,143],[39,160,142],[40,160,141],[40,160,141],[41,160,140],[41,160,139],[42,160,139],[42,160,138],[43,160,137],[43,160,136],[43,160,136],[44,160,135],[44,161,134],[45,161,134],[45,161,133],[46,161,132],[46,161,132],[47,161,131],[47,161,130],[48,161,129],[48,161,129],[49,161,128],[49,161,127],[50,161,127],[50,161,126],[51,161,125],[52,161,125],[53,161,124],[54,161,123],[55,161,123],[56,161,122],[56,160,121],[57,160,121],[58,160,120],[59,160,120],[60,160,119],[61,160,118],[62,160,118],[63,160,117],[64,160,116],[65,160,116],[66,160,115],[67,160,114],[67,159,114],[68,159,113],[69,159,112],[70,159,112],[71,159,111],[72,159,111],[73,159,110],[74,159,109],[75,159,109],[76,159,108],[77,159,107],[78,159,107],[78,158,106],[79,158,105],[80,158,105],[81,158,104],[82,158,103],[83,158,103],[84,158,102],[85,158,102],[86,158,101],[87,158,100],[88,158,100],[89,158,99],[89,157,98],[90,157,98],[91,157,97],[92,157,96],[93,157,96],[94,157,95],[95,157,94],[96,157,94],[97,157,93],[98,157,93],[99,157,92],[100,157,91],[100,156,91],[101,156,90],[102,156,89],[103,156,89],[104,156,88],[105,156,87],[106,156,87],[107,156,86],[108,156,85],[109,156,85],[110,156,84],[111,156,84],[111,155,83],[112,155,82],[113,155,82],[114,155,81],[115,155,80],[116,155,80],[117,155,79],[118,155,79],[118,155,79],[119,154,78],[120,154,78],[121,154,78],[121,154,78],[122,154,78],[123,153,77],[123,153,77],[124,153,77],[125,153,77],[126,153,77],[126,152,77],[127,152,76],[128,152,76],[128,152,76],[129,152,76],[130,151,76],[131,151,75],[131,151,75],[132,151,75],[133,150,75],[133,150,75],[134,150,74],[135,150,74],[136,150,74],[136,149,74],[137,149,74],[138,149,73],[138,149,73],[139,149,73],[140,148,73],[141,148,73],[141,148,72],[142,148,72],[143,148,72],[143,147,72],[144,147,72],[145,147,72],[145,147,71],[146,147,71],[147,146,71],[148,146,71],[148,146,71],[149,146,70],[150,146,70],[150,145,70],[151,145,70],[152,145,70],[153,145,69],[153,145,69],[154,144,69],[155,144,69],[155,144,69],[156,144,68],[157,143,68],[158,143,68],[158,143,68],[159,143,68],[160,143,67],[160,142,67],[161,142,67],[162,142,67],[163,142,67],[163,142,67],[164,141,66],[165,141,66],[165,141,66],[166,141,66],[167,141,66],[168,140,65],[168,140,65],[169,140,65],[169,140,65],[170,140,66],[170,139,66],[171,139,66],[171,139,67],[172,139,67],[172,139,67],[172,138,68],[173,138,68],[173,138,68],[174,138,69],[174,138,69],[175,137,69],[175,137,70],[175,137,70],[176,137,70],[176,137,71],[177,136,71],[177,136,71],[177,136,72],[178,136,72],[178,135,72],[179,135,73],[179,135,73],[180,135,73],[180,135,74],[180,134,74],[181,134,74],[181,134,75],[182,134,75],[182,134,75],[183,133,76],[183,133,76],[183,133,76],[184,133,77],[184,133,77],[185,132,77],[185,132,77],[186,132,78],[186,132,78],[186,132,78],[187,131,79],[187,131,79],[188,131,79],[188,131,80],[189,131,80],[189,130,80],[189,130,81],[190,130,81],[190,130,81],[191,130,82],[191,129,82],[192,129,82],[192,129,83],[192,129,83],[193,128,83],[193,128,84],[194,128,84],[194,128,84],[194,128,85],[195,127,85],[195,127,85],[196,127,86],[196,127,86],[197,127,86],[197,126,87],[197,126,87],[198,126,87],[198,126,88],[199,126,88],[199,125,88],[200,125,89],[200,125,89]],gradientHi:[[167,1,221],[131,4,228],[74,2,231],[47,2,242],[2,27,247],[3,33,251],[4,39,254],[5,51,254],[6,75,254],[7,101,254],[8,127,238],[9,151,213],[10,177,168],[19,202,123],[30,227,78],[41,252,40],[72,254,36],[126,254,33],[167,254,30],[194,253,30],[220,224,29],[253,203,31],[254,176,25],[254,148,21],[254,120,18],[254,90,13],[254,61,9],[254,30,6],[254,2,2],[254,1,1],[254,1,1],[255,0,0]],survey:[[166,206,227],[31,120,180],[178,223,138],[51,160,44],[251,154,153],[227,26,28],[253,191,111],[255,127,0],[202,178,214],[106,61,154],[255,255,153]],depth:[[255,255,204],[255,255,203],[255,255,203],[255,254,202],[255,254,202],[255,254,201],[255,254,200],[255,253,200],[255,253,199],[255,253,199],[255,253,198],[255,252,197],[255,252,197],[255,252,196],[255,252,196],[255,251,195],[255,251,194],[255,251,194],[255,251,193],[255,250,193],[255,250,192],[255,250,191],[255,250,191],[255,249,190],[255,249,190],[255,249,189],[255,249,188],[255,248,188],[255,248,187],[255,248,187],[255,248,186],[255,247,185],[255,247,185],[255,247,184],[255,247,184],[255,246,183],[255,246,182],[255,246,182],[255,246,181],[255,245,180],[255,245,180],[255,245,179],[255,245,179],[255,244,178],[255,244,177],[255,244,177],[255,244,176],[255,243,176],[255,243,175],[255,243,174],[255,243,174],[255,242,173],[255,242,173],[255,242,172],[255,242,171],[255,241,171],[255,241,170],[255,241,170],[255,241,169],[255,240,168],[255,240,168],[255,240,167],[255,240,167],[255,239,166],[255,239,165],[255,239,165],[255,239,164],[255,238,164],[255,238,163],[255,238,162],[255,238,162],[255,237,161],[255,237,161],[255,237,160],[255,237,159],[255,236,159],[255,236,158],[255,236,158],[255,236,157],[255,235,157],[255,235,156],[255,235,155],[255,235,155],[255,234,154],[255,234,154],[255,234,153],[255,233,153],[255,233,152],[255,233,151],[255,233,151],[255,232,150],[255,232,150],[255,232,149],[255,232,148],[255,231,148],[255,231,147],[255,231,147],[255,230,146],[255,230,146],[255,230,145],[255,230,144],[255,229,144],[255,229,143],[255,229,143],[255,229,142],[255,228,142],[255,228,141],[255,228,140],[255,227,140],[255,227,139],[254,227,139],[254,227,138],[254,226,138],[254,226,137],[254,226,136],[254,225,136],[254,225,135],[254,225,135],[254,225,134],[254,224,134],[254,224,133],[254,224,132],[254,224,132],[254,223,131],[254,223,131],[254,223,130],[254,222,130],[254,222,129],[254,222,128],[254,222,128],[254,221,127],[254,221,127],[254,221,126],[254,221,125],[254,220,125],[254,220,124],[254,220,124],[254,219,123],[254,219,123],[254,219,122],[254,219,121],[254,218,121],[254,218,120],[254,218,120],[254,218,119],[254,217,119],[254,217,118],[254,216,117],[254,216,117],[254,215,116],[254,215,116],[254,214,115],[254,214,115],[254,213,114],[254,213,113],[254,212,113],[254,212,112],[254,211,112],[254,211,111],[254,210,111],[254,210,110],[254,209,109],[254,208,109],[254,208,108],[254,207,108],[254,207,107],[254,206,106],[254,206,106],[254,205,105],[254,205,105],[254,204,104],[254,204,104],[254,203,103],[254,203,102],[254,202,102],[254,202,101],[254,201,101],[254,200,100],[254,200,100],[254,199,99],[254,199,98],[254,198,98],[254,198,97],[254,197,97],[254,197,96],[254,196,96],[254,196,95],[254,195,94],[254,195,94],[254,194,93],[254,193,93],[254,193,92],[254,192,92],[254,192,91],[254,191,90],[254,191,90],[254,190,89],[254,190,89],[254,189,88],[254,189,88],[254,188,87],[254,188,86],[254,187,86],[254,187,85],[254,186,85],[254,185,84],[254,185,83],[254,184,83],[254,184,82],[254,183,82],[254,183,81],[254,182,81],[254,182,80],[254,181,79],[254,181,79],[254,180,78],[254,180,78],[254,179,77],[254,179,77],[254,178,76],[254,177,76],[254,177,76],[254,176,75],[254,176,75],[254,175,75],[254,175,75],[254,174,74],[254,174,74],[254,173,74],[254,173,74],[254,172,74],[254,172,73],[254,171,73],[254,171,73],[254,170,73],[254,170,72],[254,169,72],[254,169,72],[254,168,72],[254,168,72],[254,167,71],[254,167,71],[254,166,71],[254,166,71],[254,165,71],[254,165,70],[254,164,70],[254,164,70],[254,163,70],[254,163,69],[254,162,69],[254,162,69],[254,161,69],[254,161,69],[254,160,68],[254,160,68],[253,159,68],[253,159,68],[253,158,67],[253,158,67],[253,157,67],[253,157,67],[253,156,67],[253,156,66],[253,155,66],[253,155,66],[253,154,66],[253,154,65],[253,153,65],[253,153,65],[253,152,65],[253,152,65],[253,151,64],[253,151,64],[253,150,64],[253,150,64],[253,149,64],[253,149,63],[253,148,63],[253,148,63],[253,147,63],[253,147,62],[253,146,62],[253,146,62],[253,145,62],[253,145,62],[253,144,61],[253,144,61],[253,143,61],[253,143,61],[253,142,60],[253,142,60],[253,141,60],[253,140,60],[253,139,60],[253,138,59],[253,138,59],[253,137,59],[253,136,59],[253,135,58],[253,134,58],[253,133,58],[253,132,58],[253,132,57],[253,131,57],[253,130,57],[253,129,57],[253,128,56],[253,127,56],[253,126,56],[253,125,56],[253,125,55],[253,124,55],[253,123,55],[253,122,55],[253,121,54],[253,120,54],[253,119,54],[253,119,54],[253,118,53],[253,117,53],[253,116,53],[253,115,53],[253,114,52],[253,113,52],[253,113,52],[253,112,52],[253,111,51],[253,110,51],[252,109,51],[252,108,51],[252,107,50],[252,106,50],[252,106,50],[252,105,50],[252,104,49],[252,103,49],[252,102,49],[252,101,49],[252,100,48],[252,100,48],[252,99,48],[252,98,48],[252,97,47],[252,96,47],[252,95,47],[252,94,47],[252,94,46],[252,93,46],[252,92,46],[252,91,46],[252,90,45],[252,89,45],[252,88,45],[252,87,45],[252,87,44],[252,86,44],[252,85,44],[252,84,44],[252,83,43],[252,82,43],[252,81,43],[252,81,43],[252,80,42],[252,79,42],[252,78,42],[252,77,42],[251,77,42],[251,76,41],[251,75,41],[250,74,41],[250,74,41],[250,73,41],[249,72,40],[249,72,40],[249,71,40],[248,70,40],[248,69,40],[248,69,40],[247,68,39],[247,67,39],[247,67,39],[246,66,39],[246,65,39],[245,64,38],[245,64,38],[245,63,38],[244,62,38],[244,62,38],[244,61,37],[243,60,37],[243,59,37],[243,59,37],[242,58,37],[242,57,36],[242,57,36],[241,56,36],[241,55,36],[241,54,36],[240,54,35],[240,53,35],[240,52,35],[239,52,35],[239,51,35],[239,50,35],[238,50,34],[238,49,34],[238,48,34],[237,47,34],[237,47,34],[237,46,33],[236,45,33],[236,45,33],[236,44,33],[235,43,33],[235,42,32],[235,42,32],[234,41,32],[234,40,32],[234,40,32],[233,39,31],[233,38,31],[232,37,31],[232,37,31],[232,36,31],[231,35,30],[231,35,30],[231,34,30],[230,33,30],[230,32,30],[230,32,30],[229,31,29],[229,30,29],[229,30,29],[228,29,29],[228,28,29],[228,27,28],[227,27,28],[227,26,28],[226,26,28],[226,25,28],[225,25,28],[224,25,29],[224,24,29],[223,24,29],[222,24,29],[222,23,29],[221,23,29],[220,22,29],[219,22,30],[219,22,30],[218,21,30],[217,21,30],[217,21,30],[216,20,30],[215,20,30],[215,20,30],[214,19,31],[213,19,31],[213,19,31],[212,18,31],[211,18,31],[211,17,31],[210,17,31],[209,17,32],[209,16,32],[208,16,32],[207,16,32],[206,15,32],[206,15,32],[205,15,32],[204,14,33],[204,14,33],[203,14,33],[202,13,33],[202,13,33],[201,12,33],[200,12,33],[200,12,33],[199,11,34],[198,11,34],[198,11,34],[197,10,34],[196,10,34],[195,10,34],[195,9,34],[194,9,35],[193,9,35],[193,8,35],[192,8,35],[191,7,35],[191,7,35],[190,7,35],[189,6,36],[189,6,36],[188,6,36],[187,5,36],[187,5,36],[186,5,36],[185,4,36],[185,4,36],[184,4,37],[183,3,37],[182,3,37],[182,2,37],[181,2,37],[180,2,37],[180,1,37],[179,1,38],[178,1,38],[178,0,38],[177,0,38]],hypsometric:[[148,191,139],[148,191,139],[168,198,143],[168,198,143],[189,204,150],[189,204,150],[209,215,171],[209,215,171],[225,228,181],[225,228,181],[239,235,192],[239,235,192],[232,225,182],[232,225,182],[222,214,163],[222,214,163],[211,202,157],[211,202,157],[202,185,130],[202,185,130],[195,167,107],[195,167,107],[192,154,83],[192,154,83],[184,146,71],[184,146,71],[175,140,71],[175,140,71],[168,136,71],[168,136,71],[159,128,72],[159,128,72]]};function Ao(){const t=[];this.getColors=function(e){var i=t[e];if(void 0===i){const n=Lo[e];void 0===n&&console.error("unknown colour scale requested "+e),i=function(t){const e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i];e[i]=new $t(n[0]/255,n[1]/255,n[2]/255)}return e}(n),t[e]=i}return i}}function Ro(){const t=[];this.getTexture=function(e){var i=t[e];if(void 0===i){if("disc"===e)i=(new Ks).load("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg id='a' width='32mm' height='32mm' version='1.1' viewBox='0 0 32 32' xmlns='http://www.w3.org/2000/svg' %3E%3Ccircle id='d' cx='16' cy='16' r='14' color='%23000000' fill='%23fff' fill-rule='evenodd' stroke-width='0'/%3E%3C/svg%3E%0A");else if("disc-outlined"===e)i=(new Ks).load("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg id='a' width='32mm' height='32mm' version='1.1' viewBox='0 0 32 32' xmlns='http://www.w3.org/2000/svg' %3E%3Ccircle id='d' cx='16' cy='16' r='14' color='%23000000' fill='%23fff' fill-rule='evenodd' stroke-width='1' stroke='%23000'/%3E%3C/svg%3E%0A");else{const t=Lo[e];void 0===t&&console.error("unknown colour scale requested "+e),i=function(t){const e=t.length,i=new Uint8Array(3*e);var n=0;for(let r=e;r;){const e=t[--r];i[n++]=e[0],i[n++]=e[1],i[n++]=e[2]}const r=new ks(i,e,1,R,w);return r.minFilter=b,r.magFilter=b,r.needsUpdate=!0,r}(t)}t[e]=i}return i}}function Po(t){const e=512,i=document.createElement("canvas"),n=" ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789%,.-_/()[]'\"",r=n.length;if(this.cellScale=.0625,this.cellSize=32,this.glyphCount=r,this.divisions=16,this.map={},r>256)return void console.error("too many glyphs for atlas");i||console.error("creating canvas for glyph atlas failed"),i.width=e,i.height=e;const s=i.getContext("2d");s||console.error("cannot obtain 2D canvas"),s.fillStyle=t.background||"rgba( 0, 0, 0, 0 )",s.fillRect(0,0,e,e),s.textAlign="left",s.font="28px "+t.font,s.fillStyle=t.color||"#ffffff",this.ctx=s;for(var a=0;a<r;a++)this.addGlyphToCanvas(n.charAt(a),a);this.texture=new Gs(i),this.texture.minFilter=b,this.generateMipmaps=!1}function Do(){const t=[];this.getAtlas=function(e){const i=JSON.stringify(e);var n=t[i];return void 0===n&&(n=new Po(e),t[i]=n),n}}function No(t){const e=new Map,i=t.ctx,n=this;var r=new Do,s=new Set,a={},o=0;const l=new Ao,h=new Ro;this.colourCache=l,this.textureCache=h;const c=i.cfg.value("saturatedGradient",!1)||i.cfg.themeValue("saturatedGradient")?"gradientHi":"gradientLow",u=i.cfg.themeValue("shading.single");this.commonUniforms={fogColor:{value:i.cfg.themeColor("background")},fogDensity:{value:.0025},fogEnabled:{value:0},distanceTransparency:{value:0}},this.commonDepthUniforms={datumShift:{value:0}},this.commonTerrainUniforms={scale:{value:0},accuracy:{value:0},target:{value:new Q},ringColor:{value:new $t(16711680)}},this.terrainOpacity=.5,Object.defineProperty(this,"cursorHeight",{get:function(){return o},set:function(t){s.forEach((e=>o=e.setCursor(t)))}});const d=this.commonUniforms.distanceTransparency;function p(t,i,n){var r=e.get("name");return void 0===r&&(r=function(t,i,n){return e.set(t,i),n&&(i.stencilWrite=!0,i.stencilZPass=B),i}(t,i(),n)),r}function f(t,e,i){const n=p(t,e,i);return a[t]=n,n}function m(t){n.commonDepthUniforms.datumShift.value=t.value}Object.defineProperty(this,"distanceTransparency",{get:function(){return d.value},set:function(t){d.value=t}}),this.getLine2Material=function(t="",e=!1){const n=f("line2-"+t+e?"-":"",(function(){return new Wa(i,t,e)}),!0);return"cursor"!=t&&"depth-cursor"!=t||s.add(n),n},this.getHeightMaterial=function(t){return f("height"+t,(function(){return new So(i,t)}),!0)},this.getHypsometricMaterial=function(){return f("hypsometric",(function(){return new To(i)}))},this.getDepthMapMaterial=function(t){return new _o(t)},this.getDepthMaterial=function(t){return f("depth"+t,(function(){return new yo(i,t)}),!0)},this.getCursorMaterial=function(t){const e=f("cursor"+t,(function(){return new uo(i,t)}),!0);return s.add(e),e},this.getDepthCursorMaterial=function(t){const e=f("depthCursor"+t,(function(){return new xo(i,t)}),!0);return s.add(e),e},this.getBezelMaterial=function(){return p("bezel","flat"===i.cfg.themeValue("hud.bezelType")?function(){return new ai({color:i.cfg.themeValue("hud.bezel")})}:function(){return new Xs({color:i.cfg.themeValue("hud.bezel"),specular:8947848})},!0)},this.getPlainMaterial=function(){return p("plain",(function(){return new ai({color:16777215,vertexColors:!0})}),!0)},this.getSurfaceMaterial=function(){return p("surface",(function(){return new js({color:u,vertexColors:!1})}),!0)},this.getLineMaterial=function(){return p("line",(function(){return new Ss({color:16777215,vertexColors:!0})}),!0)},this.getExtendedPointsMaterial=function(){return p("extendedPoints",(function(){return new Mo(i)}),!0)},this.getMissingMaterial=function(){return p("missing",(function(){return new Co(i)}))},this.getUnselectedMaterial=function(){return p("unselected",(function(){return new Ss({color:4473924,vertexColors:!0})}))},this.getUnselectedWallMaterial=function(){return p("unselectedWall",(function(){return new js({color:4473924,vertexColors:!0})}))},this.getScaleMaterial=function(){return p("scale",(function(){return new ai({color:16777215,map:h.getTexture(c)})}))},this.getContourMaterial=function(){return f("contour",(function(){return new vo(i)}))},this.getGlyphMaterial=function(e,n){const s=r.getAtlas(e);return p(JSON.stringify(e)+":"+n.toString(),(function(){return new bo(i,s,n,t)}))},this.getClusterMaterial=function(t){return p("cluster"+t,(function(){return new po(t)}),!0)},this.setTerrain=function(t){t.addEventListener("datumShiftChange",m)},this.flushCache=function(){var t;for(t in s.clear(),a){a[t].dispose(),e.delete(t)}a={},i.glyphStringCache=new Map,o=0},this.setFog=function(t){n.commonUniforms.fogEnabled.value=t?1:0}}function Io(t,e,i){this.colorMatrixLeft=(new $).fromArray([1.0671679973602295,-.0016435992438346148,.0001777536963345483,-.028107794001698494,-.00019593400065787137,-.0002875397040043026,-.04279090091586113,15809757314855233e-21,-.00024287120322696865]),this.colorMatrixRight=(new $).fromArray([-.0355340838432312,-.06440307199954987,.018319187685847282,-.10269022732973099,.8079727292060852,-.04835830628871918,.0001224992738571018,-.009558862075209618,.567823588848114]);var n=new Gi(-1,1,1,-1,0,1),r=new bs,s=new ha;s.cameraL.layers.mask=4294967295,s.cameraR.layers.mask=4294967295;var a={minFilter:b,magFilter:M,format:P};void 0===e&&(e=512),void 0===i&&(i=512);var o=t.getPixelRatio(),l=new st(e*o,i*o,a),h=new st(e*o,i*o,a),c=new ke({uniforms:{mapLeft:{value:l.texture},mapRight:{value:h.texture},colorMatrixLeft:{value:this.colorMatrixLeft},colorMatrixRight:{value:this.colorMatrixRight}},vertexShader:Ga.anaglyphVertexShader,fragmentShader:Ga.anaglyphFragmentShader}),u=new wi(new Ie(2,2),c);r.add(u),this.setLayers=function(t){s.cameraL.layers.mask=t,s.cameraR.layers.mask=t},this.setSize=function(e,i){t.setSize(e,i);var n=t.getPixelRatio();l.setSize(e*n,i*n),h.setSize(e*n,i*n)},this.setEyeSeparation=function(t){s.eyeSep=t},this.render=function(e,i){e.updateMatrixWorld(),null===i.parent&&i.updateMatrixWorld(),s.update(i),t.setRenderTarget(l),t.clear(),t.render(e,s.cameraL),t.setRenderTarget(h),t.clear(),t.render(e,s.cameraR),t.setRenderTarget(null),t.render(r,n)},this.dispose=function(){l&&l.dispose(),h&&h.dispose(),c&&c.dispose(),u&&u.geometry.dispose()}}function Fo(t,e,i){const n=t.container;var r=n.clientWidth,s=n.clientHeight,a=n.getBoundingClientRect();const o=new Gi(-r/2,r/2,s/2,-s/2,1,4e3),l=new Fi(t.cfg.themeValue("fieldOfView"),r/s,1,16e3),h=new Q,c=this;i.add(l),i.add(o),v(l),v(o),this.activeCamera=l,this.mode=2;const u=new ai({side:1,colorWrite:!1});var d,p=.5,f=0;t.viewer.addEventListener("resized",(function(t){r=t.width,s=t.height,a=n.getBoundingClientRect(),o.zoom*=r/(o.right-o.left),o.left=-r/2,o.right=r/2,o.top=s/2,o.bottom=-s/2,o.updateProjectionMatrix(),l.aspect=r/s,l.updateProjectionMatrix(),null!==c.activeEffect&&c.activeEffect.setSize(r,s)}));const m=function(){e.render(i,c.activeCamera),e.getContext().flush(),f=e.info.render.frame},g=function(){const t=c.activeCamera;c.testCameraLayer(7)&&(t.layers.mask=129,i.overrideMaterial=u,e.render(i,t),i.overrideMaterial=null,t.layers.mask=d),e.render(i,t),e.getContext().flush(),f=e.info.render.frame};function v(t){t.zoom=1,t.layers.set(0),t.layers.enable(1),t.layers.enable(5)}this.maskedTerrain=!0,this.activeRenderer=g,this.activeEffect=null,this.resetCameras=function(){v(l),v(o)},this.setCameraLayer=function(t,e){e?(l.layers.enable(t),o.layers.enable(t)):(l.layers.disable(t),o.layers.disable(t)),d=this.activeCamera.layers.mask,null!==this.activeEffect&&this.activeEffect.setLayers(d)},this.testCameraLayer=function(t){return(d&1<<t)>0},this.setCamera=function(t,n){if(this.mode===t)return;var a,h=this.activeCamera;const u=h.position.clone().sub(n);null!==this.activeEffect&&this.activeEffect.dispose();var d=null;switch(t){case 3:if(d=new Io(e,r,s),h.isPerspective)break;case 2:a=4*s*Math.tan(V*l.fov/2)/o.zoom/2,u.setLength(a),h=l;break;case 1:a=u.length(),o.zoom=2*s*Math.tan(V*l.fov/2)/a,h=o;break;default:return void console.warn("unknown camera mode",t)}null!==d?(d.setLayers(h.layers.mask),this.activeRenderer=function(){d.render(i,c.activeCamera)}):this.maskedTerrain?this.activeRenderer=g:this.activeRenderer=m,h.position.copy(u.add(n)),h.updateProjectionMatrix(),h.lookAt(n),this.activeCamera=h,this.activeEffect=d,this.mode=t},this.getLastFrame=function(){return f},this.getMouse=function(t,e){return h.set((t-a.left)/n.clientWidth*2-1,-(e-a.top)/n.clientHeight*2+1),h},Object.defineProperties(this,{eyeSeparation:{get:function(){return p},set:function(t){p=t,null!==this.activeEffect&&this.activeEffect.setEyeSeparation(.064+.06*(t-.5))}},focalLength:{get:function(){return l.getFocalLength()},set:function(t){l.setFocalLength(t)}}})}function Oo(t,e){const i=t.cfg,n=new ot,r=new ot,s=new sa(16777215),a=new aa(16777215,.3),o=i.themeAngle("lighting.inclination"),l=i.themeAngle("lighting.azimuth")-Math.PI/2;n.setFromSpherical(new xa(1,o,l)),n.applyAxisAngle(new ot(1,0,0),Math.PI/2),r.copy(n),s.position.copy(n),e.addStatic(s),e.addStatic(a),this.setRotation=function(t){r.copy(n),r.applyAxisAngle(Se.DefaultUp,t.z),s.position.copy(r),s.updateMatrix()},Object.defineProperty(this,"directionalLighting",{get:function(){return s.visible},set:function(t){s.visible=t,a.intensity=t?.3:1}})}Po.prototype.addGlyphToCanvas=function(t,e){const i=this.divisions,n=this.ctx,r=this.cellSize,s=n.measureText(t).width/r,a=Math.floor(e/i)+1,o=e%i,l={row:(i-a)/i,column:o/i,width:s};return this.map[t]=l,n.fillText(t,r*o,r*a-7),l},Po.prototype.getTexture=function(){return this.texture},Po.prototype.getGlyph=function(t){var e=this.map[t];if(void 0===e){if(this.glyphCount+1>this.divisions*this.divisions)return void console.warn("too many glyphs for atlas when adding ["+t+"]");e=this.addGlyphToCanvas(t,this.glyphCount++),this.texture.needsUpdate=!0}return e};const zo=new ot,Uo=new zt,Bo=new le;function ko(t,e){this.controls=t,this.renderFunction=e,this.endCameraPosition=new ot,this.endPOI=new ot,this.endZoom=1,this.endQuaternion=new at,this.frameCount=0,this.skipNext=!1,this.rotation=0,this.delta=0,this.running=!1,this.animationFunction=null,this.rafID=0,this.doAnimate=this.animate.bind(this)}function Go(t,e){return void 0===t?"file set":t.split(".").shift()+"."+e}function Ho(t){return"data:text/json;charset=utf8,"+encodeURIComponent(JSON.stringify(t,null,"\t"))}ko.fitBox=function(t,e,i){const n=e.getSize(zo);var r,s,a,o=600,l=1;if(void 0===i||0!==i.z?(r=n.x,s=n.y,a=n.z):0!==i.x?(r=n.y,s=n.z,a=n.x):(r=n.x,s=n.z,a=n.y),t.isPerspectiveCamera){const e=2*Math.tan(.5*V*t.getEffectiveFOV()),i=s/e,n=1/t.aspect*r/e;0===(o=1.1*Math.max(i,n)+a/2)&&(o=100)}else{const e=(t.right-t.left)/r,i=(t.top-t.bottom)/s;l=1*Math.min(e,i)/1.1}return{zoom:l,elevation:o}},ko.prototype.getCardinalAxis=function(t){this.controls.cameraManager.activeCamera.getWorldDirection(zo);const e=Math.abs(zo.x),i=Math.abs(zo.y),n=Math.abs(zo.z);e>i&&e>n?t.set(Math.sign(zo.x),0,0):i>n?t.set(0,Math.sign(zo.y),0):t.set(0,0,Math.sign(zo.z))},ko.prototype.prepareRotation=function(t,e){const i=this.controls.cameraManager.activeCamera;zo.copy(t).sub(this.endPOI).normalize();const n=zo.dot(Se.DefaultUp);Math.abs(n)>.99999&&void 0!==e&&t.add(e.multiplyScalar(.02*zo.z)),Uo.lookAt(t,this.endPOI,Se.DefaultUp),this.endQuaternion.setFromRotationMatrix(Uo).normalize(),this.rotation=Math.round(2*Math.acos(Math.abs(X(this.endQuaternion.dot(i.quaternion),-1,1)))*W)},ko.prototype.prepare=function(){const t=new ot,e=new ot;return function(i,n){if(this.running)return this;const r=this.controls.cameraManager.activeCamera,s=this.endPOI,a=r.position,o=this.endCameraPosition;if(this.skipNext=!1,void 0===n){if(this.getCardinalAxis(t),0!==t.z){Bo.setFromQuaternion(r.quaternion);switch(Math.round(2*(Bo.z+Math.PI)/Math.PI)){case 0:case 4:e.set(0,1,0);break;case 1:e.set(-1,0,0);break;case 2:e.set(0,-1,0);break;case 3:e.set(1,0,0);break;default:e.set(0,-1,0)}}}else t.copy(n),e.set(0,-1,0);const l=ko.fitBox(r,i,t);i.getCenter(s),this.endZoom=l.zoom,o.copy(s).add(t.negate().multiplyScalar(l.elevation));const h=a.distanceTo(o);return this.prepareRotation(o,e),h<.1*o.z?this.skipNext=0===this.rotation:this.rotation=0,this.animationFunction=this.animateMove,this}}(),ko.prototype.preparePoint=function(t){if(this.running)return this;const e=this.controls.cameraManager.activeCamera;return this.endPOI.copy(t),this.endCameraPosition.copy(e.position),this.prepareRotation(e.position),this.skipNext=0===this.rotation,this.animationFunction=this.animateMove,this},ko.prototype.prepareSimpleMove=function(t){return this.running||(this.endCameraPosition.copy(t),this.animationFunction=this.animateSimpleMove,this.skipNext=!1),this},ko.prototype.start=function(t){if(this.running||this.skipNext)return;const e=this.controls;this.frameCount=t?this.rotation>0?Math.max(1,Math.round(this.rotation/2)):30:1,e.enabled=!1,this.running=!0,this.animate()},ko.prototype.cancel=function(){0!==this.rafID&&window.cancelAnimationFrame(this.rafID),this.running&&(this.frameCount=1,this.running=!1,this.rafID=0,this.animate(),this.controls.enabled=!0,this.controls.autoRotate=!1)},ko.prototype.animate=function(){const t=this.controls;t.autoRotate?t.update():this.animationFunction&&(this.animationFunction(),0==--this.frameCount&&(this.animationFunction=null,this.endAnimation())),this.running&&(this.rafID=window.requestAnimationFrame(this.doAnimate))},ko.prototype.endAnimation=function(){const t=this.controls,e=t.cameraManager.activeCamera;t.target.copy(this.endPOI),this.rotation>0&&e.position.copy(this.endCameraPosition),this.running=!1,this.rotation=0,this.rafID=0,t.update(),t.enabled=!0,t.end()},ko.prototype.animateMove=function(){const t=this.controls.cameraManager.activeCamera,e=this.controls.target,i=1-(this.frameCount-1)/this.frameCount;this.rotation||(t.position.lerp(this.endCameraPosition,i),t.zoom=t.zoom+(this.endZoom-t.zoom)*i,t.isOrthographicCamera&&t.updateProjectionMatrix(),t.lookAt(e.lerp(this.endPOI,i))),t.quaternion.slerp(this.endQuaternion,i),this.renderFunction()},ko.prototype.animateSimpleMove=function(){const t=this.controls.cameraManager.activeCamera,e=1-(this.frameCount-1)/this.frameCount;t.position.lerp(this.endCameraPosition,e),this.renderFunction()},ko.prototype.setAngleCommon=function(t){this.frameCount=Math.max(1,Math.round(90*Math.abs(t)/Math.PI)),this.delta=t/this.frameCount,this.running=!0,this.animate()},ko.prototype.setAzimuthAngle=function(t){const e=this.controls;if(this.running||e.autoRotate)return this;var i=e.getAzimuthalAngle()-t,n=Math.abs(i);n>Math.PI&&(i=2*Math.PI-n),this.animationFunction=this.animateAzimuthMove,this.setAngleCommon(i)},ko.prototype.animateAzimuthMove=function(){this.controls.rotateLeft(this.delta)},ko.prototype.setPolarAngle=function(t){if(this.running)return this;this.animationFunction=this.animatePolarMove,this.setAngleCommon(this.controls.getPolarAngle()-t)},ko.prototype.animatePolarMove=function(){this.controls.rotateUp(this.delta)},ko.prototype.setAutoRotate=function(t){const e=this.controls;if(t){if(this.running)return;e.autoRotate=!0,this.running=!0,this.animationFunction=!1,this.animate()}else e.autoRotate&&(this.running=!1),e.autoRotate=!1,e.enabled=!0,this.rafID=0};class Vo extends ot{constructor(t,e,i){super(t,e,i)}}function Wo(t){this.fileName=t,this.groups=[],this.section=null}var jo;if(Vo.scaleFactor=1,Vo.prototype.connections=0,Vo.prototype.splays=0,Vo.prototype.correctedDistanceTo=function(t){return Math.sqrt(this.correctedDistanceToSquared(t))},Vo.prototype.correctedDistanceToSquared=function(t){var e=this.x-t.x,i=this.y-t.y,n=(this.z-t.z)*Vo.scaleFactor;return e*e+i*i+n*n},Wo.prototype.constructor=Wo,Wo.prototype.type="arraybuffer",Wo.prototype.parse=function(t,e,i,n){t.metadata=i,this.section=n,this.groups=[],this.cave=t,this.stationMap=new Map,this.dataStream=e;var r=0;o(),this.version=o();const s=l();o();var a=void 0===s[1]?null:s[1];return console.log("Survex .3d version ",this.version),this.pos=r,t.setCRS(a).then(this.parse2.bind(this));function o(){return l()[0]}function l(){const t=new Uint8Array(e,0),i=[];var n,s=[];do{10===(n=t[r++])||0===n?(i.push(String.fromCharCode.apply(null,s).trim()),s=[]):s.push(n)}while(10!=n);return i}},Wo.prototype.parse2=function(){const t=this.cave;var e=this.pos;switch(this.version){case"Bv0.01":this.handleOld(this.dataStream,e,1);break;case"v3":case"v4":case"v5":case"v6":case"v7":case"v8":this.handleVx(this.dataStream,e,Number(this.version.charAt(1)),this.section);break;default:throw new Error("unsupported .3d version "+this.version)}return null!==this.section&&t.surveyTree.trim(this.section.split(".")),t.addStations(this.stationMap),t.addLineSegments(this.groups),t},Wo.prototype.handleOld=function(t,e,i){const n=this.cave,r=n.surveyTree,s=n.projection,a=n.limits,o=this.groups,l=this.stationMap,h=[],c=new Map,u=new DataView(t,0),d=new Uint8Array(t,0),p=d.length;var f,m,g,v,y="",x=[],_=new Vo;function M(t){throw new Error("unhandled command: "+t.toString(16)+" @ "+e.toString(16))}for(f=0;f<256;f++)h[f]=M;for(h[0]=b,h[-1]=b,h[1]=function(){return console.log("SKIP"),!1},h[2]=S,h[3]=S,h[4]=function(){const t=T();if(_=t,1===i&&2===u.getInt32(e,!0))return!0;x.length>1&&o.push(x);return(x=[]).push({coords:t}),!0},h[5]=function(){const t=T();return x.push({coords:t,type:1,survey:0}),_.connections++,t.connections++,_=t,!0},h[6]=function(){return console.log("LABEL_V2"),!1},h[7]=function(){return console.log("LABEL_V3"),!1},f=64;f<128;f++)h[f]=w;for(f=128;f<256;f++)h[f]=E;if(1===i)for(;e<p;){const t=u.getInt32(e,!0);if(e+=4,!h[t]())break}else for(alert("Unsupported version"+i);e<p&&h[d[e]](d[e++]););for(o.push(x),f=0,g=o.length;f<g;f++){const t=o[f];for(m=0,v=t.length;m<v;m++){const e=t[m],i=e.coords,n=c.get(i);void 0!==n&&(e.survey=n.parent.id)}}function b(){return!0}function S(){const t=[];for(var i=d[e++];10!==i;)t.push(i),i=d[e++];92===t[0]&&t.shift(),y=String.fromCharCode.apply(null,t);var n=r.addLeaf(y.split("."),{p:_,type:1});return c.set(_,n),!0}function w(){return console.log("LABEL_V4"),!1}function E(){return console.log("LINE_V2"),!1}function T(){const i=new DataView(t,e);var n=new Vo(i.getInt32(0,!0)/100,i.getInt32(4,!0)/100,i.getInt32(8,!0)/100);e+=12;const r=n.x+","+n.y+","+n.z,o=l.get(r);if(void 0!==o)n=o;else{if(null!==s){const t=s.forward({x:n.x,y:n.y});n.x=t.x,n.y=t.y}a.expandByPoint(n),l.set(r,n)}return n}},Wo.prototype.handleVx=function(t,e,i,n){const r=this.cave,s=r.surveyTree,a=r.messages,o=r.projection,l=r.limits,c=this.groups,u=[],d=this.stationMap,p=[],f=new Map,m=new Uint8Array(t,0),g=new DataView(t,0),v=m.length;var y,x,_,M=[],b="",S=[],w=0,E=!1,T=new Vo,C=null,L=null,A=!1,R=null===n,P=!1;function D(t){throw new Error("unhandled command: "+t.toString(16)+" @ "+e.toString(16))}for(y=0;y<256;y++)p[y]=D;if(8===i){for(p[0]=O,p[1]=O,p[2]=O,p[3]=O,p[4]=O,p[15]=B,p[16]=z,p[17]=function(){return e+=2,!0},p[18]=function(){return e+=3,!0},p[19]=function(){return e+=4,!0},p[31]=k,p[48]=H,p[49]=H,p[50]=V,p[51]=V,y=64;y<128;y++)p[y]=U;for(y=128;y<256;y++)p[y]=G;_=function(t){if(32&t)return!1;var i=m[e++],r=0,s=0;0!==i?(s=i>>4,r=15&i):(255!==(i=m[e++])?s=i:(s=g.getUint32(e,!0),e+=4),255!==(i=m[e++])?r=i:(r=g.getUint32(e,!0),e+=4));if(0===r&&0===s)return;s&&(b=b.slice(0,-s));r&&(b+=String.fromCharCode.apply(null,m.subarray(e,e+=r)));A=!0,null!==n&&(R=b.startsWith(n));return},e++}else{for(y=1;y<15;y++)p[y]=I;for(p[15]=B,y=16;y<32;y++)p[y]=F;for(p[0]=function(){b&&(b="");return!0},p[32]=function(){return e+=2,!0},p[33]=function(){return e+=3,!0},p[35]=function(){return e+=4,!0},p[36]=z,p[34]=k,p[48]=H,p[49]=H,p[50]=V,p[51]=V,y=64;y<128;y++)p[y]=G;for(y=128;y<192;y++)p[y]=U;_=function(){var t=0;switch(m[e]){case 254:t=g.getUint16(e,!0)+m[e],e+=2;break;case 255:t=g.getUint32(e,!0),e+=4;break;default:t=m[e++]}if(0===t)return;b+=String.fromCharCode.apply(null,m.subarray(e,e+=t)),A=!0,null!==n&&(R=b.startsWith(n));return}}for(i>=4&&i<=6&&(p[32]=function(){return e+=4,!0},p[33]=function(){return e+=8,!0});e<v&&p[m[e]](m[e++]););S.length>1&&u.push(S);const N=r.xGroups;return u.forEach((t=>{t.length>1&&N.push(t)})),d.forEach((t=>l.expandByPoint(t))),void c.push(M);function I(t){"."===(b=b.slice(0,-16)).charAt(b.length-1)&&(b=b.slice(0,-1));const e=b.split(".");return e.splice(-t),(b=e.join("."))&&(b+="."),A=!0,!0}function F(t){const e=t-15;return b=b.slice(0,-e),A=!0,!0}function O(){return!0}function z(){return!0}function U(t){const i=63&t;if(_(i),A&&""!==b&&(w=s.addPath(b).id,A=!1),R){E&&(M.push({coords:T}),E=!1);const t=j();if(t===T)return!0;0==(7&i)?(T.connections++,t.connections++,M.push({coords:t,type:1,survey:w})):4&i?(T.splays++,M.push({coords:t,type:2,survey:w}),t.splays=-1):1&i?M.push({coords:t,type:3,survey:w}):2&i&&M.push({coords:t,type:h,survey:w}),T=t}else E&&(X(),E=!1),e+=12;return!0}function B(){return M.length>1&&c.push(M),M=[],!R&&E&&X(),T=j(),E=!0,!0}function k(){return e+=20,!0}function G(t){const i=127&t;if(_(0),!(14&i)||32&i||!R)return e+=12,!0;const n=j();var r=b.split(".");return f.set(b,s.addLeaf(r,4&i?2:1,n)),!0}function H(i){const n=1&i;_(n);const r=new DataView(t,e);return e+=8,W(n,{l:r.getInt16(0,!0)/100,r:r.getInt16(2,!0)/100,u:r.getInt16(4,!0)/100,d:r.getInt16(6,!0)/100})}function V(i){const n=1&i;_(n);const r=new DataView(t,e);return e+=16,W(n,{l:r.getInt32(0,!0)/100,r:r.getInt32(0,!0)/100,u:r.getInt32(0,!0)/100,d:r.getInt32(0,!0)/100})}function W(t,e){if(null!==n&&!b.startsWith(n))return!0;const i=f.get(b);if(!i)return!0;const r=i.p,s=i.parent.id;S.push({start:L,end:r,lrud:e,survey:s,type:2}),i.type=4|i.type;var o=!1;return t?o=!0:1===r.connections&&S.length>1&&0==!T.connections?(x={station:i,text:"LRUD fault"},0===r.splays?(o=!0,a.push(x)):P=!0):P&&0!==r.connections&&(a.push(x),P=!1),o?(S.length>0&&u.push(S),L=null,S=[],P=!1):L=r,!0}function j(){const i=new DataView(t,e);C=String.fromCharCode.apply(null,m.subarray(e,e+12));var n=new Vo(i.getInt32(0,!0)/100,i.getInt32(4,!0)/100,i.getInt32(8,!0)/100);e+=12;const r=d.get(C);if(void 0!==r)n=r;else{if(null!==o){const t=o.forward({x:n.x,y:n.y});n.x=t.x,n.y=t.y}d.set(C,n)}return n}function X(){T.connections||d.delete(C)}},Wo.prototype.getLineSegments=function(){const t=[],e=this.groups;for(var i=0,n=e.length;i<n;i++){const n=e[i];for(var r=0,s=n.length-1;r<s;r++){const e=n[r],i=n[r+1],s=e.coords,a=i.coords;t.push({from:s,to:a,type:i.type,survey:i.survey})}}return t},Wo.prototype.getTerrainDimensions=function(){return{lines:0,samples:0}},Wo.prototype.getTerrainBitmap=function(){return!1},void 0===(jo=self||window).TextDecoder){var Xo=function(){};Xo.prototype.decode=function(t){const e=t.length;for(var i="",n=0;n<e;n++)i+="%"+t[n].toString(16);return decodeURIComponent(i)},jo.TextDecoder=Xo}var qo=0;function Yo(t){this.fileName=t}Yo.prototype.constructor=Yo,Yo.prototype.type="arraybuffer",Yo.prototype.parse=function(t,e,i,n){qo+=1e5,t.metadata=i,t.setCRS(null);const r=t.lineSegments,s=t.surveyTree,a=t.limits,o=t.projection,l=[],c={},u=null!==o,d=new TextDecoder("utf-8");var p=e;const f=p.byteLength,m=qo,g=[];for(var v,y,x,_=0,M=new DataView(p,0),b=0;_<f;)S();return p=null,t.addStations(g),t.addXsects(l),Promise.resolve(t);function S(){const t=w(),e=w(),i=w(),n=w();let r;switch(v=_+e,t){case 1:r=L;break;case 2:r=A;break;case 3:r=R;break;case 4:r=N;break;case 5:r=I;break;case 6:r=O;break;default:throw new Error("unknown chunk header. type : ",t)}for(var s=0;s<i;s++)r();_+=n}function w(){const t=M.getUint32(_,!0);return _+=4,t}function E(){const t=M.getFloat64(_,!0);return _+=8,t}function T(){return{position:w(),size:w()}}function C(t){const e=new Uint8Array(p,v+t.position,t.size-1);return d.decode(e)}function L(){const t=w(),e=T(),i=w(),r=T();if(y!==i&&(x=s.findById(void 0===y?0:i+m),y=i,void 0===x&&(x=s)),i!=t){const i=x.addById(C(e),t+m);if(null===i)throw new Error("error constructing survey tree for",C(r));null!==n&&i.getPath()===n&&(b=t)}}function A(){const t=w(),e=w(),i=T(),n=T(),r=w(),l=function(){const t=new Vo(E(),E(),E());if(null!==o){const e=o.forward({x:t.x,y:t.y});t.x=e.x,t.y=e.y}return a.expandByPoint(t),t}();g[t]=l,y!==e&&(x=s.findById(e+m),y=e);const h=0===i.size?"["+t+"]":C(i),c=n.size>0?C(n):null;x.addLeafById(h,-(t+m),2&r?2:1,l,c)}function R(){const t=w(),e=w();let i,n,a,o;e>t?(i=t,n=e,a=P(),o=P()):(i=e,n=t,o=D(),a=D());const c=w(),u=w(),d=w();if(_+=8,0!==b&&d!==b)return;let p;if(0==c)p=1;else if(8&c||22&c)p=2;else if(1&c)p=3;else{if(!(2&c))return void console.log("unexpected flags"+c);p=h}const f=g[i],v=g[n],y=d+m;if(0!==u&&1===p){const t=s.findById(-n-m);t.type=4|t.type,l.push({m_from:i,m_to:n,start:f,end:v,fromLRUD:a,lrud:o,survey:y,type:u})}f.equals(v)||(1===p&&(f.connections++,v.connections++),r.push({from:f,to:v,type:p,survey:y}))}function P(){return{l:E(),r:E(),u:E(),d:E()}}function D(){return{r:E(),l:E(),u:E(),d:E()}}function N(){w();const e=w(),i=w(),n=T(),r=w(),s=T(),a={vertices:[],faces:[],survey:e+m};let o,l,h;if(0===b||e===b){for(l=0;l<i;l++){const t=v+n.position+24*l,e=new DataView(p,t);a.vertices.push(new ot(e.getFloat64(0,!0),e.getFloat64(8,!0),e.getFloat64(16,!0)))}for(l=0;l<r;l++){const t=v+s.position+12*l,e=new DataView(p,t),i=[e.getUint32(0,!0),e.getUint32(4,!0),e.getUint32(8,!0)];t:if(void 0!==o){for(h=0;h<3;h++)if(i[h]==o[(h+2)%3]&&i[(h+1)%3]==o[(h+3)%3]){i.reverse();break t}for(h=0;h<3;h++)if(i[h]==o[h]&&i[(h+1)%3]==o[(h+1)%3]){i.reverse();break t}for(h=0;h<3;h++)if(i[h]==o[(h+1)%3]&&i[(h+1)%3]==o[(h+2)%3]){i.reverse();break t}}a.faces.push(i),o=i}t.scraps.push(a)}}function I(){w();const e=w(),i=w(),n=T(),r=F();if(u)return;const s=p.slice(_,_+n.size),a=new Float64Array(s,0);c.dtm={data:a,samples:e,lines:i,calib:r},t.terrains.push(c),t.hasTerrain=!0}function F(){return{xOrigin:E(),yOrigin:E(),xx:E(),xy:E(),yx:E(),yy:E()}}function O(){w(),w();const t=T(),e=F();u||(c.bitmap={image:z(t),calib:e})}function z(t){const e=new Uint8Array(p,v+t.position,t.size),i=e[0],n=e[1];let r;if(255===i&&216===n)r="image/jpeg";else{if(137!==i||80!==n)return"";r="image/png"}const s=new Blob([e],{type:r});return URL.createObjectURL(s)}};const Zo=12*.0254;function Jo(t){this.fileName=t}function Ko(t,e,i,n){void 0===i?(this.id=0,this.maxId=0,this.root=this,this.parent=null,this.pathCache=[]):(this.root=i,this.parent=n,this.id=null===e?++i.maxId:e,n.children.push(this)),this.name=t||"",this.children=[],this.type=0}Jo.prototype.constructor=Jo,Jo.prototype.type="text",Jo.prototype.parse=function(t,e,i){t.metadata=i,t.setCRS(null);const n=t.surveyTree,r=t.limits,s=t.projection,a=new Map,o=[],l=[],h=[],c=e.split(/[\n\r]+/),u=c.length;var d,p,f,m,g,v,y=[],x=[],_=0,M=-1,b="root";for(m=0;m<u;m++){const t=c[m].split(/\s+/),e=t[0].charAt(0);switch(e){case"M":x.length>1&&h.push(x),x=[],M=-1;case"D":if(d=t[4].substring(1),y[2]=d,g=(v=w(t)).stationIndex,x.push({coords:v,type:1,survey:_}),0===v.connections){const e=void 0===t[13]?null:t.slice(13).join(" ");n.addLeaf(y,1,v,e)}if(v.connections++,"P"===t[5]){let e=+t[6],i=+t[7],n=+t[8],r=+t[9],s=0;if(e<0&&(e=0,s++),i<0&&(i=0,s++),n<0&&(n=0,s++),r<0&&(r=0,s++),4!==s){f={l:e*Zo,u:i*Zo,d:n*Zo,r:r*Zo};var S=-1!==M?l[M]:null;o.push({m_from:M,m_to:g,start:S,end:v,lrud:f,survey:_,type:2})}M=g}break;case"N":y=[b,p=t[0].substring(1)],_=n.addPath(b+"."+p).id;break;case"Z":break;case"F":case"L":case"X":case"O":case"G":case"P":case"R":case"C":case"":break;case"S":b=c[m].substring(1);break;default:console.log("unknown command ",e)}}return x.length>1&&h.push(x),t.addStations(l),t.addLineSegments(h),t.addXsects(o),Promise.resolve(t);function w(t){const e=t[1]+":"+t[2]+":"+t[3],i=a.get(e);var n;if(void 0!==i)n=i;else{if(n=new Vo(+t[2]*Zo,+t[1]*Zo,+t[3]*Zo),null!==s){const t=s.forward({x:n.x,y:n.y});n.x=t.x,n.y=t.y}n.stationIndex=l.length,l.push(n),a.set(e,n),r.expandByPoint(n)}return n}},Ko.prototype.sorted=!1,Ko.prototype.p=null,Ko.prototype.traverse=function(t){const e=this.children;t(this);for(var i=0;i<e.length;i++)e[i].traverse(t)},Ko.prototype.traverseDepthFirst=function(t){const e=this.children;for(var i=0;i<e.length;i++)e[i].traverseDepthFirst(t);t(this)},Ko.prototype.forEachChild=function(t){this.children.forEach((e=>t(e)))},Ko.prototype.addById=function(t,e,i){const n=this.root,r=new Ko(t,e,n,this);return void 0!==i&&Object.assign(r,i),n.maxId=Math.max(n.maxId,e),r},Ko.prototype.addLeafById=function(t,e,i,n,r){const s=this.root,a=new Ko(t,e,s,this);return a.type=i,a.p=n,r&&(a.comments=r),s.maxId=Math.max(s.maxId,e),a},Ko.prototype.findById=function(t){if(this.id==t)return this;for(var e=0,i=this.children.length;e<i;e++){const i=this.children[e].findById(t);if(i)return i}},Ko.prototype.getByPath=function(t){if(!t)return;const e=t.split(".");let i,n=this.getByPathArray(e);if(0!==e.length){const e=t.split(".");if(e.length-2<0)return;var r=e.slice(0,e.length-2),s=e.slice(e.length-2,e.length).join(".");n=this.getByPathArray(i=r.concat(s))}return 0===e.length||0===i.length?n:void 0},Ko.prototype.getByPathArray=function(t){for(var e=this.root,i=!0;i&&t.length>0;){i=!1;for(var n=0,r=e.children.length;n<r;n++){const r=e.children[n];if(r.name===t[0]){e=r,t.shift(),i=!0;break}}}return e},Ko.prototype.addLeaf=function(t,e,i,n){if(1===t.length){const r=new Ko(t[0],null,this.root,this);return r.type=e,r.p=i,n&&(r.comments=n),r}for(var r,s=[];void 0===r&&t.length>1;)s.unshift(t.pop()),r=this.root.pathCache[t.join(".")];if(void 0!==r){const t=new Ko(s.join("."),null,this.root,r);return t.type=e,t.p=i,n&&(t.comments=n),t}if(t=t.concat(s),r=this.getByPathArray(t),0===t.length)return r;for(;t.length>0;){r=new Ko(t.shift(),null,this.root,r)}return r.type=e,r.p=i,n&&(r.comments=n),r},Ko.prototype.addPath=function(t){var e=t.split("."),i=this.getByPathArray(e);if(0===e.length)return i;for(;e.length>0;){const t=new Ko(e.shift(),null,this.root,i);this.root.pathCache[t.getPath()]=t,i=t}return i},Ko.prototype.getPath=function(t){const e=[];var i=this;void 0===t&&(t=this.root);do{e.push(i.name),i=i.parent}while(i!==t&&null!==i);return e.reverse().join(".")},Ko.prototype.getSubtreeIds=function(t){return this.traverse((function(e){t.add(e.id)})),t},Ko.prototype.getIdByPath=function(t){return this.getIdByPathArray(t.split("."))},Ko.prototype.getIdByPathArray=function(t){const e=this.getByPathArray(t);return 0===t.length?e.id:void 0},Ko.prototype.trim=function(t){const e=t.shift(),i=this.children;var n;if(void 0!==e){for(var r=0;r<i.length&&(n=i[r]).name!==e;r++);this.children=[n],n.trim(t)}},Ko.prototype.isStation=function(){return 0!==this.type};var Qo=6378137,$o=.0066943799901413165,tl=484813681109536e-20,el=Math.PI/2,il=1e-10,nl=.017453292519943295,rl=57.29577951308232,sl=Math.PI/4,al=2*Math.PI,ol=3.14159265359,ll={greenwich:0,lisbon:-9.131906111111,paris:2.337229166667,bogota:-74.080916666667,madrid:-3.687938888889,rome:12.452333333333,bern:7.439583333333,jakarta:106.807719444444,ferro:-17.666666666667,brussels:4.367975,stockholm:18.058277777778,athens:23.7163375,oslo:10.722916666667},hl={ft:{to_meter:.3048},"us-ft":{to_meter:1200/3937}},cl=/[\s_\-\/\(\)]/g;function ul(t,e){if(t[e])return t[e];for(var i,n=Object.keys(t),r=e.toLowerCase().replace(cl,""),s=-1;++s<n.length;)if((i=n[s]).toLowerCase().replace(cl,"")===r)return t[i]}function dl(t){var e,i,n,r={},s=t.split("+").map((function(t){return t.trim()})).filter((function(t){return t})).reduce((function(t,e){var i=e.split("=");return i.push(!0),t[i[0].toLowerCase()]=i[1],t}),{}),a={proj:"projName",datum:"datumCode",rf:function(t){r.rf=parseFloat(t)},lat_0:function(t){r.lat0=t*nl},lat_1:function(t){r.lat1=t*nl},lat_2:function(t){r.lat2=t*nl},lat_ts:function(t){r.lat_ts=t*nl},lon_0:function(t){r.long0=t*nl},lon_1:function(t){r.long1=t*nl},lon_2:function(t){r.long2=t*nl},alpha:function(t){r.alpha=parseFloat(t)*nl},gamma:function(t){r.rectified_grid_angle=parseFloat(t)},lonc:function(t){r.longc=t*nl},x_0:function(t){r.x0=parseFloat(t)},y_0:function(t){r.y0=parseFloat(t)},k_0:function(t){r.k0=parseFloat(t)},k:function(t){r.k0=parseFloat(t)},a:function(t){r.a=parseFloat(t)},b:function(t){r.b=parseFloat(t)},r_a:function(){r.R_A=!0},zone:function(t){r.zone=parseInt(t,10)},south:function(){r.utmSouth=!0},towgs84:function(t){r.datum_params=t.split(",").map((function(t){return parseFloat(t)}))},to_meter:function(t){r.to_meter=parseFloat(t)},units:function(t){r.units=t;var e=ul(hl,t);e&&(r.to_meter=e.to_meter)},from_greenwich:function(t){r.from_greenwich=t*nl},pm:function(t){var e=ul(ll,t);r.from_greenwich=(e||parseFloat(t))*nl},nadgrids:function(t){"@null"===t?r.datumCode="none":r.nadgrids=t},axis:function(t){var e="ewnsud";3===t.length&&-1!==e.indexOf(t.substr(0,1))&&-1!==e.indexOf(t.substr(1,1))&&-1!==e.indexOf(t.substr(2,1))&&(r.axis=t)},approx:function(){r.approx=!0}};for(e in s)i=s[e],e in a?"function"==typeof(n=a[e])?n(i):r[n]=i:r[e]=i;return"string"==typeof r.datumCode&&"WGS84"!==r.datumCode&&(r.datumCode=r.datumCode.toLowerCase()),r}var pl=/\s/,fl=/[A-Za-z]/,ml=/[A-Za-z84]/,gl=/[,\]]/,vl=/[\d\.E\-\+]/;function yl(t){if("string"!=typeof t)throw new Error("not a string");this.text=t.trim(),this.level=0,this.place=0,this.root=null,this.stack=[],this.currentObject=null,this.state=1}function xl(t,e,i){Array.isArray(e)&&(i.unshift(e),e=null);var n=e?{}:t,r=i.reduce((function(t,e){return _l(e,t),t}),n);e&&(t[e]=r)}function _l(t,e){if(Array.isArray(t)){var i=t.shift();if("PARAMETER"===i&&(i=t.shift()),1===t.length)return Array.isArray(t[0])?(e[i]={},void _l(t[0],e[i])):void(e[i]=t[0]);if(t.length)if("TOWGS84"!==i){if("AXIS"===i)return i in e||(e[i]=[]),void e[i].push(t);var n;switch(Array.isArray(i)||(e[i]={}),i){case"UNIT":case"PRIMEM":case"VERT_DATUM":return e[i]={name:t[0].toLowerCase(),convert:t[1]},void(3===t.length&&_l(t[2],e[i]));case"SPHEROID":case"ELLIPSOID":return e[i]={name:t[0],a:t[1],rf:t[2]},void(4===t.length&&_l(t[3],e[i]));case"PROJECTEDCRS":case"PROJCRS":case"GEOGCS":case"GEOCCS":case"PROJCS":case"LOCAL_CS":case"GEODCRS":case"GEODETICCRS":case"GEODETICDATUM":case"EDATUM":case"ENGINEERINGDATUM":case"VERT_CS":case"VERTCRS":case"VERTICALCRS":case"COMPD_CS":case"COMPOUNDCRS":case"ENGINEERINGCRS":case"ENGCRS":case"FITTED_CS":case"LOCAL_DATUM":case"DATUM":return t[0]=["name",t[0]],void xl(e,i,t);default:for(n=-1;++n<t.length;)if(!Array.isArray(t[n]))return _l(t,e[i]);return xl(e,i,t)}}else e[i]=t;else e[i]=!0}else e[t]=!0}yl.prototype.readCharicter=function(){var t=this.text[this.place++];if(4!==this.state)for(;pl.test(t);){if(this.place>=this.text.length)return;t=this.text[this.place++]}switch(this.state){case 1:return this.neutral(t);case 2:return this.keyword(t);case 4:return this.quoted(t);case 5:return this.afterquote(t);case 3:return this.number(t);case-1:return}},yl.prototype.afterquote=function(t){if('"'===t)return this.word+='"',void(this.state=4);if(gl.test(t))return this.word=this.word.trim(),void this.afterItem(t);throw new Error("havn't handled \""+t+'" in afterquote yet, index '+this.place)},yl.prototype.afterItem=function(t){return","===t?(null!==this.word&&this.currentObject.push(this.word),this.word=null,void(this.state=1)):"]"===t?(this.level--,null!==this.word&&(this.currentObject.push(this.word),this.word=null),this.state=1,this.currentObject=this.stack.pop(),void(this.currentObject||(this.state=-1))):void 0},yl.prototype.number=function(t){if(!vl.test(t)){if(gl.test(t))return this.word=parseFloat(this.word),void this.afterItem(t);throw new Error("havn't handled \""+t+'" in number yet, index '+this.place)}this.word+=t},yl.prototype.quoted=function(t){'"'!==t?this.word+=t:this.state=5},yl.prototype.keyword=function(t){if(ml.test(t))this.word+=t;else{if("["===t){var e=[];return e.push(this.word),this.level++,null===this.root?this.root=e:this.currentObject.push(e),this.stack.push(this.currentObject),this.currentObject=e,void(this.state=1)}if(!gl.test(t))throw new Error("havn't handled \""+t+'" in keyword yet, index '+this.place);this.afterItem(t)}},yl.prototype.neutral=function(t){if(fl.test(t))return this.word=t,void(this.state=2);if('"'===t)return this.word="",void(this.state=4);if(vl.test(t))return this.word=t,void(this.state=3);if(!gl.test(t))throw new Error("havn't handled \""+t+'" in neutral yet, index '+this.place);this.afterItem(t)},yl.prototype.output=function(){for(;this.place<this.text.length;)this.readCharicter();if(-1===this.state)return this.root;throw new Error('unable to parse string "'+this.text+'". State is '+this.state)};function Ml(t){return.017453292519943295*t}function bl(t){var e=new yl(t).output(),i=e.shift(),n=e.shift();e.unshift(["name",n]),e.unshift(["type",i]);var r={};return _l(e,r),function(t){if("GEOGCS"===t.type?t.projName="longlat":"LOCAL_CS"===t.type?(t.projName="identity",t.local=!0):"object"==typeof t.PROJECTION?t.projName=Object.keys(t.PROJECTION)[0]:t.projName=t.PROJECTION,t.AXIS){for(var e="",i=0,n=t.AXIS.length;i<n;++i){var r=[t.AXIS[i][0].toLowerCase(),t.AXIS[i][1].toLowerCase()];-1!==r[0].indexOf("north")||("y"===r[0]||"lat"===r[0])&&"north"===r[1]?e+="n":-1!==r[0].indexOf("south")||("y"===r[0]||"lat"===r[0])&&"south"===r[1]?e+="s":-1!==r[0].indexOf("east")||("x"===r[0]||"lon"===r[0])&&"east"===r[1]?e+="e":-1===r[0].indexOf("west")&&("x"!==r[0]&&"lon"!==r[0]||"west"!==r[1])||(e+="w")}2===e.length&&(e+="u"),3===e.length&&(t.axis=e)}t.UNIT&&(t.units=t.UNIT.name.toLowerCase(),"metre"===t.units&&(t.units="meter"),t.UNIT.convert&&("GEOGCS"===t.type?t.DATUM&&t.DATUM.SPHEROID&&(t.to_meter=t.UNIT.convert*t.DATUM.SPHEROID.a):t.to_meter=t.UNIT.convert));var s=t.GEOGCS;function a(e){return e*(t.to_meter||1)}"GEOGCS"===t.type&&(s=t),s&&(s.DATUM?t.datumCode=s.DATUM.name.toLowerCase():t.datumCode=s.name.toLowerCase(),"d_"===t.datumCode.slice(0,2)&&(t.datumCode=t.datumCode.slice(2)),"new_zealand_geodetic_datum_1949"!==t.datumCode&&"new_zealand_1949"!==t.datumCode||(t.datumCode="nzgd49"),"wgs_1984"!==t.datumCode&&"world_geodetic_system_1984"!==t.datumCode||("Mercator_Auxiliary_Sphere"===t.PROJECTION&&(t.sphere=!0),t.datumCode="wgs84"),"_ferro"===t.datumCode.slice(-6)&&(t.datumCode=t.datumCode.slice(0,-6)),"_jakarta"===t.datumCode.slice(-8)&&(t.datumCode=t.datumCode.slice(0,-8)),~t.datumCode.indexOf("belge")&&(t.datumCode="rnb72"),s.DATUM&&s.DATUM.SPHEROID&&(t.ellps=s.DATUM.SPHEROID.name.replace("_19","").replace(/[Cc]larke\_18/,"clrk"),"international"===t.ellps.toLowerCase().slice(0,13)&&(t.ellps="intl"),t.a=s.DATUM.SPHEROID.a,t.rf=parseFloat(s.DATUM.SPHEROID.rf,10)),s.DATUM&&s.DATUM.TOWGS84&&(t.datum_params=s.DATUM.TOWGS84),~t.datumCode.indexOf("osgb_1936")&&(t.datumCode="osgb36"),~t.datumCode.indexOf("osni_1952")&&(t.datumCode="osni52"),(~t.datumCode.indexOf("tm65")||~t.datumCode.indexOf("geodetic_datum_of_1965"))&&(t.datumCode="ire65"),"ch1903+"===t.datumCode&&(t.datumCode="ch1903"),~t.datumCode.indexOf("israel")&&(t.datumCode="isr93")),t.b&&!isFinite(t.b)&&(t.b=t.a),[["standard_parallel_1","Standard_Parallel_1"],["standard_parallel_1","Latitude of 1st standard parallel"],["standard_parallel_2","Standard_Parallel_2"],["standard_parallel_2","Latitude of 2nd standard parallel"],["false_easting","False_Easting"],["false_easting","False easting"],["false-easting","Easting at false origin"],["false_northing","False_Northing"],["false_northing","False northing"],["false_northing","Northing at false origin"],["central_meridian","Central_Meridian"],["central_meridian","Longitude of natural origin"],["central_meridian","Longitude of false origin"],["latitude_of_origin","Latitude_Of_Origin"],["latitude_of_origin","Central_Parallel"],["latitude_of_origin","Latitude of natural origin"],["latitude_of_origin","Latitude of false origin"],["scale_factor","Scale_Factor"],["k0","scale_factor"],["latitude_of_center","Latitude_Of_Center"],["latitude_of_center","Latitude_of_center"],["lat0","latitude_of_center",Ml],["longitude_of_center","Longitude_Of_Center"],["longitude_of_center","Longitude_of_center"],["longc","longitude_of_center",Ml],["x0","false_easting",a],["y0","false_northing",a],["long0","central_meridian",Ml],["lat0","latitude_of_origin",Ml],["lat0","standard_parallel_1",Ml],["lat1","standard_parallel_1",Ml],["lat2","standard_parallel_2",Ml],["azimuth","Azimuth"],["alpha","azimuth",Ml],["srsCode","name"]].forEach((function(e){return function(t,e){var i=e[0],n=e[1];!(i in t)&&n in t&&(t[i]=t[n],3===e.length&&(t[i]=e[2](t[i])))}(t,e)})),t.long0||!t.longc||"Albers_Conic_Equal_Area"!==t.projName&&"Lambert_Azimuthal_Equal_Area"!==t.projName||(t.long0=t.longc),t.lat_ts||!t.lat1||"Stereographic_South_Pole"!==t.projName&&"Polar Stereographic (variant B)"!==t.projName||(t.lat0=Ml(t.lat1>0?90:-90),t.lat_ts=t.lat1)}(r),r}function Sl(t){var e=this;if(2===arguments.length){var i=arguments[1];"string"==typeof i?"+"===i.charAt(0)?Sl[t]=dl(arguments[1]):Sl[t]=bl(arguments[1]):Sl[t]=i}else if(1===arguments.length){if(Array.isArray(t))return t.map((function(t){Array.isArray(t)?Sl.apply(e,t):Sl(t)}));if("string"==typeof t){if(t in Sl)return Sl[t]}else"EPSG"in t?Sl["EPSG:"+t.EPSG]=t:"ESRI"in t?Sl["ESRI:"+t.ESRI]=t:"IAU2000"in t?Sl["IAU2000:"+t.IAU2000]=t:console.log(t);return}}!function(t){t("EPSG:4326","+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees"),t("EPSG:4269","+title=NAD83 (long/lat) +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees"),t("EPSG:3857","+title=WGS 84 / Pseudo-Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs"),t.WGS84=t["EPSG:4326"],t["EPSG:3785"]=t["EPSG:3857"],t.GOOGLE=t["EPSG:3857"],t["EPSG:900913"]=t["EPSG:3857"],t["EPSG:102113"]=t["EPSG:3857"]}(Sl);var wl=["PROJECTEDCRS","PROJCRS","GEOGCS","GEOCCS","PROJCS","LOCAL_CS","GEODCRS","GEODETICCRS","GEODETICDATUM","ENGCRS","ENGINEERINGCRS"];var El=["3857","900913","3785","102113"];function Tl(t){if(!function(t){return"string"==typeof t}(t))return t;if(function(t){return t in Sl}(t))return Sl[t];if(function(t){return wl.some((function(e){return t.indexOf(e)>-1}))}(t)){var e=bl(t);if(function(t){var e=ul(t,"authority");if(e){var i=ul(e,"epsg");return i&&El.indexOf(i)>-1}}(e))return Sl["EPSG:3857"];var i=function(t){var e=ul(t,"extension");if(e)return ul(e,"proj4")}(e);return i?dl(i):e}return function(t){return"+"===t[0]}(t)?dl(t):void 0}function Cl(t,e){var i,n;if(t=t||{},!e)return t;for(n in e)void 0!==(i=e[n])&&(t[n]=i);return t}function Ll(t,e,i){var n=t*e;return i/Math.sqrt(1-n*n)}function Al(t){return t<0?-1:1}function Rl(t){return Math.abs(t)<=ol?t:t-Al(t)*al}function Pl(t,e,i){var n=t*i,r=.5*t;return n=Math.pow((1-n)/(1+n),r),Math.tan(.5*(el-e))/n}function Dl(t,e){for(var i,n,r=.5*t,s=el-2*Math.atan(e),a=0;a<=15;a++)if(i=t*Math.sin(s),s+=n=el-2*Math.atan(e*Math.pow((1-i)/(1+i),r))-s,Math.abs(n)<=1e-10)return s;return-9999}function Nl(t){return t}var Il=[{init:function(){var t=this.b/this.a;this.es=1-t*t,"x0"in this||(this.x0=0),"y0"in this||(this.y0=0),this.e=Math.sqrt(this.es),this.lat_ts?this.sphere?this.k0=Math.cos(this.lat_ts):this.k0=Ll(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)):this.k0||(this.k?this.k0=this.k:this.k0=1)},forward:function(t){var e,i,n=t.x,r=t.y;if(r*rl>90&&r*rl<-90&&n*rl>180&&n*rl<-180)return null;if(Math.abs(Math.abs(r)-el)<=il)return null;if(this.sphere)e=this.x0+this.a*this.k0*Rl(n-this.long0),i=this.y0+this.a*this.k0*Math.log(Math.tan(sl+.5*r));else{var s=Math.sin(r),a=Pl(this.e,r,s);e=this.x0+this.a*this.k0*Rl(n-this.long0),i=this.y0-this.a*this.k0*Math.log(a)}return t.x=e,t.y=i,t},inverse:function(t){var e,i,n=t.x-this.x0,r=t.y-this.y0;if(this.sphere)i=el-2*Math.atan(Math.exp(-r/(this.a*this.k0)));else{var s=Math.exp(-r/(this.a*this.k0));if(-9999===(i=Dl(this.e,s)))return null}return e=Rl(this.long0+n/(this.a*this.k0)),t.x=e,t.y=i,t},names:["Mercator","Popular Visualisation Pseudo Mercator","Mercator_1SP","Mercator_Auxiliary_Sphere","merc"]},{init:function(){},forward:Nl,inverse:Nl,names:["longlat","identity"]}],Fl={},Ol=[];function zl(t,e){var i=Ol.length;return t.names?(Ol[i]=t,t.names.forEach((function(t){Fl[t.toLowerCase()]=i})),this):(console.log(e),!0)}var Ul={start:function(){Il.forEach(zl)},add:zl,get:function(t){if(!t)return!1;var e=t.toLowerCase();return void 0!==Fl[e]&&Ol[Fl[e]]?Ol[Fl[e]]:void 0}},Bl={MERIT:{a:6378137,rf:298.257,ellipseName:"MERIT 1983"},SGS85:{a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},GRS80:{a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},IAU76:{a:6378140,rf:298.257,ellipseName:"IAU 1976"},airy:{a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"},APL4:{a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},NWL9D:{a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},mod_airy:{a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"},andrae:{a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},aust_SA:{a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},GRS67:{a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},bessel:{a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"},bess_nam:{a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},clrk66:{a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"},clrk80:{a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."},clrk58:{a:6378293.645208759,rf:294.2606763692654,ellipseName:"Clarke 1858"},CPM:{a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},delmbr:{a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},engelis:{a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"},evrst30:{a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"},evrst48:{a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"},evrst56:{a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"},evrst69:{a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"},evrstSS:{a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},fschr60:{a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},fschr60m:{a:6378155,rf:298.3,ellipseName:"Fischer 1960"},fschr68:{a:6378150,rf:298.3,ellipseName:"Fischer 1968"},helmert:{a:6378200,rf:298.3,ellipseName:"Helmert 1906"},hough:{a:6378270,rf:297,ellipseName:"Hough"},intl:{a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},kaula:{a:6378163,rf:298.24,ellipseName:"Kaula 1961"},lerch:{a:6378139,rf:298.257,ellipseName:"Lerch 1979"},mprts:{a:6397300,rf:191,ellipseName:"Maupertius 1738"},new_intl:{a:6378157.5,b:6356772.2,ellipseName:"New International 1967"},plessis:{a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},krass:{a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},SEasia:{a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"},walbeck:{a:6376896,b:6355834.8467,ellipseName:"Walbeck"},WGS60:{a:6378165,rf:298.3,ellipseName:"WGS 60"},WGS66:{a:6378145,rf:298.25,ellipseName:"WGS 66"},WGS7:{a:6378135,rf:298.26,ellipseName:"WGS 72"}},kl=Bl.WGS84={a:6378137,rf:298.257223563,ellipseName:"WGS 84"};Bl.sphere={a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"};var Gl={};Gl.wgs84={towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},Gl.ch1903={towgs84:"674.374,15.056,405.346",ellipse:"bessel",datumName:"swiss"},Gl.ggrs87={towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},Gl.nad83={towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},Gl.nad27={nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},Gl.potsdam={towgs84:"598.1,73.7,418.2,0.202,0.045,-2.455,6.7",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},Gl.carthage={towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},Gl.hermannskogel={towgs84:"577.326,90.129,463.919,5.137,1.474,5.297,2.4232",ellipse:"bessel",datumName:"Hermannskogel"},Gl.osni52={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"airy",datumName:"Irish National"},Gl.ire65={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},Gl.rassadiran={towgs84:"-133.63,-157.5,-158.62",ellipse:"intl",datumName:"Rassadiran"},Gl.nzgd49={towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},Gl.osgb36={towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Airy 1830"},Gl.s_jtsk={towgs84:"589,76,480",ellipse:"bessel",datumName:"S-JTSK (Ferro)"},Gl.beduaram={towgs84:"-106,-87,188",ellipse:"clrk80",datumName:"Beduaram"},Gl.gunung_segara={towgs84:"-403,684,41",ellipse:"bessel",datumName:"Gunung Segara Jakarta"},Gl.rnb72={towgs84:"106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1",ellipse:"intl",datumName:"Reseau National Belge 1972"};var Hl={};function Vl(t){if(0===t.length)return null;var e="@"===t[0];return e&&(t=t.slice(1)),"null"===t?{name:"null",mandatory:!e,grid:null,isNull:!0}:{name:t,mandatory:!e,grid:Hl[t]||null,isNull:!1}}function Wl(t){return t/3600*Math.PI/180}function jl(t,e,i){return String.fromCharCode.apply(null,new Uint8Array(t.buffer.slice(e,i)))}function Xl(t){return t.map((function(t){return[Wl(t.longitudeShift),Wl(t.latitudeShift)]}))}function ql(t,e,i){return{name:jl(t,e+8,e+16).trim(),parent:jl(t,e+24,e+24+8).trim(),lowerLatitude:t.getFloat64(e+72,i),upperLatitude:t.getFloat64(e+88,i),lowerLongitude:t.getFloat64(e+104,i),upperLongitude:t.getFloat64(e+120,i),latitudeInterval:t.getFloat64(e+136,i),longitudeInterval:t.getFloat64(e+152,i),gridNodeCount:t.getInt32(e+168,i)}}function Yl(t,e,i,n){for(var r=e+176,s=[],a=0;a<i.gridNodeCount;a++){var o={latitudeShift:t.getFloat32(r+16*a,n),longitudeShift:t.getFloat32(r+16*a+4,n),latitudeAccuracy:t.getFloat32(r+16*a+8,n),longitudeAccuracy:t.getFloat32(r+16*a+12,n)};s.push(o)}return s}function Zl(t,e){if(!(this instanceof Zl))return new Zl(t);e=e||function(t){if(t)throw t};var i=Tl(t);if("object"==typeof i){var n=Zl.projections.get(i.projName);if(n){if(i.datumCode&&"none"!==i.datumCode){var r=ul(Gl,i.datumCode);r&&(i.datum_params=i.datum_params||(r.towgs84?r.towgs84.split(","):null),i.ellps=r.ellipse,i.datumName=r.datumName?r.datumName:i.datumCode)}i.k0=i.k0||1,i.axis=i.axis||"enu",i.ellps=i.ellps||"wgs84",i.lat1=i.lat1||i.lat0;var s,a,o,l,h,c,u,d=function(t,e,i,n,r){if(!t){var s=ul(Bl,n);s||(s=kl),t=s.a,e=s.b,i=s.rf}return i&&!e&&(e=(1-1/i)*t),(0===i||Math.abs(t-e)<il)&&(r=!0,e=t),{a:t,b:e,rf:i,sphere:r}}(i.a,i.b,i.rf,i.ellps,i.sphere),p=(s=d.a,a=d.b,d.rf,o=i.R_A,c=((l=s*s)-(h=a*a))/l,u=0,o?(l=(s*=1-c*(.16666666666666666+c*(.04722222222222222+.022156084656084655*c)))*s,c=0):u=Math.sqrt(c),{es:c,e:u,ep2:(l-h)/h}),f=function(t){return void 0===t?null:t.split(",").map(Vl)}(i.nadgrids),m=i.datum||function(t,e,i,n,r,s,a){var o={};return o.datum_type=void 0===t||"none"===t?5:4,e&&(o.datum_params=e.map(parseFloat),0===o.datum_params[0]&&0===o.datum_params[1]&&0===o.datum_params[2]||(o.datum_type=1),o.datum_params.length>3&&(0===o.datum_params[3]&&0===o.datum_params[4]&&0===o.datum_params[5]&&0===o.datum_params[6]||(o.datum_type=2,o.datum_params[3]*=tl,o.datum_params[4]*=tl,o.datum_params[5]*=tl,o.datum_params[6]=o.datum_params[6]/1e6+1))),a&&(o.datum_type=3,o.grids=a),o.a=i,o.b=n,o.es=r,o.ep2=s,o}(i.datumCode,i.datum_params,d.a,d.b,p.es,p.ep2,f);Cl(this,i),Cl(this,n),this.a=d.a,this.b=d.b,this.rf=d.rf,this.sphere=d.sphere,this.es=p.es,this.e=p.e,this.ep2=p.ep2,this.datum=m,this.init(),e(null,this)}else e(t)}else e(t)}function Jl(t,e,i){var n,r,s,a,o=t.x,l=t.y,h=t.z?t.z:0;if(l<-el&&l>-1.001*el)l=-el;else if(l>el&&l<1.001*el)l=el;else{if(l<-el)return{x:-1/0,y:-1/0,z:t.z};if(l>el)return{x:1/0,y:1/0,z:t.z}}return o>Math.PI&&(o-=2*Math.PI),r=Math.sin(l),a=Math.cos(l),s=r*r,{x:((n=i/Math.sqrt(1-e*s))+h)*a*Math.cos(o),y:(n+h)*a*Math.sin(o),z:(n*(1-e)+h)*r}}function Kl(t,e,i,n){var r,s,a,o,l,h,c,u,d,p,f,m,g,v,y,x=1e-12,_=t.x,M=t.y,b=t.z?t.z:0;if(r=Math.sqrt(_*_+M*M),s=Math.sqrt(_*_+M*M+b*b),r/i<x){if(v=0,s/i<x)return el,y=-n,{x:t.x,y:t.y,z:t.z}}else v=Math.atan2(M,_);a=b/s,u=(o=r/s)*(1-e)*(l=1/Math.sqrt(1-e*(2-e)*o*o)),d=a*l,g=0;do{g++,h=e*(c=i/Math.sqrt(1-e*d*d))/(c+(y=r*u+b*d-c*(1-e*d*d))),m=(f=a*(l=1/Math.sqrt(1-h*(2-h)*o*o)))*u-(p=o*(1-h)*l)*d,u=p,d=f}while(m*m>1e-24&&g<30);return{x:v,y:Math.atan(f/Math.abs(p)),z:y}}function Ql(t){return 1===t||2===t}function $l(t,e,i){if(function(t,e){return t.datum_type===e.datum_type&&!(t.a!==e.a||Math.abs(t.es-e.es)>5e-11)&&(1===t.datum_type?t.datum_params[0]===e.datum_params[0]&&t.datum_params[1]===e.datum_params[1]&&t.datum_params[2]===e.datum_params[2]:2!==t.datum_type||t.datum_params[0]===e.datum_params[0]&&t.datum_params[1]===e.datum_params[1]&&t.datum_params[2]===e.datum_params[2]&&t.datum_params[3]===e.datum_params[3]&&t.datum_params[4]===e.datum_params[4]&&t.datum_params[5]===e.datum_params[5]&&t.datum_params[6]===e.datum_params[6])}(t,e))return i;if(5===t.datum_type||5===e.datum_type)return i;var n=t.a,r=t.es;if(3===t.datum_type){if(0!==th(t,!1,i))return;n=Qo,r=$o}var s=e.a,a=e.b,o=e.es;if(3===e.datum_type&&(s=Qo,a=6356752.314,o=$o),r===o&&n===s&&!Ql(t.datum_type)&&!Ql(e.datum_type))return i;if((i=Jl(i,r,n),Ql(t.datum_type)&&(i=function(t,e,i){if(1===e)return{x:t.x+i[0],y:t.y+i[1],z:t.z+i[2]};if(2===e){var n=i[0],r=i[1],s=i[2],a=i[3],o=i[4],l=i[5],h=i[6];return{x:h*(t.x-l*t.y+o*t.z)+n,y:h*(l*t.x+t.y-a*t.z)+r,z:h*(-o*t.x+a*t.y+t.z)+s}}}(i,t.datum_type,t.datum_params)),Ql(e.datum_type)&&(i=function(t,e,i){if(1===e)return{x:t.x-i[0],y:t.y-i[1],z:t.z-i[2]};if(2===e){var n=i[0],r=i[1],s=i[2],a=i[3],o=i[4],l=i[5],h=i[6],c=(t.x-n)/h,u=(t.y-r)/h,d=(t.z-s)/h;return{x:c+l*u-o*d,y:-l*c+u+a*d,z:o*c-a*u+d}}}(i,e.datum_type,e.datum_params)),i=Kl(i,o,s,a),3===e.datum_type)&&0!==th(e,!0,i))return;return i}function th(t,e,i){if(null===t.grids||0===t.grids.length)return console.log("Grid shift grids not found"),-1;for(var n={x:-i.x,y:i.y},r={x:Number.NaN,y:Number.NaN},s=[],a=0;a<t.grids.length;a++){var o=t.grids[a];if(s.push(o.name),o.isNull){r=n;break}if(null!==o.grid){var l=o.grid.subgrids[0],h=(Math.abs(l.del[1])+Math.abs(l.del[0]))/1e4,c=l.ll[0]-h,u=l.ll[1]-h,d=l.ll[0]+(l.lim[0]-1)*l.del[0]+h,p=l.ll[1]+(l.lim[1]-1)*l.del[1]+h;if(!(u>n.y||c>n.x||p<n.y||d<n.x||(r=eh(n,e,l),isNaN(r.x))))break}else if(o.mandatory)return console.log("Unable to find mandatory grid '"+o.name+"'"),-1}return isNaN(r.x)?(console.log("Failed to find a grid shift table for location '"+-n.x*rl+" "+n.y*rl+" tried: '"+s+"'"),-1):(i.x=-r.x,i.y=r.y,0)}function eh(t,e,i){var n={x:Number.NaN,y:Number.NaN};if(isNaN(t.x))return n;var r={x:t.x,y:t.y};r.x-=i.ll[0],r.y-=i.ll[1],r.x=Rl(r.x-Math.PI)+Math.PI;var s=ih(r,i);if(e){if(isNaN(s.x))return n;s.x=r.x-s.x,s.y=r.y-s.y;var a,o,l=9;do{if(o=ih(s,i),isNaN(o.x)){console.log("Inverse grid shift iteration failed, presumably at grid edge.  Using first approximation.");break}a={x:r.x-(o.x+s.x),y:r.y-(o.y+s.y)},s.x+=a.x,s.y+=a.y}while(l--&&Math.abs(a.x)>1e-12&&Math.abs(a.y)>1e-12);if(l<0)return console.log("Inverse grid shift iterator failed to converge."),n;n.x=Rl(s.x+i.ll[0]),n.y=s.y+i.ll[1]}else isNaN(s.x)||(n.x=t.x+s.x,n.y=t.y+s.y);return n}function ih(t,e){var i,n={x:t.x/e.del[0],y:t.y/e.del[1]},r=Math.floor(n.x),s=Math.floor(n.y),a=n.x-1*r,o=n.y-1*s,l={x:Number.NaN,y:Number.NaN};if(r<0||r>=e.lim[0])return l;if(s<0||s>=e.lim[1])return l;i=s*e.lim[0]+r;var h=e.cvs[i][0],c=e.cvs[i][1];i++;var u=e.cvs[i][0],d=e.cvs[i][1];i+=e.lim[0];var p=e.cvs[i][0],f=e.cvs[i][1];i--;var m=e.cvs[i][0],g=e.cvs[i][1],v=a*o,y=a*(1-o),x=(1-a)*(1-o),_=(1-a)*o;return l.x=x*h+y*u+_*m+v*p,l.y=x*c+y*d+_*g+v*f,l}function nh(t,e,i){var n,r,s,a=i.x,o=i.y,l=i.z||0,h={};for(s=0;s<3;s++)if(!e||2!==s||void 0!==i.z)switch(0===s?(n=a,r=-1!=="ew".indexOf(t.axis[s])?"x":"y"):1===s?(n=o,r=-1!=="ns".indexOf(t.axis[s])?"y":"x"):(n=l,r="z"),t.axis[s]){case"e":h[r]=n;break;case"w":h[r]=-n;break;case"n":h[r]=n;break;case"s":h[r]=-n;break;case"u":void 0!==i[r]&&(h.z=n);break;case"d":void 0!==i[r]&&(h.z=-n);break;default:return null}return h}function rh(t){var e={x:t[0],y:t[1]};return t.length>2&&(e.z=t[2]),t.length>3&&(e.m=t[3]),e}function sh(t){if("function"==typeof Number.isFinite){if(Number.isFinite(t))return;throw new TypeError("coordinates must be finite numbers")}if("number"!=typeof t||t!=t||!isFinite(t))throw new TypeError("coordinates must be finite numbers")}function ah(t,e,i,n){var r;if(Array.isArray(i)&&(i=rh(i)),function(t){sh(t.x),sh(t.y)}(i),t.datum&&e.datum&&function(t,e){return(1===t.datum.datum_type||2===t.datum.datum_type)&&"WGS84"!==e.datumCode||(1===e.datum.datum_type||2===e.datum.datum_type)&&"WGS84"!==t.datumCode}(t,e)&&(i=ah(t,r=new Zl("WGS84"),i,n),t=r),n&&"enu"!==t.axis&&(i=nh(t,!1,i)),"longlat"===t.projName)i={x:i.x*nl,y:i.y*nl,z:i.z||0};else if(t.to_meter&&(i={x:i.x*t.to_meter,y:i.y*t.to_meter,z:i.z||0}),!(i=t.inverse(i)))return;if(t.from_greenwich&&(i.x+=t.from_greenwich),i=$l(t.datum,e.datum,i))return e.from_greenwich&&(i={x:i.x-e.from_greenwich,y:i.y,z:i.z||0}),"longlat"===e.projName?i={x:i.x*rl,y:i.y*rl,z:i.z||0}:(i=e.forward(i),e.to_meter&&(i={x:i.x/e.to_meter,y:i.y/e.to_meter,z:i.z||0})),n&&"enu"!==e.axis?nh(e,!0,i):i}Zl.projections=Ul,Zl.projections.start();var oh=Zl("WGS84");function lh(t,e,i,n){var r,s,a;return Array.isArray(i)?(r=ah(t,e,i,n)||{x:NaN,y:NaN},i.length>2?void 0!==t.name&&"geocent"===t.name||void 0!==e.name&&"geocent"===e.name?"number"==typeof r.z?[r.x,r.y,r.z].concat(i.splice(3)):[r.x,r.y,i[2]].concat(i.splice(3)):[r.x,r.y].concat(i.splice(2)):[r.x,r.y]):(s=ah(t,e,i,n),2===(a=Object.keys(i)).length||a.forEach((function(n){if(void 0!==t.name&&"geocent"===t.name||void 0!==e.name&&"geocent"===e.name){if("x"===n||"y"===n||"z"===n)return}else if("x"===n||"y"===n)return;s[n]=i[n]})),s)}function hh(t){return t instanceof Zl?t:t.oProj?t.oProj:Zl(t)}function ch(t,e,i){t=hh(t);var n,r=!1;return void 0===e?(e=t,t=oh,r=!0):(void 0!==e.x||Array.isArray(e))&&(i=e,e=t,t=oh,r=!0),e=hh(e),i?lh(t,e,i):(n={forward:function(i,n){return lh(t,e,i,n)},inverse:function(i,n){return lh(e,t,i,n)}},r&&(n.oProj=e),n)}var uh="AJSAJS",dh="AFAFAF",ph=65,fh=73,mh=79,gh=86,vh=90,yh={forward:xh,inverse:function(t){var e=Sh(Th(t.toUpperCase()));if(e.lat&&e.lon)return[e.lon,e.lat,e.lon,e.lat];return[e.left,e.bottom,e.right,e.top]},toPoint:_h};function xh(t,e){return e=e||5,function(t,e){var i="00000"+t.easting,n="00000"+t.northing;return t.zoneNumber+t.zoneLetter+(p=t.easting,f=t.northing,m=t.zoneNumber,g=Eh(m),v=Math.floor(p/1e5),y=Math.floor(f/1e5)%20,r=v,s=y,a=g,o=a-1,l=uh.charCodeAt(o),h=dh.charCodeAt(o),c=l+r-1,u=h+s,d=!1,c>vh&&(c=c-vh+ph-1,d=!0),(c===fh||l<fh&&c>fh||(c>fh||l<fh)&&d)&&c++,(c===mh||l<mh&&c>mh||(c>mh||l<mh)&&d)&&++c===fh&&c++,c>vh&&(c=c-vh+ph-1),u>gh?(u=u-gh+ph-1,d=!0):d=!1,(u===fh||h<fh&&u>fh||(u>fh||h<fh)&&d)&&u++,(u===mh||h<mh&&u>mh||(u>mh||h<mh)&&d)&&++u===fh&&u++,u>gh&&(u=u-gh+ph-1),String.fromCharCode(c)+String.fromCharCode(u))+i.substr(i.length-5,e)+n.substr(n.length-5,e);var r,s,a,o,l,h,c,u,d;var p,f,m,g,v,y}(function(t){var e,i,n,r,s,a,o,l,h=t.lat,c=t.lon,u=6378137,d=.00669438,p=.9996,f=Mh(h),m=Mh(c);l=Math.floor((c+180)/6)+1,180===c&&(l=60);h>=56&&h<64&&c>=3&&c<12&&(l=32);h>=72&&h<84&&(c>=0&&c<9?l=31:c>=9&&c<21?l=33:c>=21&&c<33?l=35:c>=33&&c<42&&(l=37));o=Mh(6*(l-1)-180+3),e=d/(1-d),i=u/Math.sqrt(1-d*Math.sin(f)*Math.sin(f)),n=Math.tan(f)*Math.tan(f),r=e*Math.cos(f)*Math.cos(f),s=Math.cos(f)*(m-o),a=u*((1-d/4-3*d*d/64-5*d*d*d/256)*f-(3*d/8+3*d*d/32+45*d*d*d/1024)*Math.sin(2*f)+(15*d*d/256+45*d*d*d/1024)*Math.sin(4*f)-35*d*d*d/3072*Math.sin(6*f));var g=p*i*(s+(1-n+r)*s*s*s/6+(5-18*n+n*n+72*r-58*e)*s*s*s*s*s/120)+5e5,v=p*(a+i*Math.tan(f)*(s*s/2+(5-n+9*r+4*r*r)*s*s*s*s/24+(61-58*n+n*n+600*r-330*e)*s*s*s*s*s*s/720));h<0&&(v+=1e7);return{northing:Math.round(v),easting:Math.round(g),zoneNumber:l,zoneLetter:wh(h)}}({lat:t[1],lon:t[0]}),e)}function _h(t){var e=Sh(Th(t.toUpperCase()));return e.lat&&e.lon?[e.lon,e.lat]:[(e.left+e.right)/2,(e.top+e.bottom)/2]}function Mh(t){return t*(Math.PI/180)}function bh(t){return t/Math.PI*180}function Sh(t){var e=t.northing,i=t.easting,n=t.zoneLetter,r=t.zoneNumber;if(r<0||r>60)return null;var s,a,o,l,h,c,u,d,p,f=.9996,m=6378137,g=.00669438,v=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),y=i-5e5,x=e;n<"N"&&(x-=1e7),u=6*(r-1)-180+3,s=.006739496752268451,p=(d=x/f/6367449.145945056)+(3*v/2-27*v*v*v/32)*Math.sin(2*d)+(21*v*v/16-55*v*v*v*v/32)*Math.sin(4*d)+151*v*v*v/96*Math.sin(6*d),a=m/Math.sqrt(1-g*Math.sin(p)*Math.sin(p)),o=Math.tan(p)*Math.tan(p),l=s*Math.cos(p)*Math.cos(p),h=.99330562*m/Math.pow(1-g*Math.sin(p)*Math.sin(p),1.5),c=y/(a*f);var _=p-a*Math.tan(p)/h*(c*c/2-(5+3*o+10*l-4*l*l-9*s)*c*c*c*c/24+(61+90*o+298*l+45*o*o-1.6983531815716497-3*l*l)*c*c*c*c*c*c/720);_=bh(_);var M,b=(c-(1+2*o+l)*c*c*c/6+(5-2*l+28*o-3*l*l+8*s+24*o*o)*c*c*c*c*c/120)/Math.cos(p);if(b=u+bh(b),t.accuracy){var S=Sh({northing:t.northing+t.accuracy,easting:t.easting+t.accuracy,zoneLetter:t.zoneLetter,zoneNumber:t.zoneNumber});M={top:S.lat,right:S.lon,bottom:_,left:b}}else M={lat:_,lon:b};return M}function wh(t){var e="Z";return 84>=t&&t>=72?e="X":72>t&&t>=64?e="W":64>t&&t>=56?e="V":56>t&&t>=48?e="U":48>t&&t>=40?e="T":40>t&&t>=32?e="S":32>t&&t>=24?e="R":24>t&&t>=16?e="Q":16>t&&t>=8?e="P":8>t&&t>=0?e="N":0>t&&t>=-8?e="M":-8>t&&t>=-16?e="L":-16>t&&t>=-24?e="K":-24>t&&t>=-32?e="J":-32>t&&t>=-40?e="H":-40>t&&t>=-48?e="G":-48>t&&t>=-56?e="F":-56>t&&t>=-64?e="E":-64>t&&t>=-72?e="D":-72>t&&t>=-80&&(e="C"),e}function Eh(t){var e=t%6;return 0===e&&(e=6),e}function Th(t){if(t&&0===t.length)throw"MGRSPoint coverting from nothing";for(var e,i=t.length,n=null,r="",s=0;!/[A-Z]/.test(e=t.charAt(s));){if(s>=2)throw"MGRSPoint bad conversion from: "+t;r+=e,s++}var a=parseInt(r,10);if(0===s||s+3>i)throw"MGRSPoint bad conversion from: "+t;var o=t.charAt(s++);if(o<="A"||"B"===o||"Y"===o||o>="Z"||"I"===o||"O"===o)throw"MGRSPoint zone letter "+o+" not handled: "+t;n=t.substring(s,s+=2);for(var l=Eh(a),h=function(t,e){var i=uh.charCodeAt(e-1),n=1e5,r=!1;for(;i!==t.charCodeAt(0);){if(++i===fh&&i++,i===mh&&i++,i>vh){if(r)throw"Bad character: "+t;i=ph,r=!0}n+=1e5}return n}(n.charAt(0),l),c=function(t,e){if(t>"V")throw"MGRSPoint given invalid Northing "+t;var i=dh.charCodeAt(e-1),n=0,r=!1;for(;i!==t.charCodeAt(0);){if(++i===fh&&i++,i===mh&&i++,i>gh){if(r)throw"Bad character: "+t;i=ph,r=!0}n+=1e5}return n}(n.charAt(1),l);c<Ch(o);)c+=2e6;var u=i-s;if(u%2!=0)throw"MGRSPoint has to have an even number \nof digits after the zone letter and two 100km letters - front \nhalf for easting meters, second half for \nnorthing meters"+t;var d,p,f,m=u/2,g=0,v=0;return m>0&&(d=1e5/Math.pow(10,m),p=t.substring(s,s+m),g=parseFloat(p)*d,f=t.substring(s+m),v=parseFloat(f)*d),{easting:g+h,northing:v+c,zoneLetter:o,zoneNumber:a,accuracy:d}}function Ch(t){var e;switch(t){case"C":e=11e5;break;case"D":e=2e6;break;case"E":e=28e5;break;case"F":e=37e5;break;case"G":e=46e5;break;case"H":e=55e5;break;case"J":e=64e5;break;case"K":e=73e5;break;case"L":e=82e5;break;case"M":e=91e5;break;case"N":e=0;break;case"P":e=8e5;break;case"Q":e=17e5;break;case"R":e=26e5;break;case"S":e=35e5;break;case"T":e=44e5;break;case"U":e=53e5;break;case"V":e=62e5;break;case"W":e=7e6;break;case"X":e=79e5;break;default:e=-1}if(e>=0)return e;throw"Invalid zone letter: "+t}function Lh(t,e,i){if(!(this instanceof Lh))return new Lh(t,e,i);if(Array.isArray(t))this.x=t[0],this.y=t[1],this.z=t[2]||0;else if("object"==typeof t)this.x=t.x,this.y=t.y,this.z=t.z||0;else if("string"==typeof t&&void 0===e){var n=t.split(",");this.x=parseFloat(n[0],10),this.y=parseFloat(n[1],10),this.z=parseFloat(n[2],10)||0}else this.x=t,this.y=e,this.z=i||0;console.warn("proj4.Point will be removed in version 3, use proj4.toPoint")}Lh.fromMGRS=function(t){return new Lh(_h(t))},Lh.prototype.toMGRS=function(t){return xh([this.x,this.y],t)};var Ah=.046875,Rh=.01953125,Ph=.01068115234375;function Dh(t){var e=[];e[0]=1-t*(.25+t*(Ah+t*(Rh+t*Ph))),e[1]=t*(.75-t*(Ah+t*(Rh+t*Ph)));var i=t*t;return e[2]=i*(.46875-t*(.013020833333333334+.007120768229166667*t)),i*=t,e[3]=i*(.3645833333333333-.005696614583333333*t),e[4]=i*t*.3076171875,e}function Nh(t,e,i,n){return i*=e,e*=e,n[0]*t-i*(n[1]+e*(n[2]+e*(n[3]+e*n[4])))}function Ih(t,e,i){for(var n=1/(1-e),r=t,s=20;s;--s){var a=Math.sin(r),o=1-e*a*a;if(r-=o=(Nh(r,a,Math.cos(r),i)-t)*(o*Math.sqrt(o))*n,Math.abs(o)<il)return r}return r}var Fh={init:function(){this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.es&&(this.en=Dh(this.es),this.ml0=Nh(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en))},forward:function(t){var e,i,n,r=t.x,s=t.y,a=Rl(r-this.long0),o=Math.sin(s),l=Math.cos(s);if(this.es){var h=l*a,c=Math.pow(h,2),u=this.ep2*Math.pow(l,2),d=Math.pow(u,2),p=Math.abs(l)>il?Math.tan(s):0,f=Math.pow(p,2),m=Math.pow(f,2);e=1-this.es*Math.pow(o,2),h/=Math.sqrt(e);var g=Nh(s,o,l,this.en);i=this.a*(this.k0*h*(1+c/6*(1-f+u+c/20*(5-18*f+m+14*u-58*f*u+c/42*(61+179*m-m*f-479*f)))))+this.x0,n=this.a*(this.k0*(g-this.ml0+o*a*h/2*(1+c/12*(5-f+9*u+4*d+c/30*(61+m-58*f+270*u-330*f*u+c/56*(1385+543*m-m*f-3111*f))))))+this.y0}else{var v=l*Math.sin(a);if(Math.abs(Math.abs(v)-1)<il)return 93;if(i=.5*this.a*this.k0*Math.log((1+v)/(1-v))+this.x0,n=l*Math.cos(a)/Math.sqrt(1-Math.pow(v,2)),(v=Math.abs(n))>=1){if(v-1>il)return 93;n=0}else n=Math.acos(n);s<0&&(n=-n),n=this.a*this.k0*(n-this.lat0)+this.y0}return t.x=i,t.y=n,t},inverse:function(t){var e,i,n,r,s=(t.x-this.x0)*(1/this.a),a=(t.y-this.y0)*(1/this.a);if(this.es)if(i=Ih(e=this.ml0+a/this.k0,this.es,this.en),Math.abs(i)<el){var o=Math.sin(i),l=Math.cos(i),h=Math.abs(l)>il?Math.tan(i):0,c=this.ep2*Math.pow(l,2),u=Math.pow(c,2),d=Math.pow(h,2),p=Math.pow(d,2);e=1-this.es*Math.pow(o,2);var f=s*Math.sqrt(e)/this.k0,m=Math.pow(f,2);n=i-(e*=h)*m/(1-this.es)*.5*(1-m/12*(5+3*d-9*c*d+c-4*u-m/30*(61+90*d-252*c*d+45*p+46*c-m/56*(1385+3633*d+4095*p+1574*p*d)))),r=Rl(this.long0+f*(1-m/6*(1+2*d+c-m/20*(5+28*d+24*p+8*c*d+6*c-m/42*(61+662*d+1320*p+720*p*d))))/l)}else n=el*Al(a),r=0;else{var g=Math.exp(s/this.k0),v=.5*(g-1/g),y=this.lat0+a/this.k0,x=Math.cos(y);e=Math.sqrt((1-Math.pow(x,2))/(1+Math.pow(v,2))),n=Math.asin(e),a<0&&(n=-n),r=0===v&&0===x?0:Rl(Math.atan2(v,x)+this.long0)}return t.x=r,t.y=n,t},names:["Fast_Transverse_Mercator","Fast Transverse Mercator"]};function Oh(t){var e=Math.exp(t);return e=(e-1/e)/2}function zh(t,e){t=Math.abs(t),e=Math.abs(e);var i=Math.max(t,e),n=Math.min(t,e)/(i||1);return i*Math.sqrt(1+Math.pow(n,2))}function Uh(t){var e=Math.abs(t);return e=function(t){var e=1+t,i=e-1;return 0===i?t:t*Math.log(e)/i}(e*(1+e/(zh(1,e)+1))),t<0?-e:e}function Bh(t,e){for(var i,n=2*Math.cos(2*e),r=t.length-1,s=t[r],a=0;--r>=0;)i=n*s-a+t[r],a=s,s=i;return e+i*Math.sin(2*e)}function kh(t,e,i){for(var n,r,s=Math.sin(e),a=Math.cos(e),o=Oh(i),l=function(t){var e=Math.exp(t);return(e+1/e)/2}(i),h=2*a*l,c=-2*s*o,u=t.length-1,d=t[u],p=0,f=0,m=0;--u>=0;)n=f,r=p,d=h*(f=d)-n-c*(p=m)+t[u],m=c*f-r+h*p;return[(h=s*l)*d-(c=a*o)*m,h*m+c*d]}var Gh={init:function(){if(!this.approx&&(isNaN(this.es)||this.es<=0))throw new Error('Incorrect elliptical usage. Try using the +approx option in the proj string, or PROJECTION["Fast_Transverse_Mercator"] in the WKT.');this.approx&&(Fh.init.apply(this),this.forward=Fh.forward,this.inverse=Fh.inverse),this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.cgb=[],this.cbg=[],this.utg=[],this.gtu=[];var t=this.es/(1+Math.sqrt(1-this.es)),e=t/(2-t),i=e;this.cgb[0]=e*(2+e*(-2/3+e*(e*(116/45+e*(26/45+e*(-2854/675)))-2))),this.cbg[0]=e*(e*(2/3+e*(4/3+e*(-82/45+e*(32/45+e*(4642/4725)))))-2),i*=e,this.cgb[1]=i*(7/3+e*(e*(-227/45+e*(2704/315+e*(2323/945)))-1.6)),this.cbg[1]=i*(5/3+e*(-16/15+e*(-13/9+e*(904/315+e*(-1522/945))))),i*=e,this.cgb[2]=i*(56/15+e*(-136/35+e*(-1262/105+e*(73814/2835)))),this.cbg[2]=i*(-26/15+e*(34/21+e*(1.6+e*(-12686/2835)))),i*=e,this.cgb[3]=i*(4279/630+e*(-332/35+e*(-399572/14175))),this.cbg[3]=i*(1237/630+e*(e*(-24832/14175)-2.4)),i*=e,this.cgb[4]=i*(4174/315+e*(-144838/6237)),this.cbg[4]=i*(-734/315+e*(109598/31185)),i*=e,this.cgb[5]=i*(601676/22275),this.cbg[5]=i*(444337/155925),i=Math.pow(e,2),this.Qn=this.k0/(1+e)*(1+i*(1/4+i*(1/64+i/256))),this.utg[0]=e*(e*(2/3+e*(-37/96+e*(1/360+e*(81/512+e*(-96199/604800)))))-.5),this.gtu[0]=e*(.5+e*(-2/3+e*(5/16+e*(41/180+e*(-127/288+e*(7891/37800)))))),this.utg[1]=i*(-1/48+e*(-1/15+e*(437/1440+e*(-46/105+e*(1118711/3870720))))),this.gtu[1]=i*(13/48+e*(e*(557/1440+e*(281/630+e*(-1983433/1935360)))-.6)),i*=e,this.utg[2]=i*(-17/480+e*(37/840+e*(209/4480+e*(-5569/90720)))),this.gtu[2]=i*(61/240+e*(-103/140+e*(15061/26880+e*(167603/181440)))),i*=e,this.utg[3]=i*(-4397/161280+e*(11/504+e*(830251/7257600))),this.gtu[3]=i*(49561/161280+e*(-179/168+e*(6601661/7257600))),i*=e,this.utg[4]=i*(-4583/161280+e*(108847/3991680)),this.gtu[4]=i*(34729/80640+e*(-3418889/1995840)),i*=e,this.utg[5]=i*(-20648693/638668800),this.gtu[5]=.6650675310896665*i;var n=Bh(this.cbg,this.lat0);this.Zb=-this.Qn*(n+function(t,e){for(var i,n=2*Math.cos(e),r=t.length-1,s=t[r],a=0;--r>=0;)i=n*s-a+t[r],a=s,s=i;return Math.sin(e)*i}(this.gtu,2*n))},forward:function(t){var e=Rl(t.x-this.long0),i=t.y;i=Bh(this.cbg,i);var n=Math.sin(i),r=Math.cos(i),s=Math.sin(e),a=Math.cos(e);i=Math.atan2(n,a*r),e=Math.atan2(s*r,zh(n,r*a)),e=Uh(Math.tan(e));var o,l,h=kh(this.gtu,2*i,2*e);return i+=h[0],e+=h[1],Math.abs(e)<=2.623395162778?(o=this.a*(this.Qn*e)+this.x0,l=this.a*(this.Qn*i+this.Zb)+this.y0):(o=1/0,l=1/0),t.x=o,t.y=l,t},inverse:function(t){var e,i,n=(t.x-this.x0)*(1/this.a),r=(t.y-this.y0)*(1/this.a);if(r=(r-this.Zb)/this.Qn,n/=this.Qn,Math.abs(n)<=2.623395162778){var s=kh(this.utg,2*r,2*n);r+=s[0],n+=s[1],n=Math.atan(Oh(n));var a=Math.sin(r),o=Math.cos(r),l=Math.sin(n),h=Math.cos(n);r=Math.atan2(a*h,zh(l,h*o)),e=Rl((n=Math.atan2(l,h*o))+this.long0),i=Bh(this.cgb,r)}else e=1/0,i=1/0;return t.x=e,t.y=i,t},names:["Extended_Transverse_Mercator","Extended Transverse Mercator","etmerc","Transverse_Mercator","Transverse Mercator","tmerc"]};var Hh={init:function(){var t=function(t,e){if(void 0===t){if((t=Math.floor(30*(Rl(e)+Math.PI)/Math.PI)+1)<0)return 0;if(t>60)return 60}return t}(this.zone,this.long0);if(void 0===t)throw new Error("unknown utm zone");this.lat0=0,this.long0=(6*Math.abs(t)-183)*nl,this.x0=5e5,this.y0=this.utmSouth?1e7:0,this.k0=.9996,Gh.init.apply(this),this.forward=Gh.forward,this.inverse=Gh.inverse},names:["Universal Transverse Mercator System","utm"],dependsOn:"etmerc"};function Vh(t,e){return Math.pow((1-t)/(1+t),e)}var Wh={init:function(){var t=Math.sin(this.lat0),e=Math.cos(this.lat0);e*=e,this.rc=Math.sqrt(1-this.es)/(1-this.es*t*t),this.C=Math.sqrt(1+this.es*e*e/(1-this.es)),this.phic0=Math.asin(t/this.C),this.ratexp=.5*this.C*this.e,this.K=Math.tan(.5*this.phic0+sl)/(Math.pow(Math.tan(.5*this.lat0+sl),this.C)*Vh(this.e*t,this.ratexp))},forward:function(t){var e=t.x,i=t.y;return t.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*i+sl),this.C)*Vh(this.e*Math.sin(i),this.ratexp))-el,t.x=this.C*e,t},inverse:function(t){for(var e=t.x/this.C,i=t.y,n=Math.pow(Math.tan(.5*i+sl)/this.K,1/this.C),r=20;r>0&&(i=2*Math.atan(n*Vh(this.e*Math.sin(t.y),-.5*this.e))-el,!(Math.abs(i-t.y)<1e-14));--r)t.y=i;return r?(t.x=e,t.y=i,t):null},names:["gauss"]};var jh={init:function(){Wh.init.apply(this),this.rc&&(this.sinc0=Math.sin(this.phic0),this.cosc0=Math.cos(this.phic0),this.R2=2*this.rc,this.title||(this.title="Oblique Stereographic Alternative"))},forward:function(t){var e,i,n,r;return t.x=Rl(t.x-this.long0),Wh.forward.apply(this,[t]),e=Math.sin(t.y),i=Math.cos(t.y),n=Math.cos(t.x),r=this.k0*this.R2/(1+this.sinc0*e+this.cosc0*i*n),t.x=r*i*Math.sin(t.x),t.y=r*(this.cosc0*e-this.sinc0*i*n),t.x=this.a*t.x+this.x0,t.y=this.a*t.y+this.y0,t},inverse:function(t){var e,i,n,r,s;if(t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,t.x/=this.k0,t.y/=this.k0,s=Math.sqrt(t.x*t.x+t.y*t.y)){var a=2*Math.atan2(s,this.R2);e=Math.sin(a),i=Math.cos(a),r=Math.asin(i*this.sinc0+t.y*e*this.cosc0/s),n=Math.atan2(t.x*e,s*this.cosc0*i-t.y*this.sinc0*e)}else r=this.phic0,n=0;return t.x=n,t.y=r,Wh.inverse.apply(this,[t]),t.x=Rl(t.x+this.long0),t},names:["Stereographic_North_Pole","Oblique_Stereographic","Polar_Stereographic","sterea","Oblique Stereographic Alternative","Double_Stereographic"]};var Xh={init:function(){this.coslat0=Math.cos(this.lat0),this.sinlat0=Math.sin(this.lat0),this.sphere?1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=il&&(this.k0=.5*(1+Al(this.lat0)*Math.sin(this.lat_ts))):(Math.abs(this.coslat0)<=il&&(this.lat0>0?this.con=1:this.con=-1),this.cons=Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e)),1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=il&&(this.k0=.5*this.cons*Ll(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts))/Pl(this.e,this.con*this.lat_ts,this.con*Math.sin(this.lat_ts))),this.ms1=Ll(this.e,this.sinlat0,this.coslat0),this.X0=2*Math.atan(this.ssfn_(this.lat0,this.sinlat0,this.e))-el,this.cosX0=Math.cos(this.X0),this.sinX0=Math.sin(this.X0))},forward:function(t){var e,i,n,r,s,a,o=t.x,l=t.y,h=Math.sin(l),c=Math.cos(l),u=Rl(o-this.long0);return Math.abs(Math.abs(o-this.long0)-Math.PI)<=il&&Math.abs(l+this.lat0)<=il?(t.x=NaN,t.y=NaN,t):this.sphere?(e=2*this.k0/(1+this.sinlat0*h+this.coslat0*c*Math.cos(u)),t.x=this.a*e*c*Math.sin(u)+this.x0,t.y=this.a*e*(this.coslat0*h-this.sinlat0*c*Math.cos(u))+this.y0,t):(i=2*Math.atan(this.ssfn_(l,h,this.e))-el,r=Math.cos(i),n=Math.sin(i),Math.abs(this.coslat0)<=il?(s=Pl(this.e,l*this.con,this.con*h),a=2*this.a*this.k0*s/this.cons,t.x=this.x0+a*Math.sin(o-this.long0),t.y=this.y0-this.con*a*Math.cos(o-this.long0),t):(Math.abs(this.sinlat0)<il?(e=2*this.a*this.k0/(1+r*Math.cos(u)),t.y=e*n):(e=2*this.a*this.k0*this.ms1/(this.cosX0*(1+this.sinX0*n+this.cosX0*r*Math.cos(u))),t.y=e*(this.cosX0*n-this.sinX0*r*Math.cos(u))+this.y0),t.x=e*r*Math.sin(u)+this.x0,t))},inverse:function(t){var e,i,n,r,s;t.x-=this.x0,t.y-=this.y0;var a=Math.sqrt(t.x*t.x+t.y*t.y);if(this.sphere){var o=2*Math.atan(a/(2*this.a*this.k0));return e=this.long0,i=this.lat0,a<=il?(t.x=e,t.y=i,t):(i=Math.asin(Math.cos(o)*this.sinlat0+t.y*Math.sin(o)*this.coslat0/a),e=Math.abs(this.coslat0)<il?this.lat0>0?Rl(this.long0+Math.atan2(t.x,-1*t.y)):Rl(this.long0+Math.atan2(t.x,t.y)):Rl(this.long0+Math.atan2(t.x*Math.sin(o),a*this.coslat0*Math.cos(o)-t.y*this.sinlat0*Math.sin(o))),t.x=e,t.y=i,t)}if(Math.abs(this.coslat0)<=il){if(a<=il)return i=this.lat0,e=this.long0,t.x=e,t.y=i,t;t.x*=this.con,t.y*=this.con,n=a*this.cons/(2*this.a*this.k0),i=this.con*Dl(this.e,n),e=this.con*Rl(this.con*this.long0+Math.atan2(t.x,-1*t.y))}else r=2*Math.atan(a*this.cosX0/(2*this.a*this.k0*this.ms1)),e=this.long0,a<=il?s=this.X0:(s=Math.asin(Math.cos(r)*this.sinX0+t.y*Math.sin(r)*this.cosX0/a),e=Rl(this.long0+Math.atan2(t.x*Math.sin(r),a*this.cosX0*Math.cos(r)-t.y*this.sinX0*Math.sin(r)))),i=-1*Dl(this.e,Math.tan(.5*(el+s)));return t.x=e,t.y=i,t},names:["stere","Stereographic_South_Pole","Polar Stereographic (variant B)"],ssfn_:function(t,e,i){return e*=i,Math.tan(.5*(el+t))*Math.pow((1-e)/(1+e),.5*i)}};var qh={init:function(){var t=this.lat0;this.lambda0=this.long0;var e=Math.sin(t),i=this.a,n=1/this.rf,r=2*n-Math.pow(n,2),s=this.e=Math.sqrt(r);this.R=this.k0*i*Math.sqrt(1-r)/(1-r*Math.pow(e,2)),this.alpha=Math.sqrt(1+r/(1-r)*Math.pow(Math.cos(t),4)),this.b0=Math.asin(e/this.alpha);var a=Math.log(Math.tan(Math.PI/4+this.b0/2)),o=Math.log(Math.tan(Math.PI/4+t/2)),l=Math.log((1+s*e)/(1-s*e));this.K=a-this.alpha*o+this.alpha*s/2*l},forward:function(t){var e=Math.log(Math.tan(Math.PI/4-t.y/2)),i=this.e/2*Math.log((1+this.e*Math.sin(t.y))/(1-this.e*Math.sin(t.y))),n=-this.alpha*(e+i)+this.K,r=2*(Math.atan(Math.exp(n))-Math.PI/4),s=this.alpha*(t.x-this.lambda0),a=Math.atan(Math.sin(s)/(Math.sin(this.b0)*Math.tan(r)+Math.cos(this.b0)*Math.cos(s))),o=Math.asin(Math.cos(this.b0)*Math.sin(r)-Math.sin(this.b0)*Math.cos(r)*Math.cos(s));return t.y=this.R/2*Math.log((1+Math.sin(o))/(1-Math.sin(o)))+this.y0,t.x=this.R*a+this.x0,t},inverse:function(t){for(var e=t.x-this.x0,i=t.y-this.y0,n=e/this.R,r=2*(Math.atan(Math.exp(i/this.R))-Math.PI/4),s=Math.asin(Math.cos(this.b0)*Math.sin(r)+Math.sin(this.b0)*Math.cos(r)*Math.cos(n)),a=Math.atan(Math.sin(n)/(Math.cos(this.b0)*Math.cos(n)-Math.sin(this.b0)*Math.tan(r))),o=this.lambda0+a/this.alpha,l=0,h=s,c=-1e3,u=0;Math.abs(h-c)>1e-7;){if(++u>20)return;l=1/this.alpha*(Math.log(Math.tan(Math.PI/4+s/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(h))/2)),c=h,h=2*Math.atan(Math.exp(l))-Math.PI/2}return t.x=o,t.y=h,t},names:["somerc"]},Yh=1e-7;var Zh={init:function(){var t,e,i,n,r,s,a,o,l,h,c,u,d,p=0,f=0,m=0,g=0,v=0,y=0,x=0;this.no_off=(d="object"==typeof(u=this).PROJECTION?Object.keys(u.PROJECTION)[0]:u.PROJECTION,"no_uoff"in u||"no_off"in u||-1!==["Hotine_Oblique_Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin"].indexOf(d)),this.no_rot="no_rot"in this;var _=!1;"alpha"in this&&(_=!0);var M=!1;if("rectified_grid_angle"in this&&(M=!0),_&&(x=this.alpha),M&&(p=this.rectified_grid_angle*nl),_||M)f=this.longc;else if(m=this.long1,v=this.lat1,g=this.long2,y=this.lat2,Math.abs(v-y)<=Yh||(t=Math.abs(v))<=Yh||Math.abs(t-el)<=Yh||Math.abs(Math.abs(this.lat0)-el)<=Yh||Math.abs(Math.abs(y)-el)<=Yh)throw new Error;var b=1-this.es;e=Math.sqrt(b),Math.abs(this.lat0)>il?(o=Math.sin(this.lat0),i=Math.cos(this.lat0),t=1-this.es*o*o,this.B=i*i,this.B=Math.sqrt(1+this.es*this.B*this.B/b),this.A=this.B*this.k0*e/t,(r=(n=this.B*e/(i*Math.sqrt(t)))*n-1)<=0?r=0:(r=Math.sqrt(r),this.lat0<0&&(r=-r)),this.E=r+=n,this.E*=Math.pow(Pl(this.e,this.lat0,o),this.B)):(this.B=1/e,this.A=this.k0,this.E=n=r=1),_||M?(_?(c=Math.asin(Math.sin(x)/n),M||(p=x)):(c=p,x=Math.asin(n*Math.sin(c))),this.lam0=f-Math.asin(.5*(r-1/r)*Math.tan(c))/this.B):(s=Math.pow(Pl(this.e,v,Math.sin(v)),this.B),a=Math.pow(Pl(this.e,y,Math.sin(y)),this.B),r=this.E/s,l=(a-s)/(a+s),h=((h=this.E*this.E)-a*s)/(h+a*s),(t=m-g)<-Math.pi?g-=al:t>Math.pi&&(g+=al),this.lam0=Rl(.5*(m+g)-Math.atan(h*Math.tan(.5*this.B*(m-g))/l)/this.B),c=Math.atan(2*Math.sin(this.B*Rl(m-this.lam0))/(r-1/r)),p=x=Math.asin(n*Math.sin(c))),this.singam=Math.sin(c),this.cosgam=Math.cos(c),this.sinrot=Math.sin(p),this.cosrot=Math.cos(p),this.rB=1/this.B,this.ArB=this.A*this.rB,this.BrA=1/this.ArB,this.A,this.B,this.no_off?this.u_0=0:(this.u_0=Math.abs(this.ArB*Math.atan(Math.sqrt(n*n-1)/Math.cos(x))),this.lat0<0&&(this.u_0=-this.u_0)),r=.5*c,this.v_pole_n=this.ArB*Math.log(Math.tan(sl-r)),this.v_pole_s=this.ArB*Math.log(Math.tan(sl+r))},forward:function(t){var e,i,n,r,s,a,o,l,h={};if(t.x=t.x-this.lam0,Math.abs(Math.abs(t.y)-el)>il){if(e=.5*((s=this.E/Math.pow(Pl(this.e,t.y,Math.sin(t.y)),this.B))-(a=1/s)),i=.5*(s+a),r=Math.sin(this.B*t.x),n=(e*this.singam-r*this.cosgam)/i,Math.abs(Math.abs(n)-1)<il)throw new Error;l=.5*this.ArB*Math.log((1-n)/(1+n)),a=Math.cos(this.B*t.x),o=Math.abs(a)<Yh?this.A*t.x:this.ArB*Math.atan2(e*this.cosgam+r*this.singam,a)}else l=t.y>0?this.v_pole_n:this.v_pole_s,o=this.ArB*t.y;return this.no_rot?(h.x=o,h.y=l):(o-=this.u_0,h.x=l*this.cosrot+o*this.sinrot,h.y=o*this.cosrot-l*this.sinrot),h.x=this.a*h.x+this.x0,h.y=this.a*h.y+this.y0,h},inverse:function(t){var e,i,n,r,s,a,o,l={};if(t.x=(t.x-this.x0)*(1/this.a),t.y=(t.y-this.y0)*(1/this.a),this.no_rot?(i=t.y,e=t.x):(i=t.x*this.cosrot-t.y*this.sinrot,e=t.y*this.cosrot+t.x*this.sinrot+this.u_0),r=.5*((n=Math.exp(-this.BrA*i))-1/n),s=.5*(n+1/n),o=((a=Math.sin(this.BrA*e))*this.cosgam+r*this.singam)/s,Math.abs(Math.abs(o)-1)<il)l.x=0,l.y=o<0?-el:el;else{if(l.y=this.E/Math.sqrt((1+o)/(1-o)),l.y=Dl(this.e,Math.pow(l.y,1/this.B)),l.y===1/0)throw new Error;l.x=-this.rB*Math.atan2(r*this.cosgam-a*this.singam,Math.cos(this.BrA*e))}return l.x+=this.lam0,l},names:["Hotine_Oblique_Mercator","Hotine Oblique Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin","Hotine_Oblique_Mercator_Two_Point_Natural_Origin","Hotine_Oblique_Mercator_Azimuth_Center","Oblique_Mercator","omerc"]};var Jh={init:function(){if(this.lat2||(this.lat2=this.lat1),this.k0||(this.k0=1),this.x0=this.x0||0,this.y0=this.y0||0,!(Math.abs(this.lat1+this.lat2)<il)){var t=this.b/this.a;this.e=Math.sqrt(1-t*t);var e=Math.sin(this.lat1),i=Math.cos(this.lat1),n=Ll(this.e,e,i),r=Pl(this.e,this.lat1,e),s=Math.sin(this.lat2),a=Math.cos(this.lat2),o=Ll(this.e,s,a),l=Pl(this.e,this.lat2,s),h=Pl(this.e,this.lat0,Math.sin(this.lat0));Math.abs(this.lat1-this.lat2)>il?this.ns=Math.log(n/o)/Math.log(r/l):this.ns=e,isNaN(this.ns)&&(this.ns=e),this.f0=n/(this.ns*Math.pow(r,this.ns)),this.rh=this.a*this.f0*Math.pow(h,this.ns),this.title||(this.title="Lambert Conformal Conic")}},forward:function(t){var e=t.x,i=t.y;Math.abs(2*Math.abs(i)-Math.PI)<=il&&(i=Al(i)*(el-2e-10));var n,r,s=Math.abs(Math.abs(i)-el);if(s>il)n=Pl(this.e,i,Math.sin(i)),r=this.a*this.f0*Math.pow(n,this.ns);else{if((s=i*this.ns)<=0)return null;r=0}var a=this.ns*Rl(e-this.long0);return t.x=this.k0*(r*Math.sin(a))+this.x0,t.y=this.k0*(this.rh-r*Math.cos(a))+this.y0,t},inverse:function(t){var e,i,n,r,s,a=(t.x-this.x0)/this.k0,o=this.rh-(t.y-this.y0)/this.k0;this.ns>0?(e=Math.sqrt(a*a+o*o),i=1):(e=-Math.sqrt(a*a+o*o),i=-1);var l=0;if(0!==e&&(l=Math.atan2(i*a,i*o)),0!==e||this.ns>0){if(i=1/this.ns,n=Math.pow(e/(this.a*this.f0),i),-9999===(r=Dl(this.e,n)))return null}else r=-el;return s=Rl(l/this.ns+this.long0),t.x=s,t.y=r,t},names:["Lambert Tangential Conformal Conic Projection","Lambert_Conformal_Conic","Lambert_Conformal_Conic_1SP","Lambert_Conformal_Conic_2SP","lcc"]};var Kh={init:function(){this.a=6377397.155,this.es=.006674372230614,this.e=Math.sqrt(this.es),this.lat0||(this.lat0=.863937979737193),this.long0||(this.long0=.4334234309119251),this.k0||(this.k0=.9999),this.s45=.785398163397448,this.s90=2*this.s45,this.fi0=this.lat0,this.e2=this.es,this.e=Math.sqrt(this.e2),this.alfa=Math.sqrt(1+this.e2*Math.pow(Math.cos(this.fi0),4)/(1-this.e2)),this.uq=1.04216856380474,this.u0=Math.asin(Math.sin(this.fi0)/this.alfa),this.g=Math.pow((1+this.e*Math.sin(this.fi0))/(1-this.e*Math.sin(this.fi0)),this.alfa*this.e/2),this.k=Math.tan(this.u0/2+this.s45)/Math.pow(Math.tan(this.fi0/2+this.s45),this.alfa)*this.g,this.k1=this.k0,this.n0=this.a*Math.sqrt(1-this.e2)/(1-this.e2*Math.pow(Math.sin(this.fi0),2)),this.s0=1.37008346281555,this.n=Math.sin(this.s0),this.ro0=this.k1*this.n0/Math.tan(this.s0),this.ad=this.s90-this.uq},forward:function(t){var e,i,n,r,s,a,o,l=t.x,h=t.y,c=Rl(l-this.long0);return e=Math.pow((1+this.e*Math.sin(h))/(1-this.e*Math.sin(h)),this.alfa*this.e/2),i=2*(Math.atan(this.k*Math.pow(Math.tan(h/2+this.s45),this.alfa)/e)-this.s45),n=-c*this.alfa,r=Math.asin(Math.cos(this.ad)*Math.sin(i)+Math.sin(this.ad)*Math.cos(i)*Math.cos(n)),s=Math.asin(Math.cos(i)*Math.sin(n)/Math.cos(r)),a=this.n*s,o=this.ro0*Math.pow(Math.tan(this.s0/2+this.s45),this.n)/Math.pow(Math.tan(r/2+this.s45),this.n),t.y=o*Math.cos(a)/1,t.x=o*Math.sin(a)/1,this.czech||(t.y*=-1,t.x*=-1),t},inverse:function(t){var e,i,n,r,s,a,o,l=t.x;t.x=t.y,t.y=l,this.czech||(t.y*=-1,t.x*=-1),s=Math.sqrt(t.x*t.x+t.y*t.y),r=Math.atan2(t.y,t.x)/Math.sin(this.s0),n=2*(Math.atan(Math.pow(this.ro0/s,1/this.n)*Math.tan(this.s0/2+this.s45))-this.s45),e=Math.asin(Math.cos(this.ad)*Math.sin(n)-Math.sin(this.ad)*Math.cos(n)*Math.cos(r)),i=Math.asin(Math.cos(n)*Math.sin(r)/Math.cos(e)),t.x=this.long0-i/this.alfa,a=e,o=0;var h=0;do{t.y=2*(Math.atan(Math.pow(this.k,-1/this.alfa)*Math.pow(Math.tan(e/2+this.s45),1/this.alfa)*Math.pow((1+this.e*Math.sin(a))/(1-this.e*Math.sin(a)),this.e/2))-this.s45),Math.abs(a-t.y)<1e-10&&(o=1),a=t.y,h+=1}while(0===o&&h<15);return h>=15?null:t},names:["Krovak","krovak"]};function Qh(t,e,i,n,r){return t*r-e*Math.sin(2*r)+i*Math.sin(4*r)-n*Math.sin(6*r)}function $h(t){return 1-.25*t*(1+t/16*(3+1.25*t))}function tc(t){return.375*t*(1+.25*t*(1+.46875*t))}function ec(t){return.05859375*t*t*(1+.75*t)}function ic(t){return t*t*t*(35/3072)}function nc(t,e,i){var n=e*i;return t/Math.sqrt(1-n*n)}function rc(t){return Math.abs(t)<el?t:t-Al(t)*Math.PI}function sc(t,e,i,n,r){var s,a;s=t/e;for(var o=0;o<15;o++)if(s+=a=(t-(e*s-i*Math.sin(2*s)+n*Math.sin(4*s)-r*Math.sin(6*s)))/(e-2*i*Math.cos(2*s)+4*n*Math.cos(4*s)-6*r*Math.cos(6*s)),Math.abs(a)<=1e-10)return s;return NaN}var ac={init:function(){this.sphere||(this.e0=$h(this.es),this.e1=tc(this.es),this.e2=ec(this.es),this.e3=ic(this.es),this.ml0=this.a*Qh(this.e0,this.e1,this.e2,this.e3,this.lat0))},forward:function(t){var e,i,n=t.x,r=t.y;if(n=Rl(n-this.long0),this.sphere)e=this.a*Math.asin(Math.cos(r)*Math.sin(n)),i=this.a*(Math.atan2(Math.tan(r),Math.cos(n))-this.lat0);else{var s=Math.sin(r),a=Math.cos(r),o=nc(this.a,this.e,s),l=Math.tan(r)*Math.tan(r),h=n*Math.cos(r),c=h*h,u=this.es*a*a/(1-this.es);e=o*h*(1-c*l*(1/6-(8-l+8*u)*c/120)),i=this.a*Qh(this.e0,this.e1,this.e2,this.e3,r)-this.ml0+o*s/a*c*(.5+(5-l+6*u)*c/24)}return t.x=e+this.x0,t.y=i+this.y0,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var e,i,n=t.x/this.a,r=t.y/this.a;if(this.sphere){var s=r+this.lat0;e=Math.asin(Math.sin(s)*Math.cos(n)),i=Math.atan2(Math.tan(n),Math.cos(s))}else{var a=sc(this.ml0/this.a+r,this.e0,this.e1,this.e2,this.e3);if(Math.abs(Math.abs(a)-el)<=il)return t.x=this.long0,t.y=el,r<0&&(t.y*=-1),t;var o=nc(this.a,this.e,Math.sin(a)),l=o*o*o/this.a/this.a*(1-this.es),h=Math.pow(Math.tan(a),2),c=n*this.a/o,u=c*c;e=a-o*Math.tan(a)/l*c*c*(.5-(1+3*h)*c*c/24),i=c*(1-u*(h/3+(1+3*h)*h*u/15))/Math.cos(a)}return t.x=Rl(i+this.long0),t.y=rc(e),t},names:["Cassini","Cassini_Soldner","cass"]};function oc(t,e){var i;return t>1e-7?(1-t*t)*(e/(1-(i=t*e)*i)-.5/t*Math.log((1-i)/(1+i))):2*e}var lc=.3333333333333333,hc=.17222222222222222,cc=.10257936507936508,uc=.06388888888888888,dc=.0664021164021164,pc=.016415012942191543;var fc={init:function(){var t,e=Math.abs(this.lat0);if(Math.abs(e-el)<il?this.mode=this.lat0<0?this.S_POLE:this.N_POLE:Math.abs(e)<il?this.mode=this.EQUIT:this.mode=this.OBLIQ,this.es>0)switch(this.qp=oc(this.e,1),this.mmf=.5/(1-this.es),this.apa=function(t){var e,i=[];return i[0]=t*lc,e=t*t,i[0]+=e*hc,i[1]=e*uc,e*=t,i[0]+=e*cc,i[1]+=e*dc,i[2]=e*pc,i}(this.es),this.mode){case this.N_POLE:case this.S_POLE:this.dd=1;break;case this.EQUIT:this.rq=Math.sqrt(.5*this.qp),this.dd=1/this.rq,this.xmf=1,this.ymf=.5*this.qp;break;case this.OBLIQ:this.rq=Math.sqrt(.5*this.qp),t=Math.sin(this.lat0),this.sinb1=oc(this.e,t)/this.qp,this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1),this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*t*t)*this.rq*this.cosb1),this.ymf=(this.xmf=this.rq)/this.dd,this.xmf*=this.dd}else this.mode===this.OBLIQ&&(this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0))},forward:function(t){var e,i,n,r,s,a,o,l,h,c,u=t.x,d=t.y;if(u=Rl(u-this.long0),this.sphere){if(s=Math.sin(d),c=Math.cos(d),n=Math.cos(u),this.mode===this.OBLIQ||this.mode===this.EQUIT){if((i=this.mode===this.EQUIT?1+c*n:1+this.sinph0*s+this.cosph0*c*n)<=il)return null;e=(i=Math.sqrt(2/i))*c*Math.sin(u),i*=this.mode===this.EQUIT?s:this.cosph0*s-this.sinph0*c*n}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(n=-n),Math.abs(d+this.lat0)<il)return null;i=sl-.5*d,e=(i=2*(this.mode===this.S_POLE?Math.cos(i):Math.sin(i)))*Math.sin(u),i*=n}}else{switch(o=0,l=0,h=0,n=Math.cos(u),r=Math.sin(u),s=Math.sin(d),a=oc(this.e,s),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(o=a/this.qp,l=Math.sqrt(1-o*o)),this.mode){case this.OBLIQ:h=1+this.sinb1*o+this.cosb1*l*n;break;case this.EQUIT:h=1+l*n;break;case this.N_POLE:h=el+d,a=this.qp-a;break;case this.S_POLE:h=d-el,a=this.qp+a}if(Math.abs(h)<il)return null;switch(this.mode){case this.OBLIQ:case this.EQUIT:h=Math.sqrt(2/h),i=this.mode===this.OBLIQ?this.ymf*h*(this.cosb1*o-this.sinb1*l*n):(h=Math.sqrt(2/(1+l*n)))*o*this.ymf,e=this.xmf*h*l*r;break;case this.N_POLE:case this.S_POLE:a>=0?(e=(h=Math.sqrt(a))*r,i=n*(this.mode===this.S_POLE?h:-h)):e=i=0}}return t.x=this.a*e+this.x0,t.y=this.a*i+this.y0,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var e,i,n,r,s,a,o,l,h,c,u=t.x/this.a,d=t.y/this.a;if(this.sphere){var p,f=0,m=0;if((i=.5*(p=Math.sqrt(u*u+d*d)))>1)return null;switch(i=2*Math.asin(i),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(m=Math.sin(i),f=Math.cos(i)),this.mode){case this.EQUIT:i=Math.abs(p)<=il?0:Math.asin(d*m/p),u*=m,d=f*p;break;case this.OBLIQ:i=Math.abs(p)<=il?this.lat0:Math.asin(f*this.sinph0+d*m*this.cosph0/p),u*=m*this.cosph0,d=(f-Math.sin(i)*this.sinph0)*p;break;case this.N_POLE:d=-d,i=el-i;break;case this.S_POLE:i-=el}e=0!==d||this.mode!==this.EQUIT&&this.mode!==this.OBLIQ?Math.atan2(u,d):0}else{if(o=0,this.mode===this.OBLIQ||this.mode===this.EQUIT){if(u/=this.dd,d*=this.dd,(a=Math.sqrt(u*u+d*d))<il)return t.x=this.long0,t.y=this.lat0,t;r=2*Math.asin(.5*a/this.rq),n=Math.cos(r),u*=r=Math.sin(r),this.mode===this.OBLIQ?(o=n*this.sinb1+d*r*this.cosb1/a,s=this.qp*o,d=a*this.cosb1*n-d*this.sinb1*r):(o=d*r/a,s=this.qp*o,d=a*n)}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(d=-d),!(s=u*u+d*d))return t.x=this.long0,t.y=this.lat0,t;o=1-s/this.qp,this.mode===this.S_POLE&&(o=-o)}e=Math.atan2(u,d),l=Math.asin(o),h=this.apa,c=l+l,i=l+h[0]*Math.sin(c)+h[1]*Math.sin(c+c)+h[2]*Math.sin(c+c+c)}return t.x=Rl(this.long0+e),t.y=i,t},names:["Lambert Azimuthal Equal Area","Lambert_Azimuthal_Equal_Area","laea"],S_POLE:1,N_POLE:2,EQUIT:3,OBLIQ:4};function mc(t){return Math.abs(t)>1&&(t=t>1?1:-1),Math.asin(t)}var gc={init:function(){Math.abs(this.lat1+this.lat2)<il||(this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e3=Math.sqrt(this.es),this.sin_po=Math.sin(this.lat1),this.cos_po=Math.cos(this.lat1),this.t1=this.sin_po,this.con=this.sin_po,this.ms1=Ll(this.e3,this.sin_po,this.cos_po),this.qs1=oc(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat2),this.cos_po=Math.cos(this.lat2),this.t2=this.sin_po,this.ms2=Ll(this.e3,this.sin_po,this.cos_po),this.qs2=oc(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat0),this.cos_po=Math.cos(this.lat0),this.t3=this.sin_po,this.qs0=oc(this.e3,this.sin_po,this.cos_po),Math.abs(this.lat1-this.lat2)>il?this.ns0=(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.ns0=this.con,this.c=this.ms1*this.ms1+this.ns0*this.qs1,this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0)},forward:function(t){var e=t.x,i=t.y;this.sin_phi=Math.sin(i),this.cos_phi=Math.cos(i);var n=oc(this.e3,this.sin_phi,this.cos_phi),r=this.a*Math.sqrt(this.c-this.ns0*n)/this.ns0,s=this.ns0*Rl(e-this.long0),a=r*Math.sin(s)+this.x0,o=this.rh-r*Math.cos(s)+this.y0;return t.x=a,t.y=o,t},inverse:function(t){var e,i,n,r,s,a;return t.x-=this.x0,t.y=this.rh-t.y+this.y0,this.ns0>=0?(e=Math.sqrt(t.x*t.x+t.y*t.y),n=1):(e=-Math.sqrt(t.x*t.x+t.y*t.y),n=-1),r=0,0!==e&&(r=Math.atan2(n*t.x,n*t.y)),n=e*this.ns0/this.a,this.sphere?a=Math.asin((this.c-n*n)/(2*this.ns0)):(i=(this.c-n*n)/this.ns0,a=this.phi1z(this.e3,i)),s=Rl(r/this.ns0+this.long0),t.x=s,t.y=a,t},names:["Albers_Conic_Equal_Area","Albers","aea"],phi1z:function(t,e){var i,n,r,s,a=mc(.5*e);if(t<il)return a;for(var o=t*t,l=1;l<=25;l++)if(a+=s=.5*(r=1-(n=t*(i=Math.sin(a)))*n)*r/Math.cos(a)*(e/(1-o)-i/r+.5/t*Math.log((1-n)/(1+n))),Math.abs(s)<=1e-7)return a;return null}};var vc={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0),this.infinity_dist=1e3*this.a,this.rc=1},forward:function(t){var e,i,n,r,s,a,o,l=t.x,h=t.y;return n=Rl(l-this.long0),e=Math.sin(h),i=Math.cos(h),r=Math.cos(n),1,(s=this.sin_p14*e+this.cos_p14*i*r)>0||Math.abs(s)<=il?(a=this.x0+1*this.a*i*Math.sin(n)/s,o=this.y0+1*this.a*(this.cos_p14*e-this.sin_p14*i*r)/s):(a=this.x0+this.infinity_dist*i*Math.sin(n),o=this.y0+this.infinity_dist*(this.cos_p14*e-this.sin_p14*i*r)),t.x=a,t.y=o,t},inverse:function(t){var e,i,n,r,s,a;return t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,t.x/=this.k0,t.y/=this.k0,(e=Math.sqrt(t.x*t.x+t.y*t.y))?(r=Math.atan2(e,this.rc),i=Math.sin(r),a=mc((n=Math.cos(r))*this.sin_p14+t.y*i*this.cos_p14/e),s=Math.atan2(t.x*i,e*this.cos_p14*n-t.y*this.sin_p14*i),s=Rl(this.long0+s)):(a=this.phic0,s=0),t.x=s,t.y=a,t},names:["gnom"]};var yc={init:function(){this.sphere||(this.k0=Ll(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))},forward:function(t){var e,i,n=t.x,r=t.y,s=Rl(n-this.long0);if(this.sphere)e=this.x0+this.a*s*Math.cos(this.lat_ts),i=this.y0+this.a*Math.sin(r)/Math.cos(this.lat_ts);else{var a=oc(this.e,Math.sin(r));e=this.x0+this.a*this.k0*s,i=this.y0+this.a*a*.5/this.k0}return t.x=e,t.y=i,t},inverse:function(t){var e,i;return t.x-=this.x0,t.y-=this.y0,this.sphere?(e=Rl(this.long0+t.x/this.a/Math.cos(this.lat_ts)),i=Math.asin(t.y/this.a*Math.cos(this.lat_ts))):(i=function(t,e){var i=1-(1-t*t)/(2*t)*Math.log((1-t)/(1+t));if(Math.abs(Math.abs(e)-i)<1e-6)return e<0?-1*el:el;for(var n,r,s,a,o=Math.asin(.5*e),l=0;l<30;l++)if(r=Math.sin(o),s=Math.cos(o),a=t*r,o+=n=Math.pow(1-a*a,2)/(2*s)*(e/(1-t*t)-r/(1-a*a)+.5/t*Math.log((1-a)/(1+a))),Math.abs(n)<=1e-10)return o;return NaN}(this.e,2*t.y*this.k0/this.a),e=Rl(this.long0+t.x/(this.a*this.k0))),t.x=e,t.y=i,t},names:["cea"]};var xc={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Equidistant Cylindrical (Plate Carre)",this.rc=Math.cos(this.lat_ts)},forward:function(t){var e=t.x,i=t.y,n=Rl(e-this.long0),r=rc(i-this.lat0);return t.x=this.x0+this.a*n*this.rc,t.y=this.y0+this.a*r,t},inverse:function(t){var e=t.x,i=t.y;return t.x=Rl(this.long0+(e-this.x0)/(this.a*this.rc)),t.y=rc(this.lat0+(i-this.y0)/this.a),t},names:["Equirectangular","Equidistant_Cylindrical","eqc"]};var _c={init:function(){this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=$h(this.es),this.e1=tc(this.es),this.e2=ec(this.es),this.e3=ic(this.es),this.ml0=this.a*Qh(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(t){var e,i,n,r=t.x,s=t.y,a=Rl(r-this.long0);if(n=a*Math.sin(s),this.sphere)Math.abs(s)<=il?(e=this.a*a,i=-1*this.a*this.lat0):(e=this.a*Math.sin(n)/Math.tan(s),i=this.a*(rc(s-this.lat0)+(1-Math.cos(n))/Math.tan(s)));else if(Math.abs(s)<=il)e=this.a*a,i=-1*this.ml0;else{var o=nc(this.a,this.e,Math.sin(s))/Math.tan(s);e=o*Math.sin(n),i=this.a*Qh(this.e0,this.e1,this.e2,this.e3,s)-this.ml0+o*(1-Math.cos(n))}return t.x=e+this.x0,t.y=i+this.y0,t},inverse:function(t){var e,i,n,r,s,a,o,l,h;if(n=t.x-this.x0,r=t.y-this.y0,this.sphere)if(Math.abs(r+this.a*this.lat0)<=il)e=Rl(n/this.a+this.long0),i=0;else{var c;for(a=this.lat0+r/this.a,o=n*n/this.a/this.a+a*a,l=a,s=20;s;--s)if(l+=h=-1*(a*(l*(c=Math.tan(l))+1)-l-.5*(l*l+o)*c)/((l-a)/c-1),Math.abs(h)<=il){i=l;break}e=Rl(this.long0+Math.asin(n*Math.tan(l)/this.a)/Math.sin(i))}else if(Math.abs(r+this.ml0)<=il)i=0,e=Rl(this.long0+n/this.a);else{var u,d,p,f,m;for(a=(this.ml0+r)/this.a,o=n*n/this.a/this.a+a*a,l=a,s=20;s;--s)if(m=this.e*Math.sin(l),u=Math.sqrt(1-m*m)*Math.tan(l),d=this.a*Qh(this.e0,this.e1,this.e2,this.e3,l),p=this.e0-2*this.e1*Math.cos(2*l)+4*this.e2*Math.cos(4*l)-6*this.e3*Math.cos(6*l),l-=h=(a*(u*(f=d/this.a)+1)-f-.5*u*(f*f+o))/(this.es*Math.sin(2*l)*(f*f+o-2*a*f)/(4*u)+(a-f)*(u*p-2/Math.sin(2*l))-p),Math.abs(h)<=il){i=l;break}u=Math.sqrt(1-this.es*Math.pow(Math.sin(i),2))*Math.tan(i),e=Rl(this.long0+Math.asin(n*u/this.a)/Math.sin(i))}return t.x=e,t.y=i,t},names:["Polyconic","poly"]};var Mc={init:function(){this.A=[],this.A[1]=.6399175073,this.A[2]=-.1358797613,this.A[3]=.063294409,this.A[4]=-.02526853,this.A[5]=.0117879,this.A[6]=-.0055161,this.A[7]=.0026906,this.A[8]=-.001333,this.A[9]=67e-5,this.A[10]=-34e-5,this.B_re=[],this.B_im=[],this.B_re[1]=.7557853228,this.B_im[1]=0,this.B_re[2]=.249204646,this.B_im[2]=.003371507,this.B_re[3]=-.001541739,this.B_im[3]=.04105856,this.B_re[4]=-.10162907,this.B_im[4]=.01727609,this.B_re[5]=-.26623489,this.B_im[5]=-.36249218,this.B_re[6]=-.6870983,this.B_im[6]=-1.1651967,this.C_re=[],this.C_im=[],this.C_re[1]=1.3231270439,this.C_im[1]=0,this.C_re[2]=-.577245789,this.C_im[2]=-.007809598,this.C_re[3]=.508307513,this.C_im[3]=-.112208952,this.C_re[4]=-.15094762,this.C_im[4]=.18200602,this.C_re[5]=1.01418179,this.C_im[5]=1.64497696,this.C_re[6]=1.9660549,this.C_im[6]=2.5127645,this.D=[],this.D[1]=1.5627014243,this.D[2]=.5185406398,this.D[3]=-.03333098,this.D[4]=-.1052906,this.D[5]=-.0368594,this.D[6]=.007317,this.D[7]=.0122,this.D[8]=.00394,this.D[9]=-.0013},forward:function(t){var e,i=t.x,n=t.y-this.lat0,r=i-this.long0,s=n/tl*1e-5,a=r,o=1,l=0;for(e=1;e<=10;e++)o*=s,l+=this.A[e]*o;var h,c=l,u=a,d=1,p=0,f=0,m=0;for(e=1;e<=6;e++)h=p*c+d*u,d=d*c-p*u,p=h,f=f+this.B_re[e]*d-this.B_im[e]*p,m=m+this.B_im[e]*d+this.B_re[e]*p;return t.x=m*this.a+this.x0,t.y=f*this.a+this.y0,t},inverse:function(t){var e,i,n=t.x,r=t.y,s=n-this.x0,a=(r-this.y0)/this.a,o=s/this.a,l=1,h=0,c=0,u=0;for(e=1;e<=6;e++)i=h*a+l*o,l=l*a-h*o,h=i,c=c+this.C_re[e]*l-this.C_im[e]*h,u=u+this.C_im[e]*l+this.C_re[e]*h;for(var d=0;d<this.iterations;d++){var p,f=c,m=u,g=a,v=o;for(e=2;e<=6;e++)p=m*c+f*u,f=f*c-m*u,m=p,g+=(e-1)*(this.B_re[e]*f-this.B_im[e]*m),v+=(e-1)*(this.B_im[e]*f+this.B_re[e]*m);f=1,m=0;var y=this.B_re[1],x=this.B_im[1];for(e=2;e<=6;e++)p=m*c+f*u,f=f*c-m*u,m=p,y+=e*(this.B_re[e]*f-this.B_im[e]*m),x+=e*(this.B_im[e]*f+this.B_re[e]*m);var _=y*y+x*x;c=(g*y+v*x)/_,u=(v*y-g*x)/_}var M=c,b=u,S=1,w=0;for(e=1;e<=9;e++)S*=M,w+=this.D[e]*S;var E=this.lat0+w*tl*1e5,T=this.long0+b;return t.x=T,t.y=E,t},names:["New_Zealand_Map_Grid","nzmg"]};var bc={init:function(){},forward:function(t){var e=t.x,i=t.y,n=Rl(e-this.long0),r=this.x0+this.a*n,s=this.y0+this.a*Math.log(Math.tan(Math.PI/4+i/2.5))*1.25;return t.x=r,t.y=s,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var e=Rl(this.long0+t.x/this.a),i=2.5*(Math.atan(Math.exp(.8*t.y/this.a))-Math.PI/4);return t.x=e,t.y=i,t},names:["Miller_Cylindrical","mill"]};var Sc={init:function(){this.sphere?(this.n=1,this.m=0,this.es=0,this.C_y=Math.sqrt((this.m+1)/this.n),this.C_x=this.C_y/(this.m+1)):this.en=Dh(this.es)},forward:function(t){var e,i,n=t.x,r=t.y;if(n=Rl(n-this.long0),this.sphere){if(this.m)for(var s=this.n*Math.sin(r),a=20;a;--a){var o=(this.m*r+Math.sin(r)-s)/(this.m+Math.cos(r));if(r-=o,Math.abs(o)<il)break}else r=1!==this.n?Math.asin(this.n*Math.sin(r)):r;e=this.a*this.C_x*n*(this.m+Math.cos(r)),i=this.a*this.C_y*r}else{var l=Math.sin(r),h=Math.cos(r);i=this.a*Nh(r,l,h,this.en),e=this.a*n*h/Math.sqrt(1-this.es*l*l)}return t.x=e,t.y=i,t},inverse:function(t){var e,i,n;return t.x-=this.x0,i=t.x/this.a,t.y-=this.y0,e=t.y/this.a,this.sphere?(e/=this.C_y,i/=this.C_x*(this.m+Math.cos(e)),this.m?e=mc((this.m*e+Math.sin(e))/this.n):1!==this.n&&(e=mc(Math.sin(e)/this.n)),i=Rl(i+this.long0),e=rc(e)):(e=Ih(t.y/this.a,this.es,this.en),(n=Math.abs(e))<el?(n=Math.sin(e),i=Rl(this.long0+t.x*Math.sqrt(1-this.es*n*n)/(this.a*Math.cos(e)))):n-il<el&&(i=this.long0)),t.x=i,t.y=e,t},names:["Sinusoidal","sinu"]};var wc={init:function(){},forward:function(t){for(var e=t.x,i=t.y,n=Rl(e-this.long0),r=i,s=Math.PI*Math.sin(i);;){var a=-(r+Math.sin(r)-s)/(1+Math.cos(r));if(r+=a,Math.abs(a)<il)break}r/=2,Math.PI/2-Math.abs(i)<il&&(n=0);var o=.900316316158*this.a*n*Math.cos(r)+this.x0,l=1.4142135623731*this.a*Math.sin(r)+this.y0;return t.x=o,t.y=l,t},inverse:function(t){var e,i;t.x-=this.x0,t.y-=this.y0,i=t.y/(1.4142135623731*this.a),Math.abs(i)>.999999999999&&(i=.999999999999),e=Math.asin(i);var n=Rl(this.long0+t.x/(.900316316158*this.a*Math.cos(e)));n<-Math.PI&&(n=-Math.PI),n>Math.PI&&(n=Math.PI),i=(2*e+Math.sin(2*e))/Math.PI,Math.abs(i)>1&&(i=1);var r=Math.asin(i);return t.x=n,t.y=r,t},names:["Mollweide","moll"]};var Ec={init:function(){Math.abs(this.lat1+this.lat2)<il||(this.lat2=this.lat2||this.lat1,this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=$h(this.es),this.e1=tc(this.es),this.e2=ec(this.es),this.e3=ic(this.es),this.sinphi=Math.sin(this.lat1),this.cosphi=Math.cos(this.lat1),this.ms1=Ll(this.e,this.sinphi,this.cosphi),this.ml1=Qh(this.e0,this.e1,this.e2,this.e3,this.lat1),Math.abs(this.lat1-this.lat2)<il?this.ns=this.sinphi:(this.sinphi=Math.sin(this.lat2),this.cosphi=Math.cos(this.lat2),this.ms2=Ll(this.e,this.sinphi,this.cosphi),this.ml2=Qh(this.e0,this.e1,this.e2,this.e3,this.lat2),this.ns=(this.ms1-this.ms2)/(this.ml2-this.ml1)),this.g=this.ml1+this.ms1/this.ns,this.ml0=Qh(this.e0,this.e1,this.e2,this.e3,this.lat0),this.rh=this.a*(this.g-this.ml0))},forward:function(t){var e,i=t.x,n=t.y;if(this.sphere)e=this.a*(this.g-n);else{var r=Qh(this.e0,this.e1,this.e2,this.e3,n);e=this.a*(this.g-r)}var s=this.ns*Rl(i-this.long0),a=this.x0+e*Math.sin(s),o=this.y0+this.rh-e*Math.cos(s);return t.x=a,t.y=o,t},inverse:function(t){var e,i,n,r;t.x-=this.x0,t.y=this.rh-t.y+this.y0,this.ns>=0?(i=Math.sqrt(t.x*t.x+t.y*t.y),e=1):(i=-Math.sqrt(t.x*t.x+t.y*t.y),e=-1);var s=0;return 0!==i&&(s=Math.atan2(e*t.x,e*t.y)),this.sphere?(r=Rl(this.long0+s/this.ns),n=rc(this.g-i/this.a),t.x=r,t.y=n,t):(n=sc(this.g-i/this.a,this.e0,this.e1,this.e2,this.e3),r=Rl(this.long0+s/this.ns),t.x=r,t.y=n,t)},names:["Equidistant_Conic","eqdc"]};var Tc={init:function(){this.R=this.a},forward:function(t){var e,i,n=t.x,r=t.y,s=Rl(n-this.long0);Math.abs(r)<=il&&(e=this.x0+this.R*s,i=this.y0);var a=mc(2*Math.abs(r/Math.PI));(Math.abs(s)<=il||Math.abs(Math.abs(r)-el)<=il)&&(e=this.x0,i=r>=0?this.y0+Math.PI*this.R*Math.tan(.5*a):this.y0+Math.PI*this.R*-Math.tan(.5*a));var o=.5*Math.abs(Math.PI/s-s/Math.PI),l=o*o,h=Math.sin(a),c=Math.cos(a),u=c/(h+c-1),d=u*u,p=u*(2/h-1),f=p*p,m=Math.PI*this.R*(o*(u-f)+Math.sqrt(l*(u-f)*(u-f)-(f+l)*(d-f)))/(f+l);s<0&&(m=-m),e=this.x0+m;var g=l+u;return m=Math.PI*this.R*(p*g-o*Math.sqrt((f+l)*(l+1)-g*g))/(f+l),i=r>=0?this.y0+m:this.y0-m,t.x=e,t.y=i,t},inverse:function(t){var e,i,n,r,s,a,o,l,h,c,u,d;return t.x-=this.x0,t.y-=this.y0,u=Math.PI*this.R,s=(n=t.x/u)*n+(r=t.y/u)*r,u=3*(r*r/(l=-2*(a=-Math.abs(r)*(1+s))+1+2*r*r+s*s)+(2*(o=a-2*r*r+n*n)*o*o/l/l/l-9*a*o/l/l)/27)/(h=(a-o*o/3/l)/l)/(c=2*Math.sqrt(-h/3)),Math.abs(u)>1&&(u=u>=0?1:-1),d=Math.acos(u)/3,i=t.y>=0?(-c*Math.cos(d+Math.PI/3)-o/3/l)*Math.PI:-(-c*Math.cos(d+Math.PI/3)-o/3/l)*Math.PI,e=Math.abs(n)<il?this.long0:Rl(this.long0+Math.PI*(s-1+Math.sqrt(1+2*(n*n-r*r)+s*s))/2/n),t.x=e,t.y=i,t},names:["Van_der_Grinten_I","VanDerGrinten","vandg"]};var Cc={init:function(){this.sin_p12=Math.sin(this.lat0),this.cos_p12=Math.cos(this.lat0)},forward:function(t){var e,i,n,r,s,a,o,l,h,c,u,d,p,f,m,g,v,y,x,_,M,b,S=t.x,w=t.y,E=Math.sin(t.y),T=Math.cos(t.y),C=Rl(S-this.long0);return this.sphere?Math.abs(this.sin_p12-1)<=il?(t.x=this.x0+this.a*(el-w)*Math.sin(C),t.y=this.y0-this.a*(el-w)*Math.cos(C),t):Math.abs(this.sin_p12+1)<=il?(t.x=this.x0+this.a*(el+w)*Math.sin(C),t.y=this.y0+this.a*(el+w)*Math.cos(C),t):(y=this.sin_p12*E+this.cos_p12*T*Math.cos(C),v=(g=Math.acos(y))?g/Math.sin(g):1,t.x=this.x0+this.a*v*T*Math.sin(C),t.y=this.y0+this.a*v*(this.cos_p12*E-this.sin_p12*T*Math.cos(C)),t):(e=$h(this.es),i=tc(this.es),n=ec(this.es),r=ic(this.es),Math.abs(this.sin_p12-1)<=il?(s=this.a*Qh(e,i,n,r,el),a=this.a*Qh(e,i,n,r,w),t.x=this.x0+(s-a)*Math.sin(C),t.y=this.y0-(s-a)*Math.cos(C),t):Math.abs(this.sin_p12+1)<=il?(s=this.a*Qh(e,i,n,r,el),a=this.a*Qh(e,i,n,r,w),t.x=this.x0+(s+a)*Math.sin(C),t.y=this.y0+(s+a)*Math.cos(C),t):(o=E/T,l=nc(this.a,this.e,this.sin_p12),h=nc(this.a,this.e,E),c=Math.atan((1-this.es)*o+this.es*l*this.sin_p12/(h*T)),x=0===(u=Math.atan2(Math.sin(C),this.cos_p12*Math.tan(c)-this.sin_p12*Math.cos(C)))?Math.asin(this.cos_p12*Math.sin(c)-this.sin_p12*Math.cos(c)):Math.abs(Math.abs(u)-Math.PI)<=il?-Math.asin(this.cos_p12*Math.sin(c)-this.sin_p12*Math.cos(c)):Math.asin(Math.sin(C)*Math.cos(c)/Math.sin(u)),d=this.e*this.sin_p12/Math.sqrt(1-this.es),g=l*x*(1-(_=x*x)*(m=(p=this.e*this.cos_p12*Math.cos(u)/Math.sqrt(1-this.es))*p)*(1-m)/6+(M=_*x)/8*(f=d*p)*(1-2*m)+(b=M*x)/120*(m*(4-7*m)-3*d*d*(1-7*m))-b*x/48*f),t.x=this.x0+g*Math.sin(u),t.y=this.y0+g*Math.cos(u),t))},inverse:function(t){var e,i,n,r,s,a,o,l,h,c,u,d,p,f,m,g,v,y,x,_,M,b,S;if(t.x-=this.x0,t.y-=this.y0,this.sphere){if((e=Math.sqrt(t.x*t.x+t.y*t.y))>2*el*this.a)return;return i=e/this.a,n=Math.sin(i),r=Math.cos(i),s=this.long0,Math.abs(e)<=il?a=this.lat0:(a=mc(r*this.sin_p12+t.y*n*this.cos_p12/e),o=Math.abs(this.lat0)-el,s=Math.abs(o)<=il?this.lat0>=0?Rl(this.long0+Math.atan2(t.x,-t.y)):Rl(this.long0-Math.atan2(-t.x,t.y)):Rl(this.long0+Math.atan2(t.x*n,e*this.cos_p12*r-t.y*this.sin_p12*n))),t.x=s,t.y=a,t}return l=$h(this.es),h=tc(this.es),c=ec(this.es),u=ic(this.es),Math.abs(this.sin_p12-1)<=il?(a=sc(((d=this.a*Qh(l,h,c,u,el))-(e=Math.sqrt(t.x*t.x+t.y*t.y)))/this.a,l,h,c,u),s=Rl(this.long0+Math.atan2(t.x,-1*t.y)),t.x=s,t.y=a,t):Math.abs(this.sin_p12+1)<=il?(d=this.a*Qh(l,h,c,u,el),a=sc(((e=Math.sqrt(t.x*t.x+t.y*t.y))-d)/this.a,l,h,c,u),s=Rl(this.long0+Math.atan2(t.x,t.y)),t.x=s,t.y=a,t):(e=Math.sqrt(t.x*t.x+t.y*t.y),m=Math.atan2(t.x,t.y),p=nc(this.a,this.e,this.sin_p12),g=Math.cos(m),y=-(v=this.e*this.cos_p12*g)*v/(1-this.es),x=3*this.es*(1-y)*this.sin_p12*this.cos_p12*g/(1-this.es),b=1-y*(M=(_=e/p)-y*(1+y)*Math.pow(_,3)/6-x*(1+3*y)*Math.pow(_,4)/24)*M/2-_*M*M*M/6,f=Math.asin(this.sin_p12*Math.cos(M)+this.cos_p12*Math.sin(M)*g),s=Rl(this.long0+Math.asin(Math.sin(m)*Math.sin(M)/Math.cos(f))),S=Math.sin(f),a=Math.atan2((S-this.es*b*this.sin_p12)*Math.tan(f),S*(1-this.es)),t.x=s,t.y=a,t)},names:["Azimuthal_Equidistant","aeqd"]};var Lc={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0)},forward:function(t){var e,i,n,r,s,a,o,l=t.x,h=t.y;return n=Rl(l-this.long0),e=Math.sin(h),i=Math.cos(h),r=Math.cos(n),1,((s=this.sin_p14*e+this.cos_p14*i*r)>0||Math.abs(s)<=il)&&(a=1*this.a*i*Math.sin(n),o=this.y0+1*this.a*(this.cos_p14*e-this.sin_p14*i*r)),t.x=a,t.y=o,t},inverse:function(t){var e,i,n,r,s,a,o;return t.x-=this.x0,t.y-=this.y0,i=mc((e=Math.sqrt(t.x*t.x+t.y*t.y))/this.a),n=Math.sin(i),r=Math.cos(i),a=this.long0,Math.abs(e)<=il?(o=this.lat0,t.x=a,t.y=o,t):(o=mc(r*this.sin_p14+t.y*n*this.cos_p14/e),s=Math.abs(this.lat0)-el,Math.abs(s)<=il?(a=this.lat0>=0?Rl(this.long0+Math.atan2(t.x,-t.y)):Rl(this.long0-Math.atan2(-t.x,t.y)),t.x=a,t.y=o,t):(a=Rl(this.long0+Math.atan2(t.x*n,e*this.cos_p14*r-t.y*this.sin_p14*n)),t.x=a,t.y=o,t))},names:["ortho"]},Ac=1,Rc=2,Pc=3,Dc=4,Nc=5,Ic=6,Fc=1,Oc=2,zc=3,Uc=4;function Bc(t,e,i,n){var r;return t<il?(n.value=Fc,r=0):(r=Math.atan2(e,i),Math.abs(r)<=sl?n.value=Fc:r>sl&&r<=el+sl?(n.value=Oc,r-=el):r>el+sl||r<=-(el+sl)?(n.value=zc,r=r>=0?r-ol:r+ol):(n.value=Uc,r+=el)),r}function kc(t,e){var i=t+e;return i<-ol?i+=al:i>+ol&&(i-=al),i}var Gc={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Quadrilateralized Spherical Cube",this.lat0>=el-sl/2?this.face=Nc:this.lat0<=-(el-sl/2)?this.face=Ic:Math.abs(this.long0)<=sl?this.face=Ac:Math.abs(this.long0)<=el+sl?this.face=this.long0>0?Rc:Dc:this.face=Pc,0!==this.es&&(this.one_minus_f=1-(this.a-this.b)/this.a,this.one_minus_f_squared=this.one_minus_f*this.one_minus_f)},forward:function(t){var e,i,n,r,s,a,o={x:0,y:0},l={value:0};if(t.x-=this.long0,e=0!==this.es?Math.atan(this.one_minus_f_squared*Math.tan(t.y)):t.y,i=t.x,this.face===Nc)r=el-e,i>=sl&&i<=el+sl?(l.value=Fc,n=i-el):i>el+sl||i<=-(el+sl)?(l.value=Oc,n=i>0?i-ol:i+ol):i>-(el+sl)&&i<=-sl?(l.value=zc,n=i+el):(l.value=Uc,n=i);else if(this.face===Ic)r=el+e,i>=sl&&i<=el+sl?(l.value=Fc,n=-i+el):i<sl&&i>=-sl?(l.value=Oc,n=-i):i<-sl&&i>=-(el+sl)?(l.value=zc,n=-i-el):(l.value=Uc,n=i>0?-i+ol:-i-ol);else{var h,c,u,d,p,f;this.face===Rc?i=kc(i,+el):this.face===Pc?i=kc(i,+ol):this.face===Dc&&(i=kc(i,-el)),d=Math.sin(e),p=Math.cos(e),f=Math.sin(i),h=p*Math.cos(i),c=p*f,u=d,this.face===Ac?n=Bc(r=Math.acos(h),u,c,l):this.face===Rc?n=Bc(r=Math.acos(c),u,-h,l):this.face===Pc?n=Bc(r=Math.acos(-h),u,-c,l):this.face===Dc?n=Bc(r=Math.acos(-c),u,h,l):(r=n=0,l.value=Fc)}return a=Math.atan(12/ol*(n+Math.acos(Math.sin(n)*Math.cos(sl))-el)),s=Math.sqrt((1-Math.cos(r))/(Math.cos(a)*Math.cos(a))/(1-Math.cos(Math.atan(1/Math.cos(n))))),l.value===Oc?a+=el:l.value===zc?a+=ol:l.value===Uc&&(a+=1.5*ol),o.x=s*Math.cos(a),o.y=s*Math.sin(a),o.x=o.x*this.a+this.x0,o.y=o.y*this.a+this.y0,t.x=o.x,t.y=o.y,t},inverse:function(t){var e,i,n,r,s,a,o,l,h,c,u,d,p={lam:0,phi:0},f={value:0};if(t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,i=Math.atan(Math.sqrt(t.x*t.x+t.y*t.y)),e=Math.atan2(t.y,t.x),t.x>=0&&t.x>=Math.abs(t.y)?f.value=Fc:t.y>=0&&t.y>=Math.abs(t.x)?(f.value=Oc,e-=el):t.x<0&&-t.x>=Math.abs(t.y)?(f.value=zc,e=e<0?e+ol:e-ol):(f.value=Uc,e+=el),h=ol/12*Math.tan(e),s=Math.sin(h)/(Math.cos(h)-1/Math.sqrt(2)),a=Math.atan(s),(o=1-(n=Math.cos(e))*n*(r=Math.tan(i))*r*(1-Math.cos(Math.atan(1/Math.cos(a)))))<-1?o=-1:o>1&&(o=1),this.face===Nc)l=Math.acos(o),p.phi=el-l,f.value===Fc?p.lam=a+el:f.value===Oc?p.lam=a<0?a+ol:a-ol:f.value===zc?p.lam=a-el:p.lam=a;else if(this.face===Ic)l=Math.acos(o),p.phi=l-el,f.value===Fc?p.lam=-a+el:f.value===Oc?p.lam=-a:f.value===zc?p.lam=-a-el:p.lam=a<0?-a-ol:-a+ol;else{var m,g,v;h=(m=o)*m,g=(h+=(v=h>=1?0:Math.sqrt(1-h)*Math.sin(a))*v)>=1?0:Math.sqrt(1-h),f.value===Oc?(h=g,g=-v,v=h):f.value===zc?(g=-g,v=-v):f.value===Uc&&(h=g,g=v,v=-h),this.face===Rc?(h=m,m=-g,g=h):this.face===Pc?(m=-m,g=-g):this.face===Dc&&(h=m,m=g,g=-h),p.phi=Math.acos(-v)-el,p.lam=Math.atan2(g,m),this.face===Rc?p.lam=kc(p.lam,-el):this.face===Pc?p.lam=kc(p.lam,-ol):this.face===Dc&&(p.lam=kc(p.lam,+el))}return 0!==this.es&&(c=p.phi<0?1:0,u=Math.tan(p.phi),d=this.b/Math.sqrt(u*u+this.one_minus_f_squared),p.phi=Math.atan(Math.sqrt(this.a*this.a-d*d)/(this.one_minus_f*d)),c&&(p.phi=-p.phi)),p.lam+=this.long0,t.x=p.lam,t.y=p.phi,t},names:["Quadrilateralized Spherical Cube","Quadrilateralized_Spherical_Cube","qsc"]},Hc=[[1,22199e-21,-715515e-10,31103e-10],[.9986,-482243e-9,-24897e-9,-13309e-10],[.9954,-83103e-8,-448605e-10,-9.86701e-7],[.99,-.00135364,-59661e-9,36777e-10],[.9822,-.00167442,-449547e-11,-572411e-11],[.973,-.00214868,-903571e-10,1.8736e-8],[.96,-.00305085,-900761e-10,164917e-11],[.9427,-.00382792,-653386e-10,-26154e-10],[.9216,-.00467746,-10457e-8,481243e-11],[.8962,-.00536223,-323831e-10,-543432e-11],[.8679,-.00609363,-113898e-9,332484e-11],[.835,-.00698325,-640253e-10,9.34959e-7],[.7986,-.00755338,-500009e-10,9.35324e-7],[.7597,-.00798324,-35971e-9,-227626e-11],[.7186,-.00851367,-701149e-10,-86303e-10],[.6732,-.00986209,-199569e-9,191974e-10],[.6213,-.010418,883923e-10,624051e-11],[.5722,-.00906601,182e-6,624051e-11],[.5322,-.00677797,275608e-9,624051e-11]],Vc=[[-520417e-23,.0124,121431e-23,-845284e-16],[.062,.0124,-1.26793e-9,4.22642e-10],[.124,.0124,5.07171e-9,-1.60604e-9],[.186,.0123999,-1.90189e-8,6.00152e-9],[.248,.0124002,7.10039e-8,-2.24e-8],[.31,.0123992,-2.64997e-7,8.35986e-8],[.372,.0124029,9.88983e-7,-3.11994e-7],[.434,.0123893,-369093e-11,-4.35621e-7],[.4958,.0123198,-102252e-10,-3.45523e-7],[.5571,.0121916,-154081e-10,-5.82288e-7],[.6176,.0119938,-241424e-10,-5.25327e-7],[.6769,.011713,-320223e-10,-5.16405e-7],[.7346,.0113541,-397684e-10,-6.09052e-7],[.7903,.0109107,-489042e-10,-104739e-11],[.8435,.0103431,-64615e-9,-1.40374e-9],[.8936,.00969686,-64636e-9,-8547e-9],[.9394,.00840947,-192841e-9,-42106e-10],[.9761,.00616527,-256e-6,-42106e-10],[1,.00328947,-319159e-9,-42106e-10]],Wc=.8487,jc=1.3523,Xc=rl/5,qc=18,Yc=function(t,e){return t[0]+e*(t[1]+e*(t[2]+e*t[3]))};var Zc={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.long0=this.long0||0,this.es=0,this.title=this.title||"Robinson"},forward:function(t){var e=Rl(t.x-this.long0),i=Math.abs(t.y),n=Math.floor(i*Xc);n<0?n=0:n>=qc&&(n=17);var r={x:Yc(Hc[n],i=rl*(i-.08726646259971647*n))*e,y:Yc(Vc[n],i)};return t.y<0&&(r.y=-r.y),r.x=r.x*this.a*Wc+this.x0,r.y=r.y*this.a*jc+this.y0,r},inverse:function(t){var e={x:(t.x-this.x0)/(this.a*Wc),y:Math.abs(t.y-this.y0)/(this.a*jc)};if(e.y>=1)e.x/=Hc[18][0],e.y=t.y<0?-el:el;else{var i=Math.floor(e.y*qc);for(i<0?i=0:i>=qc&&(i=17);;)if(Vc[i][0]>e.y)--i;else{if(!(Vc[i+1][0]<=e.y))break;++i}var n=Vc[i],r=5*(e.y-n[0])/(Vc[i+1][0]-n[0]);r=function(t,e,i,n){for(var r=e;n;--n){var s=t(r);if(r-=s,Math.abs(s)<i)break}return r}((function(t){return(Yc(n,t)-e.y)/function(t,e){return t[1]+e*(2*t[2]+3*e*t[3])}(n,t)}),r,il,100),e.x/=Yc(Hc[i],r),e.y=(5*i+r)*nl,t.y<0&&(e.y=-e.y)}return e.x=Rl(e.x+this.long0),e},names:["Robinson","robin"]};var Jc={init:function(){this.name="geocent"},forward:function(t){return Jl(t,this.es,this.a)},inverse:function(t){return Kl(t,this.es,this.a,this.b)},names:["Geocentric","geocentric","geocent","Geocent"]},Kc=0,Qc=1,$c=2,tu=3,eu={h:{def:1e5,num:!0},azi:{def:0,num:!0,degrees:!0},tilt:{def:0,num:!0,degrees:!0},long0:{def:0,num:!0},lat0:{def:0,num:!0}};var iu={init:function(){if(Object.keys(eu).forEach(function(t){if(void 0===this[t])this[t]=eu[t].def;else{if(eu[t].num&&isNaN(this[t]))throw new Error("Invalid parameter value, must be numeric "+t+" = "+this[t]);eu[t].num&&(this[t]=parseFloat(this[t]))}eu[t].degrees&&(this[t]=this[t]*nl)}.bind(this)),Math.abs(Math.abs(this.lat0)-el)<il?this.mode=this.lat0<0?Qc:Kc:Math.abs(this.lat0)<il?this.mode=$c:(this.mode=tu,this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0)),this.pn1=this.h/this.a,this.pn1<=0||this.pn1>1e10)throw new Error("Invalid height");this.p=1+this.pn1,this.rp=1/this.p,this.h1=1/this.pn1,this.pfact=(this.p+1)*this.h1,this.es=0;var t=this.tilt,e=this.azi;this.cg=Math.cos(e),this.sg=Math.sin(e),this.cw=Math.cos(t),this.sw=Math.sin(t)},forward:function(t){t.x-=this.long0;var e,i,n,r,s=Math.sin(t.y),a=Math.cos(t.y),o=Math.cos(t.x);switch(this.mode){case tu:i=this.sinph0*s+this.cosph0*a*o;break;case $c:i=a*o;break;case Qc:i=-s;break;case Kc:i=s}switch(e=(i=this.pn1/(this.p-i))*a*Math.sin(t.x),this.mode){case tu:i*=this.cosph0*s-this.sinph0*a*o;break;case $c:i*=s;break;case Kc:i*=-a*o;break;case Qc:i*=a*o}return r=1/((n=i*this.cg+e*this.sg)*this.sw*this.h1+this.cw),e=(e*this.cg-i*this.sg)*this.cw*r,i=n*r,t.x=e*this.a,t.y=i*this.a,t},inverse:function(t){t.x/=this.a,t.y/=this.a;var e,i,n,r={x:t.x,y:t.y};n=1/(this.pn1-t.y*this.sw),e=this.pn1*t.x*n,i=this.pn1*t.y*this.cw*n,t.x=e*this.cg+i*this.sg,t.y=i*this.cg-e*this.sg;var s=zh(t.x,t.y);if(Math.abs(s)<il)r.x=0,r.y=t.y;else{var a,o;switch(o=1-s*s*this.pfact,o=(this.p-Math.sqrt(o))/(this.pn1/s+s/this.pn1),a=Math.sqrt(1-o*o),this.mode){case tu:r.y=Math.asin(a*this.sinph0+t.y*o*this.cosph0/s),t.y=(a-this.sinph0*Math.sin(r.y))*s,t.x*=o*this.cosph0;break;case $c:r.y=Math.asin(t.y*o/s),t.y=a*s,t.x*=o;break;case Kc:r.y=Math.asin(a),t.y=-t.y;break;case Qc:r.y=-Math.asin(a)}r.x=Math.atan2(t.x,t.y)}return t.x=r.x+this.long0,t.y=r.y,t},names:["Tilted_Perspective","tpers"]};function nu(t){this.surveyTree=new Ko,this.limits=new ct,this.offsets=new ot,this.allStations=[],this.lineSegments=[],this.xGroups=[],this.scraps=[],this.terrains=[],this.sourceCRS=null,this.targetCRS="EPSG:3857",this.displayCRS=null,this.projection=null,this.hasTerrain=!1,this.messages=[],this.metadata=null,this.fileCount=0,this.ctx=t}ch.defaultDatum="WGS84",ch.Proj=Zl,ch.WGS84=new ch.Proj("WGS84"),ch.Point=Lh,ch.toPoint=rh,ch.defs=Sl,ch.nadgrid=function(t,e){var i=new DataView(e),n=function(t){var e=t.getInt32(8,!1);if(11===e)return!1;11!==(e=t.getInt32(8,!0))&&console.warn("Failed to detect nadgrid endian-ness, defaulting to little-endian");return!0}(i),r=function(t,e){return{nFields:t.getInt32(8,e),nSubgridFields:t.getInt32(24,e),nSubgrids:t.getInt32(40,e),shiftType:jl(t,56,64).trim(),fromSemiMajorAxis:t.getFloat64(120,e),fromSemiMinorAxis:t.getFloat64(136,e),toSemiMajorAxis:t.getFloat64(152,e),toSemiMinorAxis:t.getFloat64(168,e)}}(i,n);r.nSubgrids>1&&console.log("Only single NTv2 subgrids are currently supported, subsequent sub grids are ignored");var s={header:r,subgrids:function(t,e,i){for(var n=176,r=[],s=0;s<e.nSubgrids;s++){var a=ql(t,n,i),o=Yl(t,n,a,i),l=Math.round(1+(a.upperLongitude-a.lowerLongitude)/a.longitudeInterval),h=Math.round(1+(a.upperLatitude-a.lowerLatitude)/a.latitudeInterval);r.push({ll:[Wl(a.lowerLongitude),Wl(a.lowerLatitude)],del:[Wl(a.longitudeInterval),Wl(a.latitudeInterval)],lim:[l,h],count:a.gridNodeCount,cvs:Xl(o)})}return r}(i,r,n)};return Hl[t]=s,s},ch.transform=ah,ch.mgrs=yh,ch.version="__VERSION__",function(t){t.Proj.projections.add(Fh),t.Proj.projections.add(Gh),t.Proj.projections.add(Hh),t.Proj.projections.add(jh),t.Proj.projections.add(Xh),t.Proj.projections.add(qh),t.Proj.projections.add(Zh),t.Proj.projections.add(Jh),t.Proj.projections.add(Kh),t.Proj.projections.add(ac),t.Proj.projections.add(fc),t.Proj.projections.add(gc),t.Proj.projections.add(vc),t.Proj.projections.add(yc),t.Proj.projections.add(xc),t.Proj.projections.add(_c),t.Proj.projections.add(Mc),t.Proj.projections.add(bc),t.Proj.projections.add(Sc),t.Proj.projections.add(wc),t.Proj.projections.add(Ec),t.Proj.projections.add(Tc),t.Proj.projections.add(Cc),t.Proj.projections.add(Lc),t.Proj.projections.add(Gc),t.Proj.projections.add(Zc),t.Proj.projections.add(Jc),t.Proj.projections.add(iu)}(ch),nu.prototype.setCRS=function(t){if(null!==t){const i=t.match(/\+init=(.*)\s/);if(i&&2===i.length){const n=i[1];var e;switch(n){case"epsg:27700":t="+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs";break;default:if(null!=(e=n.match(/epsg:([0-9]+)/)))return console.log("looking up CRS code EPSG:"+e[1]),fetch("https://epsg.io/"+e[1]+".proj4").then((t=>t.text())).then((t=>{this._setCRS(t)})).catch((function(){console.log("CRS lookup failed")}));console.log("Unsupported projection:",t),t=null}}}return this._setCRS(t),Promise.resolve(null)},nu.prototype._setCRS=function(t){const e=this.ctx.cfg,i=e.value("displayCRS","EPSG:3857");null===t&&null!==(t=e.value("defaultCRS",null))&&console.log("Using default projection."),null!==t&&(this.sourceCRS=t,"ORIGINAL"===i?this.displayCRS="ORIGINAL":(console.log("Reprojecting from",t,"to",this.targetCRS),this.projection=ch(this.sourceCRS,this.targetCRS),this.displayCRS=this.targetCRS))},nu.prototype.addStations=function(t){this.fileCount++,this.allStations.push(t)},nu.prototype.addLineSegments=function(t){const e=this.lineSegments,i=t.length;var n;for(n=0;n<i;n++){const i=t[n],r=i.length-1;let s;for(s=0;s<r;s++){const t=i[s],n=i[s+1],r=t.coords,a=n.coords;e.push({from:r,to:a,type:n.type,survey:n.survey})}}},nu.prototype.addXsects=function(t){const e=[],i=[];var n,r,s;for(t.sort((function(t,e){return t.m_from-e.m_from})),s=0;s<t.length;s++){const i=t[s];i.m_from!==n&&(r=[],e.push(r)),n=i.m_to,r.push(i)}for(s=0;s<e.length;s++){const t=e[s],n=t[0].m_from,r=t[t.length-1].m_to,a=i.indexOf(n);-1!==a&&(e[s]=e[a].concat(t),e[a]=[],i[a]=void 0),i.push(r)}for(s=0;s<e.length;s++){const t=e[s];if(t.length<2)continue;const i=t[0],n=t[1];if(void 0===i)continue;const r=n.start,a=n.end;i.start=(new ot).copy(r).multiplyScalar(2).sub(a),this.xGroups.push(t)}},nu.prototype.getSurvey=function(){const t=this.limits;if(!this.hasTerrain){const e=t.min,i=t.max;t.expandByVector(new ot(.05*(i.x-e.x),.05*(i.y-e.y),0))}const e=t.getCenter(this.offsets);this.allStations.forEach((t=>t.forEach((t=>t.sub(e)))));const i=this.scraps;var n,r;for(n=0;n<i.length;n++){const t=i[n].vertices;for(r=0;r<t.length;r++)t[r].sub(e)}return{title:this.fileName,surveyTree:this.surveyTree,sourceCRS:this.sourceCRS,displayCRS:this.displayCRS,lineSegments:this.lineSegments,crossSections:this.xGroups,scraps:this.scraps,hasTerrain:this.hasTerrain,metadata:this.metadata,terrains:this.terrains,limits:this.limits,offsets:this.offsets}};class ru extends c{constructor(t,e){super(),e||alert("No callback specified"),this.callback=e,this.dataResponse=null,this.metadataResponse=null,this.requests=[],this.ctx=t,this.reset()}}ru.prototype.reset=function(){this.files=null,this.handler=null,this.section=null,this.requests.forEach((t=>t.abort())),this.requests=[],this.models=new nu(this.ctx)},ru.prototype.setHandler=function(t){const e=t.split(".").reverse().shift().toLowerCase();switch(e){case"3d":this.handler=new Wo(t);break;case"lox":this.handler=new Yo(t);break;case"plt":this.handler=new Jo(t);break;default:return console.warn("CaveView: unknown file extension [",e,"]"),!1}return!0},ru.prototype.loadFile=function(t,e){t instanceof File?this.loadLocalFile(t,e):this.loadURL(t,e)},ru.prototype.loadFiles=function(t){this.files=t,this.loadFile(t.pop())},ru.prototype.loadURL=function(t,e){const i=this.ctx.cfg;this.dispatchEvent({type:"progress",name:"start"}),void 0!==e&&(this.section=e);const n=this,r=i.value("surveyDirectory",""),s=i.value("loadMetadata",!1);if(!this.setHandler(t))return!1;const a=s?2:1;var o=0;const l=(new $s).setPath(r);if(s){l.setResponseType("json");const e=l.load(Go(t,"json"),(function(t){n.metadataResponse=t,++o===a&&n.callHandler()}),void 0,(function(t){if("abort"===t.type)return;++o===a&&n.callHandler()}));e&&this.requests.push(e)}l.setResponseType(this.handler.type);const h=l.load(t,(function(t){n.dataResponse=t,++o===a&&n.callHandler()}),(function(t){t.total>0&&n.dispatchEvent({type:"progress",name:"set",progress:Math.round(100*t.loaded/t.total)})}),(function(t){if("abort"===t.type)return;console.warn("error event",t),++o===a&&n.callHandler()}));return h&&this.requests.push(h),!0},ru.prototype.loadLocalFile=function(t,e){this.dispatchEvent({type:"progress",name:"start"}),void 0!==e&&(this.section=e);const i=this,n=t.name;if(!this.setHandler(n))return!1;const r=new FileReader;switch(r.addEventListener("load",(function t(){i.dataResponse=r.result,i.callHandler(),r.removeEventListener("load",t),r.removeEventListener("progress",s)})),r.addEventListener("progress",s),this.handler.type){case"arraybuffer":r.readAsArrayBuffer(t);break;case"text":r.readAsText(t);break;default:return alert("unknown file data type"),!1}return!0;function s(t){t.total>0&&i.dispatchEvent({type:"progress",name:"set",progress:Math.round(100*t.loaded/t.total)})}},ru.prototype.callHandler=function(){if(null===this.dataResponse)return this.callback(!1),void this.dispatchEvent({type:"progress",name:"end"});const t=this.dataResponse,e=this.metadataResponse,i=this.section,n=this.files;this.dataResponse=null,this.metadataResponse=null;const r=null!==n&&n.length>0,s=this.handler;this.handler=null,r&&this.loadFile(n.pop()),s.parse(this.models,t,e,i).then((t=>{r||(this.callback(t),this.dispatchEvent({type:"progress",name:"end"}))}))};class su extends Us{constructor(t,e){const i=e.materials;void 0===i.pointGeometry&&(i.pointGeometry=(new De).setAttribute("position",new se([0,0,0],3))),super(i.pointGeometry,t),this.type="Point"}}class au extends su{constructor(t,e){super(t.materials.getClusterMaterial(e),t),this.renderOrder=1}}au.prototype.isMarker=!0,au.prototype.adjustHeight=function(t){this.position.setZ(t(this.position)+10)};const ou=new ot,lu=new ot,hu=new ot,cu=new ot,uu=new si(ou,lu,hu),du=new si(ou,hu,cu),pu=new Nt,fu=new ot;function mu(t,e,i,n,r){this.nodes=new Array(4),this.count=0,this.markers=[],this.quadMarker=null,this.centroid=new ot,this.ctx=t,this.xMin=e,this.xMax=i,this.yMin=n,this.yMax=r}mu.prototype.addNode=function(t,e){if(0==e--)return;const i=t.position,n=this.ctx,r=(this.xMin+this.xMax)/2,s=(this.yMin+this.yMax)/2;this.markers.push(t),this.centroid.add(i),this.count++;var a=0;i.x>r&&(a+=1),i.y>s&&(a+=2);var o=this.nodes[a];if(void 0===o){switch(a){case 0:o=new mu(n,this.xMin,r,this.yMin,s);break;case 1:o=new mu(n,r,this.xMax,this.yMin,s);break;case 2:o=new mu(n,this.xMin,r,s,this.yMax);break;case 3:o=new mu(n,r,this.xMax,s,this.yMax)}this.nodes[a]=o}o.addNode(t,e)},mu.prototype.check=function(t,e,i,n){var r,s;for(s=0;s<4;s++)if(void 0!==(r=this.nodes[s])){if(r.count<2){this.nodes[s]=void 0;continue}const a=r.projectedArea(t);ou.subVectors(t.camera.position,e);const o=2*ou.length();ou.normalize(),pu.setFromNormalAndCoplanarPoint(ou,t.camera.position),null===this.quadMarker?lu.copy(this.centroid.clone().divideScalar(this.count)).applyMatrix4(t.matrixWorld):lu.copy(this.quadMarker.position).applyMatrix4(t.matrixWorld);a<10*((o-Math.abs(pu.distanceToPoint(lu)))/o)*i?r.clusterMarkers(t):(r.showMarkers(n),r.check(t,e,i,n))}},mu.prototype.showMarkers=function(t){this.markers.forEach((e=>e.visible=t.contains(e.stationID))),null!==this.quadMarker&&(this.quadMarker.visible=!1)},mu.prototype.hideMarkers=function(){this.markers.forEach((t=>t.visible=!1)),null!==this.quadMarker&&(this.quadMarker.visible=!1)},mu.prototype.clusterMarkers=function(t){var e;for(this.hideMarkers(),e=0;e<4;e++){const t=this.nodes[e];void 0!==t&&t.hideQuadMarkers()}if(null===this.quadMarker){const e=new au(this.ctx,this.count);e.position.copy(this.centroid).divideScalar(this.count),e.layers.set(16),null!==t.heightProvider&&e.adjustHeight(t.heightProvider),t.addStatic(e),this.quadMarker=e}this.quadMarker.visible=!0},mu.prototype.hideQuadMarkers=function(){var t;for(this.quadMarker&&(this.quadMarker.visible=!1),t=0;t<4;t++){const e=this.nodes[t];void 0!==e&&e.hideQuadMarkers()}},mu.prototype.projectedArea=function(t){const e=t.camera,i=t.matrixWorld,n=this.centroid.z/this.count;return ou.set(this.xMin,this.yMin,n).applyMatrix4(i).project(e),lu.set(this.xMin,this.yMax,n).applyMatrix4(i).project(e),hu.set(this.xMax,this.yMax,n).applyMatrix4(i).project(e),cu.set(this.xMax,this.yMin,n).applyMatrix4(i).project(e),uu.getArea()+du.getArea()};class gu extends Se{constructor(t,e,i){super();const n=e.min,r=e.max;this.maxDepth=i,this.type="CV.ClusterMarker",this.quadTree=new mu(t,n.x,r.x,n.y,r.y),this.heightProvider=null,this.labels=[],this.ctx=t,this.addEventListener("removed",this.onRemoved)}}gu.prototype.addHeightProvider=function(t){this.heightProvider=t,this.traverse((e=>{e.isMarker&&e.adjustHeight(t)}))},gu.prototype.onRemoved=function(){this.traverse((t=>{"GlyphString"===t.type&&t.geometry.dispose()}))},gu.prototype.addMarker=function(t,e){const i=this.ctx.cfg,n=this.ctx.materials,r={background:i.themeColorCSS("stations.entrances.background"),color:i.themeColorCSS("stations.entrances.text"),font:"normal helvetica,sans-serif"},s=n.getGlyphMaterial(r,Math.PI/4);s.depthTest=!0,s.transparent=!1,s.alphaTest=0;const a=new Oa(e,s,this.ctx);return a.layers.set(6),a.position.copy(t.p),a.stationID=t.id,this.labels.push(a),this.quadTree.addNode(a,this.maxDepth),this.addStatic(a),a},gu.prototype.cluster=function(t,e,i){if(this.children.length<2)return;this.camera=t;const n=this.camera.getWorldDirection(fu).dot(Se.DefaultUp);this.quadTree.check(this,e,Math.max(.05,1-Math.cos(n)),i)};class vu extends gu{constructor(t,e){super(t,e.modelLimits,4);const i=this,n=e.surveyTree,r=e.metadata.entrances,s=[],a=[],o=new De,l=t.cfg.themeValue("entrance_dot_size"),h=new Ns({map:t.materials.textureCache.getTexture("disc-outlined"),opacity:1,alphaTest:.8,sizeAttenuation:!1,transparent:!0,size:Math.max(l,Math.floor(l*t.container.clientWidth/1e3)),vertexColors:!0});h.stencilWrite=!0,h.stencilZPass=B,t.viewer.addEventListener("resized",(t=>{h.size=Math.max(l,Math.floor(l*t.width/1e3))})),this.entranceColor=t.cfg.themeColor("stations.entrances.marker");const c=new Us(o,h);c.layers.set(17);for(var u=n;1===u.children.length;)u=u.children[0];n.traverse((function(t){if(!(2&t.type))return;let e;const n=r[t.getPath()];e=void 0!==n&&void 0!==n.name?n.name:void 0!==t.comment?t.comment:t.getPath(u);if(s.push(t.p),a.push(t),"-skip"===e)return;i.addMarker(t," "+e+" ")}));const d=3*s.length;if(d>0){const t=new se(d,3),e=new se(d,3);t.copyVector3sArray(s),o.setAttribute("position",t),o.setAttribute("color",e)}else this.visible=!1;return this.markers=c,this.stations=a,this.metadata=e.metadata,this.setSelection(null),this.addStatic(c),this}}vu.prototype.getStation=function(t){const e=this.stations[t],i=e.getPath();return{station:e,name:i,info:this.metadata.entrances[i]}},vu.prototype.setStation=function(t,e){const i=this.metadata;i.entrances[t.getPath()]=e,i.saveLocal()},vu.prototype.intersectLabels=function(t,e,i){const n=this.labels.filter((function(n){return n.intersects(t,e,i)})).sort((function(t,e){return t.depth-e.depth}));return 0===n.length?null:n[0]},vu.prototype.setSelection=function(t){const e=this.markers.geometry.getAttribute("color"),i=this.entranceColor;if(void 0!==e){if(null===t||t.isEmpty()){const t=e.array,n=t.length;for(let e=0;e<n;e+=3)i.toArray(t,e)}else{const n=t.getIds();this.stations.forEach((function(t,r){n.has(t.id)?i.toArray(e,3*r):e.setXYZ(r,.5,.5,.5)}))}e.needsUpdate=!0}};class yu extends su{constructor(t,e){const i=t.materials;void 0===i.pointerTexture&&(i.pointerTexture=(new Ks).load("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='36px' height='36px'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M20.94 11c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z'/%3E%3C/svg%3E"));super(new Ns({size:32,map:i.pointerTexture,transparent:!0,sizeAttenuation:!1,alphaTest:.8,color:e}),t)}}const xu=new ot;class _u extends Us{constructor(t,e){super(new De,t.materials.getExtendedPointsMaterial()),this.type="CV.Stations",this.map=new Map,this.stationCount=0;const i=t.cfg;this.baseColor=i.themeColor("stations.default.marker"),this.junctionColor=i.themeColor("stations.junctions.marker"),this.entranceColor=i.themeColor("stations.entrances.marker"),this.pointSizes=[],this.vertices=[],this.colors=[],this.stations=[],this.selected=null,this.selectedSize=0,this.selection=e,this.splaysVisible=!1;const n=new yu(t,16711680);n.visible=!1,this.addStatic(n),this.highlightPoint=n}}_u.prototype.addStation=function(t){const e=t.p;if(void 0!==this.map.get(e))return;const i=e.connections;this.vertices.push(e);let n=0;2&t.type?(this.colors.push(this.entranceColor),n=12):(this.colors.push(i>2?this.junctionColor:this.baseColor),n=8),this.pointSizes.push(n),this.map.set(e,t),this.stations.push(t),t.stationVertexIndex=this.stationCount++,t.linkedSegments=[],t.legs=[],t.distance=1/0},_u.prototype.getStation=function(t){return this.map.get(t)},_u.prototype.getVisibleStation=function(t){const e=this.map.get(t);return this.selection.contains(e.id)&&(e.p.connections>0||this.splaysVisible)?e:(void 0!==e.label&&(e.label.visible=!1),null)},_u.prototype.getStationByIndex=function(t){return this.stations[t]},_u.prototype.clearSelected=function(){if(null!==this.selected){const t=this.geometry.getAttribute("pSize");t.setX(this.selected,this.selectedSize),t.needsUpdate=!0,this.selected=null}},_u.prototype.highlightStation=function(t){const e=this.highlightPoint;return e.position.copy(t.p),e.updateMatrix(),e.visible=!0,t},_u.prototype.clearHighlight=function(){this.highlightPoint.visible=!1},_u.prototype.selectStation=function(t){this.selectStationByIndex(t.stationVertexIndex)},_u.prototype.selectStationByIndex=function(t){const e=this.geometry.getAttribute("pSize");null!==this.selected&&e.setX(this.selected,this.selectedSize),this.selectedSize=e.getX(t),e.setX(t,2*this.selectedSize),e.needsUpdate=!0,this.selected=t},_u.prototype.selectStations=function(t){const e=this.stations,i=e.length,n=this.geometry.getAttribute("pSize"),r=this.splaysVisible?6:0,s=t.getIds(),a=t.isEmpty();for(let t=0;t<i;t++){const i=e[t];let o=8;a||s.has(i.id)?(2&i.type?o=12:0===i.p.connections&&(o=r),n.setX(t,o)):(n.setX(t,0),void 0!==i.label&&(i.label.visible=!1))}n.needsUpdate=!0},_u.prototype.finalise=function(){const t=this.geometry,e=new se(3*this.vertices.length,3),i=new se(3*this.colors.length,3);t.setAttribute("pSize",new se(this.pointSizes,1)),t.setAttribute("position",e.copyVector3sArray(this.vertices)),t.setAttribute("color",i.copyColorsArray(this.colors)),t.getAttribute("color").onUpload(Se.onUploadDropBuffer),this.pointSizes=null,this.colors=null},_u.prototype.resetDistances=function(){this.stations.forEach((t=>t.distance=1/0))},_u.prototype.getClosestVisibleStation=function(t,e){const i=this.splaysVisible;var n=1/0,r=null;return e.forEach((e=>{const s=this.getStationByIndex(e.index);if(!i&&null!==s&&0===s.p.connections)return;xu.copy(s.p).applyMatrix4(this.matrixWorld).project(t),xu.sub(e.point.project(t));const a=xu.x*xu.x+xu.y*xu.y;a<n&&(n=a,r=s)})),r},_u.prototype.setSplaysVisibility=function(t){this.splaysVisible=t;const e=t?6:0,i=this.stations,n=this.geometry.getAttribute("pSize"),r=i.length,s=this.selection;for(let t=0;t<r;t++){const r=i[t];0!==r.p.connections||0!=e&&!s.contains(r.id)||n.setX(t,e)}n.needsUpdate=!0};const Mu=new ot;class bu extends ms{constructor(t,e,i){super(),this.type="CV.StationLabels",this.stations=e,this.commentCount=i,this.ctx=t;const n=t.cfg,r=t.materials,s={color:n.themeColorCSS("stations.default.text"),font:n.themeValue("stations.font")};this.defaultLabelMaterial=r.getGlyphMaterial(s,0),this.splayLabelMaterial=r.getGlyphMaterial(s,0);const a={color:n.themeColorCSS("stations.junctions.text"),font:n.themeValue("stations.font")};this.junctionLabelMaterial=r.getGlyphMaterial(a,0)}}bu.prototype.update=function(t,e,i){const n=Mu.copy(t.position);t.isOrthographicCamera&&(n.sub(e),n.setLength(600/t.zoom),n.add(e)),n.applyMatrix4(i);const r=this.stations,s=r.vertices,a=s.length,o=0!=(8192&t.layers.mask),l=0!=(32768&t.layers.mask),h=a/this.commentCount;for(var c=0;c<a;c++){const t=s[c],e=r.getVisibleStation(t);if(null!==e){const i=e.label;let r=4e4;0===t.connections?r=250:t.connections<3&&(r=5e3),l&&void 0!==e.comment&&(r*=h);const s=t.distanceToSquared(n)<r;let a="";o&&(a+=e.name),o&&l&&void 0!==e.comment&&(a+=" "),l&&void 0!==e.comment&&(a+=e.comment),i&&i.name===a?i.visible=s:(void 0!==i&&(this.remove(i),e.label=null),s&&this.addLabel(e,a))}}},bu.prototype.addLabel=function(t,e){var i;const n=t.p,r=n.connections;i=0===r?this.splayLabelMaterial:r<3?this.defaultLabelMaterial:this.junctionLabelMaterial;const s=new Oa(e,i,this.ctx);s.layers.mask=this.layers.mask,s.position.copy(n),t.label=s,this.addStatic(s)};class Su extends ms{constructor(t,e){super(),this.markers=new Map,this.markerColor=e,this.ctx=t}}function wu(t,e){if(0===t.length||!e)return;this.stations=t,this.legsObject=e,this.vertexPairToSegment=[],this.segmentMap=new Map,this.segmentToInfo={},this.maxDistance=0,this.zeroStation=null;const i=e.legVertices,n=this.segmentMap,r=this.vertexPairToSegment,s=this.segmentToInfo,a=i.length;var o,l,h=!0,c=0;for(let e=0;e<a;e+=2){const u=i[e],d=i[e+1];if(r.push(c),void 0!==(o=t.getStation(u))&&(o.legs.push(e),o.linkedSegments.push(c)),h){if(void 0===o)continue;l={segment:c,startStation:o,endStation:null},h=!1}void 0!==(o=t.getStation(d))&&o.legs.push(e),o&&(d.connections>2||e+2<a&&!d.equals(i[e+2]))&&(l.endStation=o,n.set(l.startStation.id+":"+o.id,l),s[c]=l,o.linkedSegments.push(c),c++,h=!0)}return h||(l.endStation=o,n.set(l.startStation.id+":"+o.id,l),o.linkedSegments.push(c)),this}Su.prototype.mark=function(t){const e=this.markers;if(e.has(t))return;const i=new yu(this.ctx,this.markerColor);i.position.copy(t.p),i.station=t,i.layers=this.layers,this.add(i),e.set(t,i)},Su.prototype.unmark=function(t){const e=this.markers,i=e.get(t);void 0!==i&&(this.remove(i),e.delete(t))},Su.prototype.clear=function(){this.markers.forEach((t=>this.remove(t))),this.markers.clear()},Su.prototype.getStations=function(){const t=[];return this.markers.forEach(((e,i)=>t.push(i))),t},Su.prototype.setVisibility=function(t){this.markers.forEach((e=>e.visible=t))},wu.prototype.vertexSegment=function(t){return this.vertexPairToSegment[t/2]},wu.prototype.shortestPathSearch=function(t){const e=[t],i=this.legsObject,n=i.legVertices,r=this.stations;r.resetDistances();var s=0;for(t.distance=0;e.length>0;){const t=e.shift(),a=t.distance,o=t.legs;s=Math.max(s,a);for(let s=0;s<o.length;s++){const l=o[s],h=n[l],c=n[l+1],u=h!==t.p?h:c,d=r.getStation(u),p=i.legLengths[l/2];d.distance>a+p&&(d.distance=a+p,e.push(d))}}this.zeroStation=t,this.maxDistance=s},wu.prototype.getShortestPath=function(t){const e=this.zeroStation,i=new Set;if(null===e||t.distance===1/0||e===t||0===t.distance)return i;const n=this.stations,r=this.legsObject.legVertices;for(var s=t,a=!0;a;){const t=s.legs,o=t.length;for(let l=0;l<o;l++){const o=t[l],h=r[o],c=r[o+1],u=h!==s.p?h:c,d=n.getStation(u);d.distance<s.distance&&(s=d,i.add(o),s===e&&(a=!1))}}return i};class Eu extends c{constructor(t){super(),this.metadata=t.metadata,this.topology=t.topology,this.surveyTree=t.surveyTree,this.routes=new Map,this.routeNames=[],this.currentRoute=new Set,this.currentRouteName=null,this.adjacentSegments=new Set,Object.defineProperty(this,"setRoute",{set:function(t){this.loadRoute(t)},get:function(){return this.currentRouteName}});const e=this.metadata.getRoutes(),i=this.routeNames;var n;for(n in e){const t=e[n];i.push(n),this.routes.set(n,t.segments)}i.sort(),this.dispatchEvent({type:"changed",name:"download"})}}Eu.prototype.addRoute=function(t){t!==this.currentRouteName&&void 0!==t&&(this.routeNames.indexOf(t)<0&&(this.routeNames.push(t),this.routes.set(t,[])),this.loadRoute(t))},Eu.prototype.loadRoute=function(t){const e=this.surveyTree,i=this.currentRoute,n=this.topology.segmentMap,r=this.routes.get(t);var s;if(!r)return alert("route "+t+" does not exist"),!1;for(i.clear(),s=0;s<r.length;s++){const t=r[s],a=n.get(e.getIdByPath(t.start)+":"+e.getIdByPath(t.end));void 0!==a&&i.add(a.segment)}return this.currentRouteName=t,this.dispatchEvent({type:"changed",name:""}),!0},Eu.prototype.getCurrentRoute=function(){return this.currentRoute},Eu.prototype.saveCurrent=function(){const t=this.currentRouteName,e=this.topology.segmentMap,i=this.currentRoute;if(!t)return;const n=[];e.forEach((function(t){i.has(t.segment)&&n.push({start:t.startStation.getPath(),end:t.endStation.getPath()})})),this.routes.set(t,n),this.metadata.saveRoute(t,{segments:n})},Eu.prototype.getRouteNames=function(){return this.routeNames},Eu.prototype.toggleSegment=function(t){const e=this,i=this.currentRoute,n=this.topology.vertexSegment(t);if(this.adjacentSegments.clear(),i.has(n))i.delete(n);else{i.add(n);const t=this.topology.segmentToInfo[n];void 0!==t&&(t.startStation.linkedSegments.forEach(r),t.endStation.linkedSegments.forEach(r))}return;function r(t){i.has(t)||e.adjacentSegments.add(t)}},Eu.prototype.inCurrentRoute=function(t){return this.currentRoute.has(this.topology.vertexSegment(t))},Eu.prototype.adjacentToRoute=function(t){return this.adjacentSegments.has(this.topology.vertexSegment(t))};class Tu extends ms{constructor(t){super(),this.ctx=t,this.legLengths=[],this.legVertices=[],this.colors=[],this.type="Legs"}}Tu.prototype.addLegs=function(t,e){const i=this.ctx;this.legVertices=t,this.legRuns=e;var n=null;n=i.cfg.value("gl-lines",!1)?new Cu(i):new Lu(i);const r=new se(3*t.length,3),s=new se(3*t.length,3);return r.copyVector3sArray(t),s.array.fill(1),n.addLegs(r,s),n.setShading=function(){},n.layers=this.layers,this.computeStats(),this.addStatic(n),this.colors=s,this.legs=n,this},Tu.prototype.computeStats=function(){const t={maxLegLength:-1/0,minLegLength:1/0,legCount:0,legLength:0},e=this.legVertices,i=e.length,n=i/2,r=new Array(n);var s,a=0,o=0;for(s=0;s<i;s+=2){const i=e[s],n=e[s+1],l=i.correctedDistanceTo(n);r[s/2]=l,a+=l,o+=l*l,t.maxLegLength=Math.max(t.maxLegLength,l),t.minLegLength=Math.min(t.minLegLength,l)}return t.legLength=a,t.legLengthSD=Math.sqrt(o/n-Math.pow(a/n,2)),t.legLengthRange=t.maxLegLength-t.minLegLength,t.legCount=n,this.legLengths=r,this.stats=t,this},Tu.prototype.cutRuns=function(t){const e=t.getIds(),i=this.legRuns;if(!i)return;const n=this.legVertices,r=[],s=[],a=i.length;var o;for(o=0;o<a;o++){const t=i[o],a=t.survey,h=t.start,c=t.end;let u=0;if(e.has(a)){for(var l=h;l<c;l++)r.push(n[l]);t.start=u,u+=c-h,t.end=u,s.push(t)}}return 0!==r.length&&(this.legs.geometry.dispose(),this.remove(this.legs),this.addLegs(r,s),!0)},Tu.prototype.setShading=function(t,e,i,n){this.legs.updateMaterial(this.ctx,i,n);const r=this.legRuns,s=this.ctx.cfg.themeColor("shading.unselected");var a,o,l;const h=this.legVertices,c=this.colors.array;if(t.size>0&&r)for(o=0,a=r.length;o<a;o++){const i=r[o],n=i.survey,a=i.start,u=i.end;if(t.has(n))for(l=a;l<u;l+=2)e(h,c,l,l+1,n);else for(l=a;l<u;l+=2)s.toArray(c,3*l),s.toArray(c,3*(l+1))}else for(l=0,a=h.length;l<a;l+=2)e(h,c,l,l+1,null);this.legs.updateColors()},Tu.prototype.hide=function(t){this.legs.hide(this,t)};class Cu extends Ds{constructor(t){super(new De,t.materials.getUnselectedMaterial()),this.type="CV.ThinLegs"}}Cu.prototype.addLegs=function(t,e){const i=this.geometry;return i.setAttribute("position",t),i.setAttribute("color",e),i.computeBoundingBox(),this},Cu.prototype.updateColors=function(){this.geometry.getAttribute("color").needsUpdate=!0},Cu.prototype.updateMaterial=function(t,e){const i=t.materials;switch(e){case"height":this.material=i.getHeightMaterial(1);break;case"depth":this.material=i.getDepthMaterial(1);break;case"depth-cursor":this.material=i.getDepthCursorMaterial(1);break;case"cursor":this.material=i.getCursorMaterial(1);break;case"basic":this.material=i.getLineMaterial()}this.material.needsUpdate=!0},Cu.prototype.hide=function(t,e){const i=this.legs.geometry;if(i.clearGroups(),e){const e=t.ctx.survey.stations,n=t.legVertices,r=e.getStation(n[0]).type,s=e.getStation(n[0]).type;let a=!!(4&r)&&!!(4&s);const o=n.length;let l=0,h=0;for(let t=0;t<o;t+=2){const r=e.getStation(n[t]).type,s=e.getStation(n[t+1]).type,o=!!(4&r)&&!!(4&s);a===o?h+=2:(i.addGroup(l,h,a?0:1),l=t,h=0),a=o}i.addGroup(l,h+2,a?0:1);const c=t.ctx.materials.getMissingMaterial();c.visible=!1,this.material=[c,this.material]}else this.material=this.material[1]};class Lu extends ja{constructor(t){super(new Ua,t.materials.getLine2Material("basic")),this.scale.set(1,1,1),this.type="CV.FatLegs"}}function Au(t,e,i,n,r){r.dashOffset+=.1}Lu.prototype.addLegs=function(t,e){const i=this.geometry;return i.setPositions(t.array),i.setColors(e.array),this.computeLineDistances(),this},Lu.prototype.updateColors=function(){this.geometry.getAttribute("instanceColorStart").needsUpdate=!0,this.geometry.getAttribute("instanceColorEnd").needsUpdate=!0},Lu.prototype.updateMaterial=function(t,e,i){this.material=t.materials.getLine2Material(e,i),this.material.needsUpdate=!0},Lu.prototype.hide=function(t,e){if(e){const e=t.ctx.survey.stations,i=t.legVertices,n=i.length,r=[];for(let t=0;t<n;t+=2){const n=e.getStation(i[t]).type,s=e.getStation(i[t+1]).type;r.push(4&n&&4&s?1:0)}this.geometry.setHide(r)}else this.geometry.clearHide()};class Ru extends ja{constructor(t){const e=new Ua,i=t.survey;super(e,new Wa(t,"",!0)),this.metadata=i.metadata,this.vertices=[],this.selected=[],this.stations=[],this.onBeforeRender=Au,this.visible=!1;const n=i.metadata.traces,r=i.surveyTree;n.forEach((t=>{const e=r.getByPath(t.start),i=r.getByPath(t.end);void 0!==i&&void 0!==e&&this._addTrace(e,i)})),this.finish()}}Ru.prototype.finish=function(){const t=this.geometry;if(0!==this.vertices.length)return t.setPositions(this.vertices),t.setHide(this.selected),this.visible=!0,this.metadata.traces=this.serialise(),this.metadata.saveLocal(),this},Ru.prototype.getTraceStations=function(t){const e=this.stations;return{start:e[2*t].getPath(),end:e[2*t+1].getPath()}},Ru.prototype.deleteTrace=function(t){const e=2*t;this.stations.splice(e,2),this.vertices.splice(e,2),this.selected.splice(e,2),this.finish()},Ru.prototype._addTrace=function(t,e){this.vertices.push(t.p.x,t.p.y,t.p.z,e.p.x,e.p.y,e.p.z),this.stations.push(t,e),this.selected.push(1,1)},Ru.prototype.addTrace=function(t,e){this._addTrace(t,e),this.finish()},Ru.prototype.outlineTrace=function(t){if(!this.visible)return;const e=this.selected;if(e.fill(0),null!==t){let i=2*t;e[i++]=1,e[i]=1}this.geometry.setHide(e)},Ru.prototype.serialise=function(){const t=this.stations,e=[];for(let i=0,n=t.length;i<n;i+=2)e.push({start:t[i].getPath(),end:t[i+1].getPath()});return e};class Pu extends c{constructor(t,e){super(),this.name=t;var i={},n=[],r={};null!==e&&(e.routes&&(i=e.routes),e.traces&&(n=e.traces),e.entrances&&(r=e.entrances));var s=window.localStorage.getItem(t);if(null!==s){const t=(s=JSON.parse(s)).routes;var a;for(a in t){const e=t[a];e.local=!0,i[a]=e}void 0!==s.traces&&(n=s.traces),void 0!==s.entrances&&(r=s.entrances)}this.routes=i,this.traces=n,this.entrances=r}}Pu.prototype.getRoutes=function(){return this.routes},Pu.prototype.saveRoute=function(t,e){this.routes[t]=e,this.saveLocal(),this.dispatchEvent({name:"change",type:"routes"})},Pu.prototype.saveLocal=function(){const t={routes:this.routes,traces:this.traces,entrances:this.entrances};window.localStorage.setItem(this.name,JSON.stringify(t))},Pu.prototype.getURL=function(){return Ho({name:"test",version:1,routes:this.routes,traces:this.traces,entrances:this.entrances})};class Du extends js{constructor(t){super(),this.transparent=!0,this.onBeforeCompile=function(e){Object.assign(e.uniforms,t.materials.commonTerrainUniforms);var i=e.vertexShader.replace("#include <common>","$&\nvarying vec2 vPosition;\n").replace("include <begin_vertex>","$&\nvPosition = vec2( position.x, position.y );\n"),n=e.fragmentShader.replace("#include <common>","$&\n"+Ga.commonTerrainCodePars+"\n").replace("#include <color_fragment>",Ga.commonTerrainCodeColor);e.vertexShader=i,e.fragmentShader=n},Object.defineProperty(this,"opacity",{get:function(){return t.materials.terrainOpacity}})}}function Nu(t,e){this.provider=e,this.active=!1,this.hasCoverage=!1,this.crsSupported=void 0===e.crsSupported?["EPSG:3857","EPSG:4326","ORIGINAL"]:e.crsSupported,this.throughMode=2,this.ctx=t;const i=e.getAttribution();if(i){const e={h:0,s:0,l:0};new $t(t.cfg.themeValue("background")).getHSL(e),i.classList.add("overlay-branding"),i.style.color=e.l<.5?"white":"black",this.attribution=i}this.materialCache=new Map,this.missing=new Set;const n=e.coverage;void 0!==n&&(this.coverage=new Ma(new Q(n.minX,n.minY),new Q(n.maxX,n.maxY)))}Object.assign(Du.prototype,fo.prototype),Nu.prototype.getMinZoom=function(){return this.provider.minZoom},Nu.prototype.checkCoverage=function(t,e,i){const n=this.coverage;if(-1===this.crsSupported.indexOf(e))return!1;const r=ch("ORIGINAL"===e?i:e,"WGS84"),s=new Ma;return s.expandByPoint(r.forward({x:t.min.x,y:t.min.y})),s.expandByPoint(r.forward({x:t.min.x,y:t.max.y})),s.expandByPoint(r.forward({x:t.max.x,y:t.min.y})),s.expandByPoint(r.forward({x:t.max.x,y:t.max.y})),this.provider.crs=e,this.hasCoverage=void 0===n||n.intersectsBox(s),this.hasCoverage},Nu.prototype.showAttribution=function(){const t=this.attribution;void 0!==t&&this.ctx.container.appendChild(t)},Nu.prototype.hideAttribution=function(){const t=this.attribution,e=t.parentNode;null!==e&&e.removeChild(t)},Nu.prototype.getTile=function(t,e,i){const n=t+":"+e+":"+i,r=this.ctx.cfg,s=this.ctx.materials,a=this.materialCache.get(n),o=this.provider.maxZoom;var l=1,h=0,c=0;return new Promise((u=>{if(void 0!==a)return void u(this.active?a:null);const d=i-o;if(d>0){const n=Math.pow(2,d);l=1/n;const r=Math.floor(t*l),s=Math.floor(e*l);h=(t-r*n)/n,c=1-(e-s*n)/n,c-=l,t=r,e=s,i=o}const p=this.provider.getUrl(t,e,i);null===p||this.missing.has(p)?u(s.getMissingMaterial()):(new Ks).setCrossOrigin("anonymous").load(p,(t=>{if(!this.active)return t.dispose(),void u(null);const e=new Du(this.ctx);t.anisotropy=r.value("anisotropy",4),t.repeat.setScalar(l),t.offset.set(h,c),e.map=t,e.needsUpdate=!0,this.materialCache.set(n,e),u(e)}),void 0,(()=>{this.missing.add(p),u(this.active?s.getMissingMaterial():null)}))}))},Nu.prototype.setActive=function(){this.showAttribution(),this.active=!0},Nu.prototype.setInactive=function(){this.materialCache.forEach((t=>{t.map.dispose(),t.dispose()})),this.materialCache.clear(),this.hideAttribution(),this.active=!1},Nu.prototype.constructor=Nu;var Iu=null;const Fu=new ot,Ou=new ot,zu=new Uint8Array(4);class Uu extends ms{constructor(t){super(),this.hasOverlay=!1,this.activeOverlay=null,this.depthTexture=null,this.renderer=null,this.renderTarget=null,this.datumShift=0,this.activeDatumShift=0,this.terrainBase=null,this.terrainRange=null,this.isFlat=!1,this.screenAttribution=null,this.terrainShadingModes={},this.throughMode=1,this.commonUniforms=t.materials.commonTerrainUniforms,this.ctx=t,this.addEventListener("removed",(()=>this.removed()))}}Uu.addOverlay=function(t,e,i,n){void 0===t.overlays&&(t.overlays={}),t.overlays[e]=new Nu(t,i),n&&(Iu=e)},Uu.prototype.shadingMode=8,Uu.prototype.removed=function(){},Uu.prototype.getOpacity=function(){return this.ctx.materials.terrainOpacity},Uu.prototype.setOpacity=function(t){this.ctx.materials.terrainOpacity=t},Uu.prototype.commonRemoved=function(){const t=this.activeOverlay;null!==t&&t.setInactive(),null!==this.renderTarget&&this.renderTarget.dispose()},Uu.prototype.checkTerrainShadingModes=function(t){const e=this.ctx.overlays,i={};var n;if(i["terrain.shading.height"]=8,(t.capabilities.isWebGL2||null!==t.extensions.get("OES_standard_derivatives")&&!this.isFlat)&&(i["terrain.shading.contours ("+this.ctx.cfg.themeValue("shading.contours.interval")+"m)"]=15),this.isTiled)for(n in e){const t=e[n];t.checkCoverage(this.limits,this.displayCRS,this.surveyCRS)&&(t.active=this.activeOverlay===t,i[n]=n)}else this.hasOverlay&&(i["terrain.shading.overlay"]=7);return this.terrainShadingModes=i,i},Uu.prototype.setup=function(t,e,i){this.computeBoundingBox(),i.addStatic(this);const n=1024,r=this.ctx.materials,s=this.ctx.container;var a=s.clientWidth,o=s.clientHeight;const l=i.combinedLimits.getSize(Fu),h=a/l.x,c=o/l.y;h<c?o=o*h/c:a=a*c/h;const u=new Gi(-a/2,a/2,o/2,-o/2,-1e4,1e4);u.layers.set(7);const d=new st(n,n,{minFilter:b,magFilter:M,format:P,stencilBuffer:!0});d.texture.generateMipmaps=!1,d.texture.name="CV.DepthMapTexture",t.setSize(n,n),t.setPixelRatio(1),t.clear(),t.setRenderTarget(d),e.overrideMaterial=r.getDepthMapMaterial(this),t.render(e,u),e.overrideMaterial=null,this.addHeightMap(t,d),this.checkTerrainShadingModes(t),t.renderLists.dispose(),t.setRenderTarget(null),t.setSize(s.clientWidth,s.clientHeight),t.setPixelRatio(window.devicePixelRatio),i.setupTerrain(this),r.setTerrain(this)},Uu.prototype.setShadingMode=function(t,e){const i=this.activeOverlay,n=this.ctx.materials,r=this.ctx.overlays;var s,a=!0,o=null;switch(t){case 8:s=n.getHypsometricMaterial();break;case 7:this.setOverlay(e),a=!1;break;case 15:s=n.getContourMaterial();break;case 16:if(null===Iu){s=n.getHypsometricMaterial(),t=8;break}t=Iu;default:if(void 0===(o=r[t]))return console.warn("unknown mode",t),!1;this.isTiled&&o.hasCoverage?(o.throughMode=this.throughMode,this.setOverlay(o,e),a=!1):(s=n.getHypsometricMaterial(),t=8)}return a&&null!==i&&(i.setInactive(),this.activeOverlay=null),void 0!==s&&(s.setThroughMode(this.throughMode),this.setMaterial(s)),this.shadingMode=t,!0},Uu.prototype.setThroughMode=function(t){this.throughMode=t},Uu.prototype.setVisibility=function(t){this.visible=t,t?this.showAttribution():this.hideAttribution()},Uu.prototype.showAttribution=function(){const t=this.screenAttribution;null!==t&&this.ctx.container.appendChild(t),null!==this.activeOverlay&&this.activeOverlay.showAttribution()},Uu.prototype.hideAttribution=function(){const t=this.screenAttribution;if(null!==t){const e=t.parentNode;null!==e&&e.removeChild(t)}null!==this.activeOverlay&&this.activeOverlay.hideAttribution()},Uu.prototype.applyDatumShift=function(t){t&&0===this.activeDatumShift?(this.translateZ(this.datumShift),this.activeDatumShift=this.datumShift):t||0===this.activeDatumShift||(this.translateZ(-this.datumShift),this.activeDatumShift=0),this.updateMatrix(),this.dispatchEvent({type:"datumShiftChange",value:this.activeDatumShift})},Uu.prototype.computeBoundingBox=function(){const t=new ct;return this.traverse((function(e){e.isTile&&e.isMesh&&t.union(e.geometry.boundingBox)})),this.boundingBox=t,t},Uu.prototype.addHeightMap=function(t,e){this.depthTexture=e.texture,this.renderer=t,this.renderTarget=e},Uu.prototype.getHeight=function(t){const e=this.renderTarget;null===this.terrainBase&&(void 0===this.boundingBox&&this.computeBoundingBox(),this.terrainBase=this.boundingBox.min,this.terrainRange=this.boundingBox.getSize(new ot),Ou.set(e.width,e.height,1).divide(this.terrainRange));const i=this.terrainBase;return Fu.copy(t).sub(i).multiply(Ou).round(),this.renderer.readRenderTargetPixels(e,Fu.x,Fu.y,1,1,zu),(2.319211489520967e-10*(n=zu)[0]+5.9371814131736755e-8*n[1]+1519918441772461e-20*n[2]+.0038909912109375*n[3])*this.terrainRange.z+i.z;var n},Uu.prototype.setScale=function(t){this.commonUniforms.scale.value=t},Uu.prototype.setAccuracy=function(t){this.commonUniforms.accuracy.value=t,this.commonUniforms.ringColor.value.g=1-t/1e3},Uu.prototype.setTarget=function(t){this.commonUniforms.target.value.copy(t)},Uu.prototype._fitSurface=function(t){var e=0,i=0,n=0;t.forEach((t=>{const r=this.getHeight(t);i+=r,n+=r*r,e++}));const r=Math.sqrt(n/e-Math.pow(i/e,2));this.datumShift=i/e,console.log("Adjustmenting terrain height by:",this.datumShift,"sd:",r)};class Bu extends De{constructor(t,e){super(),this.type="LoxTerrainGeometry";const i=t.data,n=t.lines,r=t.samples,s=t.calib,a=[],o=[],l=s.xx,h=s.xy,c=s.yx,u=s.yy,d=s.xOrigin-e.x,p=s.yOrigin-e.y,f=-e.z,m=r-1,g=n-1;var v,y,x=1/0,_=-1/0;for(y=0;y<n;y++){const t=(n-1-y)*r;for(v=0;v<r;v++){const e=v*l+(g-y)*h+d,n=v*c+(g-y)*u+p,r=i[t+v]+f;o.push(e,n,r),r<x&&(x=r),r>_&&(_=r)}}const M=m*l+g*h+d,b=m*c+g*u+p;for(this.boundingBox=new ct(new ot(d,p,x),new ot(M,b,_)),y=0;y<g;y++)for(v=0;v<m;v++){const t=v+r*y,e=v+r*(y+1),i=v+1+r*(y+1),n=v+1+r*y;Math.abs(o[3*t+2]-o[3*n+2])<Math.abs(o[3*e+2]-o[3*i+2])?(a.push(t,e,n),a.push(e,i,n)):(a.push(t,e,i),a.push(i,n,t))}this.setIndex(a),this.setAttribute("position",new se(o,3)),this.computeVertexNormals()}}Bu.prototype.setupUVs=function(t,e,i){const n=t.calib,r=n.xx*n.yy-n.xy*n.yx;if(0===r)return!1;const s=n.yy/r,a=-n.xy/r,o=-n.yx/r,l=n.xx/r,h=this.getAttribute("position").array,c=e.naturalWidth,u=e.naturalHeight,d=-(s*n.xOrigin+a*n.yOrigin),p=-(o*n.xOrigin+l*n.yOrigin),f=[];for(let t=0;t<h.length;t+=3){const e=h[t]+i.x,n=h[t+1]+i.y,r=(e*s+n*a+d)/c,m=(e*o+n*l+p)/u;f.push(r,m)}void 0!==this.getAttribute("uv")&&console.alert("replacing attribute uv"),this.setAttribute("uv",new se(f,2))};class ku extends wi{constructor(t,e,i){super(new Bu(e.dtm,i),t.materials.getSurfaceMaterial()),this.type="CV.LoxTile",this.layers.set(7),this.overlayMaterial=null,this.ctx=t,void 0===e.bitmap?this.bitmap=null:(this.bitmap=e.bitmap,this.offsets=i)}}ku.prototype.isTile=!0,ku.prototype.loadOverlay=function(t,e){if(null===this.bitmap)return;const i=(new Ks).load(this.bitmap.image,(function(){const r=n.bitmap;n.geometry.setupUVs(r,i.image,n.offsets),i.onUpdate=function(t){URL.revokeObjectURL(t.image.src),t.image=null},n.overlayMaterial=new Du(t),n.overlayMaterial.map=i,n.overlayMaterial.setThroughMode(n.parent.throughMode),r.data=null,r.image=null,n.material=n.overlayMaterial,e()})),n=this;return void(i.anisotropy=this.ctx.cfg.value("anisotropy",4))},ku.prototype.removed=function(){const t=this.overlayMaterial;null!==t&&(t.map.dispose(),t.dispose()),this.geometry.dispose()};class Gu extends Uu{constructor(t,e,i){super(t),this.type="CV.Terrain",this.overlayMaterial=null,this.attributions=[];var n=0;e.forEach((e=>{const r=new ku(t,e,i);null!==r.bitmap&&n++,this.add(r)})),this.overlayLoaded=!1,this.hasOverlay=n>0}}Gu.prototype.isTiled=!1,Gu.prototype.isLoaded=!0,Gu.prototype.setOverlay=function(t){if(this.hasOverlay){if(this.overlayLoaded)return this.children.forEach((t=>{null!==t.overlayMaterial&&(t.material=t.overlayMaterial,t.material.setThroughMode(this.throughMode))})),void t();this.children.forEach((e=>e.loadOverlay(this.ctx,t))),this.overlayLoaded=!0}},Gu.prototype.removed=function(){this.children.forEach((t=>t.removed())),this.commonRemoved()},Gu.prototype.setMaterial=function(t){this.children.forEach((e=>e.material=t))},Gu.prototype.fitSurface=Uu.prototype._fitSurface;class Hu extends wi{constructor(t){super(new De,t.materials.getUnselectedWallMaterial()),this.ctx=t,this.type="Walls"}}function Vu(t,e){!function(t,e){const i=t.scraps,n=i.length;if(0===n)return null;const r=e.addFeature(new Hu(e.ctx),a,"Scraps"),s=[],o=[],l=[];var h,c=0,u=0;for(h=0;h<n;h++)d(i[h]);return r.addWalls(o,s,l),void e.addFeature(r,a,"CV.Survey:faces:scraps");function d(t){var e,i;for(e=0,i=t.vertices.length;e<i;e++)o.push(t.vertices[e]);for(e=0,i=t.faces.length;e<i;e++){const i=t.faces[e];s.push(i[0]+c,i[2]+c,i[1]+c)}const n=s.length;l.push({start:u,count:n-u,survey:t.survey}),u=n,c+=t.vertices.length}}(t,e),function(t,e){const i=t.crossSections,n=e.stations,r=e.getLegs(),a=e.ctx,o=new Map,l=a.cfg.value("fixup_xsects",!0);if(i.forEach((t=>{t.forEach((t=>{o.set(t.end,t)}))})),0===i.length)return;const h=[],c=e.addFeature(new Hu(a),s,"Walls"),u=[],d=[],p=i.length,f=[],m=Se.DefaultUp;var g,v,y,x,_,M,b,S,w,E,T,C,L,A,R,P,D,N,I,F=0,O=0;const z=new ot,U=new ot,B=new ot;var k,G=null;if(0!==p){for(N=0;N<p;N++){const t=i[N];if(t.length<2)continue;null===t[0].start&&W(t),l&&j(t);const e=t.length;for(k=V(t[0],t[1]),I=1;I<e;I++){const e=t[I],i=e.survey;k=V(e,t[I+1]),i!==g&&(g=i,null!==G&&(H(),O=u.length,G.count=O-G.start,f.push(G),G=null)),v=F++,y=F++,x=F++,_=F++,8===k?(E=F++,L=F++,T=F++,C=F++):(E=v,L=y,T=y,C=v),M=F++,b=F++,S=F++,w=F++,8===k?(A=F++,D=F++,R=F++,P=F++):(A=v,D=y,R=y,P=v),4===k?(u.push(x,y,b),u.push(x,b,S),u.push(x,S,M),u.push(x,M,v),u.push(_,b,y),u.push(_,w,b),u.push(_,M,w),u.push(_,v,M)):(u.push(x,T,R),u.push(x,R,S),u.push(x,S,A),u.push(x,A,E),u.push(T,y,b),u.push(T,b,R),u.push(E,A,M),u.push(E,M,v),u.push(L,b,y),u.push(L,D,b),u.push(C,M,P),u.push(C,v,M),u.push(_,D,L),u.push(_,w,D),u.push(_,P,w),u.push(_,C,P)),F-=k,null===G&&(G={start:O,survey:i},u.push(x,_,y),u.push(x,v,_),8===k&&(u.push(x,E,v),u.push(x,y,T),u.push(_,v,C),u.push(_,L,y)))}g=null,F+=k}if(null!==G&&(H(),G.count=u.length-G.start,f.push(G)),0!==u.length)return c.addWalls(d,u,f),e.addFeature(c,s,"CV.Survey:faces:walls"),void e.loadWarnings(h)}function H(){u.push(S,b,w),u.push(S,w,M),8===k&&(u.push(S,M,A),u.push(S,R,b),u.push(w,P,M),u.push(w,b,D))}function V(t,e){const i=.293,n=t.end,r=t.lrud;var s;z.subVectors(t.start,t.end).normalize();const a=Math.abs(z.dot(m))>.97;var o,l,h,c,u,p,f,g;if(e&&(B.subVectors(e.start,e.end).normalize(),z.add(B)),z.cross(m),a&&r.u+r.d<5){z.copy(U);const t=z.clone().cross(m);h=t.clone().setLength(-r.u).add(n),c=t.clone().setLength(r.d).add(n)}else h=new ot(n.x,n.y,n.z+r.u),c=new ot(n.x,n.y,n.z-r.d);switch(o=z.clone().setLength(r.l).add(n),l=z.clone().setLength(-r.r).add(n),U.copy(z),t.type){case 3:d.push(o,l,h,c),s=4;break;case 2:u=o.clone().setZ(h.z),p=l.clone().setZ(h.z),f=o.clone().setZ(c.z),g=l.clone().setZ(c.z),d.push(u,g,p,f),s=4;break;case 1:d.push(o,l,h,c),u=o.clone().setZ(h.z).lerp(n,i),p=l.clone().setZ(h.z).lerp(n,i),f=o.clone().setZ(c.z).lerp(n,i),g=l.clone().setZ(c.z).lerp(n,i),d.push(u,g,p,f),s=8;break;default:console.error("unsupported lrud shape",t.type)}return s}function W(t){let e=t[0],i=t[1];if(l){const r=X(e.end,i.end);if(r){e.start=r;const s=o.get(r);s&&(i=e,e={start:null,end:r,lrud:s.lrud,type:2},t.unshift(e),h.push({station:n.getStation(i.start),text:"xSects start extended"}))}}e.start=(new ot).copy(i.start).multiplyScalar(2).sub(i.end)}function j(t){const e=t[t.length-1],i=X(e.end,e.start);if(!i)return;const r=o.get(i);void 0!==r&&(t.push({start:e.end,end:i,lrud:r.lrud,type:2}),h.push({station:n.getStation(e.end),text:"xSects end extended"}))}function X(t,e){const i=n.getStation(t).legs;if(0===i.length)return;const s=[];return i.forEach((i=>{const n=r[i]!==t?r[i]:r[i+1];n!==e&&s.push(n)})),s[0]}}(t,e)}function Wu(t){var e=[],i=0;this.getColour=function(e){const i=t.materials.colourCache.getColors("survey");return i[e%i.length]},this.getColourMap=function(t){if(i===t&&e.length>0)return e;e=[];var n=i=t,r=this.getColour(i.id);a(n);for(var s=n.children;1===s.length;)a(n=s[0]),s=n.children;for(let t=0,e=s.length;t<e;t++){const e=s[t];r=this.getColour(e.id),e.traverse(a)}return e;function a(t){t.isStation()||(e[t.id]=r)}}}Hu.prototype.ready=!0,Hu.prototype.flat=!1,Hu.prototype.flatGeometry=null,Hu.prototype.indexedGeometry=null,Hu.prototype.addWalls=function(t,e,i){const n=this.geometry,r=new se(3*t.length,3);return n.setAttribute("position",r.copyVector3sArray(t)),n.setIndex(e),n.computeVertexNormals(),n.computeBoundingBox(),this.indexRuns=i,this},Hu.prototype.setShading=function(t,e){const i=this.geometry,n=this.indexRuns,r=this.ctx.materials;if(i.clearGroups(),this.visible=this.ready,t.length>0&&n){this.material=[e,r.getUnselectedWallMaterial()];let o,l=n[0],h=l.start,c=l.count,u=t.has(l.survey)?0:1;for(var s=1,a=n.length;s<a;s++)l=n[s],o=t.has(l.survey)?0:1,o===u&&l.start===h+c?c+=l.count:(i.addGroup(h,c,u),h=l.start,c=l.count,u=o);i.addGroup(h,c,u)}else this.material=e},Hu.prototype.cutRuns=function(t){const e=this.flat;this.setFlat(!1),this.flatGeometry&&(this.flatGeometry.dispose(),this.flatGeometry=null);const i=this.geometry,n=i.getAttribute("position"),r=i.index,s=t.getIds(),a=this.indexRuns,o=[],l=[],h=[],c=new Map,u=a.length;var d,p=0,f=0;for(d=0;d<u;d++){const t=a[d];let e;if(s.has(t.survey)){const i=t.start,s=t.count,a=i+s,u=n.itemSize,d=n.array;for(e=i;e<a;e++){const t=r.getX(e);let i=c.get(t);if(void 0===i){const e=t*u;i=p++,c.set(t,i),l.push(d[e],d[e+1],d[e+2])}o.push(i)}t.start=f,f+=s,h.push(t)}}return 0!==o.length&&(i.index=new r.constructor(o),i.setAttribute("position",new se(l,3)),i.computeVertexNormals(),i.computeBoundingBox(),this.indexRuns=h,this.setFlat(e),!0)},Hu.prototype.setFlat=function(t){if(t===this.flat)return;const e=this.geometry;var i=this.flatGeometry;t?(null===i&&((i=e.toNonIndexed()).computeVertexNormals(),i.computeBoundingBox()),this.indexedGeometry=e,this.geometry=i,this.dropBuffers()):(this.flatGeometry=e,this.geometry=this.indexedGeometry),this.flat=t};class ju extends ja{constructor(t,e,i=16776960){const n=new ot(.5,.5,.5),r=new ot(-.5,.5,.5),s=new ot(-.5,-.5,.5),a=new ot(.5,-.5,.5),o=new ot(.5,.5,-.5),l=new ot(-.5,.5,-.5),h=new ot(-.5,-.5,-.5),c=new ot(.5,-.5,-.5),u=[n,r,r,s,s,a,a,n,o,l,l,h,h,c,c,o,n,o,r,l,s,h,a,c],d=new se(3*u.length,3),p=new Ua;d.copyVector3sArray(u),p.setPositions(d.array),super(p,t.materials.getLine2Material("basic")),this.material.vertexColors=!1,this.material.color=new $t(i),e&&this.update(e),this.type="CV.SurveyBox"}}ju.prototype.update=function(t){t.getSize(this.scale),t.getCenter(this.position),this.updateMatrix(),this.geometry.computeBoundingSphere()},ju.prototype.removed=function(){this.geometry&&this.geometry.dispose()};class Xu extends ju{constructor(t,e){const i=t.survey,n=new ct;var r=i.surveyTree,s=r;super(t,r.boundingBox,e);const a=this.material;a.stencilWrite=!0,a.stencilZPass=B,this.layers.set(5),i.addStatic(this);const o=new Set;this.setRoot=function(t){r=t},this.set=function(t){s=t,o.clear(),s===r?this.visible=!1:(t.getSubtreeIds(o),this.visible=!0,t.isStation()||void 0===t.boundingBox||this.update(t.boundingBox))},this.getIds=function(){return o},this.isEmpty=function(){return s===r},this.contains=function(t){return s===r||o.has(t)},this.getWorldBoundingBox=function(){return this.isEmpty()?i.getWorldBoundingBox():n.copy(s.boundingBox).applyMatrix4(i.matrixWorld)},this.getName=function(){return this.isEmpty()?"":s.getPath()},this.getNode=function(){return s},this.isStation=function(){return s.isStation()}}}class qu extends ja{constructor(t){const e=new Ua,i=t.survey;super(e,t.materials.getLine2Material("basivc")),this.scale.set(1,1,1),this.type="CV.Grid";const n=t.survey.combinedLimits,r=n.min.clone();r.y=n.max.y;const s=n.max.clone(),a=n.min.clone();a.x=n.max.x;const o=n.min.clone(),l=i.getGeographicalPosition(r),h=i.getGeographicalPosition(s),c=i.getGeographicalPosition(a),u=i.getGeographicalPosition(o),d=Math.min(c.x-u.x,h.x-l.x),p=Math.min(l.y-u.y,h.y-c.y),f=Math.log10(Math.max(d,p)),m=Math.pow(10,Math.round(f)-1),g=(c.x-u.x)/(a.x-o.x),v=(l.y-u.y)/(r.y-o.y),y=Math.atan2(c.y-u.y,c.x-u.x),x=Math.cos(y),_=(m-u.x%m)*x/g,M=(m-u.y%m)*x/v,b=m*x/g,S=m*x/v,w=(a.x-o.x)*(c.y-u.y)/(c.x-u.x),E=(r.y-o.y)*(l.x-u.x)/(l.y-u.y),T=n.min.z;let C;const L=t.cfg.themeColor("grid.base"),A=[],R=[];for(C=o.x+_;C<a.x;C+=b)R.push(C,o.y,T,C-E,r.y,T),A.push(L.r,L.g,L.b,L.r,L.g,L.b);for(C=o.y+M;C<r.y;C+=S)R.push(o.x,C,T,a.x,C-w,T),A.push(L.r,L.g,L.b,L.r,L.g,L.b);e.setPositions(R),e.setColors(A)}}const Yu=new Set,Zu=new $t(16777215);class Ju extends Se{constructor(t,e){super(),this.highlightBox=null,this.highlightPath=null,this.lastMarkedStation=null,this.markers=new Su(t,65280),this.featureBox=null,this.surveyTree=null,this.projection=null,this.projectionWGS84=null,this.worldBoundingBox=null,this.caveShading=1,this.surfaceShading=5,this.duplicateShading=18,this.wallsMode=!1,this.hideMode=!1,this.ctx=t,this.pointTargets=[],this.legTargets=[],this.entranceTargets=[],this.type="CV.Survey",this.cutInProgress=!1,this.features=new Map,this.routes=null,this.stations=null,this.terrain=null,this.topology=null,this.inverseWorld=new zt,this.lightDirection=new ot(-1,-1,2).normalize();const i=this;this.gradientName=t.cfg.value("saturatedGradient",!1)?"gradientHi":"gradientLow",t.surveyColourMapper=new Wu(t),t.survey=this;var n=e.getSurvey();this.name=n.title,this.CRS=n.sourceCRS,this.displayCRS=n.displayCRS,this.limits=n.limits,this.offsets=n.offsets;const r=(new ct).copy(this.limits);r.min.sub(this.offsets),r.max.sub(this.offsets),this.modelLimits=r,this.combinedLimits=r,function(){const t=n.displayCRS;if(null===n.sourceCRS||null===t||"ORIGINAL"===t)return i.scaleFactor=1,void(null!==n.sourceCRS&&(i.projectionWGS84=ch("WGS84",n.sourceCRS)));const e=i.limits,r=e.min.clone(),s=e.max.clone();r.z=0,s.z=0;const a=r.distanceTo(s),o=ch(t,n.sourceCRS);r.copy(o.forward(r)),s.copy(o.forward(s)),i.projection=o;const l=r.distanceTo(s);i.scaleFactor=a/l,Vo.scaleFactor=1/i.scaleFactor,i.projectionWGS84=ch("WGS84",n.displayCRS)}(),this.loadCave(n),this.loadWarnings(e.messages),this.legTargets=[this.features.get(1)],this.loadEntrances(),this.setFeatureBox(),this.addStatic(this.markers),this.addFeature(new qu(t),18,"Grid"),this.addEventListener("removed",this.onRemoved);var s=.5;return n=null,void Object.defineProperty(this,"zScale",{get:function(){return s},set:function(t){const e=Math.pow(2,4*(s-.5)),n=Math.pow(2,4*(t-.5));i.applyMatrix4((new zt).makeScale(1,1,n/e)),i.updateMatrix(),s=t}})}}Ju.prototype.onRemoved=function(){if(this.cutInProgress)this.cutInProgress=!1;else for(this.traverse((function(t){t.geometry&&t.geometry.dispose()}));this.children.length>0;)this.remove(this.children[0])},Ju.prototype.loadWarnings=function(t){const e=this.selection;if(t.length>0){let i=this.getFeature(14);i||(i=new Su(this.ctx,16711935)),t.forEach((t=>{const n=t.station;void 0!==n&&(e.isEmpty()||e.contains(n.id))&&(i.mark(n),n.messageText=t.text)})),this.addFeature(i,14,"CV.Survey:warnings")}},Ju.prototype.refreshColors=function(){if(this.hasFeature(6)){const t=this.getFeature(6);this.removeFeature(t),this.remove(t),this.entrances=null}if(this.loadEntrances(),this.featureBox){const t=this.getFeature(4);this.removeFeature(t),this.remove(t),this.featureBox=null}this.setFeatureBox(),this.setShadingMode(this.caveShading),this.setSurfaceShading(this.surfaceShading),this.setDuplicateShading(this.duplicateShading)},Ju.prototype.loadEntrances=function(){const t=new vu(this.ctx,this);this.addFeature(t,6,"CV.Survey:entrances"),this.entranceTargets=[t.markers],this.entrances=t},Ju.prototype.setupTerrain=function(t){if(this.combinedLimits=(new ct).copy(t.boundingBox).union(this.modelLimits),this.setFeatureBox(),t.isFlat)return;const e=this.getFeature(18);this.removeFeature(e),this.remove(e),this.addFeature(new qu(this.ctx),18);const i=[];this.surveyTree.traverse((function(t){if(!(2&t.type))return;i.push(t.p)})),t.fitSurface(i,this.offsets),null===this.terrain&&(this.terrain=t);const n=this.getFeature(6);return void(void 0!==n&&n.addHeightProvider(t.getHeight.bind(t)))},Ju.prototype.loadCave=function(t){const e=this,i=this.ctx,n=t.surveyTree;this.surveyTree=n,this.selection=new Xu(i,i.cfg.themeValue("box.select")),function(t){const n=t.length,r=[];var s,a,o,l,c;if(r[1]={vertices:[],runs:[]},r[3]={vertices:[],runs:[]},r[2]={vertices:[],runs:[]},r[19]={vertices:[],runs:[]},0===n)return null;for(o=0;o<n;o++){const e=t[o],i=e.type,n=e.survey;if(s=r[i],void 0===e){console.warn("unknown segment type: ",i);break}if(n!==c||i!==l){if(void 0!==a){const t=r[l];a.end=t.vertices.length,t.runs.push(a)}(a={}).survey=n,a.start=s.vertices.length,c=n,l=i}s.vertices.push(e.from),s.vertices.push(e.to)}void 0===a.end&&(a.end=s.vertices.length,s.runs.push(a));return u(1,"CV.Survey:cave:cave"),u(3,"CV.Survey:surface:surface"),u(2,"CV.Survey:cave:splay"),void u(h,"CV.Survey:cave:duplicate");function u(t,n){const s=r[t];if(0===s.vertices.length)return;const a=new Tu(i);a.addLegs(s.vertices,s.runs),e.addFeature(a,t,n+":g")}}(t.lineSegments),this.loadStations(n),function(t){if(!1===t.hasTerrain)return;const n=new Gu(i,t.terrains,e.offsets);e.terrain=n}(t),this.computeBoundingBoxes(n),this.pointTargets.push(this.stations);const r=new Pu(this.name,t.metadata);return this.metadata=r,this.loadDyeTraces(),this.topology=new wu(this.stations,this.getFeature(1)),this.routes=new Eu(this),void Vu(t,this)},Ju.prototype.getFeature=function(t){return this.features.get(t)},Ju.prototype.update=function(t,e,i){const n=t.activeCamera,r=this.features.get(6);r&&t.testCameraLayer(6)?(t.setCameraLayer(16,i),r.cluster(n,e,this.selection,i)):t.setCameraLayer(16,!1);const s=this.features.get(o);(s&&t.testCameraLayer(o)||s.commentCount>0&&t.testCameraLayer(l))&&s.update(n,e,this.inverseWorld)},Ju.prototype.addFeature=function(t,e,i){return t.name=i,t.layers.set(e),this.features.set(e,t),this.addStatic(t),t},Ju.prototype.removeFeature=function(t){this.layers.mask&=~t.layers.mask;const e=this.features;e.forEach(((i,n)=>{i===t&&e.delete(n)}))},Ju.prototype.hasFeature=function(t){return this.features.has(t)},Ju.prototype.loadStations=function(t){const e=new _u(this.ctx,this.selection);var i=0;t.traverse((function(t){void 0!==t.comment&&i++;if(!t.isStation())return;e.addStation(t)})),e.finalise();const n=new bu(this.ctx,e,i);return this.addFeature(e,8,"CV.Stations"),this.addFeature(n,o,"CV.StationLabels"),i>0&&(this.features.set(l,n),n.layers.enable(l)),void(this.stations=e)},Ju.prototype.computeBoundingBoxes=function(t){return void t.traverseDepthFirst((function(t){const e=t.parent;e&&void 0===e.boundingBox&&(e.boundingBox=new ct);if(t.isStation())e.boundingBox.expandByPoint(t.p);else if(e){if(0===t.children.length||void 0!==t.boundingBox&&t.boundingBox.isEmpty())return;e.boundingBox.expandByPoint(t.boundingBox.min),e.boundingBox.expandByPoint(t.boundingBox.max)}}))},Ju.prototype.loadDyeTraces=function(){const t=new Ru(this.ctx);this.addFeature(t,9,"CV.DyeTraces"),this.dyeTraces=t},Ju.prototype.setScale=function(t,e){this.scale.set(t,t,e),this.updateMatrix(),this.updateMatrixWorld(),this.inverseWorld.copy(this.matrixWorld).invert(),this.worldBoundingBox=this.combinedLimits.clone().applyMatrix4(this.matrixWorld)},Ju.prototype.getLegs=function(){return this.getFeature(1).legVertices},Ju.prototype.getRoutes=function(){return this.routes},Ju.prototype.getWorldPosition=function(t){return t.applyMatrix4(this.matrixWorld)},Ju.prototype.getGeographicalPosition=function(t){const e=this.offsets,i=this.projection;let n={x:t.x+e.x,y:t.y+e.y};return null!==i&&(n=i.forward(n)),n.z=t.z+e.z,n},Ju.prototype.containsWGS84Position=function(t){t.copy(this.projectionWGS84.forward(t));const e=this.limits.min,i=this.limits.max;return t.x>=e.x&&t.x<=i.x&&t.y>=e.y&&t.y<=i.y},Ju.prototype.getModelSurfaceFromWGS84=function(t,e){const i=this.offsets;return t.copy(this.projectionWGS84.forward(t)),void this.terrain.getHeights([t],(function(n){t.z=n[0].z,t.sub(i),e()}))},Ju.prototype.shortestPathSearch=function(t){this.highlightPath=null,this.markers.clear(),this.topology.shortestPathSearch(t),this.markers.mark(t),this.setShadingMode(r)},Ju.prototype.showShortestPath=function(t){this.highlightPath=this.topology.getShortestPath(t),null!==this.lastMarkedStation&&this.markers.unmark(this.lastMarkedStation),this.markers.mark(t),this.lastMarkedStation=t,this.setLegShading(1,r)},Ju.prototype.getMaxDistance=function(){return this.topology.maxDistance},Ju.prototype.selectStation=function(t){this.stations.selectStation(t)},Ju.prototype.highlightSelection=function(t){if(t.isStation())this.stations.highlightStation(t);else{let e=this.highlightBox;null===e&&(e=new Xu(this.ctx,this.ctx.cfg.themeValue("box.highlight")),this.highlightBox=e),e.set(t),this.stations.clearHighlight(),t===this.surveyTree?this.entrances.setSelection(this.selection):this.entrances.setSelection(e)}},Ju.prototype.selectSection=function(t){const e=this.selection;return this.highlightSelection(this.surveyTree),e.set(t),this.stations.selectStations(e),this.entrances.setSelection(e),this.setShadingMode(this.caveShading),t},Ju.prototype.setFeatureBox=function(){if(null===this.featureBox){const t=new ju(this.ctx,this.combinedLimits,this.ctx.cfg.themeColorCSS("box.bounding"));this.addFeature(t,4,"survey-boundingbox"),this.featureBox=t}else this.featureBox.update(this.combinedLimits);this.worldBoundingBox=this.combinedLimits.clone().applyMatrix4(this.matrixWorld)},Ju.prototype.getWorldBoundingBox=function(){return this.worldBoundingBox},Ju.prototype.cutSection=function(t){const e=this.selection;if(e.set(t),e.isEmpty())return;this.pointTargets=[],this.legTargets=[],this.entranceTargets=[],this.terrain=null;const i=[];return this.traverse((function(t){switch(t.type){case"Legs":case"Walls":t.cutRuns(e)||i.push(t);break;case"CV.SurveyBox":case"CV.Stations":case"CV.StationLabels":case"CV.ClusterMarker":i.push(t)}})),i.forEach((t=>{const e=t.parent;e&&e.remove(t),t.geometry&&t.geometry.dispose(),this.removeFeature(t)})),this.surveyTree=t,this.selection.setRoot(t),this.highlightBox&&this.highlightBox.setRoot(t),this.loadStations(t),this.pointTargets.push(this.stations),this.selectSection(t),this.modelLimits=this.getBounds(),this.combinedLimits=this.modelLimits,this.limits.copy(this.modelLimits),this.limits.min.add(this.offsets),this.limits.max.add(this.offsets),this.featureBox=null,this.setFeatureBox(),this.worldBoundingBox=null,this.loadEntrances(),this.topology=new wu(this.stations,this.getFeature(1)),void(this.cutInProgress=!0)},Ju.prototype.getBounds=function(){const t=new ct,e=t.min,i=t.max;return this.traverse((function(t){if("CV.Survey"===t.type||"CV.Box3"===t.type)return;const n=t.geometry;n&&n.boundingBox&&(e.min(n.boundingBox.min),i.max(n.boundingBox.max))})),t},Ju.prototype.setWallsMode=function(t){const e=this.getFeature(s),i=this.getFeature(a);e&&e.setFlat(t),i&&i.setFlat(t),this.wallsMode=t},Ju.prototype.setHideMode=function(t){const e=this.getFeature(1);e&&e.hide(t),this.hideMode=t},Ju.prototype.setShadingMode=function(t){const e=this.ctx.materials;var i;switch(t){case 1:i=e.getHeightMaterial(2);break;case 4:i=e.getCursorMaterial(2);break;case 5:i=e.getSurfaceMaterial();break;case 9:if(null===this.terrain)return!1;if(!(i=e.getDepthMaterial(2)))return!1;break;case n:if(null===this.terrain)return!1;if(!(i=e.getDepthCursorMaterial(2)))return!1;break;case r:case 6:i=!1}return this.markers.setVisibility(t===r),this.setLegShading(1,t)&&(this.setWallShading(this.features.get(s),i),this.setWallShading(this.features.get(a),i),this.caveShading=t),this.caveShading},Ju.prototype.setWallShading=function(t,e){t&&(e?t.setShading(this.selection,e):t.visible=!1)},Ju.prototype.setSurfaceShading=function(t){return this.setLegShading(3,t,!0)&&(this.surfaceShading=t),this.surfaceShading},Ju.prototype.setDuplicateShading=function(t){return this.setLegShading(h,t,!0)&&(this.duplicateShading=t),this.duplicateShading},Ju.prototype.setLegShading=function(t,e,s){const a=this.features.get(t);if(void 0===a)return!1;switch(e){case 1:this.setLegColourByMaterial(a,"height",s);break;case 2:this.setLegColourByLength(a);break;case 3:this.setLegColourByInclination(a);break;case 4:this.setLegColourByMaterial(a,"cursor");break;case n:this.setLegColourByMaterial(a,"depth-cursor");break;case 5:this.setLegColourByColour(a,this.ctx.cfg.themeColor("shading.single"),s);break;case 17:this.setLegColourByColour(a,this.ctx.cfg.themeColor("shading.surface"),s);break;case 18:this.setLegColourByColour(a,this.ctx.cfg.themeColor("shading.duplicate"),s);break;case 6:this.setLegColourBySurvey(a);break;case i:this.setLegColourByPath(a);break;case 7:case 8:break;case 9:this.setLegColourByMaterial(a,"depth",s);break;case r:0===this.topology.maxDistance?this.setLegColourByColour(a,this.ctx.cfg.themeColor("shading.unconnected")):this.setLegColourByDistance(a);break;default:return console.warn("invalid leg shading mode"),!1}return!0},Ju.prototype.setLegColourByMaterial=function(t,e,i){t.setShading(this.selection.getIds(),(function(t,e,i,n){Zu.toArray(e,3*i),Zu.toArray(e,3*n)}),e,i)},Ju.prototype.setLegColourByColour=function(t,e,i){t.setShading(this.selection.getIds(),(function(t,i,n,r){e.toArray(i,3*n),e.toArray(i,3*r)}),"basic",i)},Ju.prototype.setLegColourByLength=function(t){const e=this.ctx.materials.colourCache.getColors(this.gradientName),i=e.length-1,n=t.stats,r=t.legLengths;t.setShading(this.selection.getIds(),(function(t,s,a,o){const l=(r[a/2]-n.minLegLength)/n.legLengthRange,h=e[Math.floor(l*i)];h.toArray(s,3*a),h.toArray(s,3*o)}),"basic")},Ju.prototype.setLegColourByDistance=function(t){const e=this.ctx.cfg,i=this.ctx.materials.colourCache.getColors(this.gradientName),n=e.themeColor("shading.unconnected"),r=e.themeColor("routes.active"),s=this.stations,a=i.length-1,o=this.topology.maxDistance,l=this.highlightPath;function h(t,e){const r=t[e],l=s.getStation(r).distance;return l===1/0?n:i[Math.floor(a*l/o)]}t.setShading(this.selection.getIds(),(function(t,e,i,n){const s=null!==l&&l.has(i),a=s?r:h(t,i),o=s?r:h(t,n);a.toArray(e,3*i),o.toArray(e,3*n)}),"basic")},Ju.prototype.setLegColourBySurvey=function(t){for(var e=this.selection.getNode();1===e.children.length;)e=e.children[0];Yu.clear(),e.getSubtreeIds(Yu);const i=this.ctx.surveyColourMapper.getColourMap(e);t.setShading(Yu,(function(t,e,n,r,s){const a=i[s];a.toArray(e,3*n),a.toArray(e,3*r)}),"basic")},Ju.prototype.setLegColourByPath=function(t){const e=this.routes,i=this.ctx.cfg,n=i.themeColor("routes.active"),r=i.themeColor("routes.adjacent"),s=i.themeColor("routes.default");t.setShading(this.selection.getIds(),(function(t,i,a,o){var l;l=e.inCurrentRoute(a)?n:e.adjacentToRoute(a)?r:s;l.toArray(i,3*a),l.toArray(i,3*o)}),"basic")},Ju.prototype.setLegColourByInclination=function(t){const e=this.ctx.materials.colourCache.getColors("inclination"),i=2*(e.length-1)/Math.PI,n=new ot;t.setShading(this.selection.getIds(),(function(t,r,s,a){const o=t[s],l=t[a];n.subVectors(o,l).normalize();const h=n.dot(Se.DefaultUp),c=Math.floor(i*Math.acos(Math.abs(h))),u=e[c];u.toArray(r,3*s),u.toArray(r,3*a)}),"basic")},Ju.prototype.gltfExport=function(t,e,i){const n=[];if(t.walls&&n.push(this.getMesh(s)),t.scraps&&n.push(this.getMesh(a)),t.legs){const t=this.getFeature(1).geometry;n.push({type:"lines",index:t.index,position:t.getAttribute("position"),modelLimits:this.modelLimits})}if(0===n.length)return;const r=new Worker(this.ctx.cfg.value("home","")+"js/workers/gltfWorker.js");r.addEventListener("message",(function(t){var n;n=e.binary?"application/octet-stream":"application/gltf+json",r.terminate(),i(new Blob([t.data.gltf],{type:n}),e.binary)})),r.postMessage({items:n,options:e})},Ju.prototype.getMesh=function(t){const e=this.getFeature(t).geometry;return{type:"walls",index:e.index,position:e.getAttribute("position"),modelLimits:this.modelLimits}};class Ku extends ke{constructor(t,e,i,n){const r=Math.cos(i),s=Math.sin(i),a=window.devicePixelRatio||1,o=e.image,l=new Float32Array([r,s,-s,r]),h=new Q(o.width*a/t.clientWidth,o.height*a/t.clientHeight);n=n||[1,1,1],super({vertexShader:Ga.popupVertexShader,fragmentShader:Ga.popupFragmentShader,type:"CV.PopupMaterial",uniforms:{rotate:{value:l},popupImage:{value:e},scale:{value:h}},defines:{USE_COLOR:!0}}),this.opacity=1,this.alphaTest=.8,this.depthTest=!1,this.transparent=!0,this.texture=e,this.defaultAttributeValues.color=n}}class Qu extends De{constructor(){super(),this.type="PopupGeometry",this.setIndex(Ea.index),this.setAttribute("position",Ea.position)}}var $u=null;class td extends wi{constructor(t){null===$u&&($u=new Qu),super($u),this.layers.set(1),this.type="Popup",this.renderOrder=1/0,this.ctx=t}}td.prototype.close=function(){this.parent&&this.parent.remove(this);const t=this.materal;t&&(t.dispose(),t.texture&&t.texture.dispose())};class ed extends td{constructor(t){return super(t),this.lines=[],this.type="CanvasPopup",this}}ed.prototype.addLine=function(t){return this.lines.push(t),this},ed.prototype.finish=function(){const t=this.ctx.cfg,e=this.ctx.container,i=this.lines,n=i.length,r=32*n,s=document.createElement("canvas");s||console.error("creating canvas for CanvasPopup failed"),s.width=256,s.height=r;const a=s.getContext("2d");var o;for(a||console.error("cannot obtain 2D canvas"),a.fillStyle=t.themeColorCSS("popup.background"),a.fillRect(0,0,256,r),a.strokeStyle=t.themeColorCSS("popup.border"),a.lineWidth=2,a.strokeRect(0,0,256,r),a.textAlign="left",a.font="20px normal helvetica,sans-serif",a.fillStyle=t.themeColorCSS("popup.text"),o=0;o<n;o++)a.fillText(i[o],10,32*(o+1)-6);const l=new Gs(s);l.onUpdate=function(t){t.image=null};const h=new Ku(e,l,0);return this.material=h,this.material.needsUpdate=!0,this};class id extends ed{constructor(t,e,i,n,r,s,a){super(t);const o=i.getGeographicalPosition(e.p);for(var l,h,c=e.getPath(),u=!1,d=null;c.length>20;)(l=c.split(".")).shift(),c=l.join("."),u=!0;if(h=s?e.distance!==1/0?Math.round(e.distance):"unconnected":null,u&&(c="..."+c),this.addLine(c),a&&void 0!==e.messageText)this.addLine(e.messageText);else if(void 0!==r&&(d=r(i.CRS,o,n,h)),null!==d)for(let t=0;t<d.length;t++)this.addLine(d[t]);else this.addLine("x: "+Math.round(o.x)+" m, y: "+Math.round(o.y)+" m").addLine("z: "+Math.round(o.z)+" m"),null!==n&&this.addLine("depth from surface: "+Math.round(n)+" m"),s&&this.addLine("distance: "+h+"m");this.finish(),this.position.copy(e.p)}}class nd extends td{constructor(t,e,i,n){super(t),this.type="ImagePopup";(new Ks).load(i,(function(t){r.material=new Ku(r.ctx.container,t,0),r.material.needsUpdate=!0,n()})).onUpdate=function(t){t.image=null},this.position.copy(e.p);const r=this}}const rd=new ot,sd=new ot,ad=new ot,od=new ot,ld=new si(rd,sd,ad),hd=new si(rd,ad,od);class cd extends wi{constructor(t,e,i,n,r){super(new De,t.materials.getSurfaceMaterial()),this.x=e,this.y=i,this.zoom=n,this.tileSet=r.tileSet,this.clip=r.clip,this.clippedFraction=r.clippedFraction,this.canZoom=n<r.tileSet.overlayMaxZoom,this.evicted=!1,this.replaced=!1,this.evictionCount=0,this.lastFrame=0,this.childrenLoading=0,this.childErrors=0,this.area=0,this.boundingBox=null,this.worldBoundingBox=null,this.type="Tile",this.isTile=!1}}function ud(t,e){this.CRS=e,this.transform=ch(e,"EPSG:4326"),this.transformedLimits=null;const i="https://api.cesium.com/v1/assets/1/endpoint?access_token="+t.cfg.value("cesiumAccessToken","no access token");return new Promise(((t,e)=>{(new $s).setResponseType("text").load(i,(e=>{const i=JSON.parse(e);this.url=i.url,this.accessToken=i.accessToken,this.attributions=i.attributions,ud.defaultTileSet.valid=!0,t(this)}),(function(){}),(()=>{console.warn("cesium api error"),e(this)}))}))}cd.liveTiles=0,cd.prototype.onBeforeRender=function(t){this.lastFrame=t.info.render.frame},cd.prototype.createFromTileData=function(t,e){const i=t.attributes,n=t.index,r=t.boundingBox;var s,a,o=this.geometry;for(s in i)a=i[s],o.setAttribute(s,new se(a.array,a.itemSize));return o.setIndex(new ne(n,1)),o.boundingBox=new ct(new ot(r.min.x,r.min.y,r.min.z),new ot(r.max.x,r.max.y,r.max.z)),this.boundingBox=o.boundingBox,this.dropBuffers(),this.layers.set(7),this.material=e,this.isTile=!0,this.canZoom=t.canZoom&&this.canZoom,null===this.worldBoundingBox&&(this.updateWorldMatrix(!0,!1),this.worldBoundingBox=this.boundingBox.clone().applyMatrix4(this.matrixWorld)),this},cd.prototype.empty=function(){this.isMesh=!1,this.geometry&&(this.geometry.dispose(),this.geometry=new De),--cd.liveTiles},cd.prototype.evict=function(){this.evicted=!0,this.replaced=!1,this.evictionCount=0,this.children.forEach((t=>t.evict())),this.empty()},cd.prototype.setReplaced=function(){this.evicted=!1,this.replaced=!0,this.empty()},cd.prototype.setSkipped=function(){this.parent.childrenLoading--,this.evicted=!1,this.replaced=!0},cd.prototype.setPending=function(t){t&&null===this.parent&&t.addStatic(this),this.parent.childrenLoading++,this.isMesh=!1,this.evicted=!1,this.replaced=!1,this.evictionCount=0},cd.prototype.setFailed=function(){const t=this.parent;t.childErrors++,t.childrenLoading--,t.canZoom=!1,t.remove(this)},cd.prototype.setLoaded=function(t,e){const i=this.parent;var n=0;if(0==--i.childrenLoading){if(0===i.childErrors)return i.isTile&&i.setReplaced(),i.children.forEach((i=>{i.replaced||i.evicted||(null===t?(i.isMesh=!0,cd.liveTiles++):(n++,i.setOverlay(t).then((t=>{t.isMesh=!0,cd.liveTiles++,0==--n&&e(this.canZoom)}))))})),void(0===n&&e(!1));i.remove(this)}e(!1)},cd.prototype.removed=function(){this.geometry&&this.geometry.dispose()},cd.prototype.setMaterial=function(t){this.material=t},cd.prototype.setThroughMode=function(t){this.isTile&&this.isMesh&&this.material.setThroughMode(t)},cd.prototype.setOverlay=function(t){return t.getTile(this.x,this.y,this.zoom).then((e=>(null!==e&&(this.material=e,e.setThroughMode(t.throughMode)),this)))},cd.prototype.computeProjectedArea=function(t){const e=this.worldBoundingBox,i=e.max.z;return rd.copy(e.min).setZ(i),ad.copy(e.max),sd.set(rd.x,ad.y,i),od.set(ad.x,rd.y,i),rd.project(t),sd.project(t),ad.project(t),od.project(t),this.area=(ld.getArea()+hd.getArea())/this.clippedFraction,this},ud.defaultTileSet={title:"Cesium",initialZoom:12,overlayMaxZoom:16,maxZoom:17,minZoom:10,divisions:1,subdirectory:null,dtmScale:64,minX:0,maxX:2048,minY:0,maxY:1023,attributions:[],log:!0,valid:!1},ud.prototype.workerScript="webMeshWorker.js",ud.prototype.getTileSets=function(){return[ud.defaultTileSet]},ud.prototype.getScreenAttribution=function(){const t=this.attributions;if(0===t.length)return null;const e=document.createElement("div");e.classList.add("overlay-branding");for(var i=0;i<t.length;i++){const n=t[i];e.innerHTML=n.html;break}return e},ud.prototype.getCoverage=function(t,e){const i={zoom:e};null===this.transformedLimits&&(this.transformedLimits=new Ma);const n=this.transformedLimits;n.expandByPoint(this.transform.forward(t.min.clone())),n.expandByPoint(this.transform.forward(t.max.clone()));const r=n.min,s=n.max,a=Math.pow(2,e)/180;return i.minX=Math.floor((r.x- -180)*a),i.maxX=Math.floor((s.x- -180)*a),i.minY=Math.floor((r.y- -90)*a),i.maxY=Math.floor((s.y- -90)*a),i.count=(i.maxX-i.minX+1)*(i.maxY-i.minY+1),i},ud.prototype.getTileSpec=function(t,e,i,n){const r=new Ma,s=180/Math.pow(2,i);if(r.min.x=t*s-180,r.min.y=e*s-90,r.max.x=(t+1)*s-180,r.max.y=(e+1)*s-90,!this.transformedLimits.intersectsBox(r))return null;const a=new Q;return r.clone().intersect(this.transformedLimits).getSize(a),{tileSet:this.tileSet,divisions:1,resolution:s,x:t,y:e,z:i,clip:n,offsets:null,flatZ:null,displayCRS:this.CRS,url:this.url,accessToken:this.accessToken,clippedFraction:a.x*a.y/s*s,request:"tile"}};const dd=6378137*Math.PI;var pd;function fd(t){return new Promise((e=>{(new $s).setResponseType("text").load(t.cfg.value("terrainDirectory","")+"/tileSets.json",(t=>{(pd=JSON.parse(t)).push(fd.defaultTileSet),e(this)}),(function(){}),(()=>{pd=[fd.defaultTileSet],e(this)}))}))}fd.defaultTileSet={isFlat:!0,title:"flat",overlayMaxZoom:18,maxZoom:16,minZoom:10,divisions:128,subdirectory:null,dtmScale:64,minX:0,maxX:1023,minY:0,maxY:1023,attributions:[],log:!0},fd.prototype.workerScript="webTileWorker.js",fd.prototype.getTileSets=function(){return pd},fd.prototype.getScreenAttribution=function(){return null},fd.prototype.getCoverage=function(t,e){const i={zoom:e},n=dd,r=-dd,s=Math.pow(2,e-1)/dd;return i.minX=Math.floor((t.min.x-r)*s),i.maxX=Math.floor((t.max.x-r)*s),i.maxY=Math.floor((n-t.min.y)*s),i.minY=Math.floor((n-t.max.y)*s),i.count=(i.maxX-i.minX+1)*(i.maxY-i.minY+1),i},fd.prototype.getTileSpec=function(t,e,i,n){const r=this.tileSet,s=i>r.maxZoom?Math.pow(2,r.maxZoom-i):1;if(1!==s&&null===this.activeOverlay)return null;this.log&&console.log("load: [ ",i+"/"+t+"/"+e,"]");const a=dd/Math.pow(2,i-1),o={top:0,bottom:0,left:0,right:0},l=a*t-dd,h=l+a,c=dd-a*e,u=c-a,d=r.divisions*s,p=a/d;if(c>n.max.y&&(o.top=Math.floor((c-n.max.y)/p)),u<n.min.y&&(o.bottom=Math.floor((n.min.y-u)/p)),l<n.min.x&&(o.left=Math.floor((n.min.x-l)/p)),h>n.max.x&&(o.right=Math.floor((h-n.max.x)/p)),o.top>=d||o.bottom>=d||o.left>=d||o.right>=d)return null;return{tileSet:r,divisions:d,resolution:p,x:t,y:e,z:i,clip:o,offsets:null,flatZ:null,clippedFraction:(d-o.top-o.bottom)*(d-o.left-o.right)/(d*d),request:"tile"}},fd.prototype.findTile=function(t){const e=this.tileSet,i=dd/Math.pow(2,e.maxZoom-1),n=(t.x+dd)/i,r=(dd-t.y)/i,s=Math.floor(n),a=Math.floor(r),o=e.maxZoom,l=n-s,h=r-a,c=e.divisions+1;return{x:s,y:a,z:o,tileSet:e,dataOffsets:[Math.floor(c*l)+c*Math.floor(c*h)],points:[t],request:"height",clip:{}}};const md=new Ot,gd=new zt,vd={type:"progress",name:"start"},yd={type:"progress",name:"end"};function xd(t,e){const i=e.zoom-t.zoom;if(0!==i)return i;const n=t.lastFrame-e.lastFrame;if(0!==n)return n;const r=t.x-e.x;return 0!==r?r:t.y-e.y}class _d extends Uu{constructor(t,e,i){let n;switch(super(t),this.name="WebTerrain",this.type="CV.WebTerrain",this.attributions=[],this.log=!1,this.ctx=t,this.displayCRS=e.displayCRS,this.surveyCRS=e.CRS,this.limits=e.limits,this.flatZ=e.modelLimits.max.z,this.offsets=e.offsets,this.onLoaded=i,this.childrenLoading=0,this.childErrors=0,this.isLoaded=!1,this.material=null,this.initialZoom=null,this.dying=!1,this.tilesLoading=0,this.maxTilesLoading=0,this.overlaysLoading=0,this.debug=!0,this.coverage=null,this.TS=null,this.maxTiles=t.cfg.value("maxTiles",128),this.retile_timeout=80,this.retileScaler=4,this.lastActivityTime=0,this.timerId=null,this.material=t.materials.getCursorMaterial(),this.canZoom=!0,this.watcher=this.scheduleRetile.bind(this),this.updateFunc=_d.prototype.zoomCheck.bind(this),this.displayCRS){case"EPSG:3857":n=new fd(t);break;case"EPSG:4326":case"ORIGINAL":n=new ud(t,this.surveyCRS);break;default:return void i(this)}n.then((e=>{console.log(e),this.workerPool=t.workerPools.getPool(e.workerScript),this.TS=e,this.tileSets=e.getTileSets(),this.screenAttribution=e.getScreenAttribution(),this.hasCoverage()?this.tileArea(this.limits):(console.log("no terrain found"),i(this))})).catch((()=>{console.log("error loading tile set")}))}}_d.prototype.isTiled=!0,_d.prototype.hasCoverage=function(){const t=this.limits,e=this.ctx.cfg.value("terrainDirectory",""),i=this.tileSets,n=this.TS;for(var r=0,s=i.length;r<s;r++){const s=i[r];if(!1===s.valid)continue;const a=n.getCoverage(t,s.minZoom);if(a.minX>=s.minX&&a.maxX<=s.maxX&&a.minY>=s.minY&&a.maxY<=s.maxY)return s.directory=e+s.subdirectory,n.tileSet=s,this.isFlat=s.isFlat,this.log=void 0!==s.log&&s.log,this.attributions=s.attributions,console.log("selected tile set:",s.title),!0}return!1},_d.prototype.loadTile=function(t,e,i,n,r){void 0===r&&(r=n.children.find((function(n){return n.x===t&&n.y===e&&n.zoom===i})));const s=this,a=this.TS.getTileSpec(t,e,i,this.limits);if(null===a)return;a.offsets=this.offsets,a.flatZ=this.flatZ,0===this.tilesLoading&&(this.dispatchEvent(vd),this.maxTilesLoading=0),this.maxTilesLoading=Math.max(this.maxTilesLoading,++this.tilesLoading),this.log&&console.log("load: [ ",i+"/"+t+"/"+e,"]",this.tilesLoading);const o=r||new cd(this.ctx,t,e,i,a);return o.setPending(n),void this.workerPool.runWorker(a,(function(t){if(--s.tilesLoading,s.dying)return void s.dispatchEvent(yd);if("zoom"===t.status)return o.setSkipped(),void s.zoomTile(o,o.parent);if("ok"!==t.status||0!==o.parent.childErrors)return o.setFailed(),0!==s.tilesLoading||s.isLoaded||s.onLoaded(s),void s.dispatchEvent(yd);o.createFromTileData(t,s.material),s.dispatchEvent({type:"progress",name:"set",progress:100*(s.maxTilesLoading-s.tilesLoading)/s.maxTilesLoading}),o.setLoaded(s.activeOverlay,l)}));function l(t){t&&null!==s.activeOverlay&&o.zoom<s.activeOverlay.getMinZoom()&&s.zoomTile(o),0===s.tilesLoading&&(0===s.tilesLoading&&s.dispatchEvent(yd),s.isLoaded||(s.isLoaded=!0,s.onLoaded(s)))}},_d.prototype.tileArea=function(t){const e=this.TS.tileSet;let i,n=e.initialZoom||e.overlayMaxZoom+1;do{i=this.TS.getCoverage(t,--n)}while(i.count>4&&n>e.minZoom);this.initialZoom=n,this.coverage=i;for(var r=i.minX;r<i.maxX+1;r++)for(var s=i.minY;s<i.maxY+1;s++)this.loadTile(r,s,n,this)},_d.prototype.tileSet=function(){const t=Object.assign({},fd.defaultTileSet),e=this.coverage;return delete t.isFlat,delete t.directory,t.title="new tile set",t.subdirectory="new_tile_set",t.minZoom=e.zoom,t.minX=e.minX,t.maxX=e.maxX,t.minY=e.minY,t.maxY=e.maxY,Ho(t)},_d.prototype.zoomTile=function(t,e=t){const i=t.zoom+1,n=2*t.x,r=2*t.y;this.loadTile(n,r,i,e),this.loadTile(n+1,r,i,e),this.loadTile(n,r+1,i,e),this.loadTile(n+1,r+1,i,e)},_d.prototype.setOverlay=function(t,e){if(this.tilesLoading>0)return;const i=this.activeOverlay,n=t.throughMode;if(null!==i){if(i===t)return void this.traverse((t=>t.setThroughMode(n)));i.setInactive()}t.setActive(),this.activeOverlay=t;const r=t.getMinZoom();this.traverse((i=>{i.isTile&&i.isMesh&&(i.zoom<r?this.zoomTile(i):(this.overlaysLoading++,i.setOverlay(t).then((()=>{0==--this.overlaysLoading&&e()}))))}))},_d.prototype.removed=function(){this.dying=!0,this.traverse((t=>{t!==this&&t.removed(t)})),this.commonRemoved()},_d.prototype.setMaterial=function(t){this.tilesLoading>0||(this.traverse((e=>{e.isTile&&e.setMaterial(t)})),this.activeOverlay=null,t.needsUpdate=!0,t.fog=!1,this.material=t)},_d.prototype.zoomCheck=function(t){if(performance.now()-this.lastActivityTime<this.retile_timeout)return;if(this.tilesLoading>0)return!0;const e=md,i=t.activeCamera,n=t.getLastFrame(),r=[],s=[],a=[];var o=!1;e.setFromProjectionMatrix(gd.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse)),this.traverse((function(t){const o=t.parent;if(!t.isTile||!o.canZoom)return;t.isMesh&&t.canZoom&&t.lastFrame===n?(t.computeProjectedArea(i),t.area/4>.81&&r.push(t)):!o.isMesh&&t.evicted&&e.intersectsBox(t.worldBoundingBox)?(t.traverse((function(e){e!==t&&(e.evicted=!1,e.replaced=!0)})),a.push(t)):t.isMesh&&t.lastFrame!==n&&s.push(t)}));const l=a.length,h=r.length,c=s.length;let u=cd.liveTiles-this.maxTiles;if(Math.min(c,u)>0){s.sort(xd);const t=performance.now(),e=s.length;for(let i=0;i<e;i++){const e=s[i];if(0===e.evictionCount)e.evictionCount=t;else if(t-e.evictionCount>1e3&&(e.evict(),--u))break}}if(0!==l){for(let t=0;t<l;t++){const e=a[t];this.loadTile(e.x,e.y,e.zoom,e.parent,e)}o=!0}else if(0!==h){for(let t=0;t<h;t++)this.zoomTile(r[t]);o=!0}return void(o&&(this.timerId=setTimeout(this.updateFunc,this.retile_timeout*this.retileScaler,t),this.retileScaler*=2))},_d.prototype.getHeights=function(t,e){const i=this.TS,n={},r=[];t.forEach((function(t,e){const r=i.findTile(t),s=r.x+":"+r.y+":"+r.z;t.index=e,void 0===n[s]?n[s]=r:(n[s].dataOffsets.push(r.dataOffsets[0]),n[s].points.push(r.points[0]))}));let s=0;for(var a in n)this.workerPool.runWorker(n[a],o),s++;return;function o(t){t.points.forEach((t=>r[t.index]=t)),0==--s&&e(r)}},_d.prototype.fitSurface=function(t,e){if(void 0===this.TS.findTile)return void this._fitSurface(t);const i=t.map((t=>t.clone().add(e)));this.getHeights(i,(t=>{let e=0,n=0,r=0;t.forEach((t=>{const s=i[t.index].z-t.z;n+=s,r+=s*s,e++}));const s=Math.sqrt(r/e-Math.pow(n/e,2));this.datumShift=n/e,console.log("Adjustmenting terrain height by:",this.datumShift,"sd:",s)}))},_d.prototype.scheduleRetile=function(t){this.visible&&(null!==this.timerId&&clearTimeout(this.timerId),this.retileScaler=4,this.lastActivityTime=performance.now(),this.timerId=setTimeout(this.updateFunc,this.retile_timeout,t.cameraManager))},_d.prototype.watch=function(t){t.addEventListener("moved",this.watcher)},_d.prototype.unwatch=function(t){t.removeEventListener("moved",this.watcher)};var Md="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},bd={exports:{}},Sd={exports:{}};!function(t,e){(function(){var e,i,n,r;n=function(t,e){return Object.prototype.toString.call(e).match(/\s(\w+)/)[1].toLowerCase()===t},i=function(t){return!!t&&n("object",t)},r=function(t){return n("array",t)?t:[t]},e=function(){function t(){this.__eventStore={},this.__asyncEvents=!0}return t.mixin=function(e){var i,n,r,s;for(n in e.__eventStore={},s=[],r=t.prototype)i=r[n],s.push(e[n]=i);return s},t.prototype.on=function(t,e,n){var s,a,o,l,h;if(null==n&&(n=!1),i(t))for(h in t)e=t[h],this.on(h,e);else for(a=0,o=(l=r(t)).length;a<o;a++)h=l[a],(s=this.__eventStore)[h]||(s[h]=[]),this.__eventStore[h].push({fn:e,once:n});return this},t.prototype.once=function(t,e){return e?this.on(t,e,!0):this.on(t,!0)},t.prototype.off=function(t,e){var n,s,a,o,l,h,c;if(!e)for(n=0,a=(l=r(t)).length;n<a;n++)c=l[n],this.__eventStore[c]=[];if(i(t))for(c in t)e=t[c],this.off(c,e);else for(s=0,o=(h=r(t)).length;s<o;s++)c=h[s],this.__eventStore[c]=(this.__eventStore[c]||[]).filter((function(t){return t.fn!==e}));return this},t.prototype.trigger=function(t,e){var i,n;return e||(e=[]),null!=(i=this.__eventStore[t])&&i.forEach((n=this,function(i){var r,s;if(r=i.fn,s=i.once,n.__asyncEvents?setTimeout((function(){return r.apply(null,e)}),1):r.apply(null,e),s)return n.off(t,r)})),this},t}(),t.exports=e}).call(Md)}(Sd),function(t,e){(function(){var e,i,n,r;n=function(t,e){return Object.prototype.toString.call(e).match(/\s(\w+)/)[1].toLowerCase()===t},i=function(t){return!!t&&n("object",t)},r=function(t){return n("array",t)?t:[t]},e=function(){function t(){this.__eventStore={},this.__asyncEvents=!0}return t.mixin=function(e){var i,n,r,s;for(n in e.__eventStore={},s=[],r=t.prototype)i=r[n],s.push(e[n]=i);return s},t.prototype.on=function(t,e,n){var s,a,o,l,h;if(null==n&&(n=!1),i(t))for(h in t)e=t[h],this.on(h,e);else for(a=0,o=(l=r(t)).length;a<o;a++)h=l[a],(s=this.__eventStore)[h]||(s[h]=[]),this.__eventStore[h].push({fn:e,once:n});return this},t.prototype.once=function(t,e){return e?this.on(t,e,!0):this.on(t,!0)},t.prototype.off=function(t,e){var n,s,a,o,l,h,c;if(!e)for(n=0,a=(l=r(t)).length;n<a;n++)c=l[n],this.__eventStore[c]=[];if(i(t))for(c in t)e=t[c],this.off(c,e);else for(s=0,o=(h=r(t)).length;s<o;s++)c=h[s],this.__eventStore[c]=(this.__eventStore[c]||[]).filter((function(t){return t.fn!==e}));return this},t.prototype.trigger=function(t,e){var i,n;return e||(e=[]),null!=(i=this.__eventStore[t])&&i.forEach((n=this,function(i){var r,s;if(r=i.fn,s=i.once,n.__asyncEvents?setTimeout((function(){return r.apply(null,e)}),1):r.apply(null,e),s)return n.off(t,r)})),this},t}(),t.exports=e}).call(Md),function(){var e,i,n={}.hasOwnProperty,r=[].slice,s=[].indexOf||function(t){for(var e=0,i=this.length;e<i;e++)if(e in this&&this[e]===t)return e;return-1};i=function(t){return new(function(t){function e(){var t,i,n;this.t=(t=this.t,i=this,function(){return t.apply(i,arguments)}),e.__super__.constructor.call(this),this.dict={},this.defaultlocal="en",this.chosenLocal=void 0,this.availableLocales=[],this.locales=[],this.missingTranslations={},this.on("dict:change",(n=this,function(){return n.sortLocales()}))}return function(t,e){for(var i in e)n.call(e,i)&&(t[i]=e[i]);function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype}(e,t),e.prototype.utils={merge:function(t,e){var i,n,r;for(i in n=[],e)"object"==typeof(r=e[i])&&"object"==typeof t[i]?n.push(this.merge(t[i],r)):n.push(t[i]=r);return n},filter:function(t,e){var i,n,r,s;for(r=[],i=0,n=t.length;i<n;i++)e(s=t[i])&&r.push(s);return r},unique:function(t){var e,i,n,r,s,a;for(s={},e=0,n=t.length;e<n;e++)s[a=t[e]]=a;for(i in r=[],s)a=s[i],r.push(a);return r},getByDotNotation:function(t,e){var i;for(i=e.split(".");0!==i.length&&void 0!==t;)t=t[i[0]],i.shift();return t},isPlainObject:function(t){return!!t&&"[object Object]"===Object.prototype.toString.call(t)}},e.prototype.register=function(t,e){return t in this.dict||(this.dict[t]={},this.availableLocales.push(t)),this.utils.merge(this.dict[t],e),this.trigger("dict:change",[t])},e.prototype.set=function(t){return this.chosenLocal=t,this.sortLocales()},e.prototype.setDefault=function(t){return this.defaultLocal=t,this.sortLocales()},e.prototype.detectLocal=function(){return navigator.userLanguage||navigator.language},e.prototype.similiarLocales=function(t){return t=String(t).slice(0,2).toLowerCase(),this.utils.filter(this.availableLocales,(function(e){return t!==e&&0===e.toLowerCase().indexOf(t)}))},e.prototype.sortLocales=function(){var t,e,i,n,a,o;for(o=this.locales.slice(),a=[],e=0,i=(t=[this.chosenLocal].concat(r.call(this.similiarLocales(this.chosenLocal)),[this.detectLocal()],r.call(this.similiarLocales(this.detectLocal())),[this.defaultLocal],r.call(this.similiarLocales(this.defaultlocal)),["en"],r.call(this.similiarLocales("en")))).length;e<i;e++)n=t[e],s.call(this.availableLocales,n)>=0&&a.push(n);if(a.push.apply(a,this.availableLocales),this.locales=this.utils.unique(a),o.join(",")!==this.locales.join(","))return this.trigger("lang:change",[this.locales,o])},e.prototype.interpolate=function(){var t,e;return e=arguments[0],t=2<=arguments.length?r.call(arguments,1):[],e=this.utils.isPlainObject(t[0])?e.replace(/%\{([^}]+)\}/g,(function(e,i){return t[0][i]})):e.replace(/%(\d+)/g,(function(e,i){return t[Number(i)-1]}))},e.prototype.t=function(){var t,e,i,n,s,a,o,l;for(i=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],o=void 0,t=0,n=(a=this.locales).length;t<n&&(s=a[t],!(o=this.utils.getByDotNotation(this.dict[s],i)));t++)s in this.missingTranslations||(this.missingTranslations[s]=[]),this.missingTranslations[s].push(i),this.missingTranslations[s]=this.utils.unique(this.missingTranslations[s]),this.trigger("missing-translation",[s,i]);return"string"==typeof o?o=this.interpolate.apply(this,[o].concat(r.call(e))):void 0!==o&&(o.plural=(l=this,function(t){return t in o?o[t]:l.interpolate(o.n,t)})),o},e}(t))},null!==t&&null!=t.exports?(e=Sd.exports,t.exports=i(e)):window.x18n=i(window.Observable)}.call(Md)}(bd);var wd=bd.exports;var Ed={settings:{title:"Settings",survey:{header:"Survey",caption:"File"},view:{header:"View",camera:{caption:"Camera type",orthographic:"Orthographic",perspective:"Perspective",anaglyph:"Anaglyph"},viewpoints:{caption:"Viewpoint",none:"<select viewpoint>",plan:"Plan",elevation_n:"N Elevation",elevation_s:"S Elevation",elevation_e:"E Elevation",elevation_w:"W Elevation"},eye_separation:"Eye Separation",vertical_scaling:"Vertical Scaling",autorotate:"Auto Rotate",rotation_speed:"Rotation Speed"},shading:{header:"Shading",caption:"Underground legs",height:"by height",length:"by leg length",inclination:"by leg inclination",height_cursor:"height cursor",fixed:"fixed",survey:"survey",route:"route",depth:"depth",depth_cursor:"depth cursor",distance:"distance",beck:"beck"},selected_route:"Selected route",no_routes:"no routes defined",visibility:{header:"Visibility",legs:"Center lines",entrances:"Entrance labels",entrance_dots:"Entrance dots",stations:"Stations",labels:"Station Labels",comments:"Station Comments",walls:"Walls (LRUD)",scraps:"Scraps",splays:"Splay Legs",duplicates:"Duplicate Legs",traces:"Dye Traces",warnings:"Warnings",box:"Bounding box",hud:"Indicators",fog:"Fog",grid:"Grid"},controls:{header:"Controls",svx_control_mode:"'Aven' controls",zoom_to_cursor:"Zoom to cursor",wheel_tilt:"Mouse wheel - tilt"},ui:{selection_tree:"Use tree selection"},colors:{header:"Colours",background_color:"Background",entrance_text:"Entrance text",entrance_background:"Entrance background",entrance_marker:"Entrance marker",bounding_box:"Bounding box",legs_fixed:"Passage lines (fixed)",surface_fixed:"Surface lines (fixed)",duplicate_fixed:"Duplicate lines (fixed)",hud_text:"Scale text",defaults:"Restore default colours"}},surface:{title:"Surface",surface:{header:"Surface Features",legs:"Surface Legs",shading:{caption:"Shading",height:"by height",inclination:"by inclination",height_cursor:"height cursor",fixed:"fixed"}},terrain:{header:"Terrain",terrain:"Terrain visible",shading:{caption:"Shading",relief:"relief shading",height:"by height",overlay:"map overlay",contours:"contours"},overlay:{caption:"Overlay"},opacity:"Opacity",datum_shift:"Vertical datum shift",lighting:"Directional Lighting",downloadTileSet:"download tile set spec"}},selection:{title:"Selection",header:"Selection"},edit:{title:"Edit",mode:"edit mode",intro:"select edit mode",modes:{none:"- none -",route:"Routes",trace:"Traces",entrances:"Entrances"},entrance:{header:"Entrances"},route:{header:"Routes",current:"Current route",save:"Save",new:"New route",add:"Add",download:"Download"},trace:{header:"Traces",start:"Start",end:"End"}},info:{title:"Information",header:"Information",file:"file",more:"For more information see",summary:"A WebGL 3d cave viewer for Survex (.3d), Therion (.lox) and Compass (.plt) models.",github:"CaveView on GitHub",stats:{header:"Survey Stats",legs:"Leg count",totalLength:"Total length",minLength:"Shortest leg",maxLength:"Longest leg",splayCount:"Splay leg count",surfaceCount:"Surface leg count",duplicateCount:"Duplicate leg count"}},help:{title:"Help",header_svx:"Key commands (survex)",header_native:"Key commands (native)",shading:{header:"Shading",height:"height",inclination:"leg inclination",length:"leg length",height_cursor:"height cursor",single:"single colour",survey:"survey section",route:"route",depth:"depth below surface",depth_cursor:"depth cursor",cursor_up:"move cursor up",cursor_down:"move cursor down",distance:"distance",flat:"Flat shading"},view:{header:"View",full_screen:"toggle full screen",orthogonal:"orthogonal view",perspective:"perspective view",reset:"reset to inital view",center:"center on selected feature",next:"next cave",plan:"plan",elevation:"elevation",north:"face north",east:"face east",south:"face south",west:"face west",rotate_clockwise:"rotate clockwise",rotate_anticlockwise:"rotate anticlockwise",zoom_in:"zoom in",zoom_out:"zoom out",auto_rotate:"rotate continuosly",rotate_speed_up:"increase speed of rotation",rotate_speed_down:"decrease speed of rotation",reverse_rotation:"reverse direction of rotation",zoom_to_cursor:"toggle zoom to cursor mode",control_mode:"toggle control mode",decrease_focal_length:"decrease focal length",increase_focal_length:"increase focal length"},visibility:{header:"Visibility",scraps:"scraps on/off [lox only]",station_labels:"station labels on/off",entrance_labels:"entrance labels on/off",splays:"splay legs on/off",survey:"underground legs on/off",surface:"surface legs on/off",terrain:"terrain on/off",walls:"LRUD walls on/off",stations:"station markers on/off",opacity_down:"decrease terrain opacity",opacity_up:"increase terrain opacity"},selection:{header:"Selection",remove:"remove all except selected section"}},exports:{title:"Exports",gltf_export:{header:"glTF Export",walls:"include LRUD walls",scraps:"include scraps",legs:"include centre lines",rotate_axes:"rotate axes",export:"Download"},png_export:{header:"Image (PNG) Export",export:"Snapshot",size:"Size (px)",line_scale:"Line scale"}},hud:{height:"height",leg_length:"leg length",depth:"depth",inclination:"inclination"},dnd:{splash_text:"Drag&nbsp;and&nbsp;drop a .3d or .lox model here to&nbsp;load"}};const Td={fieldOfView:50,background:"black",sky:1077133,maxPolarAngle:180,saturatedGradient:!1,lighting:{azimuth:315,inclination:45},entrance_dot_size:5,hud:{font:"normal Arial, sans-serif",text:"white",progress:"green",progressBackground:"dimgray",bezel:"gray",widgetSize:40,scale:{bar1:"white",bar2:"red"},compass:{top1:11549204,top2:1750245,bottom1:5774602,bottom2:807786},ahi:{sky:1077133,earth:8397056,bar:"yellow",marks:"white"},cursor:"yellow"},box:{bounding:"white",select:"blue",highlight:"red"},routes:{active:"yellow",adjacent:"red",default:"gray"},stations:{font:"normal Arial, sans-serif",entrances:{text:"white",background:"darkred",marker:"white"},junctions:{text:"yellow",marker:"yellow"},default:{text:"white",marker:"red"}},shading:{single:"red",surface:"yellow",duplicate:"white",cursor:"yellow",cursorBase:"gray",unselected:"gray",contours:{line:14793634,line10:15900002,interval:10,base:"white"},unconnected:"gray"},popup:{text:"white",border:"white",background:1118481},grid:{base:"gray"}};wd.register("en",Ed),wd.set("en");class Cd extends c{constructor(t){if(super(),this.environment=new Map,this.themeColors=new Map,this.i18n=wd.t,void 0!==t){var e;for(e in t)this.environment.set(e,t[e]);void 0!==Cd.home&&this.environment.set("home",Cd.home),this.setLanguage(this.value("language",navigator.language.slice(0,2)))}}}function Ld(t){this.script=t,this.workers=[],this.activeWorkers=new Set}void 0!==document.currentScript&&(Cd.home=document.currentScript.src.match(/^(.*\/)js\//)[1]),Cd.prototype.setLanguage=function(t){if(console.log("home:",Cd.home),"en"===t)wd.set("en");else{console.log("loading language file for:",t);(new $s).setPath(this.value("home")+"lib/").load("lang-"+t+".json",(function(e){console.log("loaded language ["+t+"]"),wd.register(t,JSON.parse(e)),wd.set(t)}),null,(function(){console.log("error loading language file",t)}))}const e=this;return void wd.on(["lang:change"],(function(){e.dispatchEvent({type:"change",name:"language"})}))},Cd.prototype.value=function(t,e){return this.environment.has(t)?this.environment.get(t):e},Cd.prototype.setPropertyValue=function(t,e){this.environment.set(t,this.value(t,e)),Object.defineProperty(this,t,{set:function(e){this.environment.set(t,e),this.dispatchEvent({type:"change",name:t})},get:function(){return this.environment.get(t)}})},Cd.prototype.themeValue=function(t){const e=this.environment.get("theme"),i=t.split(".");var n;return void 0!==e&&(n=this.treeValue(e,i)),void 0===n&&(n=this.treeValue(Td,i)),n},Cd.prototype.themeAngle=function(t){return Y(this.themeValue(t))},Cd.prototype.treeValue=function(t,e){var i,n,r=t;for(i=0;i<e.length;i++){if(void 0===r[n=e[i]])return;r=r[n]}return r},Cd.prototype.themeColorCSS=function(t){return this.themeColor(t).getStyle()},Cd.prototype.themeColor=function(t){var e=this.themeColors.get(t);if(void 0===e){var i=window.localStorage.getItem("cv-color:"+t);e=new $t(i||this.themeValue(t)),this.themeColors.set(t,e)}return e},Cd.prototype.themeColorHex=function(t){return"#"+this.themeColor(t).getHexString()},Cd.prototype.setThemeColorCSS=function(t,e){const i=window.localStorage,n=new $t(e);this.themeColors.set(t,n),i.setItem("cv-color:"+t,"#"+n.getHexString()),this.dispatchEvent({type:"colors",name:t})},Cd.prototype.resetColors=function(){this.themeColors.clear(),window.localStorage.clear(),this.dispatchEvent({type:"colors",name:"all"})};const Ad=window.navigator.hardwareConcurrency;function Rd(t){const e=new Map;this.getPool=function(i){var n=t.value("home","")+"js/workers/"+i,r=e.get(n);return void 0===r&&(r=new Ld(n),e.set(n,r)),r},this.terminateActive=function(){e.forEach((t=>t.terminateActive()))},this.dispose=function(){e.forEach((t=>{t.terminateActive(),t.dispose()})),e.clear()}}Ld.maxActive=void 0===Ad?4:Ad,Ld.pendingWork=[],Ld.activeWorkers=0,Ld.prototype.terminateActive=function(){const t=this.activeWorkers;t.forEach((t=>t.terminate())),t.clear()},Ld.prototype.getWorker=function(){var t;return t=0===this.workers.length?new Worker(this.script):this.workers.pop(),this.activeWorkers.add(t),t.pool=this,t},Ld.prototype.putWorker=function(t){this.activeWorkers.delete(t),this.workers.length<4?this.workers.push(t):t.terminate();const e=Ld.pendingWork;if(e.length>0){const t=e.shift();t.pool.queueWork(t.message,t.callback)}},Ld.prototype.runWorker=function(t,e){Ld.activeWorkers++;const i=this.getWorker();return i.onmessage=t=>{i.pool.putWorker(i),e(t.data)},i.postMessage(t),i},Ld.prototype.queueWork=function(t,e){Ld.activeWorkers!==Ld.maxActive?this.runWorker(t,e):Ld.pendingWork.push({pool:this,message:t,callback:e})},Ld.prototype.dispose=function(){this.workers.forEach((t=>t.terminate())),this.workers=null,this.activeWorkers=null};const Pd={autoRotate:!1,autoRotateSpeed:.5,box:!0,cameraType:2,view:1,editMode:0,shadingMode:1,surfaceShading:1,duplicateShading:18,terrainShading:8,terrainDirectionalLighting:!0,terrainOpacity:.5,terrainDatumShift:!1,surfaceLegs:!1,walls:!1,scraps:!1,splays:!1,grid:!1,stations:!1,stationLabels:!1,entrances:!0,entrance_dots:!0,terrain:!1,traces:!1,HUD:!0,fog:!1,warnings:!1,fullscreen:!1,zoomToCursor:!0},Dd={autoRotate:!1,walls:!0,scraps:!0,box:!1,terrain:!0,terrainOpacity:1,terrainDatumShift:!0,terrainThrough:2,terrainShading:16};function Nd(t){const e=Object.keys(t),i=[];Object.getOwnPropertyNames(t).forEach((n=>{if(e.includes(n))return;const r=Object.getOwnPropertyDescriptor(t,n);void 0!==r.set&&void 0!==r.get&&i.push(n)})),this.saveState=function(){const e={};return i.forEach((i=>{const n=t[i];"object"!=typeof n&&(e[i]=n)})),e}}const Id=Math.PI/60,Fd=new ot;class Od extends c{constructor(t,e,i){super(),this.cameraManager=t;const n=e;this.enabled=!0,this.target=new ot,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.zoomSpeed=1,this.zoomToCursor=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.wheelTilt=!1;const r=t.activeCamera;this.target0=this.target.clone(),this.position0=r.position.clone(),this.zoom0=r.zoom,this.getPolarAngle=function(){return v.phi},this.getAzimuthalAngle=function(){return v.theta},this.rotateUp=function(t){Z(t),this.update()},this.rotateLeft=function(t){Y(t),this.update()},this.scaleDolly=function(t){x*=t,this.update()},this.saveState=function(){const e=t.activeCamera;s.target0.copy(s.target),s.position0.copy(e.position),s.zoom0=e.zoom},this.reset=function(){const e=t.activeCamera;s.target.copy(s.target0),e.position.copy(s.position0),e.zoom=s.zoom0,e.updateProjectionMatrix(),s.dispatchEvent(a),s.update(),m=f.NONE},this.update=function(){var e=new ot;const i=t.activeCamera.up;var n=(new at).setFromUnitVectors(i,new ot(0,1,0)),r=n.clone().invert(),o=new ot,l=new at;return function(){var i=t.activeCamera,h=s.target,c=i.position;e.copy(c).sub(h),e.applyQuaternion(n),v.setFromVector3(e),s.autoRotate&&m===f.NONE&&Y(2*Math.PI/60/60*s.autoRotateSpeed),v.theta+=y.theta,v.phi+=y.phi,v.theta=Math.max(s.minAzimuthAngle,Math.min(s.maxAzimuthAngle,v.theta)),v.phi=Math.max(s.minPolarAngle,Math.min(s.maxPolarAngle,v.phi)),v.makeSafe();var u=Math.max(v.radius,g);return v.radius*=x,v.radius=Math.max(s.minDistance,Math.min(s.maxDistance,v.radius)),h.add(_),s.zoomToCursor&&(i.isPerspectiveCamera?s.target.lerp(D,1-v.radius/u):i.isOrthographicCamera&&s.target.lerp(D,1-b)),e.setFromSpherical(v),e.applyQuaternion(r),c.copy(h).add(e),i.lookAt(h),y.set(0,0,0),_.set(0,0,0),x=1,!!(M||o.distanceToSquared(c)>g||8*(1-l.dot(i.quaternion))>g)&&(s.dispatchEvent(a),o.copy(c),l.copy(i.quaternion),M=!1,b=1,!0)}}(),this.dispose=function(){n.removeEventListener("contextmenu",_t,!1),n.removeEventListener("mousedown",dt,!1),n.removeEventListener("wheel",mt,!1),n.removeEventListener("touchstart",vt,!1),n.removeEventListener("touchend",xt,!1),n.removeEventListener("touchmove",yt,!1),document.removeEventListener("mousemove",pt,!1),document.removeEventListener("mouseup",ft,!1),n.removeEventListener("keydown",gt,!1)},this.end=function(){s.dispatchEvent(l)},Object.defineProperty(this,"svxControlMode",{set:X,get:function(){return j}});var s=this,a={type:"change"},o={type:"start"},l={type:"end"};var h=0,c=0;const f={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY_PAN:4};var m=f.NONE,g=1e-6;const v=new xa,y=new xa;var x=1,_=new ot,M=!1,b=1;const S=new Q,w=new Q,E=new Q,T=new Q,C=new Q,L=new Q,A=new Q,R=new Q,P=new Q,D=new ot,N=new ot;var I,F,O,z,U=!0,B=new Q,k=new Q,G=new Q,H=0,V=0,W=-1,j=!1;function X(t){t?(I=it,F=nt,O=st,z=lt):(I=nt,F=rt,O=ht,z=ct),j=t}function q(){return Math.pow(.95,s.zoomSpeed)}function Y(t){y.theta-=t}function Z(t){y.phi-=t}var J=function(t,e){t*=W,Fd.setFromMatrixColumn(e,0),Fd.multiplyScalar(t),_.add(Fd)},K=function(t,e){t*=W,Fd.setFromMatrixColumn(e,1),Fd.multiplyScalar(-t),_.add(Fd)},$=function(e,i){const r=t.activeCamera;if(r.isPerspectiveCamera){Fd.copy(r.position).sub(s.target);var a=Fd.length();a*=Math.tan(r.fov/2*Math.PI/180),J(2*e*a/n.clientHeight,r.matrix),K(2*i*a/n.clientHeight,r.matrix)}else r.isOrthographicCamera&&(J(e*(r.right-r.left)/(r.zoom*n.clientWidth),r.matrix),K(i*(r.top-r.bottom)/(r.zoom*n.clientHeight),r.matrix))};function tt(e){const i=t.activeCamera;i.isPerspectiveCamera?x/=e:i.isOrthographicCamera&&(b=i.zoom,i.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,i.zoom*e)),b/=i.zoom,i.updateProjectionMatrix(),M=!0)}function et(e){const i=t.activeCamera;i.isPerspectiveCamera?x*=e:i.isOrthographicCamera&&(b=i.zoom,i.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,i.zoom/e)),b/=i.zoom,i.updateProjectionMatrix(),M=!0)}function it(t){B.set(t.clientX,t.clientY),H=0}function nt(t){S.set(t.clientX,t.clientY)}function rt(t){A.set(t.clientX,t.clientY)}function st(t){k.set(t.clientX,t.clientY),G.subVectors(k,B);const e=performance.now();e>V+1e3&&(H=0),V=e;const i=G.x*G.x,r=G.y*G.y;switch(H){case 0:H=Math.abs(G.x)>Math.abs(G.y)?1:2;break;case 1:r>8*i&&(H=2);break;case 2:i>8*r&&(H=1)}1===H?(S.copy(B),Y(2*Math.PI*G.x*W/n.clientWidth),S.copy(k),s.update()):function(t){A.copy(B),ct(t,W)}(t),B.copy(k)}function lt(t){w.set(t.clientX,t.clientY),E.subVectors(w,S),Z(2*Math.PI*E.y*W/n.clientHeight),S.copy(w),s.update()}function ht(t){w.set(t.clientX,t.clientY),E.subVectors(w,S),Y(2*Math.PI*E.x/n.clientWidth),Z(2*Math.PI*E.y/n.clientHeight),S.copy(w),s.update()}function ct(t,e){R.set(t.clientX,t.clientY),P.subVectors(R,A),P.y*=e,ut(t.clientX,t.clientY),P.y>0?tt(q()):P.y<0&&et(q()),A.copy(R),s.update()}var ut=function(){const e=new ot,n=new ot;return function(r,a){const o=t.activeCamera,l=o.up;var h;const c=t.getMouse(r,a);if(U||N.x!=c.x||N.y!=c.y){const t=i.getStation(c);null!==t&&t.project(o),N.set(c.x,c.y,null==t?.5:t.z),U=!1}o.isPerspectiveCamera?(e.set(c.x,c.y,N.z),e.unproject(o),e.sub(o.position).normalize(),h=n.copy(s.target).sub(o.position).dot(l)/e.dot(l),D.copy(o.position).add(e.multiplyScalar(h))):o.isOrthographicCamera?(e.set(c.x,c.y,(o.near+o.far)/(o.near-o.far)),e.unproject(o),n.set(0,0,-1).applyQuaternion(o.quaternion),h=-e.dot(l)/n.dot(l),D.copy(e).add(n.multiplyScalar(h))):console.warn("WARNING: OrbitControls.js encountered an unknown camera type.")}}();function dt(t){if(!1!==s.enabled){switch(t.preventDefault(),function(t){var e=0;switch(t){case u:e=1;break;case d:e=4;break;case p:e=2}var i=performance.now();i-c<100?h|=e:h=e,c=i}(t.button),h){case 1:I(t),m=f.ROTATE;break;case 4:case 3:F(t),m=f.DOLLY;break;case 2:!function(t){T.set(t.clientX,t.clientY)}(t),n.style.cursor="all-scroll",m=f.PAN}m!==f.NONE&&(document.addEventListener("mousemove",pt,!1),document.addEventListener("mouseup",ft,!1),s.dispatchEvent(o)),U=!0}}function pt(t){if(!1!==s.enabled){switch(t.preventDefault(),m){case f.ROTATE:O(t);break;case f.DOLLY:z(t,1);break;case f.PAN:!function(t){C.set(t.clientX,t.clientY),L.subVectors(C,T),$(L.x,L.y),T.copy(C),s.update()}(t)}U=!0}}function ft(){!1!==s.enabled&&(n.style.cursor="default",document.removeEventListener("mousemove",pt,!1),document.removeEventListener("mouseup",ft,!1),s.dispatchEvent(l),m=f.NONE,h=0)}function mt(t){!1===s.enabled||m!==f.NONE&&m!==f.ROTATE||(t.preventDefault(),t.stopPropagation(),s.dispatchEvent(o),function(t){const e=t.deltaY;s.wheelTilt?Z(2*Math.PI*e/12500):(ut(t.clientX,t.clientY),e<0?et(q()):e>0&&tt(q())),s.update()}(t),s.dispatchEvent(l))}function gt(t){t.preventDefault(),!1!==s.enabled&&!1!==s.enableKeys&&i.mouseOver&&function(t){switch(t.keyCode){case s.keys.UP:$(0,s.keyPanSpeed),s.update();break;case s.keys.BOTTOM:$(0,-s.keyPanSpeed),s.update();break;case s.keys.LEFT:$(s.keyPanSpeed,0),s.update();break;case s.keys.RIGHT:$(-s.keyPanSpeed,0),s.update();break;case 67:if(!j)break;Y(-Id),s.update();break;case 82:if(!j||!t.ctrlKey)break;t.preventDefault(),W*=-1;break;case 86:if(!j)break;Y(Id),s.update();break;case 191:if(!j)break;Z(-Id),s.update();break;case 192:if(!j)break;Z(Id),s.update();break;case 219:if(!j)break;et(q()),s.update();break;case 221:if(!j)break;tt(q()),s.update()}}(t)}function vt(t){if(!1!==s.enabled){switch(t.preventDefault(),t.touches.length){case 1:!function(t){S.set(t.touches[0].pageX,t.touches[0].pageY)}(t),m=f.TOUCH_ROTATE;break;case 2:!function(t){const e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;var n=Math.sqrt(e*e+i*i);A.set(0,n);const r=.5*(t.touches[0].pageX+t.touches[1].pageX),s=.5*(t.touches[0].pageY+t.touches[1].pageY);ut(r,s),T.set(r,s)}(t),m=f.TOUCH_DOLLY_PAN;break;default:m=f.NONE}m!==f.NONE&&s.dispatchEvent(o)}}function yt(t){if(!1!==s.enabled)switch(t.preventDefault(),t.stopPropagation(),t.touches.length){case 1:if(m!==f.TOUCH_ROTATE)return;!function(t){w.set(t.touches[0].pageX,t.touches[0].pageY),E.subVectors(w,S),Y(2*Math.PI*E.x/n.clientWidth),Z(2*Math.PI*E.y/n.clientHeight),S.copy(w),s.update()}(t);break;case 2:if(m!==f.TOUCH_DOLLY_PAN)return;!function(t){const e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;var n=Math.sqrt(e*e+i*i);R.set(0,n),P.set(0,Math.pow(R.y/A.y,s.zoomSpeed)),tt(P.y),A.copy(R);const r=.5*(t.touches[0].pageX+t.touches[1].pageX),a=.5*(t.touches[0].pageY+t.touches[1].pageY);ut(r,a),C.set(r,a),L.subVectors(C,T),$(L.x,L.y),T.copy(C),s.update()}(t);break;default:m=f.NONE}}function xt(){!1!==s.enabled&&(s.dispatchEvent(l),m=f.NONE)}function _t(t){!1!==s.enabled&&t.preventDefault()}n.addEventListener("contextmenu",_t,!1),n.addEventListener("mousedown",dt,!1),n.addEventListener("wheel",mt,!1),n.addEventListener("touchstart",vt,!1),n.addEventListener("touchend",xt,!1),n.addEventListener("touchmove",yt,!1),n.addEventListener("keydown",gt,!1);X(i.ctx.cfg.value("avenControls",!0)),this.update()}}const zd=new ot,Ud=new le,Bd=new at,kd=new at,Gd={type:"change"},Hd={type:"end"},Vd={type:"accuracy",value:1e3};class Wd extends c{constructor(t,e){super();var i=this,n=null;this.enabled=!1;const r=new ot,s=new Q,a=new Q;var o=0;const l=e.container,h=e.materials;var c={alpha:0,beta:0,gamma:0},u=null,d=null,p=!1;function f(t){c=t,x()}function m(){u=window.orientation||0,x()}function g(t){if(p)return;p=!0;const e=t.coords;e.accuracy!==Vd.value&&(Vd.value=e.accuracy,i.dispatchEvent(Vd)),r.set(e.longitude,e.latitude,0),n.getModelSurfaceFromWGS84(r,v)}function v(){y(),p=!1}function y(){zd.copy(r);const e=t.activeCamera,s=e.position;if(1===t.mode){zd.z+=500,n.getWorldPosition(zd),s.copy(zd),e.lookAt(zd);const t=e.right-e.left,i=e.top-e.bottom;e.zoom=Math.min(t,i)/(2*Vd.value*n.scale.x),e.updateProjectionMatrix()}else zd.z+=2,n.getWorldPosition(zd),s.copy(zd);i.dispatchEvent(Gd),i.dispatchEvent(Hd)}function x(){if(!1===i.enabled)return;const e=c.alpha?Y(c.alpha)+0:0,n=c.beta?Y(c.beta):0,s=c.gamma?Y(c.gamma):0,a=u?Y(u):0;!function(t,e,i,n,r){Ud.set(i,-n,e,"ZXY"),t.setFromEuler(Ud),t.multiply(kd.setFromAxisAngle(Se.DefaultUp,-r))}(Bd,e,n,s,a),zd.set(0,0,1).applyQuaternion(Bd);const o=zd.angleTo(Se.DefaultUp);!function(e){var i=t.mode;e>60?i=1:e<30?i=2:0===i&&(i=1),i!==t.mode&&(t.setCamera(i,r),y())}(Math.abs(o*W-90)),2===t.mode?t.activeCamera.quaternion.copy(Bd):t.activeCamera.setRotationFromAxisAngle(Se.DefaultUp,e),i.dispatchEvent(Gd),i.dispatchEvent(Hd)}function _(t){const e=t.touches.item(0);s.set(e.clientX,e.clientY),o=0}function M(e){const n=t.activeCamera,r=e.touches.item(0);a.set(r.clientX,r.clientY),s.sub(a);const c=100*s.x/l.clientWidth,u=100*s.y/l.clientHeight;0===o&&(o=Math.abs(u)>Math.abs(c)?1:-1),1===o?(n.zoom=Math.max(n.zoom+u,1),n.updateProjectionMatrix()):h.distanceTransparency=Math.max(h.distanceTransparency-c,0),s.copy(a),i.dispatchEvent(Gd)}function b(){o=0}this.location=r,this.hasLocation=function(t,e){n=t,"geolocation"in navigator&&null!==n.CRS&&navigator.geolocation.getCurrentPosition((function(t){const i=t.coords;r.set(i.longitude,i.latitude,0),n.containsWGS84Position(r)&&e()}))},this.connect=function(){m(),window.addEventListener("orientationchange",m,!1),window.addEventListener("deviceorientation",f,!1),l.addEventListener("touchstart",_,!1),l.addEventListener("touchend",b,!1),l.addEventListener("touchmove",M,!1);var t=navigator.geolocation;t.getCurrentPosition(g),d=t.watchPosition(g),i.enabled=!0,x()},this.disconnect=function(){window.removeEventListener("orientationchange",m,!1),window.removeEventListener("deviceorientation",f,!1),l.removeEventListener("touchstart",_,!1),l.removeEventListener("touchend",b,!1),l.removeEventListener("touchmove",M,!1),navigator.geolocation.clearWatch(d),i.enabled=!1},this.dispose=function(){i.disconnect()}}}function jd(t){this.ctx=t,this.openPageId=null,this.reset()}jd.prototype.reset=function(){const t=this,e=document.createElement("div");e.classList.add("cv-frame");const i=document.createElement("div");i.classList.add("cv-frame-header"),i.textContent="frame header",e.appendChild(i);const n=document.createElement("div");n.classList.add("cv-tab-box"),this.pages&&this.pages.forEach((t=>t.owner.dispose())),this.frame=e,this.header=i,this.tabBox=n,this.pages=[],this.listeners=[],this.inHandler=!1,this.controls=[],this.seq=0;const r=document.createElement("div");r.classList.add("close"),r.classList.add("tab"),this.addListener(r,"click",(function(){t.openPageId=null,t.tabBox.classList.remove("onscreen"),t.frame.classList.remove("onscreen")})),n.appendChild(r)},jd.seq=0,jd.prototype.addPage=function(t){const e=t.page,i=t.tab;return t.frame=this,this.addListener(i,"click",t.tabHandleClick.bind(t)),void 0!==t.onTop&&this.addListener(i,"click",t.onTop),this.tabBox.appendChild(i),this.frame.appendChild(e),this.pages.push({tab:i,page:e,owner:t}),this.openPageId===t.id&&t.open(),this},jd.prototype.getSeq=function(){return jd.seq++},jd.prototype.onScreen=function(t){this.tabBox.classList.add("onscreen"),this.frame.classList.add("onscreen"),this.header.textContent=t},jd.prototype.setParent=function(t){t.appendChild(this.tabBox),t.appendChild(this.frame)},jd.prototype.setControlsVisibility=function(t,e){const i=e?"block":"none";t.forEach((t=>{null!==t&&(t.style.display=i)}))},jd.prototype.clear=function(){const t=this.frame,e=this.tabBox;null!==t&&null!==t.parentElement&&t.parentElement.removeChild(t),null!==e&&null!==e.parentElement&&e.parentElement.removeChild(e),this.listeners.forEach((t=>t.obj.removeEventListener(t.name,t.handler))),this.reset()},jd.prototype.addFullscreenButton=function(t,e,i){const n=this.tabBox,r=document.createElement("div");return r.classList.add(t),r.classList.add("tab"),this.addListener(r,"click",(function(){e[i]=!e[i],s()})),this.addListener(e,"change",s),n.appendChild(r),s(),r;function s(){e[i]?(r.classList.remove("expand"),r.classList.add("collapse")):(r.classList.add("expand"),r.classList.remove("collapse"))}},jd.prototype.addListener=function(t,e,i){t.addEventListener(e,i,!1),this.listeners.push({obj:t,name:e,handler:i})},jd.prototype.handleChange=function(t){const e=t.target,i=t.name;if(!this.displayinHandle&&this.controls[i]){const t=this.controls[i];switch(t.type){case"checkbox":t.checked=e[i];break;case"select-one":case"range":t.value=e[i];break;case"download":t.href=e[i]}}this.pages.forEach((e=>{const i=e.owner;null!==i.onChange&&i.onChange(t)}))};class Xd{constructor(t,e,i,n){const r=document.createElement("div"),s=document.createElement("div");s.classList.add("page"),r.classList.add(t),r.classList.add("tab"),this.page=s,this.tab=r,this.onTop=i,this.frame=null,this.onLeave=n,this.slide=void 0,this.x18nPrefix=e+".",this.onChange=null,this.id=t}}Xd.prototype.i18n=function(t){const e=this.frame.ctx.cfg.i18n(this.x18nPrefix+t);return void 0===e?t:e},Xd.prototype.addListener=function(t,e,i){this.frame.addListener(t,e,i)},Xd.prototype.tabHandleClick=function(t){t.preventDefault(),t.stopPropagation(),this.open()},Xd.prototype.open=function(){const t=this.tab,e=this.frame.pages;t.classList.add("toptab"),this.frame.onScreen(this.i18n("title")),this.frame.openPageId=this.id,e.forEach((e=>{const i=e.page,n=e.tab,r=e.owner;n===t?i.style.display="block":(i.style.display="none",n.classList.contains("toptab")&&(n.classList.remove("toptab"),void 0!==r.onLeave&&r.onLeave()))}))},Xd.prototype.appendChild=function(t){return this.page.appendChild(t),t},Xd.prototype.addHeader=function(t){const e=document.createElement("div");return e.classList.add("header"),e.textContent=this.i18n(t),this.page.appendChild(e),e},Xd.prototype.addCollapsingHeader=function(t){const e=document.createElement("div");e.classList.add("header"),e.textContent=this.i18n(t),e.classList.add("header_full"),this.page.appendChild(e);const i=document.createElement("div");return i.classList.add("container_full"),this.page.appendChild(i),e.addEventListener("click",(function(){e.classList.contains("header_collapsed")?(i.style.display="block",i.addEventListener("transitionend",(function t(){i.removeEventListener("transitionend",t),e.classList.remove("header_collapsed")})),i.classList.remove("container_collapsed")):(i.addEventListener("transitionend",(function t(){i.removeEventListener("transitionend",t),e.classList.add("header_collapsed"),i.style.display="none"})),i.classList.add("container_collapsed"))})),i},Xd.prototype.addText=function(t){const e=this.addLine(t);return e.classList.add("spaced"),e},Xd.prototype.addLine=function(t){const e=document.createElement("p");return e.textContent=t,this.page.appendChild(e),e},Xd.prototype.addBlankLine=function(){const t=document.createElement("br");return this.page.appendChild(t),t},Xd.prototype.addLink=function(t,e){const i=document.createElement("a");return i.href=t,i.textContent=e,i.target="_blank",this.page.appendChild(i),i},Xd.prototype.makeLabel=function(t,e,i="na"){const n=document.createElement("label");return n.textContent=this.i18n(t),n.htmlFor=i,n.classList.add(e),n},Xd.prototype.addSelect=function(t,e,i,n,r){const s=document.createElement("div"),a=document.createElement("select");if(s.classList.add("control"),e instanceof Array)e.forEach((t=>{const e=document.createElement("option");e.value=t,e.text=t,e.text===i[n]&&(e.selected=!0),a.add(e,null)}));else for(var o in e){const t=document.createElement("option");t.text=o.split(" ").reduce(((t,e)=>t+" "+this.i18n(e)),"").trim(),t.value=e[o],t.value==i[n]&&(t.selected=!0),a.add(t,null)}const l=this.frame;return this.addListener(a,"change",(function(t){l.inHandler=!0,i[n]=t.target.value,l.inHandler=!1})),l.controls[n]=a,s.appendChild(this.makeLabel(t,"cv-select")),s.appendChild(a),void 0===r?this.page.appendChild(s):this.page.replaceChild(s,r),s},Xd.prototype.addFileSelect=function(t,e,i,n){const r=this.frame,s=this.addSelect(t,e,i,n),a=s.firstChild,o="cv-"+r.getSeq();a.for=o,a.classList.add("cv-file-label");const l=document.createElement("input");return l.id=o,l.classList.add("cv-file"),l.type="file",l.accept=".svx,.lox,.plt",l.multiple=!0,this.addListener(l,"change",(function(){const t=l.files.length,e=[];if(t>0){for(let i=0;i<t;i++)e.push(l.files[i]);i[n]=e}})),a.appendChild(l),s},Xd.prototype.addCheckbox=function(t,e,i){const n=this.frame,r=document.createElement("input"),s=document.createElement("div"),a="cv-"+n.getSeq();return s.classList.add("control"),r.type="checkbox",r.checked=e[i],r.id=a,this.addListener(r,"change",(function(t){n.inHandler=!0,e[i]=t.target.checked,n.inHandler=!1})),n.controls[i]=r,s.appendChild(r),s.appendChild(this.makeLabel(t,"check",a)),this.page.appendChild(s),s},Xd.prototype.addRange=function(t,e,i){const n=this.frame,r=document.createElement("div"),s=document.createElement("input");return r.classList.add("control"),s.type="range",s.min=0,s.max=1,s.step=.05,s.value=e[i],this.addListener(s,"input",a),this.addListener(s,"change",a),n.controls[i]=s,r.appendChild(this.makeLabel(t,"cv-range")),r.appendChild(s),this.page.appendChild(r),r;function a(t){n.inHandler=!0,e[i]=t.target.value,n.inHandler=!1}},Xd.prototype.addSlide=function(t,e){const i=document.createElement("div");return i.classList.add("slide"),i.style.zIndex=200-e,i.appendChild(t),this.page.appendChild(i),this.slide=i,this.slideDepth=e,i},Xd.prototype.replaceSlide=function(t,e){const i=document.createElement("div"),n=this.page;var r=this.slide;return i.classList.add("slide"),i.style.zIndex=200-e,e<this.slideDepth&&i.classList.add("slide-out"),i.appendChild(t),n.appendChild(i),e>this.slideDepth?(r.addEventListener("transitionend",(function t(){r.removeEventListener("transitionend",t),n.removeChild(r),r=null})),r.classList.add("slide-out")):e<this.slideDepth?(i.addEventListener("transitionend",(function t(){n.removeChild(r),i.removeEventListener("transitionend",t),r=null})),i.classList.remove("slide-out")):n.removeChild(r),this.slide=i,this.slideDepth=e,i},Xd.prototype.addButton=function(t,e){const i=document.createElement("button");return i.type="button",i.textContent=this.i18n(t),this.addListener(i,"click",e),this.page.appendChild(i),i},Xd.prototype.addTextBox=function(t,e,i){const n=document.createElement("div"),r=document.createElement("input");var s;return r.type="text",r.placeholder=e,n.appendChild(this.makeLabel(t,"text")),n.appendChild(r),this.page.appendChild(n),this.addListener(r,"change",(function(t){return s=t.target.value,!0})),i((function(){return r.value="",s})),n},Xd.prototype.addDownloadButton=function(t,e,i){const n=document.createElement("a");return void 0===n.download?null:(this.addListener(n,"click",(()=>{n.href=e(n)})),n.textContent=this.i18n(t),n.type="download",n.download=i,n.href="javascript:void();",n.classList.add("download"),this.page.appendChild(n),n)},Xd.canDownload=function(){return void 0!==document.createElement("a").download},Xd.prototype.download=function(t,e){const i=document.createElement("a");if(void 0===i.download)return null;i.type="download",i.download=e,i.href=t,i.click()},Xd.prototype.addColor=function(t,e){const i=this.frame,n=document.createElement("input"),r=document.createElement("div"),s=i.ctx.cfg,a="cv-"+i.getSeq();return r.classList.add("control"),n.type="color",n.value=s.themeColorHex(e),n.id=a,this.addListener(n,"change",(function(t){i.inHandler=!0,s.setThemeColorCSS(e,t.target.value),i.inHandler=!1})),i.controls[e]=n,r.appendChild(n),r.appendChild(this.makeLabel(t,"color",a)),this.page.appendChild(r),this.addListener(s,"colors",(t=>{"all"===t.name&&(n.value=s.themeColorHex(e))})),r},Xd.prototype.addLogo=function(){const t=document.createElement("div");t.classList.add("logo"),t.title="logo",this.appendChild(t)},Xd.prototype.dispose=function(){this._dispose&&this._dispose()};class qd extends Xd{constructor(t,e){super("icon_help","help"),t.addPage(this);const i=this;var n;function r(t,e){const r=document.createElement("dt"),s=document.createElement("dd");r.textContent=t,s.textContent=i.i18n(e),n.appendChild(r),n.appendChild(s)}this.addHeader(e?"header_svx":"header_native"),this.addHeader("shading.header"),n=document.createElement("dl"),r("1","shading.height"),r("2","shading.inclination"),r("3","shading.length"),r("4","shading.height_cursor"),r("5","shading.single"),r("6","shading.survey"),r("7","shading.route"),r("8","shading.depth"),r("9","shading.depth_cursor"),r("0","shading.distance"),r("<alt>f","shading.flat"),e||(r("[","shading.cursor_up"),r("]","shading.cursor_down")),this.appendChild(n),this.addHeader("view.header"),n=document.createElement("dl"),e?(r("P","view.plan"),r("L","view.elevation"),r("","-"),r("N","view.north"),r("E","view.east"),r("S","view.south"),r("W","view.west"),r("","-"),r("C","view.rotate_clockwise"),r("V","view.rotate_anticlockwise"),r("]","view.zoom_in"),r("[","view.zoom_out"),r("F","view.full_screen"),r("","-"),r('" "',"view.auto_rotate"),r("Z","view.rotate_speed_up"),r("V","view.rotate_speed_down"),r("R","view.reverse_rotation"),r("","-"),r("<del>","view.reset")):(r("F","view.full_screen"),r("O","view.orthogonal"),r("P","view.perspective"),r("R","view.reset"),r(".","view.center"),r("N","view.next")),r("<alt>S","view.control_mode"),r("<alt>X","view.zoom_to_cursor"),r("(","view.decrease_focal_length"),r(")","view.increase_focal_length"),this.appendChild(n),this.addHeader("visibility.header"),n=document.createElement("dl"),e?(r("J","visibility.station_labels"),r("Q","visibility.splays"),r("T","visibility.terrain"),r("<ctrl>N","visibility.station_labels"),r("<ctrl>X","visibility.stations"),r("<ctrl>L","visibility.survey"),r("<ctrl>F","visibility.surface"),r("","-"),r("<","visibility.opacity_down"),r(">","visibility.opacity_up")):(r("C","visibility.scraps"),r("J","visibility.station_labels"),r("L","visibility.entrance_labels"),r("Q","visibility.splays"),r("S","visibility.surface"),r("T","visibility.terrain"),r("W","visibility.walls"),r("Z","visibility.stations"),r("","-"),r("<","visibility.opacity_down"),r(">","visibility.opacity_up")),this.appendChild(n),e||(this.addHeader("selection.header"),n=document.createElement("dl"),r("V","selection.remove"),this.appendChild(n))}}class Yd extends Xd{constructor(t,e,i){super("icon_info","info"),t.addPage(this),this.addHeader("header"),this.addHeader("stats.header"),this.addText(this.i18n("file")+": "+i.file);const n=e.getLegStats(1);if(this.addBlankLine(),this.addLine(this.i18n("stats.legs")+": "+n.legCount),this.addLine(this.i18n("stats.totalLength")+": "+n.legLength.toFixed(2)+"m"),this.addLine(this.i18n("stats.minLength")+": "+n.minLegLength.toFixed(2)+"m"),this.addLine(this.i18n("stats.maxLength")+": "+n.maxLegLength.toFixed(2)+"m"),(e.hasSplays||e.hasDuplicateLegs||e.hasSurfaceLegs)&&(this.addBlankLine(),this.addLine("Other legs"),this.addBlankLine()),e.hasSplays){const t=e.getLegStats(2);this.addLine(this.i18n("stats.splayCount")+": "+t.legCount)}if(e.hasDuplicateLegs){const t=e.getLegStats(h);this.addLine(this.i18n("stats.duplicateCount")+": "+t.legCount)}if(e.hasSurfaceLegs){const t=e.getLegStats(3);this.addLine(this.i18n("stats.surfaceCount")+": "+t.legCount)}this.addHeader("CaveView v2.2.0."),this.addLogo(),this.addText(this.i18n("summary")),this.addText(this.i18n("more")+": "),this.addLink("https://aardgoose.github.io/CaveView.js/",this.i18n("github")),this.addText(" Angus Sawyer, 2021")}}class Zd extends Xd{constructor(t,e,i,n){super("icon_explore","selection",(function(){a.isOntop=!0}),(function(){a.isOntop=!1})),t.addPage(this),this.surveyTree=e.getSurveyTree(),this.currentTop=this.surveyTree,this.nodes=new WeakMap,this.leafSections=new WeakSet,this.lastSelected=null,this.lastSection=0,this.lastShadingMode=e.shadingMode,this.currentHover=null,this.stringCompare=new Intl.Collator("en-GB",{numeric:!0}).compare,this.isOntop=!1;const r=document.createElement("div"),s=e.ctx.cfg;r.id="ui-path",r.classList.add("header"),e.isClipped?(this.addListener(r,"click",(function(){n.reload()})),r.classList.add("reload"),r.textContent=this.currentTop.name):(r.textContent=this.currentTop.name,this.nodes.set(r,this.currentTop)),this.titleBar=r,this.appendChild(r),this.addListener(this.page,"mouseover",(function(t){const i=t.target;if("LI"!==i.nodeName)return;const n=a.nodes.get(i);n!==a.currentHover&&(e.highlight=e.section!==n?n:a.surveyTree,e.popup=n,a.currentHover=n)})),this.addListener(this.page,"mouseleave",(function(){e.highlight=a.surveyTree,e.popup=a.surveyTree})),this.addListener(this.page,"click",(function(t){t.stopPropagation(),t.preventDefault();const i=t.target,n=a.nodes.get(i);switch(i.tagName){case"LI":e.section=n,e.setPOI=!0,i.classList.add("selected"),null!==a.lastSelected&&a.lastSelected.classList.remove("selected"),a.lastSelected=i;break;case"DIV":a.handleNext(i,n);break;case"SPAN":a.handleBack(i)}})),this.addListener(this.page,"dblclick",(function(t){t.stopPropagation(),t.preventDefault();const i=t.target,n=a.nodes.get(i);if(!i.classList.contains("section"))return;n!==a.surveyTree&&(e.cut=!0)}));const a=this;return i.clientHeight,this.addLine=function(t,i){const n=null===i.p?null:i.p.connections;if(null===n||this.leafSections.has(t)||this.leafSections.add(t),!(0!==n||e.splays||2&i.type))return;const r=document.createElement("li"),l=void 0===i.comment?i.name:i.name+" ( "+i.comment+" )",h=document.createTextNode(l);var c;if(a.nodes.set(r,i),e.section===i&&r.classList.add("selected"),null===n?(c=o(" ","#444444"),r.classList.add("section")):2===i.type?(c=o(" ",s.themeColorCSS("stations.entrances.marker"))).classList.add("cv-entrance"):c=n>2?o(" ",s.themeColorCSS("stations.junctions.marker")):o(0===n?" ":" ",s.themeColorCSS("stations.default.marker")),r.appendChild(c),r.appendChild(h),i.children.length>0){const t=document.createElement("div");t.classList.add("descend-tree"),a.nodes.set(t,i),r.appendChild(t)}t.appendChild(r)},this.displaySectionCommon=function(t){const i=t.children;t.sorted||(i.sort(((t,e)=>this.stringCompare(t.name,e.name))),t.sorted=!0);const n=document.createElement("ul");return n.classList.add("cv-tree"),t.forEachChild((t=>this.addLine(n,t))),l(n),this.currentTop=t,this.lastShadingMode=e.shadingMode,n},this.reloadSections=function(){const t=this.page.getElementsByTagName("UL"),e=[];var i;for(i=0;i<t.length;i++){const n=t[i];this.leafSections.has(n)&&e.push(n)}e.forEach((t=>{const e=this.nodes.get(t.previousSibling)||this.currentTop;e&&t.replaceWith(this.displaySectionCommon(e))}))},void(this.onChange=function(t){if(!e.surveyLoaded)return;if("splays"===t.name)return void a.reloadSections();(a.lastSection!==e.section||6===a.lastShadingMode&&6!==e.shadingMode||6!==a.lastShadingMode&&6===e.shadingMode)&&(l(),a.lastShadingMode=e.shadingMode,a.lastSection=e.section)});function o(t,e){const i=document.createElement("span");return i.style.color=e,i.textContent=t,i}function l(t){const i=(void 0===t?a.page:t).getElementsByTagName("li");var n;const r=e.ctx.surveyColourMapper,s=6===e.shadingMode?r.getColourMap(e.section):null;for(n=0;n<i.length;n++){const t=i[n],e=a.nodes.get(i[n]);if(void 0!==e&&null===e.p){const i=t.firstChild,n=e.id;let r;r=null!==s&&void 0!==s[n]?"#"+s[n].getHexString():"#444444",i.style.color=r}}}}}class Jd extends Zd{constructor(t,e,i,n){super(t,e,i,n);const r=this;var s=0;return this.addSlide(a(r.currentTop),s),i.clientHeight,this.handleNext=function(t,i){void 0!==i&&i!==r.surveyTree?r.replaceSlide(a(i),++s):"ui-path"===t.id&&(e.section=r.currentTop)},this.handleBack=function(t){if("surveyBack"===t.id){if(r.currentTop===r.surveyTree)return;r.replaceSlide(a(r.currentTop.parent),--s)}},this;function a(t){let e;for(r.nodes=new WeakMap;e=r.titleBar.firstChild;)r.titleBar.removeChild(e);if(t===r.surveyTree)r.titleBar.textContent=""===t.name?"[model]":t.name,r.nodes.set(r.titleBar,t);else{const e=document.createElement("span");e.id="surveyBack",e.textContent=" ",r.nodes.set(e,t),r.titleBar.appendChild(e),r.titleBar.appendChild(document.createTextNode(" "+t.name))}return r.displaySectionCommon(t)}}}class Kd extends Zd{constructor(t,e,i,n){super(t,e,i,n);const r=this,s=r.displaySectionCommon(this.currentTop);var a=null,o=0;return this.appendChild(s),i.clientHeight,this.handleNext=function(t,i){if(void 0!==i&&i!==r.surveyTree){const e=t.parentNode;if(!t.classList.contains("open")){const n=r.displaySectionCommon(i);return e.appendChild(n),t.classList.add("open"),n}e.removeChild(e.lastElementChild),t.classList.remove("open")}else"ui-path"===t.id&&(e.section=r.currentTop)},this.handleBack=function(){},e.addEventListener("select",l),void(this._dispose=function(){e.removeEventListener("select",l)});function l(t){if(!r.isOntop)return;const e=t.node;if(null===e)return r.frame.frame.removeEventListener("scroll",u),void(o>performance.now()-1e3?setTimeout(c,1e3):c());const i=[];var n=e;do{i.push(n),n=n.parent}while(0!==n.id);var a=s,l=a.childNodes;for(n=i.pop();void 0!==n;){let t,s=0;for(s=0;s<l.length&&(t=l[s],r.nodes.get(t)!=n);s++);if(s==l.length)break;if(n===e){h(t);break}{let e=t.lastElementChild;"DIV"===e.tagName&&(e=r.handleNext(e,n)),n=i.pop(),l=e.childNodes,a=e}}}function h(t){o=0,r.frame.frame.addEventListener("scroll",u),t.classList.add("highlight"),t.scrollIntoView({behavior:"smooth",block:"center"}),null!==a&&c(),a=t}function c(){null!=a&&(a.classList.remove("highlight"),a=null,o=0)}function u(t){o=t.timeStamp}}}const Qd={"shading.height":1,"shading.length":2,"shading.inclination":3,"shading.height_cursor":4,"shading.fixed":5,"shading.survey":6,"shading.route":i,"shading.distance":r},$d={"view.viewpoints.none":0,"view.viewpoints.plan":1,"view.viewpoints.elevation_n":2,"view.viewpoints.elevation_s":3,"view.viewpoints.elevation_e":4,"view.viewpoints.elevation_w":5},tp={"view.camera.orthographic":1,"view.camera.perspective":2,"view.camera.anaglyph":3};class ep extends Xd{constructor(t,e,r){super("icon_settings","settings"),t.addPage(this);const s=[],a=[],o=e.ctx.cfg,l=Object.assign({},Qd),h=e.routeNames;e.hasRealTerrain&&(l["shading.depth"]=9,l["shading.depth_cursor"]=n),this.addHeader("survey.header"),r.fileCount>1?this.addFileSelect("survey.caption",r.fileList,r,"file"):this.addLine(r.selectedFile);const c=this.addCollapsingHeader("view.header");c.appendChild(this.addSelect("view.camera.caption",tp,e,"cameraType")),c.appendChild(this.addSelect("view.viewpoints.caption",$d,e,"view")),c.appendChild(this.addRange("view.vertical_scaling",e,"zScale")),c.appendChild(this.addCheckbox("view.autorotate",e,"autoRotate")),c.appendChild(this.addRange("view.rotation_speed",e,"autoRotateSpeed"));this.addCollapsingHeader("shading.header").appendChild(this.addSelect("shading.caption",l,e,"shadingMode")),0!==h.length?(e.route||(e.route=h[0]),a.push(this.addSelect("selected_route",h,e,"route"))):a.push(this.addText(this.i18n("no_routes")));const u=this.addCollapsingHeader("visibility.header");e.hasLegs&&u.appendChild(this.addCheckbox("visibility.legs",e,"legs")),e.hasEntrances&&u.appendChild(this.addCheckbox("visibility.entrances",e,"entrances")),e.hasEntrances&&u.appendChild(this.addCheckbox("visibility.entrance_dots",e,"entrance_dots")),e.hasStations&&u.appendChild(this.addCheckbox("visibility.stations",e,"stations")),e.hasStationLabels&&u.appendChild(this.addCheckbox("visibility.labels",e,"stationLabels")),e.hasStationComments&&u.appendChild(this.addCheckbox("visibility.comments",e,"stationComments")),e.hasSplays&&u.appendChild(this.addCheckbox("visibility.splays",e,"splays")),e.hasWalls&&u.appendChild(this.addCheckbox("visibility.walls",e,"walls")),e.hasScraps&&u.appendChild(this.addCheckbox("visibility.scraps",e,"scraps")),e.hasDuplicateLegs&&u.appendChild(this.addCheckbox("visibility.duplicates",e,"duplicateLegs")),e.hasTraces&&u.appendChild(this.addCheckbox("visibility.traces",e,"traces")),u.appendChild(this.addCheckbox("visibility.fog",e,"fog")),u.appendChild(this.addCheckbox("visibility.hud",e,"HUD")),u.appendChild(this.addCheckbox("visibility.box",e,"box")),u.appendChild(this.addCheckbox("visibility.grid",e,"grid")),e.hasWarnings&&u.appendChild(this.addCheckbox("visibility.warnings",e,"warnings"));const d=this.addCollapsingHeader("controls.header");d.appendChild(this.addCheckbox("controls.svx_control_mode",e,"svxControlMode")),d.appendChild(this.addCheckbox("controls.zoom_to_cursor",e,"zoomToCursor")),d.appendChild(this.addCheckbox("ui.selection_tree",o,"selectionTree"));const p=this.addCollapsingHeader("colors.header");return p.appendChild(this.addColor("colors.background_color","background")),p.appendChild(this.addColor("colors.entrance_text","stations.entrances.text")),p.appendChild(this.addColor("colors.entrance_background","stations.entrances.background")),p.appendChild(this.addColor("colors.entrance_marker","stations.entrances.marker")),p.appendChild(this.addColor("colors.bounding_box","box.bounding")),p.appendChild(this.addColor("colors.legs_fixed","shading.single")),p.appendChild(this.addColor("colors.surface_fixed","shading.surface")),p.appendChild(this.addColor("colors.duplicate_fixed","shading.duplicate")),p.appendChild(this.addColor("colors.hud_text","hud.text")),p.appendChild(this.addButton("colors.defaults",o.resetColors.bind(o))),e.svxControlMode&&d.appendChild(this.addCheckbox("controls.wheel_tilt",e,"wheelTilt")),f({name:"cameraType"}),f({name:"shadingMode"}),this.onChange=f,this;function f(n){"shadingMode"===n.name&&t.setControlsVisibility(a,e.shadingMode===i),"cameraType"===n.name&&t.setControlsVisibility(s,3===e.cameraType)}}}const ip={"surface.shading.height":1,"surface.shading.inclination":3,"surface.shading.height_cursor":4,"surface.shading.fixed":17};class np extends Xd{constructor(t,e){const i=[];if(super("icon_terrain","surface"),t.addPage(this),this.addHeader("surface.header"),e.hasSurfaceLegs&&(this.addCheckbox("surface.legs",e,"surfaceLegs"),this.addSelect("surface.shading.caption",ip,e,"surfaceShading")),e.hasTerrain){this.addHeader("terrain.header"),this.addCheckbox("terrain.terrain",e,"terrain"),i.push(this.addSelect("terrain.shading.caption",e.terrainShadingModes,e,"terrainShading")),i.push(this.addRange("terrain.opacity",e,"terrainOpacity")),i.push(this.addCheckbox("terrain.datum_shift",e,"terrainDatumShift")),i.push(this.addCheckbox("terrain.lighting",e,"terrainDirectionalLighting")),e.hasRealTerrain||i.push(this.addDownloadButton("terrain.downloadTileSet",e.terrainTileSet,"tileSetEntry.json"));const t=e.terrainAttributions;for(let e=0;e<t.length;e++)this.addText(t[e])}return n({name:"terrain"}),this.onChange=n,this;function n(n){"terrain"===n.name&&t.setControlsVisibility(i,e.terrain)}}}class rp{constructor(t){this.page=t,this.elements=[],this.dynamic=[],this.onShow=function(){this.dynamic.forEach((t=>t.parentElement.removeChild(t))),this.dynamic=[]}}}rp.prototype.add=function(t){return this.elements.push(t),t},rp.prototype.addDynamic=function(t){return this.dynamic.push(t),t},rp.prototype.setVisibility=function(t){const e=this.page.frame;e.setControlsVisibility(this.elements,t),e.setControlsVisibility(this.dynamic,t),t&&null!==this.onShow&&this.onShow()};class sp extends rp{constructor(t,e,i){super(t);const n=this,r=e.getMetadata(),s=e.routeNames;this.add(t.addHeader("route.header"));var a,o=t.addSelect("route.current",s,e,"route");this.add(o),this.add(t.addButton("route.save",(function(){}))),this.add(t.addTextBox("route.new","---",(function(t){a=t}))),this.add(t.addButton("route.add",(function(){console.log(a),o=n.addSelect("Current Route",e.routeNames,e,"route",o)}))),this.add(t.addDownloadButton("route.download",r.getURL,Go(i.file,"json")))}}class ap extends rp{constructor(t,e){super(t);const i=this,n=t.i18n("trace.start")+":",r=t.i18n("trace.end")+":";t.addListener(e,"selectedTrace",(function(e){void 0!==e.add?function(e){o(),void 0!==e.start&&(s.textContent=n+" "+e.start);void 0!==e.end&&(a.textContent=r+" "+e.end,i.addDynamic(t.addButton("trace.add",(function(){e.add(),o()}))))}(e):void 0!==e.delete&&function(e){const l=e.trace;o(),s.textContent=n+" "+l.start,a.textContent=r+" "+l.end,i.addDynamic(t.addButton("trace.delete",(function(){e.delete(),o()})))}(e)})),this.add(t.addHeader("trace.header"));var s=this.add(t.addLine(n)),a=this.add(t.addLine(r));function o(){i.onShow(),s.textContent=n,a.textContent=r}}}const op={"modes.none":0,"modes.route":1,"modes.trace":3};class lp extends Xd{constructor(t,e,n){super("icon_route","edit",(function(){a={shadingMode:e.shadingMode,stations:e.stations,traces:e.traces},h({type:"change",name:"editMode"})}),(function(){e.setView(a)})),t.addPage(this);const r=this,s=[];var a,o=null,l=null;return this.addSelect("mode",op,e,"editMode"),s.push(this.addText(this.i18n("intro"))),void(this.onChange=h);function h(h){if("editMode"===h.name){const h=Object.assign({},a);switch(e.editMode){case 3:null===l&&(l=new ap(r,e)),h.traces=!0;break;case 1:null===o&&(o=new sp(r,e,n)),h.shadingMode=i}e.setView(h),t.setControlsVisibility(s,0===e.editMode),null!==o&&o.setVisibility(1===e.editMode),null!==l&&l.setVisibility(3===e.editMode)}}}}function hp(t,e){var i=e.getElementsByClassName("cv-gps-button");if(0!=i.length&&e.removeChild(i[0]),t.hasLocation){var n=document.createElement("div");n.classList.add("cv-gps-button"),n.addEventListener("click",(function(){t.trackLocation?n.classList.remove("on"):n.classList.add("on"),t.trackLocation=!t.trackLocation})),e.appendChild(n),this.dispose=function(){e.removeChild(n)}}}function cp(t,e,s){function a(a){t.surveyLoaded&&t.mouseOver&&(a.preventDefault(),function(e){if(e.ctrlKey)return!1;var s=!0;if(e.altKey)switch(e.key){case"s":t.svxControlMode=!t.svxControlMode;break;case"f":t.flatShading=!t.flatShading;break;case"h":t.hideMode=!t.hideMode;break;case"x":t.zoomToCursor=!t.zoomToCursor;break;default:s=!1}else switch(e.key){case"0":t.shadingMode=r;break;case"1":t.shadingMode=1;break;case"2":t.shadingMode=3;break;case"3":t.shadingMode=2;break;case"4":t.shadingMode=4;break;case"5":t.shadingMode=5;break;case"6":t.shadingMode=6;break;case"7":t.shadingMode=i;break;case"8":t.shadingMode=9;break;case"9":t.shadingMode=n;break;case"f":t.fullscreen=!t.fullscreen;break;case"j":t.hasStationLabels&&(t.stationLabels=!t.stationLabels);break;case"o":t.cameraType=1;break;case"q":t.hasSplays&&(t.splays=!t.splays);break;case"t":t.hasTerrain&&(t.terrain=!t.terrain);break;case"+":t.cursorHeight++;break;case"-":t.cursorHeight--;break;case"<":t.hasTerrain&&(t.terrainOpacity=Math.max(t.terrainOpacity-.05,0));break;case">":t.hasTerrain&&(t.terrainOpacity=Math.min(t.terrainOpacity+.05,1));break;case"(":t.focalLength=Math.max(10,t.focalLength-10);break;case")":t.focalLength=Math.min(300,t.focalLength+10);break;default:s=!1}return s}(a)||(s?function(e){if(e.ctrlKey)switch(e.key){case"b":t.box=!t.box;break;case"e":t.wheelTilt=!t.wheelTilt;break;case"f":t.hasSurfaceLegs&&(t.surfaceLegs=!t.surfaceLegs);break;case"l":t.hasLegs&&(t.legs=!t.legs);break;case"n":t.hasStationLabels&&(t.stationLabels=!t.stationLabels);break;case"x":t.stations=!t.stations}else switch(e.key){case"Delete":t.reset=!0;break;case"Enter":t.autoRotate=!0;break;case" ":t.autoRotate=!t.autoRotate;break;case"l":t.polarAngle=Math.PI/2;break;case"e":t.azimuthAngle=3*Math.PI/2;break;case"n":t.azimuthAngle=0;break;case"p":t.polarAngle=0;break;case"r":t.autoRotateSpeed*=-1;break;case"s":t.azimuthAngle=Math.PI;break;case"w":t.azimuthAngle=Math.PI/2;break;case"x":t.autoRotateSpeed-=.1;break;case"z":t.autoRotateSpeed+=.1}}(a):function(i){if(i.ctrlKey)return;switch(i.key){case"c":t.hasScraps&&(t.scraps=!t.scraps);break;case"d":t.hasTraces&&(t.traces=!t.traces);break;case"f":t.fullscreen=!t.fullscreen;break;case"j":t.hasStationLabels&&(t.stationLabels=!t.stationLabels);break;case"l":t.hasEntrances&&(t.entrances=!t.entrances);break;case"n":e.nextFile();break;case"o":t.cameraType=1;break;case"p":t.cameraType=2;break;case"q":t.hasSplays&&(t.splays=!t.splays);break;case"r":t.view=1;break;case"s":t.hasSurfaceLegs&&(t.surfaceLegs=!t.surfaceLegs);break;case"t":t.hasTerrain&&(t.terrain=!t.terrain);break;case"v":Xd.clear(),t.cut=!0;break;case"w":t.hasWalls&&(t.walls=!t.walls);break;case"x":t.setPOI=!0;break;case"z":t.stations=!t.stations;break;case"]":t.cursorHeight++;break;case"[":t.cursorHeight--}}(a)))}document.addEventListener("keydown",a),this.dispose=function(){document.removeEventListener("keydown",a)}}class up extends c{constructor(t,e){super(),this.fileList=[],this.fileCount=0,this.currentIndex=1/0,this.loadedFile=null,this.isMultiple=!1,this.splash=null,this.localFilename=null;const i=this;function n(){const e=i.splash;t.classList.remove("cv-splash"),null!==e&&(e.parentNode.removeChild(e),i.splash=null)}function r(n){if(n.preventDefault(),null!==i.splash)return;const r=document.createElement("div");r.innerHTML=e.cfg.i18n("dnd.splash_text")||"dnd.splash_text",r.id="cv-splash",t.appendChild(r),t.classList.add("cv-splash"),i.splash=r}function s(t){t.preventDefault(),t.dataTransfer.dropEffect="copy"}function a(e){e.preventDefault(),e.relatedTarget===t.parentNode&&n()}function o(t){n();const e=t.dataTransfer;t.preventDefault();const r=e.files.length,s=[];if(r>0){for(var a=0;a<r;a++)s.push(e.files[a]);i.selectFile(s,null)}}t.addEventListener("drop",o),t.addEventListener("dragenter",r),t.addEventListener("dragover",s),t.addEventListener("dragleave",a),Object.defineProperty(this,"file",{get:function(){return this.selectedFile},set:this.selectFile}),this.dispose=function(){t.removeEventListener("drop",o),t.removeEventListener("dragover",s),t.removeEventListener("dragleave",a),t.removeEventListener("dragenter",r)}}}up.prototype.addList=function(t){this.fileList=t,this.fileCount=t.length},up.prototype.nextFile=function(){const t=this.fileList;if(0===this.fileCount)return!1;++this.currentIndex>=this.fileCount&&(this.currentIndex=0),this.selectFile(t[this.currentIndex])},up.prototype.selectFile=function(t,e){Array.isArray(t)?1===t.length?(this.localFilename=t[0].name,this.selectedFile=t[0],this.isMultiple=!1):(this.selectedFile="[multiple]",this.localFilename="multiple",this.isMultiple=!0):(this.selectedFile=t,this.localFilename=t),this.loadedFile=t,this.dispatchEvent({type:"selected",file:t,section:e})},up.prototype.reload=function(){this.selectFile(this.loadedFile)};class dp extends Xd{constructor(t,e,i){super("icon_export","exports"),t.addPage(this),this.addHeader("png_export.header");const n=[];let r=e.maxSnapshotSize;do{n.push(r)}while((r/=2)>512);const s={exportSize:n[0],lineScale:1};this.addSelect("png_export.line_scale",[1,2,3,4,5,6],s,"lineScale"),this.addSelect("png_export.size",n,s,"exportSize"),this.addDownloadButton("png_export.export",(()=>e.getSnapshot(s.exportSize,s.lineScale)),"snapshot.png"),this.addHeader("gltf_export.header");const a={legs:!1,walls:!1,scraps:!1},o={rotate:!1,binary:!1};e.hasWalls&&(a.walls=!0,this.addCheckbox("gltf_export.walls",a,"walls")),e.hasScraps&&(a.scraps=!0,this.addCheckbox("gltf_export.scraps",a,"scraps")),this.addCheckbox("gltf_export.legs",a,"legs"),this.addCheckbox("gltf_export.rotate_axes",o,"rotate"),this.addButton("gltf_export.export",(function(){e.getGLTFExport(a,o,h)}));const l=this;return;function h(t,e){var n=Go(i.localFilename,e?"glb":"gltf");l.download(URL.createObjectURL(t),n)}}}t.CAMERA_ANAGLYPH=3,t.CAMERA_NONE=0,t.CAMERA_OFFSET=600,t.CAMERA_ORTHOGRAPHIC=1,t.CAMERA_PERSPECTIVE=2,t.CLUSTER_MARKERS=16,t.CaveViewUI=function(t){const e=t.ctx,i=t.container,n=new jd(e),r=e.cfg,s=new up(i,e);s.addEventListener("selected",(function(e){n.clear(),t.clearView(),Array.isArray(e.file)?t.loadCaves(e.file):t.loadCave(e.file,e.section)})),r.setPropertyValue("selectionTree",!0),t.addEventListener("change",n.handleChange.bind(n)),t.addEventListener("newCave",l),r.addEventListener("change",l);const a=new cp(t,s,r.value("avenControls",!0));var o;function l(){t.surveyLoaded&&(n.clear(),new ep(n,t,s),(t.hasSurfaceLegs||t.hasTerrain)&&new np(n,t),r.selectionTree?new Kd(n,t,i,s):new Jd(n,t,i,s),r.value("showEditPage",!1)&&!s.isMultiple&&new lp(n,t,s),r.value("showExportPage",!1)&&Xd.canDownload()&&new dp(n,t,s),new Yd(n,t,s),new qd(n,t.svxControlMode),n.setParent(i),n.addFullscreenButton("fullscreen",t,"fullscreen"),o=new hp(t,i))}this.loadCaveList=function(t){s.addList(t),s.nextFile()},this.loadCave=function(t,e){s.selectFile(t,e)},this.loadCaves=function(e){t.clearView(),t.loadCaves(e)},this.clearView=function(){n.clear(),t.clearView()},this.dispose=function(){n.clear(),t.clearView(),s.dispose(),o.dispose(),a.dispose(),t.dispose()}},t.CaveViewer=class extends c{constructor(t,e){super(),console.log("CaveView v2.2.0");const n=document.getElementById(t);this.container=n,n||alert("No container DOM object ["+t+"] available"),n.classList.add("cv-container");const c=new Cd(e),d={cfg:c,container:n,workerPools:new Rd(c),glyphStringCache:new Map,viewer:this};this.ctx=d;const f=new No(this);d.materials=f,n.style.backgroundColor=c.themeColorCSS("background");var m=new _s({antialias:!0,alpha:!0});m.setSize(n.clientWidth,n.clientHeight),m.setPixelRatio(window.devicePixelRatio),m.setClearColor(c.themeColor("background"),0),m.setRenderTarget(null),m.clear(),m.autoClear=!1,n.appendChild(m.domElement);const g=new Ms(c.themeColorCSS("background"),.0025),v=new bs;v.fog=g,v.name="CV.Viewer";var y=new Fo(d,m,v);const x=new ga;x.layers.enableAll();const _=new Oo(d,v),S=new Od(y,m.domElement,this);S.maxPolarAngle=c.themeAngle("maxPolarAngle"),S.addEventListener("change",ut),S.addEventListener("end",Tt);const w=new Wd(y,d);w.addEventListener("change",ut),w.addEventListener("end",Tt),w.addEventListener("accuracy",(function(t){I.setAccuracy(t.value)}));const E=new ko(S,ut),T={type:"moved",cameraManager:y},C={};var L=!1,A=0,R=0,D=[],N=0,I=null,F=null,O=null,z={},U=!1,B=!0,k=null,G=!1;const H=new le,V=new at,W=new ot,j=this;var X,q=null,Y=!1,Z=!1,J=!1;function K(){Y=!0}function Q(){Y=!1}window.addEventListener("resize",ft),Object.defineProperties(this,{mouseOver:{get:function(){return Y}},reset:{set:function(){mt(!1)}},surveyLoaded:{get:function(){return L}},terrain:{get:function(){return y.testCameraLayer(7)},set:function(t){null!==I&&I.isLoaded&&(I.setVisibility(t),y.setCameraLayer(7,t),j.dispatchEvent({type:"change",name:"terrain"}),Et())}},terrainShading:{get:function(){return null!==I?I.shadingMode:null},set:it(lt,"terrainShading")},hasTerrain:{get:function(){return!!I}},hasRealTerrain:{get:function(){return I&&!I.isFlat}},terrainAttributions:{get:function(){return null!==I?I.attributions:[]}},terrainDirectionalLighting:{get:function(){return _.directionalLighting},set:function(t){_.directionalLighting=t,Et()}},terrainThrough:{get:function(){return null!==I?I.throughMode:null},set:it((function(t){if(null===I)return;I.setThroughMode(t),f.distanceTransparency=2===t?200:0,lt(I.shadingMode)}),"terrainThrough")},terrainShadingModes:{get:function(){return null!==I?I.terrainShadingModes:{}}},terrainTileSet:{get:function(){return I.tileSet.bind(I)}},terrainDatumShift:{get:function(){return!!I.activeDatumShift},set:function(t){if(null===I)return;I.applyDatumShift(t),j.dispatchEvent({type:"change",name:"terrainDatumShift"}),Et()}},terrainOpacity:{get:function(){return null!==I?I.getOpacity():0},set:function(t){if(null===I)return;I.setOpacity(t),j.dispatchEvent({type:"change",name:"terrainOpacity"}),Et()}},shadingMode:{get:function(){return F.caveShading},set:it(dt,"shadingMode")},hideMode:{get:function(){return F.hideMode},set:function(t){F.setHideMode(t),Et()}},flatShading:{get:function(){return F.wallsMode},set:function(t){F.setWallsMode(t),Et()}},route:{get:function(){return F.getRoutes().setRoute},set:function(t){F.getRoutes().setRoute=t}},routeNames:{get:function(){return F.getRoutes().getRouteNames()}},surfaceShading:{get:function(){return F.surfaceShading},set:it((function(t){F.setSurfaceShading(t),Et()}),"surfaceShading")},duplicateShading:{get:function(){return F.duplicateShading},set:it((function(t){F.setDuplicateShading(t),Et()}),"duplicateShading")},cameraType:{get:function(){return y.mode},set:it((function(t){y.setCamera(t,S.target),Et()}),"cameraType")},eyeSeparation:{get:function(){return y.eyeSeparation},set:function(t){y.eyeSeparation=t,Et()}},view:{get:function(){return 0},set:it((function(t){const e=W;switch(t){case 0:return;case 1:e.set(0,0,-1);break;case 2:e.set(0,1,0);break;case 3:e.set(0,-1,0);break;case 4:e.set(1,0,0);break;case 5:e.set(-1,0,0);break;default:return void console.warn("invalid view mode specified: ",t)}E.prepare(F.getWorldBoundingBox(),e),E.start(B)}),"view")},cursorHeight:{get:function(){return f.cursorHeight},set:function(t){f.cursorHeight=t,j.dispatchEvent({type:"cursorChange",name:"cursorHeight"}),Et()}},maxDistance:{get:function(){return F.getMaxDistance()}},maxHeight:{get:function(){return null===O?0:O.max.z}},minHeight:{get:function(){return null===O?0:O.min.z}},maxLegLength:{get:function(){return z.maxLegLength}},minLegLength:{get:function(){return z.minLegLength}},section:{get:function(){return F.selection.getNode()},set:it(pt,"section")},sectionByName:{get:function(){return F.selection.getName()},set:function(t){pt(F.surveyTree.getByPath(t)||F.surveyTree)}},popup:{set:function(t){_t(),t.isStation()&&xt(t)}},highlight:{set:it((function(t){F.highlightSelection(t),Et()}),"highlight")},polarAngle:{get:function(){return S.getPolarAngle()},set:function(t){E.setPolarAngle(t)}},azimuthAngle:{set:function(t){E.setAzimuthAngle(t)}},editMode:{get:function(){return R},set:function(t){!function(t){switch(R=Number(t),A=R,N=0,F.markers.clear(),F.selectSection(F.surveyTree),Et(),x.params.Points.threshold=3,R){case 3:D=F.pointTargets.concat([F.dyeTraces]);break;case 0:D=F.pointTargets;break;case 1:D=F.legTargets;break;case 4:D=F.entranceTargets,x.params.Points.threshold=15;break;default:console.warn("invalid mouse mode",t)}}(t),j.dispatchEvent({type:"change",name:"editMode"})}},setPOI:{set:it((function(){E.start(!0)}),"setPOI")},HUD:{get:function(){return $.getVisibility()},set:function(t){$.setVisibility(t)}},cut:{set:function(){const t=F.selection;if(t.isEmpty()||t.isStation())return;E.cancel(),F.remove(I),F.cutSection(t.getNode());const e=F;q=X.saveState(),j.clearView(),G=!0,gt(e)}},zScale:{get:function(){return F.zScale},set:function(t){F.zScale=t,Et()}},autoRotate:{get:function(){return S.autoRotate},set:function(t){var e;e=!!t,E.setAutoRotate(e),j.dispatchEvent({type:"change",name:"autoRotate"})}},wheelTilt:{get:function(){return S.wheelTilt},set:function(t){S.wheelTilt=!!t,j.dispatchEvent({type:"change",name:"wheelTilt"})}},svxControlMode:{get:function(){return S.svxControlMode},set:function(t){S.svxControlMode=!!t,j.dispatchEvent({type:"newCave",name:"newCave"})}},zoomToCursor:{get:function(){return S.zoomToCursor},set:function(t){S.zoomToCursor=!!t,j.dispatchEvent({type:"change",name:"zoomToCursor"})}},autoRotateSpeed:{get:function(){return S.autoRotateSpeed/11},set:function(t){S.autoRotateSpeed=11*Math.max(Math.min(t,1),-1),j.dispatchEvent({type:"change",name:"autoRotateSpeed"})}},fullscreen:{get:nt,set:function(t){if(nt()===t)return;t?(n.classList.add("toggle-fullscreen"),null===document.fullscreenElement?n.requestFullscreen():null===document.msfullscreenElement?n.msRequestFullscreen():null===document.webkitFullscreenElement&&n.webkitRequestFullscreen()):(n.classList.remove("toggle-fullscreen"),document.fullscreenElement?document.exitFullscreen():document.msFullscreenElement?document.msExitFullscreen():document.webkitFullscreenElement&&(document.webkitExitFullscreen?document.webkitExitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()))}},hasContours:{get:function(){return!(null===m.extensions.get("OES_standard_derivatives"))}},fog:{get:function(){return U},set:function(t){U=t,g.density=U?.0025:0,Et()}},isClipped:{get:function(){return G}},hasLocation:{get:function(){return Z}},trackLocation:{get:function(){return J},set:function(t){t?(q=X.saveState(),S.saveState(),w.connect(),j.setView(Dd,null),E.cancel()):(w.disconnect(),null!==I&&I.setScale(0),j.setView(q,null),E.cancel(),S.reset(),q=null);S.enabled=!t,J=t,Et()}},maxSnapshotSize:{get:function(){const t=m.getContext();return t.getParameter(t.MAX_RENDERBUFFER_SIZE)}},focalLength:{get:function(){return y.focalLength},set:function(t){const e=t/y.focalLength;y.focalLength=t,S.scaleDolly(e)}}}),et(4,"box"),et(6,"entrances"),et(17,"entrance_dots"),et(8,"stations"),et(9,"traces"),et(18,"grid"),et(a,"scraps"),et(s,"walls"),et(1,"legs"),et(2,"splays"),et(3,"surfaceLegs"),et(h,"duplicateLegs"),et(o,"stationLabels"),et(l,"stationComments"),et(14,"warnings"),n.addEventListener("mouseover",K),n.addEventListener("mouseleave",Q),n.addEventListener("fullscreenchange",rt),n.addEventListener("msfullscreenchange",rt),n.addEventListener("webkitfullscreenchange",rt),this.addEventListener("change",(function(t){null!==F&&"splays"===t.name&&F.stations.setSplaysVisibility(j.splays)})),c.addEventListener("colors",(()=>{n.style.backgroundColor=c.themeColorCSS("background"),m.setClearColor(c.themeColor("background"),0),F&&F.refreshColors(),Et()})),this.getControls=function(){return S};const $=new co(this,m),tt=new ru(d,(function(t){if(!t)return void alert("failed loading cave information");ft(),gt(new Ju(d,t)),tt.reset()}));function et(t,e){Object.defineProperty(j,e,{get:function(){return y.testCameraLayer(t)},set:function(i){y.setCameraLayer(t,i),j.dispatchEvent({type:"change",name:e}),Et()}});const i="has"+e.substr(0,1).toUpperCase()+e.substr(1);Object.defineProperty(j,i,{get:function(){return F.hasFeature(t)}})}function it(t,e){return function(i){t(isNaN(i)?i:Number(i)),j.dispatchEvent({type:"change",name:e})}}function nt(){return window.innerHeight===n.clientHeight&&window.innerWidth===n.clientWidth}function rt(){document.fullscreenElement||document.msFullscreenElement||document.webkitFullscreenElement?n.classList.add("toggle-fullscreen"):n.classList.remove("toggle-fullscreen"),ft(),j.dispatchEvent({type:"change",name:"fullscreen"})}function lt(t){null!==F.terrain&&(I.setShadingMode(t,Et),Et(),I.isTiled&&I.zoomCheck(y))}function ht(t){t.isLoaded&&((I=t).setup(m,v,F),c.value("useGPS",!1)&&w.hasLocation(F,ct),I.isTiled&&(I.addEventListener("progress",vt),I.watch(j))),mt(!0)}function ct(){Z=!0,j.dispatchEvent({type:"newCave",name:"newCave"})}function ut(){const t=y.activeCamera;H.setFromQuaternion(t.getWorldQuaternion(V)),_.setRotation(H),J&&null!==I&&(t.isOrthographicCamera?(I.setScale(t.zoom*F.scale.z),I.setTarget(w.location)):I.setScale(0)),Et()}function dt(t){F.setShadingMode(t)===r?(A=R,R=2,D=F.pointTargets):R=A,Et()}function pt(t){return t.isStation()?function(t){3===R?St(t):(F.selectStation(t),E.preparePoint(F.getWorldPosition(t.p.clone())))}(t):function(t){F.selectSection(t),E.cancel(),E.prepare(F.selection.getWorldBoundingBox()),F.selection.isEmpty()&&E.start(B)}(t),void Et()}function ft(){const t=n.clientWidth,e=n.clientHeight;m.setSize(t,e),j.dispatchEvent({type:"resized",name:"rts",width:t,height:e}),Et()}function mt(t){B=!0,null===q?j.setView(Pd,c.value("view",{})):(j.setView(q),q=null),t&&j.dispatchEvent({type:"newCave",name:"newCave"})}function gt(t){B=!1,F=t,$.getProgressDial(1).watch(F),z=j.getLegStats(1),function(){const t=n.clientWidth,e=n.clientHeight,i=F.scaleFactor;O=F.limits;const r=F.combinedLimits.getSize(W);var s=Math.min(t/r.x,e/r.y);s===1/0&&(s=1);const a=s*i;F.setScale(s,a),$.setScale(a)}(),f.flushCache(),v.addStatic(F),D=F.pointTargets,v.matrixAutoUpdate=!1,n.addEventListener("mousedown",bt,!1),S.enabled=!0,F.getRoutes().addEventListener("changed",yt),F.addEventListener("changed",yt),L=!0;let e=F.terrain;null!==e?ht(e):navigator.onLine?(e=new _d(d,F,ht),$.getProgressDial(0).watch(e),mt(!1)):mt(!0)}function vt(t){"end"===t.name&&Et()}function yt(){dt(F.caveShading)}function xt(t){if(null!==k)return;const e=I?t.p.z-I.getHeight(t.p):null;k=new id(d,t,F,e,C.station,F.caveShading===r,j.warnings),F.add(k),Et()}function _t(){null!==k&&(k.close(),k=null)}function Mt(){n.removeEventListener("mouseup",Mt),_t(),Et(),j.dispatchEvent({type:"select",node:null})}function bt(t){if(t.target!==m.domElement)return;const e=W.set(n.clientWidth/2,n.clientHeight/2,0),r=y.getMouse(t.clientX,t.clientY);x.setFromCamera(r,y.activeCamera);const s=x.intersectObjects(D,!1);var a;if(0===R&&j.entrances&&null!==(a=F.entrances.intersectLabels(r,y.activeCamera,e))){const e=F.surveyTree.findById(a.stationID),i={type:"entrance",node:e,handled:!1,mouseEvent:t};if(j.dispatchEvent(i),i.handled)return;l(e)}else{var o;if(!(s.length<1))switch(R){case 0:l(wt(s));break;case 1:o=s[0],F.getRoutes().toggleSegment(o.index),dt(i),Et();break;case 2:!function(e){if(null===e)return;t.button===u?(F.showShortestPath(e),h(e)):t.button===p&&(F.shortestPathSearch(e),j.dispatchEvent({type:"change",name:"shadingMode"}),Et())}(wt(s));break;case 3:t.button===u&&("Mesh"===s[0].object.type?function(t){const e=F.dyeTraces,i=t.faceIndex;F.markers.clear(),e.outlineTrace(i),j.dispatchEvent({type:"selectedTrace",trace:e.getTraceStations(i),delete:function(){e.deleteTrace(i),Et()}}),Et()}(s[0]):St(wt(s)))}}function l(e){if(null===e)return;F.selectStation(e);const i={type:"select",node:e,handled:!1,mouseEvent:t};j.dispatchEvent(i),i.handled||(t.button===u?h(e):t.button===p&&function(e){F.selection.contains(e.id)||F.selectSection(F.surveyTree);pt(e),E.start(!0),t.stopPropagation(),n.addEventListener("mouseup",c)}(e))}function h(t){return xt(t),n.addEventListener("mouseup",Mt),E.preparePoint(F.getWorldPosition(t.p.clone())),!0}function c(){n.removeEventListener("mouseup",c),J||(S.enabled=!0),Et(),j.dispatchEvent({type:"select",node:null})}}function St(t){if(null===t)return;const e=F.dyeTraces,i=F.markers;e.outlineTrace(null),3==++N&&(i.clear(),N=1),i.mark(t);const n=i.getStations();var r,s;void 0!==n[0]&&(r=n[0].getPath()),void 0!==n[1]&&(s=n[1].getPath()),j.dispatchEvent({type:"selectedTrace",start:r,end:s,add:function(){2===n.length&&(e.addTrace(n[0],n[1]),i.clear(),Et())}}),Et()}function wt(t){return F.stations.getClosestVisibleStation(y.activeCamera,t)}function Et(){B&&(m.clear(),L&&(F.update(y,S.target,!J),U&&f.setFog(!0),y.activeRenderer()),U&&f.setFog(!1),$.renderHUD())}function Tt(){j.dispatchEvent(T)}$.getProgressDial(0).watch(tt),X=new Nd(this),this.renderView=Et,ft(),this.addOverlay=function(t,e,i){Uu.addOverlay(d,t,e,i)},this.addFormatters=function(t){C.station=t},this.clearView=function(){L=!1,m.clear(),$.setVisibility(!1),d.workerPools.terminateActive(),I&&I.isTiled&&I.unwatch(j),v.remove(F),S.enabled=!1,F=null,I=null,O=null,R=0,D=[],Z=!1,n.removeEventListener("mousedown",bt),y.resetCameras(),S.reset()},this.loadCave=function(t,e){tt.reset(),tt.loadFile(t,e),G=void 0!==e&&""!=e},this.loadCaves=function(t){tt.reset(),tt.loadFiles(t)},this.setView=function(t,e){B&&(B=!1,Object.assign(this,t,e),B=!0,Et())},this.getStation=function(t){const e=x.params.Points.threshold;x.setFromCamera(t,y.activeCamera),x.params.Points.threshold=20;const i=x.intersectObjects(F.pointTargets,!1);if(x.params.Points.threshold=e,i.length<1)return null;const n=wt(i);return null===n?null:F.getWorldPosition(n.p.clone())},this.renderView=Et,this.getLegStats=function(t){return void 0!==F.getFeature(t)?F.getFeature(t).stats:{legs:0,legLength:0,minLegLength:0,maxLegLength:0}},this.getControls=function(){return S},this.getMetadata=function(){return F.metadata},this.getGLTFExport=function(t,e,i){F.gltfExport(t,e,i)},this.getSurveyTree=function(){return F.surveyTree},this.showImagePopup=function(t,e){!function(t,e){null===k&&(k=new nd(d,t,e,Et),F.add(k),Et())}(t.node,e),n.addEventListener("mouseup",Mt)},this.getSnapshot=function(t,e){var i=n.clientWidth,r=n.clientHeight,s=t,a=Math.round(r*s/i);const o=new st(s,a,{minFilter:b,magFilter:M,format:P,stencilBuffer:!0});o.texture.generateMipmaps=!1,o.texture.name="CV.snapshot",m.setSize(s,a),m.setPixelRatio(1),m.setRenderTarget(o),m.setClearAlpha(1),j.dispatchEvent({type:"resized",name:"rts",width:s,height:a,lineScale:e}),Et();const l=s*a*4,h=new Uint8ClampedArray(l);m.readRenderTargetPixels(o,0,0,s,a,h);const c=4*s,u=new Uint8ClampedArray(l);for(let t=0;t<l;t+=c){const e=l-t-c;for(let i=0;i<c;i++)u[e+i]=h[t+i]}const d=new ImageData(u,s,a);var p=document.createElement("canvas");return p.width=s,p.height=a,p.getContext("2d").putImageData(d,0,0),o.dispose(),m.setRenderTarget(null),m.setPixelRatio(window.devicePixelRatio),m.setClearAlpha(0),ft(),p.toDataURL()},this.dispose=function(){d.workerPools.dispose(),v.remove(F),S.dispose(),w.dispose(),$.dispose(),d.glyphStringCache=null,d.cfg=null,d.workerPools=null,d.materials=null,d.container=null,window.removeEventListener("resize",ft),n.removeChild(m.domElement),n.removeEventListener("mouseover",K),n.removeEventListener("mouseleave",Q),n.removeEventListener("mousedown",bt),n.removeEventListener("fullscreenchange",rt),n.removeEventListener("msfullscreenchange",rt),m.clear(),m.dispose(),m=null}}},t.FACE_SCRAPS=a,t.FACE_WALLS=s,t.FEATURE_BOX=4,t.FEATURE_ENTRANCES=6,t.FEATURE_ENTRANCE_DOTS=17,t.FEATURE_GRID=18,t.FEATURE_SELECTED_BOX=5,t.FEATURE_STATIONS=8,t.FEATURE_SURVEY=0,t.FEATURE_TERRAIN=7,t.FEATURE_TRACES=9,t.LABEL_STATION=o,t.LABEL_STATION_COMMENT=l,t.LEG_CAVE=1,t.LEG_DUPLICATE=h,t.LEG_SPLAY=2,t.LEG_SURFACE=3,t.MATERIAL_LINE=1,t.MATERIAL_SURFACE=2,t.MOUSE_MODE_DISTANCE=2,t.MOUSE_MODE_ENTRANCES=4,t.MOUSE_MODE_NORMAL=0,t.MOUSE_MODE_ROUTE_EDIT=1,t.MOUSE_MODE_TRACE_EDIT=3,t.SHADING_BECK=14,t.SHADING_CONTOURS=15,t.SHADING_CURSOR=4,t.SHADING_DEPTH=9,t.SHADING_DEPTH_CURSOR=n,t.SHADING_DISTANCE=r,t.SHADING_DUPLICATE=18,t.SHADING_HEIGHT=1,t.SHADING_INCLINATION=3,t.SHADING_LENGTH=2,t.SHADING_LOCATION=16,t.SHADING_OVERLAY=7,t.SHADING_PATH=i,t.SHADING_RELIEF=8,t.SHADING_SHADED=8,t.SHADING_SINGLE=5,t.SHADING_SURFACE=17,t.SHADING_SURVEY=6,t.STATION_ENTRANCE=2,t.STATION_NORMAL=1,t.STATION_XSECT=4,t.SURVEY_WARNINGS=14,t.TERRAIN_BASIC=0,t.TERRAIN_BLEND=2,t.TERRAIN_STENCIL=1,t.VERSION=e,t.VIEW_ELEVATION_E=4,t.VIEW_ELEVATION_N=2,t.VIEW_ELEVATION_S=3,t.VIEW_ELEVATION_W=5,t.VIEW_NONE=0,t.VIEW_PLAN=1,t.WALL_DIAMOND=3,t.WALL_OVAL=1,t.WALL_SQUARE=2,Object.defineProperty(t,"__esModule",{value:!0})}));
